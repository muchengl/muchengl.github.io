<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>eBPF AF_XDPå­¦ä¹ </title>
      <link href="/2023/02/22/eBPF-XDP/"/>
      <url>/2023/02/22/eBPF-XDP/</url>
      
        <content type="html"><![CDATA[<p>å®˜æ–¹æ•™ç¨‹åœ°å€ï¼ˆ19å¹´ç‰ˆæœ¬ï¼Œæœ‰äº›æ—§ï¼ŒåŒ…ä¾èµ–å…³ç³»å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼‰ï¼š<a href="https://github.com/xdp-project/xdp-tutorial">https://github.com/xdp-project/xdp-tutorial</a></p><h2 id="XDPç¨‹åºEasy-Example"><a href="#XDPç¨‹åºEasy-Example" class="headerlink" title="XDPç¨‹åºEasy Example"></a>XDPç¨‹åºEasy Example</h2><p>ä¸‹åˆ—ç¨‹åºå¯ä»¥ç”¨äºåœ¨é­å—DDosæ”»å‡»æ—¶ä½¿ç”¨ï¼Œä½œç”¨æ˜¯ä¸¢å¼ƒæ‰€æœ‰ç½‘ç»œæ•°æ®åŒ…(ä¸è¦éšæ„è·‘è¿™ä¸ªç¨‹åºï¼Œå½“æ­¤ç¨‹åºåŠ è½½æˆåŠŸçš„ç¬é—´ï¼Œsshé“¾æ¥å°±ä¼šå¤±æ•ˆï¼Œç„¶åå°±åªèƒ½é‡å¯æœåŠ¡å™¨äº†ğŸ˜‚)ï¼š</p><p>XDPå†…æ ¸ç¨‹åºï¼Œä¼šè¢«ç¼–è¯‘ä¸º.oæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;xdp&quot;</span>)</span><br><span class="line"><span class="type">int</span>  <span class="title function_">xdp_prog_simple</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŠ è½½XDPæ ¸å¿ƒç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">xdp_link_attach</span><span class="params">(<span class="type">int</span> ifindex, __u32 xdp_flags, <span class="type">int</span> prog_fd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Next assignment this will move into ../common/ */</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* libbpf provide the XDP net_device link-level hook attach helper */</span></span><br><span class="line">  <span class="comment">// é€šè¿‡helperè¿›è¡ŒåŠ è½½</span></span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);</span><br><span class="line"><span class="keyword">if</span> (err == -EEXIST &amp;&amp; !(xdp_flags &amp; XDP_FLAGS_UPDATE_IF_NOEXIST)) &#123;</span><br><span class="line"><span class="comment">/* Force mode didn&#x27;t work, probably because a program of the</span></span><br><span class="line"><span class="comment"> * opposite type is loaded. Let&#x27;s unload that and try loading</span></span><br><span class="line"><span class="comment"> * again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__u32 old_flags = xdp_flags;</span><br><span class="line"></span><br><span class="line">xdp_flags &amp;= ~XDP_FLAGS_MODES;</span><br><span class="line">xdp_flags |= (old_flags &amp; XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;</span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, <span class="number">-1</span>, xdp_flags);</span><br><span class="line"><span class="keyword">if</span> (!err)</span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> EXIT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨libbpfä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨libbpfæä¾›çš„åŠ è½½å·¥å…·å‡½æ•°è¿›è¡ŒåŠ è½½ã€‚</p><h2 id="XDPå†…æ ¸ç¨‹åº"><a href="#XDPå†…æ ¸ç¨‹åº" class="headerlink" title="XDPå†…æ ¸ç¨‹åº"></a>XDPå†…æ ¸ç¨‹åº</h2><h3 id="XDPè¾“å‡ºå‚æ•°ï¼š"><a href="#XDPè¾“å‡ºå‚æ•°ï¼š" class="headerlink" title="XDPè¾“å‡ºå‚æ•°ï¼š"></a>XDPè¾“å‡ºå‚æ•°ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">xdp_action</span> &#123;</span></span><br><span class="line">XDP_ABORTED = <span class="number">0</span>, <span class="comment">// Drop packet while raising an exception</span></span><br><span class="line">XDP_DROP, <span class="comment">//ä¸¢å¼ƒ</span></span><br><span class="line">XDP_PASS, <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">XDP_TX,   <span class="comment">//ä»åŒä¸€ç½‘è¯¾è¿”å›è¯¥æ•°æ®åŒ…</span></span><br><span class="line">XDP_REDIRECT, <span class="comment">//é‡å®šå‘ï¼ŒAF_XDPå¯ä»¥å°†æ•°æ®åŒ…é‡å®šå‘åˆ°ç”¨æˆ·æ€</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="XDPè¾“å…¥å‚æ•°ï¼š"><a href="#XDPè¾“å…¥å‚æ•°ï¼š" class="headerlink" title="XDPè¾“å…¥å‚æ•°ï¼š"></a>XDPè¾“å…¥å‚æ•°ï¼š</h3><p><strong>data</strong>å’Œ<strong>data_end</strong>å­—æ®µåˆ†åˆ«æ˜¯æ•°æ®åŒ…å¼€å§‹å’Œç»“æŸçš„æŒ‡é’ˆï¼Œå®ƒä»¬æ˜¯ç”¨æ¥è·å–å’Œè§£æä¼ æ¥çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå€¼æ˜¯<strong>data_meta</strong>æŒ‡é’ˆï¼Œåˆå§‹é˜¶æ®µå®ƒæ˜¯ä¸€ä¸ªç©ºé—²çš„å†…å­˜åœ°å€ï¼Œä¾›XDPç¨‹åºä¸å…¶ä»–å±‚äº¤æ¢æ•°æ®åŒ…å…ƒæ•°æ®æ—¶ä½¿ç”¨ã€‚æœ€åä¸¤ä¸ªå­—æ®µåˆ†åˆ«æ˜¯æ¥æ”¶æ•°æ®åŒ…çš„æ¥å£å’Œå¯¹åº”çš„RXé˜Ÿåˆ—çš„ç´¢å¼•ã€‚å½“è®¿é—®è¿™ä¸¤ä¸ªå€¼æ—¶ï¼ŒBPFä»£ç ä¼šåœ¨å†…æ ¸å†…éƒ¨é‡å†™ï¼Œä»¥è®¿é—®å®é™…æŒæœ‰è¿™äº›å€¼çš„å†…æ ¸ç»“æ„<strong>struct xdp_rxq_info</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> * user accessible metadata <span class="keyword">for</span> XDP packet hook</span><br><span class="line"> * new fields must be added to the end of this structure</span><br><span class="line"> *</span><br><span class="line"><span class="keyword">struct</span> xdp_md &#123;</span><br><span class="line">__u32 data;</span><br><span class="line">__u32 data_end;</span><br><span class="line">__u32 data_meta;</span><br><span class="line"><span class="comment">// Below access go through struct xdp_rxq_info</span></span><br><span class="line">__u32 ingress_ifindex; <span class="comment">// rxq-&gt;dev-&gt;ifindex</span></span><br><span class="line">__u32 rx_queue_index;  <span class="comment">// rxq-&gt;queue_index</span></span><br><span class="line">&#125;;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><h2 id="Libbpfä¸­ä½¿ç”¨AF-XDP"><a href="#Libbpfä¸­ä½¿ç”¨AF-XDP" class="headerlink" title="Libbpfä¸­ä½¿ç”¨AF_XDP"></a>Libbpfä¸­ä½¿ç”¨AF_XDP</h2><p>ç”±äºç°åœ¨libbpfå·²ç»åœæ­¢äº†å¯¹AF_xdp socket(xsk)çš„ç›´æ¥æ”¯æŒï¼Œå› æ­¤éœ€è¦åœ¨libpbfé¡¹ç›®ä¸­æ‰‹åŠ¨å¼•å…¥XDP-TOOLï¼Œä»¥è·å–xdpå…¨éƒ¨åŠŸèƒ½<br><a href="https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96">https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96</a><br>XDP tools: <a href="https://github.com/xdp-project/xdp-tools">https://github.com/xdp-project/xdp-tools</a></p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p>å°†xdp-toolåŒ…åŠ å…¥libbpfé¡¹ç›®</p></li><li><p>ä¿®æ”¹makefile</p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŠ å…¥ç¼–è¯‘xdp-toolçš„éƒ¨åˆ†</span></span><br><span class="line">XDPTOOL_SRC := <span class="variable">$(<span class="built_in">abspath</span> ../../xdp-tools)</span> <span class="comment">#å¾…ç¼–è¯‘æ–‡ä»¶</span></span><br><span class="line">LIBXDP_SOURCES := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(XDPTOOL_SRC)</span>/lib/libxdp/libxdp*.[ch])</span> $(<span class="variable">$(XDPTOOL_SRC)</span>/lib/libxdp/xsk.c)</span><br><span class="line">XDPTOOL := <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(OUTPUT)</span>/libxdp.a)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(XDPTOOL)</span>: <span class="variable">$(LIBXDP_SOURCES)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> msg,LIB,<span class="variable">$@</span>)</span></span><br><span class="line"><span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> -C <span class="variable">$(XDPTOOL_SRC)</span> BUILD_STATIC_ONLY=1\</span><br><span class="line">OBJDIR=<span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>/xdptool DESTDIR=<span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>      \</span><br><span class="line">INCLUDEDIR= LIBDIR= UAPIDIR=      \</span><br><span class="line">libxdp_install</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€åç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥xdp-tool</span></span><br><span class="line"><span class="variable">$(APPS)</span>: %: <span class="variable">$(OUTPUT)</span>/%.o <span class="variable">$(XDPTOOL)</span> <span class="variable">$(LIBBPF_OBJ)</span>| <span class="variable">$(OUTPUT)</span>  </span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> msg,BINARY,<span class="variable">$@</span>)</span></span><br><span class="line"><span class="variable">$(Q)</span><span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> <span class="variable">$(ALL_LDFLAGS)</span> -lpthread -lelf -lz -o <span class="variable">$@</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ç”¨æˆ·æ€bpfç¨‹åºä¸­å¼•å…¥ #include &lt;xdp/xsk.h&gt;ï¼Œåç»­å³å¯ä½¿ç”¨AF_XDPçš„åŠŸèƒ½</p></li><li><p>Libbpf attach xdpç¨‹åºæ–¹æ³•ï¼š</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å…¨éƒ¨ç½‘å¡ä¿¡æ¯çš„å·¥å…·å‡½æ•°</span></span><br><span class="line"><span class="comment">// å‚è€ƒæ­¤åšå®¢ https://blog.csdn.net/Rong_Toa/article/details/109118585</span></span><br><span class="line"><span class="type">int</span> ret = get_ifinfo(ifdisplay, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attack bpf sec to all IF devs</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;ret;i++)&#123;</span><br><span class="line">bpf_program__attach_xdp (skel-&gt;progs.xdp_prog, i);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥åœ¨pipeä¸­çœ‹åˆ°XDPåŒ…çš„ä¿¡æ¯</p><h2 id="åˆ©ç”¨AF-XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€"><a href="#åˆ©ç”¨AF-XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€" class="headerlink" title="åˆ©ç”¨AF XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€"></a>åˆ©ç”¨AF XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€</h2><p><a href="https://www.kernel.org/doc/html/next/networking/af_xdp.html">https://www.kernel.org/doc/html/next/networking/af_xdp.html</a></p><p><a href="https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/">https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/</a></p><p>AF_XDPç”¨æˆ·æ€ä¸å†…æ ¸äº¤æ¢æ•°æ®åŒ…åŸç†ï¼š</p><p>åœ¨ç”¨æˆ·å’Œå†…æ ¸ä¹‹é—´ï¼Œæœ‰ä¸€å—å…¬å…±çš„å†…å­˜åŒºåŸŸï¼šUMEMã€‚xdpå†…æ ¸ç¨‹åºä¼šå°†xdpæ•°æ®åŒ…å­˜å‚¨åœ¨UMEMé‡Œï¼Œ<br>åŒæ—¶æœ‰å››ç§ringï¼šFILL, COMPLETION, RX and TXã€‚å†…æ ¸å°†æŒ‡å‘UMEMä¸­æ•°æ®åŒ…çš„æŒ‡é’ˆæ”¾å…¥RX queueé‡Œã€‚ä¾›ç”¨æˆ·ç©ºé—´æ¶ˆè´¹ã€‚åŒæ—¶ç”¨æˆ·æ€å¯ä»¥é€šè¿‡å†™å…¥TX queueï¼Œå°†æ•°æ®åŒ…ä¼ å›å†…æ ¸å¤„ç†ã€‚å†…æ ¸å¤„ç†è¯¥æ•°æ®åŒ…ä¹‹åï¼Œå°†TXæè¿°ç¬¦æ”¾å…¥completion queueé‡Œï¼Œè¡¨ç¤ºå¤„ç†å®Œæˆã€‚æœ€åç”¨æˆ·ç©ºé—´å¯ä»¥åœ¨Fill queueæˆ–TXé˜Ÿåˆ—é‡Œå›æ”¶æè¿°ç¬¦ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png" alt="image7-6"></p><p>ä¸€å¼ å¾ˆæœ‰å¯å‘æ„ä¹‰çš„å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png" alt="unnamed1"></p><h3 id="ä»£ç è¯¦è§£"><a href="#ä»£ç è¯¦è§£" class="headerlink" title="ä»£ç è¯¦è§£"></a>ä»£ç è¯¦è§£</h3><p>åœ¨ç”¨æˆ·æ€è¾“å‡ºxdpåŒ…æ•°æ®ï¼Œè¿è¡Œç»“æœï¼š</p><p><img src="https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2023-02-25%2021.36.18.png?raw=true" alt="æˆªå±2023-02-25 21.36.18"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1792 Maximum Average Pass Ratio</title>
      <link href="/2023/02/19/lc1792-Maximum-Average-Pass-Ratio/"/>
      <url>/2023/02/19/lc1792-Maximum-Average-Pass-Ratio/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>There is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.</p><p>You are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.</p><p>The pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.</p><p>Return the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: classes = [[1,2],[3,5],[2,2]], extraStudents = 2</span><br><span class="line">Output: 0.78333</span><br><span class="line">Explanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4</span><br><span class="line">Output: 0.53485</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public double maxAverageRatio(int[][] classes, int extraStudents) &#123;</span><br><span class="line"></span><br><span class="line">        // So this is a two-dimensional array</span><br><span class="line">        PriorityQueue&lt;int[]&gt; queue = new PriorityQueue&lt;int[]&gt;(</span><br><span class="line">         (a, b) -&gt; &#123;</span><br><span class="line">            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);</span><br><span class="line">            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);</span><br><span class="line">            if (val1 == val2) &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">            return val1 &lt; val2 ? 1 : -1;</span><br><span class="line">        &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;classes.length;i++)&#123;</span><br><span class="line">            queue.add(classes[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // while(!queue.isEmpty())&#123;</span><br><span class="line">        //     int[] item=queue.poll();</span><br><span class="line">        //     System.out.println(item[0]+&quot; &quot;+item[1]);</span><br><span class="line">        // &#125;</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;extraStudents;i++)&#123;</span><br><span class="line">            int[] item=queue.poll();</span><br><span class="line">            item[0]++;</span><br><span class="line">            item[1]++;</span><br><span class="line">            queue.add(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        double ans=0;</span><br><span class="line">        while(!queue.isEmpty())&#123;</span><br><span class="line">            int[] item=queue.poll();</span><br><span class="line">            ans+=((double)item[0])/((double)item[1]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        return ans/classes.length;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// dp[i][j] The max pass ratio for first i class,first j extra student</span><br><span class="line">// dp[i][j]=MAX&#123; dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)&#125;</span><br><span class="line">// Time complexityï¼šO(l * extraStudents^2)</span><br><span class="line">// This algorithm seems too complicated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// So Use a greedy idea.</span><br><span class="line">// I define a priority queue</span><br><span class="line">// And the queue storage the classes and sort them by pass ratio from small to big.</span><br><span class="line"></span><br><span class="line">// I keep pulling classes from the head of the queue</span><br><span class="line">// Adding a extra student to this class and push this class back to queue.</span><br><span class="line"></span><br><span class="line">// When all extra student were used, the average pass retio has been maximized</span><br><span class="line">// the time complexity is o(log(l)*extraStudentNum)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1237  Find Positive Integer Solution for a Given Equation</title>
      <link href="/2023/02/18/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/"/>
      <url>/2023/02/18/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>Given a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.</p><p>While the exact formula is hidden, the function is monotonically increasing, i.e.:</p><p>f(x, y) &lt; f(x + 1, y)<br>f(x, y) &lt; f(x, y + 1)<br>The function interface is defined like this:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface CustomFunction &#123;</span><br><span class="line">public:</span><br><span class="line">  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.</span><br><span class="line">  int f(int x, int y);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>We will judge your solution as follows:</p><p>The judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.<br>The judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.<br>The judge will call your findSolution and compare your results with the answer key.<br>If your results match the answer key, your solution will be Accepted.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: function_id = 1, z = 5</span><br><span class="line">Output: [[1,4],[2,3],[3,2],[4,1]]</span><br><span class="line">Explanation: The hidden formula for function_id = 1 is f(x, y) = x + y.</span><br><span class="line">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class="line">x=1, y=4 -&gt; f(1, 4) = 1 + 4 = 5.</span><br><span class="line">x=2, y=3 -&gt; f(2, 3) = 2 + 3 = 5.</span><br><span class="line">x=3, y=2 -&gt; f(3, 2) = 3 + 2 = 5.</span><br><span class="line">x=4, y=1 -&gt; f(4, 1) = 4 + 1 = 5.</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: function_id = 2, z = 5</span><br><span class="line">Output: [[1,5],[5,1]]</span><br><span class="line">Explanation: The hidden formula for function_id = 2 is f(x, y) = x * y.</span><br><span class="line">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class="line">x=1, y=5 -&gt; f(1, 5) = 1 * 5 = 5.</span><br><span class="line">x=5, y=1 -&gt; f(5, 1) = 5 * 1 = 5.</span><br></pre></td></tr></table></figure><h2 id="Solution-01"><a href="#Solution-01" class="headerlink" title="Solution 01"></a>Solution 01</h2><p>So, can i call the funtion f like this?<br>customfunction.f(x,y);</p><p>Ok, the z ranges from 1 to 100. And x and y range from 1 to 1000.<br>So. Thatâ€™s not a huge amount of data.</p><p>The easy idea it to try each xy pairs. I need try a million time to get all pairs. </p><p>Considering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findSolution</span><span class="params">(CustomFunction customfunction, <span class="type">int</span> z)</span> &#123;</span><br><span class="line">        <span class="comment">// customfunction.f(x,y);</span></span><br><span class="line">        <span class="comment">// z ranges from 1 to 100</span></span><br><span class="line">        <span class="comment">// 1 &lt;= x, y &lt;= 1000</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// the easy idea is try each x and y to get all pairs.</span></span><br><span class="line">        <span class="comment">// I only need to try a million times to get all answer</span></span><br><span class="line">        <span class="comment">// Let&#x27;s consider that f is an increasing function. so i can do it by multiplying</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// for each x, Use the dichotomy to find y</span></span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; ans=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> x=<span class="number">1</span>;x&lt;<span class="number">1000</span>;x++)&#123; <span class="comment">// trying all possible x</span></span><br><span class="line">            <span class="type">int</span> l=<span class="number">1</span>,r=<span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">while</span>(l&lt;=r)&#123; <span class="comment">// for each x, using dichotomy to find the target y.</span></span><br><span class="line">                <span class="type">int</span> mid=(l+r)/<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span>(customfunction.f(x,mid)==z)&#123;</span><br><span class="line">                    List&lt;Integer&gt; item=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                    item.add(x);</span><br><span class="line">                    item.add(mid);</span><br><span class="line">                    ans.add(item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(customfunction.f(x,mid)&gt;z) r=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> l=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="solution-02"><a href="#solution-02" class="headerlink" title="solution 02"></a>solution 02</h2><p>// x=500 y=100;  fâ€™s return value is  z.<br>// And than, x goes up to 501.<br>// x=501 y!=100-1000<br>// Beacuse function f is increasing. So y canâ€™t be a bigger number than 100.<br>// Based on this idea, i can reduce the time complexity to O(x+y)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findSolution</span><span class="params">(CustomFunction customfunction, <span class="type">int</span> z)</span> &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class="line">        <span class="type">int</span> y=<span class="number">1000</span>; <span class="comment">// I&#x27;m defining y here as the maximum 1000</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">1</span>; x &lt;= <span class="number">1000</span> &amp;&amp; y &gt;= <span class="number">1</span>; x++) &#123; <span class="comment">// trying each x, and keep y bigger than 1</span></span><br><span class="line">            <span class="keyword">while</span> (y &gt;= <span class="number">1</span> &amp;&amp; customfunction.f(x, y) &gt; z) &#123;  <span class="comment">// Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)&gt;z</span></span><br><span class="line">                y--;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// At this time, judge whether f(x,y) equals z;</span></span><br><span class="line">          <span class="comment">// if it&#x27;s true,add this pair the ans list.</span></span><br><span class="line">            <span class="keyword">if</span> (y &gt;= <span class="number">1</span> &amp;&amp; customfunction.f(x, y) == z) &#123;</span><br><span class="line">                List&lt;Integer&gt; pair = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">                pair.add(x);</span><br><span class="line">                pair.add(y);</span><br><span class="line">                res.add(pair);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1139 Largest 1-Bordered Square</title>
      <link href="/2023/02/17/lc1139-Largest-1-Bordered-Square/"/>
      <url>/2023/02/17/lc1139-Largest-1-Bordered-Square/</url>
      
        <content type="html"><![CDATA[<p>Given a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesnâ€™t exist in the grid.</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: grid = [[1,1,1],[1,0,1],[1,1,1]]</span><br><span class="line">Output: 9</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: grid = [[1,1,0,0]]</span><br><span class="line">Output: 1</span><br></pre></td></tr></table></figure><p>The easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ï¼š</p><ol><li><p>storage the number of consecutive ones in the direction of vertical and horizontal for each points.</p></li><li><p>Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i use a array con[i][j][0] and con[i][j][1].</span><br><span class="line"></span><br><span class="line">con[i][j][0] 1 -</span><br><span class="line">con[i][j][1] 1 |</span><br><span class="line"></span><br><span class="line">*---*</span><br><span class="line">|   |</span><br><span class="line">|   |</span><br><span class="line">|   |</span><br><span class="line">*---P</span><br><span class="line">try 3</span><br><span class="line">if con[i-2][j][0]&gt;=3 &amp;&amp; con[i][j-2][1]&gt;=3 </span><br><span class="line">the square can be formedï¼›</span><br><span class="line">Update the area of the largest rectangleï¼›</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int largest1BorderedSquare(int[][] grid) &#123;</span><br><span class="line"></span><br><span class="line">        // con[i][j][0] number of 1 in the direction of y</span><br><span class="line">        // The number of consecutive ones in the vertical direction</span><br><span class="line">        // con[i][j][1] number of 1 in the direction of x</span><br><span class="line">        // The number of consecutive ones in the horizontal direction</span><br><span class="line"></span><br><span class="line">        int m=grid.length,n=grid[0].length;</span><br><span class="line"></span><br><span class="line">        int[][][] con=new int[m][n][2];</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class="line">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class="line">                if(grid[i][j]==1)&#123;</span><br><span class="line">                    if(i&gt;0) con[i][j][1]=con[i-1][j][1]+1;</span><br><span class="line">                    else con[i][j][1]=1;</span><br><span class="line">                    if(j&gt;0) con[i][j][0]=con[i][j-1][0]+1;</span><br><span class="line">                    else con[i][j][0]=1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //System.out.println(con[2][2][0]+&quot; &quot;+con[2][2][1]);</span><br><span class="line">        //System.out.println(con[2][0][0]+&quot; &quot;+con[2][0][1]);</span><br><span class="line">        //System.out.println(con[0][2][0]+&quot; &quot;+con[0][2][1]);</span><br><span class="line"></span><br><span class="line">        int ans=0;</span><br><span class="line">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class="line">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class="line">                // I need to go through the length of the edge from the largest to the smallest</span><br><span class="line">                for(int k=Math.min(con[i][j][0],con[i][j][1]);k&gt;0;k--)&#123;</span><br><span class="line">                    </span><br><span class="line">                    // *---k</span><br><span class="line">                    // ï½œ   |</span><br><span class="line">                    // ï½œ.  |</span><br><span class="line">                    // ï½œ.  |</span><br><span class="line">                    // k---p</span><br><span class="line">                    if(con[i-k+1][j][0]&gt;=k &amp;&amp; con[i][j-k+1][1]&gt;=k)&#123;</span><br><span class="line">                        ans=Math.max(ans,k*k);</span><br><span class="line">                        //System.out.println(i+&quot; &quot;+j+&quot; &quot;+k+&quot; &quot;+);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return ans;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc 1234 - Sliding window</title>
      <link href="/2023/02/13/lc-1234-Sliding-window/"/>
      <url>/2023/02/13/lc-1234-Sliding-window/</url>
      
        <content type="html"><![CDATA[<h2 id="Puzzle"><a href="#Puzzle" class="headerlink" title="Puzzle"></a>Puzzle</h2><p>You are given a string s of length n containing only four kinds of characters: â€˜Qâ€™, â€˜Wâ€™, â€˜Eâ€™, and â€˜Râ€™.</p><p>A string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.</p><p>Return the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Input: s = &quot;QWER&quot;</span><br><span class="line">Output: 0</span><br><span class="line">Explanation: s is already balanced.</span><br><span class="line"></span><br><span class="line">Input: s = &quot;QQWE&quot;</span><br><span class="line">Output: 1</span><br><span class="line">Explanation: We need to replace a &#x27;Q&#x27; to &#x27;R&#x27;, so that &quot;RQWE&quot; (or &quot;QRWE&quot;) is balanced.</span><br><span class="line"></span><br><span class="line">Input: s = &quot;QQQW&quot;</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: We can replace the first &quot;QQ&quot; to &quot;ER&quot;. </span><br></pre></td></tr></table></figure><h2 id="My-Answer"><a href="#My-Answer" class="headerlink" title="My Answer"></a>My Answer</h2><h3 id="Idea1-fault"><a href="#Idea1-fault" class="headerlink" title="Idea1 (fault)"></a>Idea1 (fault)</h3><p>// For each string, I can replace the entire string to solve the problem<br>// But that doesnâ€™t satisfy the problem that i need to find the minimum Length of the subString<br>// Assume the followingï¼š<br>// xxxx ã€sub stringã€‘ xxxx<br>// For the strings on both sides, the balance has been reached</p><p>// so i only need to  rplace the ã€sub stringã€‘, the section.<br>// it no need for me to know how to replace it ,or which kinds of characters in the ã€sub stringã€‘<br>// So now the question becomes, how do you find aã€sub stringã€‘which can keep two sides strings balanced. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// dp[i][j] = true / false</span><br><span class="line">// dp[0][n-1] =true</span><br><span class="line">// dp[i][j]= true (  dp[i-2][j+2]==true &amp;&amp; s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )</span><br><span class="line">// dp[i][j]= false </span><br></pre></td></tr></table></figure><p>However, the time complexity of this answer is o(n^2). And this state transition equation doesnâ€™t work.</p><h2 id="Idea2"><a href="#Idea2" class="headerlink" title="Idea2"></a>Idea2</h2><p>Actually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to stringâ€™s length/4. So , what i need to do is keep the num of each character in both side of the sub string less than stringâ€™s length divided by 4.  As long as itâ€™s less than a quarter, I can complete the missing part in the sub string.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(<span class="type">int</span>[] con,<span class="type">int</span> qtr)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(con[<span class="string">&#x27;Q&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;W&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;E&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;R&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>To find the minimum sub string, i can maintain a array to storage each characterâ€™s number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun windowâ€™s size.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">balancedString</span><span class="params">(String s)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] con=<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>]; <span class="comment">// QWER</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            con[s.charAt(i)-<span class="string">&#x27;A&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ans=s.length();</span><br><span class="line">        <span class="type">int</span> qtr=s.length()/<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> r=<span class="number">0</span>,l=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//if(check(con,qtr)) return 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(r=<span class="number">0</span>;r&lt;s.length();r++)&#123;</span><br><span class="line">            con[s.charAt(r)-<span class="string">&#x27;A&#x27;</span>]--;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(l&lt;s.length() &amp;&amp; check(con,qtr))&#123;</span><br><span class="line">            </span><br><span class="line">                ans=Math.min(ans,r-l+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//System.out.println(r+&quot; &quot;+l);</span></span><br><span class="line">                l++;</span><br><span class="line">                con[s.charAt(l-<span class="number">1</span>)-<span class="string">&#x27;A&#x27;</span>]++;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>libbpf spinglock &amp; map</title>
      <link href="/2023/02/10/libbpf-01/"/>
      <url>/2023/02/10/libbpf-01/</url>
      
        <content type="html"><![CDATA[<h2 id="minimal"><a href="#minimal" class="headerlink" title="minimal"></a>minimal</h2><ol><li>bpfç¨‹åºï¼Œè¿™ä¸€ä»£ç ä¼šè¢«åŠ è½½è¿›bpfè™šæ‹Ÿæœºï¼Œç”±äº‹ä»¶è§¦å‘æ‰§è¡Œã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> my_pid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ ELF section</span></span><br><span class="line">SEC(<span class="string">&quot;tp/syscalls/sys_enter_write&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_tp</span><span class="params">(<span class="type">void</span> *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// globleå˜é‡ï¼Œè¯»å–pid</span></span><br><span class="line"><span class="type">int</span> pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pid != my_pid)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‘pipeå‘é€å­—ç¬¦ä¸²</span></span><br><span class="line">bpf_printk(<span class="string">&quot;BPF triggered from PID %d.\n&quot;</span>, pid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ç”¨æˆ·ç©ºé—´ä»£ç </li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;minimal.skel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">libbpf_print_fn</span><span class="params">(<span class="keyword">enum</span> libbpf_print_level level, <span class="type">const</span> <span class="type">char</span> *format, va_list args)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, format, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">minimal_bpf</span> *<span class="title">skel</span>;</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">libbpf_set_strict_mode(LIBBPF_STRICT_ALL);</span><br><span class="line"><span class="comment">/* Set up libbpf errors and debug info callback */</span></span><br><span class="line">libbpf_set_print(libbpf_print_fn);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Open BPF application */</span></span><br><span class="line">skel = minimal_bpf__open();</span><br><span class="line"><span class="keyword">if</span> (!skel) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to open BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ensure BPF program only handles write() syscalls from our process */</span></span><br><span class="line">skel-&gt;bss-&gt;my_pid = getpid();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Load &amp; verify BPF programs */</span></span><br><span class="line">err = minimal_bpf__load(skel);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to load and verify BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attach tracepoint handler */</span></span><br><span class="line">err = minimal_bpf__attach(skel);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &quot;</span></span><br><span class="line">       <span class="string">&quot;to see output of the BPF programs.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">/* è§¦å‘bpfç¨‹åºï¼Œç”¨äºæµ‹è¯• */</span></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">minimal_bpf__destroy(skel);</span><br><span class="line"><span class="keyword">return</span> -err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="bpf-Spinlocks"><a href="#bpf-Spinlocks" class="headerlink" title="bpf Spinlocks"></a>bpf Spinlocks</h2><p><a href="https://libbpf.readthedocs.io/en/latest/program_types.html">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p><p><a href="https://libbpf.readthedocs.io/en/latest/program_types.html">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p><p>spinglockç›®å‰æ— æ³•ç”¨äºtrackingå’Œsccket filterç›¸å…³ELF</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png" alt="æˆªå±2023-02-10 18.15.29"></p><p><a href="https://www.edony.ink/deepinsight-of-ebpf-map/">https://www.edony.ink/deepinsight-of-ebpf-map/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MITOSIS by WASM-ebpf in Faasmï¼ˆåŸºäºWASM-eBPFçš„è¿œç¨‹WASMè™šæ‹ŸæœºçŠ¶æ€æ‹·è´ï¼‰</title>
      <link href="/2023/02/07/MITOSIS-by-WASM-ebpf-in-Faasm/"/>
      <url>/2023/02/07/MITOSIS-by-WASM-ebpf-in-Faasm/</url>
      
        <content type="html"><![CDATA[<h2 id="è¿œç¨‹Forkçš„ä¸¤ç§è·¯çº¿"><a href="#è¿œç¨‹Forkçš„ä¸¤ç§è·¯çº¿" class="headerlink" title="è¿œç¨‹Forkçš„ä¸¤ç§è·¯çº¿"></a>è¿œç¨‹Forkçš„ä¸¤ç§è·¯çº¿</h2><p>ç”±äºMITOSISå¯¹ç¡¬ä»¶æœ‰ç¡¬æ€§è¦æ±‚ï¼Œä¸”éœ€è¦ä¿®æ”¹å†…æ ¸ï¼Œé€šç”¨æ€§ç›¸å¯¹è¾ƒä½ã€‚å› æ­¤å°è¯•å°†MITOSISç§»æ¤ä¸ºä¸€ä¸ªå¯åœ¨eBPFä¸­è¿è¡Œçš„æ¨¡å—ã€‚ä¸‹æ–‡å°†ç§»æ¤åçš„MITOSISç§°ä¸ºMITOSIS-eBPFã€‚</p><p>ç›®å‰å®ç°MITOSIS-eBPFæœ‰ä¸¤ç§æ€è·¯ï¼š </p><h3 id="1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹"><a href="#1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹" class="headerlink" title="1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹"></a>1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹</h3><p>åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹çŠ¶æ€ï¼Œè¿™ä¸€æ€è·¯ä¸åŸç”ŸMITOSISä¸€è‡´ï¼Œéœ€å®ç°ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å¯¹â€œè¢«Forkè¿›ç¨‹â€è¿›è¡ŒMetadataå¿«ç…§ï¼Œå¹¶å°†æ­¤å¿«ç…§ä¼ é€’ç»™â€œå­è¿›ç¨‹â€</li><li>å­è¿›ç¨‹éœ€æ ¹æ®pteæ¢çŸ¥è¯¥Pageæ˜¯å¦åœ¨æœ¬åœ°ï¼Œè‹¥ä¸åœ¨æœ¬åœ°ï¼Œåˆ™éœ€è¦è¿›è¡Œè¿œç¨‹é¡µè·å–</li><li>MITOSIS-eBPFéœ€è¦èƒ½å¤Ÿè¯»å–æŒ‡å®šè¿›ç¨‹çš„æ•°æ®ï¼Œä»è€Œé€šè¿‡rpc/RDMAç­‰æ–¹å¼ä¼ é€’ç»™å­è¿›ç¨‹</li></ol><p>å…¶ä¸­æ­¥éª¤äºŒï¼ŒåŸç”ŸMITOSISçš„å®ç°æ–¹å¼æ˜¯åˆ©ç”¨pteä¸­æœªè¢«ä½¿ç”¨çš„é«˜ä½ä½œä¸ºæ ‡è®°ï¼Œä»è€Œåˆ¤æ–­è¯¥pageæ˜¯å¦åœ¨æœ¬åœ°ã€‚è¿™ä¸€æ“ä½œæ¶‰åŠå†…æ ¸ä¿®æ”¹ï¼Œä¼¼ä¹æ— æ³•é€šè¿‡eBPFå®ç°ï¼Œå› æ­¤â€œåœ¨å†…æ ¸æ¢å¤è¿›ç¨‹â€è¿™ä¸€æ–¹æ¡ˆæ— æ³•é¿å…ä¿®æ”¹å†…æ ¸ã€‚å› æ­¤ï¼Œæ­¤æ–¹æ¡ˆæ— æ³•å®Œç¾å®ç°MITOSIS-eBPFçš„éœ€æ±‚ï¼Œæ€§ä»·æ¯”ç•¥ä½ã€‚</p><h3 id="2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹"><a href="#2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹" class="headerlink" title="2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹"></a>2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹</h3><p>é’ˆå¯¹Faasmè¿™ä¸€Serverlesså¹³å°ï¼ŒFaasmä¸­çš„Functionå®é™…è¿è¡Œåœ¨WASMè™šæ‹Ÿæœºä¸­ã€‚å› æ­¤æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œè¿œç¨‹Forkï¼š</p><ol><li>å­è¿›ç¨‹çš„WASMè™šæ‹Ÿæœºåˆå§‹åŒ–</li><li>åˆ©ç”¨WASM-eBPFï¼Œä»â€œè¢«Forkè¿›ç¨‹â€è·å–ç›¸å…³æ•°æ®ï¼Œåœ¨WASMè™šæ‹Ÿæœºä¸­è¿›è¡ŒçŠ¶æ€æ¢å¤</li><li>è‹¥å­è¿›ç¨‹çš„WASMè™šæ‹Ÿæœºé‡åˆ°ç¼ºé¡µï¼Œåˆ™åˆ©ç”¨WASM-eBPFä»è¿›è¡Œè¿œç¨‹é¡µè·å–</li></ol><p>è¿™ä¸€æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š</p><ol><li>Faasmä½¿ç”¨äº†Photo Faasletå¿«ç…§+COWè¿›è¡Œå†·å¯åŠ¨åŠ é€Ÿï¼Œå› æ­¤â€œåœ¨WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹çŠ¶æ€â€çš„å¯è¡Œæ€§å·²çŸ¥</li><li>å®Œå…¨é¿å…ä¿®æ”¹å†…æ ¸</li><li>ç”±äºå­˜åœ¨WASM-eBPFå·¥å…·ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸/ç½‘ç»œçš„é€šä¿¡é€Ÿåº¦ä¼šæœ‰å¾ˆå¤§æå‡ã€‚</li></ol><p>è¿™ä¸€æ–¹æ¡ˆçš„å¯èƒ½ç¼ºç‚¹ï¼š</p><ol><li>ç”±äºç”¨æˆ·æ€COWè¿‡ç¨‹è·¨è¶Šäº†è¾ƒå¤šå±‚ï¼Œè‹¥Functionæ¶‰åŠè¾ƒå¤šçš„è¿œç¨‹é¡µè·å–ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œè¾ƒæ…¢ï¼Œç”šè‡³æœ‰å¯èƒ½æ…¢äºåŸç”ŸFaasmçš„å†·å¯åŠ¨ã€‚<br> MITOSISæœ‰Non-COWçš„è¯„ä¼°ï¼ˆä¸€æ¬¡æ€§è¯»å–å…¨éƒ¨Parentå†…å­˜ï¼‰ï¼Œå½“é¢„å–å¤§å°ä¸º1æ—¶ï¼ŒCOWçš„å¹³å‡æ—¶å»¶æ¯”Non-COWä½8.7%(0.6% ~ 44%)å’Œ3.7% (-5% ~ 31%)ã€‚è€ƒè™‘åˆ°åŸç”ŸFaasmå†·å¯åŠ¨æ˜¯ä»å¯¹è±¡å­˜å‚¨ä¸­ä¸‹è½½å¿«ç…§ï¼Œå› æ­¤æœ‰è¾ƒå¤§æ¦‚ç‡è·å¾—æ”¶ç›Šã€‚</li><li>é€šç”¨æ€§ç•¥ä½ï¼Œè¿™ä¸€æ–¹æ¡ˆå¯ä»¥è®¤ä¸ºæ˜¯é’ˆå¯¹Faasmè¿›è¡Œæ”¹è¿›æ‹“å±•ã€‚<br> ï¼ˆ<strong>ç†è®ºä¸Šè¯¥æ–¹æ¡ˆå¯ä»¥æ‹“å±•ä¸ºâ€œåŸºäºWASM-eBPFçš„è¿œç¨‹WASMè™šæ‹ŸæœºçŠ¶æ€æ‹·è´æœºåˆ¶â€</strong>ï¼Œä½†ä¾ç„¶å¹¶éé’ˆå¯¹ä»»ä½•è¿›ç¨‹çš„é€šç”¨æ–¹æ¡ˆï¼‰</li></ol><h2 id="åœ¨WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯"><a href="#åœ¨WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯" class="headerlink" title="åœ¨WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯"></a>åœ¨WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯</h2><p>åˆæ­¥çœ‹æ¥æ²¡æ³•å®ç°æœ‰æ”¶ç›Šçš„â€œåœ¨WASMä¸­æ¢å¤è¿›ç¨‹â€</p><h3 id="0-æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼çš„æŠ€æœ¯äº†"><a href="#0-æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼çš„æŠ€æœ¯äº†" class="headerlink" title="0.æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼çš„æŠ€æœ¯äº†"></a>0.æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼çš„æŠ€æœ¯äº†</h3><p>NO</p><h3 id="1-Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€"><a href="#1-Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€" class="headerlink" title="1.Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€"></a>1.Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€</h3><p>Faasmç”¨äº† WARMé‡Œçš„AOTæ¥å£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aot_comp_context_t</span><br><span class="line">aot_create_comp_context(aot_comp_data_t comp_data, aot_comp_option_t option);</span><br></pre></td></tr></table></figure><p>æ¢å¤ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„æ¥å£</p><h4 id="2-èƒ½å¦æ”¯æŒä»WSVMè¯»å–å†…å­˜æ•°æ®"><a href="#2-èƒ½å¦æ”¯æŒä»WSVMè¯»å–å†…å­˜æ•°æ®" class="headerlink" title="2.èƒ½å¦æ”¯æŒä»WSVMè¯»å–å†…å­˜æ•°æ®"></a>2.èƒ½å¦æ”¯æŒä»WSVMè¯»å–å†…å­˜æ•°æ®</h4><p>åªèƒ½ä»ç£ç›˜ä¸Šè¯»ï¼Œå› æ­¤å¾ˆæ…¢ï¼Œä¼°è®¡ä¸ä¼šæœ‰æ”¶ç›Šã€‚</p><h3 id="3-ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ"><a href="#3-ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ" class="headerlink" title="3.ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ"></a>3.ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ</h3><p><a href="https://www.cnxct.com/lessons-using-ebpf-accelerating-cloud-native-zh/">https://www.cnxct.com/lessons-using-ebpf-accelerating-cloud-native-zh/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Faasm / WASM serverless</title>
      <link href="/2023/02/06/Faasm-WASM-serverless/"/>
      <url>/2023/02/06/Faasm-WASM-serverless/</url>
      
        <content type="html"><![CDATA[<p>è®ºæ–‡åœ°å€ï¼š<a href="https://arxiv.org/abs/2002.09344">https://arxiv.org/abs/2002.09344</a></p><h2 id="Faaslet-Faasmæ€»ç»“"><a href="#Faaslet-Faasmæ€»ç»“" class="headerlink" title="Faaslet/Faasmæ€»ç»“"></a>Faaslet/Faasmæ€»ç»“</h2><h3 id="1ï¼‰Faaslet"><a href="#1ï¼‰Faaslet" class="headerlink" title="1ï¼‰Faaslet"></a>1ï¼‰Faaslet</h3><p>Faasletæ˜¯ä¸€ç§software-based isolationã€‚è¿™æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½æ— æœåŠ¡è®¡ç®—çš„éš”ç¦»æŠ½è±¡ã€‚Faasletä½¿ç”¨WebAssemblyæä¾›çš„è½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼Œ<em>software-fault isolation</em>, provided by <em>WebAssembly</em>ï¼‰æ¥éš”ç¦»å·²æ‰§è¡Œå‡½æ•°çš„å†…å­˜ï¼Œå¹¶å…è®¸åŒä¸€åœ°å€ç©ºé—´çš„å‡½æ•°ä¹‹é—´å…±äº«å†…å­˜åŒºåŸŸã€‚</p><p>Faasletå…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ol><li><a href="#is">éš”ç¦»</a>ï¼šæ¯ä¸ªfassletç”±ä¸€ä¸ªthreadè¿›è¡Œæ‰§è¡Œï¼Œåˆ©ç”¨CGroupè¿›è¡Œçº¦æŸ</li><li>ä¸ºå®ç°é«˜æ•ˆçš„Functioné—´é€šä¿¡ï¼Œ1ï¼‰æä¾›æœ¬åœ°<a href="#memy">å…±äº«å†…å­˜æœºåˆ¶</a>ï¼ˆç”±WASMçš„ç‰¹æ€§ä¿è¯å†…å­˜å®‰å…¨ï¼Œ<a href="https://zhuanlan.zhihu.com/p/386849387">WASMå†…å­˜æ¨¡å‹</a>ï¼‰ã€‚2ï¼‰åŒæ—¶æä¾›ç”±distributed key-value store (KVSï¼ŒRedis)æ”¯æŒçš„å…¨å±€çŠ¶æ€å…±äº«</li><li>ä¸ºäº†Functionå¯ä»¥<strong>å®‰å…¨</strong>ä¸”<strong>é«˜æ•ˆ</strong>çš„è¿›è¡ŒåŠŸèƒ½è°ƒç”¨ï¼Œå®ç°äº†<a href="#inter">Host interface</a> APIï¼ˆç±»<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">POSIX</a>çš„å­é›†ï¼ŒåŸºäºWASIï¼‰ï¼Œfunctionå¯ä»¥è°ƒç”¨APIä»¥ä½¿ç”¨å„ç§ç³»ç»ŸåŠŸèƒ½ï¼ˆç›¸å½“äºåœ¨å‡½æ•°å’Œosä¹‹é—´åŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼Œå®ç°äº†ä½æ°´å¹³çš„è™šæ‹ŸåŒ–ï¼‰ã€‚ä½¿ç”¨message busä¸çˆ¶è¿›ç¨‹é€šä¿¡ï¼Œæ¥æ”¶å‡½æ•°è°ƒç”¨ã€å…±äº«ã€è°ƒç”¨å’Œç­‰å¾…å…¶ä»–å‡½æ•°ç­‰ä¿¡æ¯</li><li>å¿«é€Ÿå¯åŠ¨ï¼ŒFaasmä½¿ç”¨å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ä¸­çš„Proto-Faasletå¿«ç…§ä¼˜åŒ–å†·å¯åŠ¨æ—¶é—´ ã€‚</li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png" alt="æˆªå±2023-02-06 12.58.20"></p><h3 id="2ï¼‰Faasm"><a href="#2ï¼‰Faasm" class="headerlink" title="2ï¼‰Faasm"></a>2ï¼‰Faasm</h3><p>Faasmæ˜¯ä¸€ä¸ªè´Ÿè´£è°ƒåº¦Faasletçš„runtimeã€‚Faasmå¯ä»¥ç®¡ç†å¤šä¸ªFaasletã€‚Faasmé€šè¿‡Faasletçš„çŠ¶æ€å…±äº«æœºåˆ¶è¿›è¡Œè°ƒåº¦ã€‚</p><p>å¦‚ä¸‹å›¾ï¼ŒABCä¸‰ä¸ªå‡½æ•°è°ƒç”¨äº‹ä»¶ï¼ŒFaasm instance1å…·æœ‰å®ä¾‹Aï¼Œå› æ­¤ç›´æ¥æ‰§è¡Œã€‚Faasm instance1 ç¼ºå°‘BCå®ä¾‹ï¼Œä¸ºäº†é¿å…å†·å¯åŠ¨ï¼Œåˆ™å°†BCä»»åŠ¡å…±äº«åˆ°Faasm instance2.</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png" alt="æˆªå±2023-02-06 14.19.51"></p><p>æ­¤å¤–ï¼ŒFaasmä½¿ç”¨LLVMç¼–è¯‘functionï¼Œç”¨WAVMè¿›è¡Œæ‰§è¡Œã€‚</p><blockquote><p>ç¼–è¯‘è¿‡ç¨‹ï¼š<br>(1) ç”¨æˆ·è°ƒç”¨Faasletå·¥å…·é“¾å°†å‡½æ•°ç¼–è¯‘æˆWebAssemblyäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé“¾æ¥åˆ°Faaslet host interfaceçš„ç‰¹å®šè¯­è¨€å£°æ˜;<br>(2) ç”Ÿæˆä¸€ä¸ªç”±WebAssemblyåˆ›å»ºçš„â€œobject file with machine codeâ€<br>(3) Host interfaceä¸machine codeé“¾æ¥ä»¥ç”ŸæˆFaasletå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆFaaslet executableï¼‰</p></blockquote><h2 id="å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°"><a href="#å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°" class="headerlink" title="å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°"></a>å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°</h2><p>ç”±äºWASMå…·æœ‰<strong>å†…å­˜å®‰å…¨</strong>çš„ç‰¹æ€§ï¼Œä½¿ç”¨WASMå®ç°è½»é‡çº§çš„éš”ç¦»ï¼Œä»¥å–å¾—è¾ƒé«˜çš„æ€§èƒ½ï¼š</p><ol><li>å°†ç”¨æˆ·functionç¼–è¯‘æˆWebAssemblyï¼Œé‡‡ç”¨WASM runtimeï¼ˆä¾‹å¦‚WAVMï¼‰å¯¹functionè¿›è¡Œ<strong>æ‰§è¡Œ</strong>ã€‚</li><li><strong>æ‰§è¡Œ</strong>æ“ä½œç”±â€œè°ƒåº¦å™¨â€è¿›è¡Œï¼ˆFaasmï¼‰ï¼Œâ€œè°ƒåº¦å™¨â€ä½¿ç”¨ä¸€ä¸ªâ€œæ‰§è¡Œçº¿ç¨‹â€è¿›è¡Œfunctionæ‰§è¡Œå’Œè°ƒåº¦ï¼Œå¹¶ä½¿ç”¨CGroupå¯¹â€œæ‰§è¡Œçº¿ç¨‹â€è¿›è¡Œçº¦æŸã€‚</li><li>ä¸ºäº†å®ç°å®Œæ•´çš„serverlesså¹³å°ï¼Œä¾‹å¦‚æä¾›ioè°ƒç”¨ã€functioné—´çŠ¶æ€å…±äº«ï¼Œéœ€è¦åŠ å…¥ç›¸åº”çš„APIæ”¯æŒï¼ˆFaaaletsæä¾›äº†ç›¸åº”çš„APIâ€”â€”Host interfaceï¼‰ï¼Œä¾›ç”¨æˆ·functionè°ƒç”¨ã€‚</li></ol><hr><p><em>ç»†èŠ‚éƒ¨åˆ†</em>:</p><h2 id="Faasletæ¦‚è¿°"><a href="#Faasletæ¦‚è¿°" class="headerlink" title="Faasletæ¦‚è¿°"></a>Faasletæ¦‚è¿°</h2><p>Faasletæ˜¯ä¸€ç§software-based isolationã€‚è¿™æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½æ— æœåŠ¡å™¨è®¡ç®—çš„æ–°çš„éš”ç¦»æŠ½è±¡ã€‚Faasletä½¿ç”¨WebAssemblyæä¾›çš„è½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼Œ<em>software-fault isolation</em> (SFI), provided by <em>WebAssembly</em>ï¼‰æ¥éš”ç¦»å·²æ‰§è¡Œå‡½æ•°çš„å†…å­˜ï¼ŒåŒæ—¶å…è®¸åŒä¸€åœ°å€ç©ºé—´çš„å‡½æ•°ä¹‹é—´å…±äº«å†…å­˜åŒºåŸŸã€‚</p><p> FAASMæ˜¯ä¸€ä¸ªåŸºäºFaasletçš„runtimeï¼Œä½¿ç”¨æ ‡å‡†çš„Linux cgroupséš”ç¦»å…¶ä»–èµ„æºï¼Œå¦‚CPUå’Œç½‘ç»œã€‚å¹¶ä¸ºç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿè®¿é—®å’ŒåŠ¨æ€åŠ è½½æä¾›ä¸€ä¸ªä½çº§åˆ«çš„POSIXä¸»æœºæ¥å£</p><blockquote><p>ç°åœ¨çš„å®¹å™¨/vmï¼Œå¯åŠ¨æ…¢ï¼Œå†…å­˜å ç”¨å¤§</p></blockquote><p>æ— æœåŠ¡å™¨è®¡ç®—å¯ä»¥é€šè¿‡ä¸€ç§æ–°çš„isolation abstractionï¼Œä»¥æ›´å¥½åœ°æ”¯æŒæ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºï¼š</p><p>(i) åœ¨å‡½æ•°ä¹‹é—´ï¼Œæä¾›å¼ºçš„<strong>å†…å­˜å’Œèµ„æºéš”ç¦»</strong>ï¼Œä¿è¯å®‰å…¨æ€§<br>(ii) æ”¯æŒé«˜æ•ˆçš„<strong>çŠ¶æ€å…±äº«</strong>ã€‚æ•°æ®åº”è¯¥ä¸åŠŸèƒ½å…±å­˜ï¼ˆco-locatedï¼‰ï¼Œå¹¶ç›´æ¥è·å–ï¼Œå°½é‡å‡å°‘æ•°æ®è¿è¾“<br>(iii) å…è®¸åœ¨å¤šä¸ªä¸»æœºä¸Šæ‰©å±•çŠ¶æ€<br>(iv) ä½å†…å­˜æ¶ˆè€—ï¼Œå…è®¸åœ¨ä¸€å°æœºå™¨ä¸Šæœ‰è®¸å¤šå®ä¾‹ï¼›<br>(v) å¿«é€Ÿçš„å®ä¾‹åŒ–<br>(vi) æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€</p><p>ä¸ºäº†å®ç°ä»¥ä¸Šç‰¹æ€§ï¼ŒFaasletå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ol><li><strong>Faaslesè½»é‡çº§çš„éš”ç¦»</strong><br> Faasletä¾èµ–äºè½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼‰ï¼Œå®ƒå°†å‡½æ•°é™åˆ¶åœ¨å¯¹å…¶è‡ªèº«å†…å­˜çš„è®¿é—®ã€‚ä¸€ä¸ªä¸Faasletå‡½æ•°ï¼Œè¿åŒå…¶åº“å’Œè¯­è¨€è¿è¡Œæ—¶çš„ä¾èµ–ï¼Œè¢«ç¼–è¯‘æˆWebAssemblyã€‚FAASMè¿è¡Œæ—¶åœ¨ä¸€ä¸ªåœ°å€ç©ºé—´å†…æ‰§è¡Œå¤šä¸ªFaasletï¼Œæ¯ä¸ªéƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çº¿ç¨‹ã€‚ä¸ºäº†å®ç°èµ„æºéš”ç¦»ï¼Œæ¯ä¸ªçº¿ç¨‹çš„CPUå‘¨æœŸä½¿ç”¨Linux cgroupsè¿›è¡Œçº¦æŸï¼Œç½‘ç»œè®¿é—®ä½¿ç”¨â€œ<em>network namespaces</em>â€å’Œâ€œ<em>traffic shaping</em>â€è¿›è¡Œé™åˆ¶ã€‚</li><li><strong>faaslet é«˜æ•ˆæœ¬åœ°/å…¨å±€çŠ¶æ€è®¿é—®</strong><br> ç”±äºfaasletå…±äº«ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œå®ƒä»¬å¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨æœ¬åœ°çŠ¶æ€è®¿é—®å…±äº«å†…å­˜åŒºåŸŸã€‚è¿™å…è®¸æ•°æ®å’Œå‡½æ•°çš„å…±åŒå®šä½ï¼Œå¹¶é¿å…ä¸²è¡ŒåŒ–çš„å¼€é”€ã€‚faasletä½¿ç”¨ä¸¤å±‚çŠ¶æ€æ¶æ„ï¼Œæœ¬åœ°å±‚æä¾›å†…å­˜å…±äº«ï¼Œå…¨å±€å±‚æ”¯æŒè·¨ä¸»æœºåˆ†å¸ƒå¼è®¿é—®çŠ¶æ€ã€‚<br> Faasmè¿è¡Œæ—¶ä¸ºFaasletæä¾›äº†ä¸€ä¸ªçŠ¶æ€ç®¡ç†APIï¼Œå¯ä»¥å¯¹ä¸¤å±‚çš„çŠ¶æ€è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚</li><li><strong>faasletå¿«é€Ÿåˆå§‹åŒ–</strong><br> ä¸ºäº†å‡å°‘Faasletç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶çš„å†·å¯åŠ¨æ—¶é—´ï¼ŒFaasletä»suspended stateå¯åŠ¨<br> suspended stateï¼šFAASMé¢„å…ˆåˆå§‹åŒ–ä¸€ä¸ªFaasletï¼Œå¹¶å¯¹å…¶å†…å­˜è¿›è¡Œå¿«ç…§ä»¥è·å¾—ä¸€ä¸ªåŸå§‹Faasletã€‚proto-Faasletç”¨äºå¿«é€Ÿåˆ›å»ºæ–°çš„Faasletå®ä¾‹ï¼Œå¯ä»¥é¿å…åˆå§‹åŒ–è¯­è¨€è¿è¡Œåº“çš„æ—¶é—´ã€‚ç†è®ºä¸Šproto - faasletæ”¯æŒè·¨ä¸»æœºæ¢å¤ï¼Œå¹¶ä¸”ä¸æ“ä½œç³»ç»Ÿæ— å…³ã€‚<br> ï¼ˆè¿™ä¸€å—ç±»ä¼¼MITOSISï¼Œæ˜¯ç›´æ¥ä½¿ç”¨äº†ä»å†…å­˜æ¢å¤è¿è¡ŒçŠ¶æ€ï¼‰</li><li><strong>Faaslet Host interface</strong><br> Faasleté€šè¿‡POSIX-like callsä¸ä¸»æœºç¯å¢ƒè¿›è¡Œäº¤äº’ã€‚åŒ…æ‹¬ç½‘ç»œã€æ–‡ä»¶I/Oã€å…¨å±€çŠ¶æ€è®¿é—®å’Œåº“åŠ è½½/é“¾æ¥ã€‚ä¸»æœºæ¥å£æä¾›äº†è¶³å¤Ÿçš„è™šæ‹ŸåŒ–ä»¥ç¡®ä¿éš”ç¦»ï¼ŒåŒæ—¶å¢åŠ çš„å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li></ol><p>FAASM runtimeä½¿ç”¨LLVMç¼–è¯‘å™¨å·¥å…·é“¾å°†åº”ç”¨ç¨‹åºè½¬æ¢ä¸ºWebAssemblyï¼Œè¿™ä¸€æ–¹æ³•æ”¯æŒç”¨å¤šç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„å‡½æ•°ã€‚å¯ç°æœ‰çš„æ— æœåŠ¡å™¨å¹³å°é›†æˆï¼Œä¾‹å¦‚Knativeã€‚</p><h2 id="Faaslet-detail-design"><a href="#Faaslet-detail-design" class="headerlink" title="Faaslet detail design"></a>Faaslet detail design</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png" alt="æˆªå±2023-02-06 12.58.20"></p><ol><li><p><a id="memy">å†…å­˜è®¾è®¡</a>ï¼šå‡½æ•°è¢«ç¼–è¯‘ä¸ºWebAssemblyï¼Œè¢«æ”¾ç½®åœ¨å®ƒè‡ªå·±çš„ç§æœ‰è¿ç»­å†…å­˜åŒºåŸŸä¸­ã€‚åŒæ—¶Faasletä¹Ÿæ”¯æŒå…±äº«å†…å­˜åŒºåŸŸï¼Œè¿™å…è®¸Faasletåœ¨WebAssemblyçš„å†…å­˜å®‰å…¨ä¿è¯çš„çº¦æŸä¸‹è®¿é—®å…±äº«çš„å†…å­˜çŠ¶æ€(å½“éœ€è¦å†…å­˜å…±äº«æ—¶ï¼ŒFaasletæ‰©å±•WASMçš„å­—èŠ‚æ•°ç»„ï¼Œä½†å°†æ–°é¡µé¢æ˜ å°„åˆ°å…¬å…±è¿›ç¨‹å†…å­˜çš„æŒ‡å®šåŒºåŸŸï¼ˆmmapï¼‰ã€‚ç„¶åå¯ä»¥ç»™å‡½æ•°ä¸€ä¸ªæŒ‡å‘å­—èŠ‚æ•°ç»„æ–°åŒºåŸŸçš„æŒ‡é’ˆï¼Œä½†æ‰€æœ‰è®¿é—®éƒ½åœ¨å…±äº«åŒºåŸŸä¸Šæ‰§è¡Œ)ã€‚<br> <img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png" alt="æˆªå±2023-02-06 15.22.09"></p></li><li><p><a id="is">éš”ç¦»</a>ï¼šfaasletç¡®ä¿äº†å…¬å¹³çš„èµ„æºè®¿é—®ã€‚å¯¹äºCPUéš”ç¦»ï¼Œä½¿ç”¨â€œLinux cgroupsçš„CPUå­é›†â€ã€‚æ¯ä¸ªå‡½æ•°éƒ½ç”±å…±äº«è¿è¡Œæ—¶è¿›ç¨‹çš„ä¸“ç”¨çº¿ç¨‹æ‰§è¡Œï¼Œè¿™ä¸ªçº¿ç¨‹è¢«åˆ†é…äº†ä¸€ä¸ªcgroupã€‚</p></li><li><p>IOæ¥å£ï¼šFaasleté€šè¿‡ç½‘ç»œå‘½åç©ºé—´ã€è™šæ‹Ÿç½‘ç»œæ¥å£å’Œæµé‡æ•´å½¢å®ç°å®‰å…¨å…¬å¹³çš„ç½‘ç»œè®¿é—®ã€‚æ¯ä¸ªFaasletåœ¨å•ç‹¬çš„åç§°ç©ºé—´ä¸­éƒ½æœ‰è‡ªå·±çš„ç½‘ç»œæ¥å£ï¼Œä½¿ç”¨iptablesè§„åˆ™è¿›è¡Œé…ç½®ã€‚ä¸ºäº†ç¡®ä¿å…±äº«ç§Ÿæˆ·ä¹‹é—´çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªFaasletä½¿ç”¨tcåœ¨å…¶è™šæ‹Ÿç½‘ç»œæ¥å£ä¸Šåº”ç”¨æµé‡æ•´å½¢ï¼Œä»è€Œå¼ºåˆ¶æ‰§è¡Œå…¥å£å’Œå‡ºå£æµé‡é€Ÿç‡é™åˆ¶ã€‚</p></li><li><p><a id="inter">Faaslet host interface</a>ï¼šFaaslet host interfaceæ˜¯ä¸€ä¸ªvirtualisation layerï¼Œæä¾›äº†ä¸€ç³»åˆ—APIï¼Œä»¥éš”ç¦»å‡½æ•°äºå¤–ç•Œç¯å¢ƒã€‚è¿™äº›æ¥å£åŸºäºWASIï¼ˆè¿™ä¸ªè®¾è®¡æœ‰ç‚¹ç±»ä¼¼gVisorï¼Œä½†æ˜¯gVisoræ˜¯æ¨¡æ‹Ÿäº†æ•´ä¸ªå†…æ ¸ï¼‰</p></li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png" alt="æˆªå±2023-02-06 13.15.25"></p><ol start="5"><li>Faasletä½¿ç”¨message busä¸çˆ¶è¿›ç¨‹ï¼ˆFaasmï¼‰é€šä¿¡ï¼Œæ¥æ”¶å‡½æ•°è°ƒç”¨ï¼Œå…±äº«å·¥ä½œï¼Œè°ƒç”¨å’Œç­‰å¾…å…¶ä»–å‡½æ•°ç­‰ä¿¡æ¯ã€‚</li><li>Proto Faasletå¿«ç…§åŒ…æ‹¬å‡½æ•°çš„å †æ ˆï¼ŒWebAssemblyè§„èŒƒçš„å‡½æ•°è¡¨ã€å †æ ˆæŒ‡é’ˆå’Œæ•°æ®ã€‚Faasmä½¿ç”¨copy-on-write memory mappingå°†å¿«ç…§è¿˜åŸåˆ°æ–°çš„Faasletä¸­ã€‚Faasmæä¾›äº†ä¸€ä¸ªHttp end pointï¼Œä¾‹å¦‚s3ï¼Œä»¥ä¾›ä¸Šä¼ å¿«ç…§.</li></ol><h2 id="FaasletçŠ¶æ€å…±äº«"><a href="#FaasletçŠ¶æ€å…±äº«" class="headerlink" title="FaasletçŠ¶æ€å…±äº«"></a>FaasletçŠ¶æ€å…±äº«</h2><p>Faasletæä¾›äº†ä¸¤å±‚æ¶æ„çš„çŠ¶æ€å…±äº«æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å¯å¸®åŠ©å®ç°Faasmçš„è°ƒåº¦ã€‚</p><p>æœ¬åœ°å±‚ï¼šæä¾›å¯¹åŒä¸€ä¸»æœºä¸Šçš„çŠ¶æ€çš„å…±äº«å†…å­˜è®¿é—®;</p><p>å…¨å±€å±‚ï¼šå…è®¸Faasletåœ¨ä¸»æœºé—´åŒæ­¥çŠ¶æ€ã€‚å…¨å±€å±‚ä½¿ç”¨distributed key-value store (KVS)å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼æ˜¯redisã€‚</p><p>DDOséšè—äº†ä¸¤å±‚çŠ¶æ€æ¶æ„ï¼Œæä¾›äº†å¯¹åˆ†å¸ƒå¼æ•°æ®çš„é€æ˜çš„è®¿é—®ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png" alt="æˆªå±2023-02-06 18.31.18"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MITOSIS test</title>
      <link href="/2023/02/02/MITOSIS-test/"/>
      <url>/2023/02/02/MITOSIS-test/</url>
      
        <content type="html"><![CDATA[<p>æœåŠ¡å™¨æ— rootæƒé™ï¼Œéœ€ä¿®æ”¹Kernelï¼Œå› æ­¤ç”¨KVMï¼ŒæŠŠdeviceæ˜ å°„åˆ°KVMé‡Œã€‚</p><h2 id="æœåŠ¡å™¨ç‰©ç†é…ç½®"><a href="#æœåŠ¡å™¨ç‰©ç†é…ç½®" class="headerlink" title="æœåŠ¡å™¨ç‰©ç†é…ç½®"></a>æœåŠ¡å™¨ç‰©ç†é…ç½®</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png" alt="æˆªå±2023-02-02 20.44.46"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig</span><br><span class="line">enp65s0f0np0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 429758  bytes 103736820 (103.7 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 804262  bytes 138138879 (138.1 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">enp66s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 431116  bytes 104497752 (104.4 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 811031  bytes 138523138 (138.5 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">enp66s0d1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 434024  bytes 104743872 (104.7 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 791748  bytes 136537921 (136.5 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><h2 id="KVMå®‰è£…ubuntu18-04"><a href="#KVMå®‰è£…ubuntu18-04" class="headerlink" title="KVMå®‰è£…ubuntu18.04"></a>KVMå®‰è£…ubuntu18.04</h2><p>æ•™ç¨‹ï¼š<a href="https://www.jianshu.com/p/d0e4ed80b8a1">https://www.jianshu.com/p/d0e4ed80b8a1</a></p><p>ä¸‹è½½ubuntué•œåƒï¼š<a href="http://mirrors.zju.edu.cn/ubuntu-releases/16.04/">http://mirrors.zju.edu.cn/ubuntu-releases/16.04/</a></p><h3 id="å®‰è£…ubuntuï¼š"><a href="#å®‰è£…ubuntuï¼š" class="headerlink" title="å®‰è£…ubuntuï¼š"></a>å®‰è£…ubuntuï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args=<span class="string">&#x27;console=ttyS0&#x27;</span></span><br></pre></td></tr></table></figure><p>å‡ºç°æƒé™ä¸è¶³æŠ¥é”™ï¼Œæ‰§è¡Œï¼šchmod 755 ~ï¼Œåé‡æ–°æ‰§è¡Œå‘½ä»¤å®‰è£…</p><h3 id="ssh-ç™»å½•è™šæ‹Ÿæœºï¼š"><a href="#ssh-ç™»å½•è™šæ‹Ÿæœºï¼š" class="headerlink" title="ssh ç™»å½•è™šæ‹Ÿæœºï¼š"></a>ssh ç™»å½•è™šæ‹Ÿæœºï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ virsh list <span class="comment">#è·å–ç›®æ ‡è™šæ‹Ÿæœºå</span></span><br><span class="line">$ virsh domifaddr [<span class="built_in">id</span> | name] <span class="comment">#è·å–è™šæ‹Ÿæœºä¿¡æ¯</span></span><br><span class="line"> Name       MAC address          Protocol     Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"> vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24</span><br><span class="line"> </span><br><span class="line">$ ssh username@192.168.122.116</span><br></pre></td></tr></table></figure><h3 id="æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤"><a href="#æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤" class="headerlink" title="æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤"></a>æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤</h3><p>å®‰è£…å®Œæ¯•åç›´æ¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ— æ³•ç™»å½•ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ virsh console ubuntu18</span><br><span class="line">Connected to domain <span class="string">&#x27;ubuntu18&#x27;</span></span><br><span class="line">Escape character is ^] (Ctrl + ]) <span class="comment">#å¡åœ¨è¿™é‡Œ</span></span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…è™šæ‹Ÿæœºæ—¶ï¼Œåº”é€‰æ‹©å®‰è£…openSSHæœåŠ¡ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨sshç™»å½•è™šæ‹Ÿæœºã€‚</p><p><a href="https://blog.csdn.net/weixin_28730403/article/details/111975038">https://blog.csdn.net/weixin_28730403/article/details/111975038</a><br><a href="https://blog.csdn.net/qq_36885515/article/details/112367143">https://blog.csdn.net/qq_36885515/article/details/112367143</a></p><h2 id="RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM"><a href="#RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM" class="headerlink" title="RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM"></a>RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM</h2><p><a href="https://blog.csdn.net/zhongbeida_xue/article/details/103602105">https://blog.csdn.net/zhongbeida_xue/article/details/103602105</a></p><ol><li><p>lspci | grep Ethernetï¼Œè·å–hostä¸»æœºä¸Šçš„ç½‘å¡åˆ—è¡¨</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep Ethernet</span><br><span class="line">41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class="line">41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class="line">42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]</span><br></pre></td></tr></table></figure></li><li><p>vim pci-01.xml ï¼Œå»ºç«‹ç›´è¿è®¾å¤‡å®šä¹‰æ–‡ä»¶</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x41&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>virsh attach-device [kvm-name] [config.xml]ï¼Œè¿›è¡Œè®¾å¤‡ç›´è¿<br> åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œlspciï¼Œå¯ä»¥å‘ç°å‡ºç°äº†ï¼Œå› æ­¤RDMAç›´è¿æ¥å·²ç”Ÿæ•ˆ</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…MITOSIS-core"><a href="#å®‰è£…MITOSIS-core" class="headerlink" title="å®‰è£…MITOSIS core"></a>å®‰è£…MITOSIS core</h2><p>1.å®‰è£…rust</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://sh.rustup.rs -sSf | sh</span><br><span class="line"></span><br><span class="line">$ rustup install nightly-2022-02-04  <span class="comment"># å®‰è£…mitosisæ‰€éœ€çš„å·¥å…·é“¾</span></span><br><span class="line">$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu</span><br><span class="line"></span><br><span class="line">$ apt-get install clang-9</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>eBPFå­¦ä¹ -01</title>
      <link href="/2023/01/19/eBPF%E5%AD%A6%E4%B9%A0-01/"/>
      <url>/2023/01/19/eBPF%E5%AD%A6%E4%B9%A0-01/</url>
      
        <content type="html"><![CDATA[<h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>å®‰è£…eBPFæ•™ç¨‹ï¼ˆFor ubuntu 18.04ï¼‰ï¼š<br><a href="https://blog.csdn.net/qq_33344148/article/details/123255679">https://blog.csdn.net/qq_33344148/article/details/123255679</a></p><p>åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°å„ä¸ªå†…æ ¸ç‰ˆæœ¬bccçš„releaseï¼Œå¯ä»¥è¿›è¡Œæ‰‹å·¥ä¸‹è½½ï¼š<br><a href="https://github.com/iovisor/bcc/releases/">https://github.com/iovisor/bcc/releases/</a></p><p>eBPF BCCï¼š<br><a href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a></p><p>Py BCCå¼€å‘æ•™ç¨‹ï¼š<br>å®˜æ–¹ï¼š<a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md">https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md</a><br>ä¸­æ–‡ï¼š<a href="https://blog.cyru1s.com/posts/ebpf-bcc.html">https://blog.cyru1s.com/posts/ebpf-bcc.html</a></p><h2 id="Example-01"><a href="#Example-01" class="headerlink" title="Example-01"></a>Example-01</h2><p>è¯¥ä»£ç å¯¹clone sys callè¿›è¡Œè¿½è¸ªã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># define BPF program</span></span><br><span class="line">prog = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string">    bpf_trace_printk(&quot;Hello, World!\\n&quot;);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=prog)</span><br><span class="line"><span class="comment"># æ·»åŠ æ¢æµ‹ç‚¹ï¼Œè¿½è¸ªcloneï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªæ¢æµ‹ç‚¹</span></span><br><span class="line">b.attach_kprobe(event=b.get_syscall_fnname(<span class="string">&quot;clone&quot;</span>), fn_name=<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># headerï¼Œè¡¨å¤´</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-18s %-16s %-6s %s&quot;</span> % (<span class="string">&quot;TIME(s)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;MESSAGE&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># format output</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment"># ä»trace_pipeè¿”å›å¤šä¸ªå‚æ•°</span></span><br><span class="line">        (task, pid, cpu, flags, ts, msg) = b.trace_fields()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line">    printb(<span class="string">b&quot;%-18.9f %-16s %-6d %s&quot;</span> % (ts, task, pid, msg))</span><br></pre></td></tr></table></figure><h2 id="Example-02"><a href="#Example-02" class="headerlink" title="Example-02"></a>Example-02</h2><p>è¯¥ä»£ç ç”¨äºè¿ç»­æ‰§è¡ŒsyncæŒ‡ä»¤æ—¶è¿›è¡Œæ‰“å°</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// åˆ›å»ºä¸€ä¸ªåä¸º last çš„ BPF hash æ˜ å°„</span></span><br><span class="line"><span class="string">BPF_HASH(last);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int do_trace(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">    u64 ts, *tsp, delta, key = 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // attempt to read stored timestamp</span></span><br><span class="line"><span class="string">    // è¯»å–å­˜å‚¨çš„ä¸Šä¸€æ¬¡æ—¶é—´æˆ³</span></span><br><span class="line"><span class="string">    tsp = last.lookup(&amp;key);</span></span><br><span class="line"><span class="string">    if (tsp != NULL) &#123;</span></span><br><span class="line"><span class="string">        // è®¡ç®—è¿‡äº†å¤šä¹…</span></span><br><span class="line"><span class="string">        delta = bpf_ktime_get_ns() - *tsp;</span></span><br><span class="line"><span class="string">        // å°äº1ç§’</span></span><br><span class="line"><span class="string">        if (delta &lt; 1000000000) &#123;</span></span><br><span class="line"><span class="string">            // output if time is less than 1 second</span></span><br><span class="line"><span class="string">            bpf_trace_printk(&quot;%d\\n&quot;, delta / 1000000);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        last.delete(&amp;key);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // update stored timestamp</span></span><br><span class="line"><span class="string">    // æ›´æ–°æ—¶é—´æˆ³</span></span><br><span class="line"><span class="string">    ts = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">    last.update(&amp;key, &amp;ts);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">b.attach_kprobe(event=b.get_syscall_fnname(<span class="string">&quot;sync&quot;</span>), fn_name=<span class="string">&quot;do_trace&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Tracing for quick sync&#x27;s... Ctrl-C to end&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># format output</span></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ä»trace pipeä¸­è¯»å–æ•°æ®ï¼Œåªæœ‰æœ‰æ•°æ®æ—¶æ‰ä¼šè¯»å–ï¼Œå¦åˆ™é˜»å¡</span></span><br><span class="line">        (task, pid, cpu, flags, ts, ms) = b.trace_fields()</span><br><span class="line">        <span class="keyword">if</span> start == <span class="number">0</span>:</span><br><span class="line">            start = ts</span><br><span class="line">        ts = ts - start</span><br><span class="line">        printb(<span class="string">b&quot;At time %.2f s: multiple syncs detected, last %s ms ago&quot;</span> % (ts, ms))</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RDMA-soft config</title>
      <link href="/2023/01/17/RDMA-soft-config/"/>
      <url>/2023/01/17/RDMA-soft-config/</url>
      
        <content type="html"><![CDATA[<p><a href="https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020">modprobe</a> rdma_rxe</p><p>rxe_cfg start</p><p>ifconfig</p><p>rxe_cfg add ens33</p><p>æˆ‘åœ¨è¿è¡ŒäºVMwareä¸­çš„ubuntuç¯å¢ƒæ­å»ºäº†Soft-RoCEè½¯ä»¶æ¨¡æ‹Ÿç¯å¢ƒï¼Œå¹¶æˆåŠŸæµ‹è¯•äº†ä¸¤å°è™šæ‹Ÿæœºå™¨é—´çš„é€šä¿¡ï¼Œä½†æ˜¯MITOSISä¼¼ä¹éœ€è¦â€œA machine with Mellanox RDMA-capable IB NIC â€ï¼ŒRoCEå’ŒIBä¸¤ç§RDMAæŠ€æœ¯æœ‰ä¸€å®šåŒºåˆ«ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´æ— æ³•æˆåŠŸã€‚</p><p>åœ¨MITOSISçš„readmeä¸­æœ‰è¿™ä¹ˆä¸€å¥â€œIn principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. â€ï¼Œæ„æ€åº”è¯¥æ˜¯ä¸æ”¯æŒRoCEï¼Ÿä½†æ˜¯ï¼Œæˆ‘ç›®å‰æ²¡æœ‰æ‰¾åˆ°è½¯ä»¶æ¨¡æ‹ŸIBçš„æ–¹å¼</p><p>IBï¼ˆInfiniBandï¼‰ï¼šåŸºäº InfiniBand æ¶æ„çš„ RDMA æŠ€æœ¯ï¼Œç”± IBTAï¼ˆInfiniBand Trade Associationï¼‰æå‡ºã€‚æ­å»ºåŸºäº IB æŠ€æœ¯çš„ RDMA ç½‘ç»œéœ€è¦ä¸“ç”¨çš„ IB ç½‘å¡å’Œ IB äº¤æ¢æœºã€‚</p><p>iWARPï¼ˆInternet Wide Area RDMA Protocalï¼‰ï¼šåŸºäº TCP/IP åè®®çš„ RDMA æŠ€æœ¯ï¼Œç”± IETF æ ‡ å‡†å®šä¹‰ã€‚iWARP æ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ä¸Šä½¿ç”¨ RDMA æŠ€æœ¯ï¼Œä½†æœåŠ¡å™¨éœ€è¦ä½¿ç”¨æ”¯æŒiWARP çš„ç½‘å¡ã€‚</p><p>RoCEï¼ˆRDMA over Converged Ethernetï¼‰ï¼šåŸºäºä»¥å¤ªç½‘çš„ RDMA æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ç”± IBTA æå‡ºã€‚RoCEæ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ä¸Šä½¿ç”¨RDMAæŠ€æœ¯ï¼Œä½†æ˜¯éœ€è¦äº¤æ¢æœºæ”¯æŒæ— æŸä»¥å¤ªç½‘ä¼ è¾“ï¼Œéœ€è¦æœåŠ¡å™¨ä½¿ç”¨ RoCE ç½‘å¡ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab5 COW</title>
      <link href="/2023/01/16/MIT-6-s081-Lab5-COW/"/>
      <url>/2023/01/16/MIT-6-s081-Lab5-COW/</url>
      
        <content type="html"><![CDATA[<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>COWæ ‡å¿—ä½ï¼Œ/rich.hã€‚å‚¨å­˜åœ¨ä¿ç•™ä½é‡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define COW_FLAG (1L &lt;&lt; 8)</span><br></pre></td></tr></table></figure><p>å¤åˆ¶å†…å­˜çš„ä»£ç ï¼Œåœ¨forkä¸­æœ‰è¢«è°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">uvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">&#123;</span><br><span class="line">    pte_t *pte;</span><br><span class="line">    uint64 pa, i;</span><br><span class="line">    int flags;</span><br><span class="line"></span><br><span class="line">    for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">        if((pte = walk(old, i, 0)) == 0)</span><br><span class="line">            panic(&quot;uvmcopy: pte should exist&quot;);</span><br><span class="line">        if((*pte &amp; PTE_V) == 0)</span><br><span class="line">            panic(&quot;uvmcopy: page not present&quot;);</span><br><span class="line"></span><br><span class="line">        // æ—§è¿›ç¨‹çš„ç‰©ç†å†…å­˜</span><br><span class="line">        pa = PTE2PA(*pte);</span><br><span class="line"></span><br><span class="line">        // COW</span><br><span class="line">        *pte = (*pte &amp; ~PTE_W) | COW_FLAG;</span><br><span class="line">        flags = PTE_FLAGS(*pte);</span><br><span class="line"></span><br><span class="line">        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)&#123;</span><br><span class="line">            goto err;</span><br><span class="line">        &#125;</span><br><span class="line">        con[getrefindex((uint64*)pa)]++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">uvmunmap(new, 0, i / PGSIZE, 1);</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†å†…å­˜éæ³•è®¿é—®ï¼ˆé¡µï¼‰ä¸­æ–­çš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">else if(r_scause() == 15)&#123;</span><br><span class="line">//      printf(&quot;page\n&quot;);</span><br><span class="line">        struct proc *p = myproc();</span><br><span class="line"></span><br><span class="line">        /* ã€xv6å¯¹é¡µçš„æ“æ§ç²’åº¦ä¸ºPageã€‘</span><br><span class="line">         * éœ€è¦å°†å½“å‰è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„pageè¿›è¡Œæ‹·è´</span><br><span class="line">         * ç”±äºè™šæ‹Ÿåœ°å€å¯èƒ½æŒ‡å‘é¡µçš„ä¸­é—´</span><br><span class="line">         * å› æ­¤éœ€è¦å‘ä¸‹å¯¹å…¶åˆ°é¡µçš„è¾¹ç•Œ</span><br><span class="line">         * ä»è€Œå°†è¿™ä¸€é¡µå…¨éƒ¨éƒ½è¿›è¡Œæ‹·è´ï¼ˆCOWï¼‰</span><br><span class="line">         */</span><br><span class="line">        uint64 va=PGROUNDDOWN(r_stval()); // è™šæ‹Ÿåœ°å€</span><br><span class="line"></span><br><span class="line">        pte_t *pte; // pte</span><br><span class="line">        pte = walk(p-&gt;pagetable, va, 0);</span><br><span class="line"></span><br><span class="line">        if(*pte &amp; COW_FLAG)&#123; //æ˜¯cowé¡µé¢</span><br><span class="line">            uint64 pa=PTE2PA(*pte); // ç‰©ç†åœ°å€</span><br><span class="line"></span><br><span class="line">            char *mem;</span><br><span class="line">            //åˆ†é…ä¸€é¡µæ–°å†…å­˜</span><br><span class="line">            if((mem = kalloc()) == 0)</span><br><span class="line">                panic(&quot;uvmtrap: pte alloc exist&quot;);</span><br><span class="line"></span><br><span class="line">            // æ‹·è´æ—§æ•°æ®çš„å€¼åˆ°æ–°page</span><br><span class="line">            memmove(mem, (char*)pa, PGSIZE);</span><br><span class="line"></span><br><span class="line">            int flags = PTE_FLAGS(*pte);</span><br><span class="line"></span><br><span class="line">            flags =flags | PTE_W;</span><br><span class="line">            flags &amp;= ~COW_FLAG;</span><br><span class="line">//            *pte &amp;=~PTE_V;</span><br><span class="line">            // è¿›è¡Œå†…å­˜æ˜ å°„</span><br><span class="line">            mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, flags);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            kfree((void*)pa);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å†…å­˜ä»£ç ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// derf.h</span><br><span class="line">extern int con[];</span><br><span class="line">extern int getrefindex(void*);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">kfree(void *pa)</span><br><span class="line">&#123;</span><br><span class="line">  struct run *r;</span><br><span class="line"></span><br><span class="line">  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP) &#123;</span><br><span class="line">      panic(&quot;kfree&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  con[getrefindex(pa)]--;</span><br><span class="line">  //printf(&quot;%d&quot;,con[(uint64)pa/PGSIZE]);</span><br><span class="line">  if(con[getrefindex(pa)]&gt;0)&#123;</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Fill with junk to catch dangling refs.</span><br><span class="line">  memset(pa, 1, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r-&gt;next = kmem.freelist;</span><br><span class="line">  kmem.freelist = r;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png" alt="æˆªå±2023-01-16 10.31.45"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MITOSIS note</title>
      <link href="/2023/01/14/MITOSIS-learning/"/>
      <url>/2023/01/14/MITOSIS-learning/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ProjectMitosisOS">MITOSIS Repo</a></p><h2 id="Remote-Fork-C-R"><a href="#Remote-Fork-C-R" class="headerlink" title="Remote Fork(C/R)"></a>Remote Fork(C/R)</h2><p>ç°æœ‰å®¹å™¨åªèƒ½é€šè¿‡C/Rçš„æ–¹æ³•è¿›è¡Œè¿œç¨‹Forkã€‚è¿™ç§æ–¹æ³•éœ€è¦çˆ¶è¿›ç¨‹é¦–å…ˆéœ€è¦<em>checkpoints</em> its statesï¼Œå¹¶å°†stateå‚¨å­˜åˆ°æ–‡ä»¶é‡Œã€‚åœ¨é€šè¿‡remote file copyæˆ–distributed file systemå°†æ–‡ä»¶å¤åˆ¶åˆ°å­è¿›ç¨‹ã€‚å­è¿›ç¨‹æ ¹æ®æ–‡ä»¶ä¿¡æ¯å¯¹å¤«è¿›ç¨‹è¿›è¡Œæ¢å¤ã€‚ç”±äºC/Réœ€è¦å¤åˆ¶å…¨éƒ¨å†…å­˜ä¿¡æ¯ï¼Œå› æ­¤å¾ˆæ…¢ã€‚ä¾‹å¦‚éœ€è¦å¯¹1Gå†…å­˜è¿›è¡Œæ‹·è´ï¼ŒC/Rç”šè‡³æ¯”å†·å¯åŠ¨è¿˜è¦æ…¢2.7å€ã€‚</p><h2 id="MITOSIS"><a href="#MITOSIS" class="headerlink" title="MITOSIS"></a>MITOSIS</h2><p>MITOSISã€maÉªËˆtoÊŠsÉªsã€‘é€šè¿‡RDMAæ¨¡æ‹Ÿæœ¬åœ°Forkæ¥å®ç°é«˜æ•ˆçš„è¿œç¨‹åˆ†å‰ï¼ˆå…·æœ‰ç±»ä¼¼COWæœºåˆ¶ï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png" alt="æˆªå±2023-01-16 11.36.26"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†çˆ¶å¯¹è±¡çš„Metadata(ä¾‹å¦‚é¡µè¡¨)å¤åˆ¶åˆ°ä¸€ä¸ªå‹ç¼©æè¿°ç¬¦æ¥æ´¾ç”Ÿå­å¯¹è±¡ã€‚Note:ä¸å°†çˆ¶è¿›ç¨‹çš„å†…å­˜é¡µå¤åˆ¶åˆ°æè¿°ç¬¦ä¸­ã€‚ç„¶åé€šè¿‡RDMAå°†æè¿°ç¬¦å¤åˆ¶åˆ°å­è¿›ç¨‹ä»¥æ¢å¤çˆ¶è¿›ç¨‹çš„Metadataã€‚å­è¿›ç¨‹çš„â€œè¿œç¨‹å†…å­˜è®¿é—®â€ä¼šè§¦å‘é¡µé¢é”™è¯¯ï¼Œå†…æ ¸å°†è¯»åŒºè¯»å–è¿œç¨‹é¡µé¢ã€‚é¿å…äº†ä¼ è¾“æ•´ä¸ªå®¹å™¨çŠ¶æ€ã€‚åŒæ—¶ï¼ŒMITOSISç›´æ¥ä½¿ç”¨å•è¾¹RDMA Readæ¥è¯»å–è¿œç¨‹ç‰©ç†å†…å­˜ï¼Œç»•è¿‡æ‰€æœ‰è½¯ä»¶å¼€é”€ã€‚</p><h3 id="MITOSISå’ŒC-R-forkçš„æ¯”è¾ƒ"><a href="#MITOSISå’ŒC-R-forkçš„æ¯”è¾ƒ" class="headerlink" title="MITOSISå’ŒC/R forkçš„æ¯”è¾ƒ"></a>MITOSISå’ŒC/R forkçš„æ¯”è¾ƒ</h3><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png" alt="æˆªå±2023-01-14 13.40.51"></p><p><strong>MITOSISç”±ä»¥ä¸‹å››ä¸ªæ¨¡å—ç»„æˆï¼š</strong></p><p>The <em>fork orchestrator</em> rehearsals the remote fork executionï¼›å‡†å¤‡forkå’Œè¿›è¡Œforkï¼Œä½¿ç”¨rpcè¿›è¡Œæ ¡éªŒ</p><p>The <em>network daemon</em> manages a scalable RDMA connection poolï¼›å•ä¾§RDMAï¼Œç»´æŠ¤RDMAè¿æ¥pool</p><p>Extend OSâ€™s <em>virtual memory subsystems</em> to utilize the remote memory with RDMA ï¼›è¿œç¨‹å†…å­˜è®¿é—®</p><p><em>Fallback daemon</em> provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMAï¼›æ¢å¤æœºåˆ¶ï¼Œå›é€€åˆ°RPC</p><h2 id="1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork"><a href="#1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork" class="headerlink" title="1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork"></a>1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork</h2><h3 id="1-fork-prepare"><a href="#1-fork-prepare" class="headerlink" title="1.fork_prepare"></a>1.fork_prepare</h3><p>å‡†å¤‡forkï¼Œä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“ä¿å­˜ï¼š</p><ul><li>CPUå¯„å­˜å™¨çŠ¶æ€ï¼ˆç”¨äºæ¢å¤è¿è¡ŒçŠ¶æ€ï¼‰</li><li>cGroupå’ŒNamespaceï¼ˆç”¨äºè¿›è¡Œå®¹å™¨åŒ–ï¼‰</li><li>é¡µè¡¨å’Œè™šæ‹Ÿå†…å­˜åŒºï¼ˆç”¨äºè¿œç¨‹å†…å­˜è®¿é—®ï¼‰</li><li>æ‰“å¼€æ–‡ä»¶ä¿¡æ¯ï¼ˆé‡æ–°æ‰“å¼€æ–‡ä»¶ï¼Œä½¿ç”¨CRIUï¼‰</li></ul><p>ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œç»“æ„ä½“å¾ˆå°ï¼Œå¤§æ¦‚æ˜¯KBçº§åˆ«</p><h3 id="2-fork-resume"><a href="#2-fork-resume" class="headerlink" title="2.fork_resume"></a>2.fork_resume</h3><p>fork_resumeä»çˆ¶è¿›ç¨‹è·å–descriptorï¼Œå¹¶æ¢å¤æ‰§è¡ŒçŠ¶æ€ã€‚</p><p>ä½¿ç”¨oneside RDMAè·å–descriptorã€‚é¦–å…ˆå­è¿›ç¨‹é€šè¿‡RPCå‘çˆ¶è¿›ç¨‹å‘ä¸€ä¸ªauthentication RPCï¼Œè‹¥è®¤è¯é€šè¿‡ï¼Œåˆ™çˆ¶è¿›ç¨‹ä¼šè¿”å›descriptorâ€™s stored addresså’Œpayloadã€‚ä¹‹åå­è¿›ç¨‹å°±å¯ä»¥ä½¿ç”¨oneside RDMAè·å–descriptorã€‚</p><p>è·å–åˆ°descriptoråï¼Œæ¢å¤å®¹å™¨çŠ¶æ€ã€‚(1)è®¾ç½®cgroupså’Œå‘½åç©ºé—´ä»¥åŒ¹é…çˆ¶æ“ä½œç³»ç»Ÿçš„è®¾ç½® (2)åˆ‡æ¢:ç”¨çˆ¶è¿›ç¨‹çš„CPUå¯„å­˜å™¨ã€é¡µè¡¨å’ŒI/Oæè¿°ç¬¦æ›¿æ¢è°ƒç”¨æ–¹çš„CPUå¯„å­˜å™¨ã€‚æ­¤å¤–å¼•å…¥SOCKä»¥å®Œæˆå¿«é€Ÿå®¹å™¨æ¢å¤ã€‚</p><h2 id="2ï¼‰å•ä¾§RDMA"><a href="#2ï¼‰å•ä¾§RDMA" class="headerlink" title="2ï¼‰å•ä¾§RDMA"></a>2ï¼‰å•ä¾§RDMA</h2><p>RDMAï¼šæœ‰ä¸‰ç§QPç±»å‹</p><p>RDMAè¿æ¥æ¶ˆè€—è¾ƒå¤§ï¼Œé€Ÿåº¦è¾ƒæ…¢ã€‚å› æ­¤ä½¿ç”¨æ— è¿æ¥çš„oneside RDMAã€‚å› æ­¤æ”¹è¿›RDMAè¿æ¥ï¼ˆDCT-dynamic connected transportï¼‰ï¼ŒDCTä¿ç•™äº†RCçš„åŠŸèƒ½ï¼Œå¹¶è¿›ä¸€æ­¥æä¾›äº†ä¸€ç§æ— è¿æ¥çš„æ–¹å¼:å•ä¸ªDCQPå¯ä»¥ä¸ä¸åŒçš„èŠ‚ç‚¹é€šä¿¡ã€‚</p><p>ç›®æ ‡èŠ‚ç‚¹åªéœ€è¦åˆ›å»ºä¸€ä¸ªDCï¼Œè¯¥DCç”±èŠ‚ç‚¹çš„RDMAåœ°å€å’Œ12B DC keyæ ‡è¯†ã€‚åœ¨çŸ¥é“keyåï¼Œå­èŠ‚ç‚¹å¯ä»¥åœ¨æ²¡æœ‰è¿æ¥çš„æƒ…å†µä¸‹å‘ç›¸åº”çš„ç›®æ ‡å‘é€å•ä¾§RDMAè¯·æ±‚ï¼Œç¡¬ä»¶ä¼šæ‰¿è½½æ•°æ®å¤„ç†è¿æ¥ï¼Œé€Ÿåº¦æå¿«(1Î¼sä»¥å†…).</p><p>åŸºäºDCTï¼Œç½‘ç»œå®ˆæŠ¤è¿›ç¨‹ç®¡ç†ä¸€ä¸ªå°å‹å†…æ ¸ç©ºé—´DCQPæ± ï¼Œç”¨äºå¤„ç†æ¥è‡ªå­è¿›ç¨‹çš„RDMAè¯·æ±‚ã€‚é€šå¸¸ï¼Œæ¯ä¸ªcpuä¸€ä¸ªDCQPå°±è¶³ä»¥å……åˆ†åˆ©ç”¨RDMAã€‚ä½†æ˜¯ï¼Œä»…ä½¿ç”¨DCTæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå­©å­éœ€è¦æå‰çŸ¥é“DCT keyæ‰èƒ½ä¸çˆ¶æ¯é€šä¿¡ã€‚å› æ­¤ï¼ŒMITOSISå®ç°äº†ä¸€ä¸ªå†…æ ¸ç©ºé—´â€fast RPCâ€æ¥å¼•å¯¼DCTã€‚fastæ˜¯ä¸€ä¸ªåŸºäºudçš„RPCï¼Œæ”¯æŒæ— è¿æ¥ã€‚ä½¿ç”¨RPCï¼Œæˆ‘ä»¬åœ¨RPCè¯·æ±‚ä¸­è£…è½½ä¸çˆ¶å¯¹è±¡å…³è”çš„DCTé”®ï¼Œä»¥æŸ¥è¯¢çˆ¶å¯¹è±¡çš„æè¿°ç¬¦ã€‚ä¸ºäº†èŠ‚çœCPUèµ„æºï¼Œæˆ‘ä»¬åªéƒ¨ç½²äº†ä¸¤ä¸ªå†…æ ¸çº¿ç¨‹æ¥å¤„ç†rpc.</p><h2 id="3ï¼‰Virtual-memory-management"><a href="#3ï¼‰Virtual-memory-management" class="headerlink" title="3ï¼‰Virtual memory management"></a>3ï¼‰Virtual memory management</h2><p>ä¸ºäº†æé«˜resumeæ•ˆç‡ï¼Œç›´æ¥å°†å­èŠ‚ç‚¹æ˜ å°„é¡µé¢çš„é¡µè¡¨é¡¹(PTE)è®¾ç½®ä¸ºçˆ¶èŠ‚ç‚¹çš„ç‰©ç†åœ°å€(PA)ã€‚ä½¿ç”¨ä¸€ä¸ªPTEä¸­çš„remote bitæ¥è¿›è¡ŒåŒºåˆ†ï¼ˆremote bitä½äºPTEæœªè¢«åˆ©ç”¨çš„é«˜ä½ï¼‰ã€‚åœ¨resumeè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šè®¾ç½®remote bitå¹¶æ¸…é™¤present bitï¼Œå½“å­è¿›ç¨‹è®¿é—®é‡Œè¯¥PTEï¼Œå°±ä¼šè¿›å…¥ç¼ºé¡µä¸­æ–­ï¼Œä»è€Œå‡ºå‘RDMAè¿œç¨‹è¯»å–ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png" alt="æˆªå±2023-01-16 13.18.22"></p><p>å¦‚æœé”™è¯¯é¡µæ²¡æœ‰æ˜ å°„åˆ°çˆ¶é¡µï¼Œä¾‹å¦‚å †æ ˆå¢é•¿ï¼Œæˆ‘ä»¬å°±åƒå¤„ç†æ™®é€šçš„é¡µé”™è¯¯ä¸€æ ·åœ¨æœ¬åœ°å¤„ç†å®ƒã€‚<br>å¦åˆ™ï¼Œæ£€æŸ¥æ•…éšœè™šæ‹Ÿåœ°å€VA (virtual address)æ˜¯å¦æ˜ å°„äº†è¿œç«¯PAã€‚ä½¿ç”¨å•è¾¹RDMAå°†è¿œç¨‹pageè¯»åˆ°æœ¬åœ°é¡µã€‚å¤§å¤šæ•°å­é¡µé¢éƒ½å¯ä»¥é€šè¿‡RDMAæ¢å¤ã€‚åœ¨é”™è¿‡æ˜ å°„çš„æƒ…å†µä¸‹ï¼Œåˆ™ä½¿ç”¨RPCæ˜ å°„ã€‚</p><p>RPCï¼šæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ªå›é€€å®ˆæŠ¤è¿›ç¨‹ï¼Œè¯¥å®ˆæŠ¤è¿›ç¨‹ç”Ÿæˆå†…æ ¸çº¿ç¨‹æ¥å¤„ç†å­èŠ‚ç‚¹çš„é¡µè¯·æ±‚ï¼ˆåŒ…å«çˆ¶èŠ‚ç‚¹æ ‡è¯†ç¬¦å’Œè¯·æ±‚çš„è™šæ‹Ÿåœ°å€ï¼‰ã€‚å›é€€é€»è¾‘: åœ¨æ£€æŸ¥è¯·æ±‚çš„æœ‰æ•ˆæ€§ä¹‹åï¼Œå®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹å°†ä»£è¡¨çˆ¶è¿›ç¨‹åŠ è½½é¡µé¢ã€‚å¦‚æœåŠ è½½æˆåŠŸï¼Œæˆ‘ä»¬å°†æŠŠç»“æœå‘å›ç»™å­è¿›ç¨‹ã€‚</p><p><strong>Access control and isolation</strong></p><p>æˆ‘ä»¬éœ€è¦æ‹’ç»å¯¹ä¸å†å±äºçˆ¶èŠ‚ç‚¹çš„æ˜ å°„é¡µçš„è®¿é—®ï¼Œå¹¶æ­£ç¡®éš”ç¦»å¯¹ä¸åŒå®¹å™¨çš„è®¿é—®ã€‚</p><p>ç›´æ¥æš´éœ²çˆ¶èŠ‚ç‚¹çš„ç‰©ç†å†…å­˜å¯ä»¥æé«˜è¿œç¨‹forkçš„é€Ÿåº¦ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éœ€è¦æ‹’ç»å¯¹ä¸å†å±äºçˆ¶èŠ‚ç‚¹çš„æ˜ å°„é¡µçš„è®¿é—®ï¼Œå¹¶æ­£ç¡®éš”ç¦»å¯¹ä¸åŒå®¹å™¨çš„è®¿é—®ã€‚ç”±äºæˆ‘ä»¬ä»¥cpuæ—è·¯çš„æ–¹å¼é€šè¿‡å•è¾¹RDMAå…¬å¼€å†…å­˜ï¼Œå› æ­¤åªèƒ½åˆ©ç”¨RNICè¿›è¡Œæ§åˆ¶ã€‚</p><p>MITOSISç”¨ä¸€ç§åŸºäºè¿æ¥çš„å†…å­˜è®¿é—®æ§åˆ¶æ–¹æ³•ã€‚å°†ä¸åŒçš„RDMAè¿æ¥åˆ†é…åˆ°çˆ¶è™šæ‹Ÿå†…å­˜åŒºåŸŸ(VMA)çš„ä¸åŒéƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼Œæ¯ä¸ªVMAä¸€ä¸ªè¿æ¥ã€‚å¦‚æœæ˜ å°„çš„ç‰©ç†é¡µä¸å†å±äºçˆ¶é¡µï¼Œæˆ‘ä»¬å°†ç ´åä¸è¯¥é¡µçš„VMAç›¸å…³çš„è¿æ¥ã€‚å› æ­¤ï¼Œchildå¯¹é¡µé¢çš„è®¿é—®å°†è¢«RNICæ‹’ç»ã€‚æ‰€æœ‰è¿æ¥éƒ½åœ¨å†…æ ¸ä¸­è¿›è¡Œç®¡ç†ï¼Œä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·è®¿é—®é”™è¯¯çš„è¿œç¨‹å®¹å™¨å†…å­˜ã€‚</p><p>ä¸ºäº†å®ç°åŸºäºè¿æ¥çš„è®¿é—®æ§åˆ¶ï¼Œæ¯ä¸ªè¿æ¥åœ¨åˆ›å»ºå’Œå­˜å‚¨æ—¶éƒ½å¿…é¡»é«˜æ•ˆã€‚å¹¸è¿çš„æ˜¯ï¼ŒDCQPå¾ˆå¥½åœ°æ»¡è¶³äº†è¿™äº›è¦æ±‚ã€‚åœ¨å­ç«¯ï¼Œæ¯ä¸ªè¿æ¥(DC key)åªæ¶ˆè€—12B ï¼Œä¸åŒçš„DCè¿æ¥å¯ä»¥å…±äº«ç›¸åŒçš„DCQPã€‚parent-side DC target consumes 144Bã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png" alt="æˆªå±2023-01-16 13.34.56"></p><p>å›¾ç‰‡è¡¨ç¤ºäº†åŸºäºdctçš„è®¿é—®æ§åˆ¶ã€‚åœ¨å‡†å¤‡åˆ†å‰æ—¶ï¼ŒMITOSISä»ç›®æ ‡æ± ä¸­é€‰æ‹©ä¸€ä¸ªDCç›®æ ‡åˆ†é…ç»™æ¯ä¸ªparent VMAã€‚poolåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œå¹¶åœ¨åå°å®šæœŸå¡«å……ã€‚è¿™äº›ç›®æ ‡çš„DC keyè¢«è£…è½½åœ¨çˆ¶è¿›ç¨‹çš„æè¿°ç¬¦ä¸­ï¼Œä»¥ä¾¿å­è¿›ç¨‹åœ¨æ¢å¤è¿‡ç¨‹ä¸­å¯ä»¥å°†å®ƒä»¬è®°å½•åœ¨VMAä¸­ã€‚åœ¨è¯»å–çˆ¶èŠ‚ç‚¹çš„pageæ—¶ï¼Œå­èŠ‚ç‚¹å°†ä½¿ç”¨ä¸é¡µé¢VMAå¯¹åº”çš„keyæ¥å‘å‡ºRDMAè¯·æ±‚ã€‚ä½¿ç”¨æ­¤æ–¹æ¡ˆï¼Œå¦‚æœparentæƒ³è¦æ‹’ç»å¯¹è¯¥é¡µçš„è®¿é—®ï¼Œå®ƒå¯ä»¥é”€æ¯ç›¸åº”çš„DCç›®æ ‡ã€‚</p><h2 id="Pre-fetching-and-caching"><a href="#Pre-fetching-and-caching" class="headerlink" title="Pre-fetching and caching"></a>Pre-fetching and caching</h2><p>æ­¤å¤„ä¼¼ä¹æœ‰ä¸€å®šä¼˜åŒ–ç©ºé—´ï¼Ÿå¯ä»¥é‡‡ç”¨è®¡æ•°æ³•æå‡cacheå‘½ä¸­ç‡ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab4 Trap</title>
      <link href="/2023/01/13/MIT-6-s081-Lab4/"/>
      <url>/2023/01/13/MIT-6-s081-Lab4/</url>
      
        <content type="html"><![CDATA[<h2 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int g(int x) &#123;</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 &lt;g&gt;:</span><br><span class="line">#include &quot;kernel/param.h&quot;</span><br><span class="line">#include &quot;kernel/types.h&quot;</span><br><span class="line">#include &quot;kernel/stat.h&quot;</span><br><span class="line">#include &quot;user/user.h&quot;</span><br><span class="line"></span><br><span class="line">int g(int x) &#123;</span><br><span class="line">   0:1141                addisp,sp,-16</span><br><span class="line">   2:e422                sds0,8(sp)</span><br><span class="line">   4:0800                addis0,sp,16</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line">   6:250d                addiwa0,a0,3</span><br><span class="line">   8:6422                lds0,8(sp)</span><br><span class="line">   a:0141                addisp,sp,16</span><br><span class="line">   c:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000000e &lt;f&gt;:</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">   e:1141                addisp,sp,-16</span><br><span class="line">  10:e422                sds0,8(sp)</span><br><span class="line">  12:0800                addis0,sp,16</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line">  14:250d                addiwa0,a0,3</span><br><span class="line">  16:6422                lds0,8(sp)</span><br><span class="line">  18:0141                addisp,sp,16</span><br><span class="line">  1a:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  1c:1141                addisp,sp,-16</span><br><span class="line">  1e:e406                sdra,8(sp)</span><br><span class="line">  20:e022                sds0,0(sp)</span><br><span class="line">  22:0800                addis0,sp,16</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  24:4635                lia2,13</span><br><span class="line">  26:45b1                lia1,12</span><br><span class="line">  28:00000517          auipca0,0x0</span><br><span class="line">  2c:7a850513          addia0,a0,1960 # 7d0 &lt;malloc+0xe8&gt;</span><br><span class="line">  30:00000097          auipcra,0x0</span><br><span class="line">  34:600080e7          jalr1536(ra) # 630 &lt;printf&gt;</span><br><span class="line">  exit(0);</span><br><span class="line">  38:4501                lia0,0</span><br><span class="line">  3a:00000097          auipcra,0x0</span><br><span class="line">  3e:28e080e7          jalr654(ra) # 2c8 &lt;exit&gt;</span><br><span class="line"></span><br><span class="line">0000000000000042 &lt;_main&gt;:</span><br><span class="line">//</span><br><span class="line">// wrapper so that it&#x27;s OK if main() does not call exit().</span><br><span class="line">//</span><br><span class="line">void</span><br><span class="line">_main()</span><br><span class="line">&#123;</span><br><span class="line">  42:1141                addisp,sp,-16</span><br><span class="line">  44:e406                sdra,8(sp)</span><br><span class="line">  46:e022                sds0,0(sp)</span><br><span class="line">  48:0800                addis0,sp,16</span><br><span class="line">  extern int main();</span><br><span class="line">  main();</span><br><span class="line">  4a:00000097          auipcra,0x0</span><br><span class="line">  4e:fd2080e7          jalr-46(ra) # 1c &lt;main&gt;</span><br><span class="line">  exit(0);</span><br><span class="line">  52:4501                lia0,0</span><br><span class="line">  54:00000097          auipcra,0x0</span><br><span class="line">  58:274080e7          jalr628(ra) # 2c8 &lt;exit&gt;</span><br><span class="line"></span><br><span class="line">000000000000005c &lt;strcpy&gt;:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="RISC-V-trap-machinery"><a href="#RISC-V-trap-machinery" class="headerlink" title="RISC-V trap machinery"></a>RISC-V trap machinery</h2><ul><li>stvec ï¼šå†…æ ¸åœ¨è¿™é‡Œå†™å…¥å®ƒçš„trapå¤„ç†ç¨‹åºçš„åœ°å€;RISC-Vè·³è½¬åˆ°stvecä¸­çš„åœ°å€æ¥å¤„ç†trapã€‚</li><li>sepcï¼šå½“ä¸€ä¸ªtrapå‘ç”Ÿæ—¶ï¼ŒRISC-Vå°†ç¨‹åºè®¡æ•°å™¨ä¿å­˜åœ¨è¿™é‡Œ(å› ä¸ºpcä¼šè¢«stvecä¸­çš„å€¼è¦†ç›–)ã€‚sret (return from trap)æŒ‡ä»¤å°†sepcå¤åˆ¶åˆ°pcä¸Šã€‚å†…æ ¸å¯ä»¥ç¼–å†™sepcæ¥æ§åˆ¶sretçš„ä½ç½®ã€‚</li><li>scauseï¼šRISC-Våœ¨è¿™é‡Œæ”¾äº†ä¸€ä¸ªæ•°å­—æ¥æè¿°trapçš„åŸå› ã€‚</li><li>sscratchï¼š trapå¤„ç†ç¨‹åºä»£ç ä½¿ç”¨sscratchæ¥é¿å…åœ¨ ä¿å­˜ç”¨æˆ·å¯„å­˜å™¨ä¹‹å‰è¦†ç›–ç”¨æˆ·å¯„å­˜å™¨ã€‚</li><li>sstatusï¼šsstatusä¸­çš„SIEä½æ§åˆ¶æ˜¯å¦å¯ç”¨è®¾å¤‡ä¸­æ–­ã€‚å¦‚æœå†…æ ¸æ¸…é™¤äº†SIE, RISC-Vå°†å»¶è¿Ÿè®¾å¤‡ä¸­æ–­ï¼Œç›´åˆ°å†…æ ¸è®¾ç½®äº†SIEã€‚SPPä½è¡¨ç¤ºtrapæ¥è‡ªç”¨æˆ·æ¨¡å¼è¿˜æ˜¯ç®¡ç†æ¨¡å¼ï¼Œå¹¶æ§åˆ¶sretè¿”å›å“ªç§æ¨¡å¼ã€‚</li></ul><p>RISC-Vä¸­æ–­å‘ç”Ÿè¿‡ç¨‹ï¼š</p><ol><li>å¦‚æœè®¾å¤‡ä¸­æ–­ï¼Œä¸”sstatus SIEä½ä¸ºæ¸…é›¶ï¼Œåˆ™æ— éœ€æ‰§è¡Œä»¥ä¸‹æ“ä½œ</li><li>é€šè¿‡æ¸…é™¤sstatusä¸­çš„SIEä½æ¥ç¦ç”¨ä¸­æ–­ã€‚</li><li>Copy the pc to sepc.</li><li>å°†å½“å‰æ¨¡å¼(useræˆ–supervisor)ä¿å­˜åœ¨sstatusçš„SPPä½ä¸­ã€‚</li><li>è®¾ç½®åŸå› ä»¥åæ˜ é™·é˜±çš„åŸå› ã€‚</li><li>Set the mode to supervisor</li><li>Copy stvec to the pc.</li><li>åœ¨æ–°çš„pcä½ç½®å¼€å§‹æ‰§è¡Œ</li></ol><h2 id="User-Trap"><a href="#User-Trap" class="headerlink" title="User Trap"></a>User Trap</h2><p>ç”¨æˆ·ä¸­æ–­å½“ç”¨æˆ·è°ƒç”¨äº†ecallæŒ‡ä»¤æ—¶å‘ç”Ÿï¼ˆæˆ–å‘ç”Ÿäº†éæ³•æ“ä½œæˆ–ç¡¬ä»¶ä¸­æ–­ï¼‰ã€‚</p><p>ç”¨æˆ·å‘ç”Ÿä¸­æ–­ï¼š<br>step1: uservec<br>step2: usertrap</p><p>å½“ä¸­æ–­è¿”å›ï¼š<br>step1: usertrapret<br>step2: userret</p><h3 id="1-å‘ç”Ÿä¸­æ–­"><a href="#1-å‘ç”Ÿä¸­æ–­" class="headerlink" title="1. å‘ç”Ÿä¸­æ–­"></a>1. å‘ç”Ÿä¸­æ–­</h3><p>TRAMPOLINE pageåœ¨ç¨‹åºåˆå§‹åŒ–æ—¶æ”¾ç½®ï¼Œä½äºuserè™šæ‹Ÿåœ°å€çš„é¡¶éƒ¨ï¼ŒåŒæ—¶TRAMPOLINEåœ¨å†…æ ¸é¡µè¡¨ä¹Ÿè¢«æ˜ å°„ã€‚ä¸”æ²¡æœ‰ PTE_Uæ ‡å¿—ã€‚å› æ­¤trap handleråœ¨åˆ‡æ¢åˆ°å†…æ ¸pageåå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png" alt="æˆªå±2023-01-13 23.20.51"></p><p>ä¸ºäº†ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œuservecä¼šå°†ç”¨æˆ·å¯„å­˜å™¨çŠ¶æ€ä¿å­˜åœ¨TRAPFRAMEï¼ˆä¸€ä¸ªç»“æ„ä½“ï¼‰ã€‚TRAPFRAME åœ¨ TRAMPOLINEä¹‹ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct trapframe &#123;</span><br><span class="line">  /*   0 */ uint64 kernel_satp;   // kernel page table</span><br><span class="line">  /*   8 */ uint64 kernel_sp;     // top of process&#x27;s kernel stack</span><br><span class="line">  /*  16 */ uint64 kernel_trap;   // usertrap()</span><br><span class="line">  /*  24 */ uint64 epc;           // saved user program counter</span><br><span class="line">  /*  32 */ uint64 kernel_hartid; // saved kernel tp</span><br><span class="line">  /*  40 */ uint64 ra;</span><br><span class="line">  /*  48 */ uint64 sp;</span><br><span class="line">  /*  56 */ uint64 gp;</span><br><span class="line">  /*  64 */ uint64 tp;</span><br><span class="line">  /*  72 */ uint64 t0;</span><br><span class="line">  /*  80 */ uint64 t1;</span><br><span class="line">  ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>TRAPFRAMEä¸­ä¿å­˜äº†å†…æ ¸pageçš„ä¿¡æ¯å’Œcpuä¿¡æ¯ï¼Œuservecä»è¿™é‡Œè·å–ä¿¡æ¯ã€‚ç„¶åæ‰§è¡Œusertrapã€‚</p><p> usertrapçš„å·¥ä½œæ˜¯ç¡®å®štrapçš„åŸå› , è¿è¡Œtrapå¹¶è¿”å›ã€‚usertrapé¦–å…ˆä¼šä¿å­˜sepcï¼ˆç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ï¼‰ã€‚å¦‚æœè¯¥trapæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™usertrapè°ƒç”¨sycallæ¥å¤„ç†å®ƒ;å¦‚æœè®¾å¤‡ä¸­æ–­ï¼Œdevintr;å¦åˆ™å®ƒæ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œå†…æ ¸ä¼šç»ˆæ­¢å‘ç”Ÿæ•…éšœçš„è¿›ç¨‹ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨è·¯å¾„åœ¨ä¿å­˜çš„ç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ä¸Šå¢åŠ äº†4ï¼Œå› ä¸ºRISC-Våœ¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä»£ç éœ€è¦åœ¨åç»­æŒ‡ä»¤å¤„æ¢å¤æ‰§è¡Œï¼ˆä¸èƒ½åå¤æ‰§è¡Œsys callï¼‰ã€‚åœ¨é€€å‡ºè¿‡ç¨‹ä¸­ï¼Œusertrapæ£€æŸ¥è¿›ç¨‹æ˜¯å¦å·²ç»è¢«æ€æ­»æˆ–åº”è¯¥äº§ç”ŸCPU(å¦‚æœè¿™ä¸ªtrapæ˜¯ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­)ã€‚</p><h3 id="2-ä¸­æ–­è¿”å›"><a href="#2-ä¸­æ–­è¿”å›" class="headerlink" title="2. ä¸­æ–­è¿”å›"></a>2. ä¸­æ–­è¿”å›</h3><p>è¿”å›ç¬¬ä¸€æ­¥æ˜¯è¿è¡Œusertrapretã€‚ç„¶åæ‰§è¡Œuserretã€‚è¿™ä¿©æ¢å¤äº†ä¸€äº›å¯„å­˜å™¨çŠ¶æ€ï¼Œè¿”å›ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="initcode-Sï¼ˆå¦‚ä½•è°ƒç”¨sys-callï¼‰"><a href="#initcode-Sï¼ˆå¦‚ä½•è°ƒç”¨sys-callï¼‰" class="headerlink" title="initcode.Sï¼ˆå¦‚ä½•è°ƒç”¨sys callï¼‰"></a>initcode.Sï¼ˆå¦‚ä½•è°ƒç”¨sys callï¼‰</h2><p>initcode.Så°†execçš„å‚æ•°æ”¾åœ¨å¯„å­˜å™¨a0å’Œa1ä¸­ï¼Œå¹¶å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨a7ä¸­ã€‚ç³»ç»Ÿè°ƒç”¨å·åŒ¹é…syscallsæ•°ç»„ä¸­çš„æ¡ç›®ï¼Œsyscallsæ•°ç»„æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ(kernel/syscall.c:107)ã€‚è°ƒç”¨æŒ‡ä»¤è¢«æ•è·åˆ°å†…æ ¸ä¸­ï¼Œå¹¶å¯¼è‡´uservecã€usertrapå’Œsycallæ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">la a0, init</span><br><span class="line">la a1, argv</span><br><span class="line">li a7, SYS_exec</span><br><span class="line">ecall</span><br></pre></td></tr></table></figure><p>Syscall (kernel/ Syscall .c:132) ä»trapframeä¸­ä¿å­˜çš„a7ä¸­è·å–ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¹¶ä½¿ç”¨å®ƒç´¢å¼•åˆ°ç³»ç»Ÿè°ƒç”¨ä¸­ã€‚å¯¹äºç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œa7åŒ…å«SYS_exec (ker- nel/ sycall .h:8)ï¼Œå¯¼è‡´è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å®ç°å‡½æ•°SYS_execã€‚</p><p>å½“sys_execè¿”å›æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨å°†è¿”å›å€¼è®°å½•åœ¨p-&gt;trapframe-&gt;a0ä¸­ã€‚è¿™å°†å¯¼è‡´å¯¹exec()çš„åŸå§‹ç”¨æˆ·ç©ºé—´è°ƒç”¨è¿”å›è¯¥å€¼ï¼Œå› ä¸ºRISC-Vä¸Šçš„Ccallçº¦å®šå°†è¿”å›å€¼æ”¾åœ¨a0ä¸­ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨é€šå¸¸è¿”å›è´Ÿæ•°è¡¨ç¤ºé”™è¯¯ï¼Œè¿”å›é›¶æˆ–æ­£æ•°è¡¨ç¤ºæˆåŠŸã€‚å¦‚æœç³»ç»Ÿè°ƒç”¨å·æ— æ•ˆï¼Œç³»ç»Ÿè°ƒç”¨å°†æ‰“å°é”™è¯¯å¹¶è¿”å›âˆ’1ã€‚</p><h2 id><a href="#" class="headerlink" title></a></h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png" alt="æˆªå±2023-01-15 00.09.58"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab3 Page Table</title>
      <link href="/2023/01/11/MIT6-s081-Lab3-Page-Table/"/>
      <url>/2023/01/11/MIT6-s081-Lab3-Page-Table/</url>
      
        <content type="html"><![CDATA[<h2 id="é¡µè¡¨ç»“æ„æ¨å¯¼"><a href="#é¡µè¡¨ç»“æ„æ¨å¯¼" class="headerlink" title="é¡µè¡¨ç»“æ„æ¨å¯¼"></a>é¡µè¡¨ç»“æ„æ¨å¯¼</h2><p>RICS-Væ¶æ„ï¼Œ2^39bitå†…å­˜å¯ç”¨ï¼Œ2^37Byteã€‚æ¯é¡µæ˜¯4096Byteï¼Œ2^12 Byte</p><p>é€»è¾‘ä¸Šï¼Œé¡µè¡¨éœ€è¦2^27ä¸ªpteï¼Œä»¥æ˜ å°„å…¨éƒ¨ç‰©ç†åœ°å€(pteæ˜¯é¡µè¡¨ä¸­å¯¹ä»¥åº”ä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€çš„ä¿¡æ¯å­˜å‚¨å•å…ƒ)ã€‚</p><p>æ¯ä¸ªpteåŒ…å«64bitï¼ˆ44bit PNNï¼Œä¸€äº›Flagï¼‰ã€‚ä»¥ä¸‹ä¸ºpteç»“æ„ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png" alt="æˆªå±2023-01-11 13.57.28"></p><p>ä½†æ˜¯ï¼Œ2^27ä¸ªpteéœ€è¦å†…å­˜ï¼š2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MBã€‚è‹¥å­˜å‚¨å…¨éƒ¨è¿›ç¨‹çš„pteåˆ™éœ€è¦å ç”¨å¤§é‡å†…å­˜ã€‚å› æ­¤ä½¿ç”¨ä¸‰çº§é¡µè¡¨ç»“æ„ï¼š</p><p>ä¸€ä¸ªé¡µè¡¨é¡µï¼ŒåŒ…å«512ä¸ªpteã€‚512^3=(2^9)^3ï¼Œå› æ­¤ç†è®ºä¸Šå¯ä»¥ä½¿ç”¨ä¸‰çº§é¡µè¡¨è¡¨ç¤ºå…¨éƒ¨çš„ç‰©ç†åœ°å€ã€‚å½“ä¸€å—è™šæ‹Ÿåœ°å€æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œåˆ™ç›¸åº”çš„é¡µè¡¨ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨å†…å­˜ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png" alt="æˆªå±2023-01-11 13.30.54"></p><p>æ ¹æ®è™šæ‹Ÿåœ°å€ï¼Œè·å–ç›¸åº”pte (è‹¥è¯¥è™šæ‹Ÿåœ°å€æœªè¢«åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„é¡µè¡¨åˆå§‹åŒ–)ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// pagetable æ ¹é¡µè¡¨</span><br><span class="line">// va è™šæ‹Ÿåœ°å€</span><br><span class="line">// allocæ˜¯å¦åˆå§‹åŒ–</span><br><span class="line">pte_t* walk(pagetable_t pagetable, uint64 va, int alloc)&#123;</span><br><span class="line">  if(va &gt;= MAXVA)</span><br><span class="line">    panic(&quot;walk&quot;);</span><br><span class="line"></span><br><span class="line">// ä¸‰çº§é¡µè¡¨</span><br><span class="line">  for(int level = 2; level &gt; 0; level--) &#123;</span><br><span class="line">    pte_t *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">    if(*pte &amp; PTE_V) &#123; //å·²ç»åˆ†é…</span><br><span class="line">      pagetable = (pagetable_t)PTE2PA(*pte); //è·³è½¬åˆ°ä¸‹ä¸€çº§é¡µè¡¨</span><br><span class="line">    &#125; else &#123; // ä¸ºåˆ†é…æ­¤çº§é¡µè¡¨</span><br><span class="line">      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //åˆ†é…ä¸€é¡µï¼Œå¹¶è·³è½¬åˆ°ä¸‹ä¸€çº§é¡µè¡¨</span><br><span class="line">        return 0;</span><br><span class="line">      memset(pagetable, 0, PGSIZE); //åˆå§‹åŒ–é¡µ</span><br><span class="line">      *pte = PA2PTE(pagetable) | PTE_V; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return &amp;pagetable[PX(0, va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸åœ°å€ç©ºé—´"><a href="#å†…æ ¸åœ°å€ç©ºé—´" class="headerlink" title="å†…æ ¸åœ°å€ç©ºé—´"></a>å†…æ ¸åœ°å€ç©ºé—´</h2><h2 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h2><h2 id="Labç»“æœ"><a href="#Labç»“æœ" class="headerlink" title="Labç»“æœ"></a>Labç»“æœ</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png" alt="æˆªå±2023-01-13 15.03.29"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab2 System Call</title>
      <link href="/2023/01/10/6-s081-Lab2-System-Call/"/>
      <url>/2023/01/10/6-s081-Lab2-System-Call/</url>
      
        <content type="html"><![CDATA[<h2 id="xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ"><a href="#xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ" class="headerlink" title="xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ"></a>xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ</h2><ul><li>/user/usys.S æ˜¯ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€çš„æ±‡ç¼–è„šæœ¬ï¼Œè¯¥æ–‡ä»¶ç”±usys.plç”Ÿæˆ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global sysinfo</span><br><span class="line">sysinfo:</span><br><span class="line"> li a7, SYS_sysinfo  # å°†syscallçš„æ ‡è¯†å†™å…¥a7å¯„å­˜å™¨</span><br><span class="line"> ecall               # ä½¿ç”¨ecallæŒ‡ä»¤ï¼Œä½¿ç”¨a7å¯„å­˜å™¨ï¼Œè¿›å…¥å†…æ ¸æ€</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure><ul><li>/kernal/syscall.cï¼Œè¯¥å‡½æ•°è·å–ç”¨æˆ·æ€ä¼ é€’çš„syscall idï¼Œå¹¶è¿›è¡Œè°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void syscall(void) &#123;</span><br><span class="line">  int num;</span><br><span class="line">  struct proc *p = myproc(); //è·å–è¿›å…¥å†…æ ¸æ€çš„è¿›ç¨‹</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;    //è·å–éœ€è¦æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨idï¼Œè¯¥idç”±usys.Så†™å…¥äº†a7å¯„å­˜å™¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123; # ä½¿ç”¨syscallçš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨</span><br><span class="line">  </span><br><span class="line">    // Use num to lookup the system call function for num, call it,</span><br><span class="line">    // and store its return value in p-&gt;trapframe-&gt;a0</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num](); #å°†syscallè¿”å›å€¼ä¿å­˜åœ¨a0å¯„å­˜å™¨ï¼Œé€šè¿‡æ­¤æ–¹æ³•å°†è¿”å›å€¼ä¼ é€’ç»™ç”¨æˆ·æ€</span><br><span class="line">    </span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    printf(&quot;%d %s: unknown sys call %d\n&quot;,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = -1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/kernal/sysproc.cï¼Œè¯¥æ–‡ä»¶æ˜¯lab2ä¸­syscallçš„å®ç°ä»£ç æ–‡ä»¶</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//å®ç°syscall,è¯¥å‡½æ•°éœ€åœ¨syscall.cä¸­å£°æ˜</span><br><span class="line">uint64 sys_trace(void)&#123;</span><br><span class="line"></span><br><span class="line">// è·å–system call å‚æ•°</span><br><span class="line">    int muskid;</span><br><span class="line">    argint(0,&amp;muskid);</span><br><span class="line"></span><br><span class="line">    return trace(muskid); //do something and return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ syscallæµç¨‹"><a href="#æ·»åŠ syscallæµç¨‹" class="headerlink" title="æ·»åŠ syscallæµç¨‹"></a>æ·»åŠ syscallæµç¨‹</h2><ol><li><p>åœ¨syscall.hä¸­æ·»åŠ ä¸€ä¸ªsyscall id</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define SYS_trace  22</span><br><span class="line">#define SYS_sysinfo  23</span><br></pre></td></tr></table></figure></li><li><p>åœ¨syscall.cä¸­æ·»åŠ syscallçš„å‡½æ•°å®šä¹‰</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extern uint64 sys_trace(void);</span><br><span class="line">extern uint64 sys_sysinfo(void);</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[SYS_trace]   sys_trace,</span><br><span class="line">[SYS_sysinfo]   sys_sysinfo</span><br></pre></td></tr></table></figure></li><li><p>åœ¨sysprocä¸­å®ç°syscallå‡½æ•°</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uint64 sys_trace(void)&#123;</span><br><span class="line">    int muskid;</span><br><span class="line"></span><br><span class="line">    // è·å–system call å‚æ•°</span><br><span class="line">    argint(0,&amp;muskid);</span><br><span class="line"></span><br><span class="line">    return trace(muskid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨/user/usys.plåŠ å…¥ç³»ç»Ÿè°ƒç”¨å£°æ˜</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry(&quot;trace&quot;);</span><br><span class="line">entry(&quot;sysinfo&quot;);</span><br></pre></td></tr></table></figure></li></ol><p>è¿™æ ·ä»¥æ¥ï¼Œç”¨æˆ·æ€å‘å†…æ ¸æ€ä¼ é€’syscall id(a7)ï¼Œå†…æ ¸æ€æ ¹æ®idå¯¹ç›¸åº”çš„syscallè¿›è¡Œè°ƒç”¨ï¼Œå¹¶å°†è¿”å›å€¼å‚¨å­˜åœ¨a0å¯„å­˜å™¨ã€‚</p><h2 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h2><h2 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png" alt="æˆªå±2023-01-10 02.03.22"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Log framework High level design</title>
      <link href="/2022/12/06/Log-fremawork-High-level-design/"/>
      <url>/2022/12/06/Log-fremawork-High-level-design/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºäº†æå‡goè¯­è¨€çš„ç†Ÿç»ƒç¨‹åº¦ï¼Œä½¿ç”¨goè¯­è¨€ç¼–å†™ä¸€ä¸ªeasy log framework. This is the high level design for this framework.</p><h2 id="Requirement-Analysis"><a href="#Requirement-Analysis" class="headerlink" title="Requirement Analysis"></a>Requirement Analysis</h2><h3 id="1-Log-levels"><a href="#1-Log-levels" class="headerlink" title="1. Log levels"></a>1. Log levels</h3><p>â€‹    ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE</p><h3 id="2-Basic-requirement"><a href="#2-Basic-requirement" class="headerlink" title="2. Basic requirement"></a>2. Basic requirement</h3><p>ç”¨æˆ·éœ€è¦åœ¨æ¯ä¸ªéœ€è¦ä½¿ç”¨æ—¥å¿—çš„ç±»ä¸­å£°æ˜ä¸€ä¸ªEasyLogå¯¹è±¡ã€‚åˆ©ç”¨å·¥å‚æ¨¡å¼å£°æ˜ï¼Œå·¥å‚æ–¹æ³•å¯é€‰ä¸€ä¸‹å‡ ç§å‚æ•°ï¼š</p><ul><li></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cross-domain security in SSO</title>
      <link href="/2022/12/01/Cross-domain-security-in-SSO/"/>
      <url>/2022/12/01/Cross-domain-security-in-SSO/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºCasdoor Flutter Sdké‡åˆ°äº†è·¨åŸŸé—®é¢˜ï¼Œæ•…è°ƒç ”Oktaå’ŒAuth0çš„è·¨åŸŸé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæ–¹æ¡ˆåˆæ­¥æ•´ç†å¦‚ä¸‹ï¼š</p><h2 id="è§£å†³ç­–ç•¥"><a href="#è§£å†³ç­–ç•¥" class="headerlink" title="è§£å†³ç­–ç•¥"></a>è§£å†³ç­–ç•¥</h2><p>åœ¨å•ç‚¹ç™»å½•ç³»ç»Ÿä¸­ï¼ŒSingle-Page Appéœ€è¦ä»æµè§ˆå™¨è·¨åŸŸè®¿é—®SSOæœåŠ¡å™¨ã€‚ä¸ºæ”¯æŒè¿™ä¸€éœ€æ±‚ï¼Œå•ç‚¹ç™»å½•ç³»ç»Ÿåº”æ”¯æŒé…ç½®â€œAllowed Web Originsâ€å’Œâ€œAllowed APIâ€ã€‚SSOæœåŠ¡å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªé…ç½®å¯¹è·¨åŸŸè¯·æ±‚è¿›è¡Œæ ¡éªŒã€‚</p><blockquote><p>å®šä¹‰ï¼š</p><ul><li><p><strong>Single-Page App</strong>ï¼šå•é¡µåº”ç”¨ã€‚ä¸ºä¸åŒ…å«åç«¯çš„çº¯webé¡µé¢</p></li><li><p><strong>Allowed Web Origins</strong>ï¼šå…è®¸è·¨åŸŸè®¿é—®çš„ç½‘ç»œæº(Web Origin)ã€‚å°½ç®¡Single-Page Appä¸åŒ…å«åç«¯ï¼Œä½†å…¶ä¾ç„¶ä¼šæŒ‚åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šä»¥æ”¯æŒç”¨æˆ·è®¿é—®ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„Hostå°±æ˜¯Web Origin</p></li><li><p> <strong>Allowed API</strong>ï¼šæ”¯æŒè·¨åŸŸè®¿é—®çš„API</p></li></ul></blockquote><p>ä»¥ä¸‹ä¸ºOktaå’ŒAuth0å¯¹ä¸¤ç§é…ç½®çš„æ”¯æŒæƒ…å†µï¼š</p><table><thead><tr><th align="center"></th><th align="center">Okta</th><th align="center">Auth0</th></tr></thead><tbody><tr><td align="center">Allowed Web Origins</td><td align="center">âœ…</td><td align="center">âœ…</td></tr><tr><td align="center">Allowed API</td><td align="center">âœ…</td><td align="center">â­•ï¸</td></tr></tbody></table><p>å¯¹äºJs sdkï¼Œéœ€å¯¹è·¨åŸŸè®¿é—®çš„è¯·æ±‚å¤´è¿›è¡Œé…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">referrer : Web Origin/path</span><br><span class="line">origin : Web Origin</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œéœ€é’ˆå¯¹Tokençš„å­˜å‚¨æ¨¡å¼æä¾›å®‰å…¨ä¿éšœï¼Œä¾‹å¦‚localstorageå’Œè®¾å®šè¿‡æœŸç­–ç•¥ã€‚<br>ï¼ˆOktaå’ŒAuth0çš„æ•´ä¸ªè·¨åŸŸæ”¯æŒé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæš‚æœªå¼„æ¸…æ•´ä¸ªæµç¨‹å…¨éƒ¨ç»†èŠ‚ï¼‰</p><h2 id="Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"><a href="#Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ" class="headerlink" title="Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"></a>Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ</h2><p>Oktaè·¨åŸŸé…ç½®æ•™ç¨‹ï¼š<a href="https://developer.okta.com/docs/guides/enable-cors/main/">https://developer.okta.com/docs/guides/enable-cors/main/</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png" alt="æˆªå±2022-12-01 19.50.59"></p><p>Okta js sdk repoï¼š<a href="https://github.com/okta/okta-auth-js">https://github.com/okta/okta-auth-js</a><br>Okta js sdkæ•™ç¨‹ï¼š<a href="https://developer.okta.com/docs/guides/auth-js/main/">https://developer.okta.com/docs/guides/auth-js/main/</a></p><h2 id="Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"><a href="#Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ" class="headerlink" title="Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"></a>Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ</h2><p>Auth0 js sdkæ•™ç¨‹ï¼š<a href="https://auth0.com/docs/quickstart/spa/vanillajs/interactive">https://auth0.com/docs/quickstart/spa/vanillajs/interactive</a></p><p><img src="https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.48.51.png?raw=true" alt="æˆªå±2022-12-01 19.48.51"></p><p>Auth0 js sdk: <a href="https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js">https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Study Notes about Virtualization 01</title>
      <link href="/2022/11/29/Study-Notes-about-Virtualization-01/"/>
      <url>/2022/11/29/Study-Notes-about-Virtualization-01/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-runtime-environment"><a href="#Docker-runtime-environment" class="headerlink" title="Docker runtime environment"></a>Docker runtime environment</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg" alt="img_3faaf387af747fdecd5530e05bfceeb0"></p><p>Dockeråˆå§‹å‘å±•é«˜åº¦å°é—­ï¼ŒåæœŸè½¬å‘å¼€æ”¾è·¯çº¿ã€‚æ­¤æ—¶Dockerçš„è¿è¡Œä¾èµ–ä¸ºRuncã€‚Runcæ˜¯ä¸€ä¸ªå®ç°äº†OCIï¼ˆ<a href="https://www.opencontainers.org/">Open Container Initiative</a>ï¼‰åè®®çš„ç»„ä»¶ã€‚å› æ­¤å¯ä»¥é€šè¿‡æ”¯æŒOCIåè®®ï¼Œå®ç°å¯¹Runcçš„æ›¿æ¢ï¼Œä»è€Œå®ç°è‡ªå·±çš„Dockerè¿è¡Œæ—¶ä¾èµ–ã€‚</p><p>Userful Linkï¼š<br>Blogï¼š<a href="https://xuanwo.io/2019/08/06/oci-intro/">https://xuanwo.io/2019/08/06/oci-intro/</a><br>OCI Repoï¼š<a href="https://github.com/opencontainers/runtime-spec">https://github.com/opencontainers/runtime-spec</a></p><h2 id="gVisor"><a href="#gVisor" class="headerlink" title="gVisor"></a>gVisor</h2><p><a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html%EF%BC%89">gVisor</a>æ˜¯ä¸€ä¸ªè°·æ­Œçš„å¼€æºé¡¹ç›®ã€‚å®ç°äº†OCIåè®®ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºDockerçš„runtimeã€‚Dockerå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œç¨‹åºæœ‰å¯èƒ½é€ƒé€¸å‡ºContainerï¼Œä»è€Œå¨èƒæ“ä½œç³»ç»Ÿæœ¬èº«è¿è¡Œã€‚å› æ­¤éœ€è¦ä¸€æ¬¾æ›´åŠ å®‰å…¨çš„Runtime applicationã€‚gVisorå°±æ˜¯è¿™æ ·çš„ä¸€æ¬¾appã€‚</p><p>gVisoræ˜¯ä¸€ä¸ªsandboxï¼Œå®ç°äº†ä¸€ä¸ªâ€œåº”ç”¨å†…æ ¸â€â€”â€”Sentryã€‚åŸç†æ˜¯åŠ«æŒäº†åº”ç”¨ç¨‹åºçš„å…¨éƒ¨sys callï¼Œåˆ©ç”¨Ptrace(or KVM)ã€‚SentryåŠ«æŒåˆ°sys callåï¼Œä½¿ç”¨goè¯­è¨€æ¨¡æ‹Ÿå‡ºäº†sys callçš„åŠŸèƒ½ï¼Œä»è€Œå®ç°äº†ä¸€ä¸ªè™šæ‹Ÿå†…æ ¸ã€‚éš”ç¦»äº†ç¨‹åºå’ŒHost Kernelã€‚</p><p>åŒæ—¶gVisoræœ‰ä¸€ä¸ªGoferæ¨¡å—ï¼Œç”¨äºå¤„ç†åº”ç”¨ç¨‹åºçš„IOã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png" alt="665372-20210108180022427-177964885"></p><h2 id="Learning-Plan"><a href="#Learning-Plan" class="headerlink" title="Learning Plan"></a>Learning Plan</h2><ul><li>Step1: å­¦å®Œgo</li><li>Step2: çœ‹<a href="https://github.com/opencontainers/runc">Runc</a>çš„ä»£ç ï¼Œç ”ç©¶OCIæ€ä¹ˆå®ç°çš„</li><li>Step3: çœ‹<a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html">gVisor</a>çš„ä»£ç ï¼Œç ”ç©¶å®ç°ç»†èŠ‚</li><li>Step4: å®ç°ä¸€ä¸ªè‡ªå·±çš„Docker runtimeï¼Œè¿™ä¸ªRuntimeåº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š<ul><li>ä½¿ç”¨goå®ç°</li><li>ç®€å•è½»é‡ï¼Œä½†å…·æœ‰å®Œå¤‡çš„åŠŸèƒ½ï¼Œå¯ä»¥å®Œç¾çš„ä½œä¸ºä¸€ä¸ªOJç³»ç»Ÿçš„Sandbox</li><li>åˆ©ç”¨Ptraceå®ç°</li><li>æ”¯æŒä½¿ç”¨jsonè‡ªå®šä¹‰sys callçš„è°ƒç”¨è§„åˆ™ï¼ˆAllow Listï¼‰ï¼Œä»¥åŠè¿›è¡Œå†…å­˜æ—¶é—´é™åˆ¶ï¼Œ<del>å¹¶å®ç°ä¸€å¥—ç®€æ˜“çš„å¯¹å¤–äº¤äº’æ¥å£(<a href="https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto">CRI</a>)</del></li><li>æ”¯æŒOCIï¼Œå¯ä»¥ä½œä¸ºDockerçš„runtimeï¼Œæ”¯æŒK8Såˆ†å‘éƒ¨ç½²user codeï¼Œä»è€Œå¯ä»¥ä½œä¸ºOJç³»ç»Ÿçš„è¯„æµ‹é›†ç¾¤Workerï¼Œ</li><li>ä¸¥æ ¼ä¿è¯é«˜ä»£ç è´¨é‡ï¼Œä¿è¯é«˜å¯è¯»æ€§ï¼Œå¯ç»´æŠ¤æ€§</li></ul></li></ul><p>â€‹    </p>]]></content>
      
      
      
        <tags>
            
            <tag> Virtualization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Casdoor Flutter Sdk Bug Fix</title>
      <link href="/2022/11/27/Casdoor-Flutter-Sdk-Bug-Fix/"/>
      <url>/2022/11/27/Casdoor-Flutter-Sdk-Bug-Fix/</url>
      
        <content type="html"><![CDATA[<h2 id="1-å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜"><a href="#1-å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜" class="headerlink" title="1.å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜"></a>1.å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜</h2><p>å®‰è£…äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹æµè§ˆå™¨ï¼Œå°±è§£å†³é—®é¢˜äº†ï¼Œå› æ­¤sdkçš„ä»£ç æœ¬èº«åº”è¯¥æ˜¯æ˜¯æ­£ç¡®çš„ï¼ˆåŸå§‹æµè§ˆå™¨ä¸èƒ½è·³è½¬çš„é—®é¢˜æš‚ä¸æ¸…æ¥šåŸå› ï¼Œè¿˜éœ€ç ”ç©¶ï¼‰  </p><h2 id="2-Flutter-webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜"><a href="#2-Flutter-webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜" class="headerlink" title="2.Flutter webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜"></a>2.Flutter webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg" alt="5DC1E696AFA5781CE5B8C30C59AEFA8F"></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg" alt="D306359D80BF70C7E5350EE14321E2DF"></p><p>è¿™ä¸ªé—®é¢˜ç½‘ä¸Šæœ‰å¾ˆå¤šè®¨è®ºï¼Œå•ä»Flutterçš„è§’åº¦æ¥è¯´ï¼Œå¥½åƒæ²¡æœ‰å®Œç¾è§£å†³æ–¹æ¡ˆã€‚ </p><blockquote><p>è¿™ä¸€å—æˆ‘ä¸æ¸…æ¥šæˆ‘ç†è§£çš„å¯¹ä¸å¯¹ï¼š</p><p>æˆ‘ç ”ç©¶äº†ä¸€ä¸‹Casdoor js sdkçš„é€»è¾‘ï¼Œä½¿ç”¨äº†js sdkçš„é¡¹ç›®é‡Œï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°æµè§ˆå™¨ç›´æ¥å‘Casdoorå‘é€è¯·æ±‚è·å–tokençš„ä¾‹å­ã€‚ </p><p>1.casdoor-python-vue-sdk-exampleè¿™ä¸ªrepoï¼Œtokenæ˜¯é€šè¿‡åç«¯çš„pyç¨‹åºè·å–çš„ï¼Œåº”è¯¥ä¸æ˜¯æµè§ˆå™¨ç›´æ¥å‘casdoorå‘è¯·æ±‚ã€‚</p><p>2.casdoor-raw-js-exampleè¿™ä¸ªrepoï¼Œæ˜¯ç”¨node.jså¯åŠ¨é¡¹ç›®ï¼ˆå¹¶ä¸”å¯åŠ¨äº†ä¸€ä¸ªä»£ç†serverï¼Œç”±è¿™ä¸ªserverå‘Casdoorå‘é€è¯·æ±‚ï¼‰ï¼Œä¹Ÿä¸æ˜¯åŸç”Ÿjsåœ¨æµè§ˆå™¨ç›´æ¥è¯·æ±‚tokenã€‚</p></blockquote><p>ä½†æ˜¯Flutter-webå°±ç­‰äºæ˜¯ç¼–è¯‘å‡ºæ¥ä¸€ä¸ªé™æ€webé¡¹ç›®ï¼ŒåŸç”Ÿè¿è¡Œåœ¨æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä¸­çš„åŸç”Ÿjsç›´æ¥å»è¯·æ±‚å…¶ä»–åŸŸåä¸‹çš„casdoorå¿…ç„¶é‡åˆ°è·¨åŸŸé—®é¢˜</p><p>ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç›®å‰æƒ³åˆ°äº†å››ç§æ–¹æ³•ï¼š</p><ul><li>ä¸ºCasdoorçš„tokenè·å–æ¥å£æ·»åŠ CORSè·¨åŸŸèµ„æºåˆ†äº«æ”¯æŒ</li><li>ç”¨Flutterè°ƒç”¨åŸç”Ÿjsä»£ç ï¼Œé€šè¿‡ä¸€äº›ä¸å¤ªä¼˜ç¾çš„åŸç”Ÿjsæ–¹å¼ç»•è¿‡è·¨åŸŸé—®é¢˜</li><li>åœ¨Flutterå†…ç½®ä¸€ä¸ªä»£ç†ç¨‹åºï¼ˆç±»ä¼¼casdoor-raw-js-exampleï¼‰.ä½†æ˜¯è¿™æ ·æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œå› ä¸ºè¿™ä¸ªä»£ç†å¿…é¡»åœ¨Dartç¯å¢ƒä¸‹æ‰èƒ½å¯åŠ¨ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€æ²¡ç”¨ã€‚</li><li>è°ƒæ•´Flutter webçš„é€»è¾‘ï¼Œä¸å†æä¾›å…¶ç›´æ¥è·å–tokençš„åŠŸèƒ½ã€‚æˆ–å‘ŠçŸ¥ç”¨æˆ·ï¼Œç›´æ¥ç”¨Flutter webæ•´åˆCasdoorä¼šé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œå»ºè®®ç»“åˆåç«¯ä½¿ç”¨</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tree Generator (éšæœºç”Ÿæˆä¸€é¢—æ ‘)</title>
      <link href="/2022/11/23/Tree/"/>
      <url>/2022/11/23/Tree/</url>
      
        <content type="html"><![CDATA[<p>This is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.</p><p>Link: <a href="https://muchengl.github.io/tree/">https://muchengl.github.io/tree/</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png" alt="æˆªå±2022-11-23 14.06.22"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Casdoor Flutter Sdk Test</title>
      <link href="/2022/11/22/Casdoor-Flutter-sdk-Test/"/>
      <url>/2022/11/22/Casdoor-Flutter-sdk-Test/</url>
      
        <content type="html"><![CDATA[<h2 id="Step-1-Clone-casdoor-flutter-example-from-Github"><a href="#Step-1-Clone-casdoor-flutter-example-from-Github" class="headerlink" title="Step 1: Clone casdoor-flutter-example from Github"></a>Step 1: Clone casdoor-flutter-example from Github</h2><p>Link: <a href="https://github.com/casdoor/casdoor-flutter-example">https://github.com/casdoor/casdoor-flutter-example</a></p><h2 id="Step-2-Test-in-Chrome-Web"><a href="#Step-2-Test-in-Chrome-Web" class="headerlink" title="Step 2: Test in Chrome(Web)"></a>Step 2: Test in Chrome(Web)</h2><p>Encountered a cross-domain problem. So the token could not be obtained.</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cross-domain code</span></span><br><span class="line"><span class="comment">// Post: localhost -&gt; door.casdoor.com</span></span><br><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> _casdoor.requestOauthAccessToken(code);</span><br></pre></td></tr></table></figure><p>Error:</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png" alt="æˆªå±2022-11-26 14.12.45"></p><h2 id="Step-3-Test-in-Android-Emulator"><a href="#Step-3-Test-in-Android-Emulator" class="headerlink" title="Step 3: Test in Android Emulator"></a>Step 3: Test in Android Emulator</h2><p>Android app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)</p><p>Graphicï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png" alt="æˆªå±2022-11-26 14.41.25"></p><h2 id="Step-4-Test-in-IOS-Emulator"><a href="#Step-4-Test-in-IOS-Emulator" class="headerlink" title="Step 4: Test in IOS Emulator"></a>Step 4: Test in IOS Emulator</h2><p>Working well.</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png" alt="æˆªå±2022-11-26 15.38.58"></p>]]></content>
      
      
      
        <tags>
            
            <tag> casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Amazon internship Doc</title>
      <link href="/2022/11/19/Amazon-Doc/"/>
      <url>/2022/11/19/Amazon-Doc/</url>
      
        <content type="html"><![CDATA[<object data="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf" type="application/pdf" width="700px" height="800px">    <embed src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf">        <p>This browser does not support PDFs. Please download the PDF to view it: <a href="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf">Download PDF</a>.</p>    </object>]]></content>
      
      
      
        <tags>
            
            <tag> intern </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OS Learning 01</title>
      <link href="/2022/11/13/OS%20Learning%2001/"/>
      <url>/2022/11/13/OS%20Learning%2001/</url>
      
        <content type="html"><![CDATA[<h1 id="C-basic-knowledge"><a href="#C-basic-knowledge" class="headerlink" title="C basic knowledge"></a>C basic knowledge</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spin()</span><br></pre></td></tr></table></figure><p>ç­‰ä¸€ç§’é’Ÿè¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert( è¡¨è¾¾å¼ );</span><br></pre></td></tr></table></figure><p>è‹¥è¡¨è¾¾å¼å€¼ä¸º0ï¼Œåˆ™ç»ˆæ­¢ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(num);</span><br><span class="line"><span class="type">int</span> *p=<span class="built_in">malloc</span>(num);</span><br></pre></td></tr></table></figure><p>åŠ¨æ€åˆ†é…å†…å­˜å‡½æ•°ï¼Œåˆ†é…é•¿åº¦ä¸ºnumå­—èŠ‚çš„å†…å­˜å—ï¼Œéœ€è¦ä½¿ç”¨freeé‡Šæ”¾ã€‚</p><p>pæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œè¡¨ç¤ºå†…å­˜ä¸­çš„ä¸€ä¸ªåœ°å€ã€‚*pè¡¨ç¤ºè¿™ä¸ªåœ°å€å†…å­˜ä¸­å­˜çš„å€¼ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> Operation Systems Three Easy Pieces </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>first-blog Test</title>
      <link href="/2022/11/13/my-first-blog/"/>
      <url>/2022/11/13/my-first-blog/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg" alt="1"></p><h1 id="Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰"><a href="#Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰" class="headerlink" title="Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰"></a>Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰</h1><h3 id="1-ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£"><a href="#1-ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£" class="headerlink" title="1.ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£"></a>1.ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£</h3><h3 id="2-Springç¨‹åºç»“æ„"><a href="#2-Springç¨‹åºç»“æ„" class="headerlink" title="2.Springç¨‹åºç»“æ„"></a>2.Springç¨‹åºç»“æ„</h3><ul><li>å®ä½“ç±»ï¼ˆpojoï¼‰<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liu.pojo;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String str;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStr</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;str=&#x27;&quot;</span> + str + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>é…ç½®æ–‡ä»¶<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>æµ‹è¯•ç±»<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–Springçš„ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Hello hello=(Hello)context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰"><a href="#3-setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰" class="headerlink" title="3.setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰"></a>3.setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰</h3></li><li>å®ä½“ç±»<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Students</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    <span class="keyword">private</span> String[] book;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobby;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; card;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; game;</span><br><span class="line">    <span class="keyword">private</span> Properties info;</span><br><span class="line">    <span class="keyword">private</span> String wife;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>é…ç½®æ–‡ä»¶<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;address&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Address&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Students&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        æ™®é€šå€¼æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;åˆ˜ç€šä¸­&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        beanæ³¨å…¥ï¼Œä½¿ç”¨ref--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;address&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              æ•°ç»„æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;book&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‚²æ…¢ä¸åè§<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‘¼å•¸å±±åº„<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>ç“¦å°”ç™»æ¹–<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              åˆ—è¡¨æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‚²æ…¢ä¸åè§<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‘¼å•¸å±±åº„<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>ç“¦å°”ç™»æ¹–<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              mapæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;é¥­å¡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;å·¥èµ„å¡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              é›†åˆæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;game&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span>åƒé¸¡<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span>lol<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        propertiesæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;administrator&quot;</span>&gt;</span>administrator@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;support&quot;</span>&gt;</span>support@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;development&quot;</span>&gt;</span>development@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        nullæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">null</span>&gt;</span><span class="tag">&lt;/<span class="name">null</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰"><a href="#4-è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰" class="headerlink" title="4.è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰"></a>4.è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰</h3>è‡ªåŠ¨è£…é…é¦–å…ˆä¼šæ ¹æ®nameå¯»æ‰¾å¯¹è±¡ï¼Œ<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;1&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;dog1&quot;)</span><span class="comment">//è‹¥dogå¯¹è±¡ä¸å”¯ä¸€ï¼Œéœ€è®¾ç½®ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;context:annotation-config/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;cat&quot;</span> class=<span class="string">&quot;com.liu.pojo.Cat&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dog1&quot;</span> class=<span class="string">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dog2&quot;</span> class=<span class="string">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;people&quot;</span> class=<span class="string">&quot;com.liu.pojo.People&quot;</span> autowire=<span class="string">&quot;byName&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><h3 id="5-æ³¨è§£ç¼–ç¨‹"><a href="#5-æ³¨è§£ç¼–ç¨‹" class="headerlink" title="5.æ³¨è§£ç¼–ç¨‹"></a>5.æ³¨è§£ç¼–ç¨‹</h3></li><li>é…ç½®æ–‡ä»¶ï¼ˆxmlï¼‰ä¸æ³¨è§£å¹¶å­˜<ul><li>daoå±‚ï¼š@Repository</li><li>pojoå±‚ï¼š@Component</li><li>serviceï¼š@Service</li><li>Controllerå±‚ï¼š@Controller<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//ç­‰ä»·äº&lt;bean id=&quot;user&quot; class=&quot;com.liu.pojo.User&quot;/&gt;</span></span><br><span class="line"><span class="meta">@Scope(&quot;singleton&quot;)</span><span class="comment">//å•ä¾‹ï¼ŒprototypeåŸå‹æ¨¡å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;lhz&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.liu&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    æ‰«æåŒ…ä¸‹çš„æ³¨è§£--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="6-ä»£ç†æ¨¡å¼"><a href="#6-ä»£ç†æ¨¡å¼" class="headerlink" title="6.ä»£ç†æ¨¡å¼"></a>6.ä»£ç†æ¨¡å¼</h3><h3 id="7-é¢å‘åˆ‡é¢ç¼–ç¨‹-aop"><a href="#7-é¢å‘åˆ‡é¢ç¼–ç¨‹-aop" class="headerlink" title="7.é¢å‘åˆ‡é¢ç¼–ç¨‹(aop)"></a>7.é¢å‘åˆ‡é¢ç¼–ç¨‹(aop)</h3><p>é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ˜¯åœ¨ä¸æ”¹å˜åŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šï¼Œå¢å¼ºä»£ç çš„åŠŸèƒ½ã€‚Spring-aopæœ‰ä¸‰ç§å®ç°æ–¹å¼ã€‚</p><ul><li>æ–¹æ³•ä¸€ï¼šSpringåŸç”ŸAPIæ¥å£å®ç°<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.service.UserServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;afterLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.log.AfterLog&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;beforeLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.log.BeforeLog&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--æ–¹å¼1:åŸç”ŸSpringçš„APIæ¥å£--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;afterLog&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;beforeLog&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>åœ¨ä¸€ä¸ªåŒ…ä¸‹å»ºç«‹ä»¥ä¸‹ä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«ä½œä¸ºæ‰§è¡Œå‰å’Œæ‰§è¡Œå<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeforeLog</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] objects, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(target.getClass().getName()+<span class="string">&quot;çš„&quot;</span>+method.getName()+<span class="string">&quot;è¢«æ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterLog</span> <span class="keyword">implements</span> <span class="title class_">AfterReturningAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(Object o, Method method, Object[] objects, Object o1)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œäº†&quot;</span>+method.getName()+<span class="string">&quot;æ–¹æ³•ï¼Œè¿”å›ç»“æœä¸ºï¼š&quot;</span>+o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æ–¹æ³•äºŒï¼šä½¿ç”¨è‡ªå®šä¹‰ç±»<br>å®šä¹‰ä¸€ä¸ªDiyPointCutç±»ï¼Œåœ¨é‡Œé¢å†™afterå’Œbeforeæ–¹æ³•<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ–¹å¼2ï¼šè‡ªå®šä¹‰ç±»--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;diy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.diy.DiyPointCut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è‡ªå®šä¹‰åˆ‡é¢--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;diy&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--åˆ‡ç‚¹--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é€šçŸ¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyPointCut</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========æ–¹æ³•æ‰§è¡Œå========&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========æ–¹æ³•æ‰§è¡Œå‰========&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æ³¨è§£<br>éœ€åœ¨xmlæ–‡ä»¶ä¸­å¼€å¯æ³¨è§£<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ–¹å¼3--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span><span class="comment">&lt;!--å¼€å¯æ³¨è§£--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;annotationPointCut&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.diy.AnnotationPointCut&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span><span class="comment">//æ ‡è®°ä¸ºåˆ‡é¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationPointCut</span> &#123;</span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===æ–¹æ³•æ‰§è¡Œå‰===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===æ–¹æ³•æ‰§è¡Œå===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-Springå’ŒMyBatisæ•´åˆ"><a href="#8-Springå’ŒMyBatisæ•´åˆ" class="headerlink" title="8.Springå’ŒMyBatisæ•´åˆ"></a>8.Springå’ŒMyBatisæ•´åˆ</h3>éœ€ä½¿ç”¨mavenå¯¼å…¥ç›¸åº”çš„jaråŒ…<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--æµ‹è¯•--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--æ³¨è§£--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        springä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        Springæ“æ§æ•°æ®åº“--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        aopç»‡å…¥åŒ…--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>Spring-Mybatisä½¿ç”¨Springå°†Mybatisçš„é…ç½®æ•´åˆï¼Œå¯ä»¥é€‰æ‹©åœ¨åŸæ¥çš„MyBatis-configæ–‡ä»¶ä¸­é…ç½®ä¸€äº›ç®€å•çš„Mapperæ³¨å†Œå’Œå¼•ç”¨åˆ«åï¼Œåœ¨Spring-dao.xmlæ–‡ä»¶ä¸­å†™å„ç§é…ç½®ï¼Œæœ€ååœ¨applicationContext.xmlæ–‡ä»¶ä¸­æ³¨å†Œå„ä¸ªç±»ã€‚ä¸Mybatisä¸åŒï¼ŒSpring-Mybatisåªèƒ½è·å¾—SqlSessionFactoryBeanå’ŒSqlSessionTemplateã€‚Spring-Mybatisæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚</li><li>ç¬¬ä¸€ç§æ–¹å¼</li></ul><p>é¦–å…ˆéœ€è¦å»ºç«‹å®ä½“ç±»ï¼Œå¹¶å»ºç«‹æ¥å£å’Œå¯¹åº”çš„xmlæ–‡ä»¶ï¼Œç„¶åå¼€å§‹é…ç½®xmlæ–‡ä»¶<br>MyBatis-config.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    å¼•ç”¨åˆ«å--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.liu.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Spring-dao.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    datasourceæ•°æ®æº--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis?useSSl=true<span class="symbol">&amp;amp;</span>useUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=utf-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    sqlSessionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        ç»‘å®šMyBatisé…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ³¨å†Œæ¥å£ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>applicationContext.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-dao.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentsMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.dao.StudentsMapperImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨å®Œæˆxmlé…ç½®ä¹‹åï¼Œä¸€èˆ¬å¯ä»¥å»ºç«‹ä¸€ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå¹¶åœ¨è¿™ä¸ªç±»è·å–sqlSession,åœ¨applicationæ–‡ä»¶ä¸­æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶å°†sqlSessioné€šè¿‡setæ³¨å…¥è¿™ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentsMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">StudentsMapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SqlSessionTemplate sqlSession;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSqlSession</span><span class="params">(SqlSessionTemplate sqlSession)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Students&gt; <span class="title function_">getStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);</span><br><span class="line">        <span class="keyword">return</span> studentsMapper.getStudents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±å¯ä»¥è¿›è¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);<span class="comment">//Springé…ç½®æ–‡ä»¶</span></span><br><span class="line">        StudentsMapper studentsMapper=context.getBean(<span class="string">&quot;studentsMapper1&quot;</span>,StudentsMapper.class);<span class="comment">//æ¥å£ï¼Œè·å–å®ç°ç±»</span></span><br><span class="line">        List&lt;Students&gt; list=studentsMapper.getStudents();</span><br><span class="line">        <span class="keyword">for</span> (Students students : list) &#123;</span><br><span class="line">            System.out.println(students);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>æ–¹æ³•äºŒ<br>å‘æ¥å£çš„å®ç°ç±»æ³¨å…¥sqlSeeeionFectoryï¼Œè¯¥å®ç°ç±»éœ€ç»§æ‰¿SqlSessionDaoSupport</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentsMapperImpl2</span> <span class="keyword">extends</span> <span class="title class_">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title class_">StudentsMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Students&gt; <span class="title function_">getStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);<span class="comment">//æ­¤å¤„ä½¿ç”¨getSqlSession()</span></span><br><span class="line">        <span class="keyword">return</span> studentsMapper.getStudents();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥sqlSessionFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;studentsMapper2&quot;</span> class=<span class="string">&quot;com.liu.dao.StudentsMapperImpl2&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;sqlSessionFactory&quot;</span> ref=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
