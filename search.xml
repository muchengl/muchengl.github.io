<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>swe meme</title>
      <link href="/2025/04/06/swe-meme/"/>
      <url>/2025/04/06/swe-meme/</url>
      
        <content type="html"><![CDATA[<p>ğŸ”¥ ä¸Šå¤ç¨‹åºå‘˜/è®¡ç®—æœºç§‘å­¦å®¶ï¼šè‡ªåŠ¨å®šç†è¯æ˜å™¨ã€çº¸å¸¦ç¼–ç¨‹ã€æ‰‹æ“ç¨‹åºæŒ‡ä»¤çº§åˆ«å†…å­˜ç®¡ç†ã€æ‹œå åº­å°†å†›ã€å¤šå±‚æ„ŸçŸ¥æœºã€æ‰‹æ“ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ã€æ‰‹æ“OSã€è®¾è®¡æ–°ç®—æ³•</p><p>ğŸ¶ ç°åœ¨çš„ç¨‹åºå‘˜/è®¡ç®—æœºç§‘å­¦å®¶ï¼šnmæ€ä¹ˆè¿™ä¸ªåŒ…æ‰¾ä¸åˆ°ã€æŠŠè¿™ä¸ªå¼ é‡æ‹‰é•¿ä¸€ç‚¹èƒ½ä¸èƒ½æ¶¨ä¸€ä¸ªç‚¹ã€wc c++çœŸéš¾å•Šã€æ— æ³•ç†Ÿç»ƒä½¿ç”¨æ— GCè¯­è¨€ã€wcè¿™è™šæ‹Ÿæœºæ€ä¹ˆè¿ä¸ä¸Š</p><p>ğŸ­ æœªæ¥çš„ç¨‹åºå‘˜/è®¡ç®—æœºç§‘å­¦å®¶ï¼šwc ChatGPTæ€ä¹ˆè¿ä¸ä¸Šäº†ã€æ— æ³•ç†Ÿç»ƒæŒæ¡ä¸€åƒè¡Œä»£ç ä»¥ä¸Šçš„ä»£ç åº“ã€æ— æ³•åœ¨æ²¡æœ‰LLMçš„å¸®åŠ©ä¸‹å®Œæˆè¶…è¿‡äº”åè¡Œçš„ç¨‹åºã€æ— æ³•ç‹¬ç«‹é˜…è¯»æ–‡æ¡£ã€å¿…é¡»è®©LLMè§£é‡Š</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project07-File-System</title>
      <link href="/2024/05/03/CSCE611-OS-Project07-File-System/"/>
      <url>/2024/05/03/CSCE611-OS-Project07-File-System/</url>
      
        <content type="html"><![CDATA[<h3 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h3><p><strong>Introduction:</strong> The File System (FS) described here is a simple implementation designed to manage files on a disk. It provides basic functionality such as mounting a disk, formatting it, creating, deleting, and looking up files by their IDs.</p><p><strong>FileSystem Class:</strong> The <code>FileSystem</code> class is the central component of the file system implementation. It manages the disk, maintains the inode list, and keeps track of free blocks. Below are the details of its member functions:</p><ol><li><p><strong>Constructor (<code>FileSystem::FileSystem()</code>):</strong></p><ul><li>Initializes local data structures.</li><li>Does not connect to the disk yet.</li><li>Outputs a message indicating the construction of the file system.</li></ul></li><li><p><strong>Destructor (<code>FileSystem::~FileSystem()</code>):</strong></p><ul><li>Unmounts the file system if it has been mounted.</li><li>Ensures that the inode list and free block list are saved. Write inode list and free list to block0 and block1.</li></ul></li><li><p><strong>Mount (<code>FileSystem::Mount(SimpleDisk\* _disk)</code>):</strong></p><ul><li><p>Associates the file system with a disk.</p></li><li><p>Reads the inode list and the free block list into memory from the disk. In my file system, the first block is used to store inode list and second block is used for free list. In inode list, eack record contains two items, inode id and block id. Free is a bit map, â€˜â€™*â€ in free list meas that <code>used</code> and â€œ_â€ means that unused.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-05-03%20at%2014.12.13.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="750" align="bottom" /></li></ul></li><li><p><strong>Format (<code>FileSystem::Format(SimpleDisk\* _disk, unsigned int _size)</code>):</strong></p><ul><li>Formats the disk, wiping any existing file system.</li><li>Populates the disk with an empty file system of the given size.</li><li>Initializes the inode list and the free block list.</li></ul></li><li><p><strong>LookupFile (<code>FileSystem::LookupFile(int _file_id)</code>):</strong></p><ul><li>Finds a file with the given ID in the file system.</li><li>Traverses the inode list to locate the file.</li><li>Returns the inode of the file if found; otherwise, returns null.</li><li>Outputs a message indicating the file lookup process.</li></ul></li><li><p><strong>CreateFile (<code>FileSystem::CreateFile(int _file_id)</code>):</strong></p><ul><li>Creates a file with the given ID in the file system.</li><li>Checks if the file already exists; if so, aborts and returns false.</li><li>Allocates a free block for the file and initializes its inode.</li><li>Adds the inode to the inode list.</li><li>Outputs a message indicating the file creation process.</li></ul></li><li><p><strong>DeleteFile (<code>FileSystem::DeleteFile(int _file_id)</code>):</strong></p><ul><li>Deletes a file with the given ID from the file system.</li><li>Checks if the file exists; if not, returns an error.</li><li>Frees the blocks occupied by the file and removes its inode from the inode list.</li><li>Outputs a message indicating the file deletion process.</li></ul></li></ol><p><strong>Inode Class:</strong> The <code>Inode</code> class represents an index node in the file system. It contains information about a file, such as its ID and the block it occupies on the disk. Additional functions may be needed to read and store inodes from and to the disk.</p><h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><p><strong>Introduction:</strong> The <code>File</code> class represents a file handle in the file system implementation. It provides functionality for sequential read and write operations on a file. Each <code>File</code> object maintains a reference to its corresponding inode in the file system.</p><p><strong>File Class:</strong> Below are the details of the <code>File</code> class member functions:</p><ol><li><strong>Constructor (<code>File::File(FileSystem\* _fs, int _id)</code>):</strong><ul><li>Initializes the file handle with the provided file system reference (<code>_fs</code>) and file ID (<code>_id</code>).</li><li>Sets the current position to the beginning of the file.</li><li>Checks if the file exists in the file system by looking up its inode.</li><li>If the file does not exist, creates a new file with the provided ID.</li><li>Reads the fileâ€™s data block into the block cache for sequential read and write operations.</li></ul></li><li><strong>Destructor (<code>File::~File()</code>):</strong><ul><li>Closes the file.</li><li>Writes any cached data to the disk.</li></ul></li><li><strong>Read (<code>File::Read(unsigned int _n, char\* _buf)</code>):</strong><ul><li>Reads <code>_n</code> characters from the file starting at the current position.</li><li>Copies the read characters into the buffer <code>_buf</code>.</li><li>Returns the number of characters read.</li><li>Does not read beyond the end of the file.</li></ul></li><li><strong>Write (<code>File::Write(unsigned int _n, const char\* _buf)</code>):</strong><ul><li>Writes <code>_n</code> characters to the file starting at the current position.</li><li>If the write extends over the end of the file, extends the length of the file until all data is written or until the maximum file size is reached.</li><li>Returns the number of characters written.</li><li>Does not write beyond the maximum length of the file.</li></ul></li><li><strong>Reset (<code>File::Reset()</code>):</strong><ul><li>Sets the current position to the beginning of the file.</li><li>Allows subsequent read or write operations to start from the beginning of the file.</li></ul></li><li><strong>EoF (<code>File::EoF()</code>):</strong><ul><li>Checks if the current position for the file is at the end of the file.</li><li>Returns true if the current position is at the end of the file; otherwise, returns false.</li><li>Helps determine if there are more characters to read from the file.</li></ul></li></ol><h3 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h3><p><strong>Testing File System Functionality</strong></p><p>To ensure the proper functioning of the file system, the following steps are taken to test various operations:</p><ol><li><p><strong>File Creation:</strong></p><ul><li>Two files are created using the <code>CreateFile</code> function of the file system.</li><li>Assertions are used to verify that the files are successfully created.<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert</span>(_file_system-&gt;<span class="built_in">CreateFile</span>(<span class="number">1</span>));</span><br><span class="line"><span class="built_in">assert</span>(_file_system-&gt;<span class="built_in">CreateFile</span>(<span class="number">2</span>));</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>File Opening and Writing:</strong></p><ul><li>The two files are â€œopenedâ€ using the <code>File</code> constructor, which initializes file handles.</li><li>Data is written to each file using the <code>Write</code> function, with different content for each file.</li><li>Assertions are used to verify that the write operations are successful.<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> * STRING1 = <span class="string">&quot;01234567890123456789&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * STRING2 = <span class="string">&quot;abcdefghijabcdefghij&quot;</span>;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>File Closing:</strong></p><ul><li>The files are automatically closed when they go out of scope.</li></ul></li><li><p><strong>File Opening and Reading:</strong></p><ul><li>The files are â€œopenedâ€ again to simulate reopening.</li><li>Data is read from each file using the <code>Read</code> function.</li><li>Assertions are used to compare the read data with the expected content.</li></ul></li><li><p><strong>File Deletion:</strong></p><ul><li>Both files are deleted using the <code>DeleteFile</code> function.</li><li>Assertions are used to verify that the files are successfully deleted.</li></ul></li><li><p><strong>Comparison with Expected Results:</strong></p><ul><li>The actual results of file read operations are compared with the expected content.</li><li>If any discrepancies are found, assertions will fail, indicating a potential problem with file reading or writing.</li></ul></li></ol><h5 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br><span class="line">formatting disk</span><br><span class="line">Write Block: <span class="number">1</span><span class="comment"># init free list and inode list</span></span><br><span class="line">Write Block: <span class="number">2</span></span><br><span class="line">mounting file system <span class="keyword">from</span> disk</span><br><span class="line">Read Block: <span class="number">1</span> <span class="comment"># read free list and inode list</span></span><br><span class="line">Read Block: <span class="number">2</span></span><br><span class="line">creating file <span class="keyword">with</span> <span class="built_in">id</span>:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Created File Name: <span class="number">1</span></span><br><span class="line">Used File Block: <span class="number">3</span></span><br><span class="line"></span><br><span class="line">creating file <span class="keyword">with</span> <span class="built_in">id</span>:<span class="number">2</span></span><br><span class="line"></span><br><span class="line">Created File Name: <span class="number">2</span></span><br><span class="line">Used File Block: <span class="number">4</span></span><br><span class="line"></span><br><span class="line">Opening file.<span class="comment"># open file21</span></span><br><span class="line">looking up file <span class="keyword">with</span> <span class="built_in">id</span> = <span class="number">1</span></span><br><span class="line">Read Block: <span class="number">3</span></span><br><span class="line">Opening file. <span class="comment"># open file 2</span></span><br><span class="line">looking up file <span class="keyword">with</span> <span class="built_in">id</span> = <span class="number">2</span></span><br><span class="line">Read Block: <span class="number">4</span></span><br><span class="line">writing to file</span><br><span class="line">writing to file</span><br><span class="line">Closing file.</span><br><span class="line">Write Block: <span class="number">4</span></span><br><span class="line">Closing file.</span><br><span class="line">Write Block: <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Opening file.<span class="comment"># open file again</span></span><br><span class="line">looking up file <span class="keyword">with</span> <span class="built_in">id</span> = <span class="number">1</span></span><br><span class="line">Read Block: <span class="number">3</span></span><br><span class="line">Opening file.<span class="comment"># open file again</span></span><br><span class="line">looking up file <span class="keyword">with</span> <span class="built_in">id</span> = <span class="number">2</span></span><br><span class="line">Read Block: <span class="number">4</span></span><br><span class="line">resetting file</span><br><span class="line">reading <span class="keyword">from</span> file</span><br><span class="line">resetting file</span><br><span class="line">reading <span class="keyword">from</span> file</span><br><span class="line">Closing file.</span><br><span class="line">Write Block: <span class="number">4</span></span><br><span class="line">Closing file.</span><br><span class="line">Write Block: <span class="number">3</span></span><br><span class="line">deleting file <span class="keyword">with</span> <span class="built_in">id</span>:<span class="number">1</span> <span class="comment"># test passed </span></span><br><span class="line">File successfully deleted.</span><br><span class="line">deleting file <span class="keyword">with</span> <span class="built_in">id</span>:<span class="number">2</span><span class="comment"># test passed </span></span><br><span class="line">File successfully deleted.</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project05-Process</title>
      <link href="/2024/03/26/CSCE611-OS-Project05-Process/"/>
      <url>/2024/03/26/CSCE611-OS-Project05-Process/</url>
      
        <content type="html"><![CDATA[<p>Github Link: <a href="https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p><p>Files I modified: </p><p>1.<strong>Scheduler and RR Scheduler</strong>:</p><ul><li>Add rr_scheduler.C/H</li><li>kernel.C : support rr_scheudler</li><li>interrupt.C/H : enable interrupt</li><li>thread.C/H: enable interrupt</li><li>copykernel.sh: Modified to fit Mac OS</li></ul><p>3.<strong>Process</strong>:</p><ul><li>Add process.C/H</li><li>Add rr_scheduler.C/H</li><li>kernel.C</li><li>interrupt.C/H</li><li>thread.C/H</li><li>Add cont_frame_pool.C/H</li><li>Add vm_pool.C/H</li><li>Add page_table.C/H</li><li>copykernel.sh: Modified to fit Mac OS</li></ul><h3 id="1-FIFO-Scheduler"><a href="#1-FIFO-Scheduler" class="headerlink" title="1. FIFO Scheduler"></a>1. FIFO Scheduler</h3><p>In the <code>Scheduler</code>, implement a queue using <code>LinkedList</code> to store <code>Threads</code>. Each time <code>Resume</code> is called, insert the thread at the end of the queue. When <code>yield</code> is called, pop the first thread from the queue and switch to it using <code>Thread::dispatch_to(Thread * _thread)</code>.</p><p>Design of LinkedList: </p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.42.01.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="750" align="bottom" /><ol><li><code>resume (append)</code>: This indicates that when a new thread is created or when a suspended thread is to be resumed, it is appended to the end of the queue.</li><li><code>yield (pop)</code>: When function yield is called, scheduler will pop the first thread in ready queue and the use <code>Thread::dispatch_to</code> to start this thread.</li><li>Finally, <code>Thread::dispatch_to:</code> will use the low level <code>asm</code> code to set the current threadâ€™s stack to hardware to start the thread. </li></ol><p>To terminate a thread, two steps are involved: 1. releasing memory, and 2. removing the thread from the scheduler. To obtain the stack address of the current thread, I added a <code>Thread::Stack()</code> function.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">thread_shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MEMORY_POOL-&gt;<span class="built_in">release</span>((<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>) current_thread-&gt;<span class="built_in">Stack</span>());</span><br><span class="line">    SYSTEM_SCHEDULER-&gt;<span class="built_in">terminate</span>(current_thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TEST:</strong></p><p>Launch the kernel, the output of threads shows on UI:</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.51.27.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="650" align="bottom" /><p>We can observe that threads are executed sequentially.</p><h3 id="2-Enable-Interrupt-bonus-1"><a href="#2-Enable-Interrupt-bonus-1" class="headerlink" title="2.Enable Interrupt (bonus 1)"></a>2.Enable Interrupt (bonus 1)</h3><p>Within the <code>Thread</code> class, in the <code>Thread::thread_start</code> function, add <code>Machine::enable_interrupts();</code>.</p><p>In the scheduler, before <code>resume</code> and <code>yield</code>, call <code>Machine::disable_interrupts()</code> to prevent interrupts from occurring during a process switch. The worst-case scenario is when an interrupt occurs during an active process switch, causing the switch to terminate prematurely, and simultaneously triggering a process switch via <code>rr_schedule</code>, which would result in an erroneous switch.</p><p>The test for interrupt is in the RR Scheduler.</p><h3 id="3-Round-Robin-Scheduler-bonus-2"><a href="#3-Round-Robin-Scheduler-bonus-2" class="headerlink" title="3.Round-Robin Scheduler (bonus 2)"></a>3.Round-Robin Scheduler (bonus 2)</h3><p>To control the activation of the round-robin (RR) scheduler, a <code>scheduler_conf.H</code> file has been added. Additionally, an <code>eoq_timer</code> has been introduced, with its constructor taking an <code>RRScheduler</code>. Every 50ms, an interrupt is triggered, and <code>EOQTimer::handle_interrupt</code> calls the schedulerâ€™s <code>resume</code> and <code>yield</code> methods to implement thread preemption.</p><p>The implementation of <code>Interrupt</code> has been modified to add a function <code>InterruptHandler::send_end_of_interrupt(REGS * _r)</code>. In the scheduler, before switching to the next thread, <code>send_end_of_interrupt</code> is called to indicate the end of the current interrupt handling, ensuring that <code>Interrupt</code> can continue processing interrupts. Moreover, in <code>InterruptHandler::dispatch_interrupt</code>, <code>if(int_no!=0) send_end_of_interrupt(_r);</code> is added to indicate that the timer interrupt is handled by the scheduler, preventing the redundant sending of interrupt end signals.</p><p>**TEST: **</p><blockquote><p> In the top of kernel.c, use <code>#define _ENABLE_RR_SCHEDULER_</code> to switch to RR_Scheduler.</p></blockquote><p>According to the figure below, we can see that thread switching includes not only the switching of threads after the â€œBURST executionâ€, but also periodic preemption switching</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.25.09.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="750" align="bottom" /><h3 id="4-Processes-bonus-3"><a href="#4-Processes-bonus-3" class="headerlink" title="4.Processes (bonus 3)"></a>4.Processes (bonus 3)</h3><p>After a discussion with the professor. In my operating system project, I have implemented a <code>kernel process system</code> with the following features and details:</p><ul><li><p>Ported the memory pool from previous assignments (MP2 to MP4) to the new project (MP5).</p></li><li><p>Enabled virtual memory and implemented a <code>Process</code> class. During the initialization of a <code>Process</code>, two virtual memory pools are declared: <code>kernel_mem_pool</code> (3MB-4MB) for internal objects of the process (e.g., stack, which requires direct mapping) and <code>process_mem_pool</code> (4MB-256MB) for allocating memory to threads during runtime, providing them with new page tables and address spaces.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process::<span class="built_in">Process</span>(<span class="type">unsigned</span> <span class="type">long</span> address_space_size);</span><br></pre></td></tr></table></figure><p>Within the constructor, the process initially switches to the <code>kernel_page_table</code> and <code>kernel_obj_pool</code>. It then uses the <code>new</code> operator to allocate memory for the processâ€™s page table and virtual memory pools, setting up the necessary environment for process execution.</p></li><li><p>**Memory Management: ** </p><ul><li>Frame Pools: I used two frame pools: <code>kernel_frame_pool</code> and <code>process_frame_pool</code></li><li>I utilized three virtual memory (VM) pools: <code>kernel_obj_pool</code>, <code>kernel_vm_pool</code>, and <code>process_vm_pool</code>:<ol><li><strong><code>kernel_obj_pool</code></strong> (2MB - 3MB): This pool is reserved for kernel objects, such as the kernel page table. When the kernel needs to define a new object, like a new process, it switches to the <code>kernel_obj_pool</code> and uses the <code>new</code> operator to allocate memory for it.</li><li><strong><code>kernel_vm_pool</code></strong> (3MB - 4MB): This pool is used for the kernel stacks of threads. Each threadâ€™s kernel stack is allocated from this pool to ensure have a dedicated memory space.</li><li><strong><code>process_vm_pool</code></strong>(4MB - 256MB): This pool is used for the execution of processes. When a thread starts, the kernel sets <code>current_thread</code> to the threadâ€™s process VM pool, allowing the process to allocate objects within its own address space.</li></ol></li></ul><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.53.46.png" alt="Screenshot 2024-03-29 at 20.53.46"></p></li><li><p>Retained the <code>Thread</code> class, similar to the original design, containing an <code>esp</code> attribute to store the current processâ€™s stack address, code segment, etc. It includes <code>push</code> and <code>set_context</code> functions to establish the context of the process.<br>Additionally, due to threads belonging to different address spaces, a page table address for the current address space is added to the <code>Thread</code> class (passed in from the process).</p><p>The constructor and functions of the <code>Thread</code> class is designed as follows:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread::<span class="built_in">Thread</span>(Thread_Function _tf, <span class="type">char</span> * _stack, <span class="type">unsigned</span> <span class="type">int</span> _stack_size);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::set_process</span><span class="params">(Process * _process)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::set_pt</span><span class="params">(PageTable * pt)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p><strong>Thread Management:</strong> Added an <code>add_thread</code> function to the <code>Process</code> class, allowing the addition of a new thread to the process. This function first disables interrupts, then switch to page table of current process, and then allocates memory from the <code>kernel_vm_pool</code> for the stack. It creates a new <code>Thread</code> object, and adds it to the schedulerâ€™s queue (without implementing â€œThread level schedulingâ€).</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process::<span class="built_in">add_proces</span>(Thread_Function _tf, <span class="type">int</span> _stack_size)</span><br></pre></td></tr></table></figure></li><li><p>When the <code>RRScheduler</code> handles thread switching, it first compares the page table of the next thread with the current one. If they are different, the new page table is loaded into the register (pt-&gt;load()) and <code>current_pool</code> will be set to <code>process_vm_pool</code> of current process.. Since the first 4MB is directly mapped to the kernel pool, switching page tables does not affect system operation.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Console::<span class="built_in">puts</span>(<span class="string">&quot;Switch CURRENT_POOL \n&quot;</span>); </span><br><span class="line">CURRENT_POOL = current_thread-&gt;process-&gt;process_pool;</span><br><span class="line"></span><br><span class="line">PageTable * pt_ = current_thread-&gt;pt;</span><br><span class="line">pt_-&gt;<span class="built_in">load</span>();</span><br></pre></td></tr></table></figure></li><li><p>With this setup, multiple threads can be continuously added to a process, and these threads will share the same address space.</p></li></ul><p>**TEST: **</p><p>For testing, two processes are started: <code>process1</code> contains <code>Thread1</code> and <code>Thread3</code>, while <code>process2</code> contains <code>Thread2</code> and <code>Thread4</code>. </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2 processes and 4 threads</span></span><br><span class="line">process1.<span class="built_in">add_thread</span>(fun1, <span class="number">1024</span>);</span><br><span class="line">process2.<span class="built_in">add_thread</span>(fun2, <span class="number">1024</span>);</span><br><span class="line">process1.<span class="built_in">add_thread</span>(fun3, <span class="number">1024</span>);</span><br><span class="line">process2.<span class="built_in">add_thread</span>(fun4, <span class="number">1024</span>);</span><br></pre></td></tr></table></figure><p>In the test, each thread accumulates its ticks in the memory location at 32MB + ThreadID. The expected result is that the ticks for threads within the same process are visible to each other, while the other locations are 0. </p><blockquote><p>addr[1]                 addr[2]                 addr[3]                addr[4]</p><p>[thread1â€™s tick]   [thread2â€™s tick]   [thread3â€™s tick]   [thread4â€™s tick]</p></blockquote><p>The test code and output (which meets expectations) is as follows:</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> tick_addr = <span class="number">32</span> MB;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Console::<span class="built_in">puts</span>(<span class="string">&quot;Thread: &quot;</span>); Console::<span class="built_in">puti</span>(Thread::<span class="built_in">CurrentThread</span>()-&gt;<span class="built_in">ThreadId</span>()); Console::<span class="built_in">puts</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    Console::<span class="built_in">puts</span>(<span class="string">&quot;FUN 1 INVOKED!\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> id=<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> * addr = (<span class="type">unsigned</span> <span class="type">long</span> *)(tick_addr);</span><br><span class="line">    addr[id]=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// _TERMINATING_FUNCTIONS_</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">        Console::<span class="built_in">puts</span>(<span class="string">&quot;FUN 1 IN BURST[&quot;</span>); Console::<span class="built_in">puti</span>(j); Console::<span class="built_in">puts</span>(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Console::<span class="built_in">puts</span>(<span class="string">&quot;FUN 1: TICK [&quot;</span>); Console::<span class="built_in">puti</span>(i); Console::<span class="built_in">puts</span>(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// add tick to memory</span></span><br><span class="line">           <span class="type">unsigned</span> <span class="type">long</span> * addr = (<span class="type">unsigned</span> <span class="type">long</span> *)(tick_addr);</span><br><span class="line">            addr[id]+=id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">pass_on_CPU</span>(thread2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console::<span class="built_in">puts</span>(<span class="string">&quot;====== FUN 1 ======\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> * addr = (<span class="type">unsigned</span> <span class="type">long</span> *)(tick_addr);</span><br><span class="line">        Console::<span class="built_in">puts</span>(<span class="string">&quot;TICK in Idx &quot;</span>); </span><br><span class="line">        Console::<span class="built_in">puti</span>(i); </span><br><span class="line">        Console::<span class="built_in">puts</span>(<span class="string">&quot;, Num: &quot;</span>); </span><br><span class="line">        Console::<span class="built_in">puti</span>(addr[i]);</span><br><span class="line">        Console::<span class="built_in">puts</span>(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>Test Output:</strong></p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Thread 3 finished firstly. </span></span><br><span class="line"><span class="comment"># Got 92 ticks from Thread 1. (because thread 1 haven&#x27;t stop, so not 100)</span></span><br><span class="line"><span class="comment"># Get 300 ticks Thread 3(itself)</span></span><br><span class="line"><span class="comment"># Got 0 ticks from Thread 2 and Thread 4. (since Thread 2 and Thread 4 belong to the different address sapce)</span></span><br><span class="line">====== FUN <span class="number">3</span> ======</span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">1</span>, Num: <span class="number">92</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">2</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">3</span>, Num: <span class="number">300</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">4</span>, Num: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Thread 2 finished. </span></span><br><span class="line"><span class="comment"># Got 368 ticks from Thread 4. (because thread 4 haven&#x27;t stop, so not 400)</span></span><br><span class="line"><span class="comment"># Got 200 ticks from Thread 2. (itself) </span></span><br><span class="line"><span class="comment"># Got 0 ticks from Thread 2 and Thread 4.</span></span><br><span class="line">====== FUN <span class="number">2</span> ======</span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">1</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">2</span>, Num: <span class="number">200</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">3</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">4</span>, Num: <span class="number">368</span></span><br><span class="line"></span><br><span class="line">====== FUN <span class="number">4</span> ======</span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">1</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">2</span>, Num: <span class="number">200</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">3</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">4</span>, Num: <span class="number">400</span></span><br><span class="line"></span><br><span class="line">====== FUN <span class="number">1</span> ======</span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">1</span>, Num: <span class="number">100</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">2</span>, Num: <span class="number">0</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">3</span>, Num: <span class="number">300</span></span><br><span class="line">TICK <span class="keyword">in</span> Idx <span class="number">4</span>, Num: <span class="number">0</span></span><br></pre></td></tr></table></figure><p>So this test verified that Process1 and Process2 have different address Spaces. This test also verified the accuracy of Thread running (according to Tick number), thread switching and page table switching.</p><p>This proves that I have completed a basic kernel process.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project05-Thread</title>
      <link href="/2024/03/24/CSCE611-OS-Project05-Thread/"/>
      <url>/2024/03/24/CSCE611-OS-Project05-Thread/</url>
      
        <content type="html"><![CDATA[<p>1.FIFO</p><p>åœ¨Scheduleré‡Œå®ç°ä¸€ä¸ªé˜Ÿåˆ—LinkedListï¼Œå‚¨å­˜Threadsã€‚æ¯æ¬¡è°ƒç”¨Resumeï¼Œåˆ™å°†threadæ’å…¥é˜Ÿå°¾ã€‚è°ƒç”¨yieldï¼Œåˆ™popå‡ºç¬¬ä¸€ä¸ªthreadï¼Œå¹¶ä½¿ç”¨ Thread::dispatch_to(Thread * _thread) åˆ‡æ¢ã€‚</p><p>ä¸ºäº†å®ç°ç»ˆæ­¢threadï¼ŒåŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼Œ1.é‡Šæ”¾å†…å­˜ï¼Œ2.ä»scheduleråˆ é™¤threadã€‚ä¸ºäº†è·å¾—å½“å‰threadçš„stackåœ°å€ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªThread::Stack()å‡½æ•°ã€‚å¹¶ä¿®æ”¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">thread_shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* This function should be called when the thread returns from the thread function.</span></span><br><span class="line"><span class="comment">       It terminates the thread by releasing memory and any other resources held by the thread. </span></span><br><span class="line"><span class="comment">       This is a bit complicated because the thread termination interacts with the scheduler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Console::<span class="built_in">puts</span>(<span class="string">&quot;thread_shutdown\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    MEMORY_POOL-&gt;<span class="built_in">release</span>((<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>) current_thread-&gt;<span class="built_in">Stack</span>());</span><br><span class="line">    SYSTEM_SCHEDULER-&gt;<span class="built_in">terminate</span>(current_thread);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.Enable Interrupt</p><p>åœ¨Threadé‡Œï¼ŒThread::thread_startå‡½æ•°é‡Œï¼Œæ·»åŠ if(!Machine::interrupts_enabled()) Machine::enable_interrupts();</p><p>åœ¨scheduleré‡Œï¼Œresumeå’Œyieldå‰ï¼Œè°ƒç”¨Machine::disable_interrupts()ï¼Œä»è€Œé¿å…è¿›è¡Œè¿›ç¨‹åˆ‡æ¢æ—¶å‘ç”Ÿä¸­æ–­ã€‚ï¼ˆæœ€åçš„æƒ…å†µæ—¶ï¼Œè¿›ç¨‹ä¸»åŠ¨åˆ‡æ¢æ—¶å‘ç”Ÿä¸­æ–­ï¼Œåˆ‡æ¢ç»ˆæ­¢ï¼ŒåŒæ—¶è§¦å‘rr_scheduleçš„è¿›ç¨‹åˆ‡æ¢ï¼Œæ­¤æ˜¯ä¼šäº§ç”Ÿé”™è¯¯çš„åˆ‡æ¢ï¼‰</p><p>3.RR scheduler</p><ul><li>ä¸ºäº†æ§åˆ¶æ˜¯å¦å¯ç”¨rr schedulerï¼Œæ·»åŠ äº†ä¸€ä¸ªscheduler_conf.H</li><li>æ·»åŠ eoq_timerï¼Œæ„é€ å‡½æ•°ä¼ å…¥RRSchedulerã€‚æ¯éš”50msï¼Œè§¦å‘ä¸­æ–­ï¼ŒEOQTimer::handle_interruptè°ƒç”¨schedulerçš„resumeå’Œyield</li><li>ä¿®æ”¹Interruptå®ç°ï¼Œå¢åŠ å‡½æ•°InterruptHandler::send_end_of_interrupt(REGS * <em>r)ã€‚åœ¨scheduleré‡Œï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªthreadå‰ï¼Œè°ƒç”¨send_end_of_interruptï¼Œè¡¨æ˜å½“å‰ä¸­æ–­å¤„ç†ç»“æŸï¼Œä»è€Œä¿è¯Interruptå¯ä»¥ç»§ç»­å¤„ç†ä¸­æ–­ã€‚</em><br>_åŒæ—¶åœ¨InterruptHandler::dispatch_interruptæ·»åŠ  if(int_no!=0) send_end_of_interrupt(_r);ï¼Œè¡¨æ˜æ—¶é—´ä¸­æ–­ï¼Œç”±timerå‘é€ç»“æŸä¿¡å·ï¼Œé¿å…é‡å¤å‘é€ä¸­æ–­ç»“æŸçš„ä¿¡æ¯ã€‚</li><li>ç¼ºç‚¹ï¼Œschedulerä¸çº¿ç¨‹å®‰å…¨ï¼ŒInterruptåˆ‡æ¢å’Œthreadæœ¬èº«çš„åˆ‡æ¢ï¼Œå¯èƒ½å†²çªï¼Œå¯¼è‡´é˜Ÿåˆ—é‡Œçš„å†…å®¹ä¸æ­£ç¡®ã€‚ç»æµ‹è¯•ï¼Œå•ç‹¬å¯ç”¨RRSchedulerï¼Œç¦ç”¨threadæœ¬èº«åˆ‡æ¢ï¼Œå¯ä»¥å‡†ç¡®å®ç°æ¯éš”50msåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªthreadã€‚</li></ul><ul><li></li></ul><p>4.Processes</p><ul><li><p>å°†ä¹‹å‰ä¸‰ä¸ªMPçš„Poolï¼Œç§»æ¤åˆ°MP5</p></li><li><p>å¯ç”¨è™šæ‹Ÿå†…å­˜ã€‚å®ç°Processç±»ã€‚åœ¨åˆå§‹åŒ–Processæ—¶ï¼Œä¸ºå…¶å£°æ˜ä¸¤ä¸ªvm_poolï¼Œkernel_mem_poolï¼ˆ3MB-4MBï¼‰ å’Œ process_mempoolï¼ˆ4MB-256MBï¼‰ã€‚kernel_mem_poolç”¨äºprocessçš„å†…éƒ¨å¯¹è±¡å£°æ˜ï¼ˆä¾‹å¦‚Stackï¼Œéœ€è¦ç›´æ¥æ˜ å°„ï¼‰ï¼Œprocess_mem_poolåœ¨çº¿ç¨‹è¿è¡Œæ—¶ç”¨äºç»™çº¿ç¨‹åˆ†é…å†…å­˜ï¼ˆå› æ­¤å…·æœ‰æ–°çš„é¡µè¡¨ï¼Œåœ°å€ç©ºé—´ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process::Process(VMPool * vm_pool);</span><br></pre></td></tr></table></figure></li><li><p>ä¿ç•™Threadï¼Œè¯¥Threadç±»ä¼¼åŸæœ‰çš„Threadçš„è®¾è®¡ã€‚å…¶ä¸­åŒ…å«espç”¨äºå‚¨å­˜å½“å‰precessçš„stackåœ°å€ï¼Œä»£ç æ®µç­‰ã€‚åŒ…å«pushå’Œset_contextå‡½æ•°ï¼Œä»¥å®Œæˆè¯¥processçš„contextå£°æ˜ã€‚<br>æ­¤å¤–ï¼Œç”±äºæ­¤æ—¶Threadä¹‹é—´å±äºä¸åŒçš„åœ°å€ç©ºé—´ï¼Œå› æ­¤éœ€è¦åœ¨Threadé‡ŒåŠ å…¥å½“å‰åœ°å€ç©ºé—´çš„é¡µè¡¨åœ°å€ï¼ˆä¼ å…¥processï¼‰</p><p>è¯¥ç±»çš„æ„é€ å‡½æ•°è®¾è®¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size, Process * process);</span><br></pre></td></tr></table></figure></li><li><p>ä¸ºProcessæ·»åŠ ä¸€ä¸ªadd_threadå‡½æ•°ï¼Œç”¨äºå‘Processå¢åŠ ä¸€ä¸ªçº¿ç¨‹ã€‚æ­¤å‡½æ•°é¦–å…ˆä¼šåœæ­¢ä¸­æ–­ï¼Œç„¶åä»kernel_vm_poolç”³è¯·ä¸€å—å†…å­˜ï¼Œç”¨ä½œstackã€‚ç„¶åå»ºç«‹ä¸€ä¸ªæ–°çš„Threadå¯¹è±¡ï¼Œåœ¨æœ¬åœ°çš„é˜Ÿåˆ—å­˜å‚¨è¯¥Threadï¼ŒåŒæ—¶å¹¶å°†æ”¹Threadå¯¹è±¡addå…¥schedulerçš„queueé‡Œï¼ˆä¸è®¾è®¡â€œThread levelè°ƒåº¦â€ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process::add_proces(Thread_Function _tf,int _stack_size)</span><br></pre></td></tr></table></figure></li><li><p>å½“Schedulerå¤„ç†Threadåˆ‡æ¢æ—¶ï¼Œé¦–å…ˆæ¯”è¾ƒä¸‹ä¸€ä¸ªThreadçš„page tableä¸å½“å‰æ˜¯å¦ç›¸åŒï¼Œä¸åŒçš„è¯åˆ™å°†æ–°çš„page table loadåˆ°å¯„å­˜å™¨ã€‚ç”±äºå‰4MBæ˜¯ç›´æ¥æ˜ å°„åˆ°kernel poolï¼Œå› æ­¤åˆ‡æ¢é¡µè¡¨ä¸ä¼šå½±å“ç³»ç»Ÿè¿è¡Œã€‚</p></li></ul><ul><li><p>è¿™æ ·ä»¥æ¥ï¼Œå°±å¯ä»¥å‘ä¸€ä¸ªProcessé‡Œä¸æ–­æ·»åŠ æ–°çš„Threadï¼Œå¹¶ä¸”è¿™äº›Threadå…·æœ‰ç›¸åŒçš„åœ°å€ç©ºé—´</p></li><li><p>æµ‹è¯•ï¼Œå¯åŠ¨ä¸¤ä¸ªProcessï¼Œprocess1åŒ…å«Thread1å’Œ2ï¼ŒProcess2åŒ…å«Thread2å’Œ4ã€‚Threadä¼šå‘åœ°å€ä¸º32MB+ThreadIDçš„ä½ç½®ç´¯åŠ æœ¬çº¿ç¨‹çš„Tickã€‚æœ€ç»ˆæ‰“å°å››ä¸ªä½ç½®çš„Tickã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> tick_addr = <span class="number">32</span> MB;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> id=<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> * addr = (<span class="type">unsigned</span> <span class="type">long</span> *)(tick_addr);</span><br><span class="line">    </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> * addr = (<span class="type">unsigned</span> <span class="type">long</span> *)(tick_addr);</span><br><span class="line">addr[id]+=id;</span><br></pre></td></tr></table></figure><p>ç»“æ„åº”è¯¥æ˜¯ï¼Œprocess1ä¸‹çš„ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„tickç›¸äº’å¯è§ï¼Œå¦å¤–ä¸¤ä¸ªtickçš„ä½ç½®æ˜¯0ã€‚åä¹‹åŒç†ã€‚æµ‹è¯•ç»“æœï¼ˆç¬¦åˆé¢„æœŸï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">====== FUN 3 ======</span><br><span class="line">TICK in Idx 1, Num: 92]</span><br><span class="line">TICK in Idx 2, Num: 0]</span><br><span class="line">TICK in Idx 3, Num: 300]</span><br><span class="line">TICK in Idx 4, Num: 0]</span><br><span class="line"></span><br><span class="line">====== FUN 2 ======</span><br><span class="line">TICK in Idx 1, Num: 0]</span><br><span class="line">TICK in Idx 2, Num: 200]</span><br><span class="line">TICK in Idx 3, Num: 0]</span><br><span class="line">TICK in Idx 4, Num: 368]</span><br><span class="line"></span><br><span class="line">====== FUN 4 ======</span><br><span class="line">TICK in Idx 1, Num: 0]</span><br><span class="line">TICK in Idx 2, Num: 200]</span><br><span class="line">TICK in Idx 3, Num: 0]</span><br><span class="line">TICK in Idx 4, Num: 400]</span><br><span class="line"></span><br><span class="line">====== FUN 1 ======</span><br><span class="line">TICK in Idx 1, Num: 100]</span><br><span class="line">TICK in Idx 2, Num: 0]</span><br><span class="line">TICK in Idx 3, Num: 300]</span><br><span class="line">TICK in Idx 4, Num: 0]</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project04-Memory</title>
      <link href="/2024/03/18/CSCE611-OS-Project04-Memory/"/>
      <url>/2024/03/18/CSCE611-OS-Project04-Memory/</url>
      
        <content type="html"><![CDATA[<p>Github Link: <a href="https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p><p>Files I modified: </p><ul><li>page table.H/C</li><li>vm_pool.H/C</li><li>copykernel.sh<ul><li>Modified to fit Mac OS</li></ul></li></ul><h3 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h3><h4 id="1-Page-Table"><a href="#1-Page-Table" class="headerlink" title="1. Page Table"></a>1. Page Table</h4><p><strong>i. Extension of page table manager</strong></p><p>For <em>register_pool()</em>, I used a linkedlist to store all VMPools in PageTable. In PageTable, I added a new variable:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm pools</span></span><br><span class="line"><span class="type">static</span> VMPool * pool_link_head;</span><br></pre></td></tr></table></figure><p>This is the head of all vm_pools. In VMPool, there is a new variable <em>next_pool</em> which point to the next pool. By doing this, I realized the register_pool by adding the pool to the end of the linkedlist in VMPoolâ€™s constructor.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PageTable::register_pool</span><span class="params">(VMPool * _vm_pool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   VMPool * node=pool_link_head;</span><br><span class="line">   <span class="keyword">if</span>(node == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">      pool_link_head = _vm_pool;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">while</span>(node-&gt;next_pool != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">         node=node-&gt;next_pool;</span><br><span class="line">      &#125;</span><br><span class="line">      node-&gt;next_pool = _vm_pool;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> For <em>free_page()</em>, first calculate the address of the page according to the page_no. Then, based on this address, find the corresponding page table. Set the corresponding pte value to 0. Then release the corresponding frame in the frame pool. Thus realize the release of memory.</p><p><strong>ii. Recursive page table lookup</strong></p><p>This is the menory structure:</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="350" align="bottom" /><p>process page faluts: </p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><p>Firstly, get fault virtual memory address from cr2â€</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> faulting_address = <span class="built_in">read_cr2</span>();</span><br></pre></td></tr></table></figure><p>Before fault handle, function need to check whether the address belong to a registed VMPool.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check address in vm pool</span></span><br><span class="line"> <span class="type">bool</span> flag=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"> VMPool * node = pool_link_head;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no vm pool, so not make checking</span></span><br><span class="line"> <span class="keyword">if</span>(node == <span class="literal">nullptr</span>) flag =<span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span>(node != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">   <span class="comment">// first two pages, used to store memory usage information</span></span><br><span class="line">    <span class="keyword">if</span>(faulting_address &gt;= node-&gt;base_address &amp;&amp; faulting_address &lt;= (node-&gt;base_address+PAGE_SIZE*<span class="number">2</span>) )&#123;</span><br><span class="line">       flag=<span class="literal">true</span>;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// is_legitimate ?</span></span><br><span class="line">    flag = flag || node-&gt;<span class="built_in">is_legitimate</span>(faulting_address);</span><br><span class="line"></span><br><span class="line">    node=node-&gt;next_pool;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>If address is legitimate, get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pd_index = faulting_address &gt;&gt; <span class="number">22</span>; <span class="comment">// index in page dir</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pt_index = (faulting_address &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b1111111111</span>; <span class="comment">// index in page table</span></span><br></pre></td></tr></table></figure><p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(pd[pd_index] &amp; <span class="number">1</span>)) &#123;</span><br><span class="line"><span class="comment">// page table not exist</span></span><br><span class="line">  <span class="comment">// apply a new frame from kernel pool</span></span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the end, we apply a new frame from process pool and add it to page table.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> new_frame = process_mem_pool-&gt;<span class="built_in">get_frames</span>(<span class="number">1</span>);</span><br><span class="line">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class="number">3</span>;</span><br></pre></td></tr></table></figure><h4 id="2-VM-Pool"><a href="#2-VM-Pool" class="headerlink" title="2.VM Pool"></a>2.VM Pool</h4><p>The <code>VMPool</code> class is responsible for managing a virtual memory pool, which includes allocating and releasing memory regions as well as checking the legitimacy of addresses. Hereâ€™s a detailed breakdown of each function in the class:</p><ol><li><p><strong>Constructor <code>VMPool</code></strong>: Initializes a virtual memory pool with a given base address, size, frame pool, and page table. It registers the pool with the page table and sets up the data structures for tracking used and free memory regions.</p></li><li><p><strong><code>allocate(unsigned long _size)</code></strong>: The <code>allocate</code> method in the <code>VMPool</code> class is responsible for allocating a region of memory from the virtual memory pool. It uses two arrays (first to frames in frame_pool), <code>used_memory_info</code> and <code>free_memory_info</code>, to track the memory usage. Each entry in these arrays consists of a pair of values, representing the start and end addresses of a memory region. This is structure of <code>used_memory_info</code>:</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2019.41.59.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /></li></ol><ol><li><p><strong><code>release(unsigned long _start_address)</code></strong>: Releases a region of previously allocated memory identified by its start address. It removes the region from the used memory info, adds it back to the free memory info, and releases the corresponding pages in the page table.</p></li><li><p><strong><code>is_legitimate(unsigned long _address)</code></strong>: Checks whether a given address is part of a currently allocated region. It returns <code>true</code> if the address is within the range of an allocated block and <code>false</code> otherwise.</p></li></ol><p>Additionally, the class has private member variables for storing the size of the pool, pointers to the frame pool and page table, and arrays for tracking used and free memory regions. It also defines a constant <code>PAGE_SIZE</code> for the page size and has a public member variable <code>base_address</code> for the base address of the pool.</p><h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing:"></a><strong>Testing</strong>:</h3><p><strong><em>TEST_PAGE_TABLE</em> (Passed)</strong> :</p><p>This test is designed to evaluate the implementation of page tables by accessing and writing to unmapped virtual memory. It determines the correctness of the page table implementation by verifying whether data can be accurately written to and read from virtual addresses.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FAULT_ADDR (4 * 1024 * 1024) <span class="comment">// 4 MB, Address used to cause page faults in the test.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NACCESS ((1 MB) / 4) <span class="comment">// (1 MB) / 4, Number of integer accesses (4 bytes each) starting from FAULT_ADDR.</span></span></span><br></pre></td></tr></table></figure><p>I also extended this test from â€œ(1 MB) / 4â€ to â€œ(27 MB) / 4â€. This is because the physics address space it 32MB. The first 4MB is direct mapped and 15-16MB is the memory hole. So, there is total 27MB can be mapped. For â€œ(27 MB) / 4â€, my code can pass the test too.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.56.06.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><p><strong><em>TEST_VM_POOL</em> (Passed)</strong> :</p><p>This test involves memory allocation and release operations. It tests the ability to correctly handle memory allocation and release requests, ensuring that memory is properly allocated when requested and correctly freed when no longer needed. </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *arr = <span class="keyword">new</span> <span class="type">int</span>[size2 * i]; <span class="comment">// allocate</span></span><br><span class="line"><span class="keyword">delete</span>[] arr; <span class="comment">// release</span></span><br></pre></td></tr></table></figure><p>My code prints out the IDs of the allocated memory frames and the frames released during the release process. Upon inspection, my vm_pool can correctly allocate and release frames.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.54.45.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" />]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project03</title>
      <link href="/2024/02/23/CSCE611-OS-Project03/"/>
      <url>/2024/02/23/CSCE611-OS-Project03/</url>
      
        <content type="html"><![CDATA[<p>Github Link: <a href="https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p><p>Files I modified: </p><ul><li>cont_frame_pool.H/C</li><li>page table.H/C</li><li>copykernel.sh<ul><li>Modified to fit Mac OS</li></ul></li></ul><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2021.44.43.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="200" align="bottom" /><p><strong>Step 1</strong> Init memory pools:<br>We have two pools : kernel pool and process pool. Kernel pool is used for store infomations from kernel like page table. Process pool is to allocate memory to processes. When a page fault is triggered, the page fault handle will get a frame from process pool and map it from the address that fault happened.</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png" alt="mp2-frame-memory.drawio (1)"></p><p><strong>Step 2</strong> add page fault handle</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PageFault_Handler</span> : <span class="keyword">public</span> ExceptionHandler &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">handle_exception</span><span class="params">(REGS * _regs)</span> </span>&#123;</span><br><span class="line">          PageTable::<span class="built_in">handle_fault</span>(_regs);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; pagefault_handler;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  ExceptionHandler::<span class="built_in">register_handler</span>(<span class="number">14</span>, &amp;pagefault_handler);</span><br></pre></td></tr></table></figure><p>In this code, we add a handle for fault 14, which is page fault. The page fault will be processed by the static function PageTable::handle_fault().</p><p><strong>Step 3</strong> Init paging</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageTable::<span class="built_in">init_paging</span>(&amp;kernel_mem_pool,</span><br><span class="line">                         &amp;process_mem_pool,</span><br><span class="line">                         <span class="number">4</span> MB); <span class="comment">/* We share the first 4MB */</span></span><br><span class="line">  </span><br><span class="line">  PageTable pt;</span><br><span class="line">  </span><br><span class="line">  pt.<span class="built_in">load</span>();</span><br></pre></td></tr></table></figure><p>In this code, we first init the PageTableâ€™s static variables by pass two memory pools to it (init_paging). In init_paging, we, first apply one frame from kernel pool for page directory. Than, we map the first 4MB of memory to it physical address(use another frame as the first page table). This can help us able to access kernel poolâ€™s frames directly.</p><p>This is the menory structure:</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="400" align="bottom" /><p>After that, we use <em>pt.load</em> to anable paging:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PageTable::load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// before we set the paging bit to 1, we must put the address of the page directory into CR3.</span></span><br><span class="line">   current_page_table = <span class="keyword">this</span>;</span><br><span class="line">   <span class="built_in">write_cr3</span>((<span class="type">unsigned</span> <span class="type">long</span>) page_directory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PageTable::enable_paging</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">   paging_enabled = <span class="number">1</span>;</span><br><span class="line">   <span class="comment">//  the paging bit of CR0(bit 31) when set to 1 enables paging</span></span><br><span class="line">   <span class="built_in">write_cr0</span>(<span class="built_in">read_cr0</span>() | <span class="number">0x80000000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Step 4</strong> process page faluts</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><p>Firstly, get fault virtual memory address from cr2â€</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> faulting_address = <span class="built_in">read_cr2</span>();</span><br></pre></td></tr></table></figure><p>Get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pd_index = faulting_address &gt;&gt; <span class="number">22</span>; <span class="comment">// index in page dir</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pt_index = (faulting_address &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b1111111111</span>; <span class="comment">// index in page table</span></span><br></pre></td></tr></table></figure><p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(pd[pd_index] &amp; <span class="number">1</span>)) &#123;</span><br><span class="line"><span class="comment">// page table not exist</span></span><br><span class="line">  <span class="comment">// apply a new frame from kernel pool</span></span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the end, we apply a new frame from process pool and add it to page table.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> new_frame = process_mem_pool-&gt;<span class="built_in">get_frames</span>(<span class="number">1</span>);</span><br><span class="line">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p><strong>Result</strong>:</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.22.42.png" alt="Screenshot 2024-02-23 at 22.22.42"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611-OS-Project02-Frame Manager</title>
      <link href="/2024/02/10/CSCE611-OS-Project02-Frame-Manager/"/>
      <url>/2024/02/10/CSCE611-OS-Project02-Frame-Manager/</url>
      
        <content type="html"><![CDATA[<h1 id="CSCE611-OS-MP02-Frame-Manager"><a href="#CSCE611-OS-MP02-Frame-Manager" class="headerlink" title="CSCE611-OS-MP02-Frame-Manager"></a>CSCE611-OS-MP02-Frame-Manager</h1><p>Github Link: <a href="https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p><p>Files I modified: </p><ul><li>cont_frame_pool.H</li><li>cont_frame_pool.C</li><li>copykernel.sh<ul><li>Modified to fit Mac OS</li></ul></li><li>makefile<ul><li>Add a new item <code>make run</code> to make it easier to start the kernel<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">run: copy start_vm</span></span><br><span class="line"><span class="section">copy: </span></span><br><span class="line">./copykernel.sh</span><br><span class="line"><span class="section">start_vm:</span></span><br><span class="line">bochs -f bochsrc.bxrc</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="Memory-Structure"><a href="#Memory-Structure" class="headerlink" title="Memory Structure"></a>Memory Structure</h3><p><strong>Design of memory pools:</strong></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png" alt="mp2-frame-memory.drawio (1)"></p><p><strong>Design of the bitmap:</strong><br>I used two bits to store the status of a frame. The first bit indicates whether the frame is used and the second bit indicates whether the frame is the head of a frame sequence. So, we have the follows:</p><ul><li><code>[0,x]</code> : Not Used (<code>x</code> is 0 or 1)</li><li><code>[1,1]</code> : Used and this frame is the head of a sequence</li><li><code>[1,0]</code> : Used and this frame is not the head of a sequence</li></ul><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-bitmap.drawio.png" alt="mp2-frame-bitmap.drawio"></p><h3 id="Get-Frames"><a href="#Get-Frames" class="headerlink" title="Get Frames"></a>Get Frames</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">ContFramePool::get_frames</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> _n_frames)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>The function first determines if there are enough frames to allocate, then iterates through the bitmap, looking for appropriate frames, and returns the frameâ€™s id.</li></ul><h3 id="Release-Frames"><a href="#Release-Frames" class="headerlink" title="Release Frames"></a>Release Frames</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">release_frames_internel</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> _first_frame_no)</span></span>;</span><br><span class="line"></span><br><span class="line">ContFramePool*        next_pool;  <span class="comment">// next pool</span></span><br><span class="line"><span class="type">static</span> ContFramePool* pools_head; <span class="comment">// head point of all polls</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">release_frames</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> _first_frame_no)</span></span>;</span><br></pre></td></tr></table></figure><ul><li><strong><code>release_frames_internel</code></strong>: An internal function to release frames starting from a given frame number within a specific pool.</li><li><strong><code>next_pool</code></strong>: A pointer to the next memory frame pool, enabling a linked list structure for pool management.</li><li><strong><code>pools_head</code></strong>: A static pointer that serves as the head of the list of all memory frame pools.</li><li><strong><code>release_frames</code></strong>: A static function that releases frames by locating the correct pool using the frameâ€™s ID and then invoking <code>release_frames_internel</code> for that pool.</li></ul><p><strong>Release process:</strong></p><ul><li>release_frames is a static function which has only one parameter <code>_first_frame_no</code></li><li>release_frames first determines which pool the frame belongs to, and then use <code>global_kernel_memory_pool</code> and <code>global_process_memory_pool </code> to releases it.</li><li>Since one sequence of frames needs to be released, the release process constantly determines whether a new head (Frame with <code>Used_Head</code> tag in bitmap) has been encountered. If so, the release_frames_internel will finish the release process and return.</li></ul><h3 id="Output-Test"><a href="#Output-Test" class="headerlink" title="Output/Test"></a>Output/Test</h3><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-10%20at%2016.26.52.png" alt="Screenshot 2024-02-10 at 16.26.52"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611 OS Project01 Note</title>
      <link href="/2024/01/25/CSCE611-OS-Projest01-Note/"/>
      <url>/2024/01/25/CSCE611-OS-Projest01-Note/</url>
      
        <content type="html"><![CDATA[<p>In this document, I describe the steps I took to add gdb debug support to the kernel in MacBook M2.</p><h2 id="1-Environment-preparation"><a href="#1-Environment-preparation" class="headerlink" title="1) Environment preparation"></a>1) Environment preparation</h2><p>Set up Bochs with  GDB support on MacBook M2:</p><p><strong>Step01</strong>, download source code from bochsâ€™s GitHub releases: <a href="https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL">https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL</a></p><p><strong>Step02</strong>, set the configure to enable GDB stub:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> [Bochs<span class="string">&#x27; dir]</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">./configure --enable-ne2000 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-all-optimizations \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-cpu-level=6 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-x86-64 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-vmx=2 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-pci \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-usb \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-usb-ohci \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-e1000 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-disasm \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --disable-debugger-gui \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --with-sdl \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --prefix=$HOME/opt/bochs \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">            --enable-gdb-stub  # important, --enable-debugger is not work</span></span></span><br></pre></td></tr></table></figure><p><strong>Step03</strong>, prepare and make Bochs:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install sdl</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure><p><strong>Step04</strong>, install GDB:</p><p>Now, no native gdb is supposed in MacBook M2. So I installed another one : i386-elf-gdb</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install i386-elf-gdb</span></span><br></pre></td></tr></table></figure><h2 id="2-Add-debug-support-to-the-kernel"><a href="#2-Add-debug-support-to-the-kernel" class="headerlink" title="2) Add debug support to the kernel"></a>2) Add debug support to the kernel</h2><p><strong>Step05</strong>, modify MPâ€™s makefile:</p><p>Add <em>-g</em> flag in makefile:</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">AS=nasm</span><br><span class="line"></span><br><span class="line">GCC=/opt/homebrew/Cellar/x86_64-elf-gcc/13.2.0/bin/x86_64-elf-gcc</span><br><span class="line">LD=/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld</span><br><span class="line"></span><br><span class="line">GCC_OPTIONS = -m32 -nostdlib -fno-builtin -nostartfiles -nodefaultlibs -fno-exceptions -fno-rtti -fno-stack-protector -fleading-underscore -fno-asynchronous-unwind-tables</span><br><span class="line"></span><br><span class="line"><span class="section">all: kernel.bin</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.o *.bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== KERNEL ENTRY POINT ====</span></span><br><span class="line"><span class="section">start.o: start.asm</span></span><br><span class="line"><span class="variable">$(AS)</span> -f elf -o start.o start.asm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== UTILITIES ====</span></span><br><span class="line"><span class="section">utils.o: utils.H utils.C</span></span><br><span class="line"><span class="variable">$(GCC)</span> <span class="variable">$(GCC_OPTIONS)</span> -g -c -o utils.o utils.C</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== DEVICES ====</span></span><br><span class="line"><span class="section">console.o: console.H console.C</span></span><br><span class="line"><span class="variable">$(GCC)</span> <span class="variable">$(GCC_OPTIONS)</span> -g -c -o console.o console.C</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== KERNEL MAIN FILE ====</span></span><br><span class="line"><span class="section">kernel.o: kernel.C</span></span><br><span class="line"><span class="variable">$(GCC)</span> <span class="variable">$(GCC_OPTIONS)</span> -g -c -o kernel.o kernel.C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">kernel.bin: start.o kernel.o console.o utils.o linker.ld</span></span><br><span class="line"><span class="variable">$(LD)</span> -melf_i386 -T linker.ld -o kernel.bin start.o kernel.o console.o utils.o</span><br></pre></td></tr></table></figure><p>Modify linker.ld, delete the first line <em>OUTPUT_FOTMAT(â€˜binaryâ€™)</em>.</p><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><p><strong>Step06</strong>, start Bochs:</p><p>I did not install bochs. So I use the path to call its runnable file directly</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/Users/lhz/bochs/bochs -f bochsrc.bxrc</span></span><br></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/start.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><p><strong>Step07</strong>, start GDB and connect to Bochs:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">i386-elf-gdb kernel.bin <span class="comment"># start GDB</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">set</span> architecture i386:x86-64:intel</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">target remote localhost:1234 <span class="comment"># connect to bochs</span></span></span><br></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/connect.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><p><strong>Step08</strong>, set breakpoint and debug in kernel:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ b main() <span class="comment"># set breakpoint</span></span><br><span class="line">$ <span class="built_in">continue</span> <span class="comment"># stop at main(), the breakpoint</span></span><br><span class="line">$ <span class="built_in">continue</span> <span class="comment"># enter main(), start console</span></span><br></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/running.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" />]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSCE611 OS Env Prepare (Macbook M-chip)</title>
      <link href="/2024/01/23/CSCE611-MP1/"/>
      <url>/2024/01/23/CSCE611-MP1/</url>
      
        <content type="html"><![CDATA[<p>This assumes that you have at the very least set up developer tools and <a href="https://brew.sh/">Homebrew</a> on your machine.</p><h2 id="Step01-GCC-Install"><a href="#Step01-GCC-Install" class="headerlink" title="Step01, GCC Install"></a>Step01, GCC Install</h2><p>In the class, we need to build a unix-like kernel in X86 arch. Because MacBook with M2 chip is arm arch. So, we canâ€™t use the original gcc in homebrew. Fortunate, there is a <strong>x86_64-elf-gcc</strong> in home-brew repo:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ brew search gcc</span><br><span class="line">==&gt; Formulae</span><br><span class="line">aarch64-elf-gcc âœ”                                            libgccjit</span><br><span class="line">arm-none-eabi-gcc                                            nativeos/i386-elf-toolchain/i386-elf-gcc</span><br><span class="line">gcc                                                          nativeos/i386-elf-toolchain/i386-elf-gcc@11.1</span><br><span class="line">gcc@10                                                       nativeos/i386-elf-toolchain/i386-elf-gcc@11.2</span><br><span class="line">gcc@11 âœ”                                                     riscv64-elf-gcc</span><br><span class="line">gcc@12 âœ”                                                     x86_64-elf-gcc âœ”</span><br><span class="line">gcc@5                                                        ghc</span><br><span class="line">gcc@6                                                        grc</span><br><span class="line">gcc@7                                                        scc</span><br><span class="line">gcc@8                                                        tcc</span><br><span class="line">gcc@9                                                        ncc</span><br><span class="line">i686-elf-gcc</span><br></pre></td></tr></table></figure><p>Use <strong>brew search gcc</strong> in terminal, you can find â€œx86_64-elf-gccâ€. So, use â€œbrew install x86_64-elf-gccâ€ to install it. Now, you can use â€œaarch64-elf-gccâ€ to compail the kernel.</p><p>All tool intalled by gcc will be store in this path: <strong>/opt/homebrew/Cellar/</strong>. So you should heve this â€œ/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ldâ€.</p><h2 id="Step2-Tools-Install"><a href="#Step2-Tools-Install" class="headerlink" title="Step2, Tools Install"></a>Step2, Tools Install</h2><ul><li>Install wget <code>brew install wget</code></li><li>Install nasm: <code>brew install nasm</code></li><li>Install qemu and bochs: <code>brew install qemu bochs</code></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 Self Review</title>
      <link href="/2023/12/26/2023-Self-Review/"/>
      <url>/2023/12/26/2023-Self-Review/</url>
      
        <content type="html"><![CDATA[<p>2023å³å°†ç»“æŸï¼Œæ€»ç»“ä¸‹è¿™ä¸€å¹´çš„æ”¶è·ï½</p><p>ï¼ˆå¹´æœ«äº†ï¼Œæ­£åœ¨åº¦è¿‡æå…¶æ— èŠçš„å¯’å‡ï¼Œæ²¡äº‹éšç¬”å†™ä¸€å†™ï¼‰</p><p><a href="https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06">Link</a></p><p><a href="https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06">https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Color-FaaS-2</title>
      <link href="/2023/10/27/Color-FaaS-2/"/>
      <url>/2023/10/27/Color-FaaS-2/</url>
      
        <content type="html"><![CDATA[<h1 id="Color-FaaS-Doc-Final"><a href="#Color-FaaS-Doc-Final" class="headerlink" title="Color FaaS Doc Final"></a>Color FaaS Doc Final</h1><p>Designed By Hanzhong Liu, Xi Shi</p><p>All Videos: <a href="https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9">https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9</a></p><p>Website &amp; Bill Service: <a href="https://github.com/muchengl/tamu-sw-faas">https://github.com/muchengl/tamu-sw-faas</a></p><p>Client: <a href="https://github.com/muchengl/Color-FaaS-Core">https://github.com/muchengl/Color-FaaS-Core</a></p><p>Function SDK: <a href="https://github.com/muchengl/Color-FaaS-SDK">https://github.com/muchengl/Color-FaaS-SDK</a></p><p>Environment: <a href="https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p><p><strong>Catalog</strong></p><p>[toc]</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a><strong>Introduction</strong></h2><p>In this project, we have undertaken a significant redesign of our existing system, transitioning to a microservices architecture and incorporating multi-modal client interfaces. This iteration represents an evolution of our system, focusing on enhanced scalability, modularity, and user experience.</p><p>Our submission for this iteration includes:</p><ol><li><strong>Requirements:</strong> Detailed descriptions and UI sketches of all use cases, incorporating standard format narratives and sequence diagrams. Video recordings demonstrating the system in action for each defined use case, highlighting functionality and user interaction.</li><li><strong>Database Design:</strong> We redesigned our DB based on MongoDB. Comprehensive outlines of data entities, relationships, and an entity-relationship diagram, accompanied by sample data.</li><li><strong>Architectural Design:</strong> In-depth descriptions of client and server components, communication protocols, data formats, and an overarching system architecture diagram.</li><li><strong>Runnable System:</strong> A fully functional system with a personalized and polished UI.</li><li><strong>Installation and Usage Manual:</strong> A detailed Handbook covering installation procedures, usage instructions, and information on necessary libraries and frameworks.</li></ol><h2 id="User-cases-and-UI-design"><a href="#User-cases-and-UI-design" class="headerlink" title="User cases and UI design"></a><strong>User cases and UI design</strong></h2><h4 id="User-case-Register-amp-Login"><a href="#User-case-Register-amp-Login" class="headerlink" title="**User case **: Register &amp; Login"></a>**User case **: Register &amp; Login</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>User</td></tr><tr><td>Goal</td><td>Register a new account and login to the platform</td></tr><tr><td>Path</td><td>1.User visits the website landing page<br />2.System returns the html code of the page<br />3.User clicks â€œNew Userâ€<br />4.System display the form for registering a new user<br />5.User fill in the new user information and submit<br />6.System writes the new user information to the database. And jump back to the landing page<br />7.User enters the new user information and clicks Login<br />8.System checks whether the user exists. If yes, go to the home page</td></tr></tbody></table><p>UI of this User case:</p><p>VIdeo: <a href="https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz">https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz</a></p><img src="/Users/lhz/Desktop/SW/SW-final/Register.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="600" align="bottom" /><img src="/Users/lhz/Desktop/SW/SW-final/login.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><h4 id="User-case-Development-Upload-function"><a href="#User-case-Development-Upload-function" class="headerlink" title="**User case **: Development/Upload function"></a>**User case **: Development/Upload function</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>A User want to deploy a application in cloud environment</td></tr><tr><td>Path</td><td>1. User develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file (in HDFS), and the function file is successfully created <br />3. User views the corresponding information in the function list</td></tr></tbody></table><p>UI of this User case</p><p>Video: <a href="https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj">https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj</a></p><img src="/Users/lhz/Desktop/SW/SW-final/function.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><h4 id="User-case-Test-Function-via-web-page"><a href="#User-case-Test-Function-via-web-page" class="headerlink" title="**User case **: Test Function via web page"></a>**User case **: Test Function via web page</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>User</td></tr><tr><td>Goal</td><td>Test the function from platformâ€™s web page</td></tr><tr><td>Path</td><td>1. User enter the function test page<br />2. System return the web page to user<br />3. User test this function from web page.<br />4. System calls the function and returns the result and log</td></tr></tbody></table><p>UI of this User case:</p><p>Video: <a href="https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8">https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8</a></p><img src="/Users/lhz/Desktop/SW/SW-final/test.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><img src="/Users/lhz/Desktop/SW/SW-final/test02.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><h4 id="User-case-Test-Functions-via-Public-URL"><a href="#User-case-Test-Functions-via-Public-URL" class="headerlink" title="**User case **: Test Functions via Public URL"></a>**User case **: Test Functions via Public URL</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>User</td></tr><tr><td>Goal</td><td>Test the function from platformâ€™s web page</td></tr><tr><td>Path</td><td>1. User enter the function test page<br />2. System return the web page to user<br />3. User copy the â€œpublic urlâ€ and test it in Browser<br />4. System calls the function and returns the result and log as JSON. Show it in Browser.</td></tr></tbody></table><p>Video: <a href="https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u">https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u</a></p><h4 id="User-case-Test-Functions-in-the-Desktop-Tool"><a href="#User-case-Test-Functions-in-the-Desktop-Tool" class="headerlink" title="**User case **: Test Functions in the Desktop Tool"></a>**User case **: Test Functions in the Desktop Tool</h4><p>There are two options to implement this Desktop tool, one is to write an <strong>interactive command line</strong>, and the other is to implement the program with UI. Since my project is a developer-oriented tool, I decided to implement an interactive command line program that more closely resembles a real-world product (like these tools in linux).</p><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Test functions in desktop tool</td></tr><tr><td>Path</td><td>1. User start the Desktop tool and login<br />2. System verifies that user information is correct<br />3. User enter list, history or test command to use different functions<br />4.System process the command and return the result<br />5.User see the output in screen.</td></tr></tbody></table><p>UI of this User case:</p><p>Video: <a href="https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i">https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i</a></p><img src="/Users/lhz/Desktop/SW/SW-final/tool01.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="300" align="bottom" /><img src="/Users/lhz/Desktop/SW/SW-final/tool02.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><img src="/Users/lhz/Desktop/SW/SW-final/tool03.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><h4 id="User-case-Manage-tasks"><a href="#User-case-Manage-tasks" class="headerlink" title="**User case **: Manage tasks"></a>**User case **: Manage tasks</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Trace  the running status of a Func</td></tr><tr><td>Path</td><td>1. User enter Task manage page<br />2. System return the manage page<br />3. User look at the running status, output and time of the function</td></tr></tbody></table><p>Video: <a href="https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE">https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE</a></p><img src="/Users/lhz/Desktop/SW/SW-final/tasks.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><h4 id="User-case-Top-up-userâ€™s-account"><a href="#User-case-Top-up-userâ€™s-account" class="headerlink" title="**User case **: Top up userâ€™s account"></a>**User case **: Top up userâ€™s account</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Top up</td></tr><tr><td>Path</td><td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click â€œRechargeâ€ button<br />4. System show the recharge form<br />5.User type info and click the button â€œSubmitâ€<br />6.System add money to userâ€™s account</td></tr></tbody></table><p>UI of this User case:</p><p>Video: <a href="https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh">https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh</a></p><img src="/Users/lhz/Desktop/SW/SW-final/recarge.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><h4 id="User-case-Pay-the-bill"><a href="#User-case-Pay-the-bill" class="headerlink" title="**User case **: Pay the bill"></a>**User case **: Pay the bill</h4><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Pay the bill</td></tr><tr><td>Path</td><td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click â€œUpdate Billâ€ button<br />4. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />5. User click â€œPayâ€ button<br />6. System deducts the fee and completes the payment</td></tr></tbody></table><p>UI of this User case:</p><p>Video: <a href="https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i">https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i</a></p><img src="/Users/lhz/Desktop/SW/SW-final/userdata.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><h2 id="Architectural-design"><a href="#Architectural-design" class="headerlink" title="Architectural design"></a><strong>Architectural design</strong></h2><h4 id="High-Level-Design"><a href="#High-Level-Design" class="headerlink" title="High Level Design"></a><strong>High Level Design</strong></h4><p>This system comprises three microservices: <strong>Website Service</strong>, <strong>Billing Service</strong>, and <strong>Execution Client</strong>. The Website interact with the Execution Client and Billing Servers using the <strong>Http RestFul API</strong> protocol. The Website Service is responsible for user login, function upload, and function management. The Billing Server handles generating bills and processing user operations for recharge and payment. </p><p>The Execution Client is a multi-instance service, allowing for the deployment of numerous instances to achieve horizontal scaling and enhance system performance. The clients will register its information in ZooKeeper. The Website can then retrieve the list of clients from ZooKeeper and subsequently dispatch function calls to these clients.</p><p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>Client</strong> program will run in In these servers. When a task is sent to a Client, it will stand up a Executor to process this task. The communitetion bewteen Client and Executor will been held by <strong>gPRC</strong>. Because, Function files are very big, so worker will use LRU to cache some function instances.</p><p>As for the architecture of this systemï¼š</p><img src="/Users/lhz/Desktop/SW/SW-final/arch.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><h4 id="Data-Storage-System"><a href="#Data-Storage-System" class="headerlink" title="Data Storage System"></a><strong>Data Storage System</strong></h4><p>In Website service and Bill service, we use <strong>MongoDB</strong> to store userâ€™s information. Website will provide user with functions include: add/update a Func, pay for the bill, trace Func status, debug function via webpage.</p><p>For function file storage, we use <strong>HDFS</strong> as the cloud storage system. Userâ€™s function files will be uploaded to HDFS and got by Executor.</p><p>For cluster management, we use <strong>ZooKeeper</strong> as the information register system. All clientsâ€™ info will be stored in ZooKeeper.</p><h4 id="Data-format-between-services"><a href="#Data-format-between-services" class="headerlink" title="Data format between services"></a><strong>Data format between services</strong></h4><p><strong>User â†” Website</strong></p><table><thead><tr><th>Request</th><th>Protocol</th><th>Data Type</th><th>Request Data</th><th>Response Data</th><th>URL</th></tr></thead><tbody><tr><td>Login</td><td>POST</td><td>Form</td><td>Username<br />Password</td><td>Redirect to the home page</td><td>/user</td></tr><tr><td>Register new user</td><td>POST</td><td>Form</td><td>Username<br />Password</td><td>register success: â€œokâ€<br />fail to register: â€œfailâ€</td><td>/add/user</td></tr><tr><td>Upload a new function</td><td>POST</td><td>Form</td><td>FunctionName<br />Description<br />Function File</td><td>upload success: â€œokâ€<br />fail to upload: â€œfailâ€</td><td>/upload/func</td></tr><tr><td>Update functionâ€™s data</td><td>POST</td><td>Json</td><td>New FunctionName<br />New Description</td><td>update success: â€œokâ€<br />fail to update: â€œfailâ€</td><td>/update/func</td></tr><tr><td>Get userâ€™s function list</td><td>GET</td><td>url</td><td>User ID</td><td>A json list contains all userâ€™s function</td><td>/funcs</td></tr><tr><td>Get userâ€™s function access history</td><td>GET</td><td>url</td><td>User ID</td><td>A json list contains all userâ€™s function access history</td><td>/user/tasks</td></tr><tr><td>Pay for the bill <br />(Forward to the Bill service)</td><td>POST</td><td>Json</td><td>User ID<br />Bill ID</td><td>pay success: â€œokâ€<br />fail to pay: â€œfailâ€</td><td>/pay/bill</td></tr><tr><td>Top up<br />(Forward to the Bill service)</td><td>POST</td><td>Json</td><td>User ID<br />Card Number<br />Amount of money</td><td>success: â€œokâ€<br />fail: â€œfailâ€</td><td>/user/add/balance</td></tr><tr><td>Update Bill<br />(Forward to the Bill service)</td><td>GET</td><td>Json</td><td>User ID</td><td>success: â€œokâ€<br />fail: â€œfailâ€</td><td>/update/bills</td></tr><tr><td>Get Bill List<br />(Forward to the Bill service)</td><td>GET</td><td>Json</td><td>User ID</td><td>A json list contains all userâ€™s bill history</td><td>/bills</td></tr><tr><td>Invoke a function</td><td>POST/GET</td><td>Json</td><td>Function ID<br />Task Input</td><td>A json of output and logs</td><td>/func/invoke</td></tr></tbody></table><p><strong>Website â†” Bill service</strong></p><table><thead><tr><th>Request</th><th>Protocol</th><th>Data Type</th><th>Request Data</th><th>Response Data</th><th>URL</th></tr></thead><tbody><tr><td>Pay for the bill</td><td>POST</td><td>Json</td><td>User ID<br />Bill ID</td><td>pay success: â€œokâ€<br />fail to pay: â€œfailâ€</td><td>/pay/bill</td></tr><tr><td>Top up</td><td>POST</td><td>Json</td><td>User ID<br />Card Number<br />Amount of money</td><td>success: â€œokâ€<br />fail: â€œfailâ€</td><td>/user/add/balance</td></tr><tr><td>Update Bill</td><td>GET</td><td>Json</td><td>User ID</td><td>success: â€œokâ€<br />fail: â€œfailâ€</td><td>/update/bills</td></tr><tr><td>Get Bill List</td><td>GET</td><td>Json</td><td>User ID</td><td>A json list contains all userâ€™s bill history</td><td>/bills</td></tr></tbody></table><p><strong>Website â†” Client</strong></p><table><thead><tr><th>Request</th><th>Protocol</th><th>Data Type</th><th>Request Data</th><th>Response Data</th><th>URL</th></tr></thead><tbody><tr><td>Submit a task</td><td>POST</td><td>Json</td><td>TaskID          <br />FuncName        <br />FuncID          <br />FuncStorageType<br />TaskFuncPath     <br />TaskRunningMode <br />FuncType      <br />TaskCPUCore     <br />TaskMem        <br />TaskDiskSpace   <br />TaskMaxTime     <br />TaskInput</td><td>A JSON include:<br />status,<br />msg<br />logs</td><td>/func/invoke</td></tr></tbody></table><h2 id="Database-Design"><a href="#Database-Design" class="headerlink" title="Database Design"></a><strong>Database Design</strong></h2><p>This FaaS platformâ€™s database(MongoDB) design encompasses multiple tables, intended to manage user information, bills, functions, function execution records, billing units, and account history details. Hereâ€™s a detailed explanation of these tables:</p><ol><li><strong>User Info Table</strong>:<ul><li><code>User_ID</code>: A unique identifier for the user, of type Bigint.</li><li><code>User_Email</code>: The email address of the user.</li><li><code>User_Name</code>: The name of the user, which can be up to 20 characters.</li><li><code>User_Password</code>: The password of the user, capped at 20 characters.</li><li><code>User_Balance</code>: The balance in the userâ€™s account, of type Bigint.</li></ul></li><li><strong>Bill Table</strong>:<ul><li><code>Bill_ID</code>: A unique identifier for the bill.</li><li><code>User_ID</code>: A unique identifier for the user, serving as an index.</li><li><code>Bill_Date</code>: The date of the bill.</li><li><code>Bill_Balance</code>: The amount of the bill.</li><li><code>Bill_tasks</code>: A JSON document inclueds all unpaid function running records, supported by MongoDB</li><li><code>Status</code>: The status of the bill, where 0 stands for unpaid and 1 for paid.</li></ul></li><li><strong>Function Table</strong>:<ul><li><code>Func_ID</code>: A unique identifier for the function.</li><li><code>User_ID</code>: A unique identifier for the user.</li><li><code>Func_Path</code>: The path to the functionâ€™s code in object storage services like S3.</li><li><code>Func_Explanation</code>: An explanation or description of the function.</li><li><code>Func_Resource</code>: Resources required by the function, in JSON format, e.g., {â€œCPUâ€:4,â€MEMâ€:1024m,â€DISKâ€:1024m}.</li></ul></li><li><strong>Func Running Record Table</strong>:<ul><li><code>ID</code>: A unique identifier for the execution record.</li><li><code>Func_ID</code>: A unique identifier for the function.</li><li><code>Running_Time</code>: Execution time, e.g., 100ms.</li><li><code>Status</code>: Status of execution, where 0 stands for failure, 1 for success, and 2 for pending.</li><li><code>Input</code>: Input data in JSON format.</li><li><code>Running_Date</code>: The date of execution.</li><li><code>Payment_Status</code>: Payment status, where 0 stands for unpaid and 1 for paid.</li></ul></li><li><strong>Billing Unit Table</strong>:<ul><li><code>Price</code>: The price, e.g., 0.01$/ms for functions.</li></ul></li><li><strong>Account Info History Table</strong>:<ul><li><code>ID</code>: A unique identifier for the record.</li><li><code>Date</code>: The date.</li><li><code>Type</code>: The action type (add fund or payment).</li><li><code>Account_num</code>: Account number.</li><li><code>Bill_ID</code>: The ID of the bill.</li><li><code>Money</code>: The amount.</li><li><code>User_ID</code>: A unique identifier for the user.</li></ul></li></ol><hr><h4 id="User-Info-Table"><a href="#User-Info-Table" class="headerlink" title="- User Info Table:"></a>- User Info Table:</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>User_ID</td><td>String</td><td></td></tr><tr><td>User_Email</td><td>String</td><td></td></tr><tr><td>User_Name</td><td>String</td><td></td></tr><tr><td>User_Password</td><td>String</td><td></td></tr><tr><td>User_Balance</td><td>Bigint</td><td>1000.0$</td></tr></tbody></table><h4 id="Bill-Table"><a href="#Bill-Table" class="headerlink" title="- Bill Table"></a>- Bill Table</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>Bill_ID</td><td>String</td><td></td></tr><tr><td>User_ID</td><td>String</td><td>Index</td></tr><tr><td>Bill_Date</td><td>String</td><td></td></tr><tr><td>Bill_Balance</td><td>Bigint</td><td></td></tr><tr><td>Bill_Tasks</td><td>Task</td><td>A JSON document inclueds all unpaid function running records, supported by MongoDB<br />{<br />    {taskID:1,â€¦},<br />    {taskID:2,â€¦}<br />}</td></tr><tr><td>Status</td><td>int</td><td>0 unpay, 1 paid</td></tr></tbody></table><h4 id="Function-Table"><a href="#Function-Table" class="headerlink" title="- Function Table"></a>- Function Table</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>Func_ID</td><td>String</td><td></td></tr><tr><td>User_ID</td><td>String</td><td></td></tr><tr><td>Func_Args</td><td>String</td><td>{â€œnum1â€:int,â€num2â€,int}</td></tr><tr><td>Func_Path</td><td>String</td><td>path of funcâ€™s code in HDFS or S3</td></tr><tr><td>Func_Explanation</td><td>String</td><td></td></tr></tbody></table><h4 id="Func-Running-Record"><a href="#Func-Running-Record" class="headerlink" title="- Func Running Record"></a>- Func Running Record</h4><table><thead><tr><th>tem</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>Running_ID</td><td>String</td><td></td></tr><tr><td>Func_ID</td><td>String</td><td></td></tr><tr><td>Running_Time</td><td>String</td><td>Example: 100ms</td></tr><tr><td>Status</td><td>Int</td><td>0: fail, 1 success, 2 pending</td></tr><tr><td>Input</td><td>String</td><td>A input json</td></tr><tr><td>Running_Date</td><td>String</td><td></td></tr><tr><td>Payment_Status</td><td>Int</td><td>0 unpay, 1 paid</td></tr></tbody></table><h4 id="Billing-Unit"><a href="#Billing-Unit" class="headerlink" title="- Billing Unit"></a>- Billing Unit</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>ID</td><td>Bitint</td><td></td></tr><tr><td>Price</td><td>float</td><td>0.0001$ / ms</td></tr></tbody></table><h4 id="Account-Info-History"><a href="#Account-Info-History" class="headerlink" title="- Account Info History"></a>- Account Info History</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation/Sample Data</th></tr></thead><tbody><tr><td>ID</td><td>String</td><td></td></tr><tr><td>Date</td><td>String</td><td></td></tr><tr><td>Type</td><td>Int</td><td>Payment or ADD</td></tr><tr><td>Account_num</td><td>String</td><td></td></tr><tr><td>Bill_ID</td><td>Int</td><td></td></tr><tr><td>Money</td><td>Bigint</td><td></td></tr><tr><td>User_ID</td><td>Bigint</td><td></td></tr></tbody></table><h4 id="ER-Graph"><a href="#ER-Graph" class="headerlink" title="- ER Graph"></a>- ER Graph</h4><img src="/Users/lhz/Desktop/SW/SW-final/ER.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="600" align="bottom" /><h2 id="Handbook"><a href="#Handbook" class="headerlink" title="Handbook"></a><strong>Handbook</strong></h2><p>Website &amp; Bill Service Code: <a href="https://github.com/muchengl/tamu-sw-faas">https://github.com/muchengl/tamu-sw-faas</a></p><p>Client Code: <a href="https://github.com/muchengl/Color-FaaS-Core">https://github.com/muchengl/Color-FaaS-Core</a></p><p>Docker Environment: <a href="https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p><h4 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a><strong>Environment</strong></h4><p>This service includes a Website, Bill service, and Client. Both the Website and Bill service rely on a Java environment (Java 1.8+), while the Client is developed using Golang and requires Golang 1.21. Website and Bill service use Maven to manager all dependent environment. Client can use Golangâ€™s mod to get all dependents.</p><h4 id="Start-Website-and-Bill-Service"><a href="#Start-Website-and-Bill-Service" class="headerlink" title="Start Website and Bill Service"></a><strong>Start Website and Bill Service</strong></h4><p>Step 01: Download/Clone all code of project.</p><p>Step 02: Open the project with IDEA.</p><p>Step 03: Open <strong>pom.xml</strong> in project and init maven for both main-module and bill-module.</p><p>Step 04: Run project in IDEA. Website is in main module <strong>com.tamu.faas.FaasApplication</strong>. Bill is in bill module <strong>com.tamu.faas.bill.BillApplication</strong></p><p>Step 05: com.tamu.faas.FaasApplication will use port 8080 and com.tamu.faas.bill.BillApplication will use 8081.</p><h4 id="Start-Client-Cluster"><a href="#Start-Client-Cluster" class="headerlink" title="Start Client Cluster"></a><strong>Start Client Cluster</strong></h4><p>Client uses makefile to manager the project, you can use the follows commands to init and build the project:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ cd [client project&#x27;s dir in your computer]</span><br><span class="line">âœ make mod</span><br><span class="line">---&gt; make mod &lt;---</span><br><span class="line">go mod tidy</span><br><span class="line">go mod download</span><br><span class="line"></span><br><span class="line">âœ make build</span><br><span class="line">---&gt; make build &lt;---</span><br><span class="line">./build.sh</span><br><span class="line">  ---&gt; make clean &lt;---</span><br><span class="line">  ---&gt; init dir &lt;---</span><br><span class="line">  ---&gt; init files &lt;---</span><br><span class="line">  ---&gt; make server &lt;---</span><br><span class="line">  ---&gt; make client &lt;---</span><br><span class="line">  ---&gt; make executor &lt;---</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>And than, use the follows commands to start the client:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ ./output/startup.sh --client</span><br></pre></td></tr></table></figure><p>If you see the following output, the client has started successfully (<strong>only one client</strong>, if you want to start many clients to form a cluster, you need to run muit-clients in many Containers/VMs):</p><img src="/Users/lhz/Desktop/SW/SW-final/run-core.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="800" align="bottom" /><h4 id="Start-Zookeeper-and-HDFS"><a href="#Start-Zookeeper-and-HDFS" class="headerlink" title="Start Zookeeper and HDFS"></a><strong>Start Zookeeper and HDFS</strong></h4><p>Start by docker-compose in project dir (May not work perfectly, may require manual installation) :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ cd [docker-compose&#x27;s dir in your computer]</span><br><span class="line">âœ docker-compose up -d</span><br></pre></td></tr></table></figure><h4 id="Test-the-project"><a href="#Test-the-project" class="headerlink" title="Test the project"></a><strong>Test the project</strong></h4><p>Test the project by URL in your browser: <a href="http://localhost:8080/login">http://localhost:8080/login</a></p><p>HDFS URL in browser: <a href="http://localhost:9870/">http://localhost:9870/</a></p><p>Test desktop tool:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ pip install prettytable requests</span><br><span class="line">âœ python3 client.py</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spark Check Point</title>
      <link href="/2023/09/25/Spark-Check-Point/"/>
      <url>/2023/09/25/Spark-Check-Point/</url>
      
        <content type="html"><![CDATA[<h1 id="Spark-check-point"><a href="#Spark-check-point" class="headerlink" title="Spark check point"></a>Spark check point</h1><p>In SparkContext, when a job is completed, rdd.doCheckpoint() will be called. </p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Run a function on a given set of partitions in an RDD and pass the results to the given</span></span><br><span class="line"><span class="comment">  * handler function. This is the main entry point for all actions in Spark.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param rdd target RDD to run tasks on</span></span><br><span class="line"><span class="comment">  * @param func a function to run on each partition of the RDD</span></span><br><span class="line"><span class="comment">  * @param partitions set of partitions to run on; some jobs may not want to compute on all</span></span><br><span class="line"><span class="comment">  * partitions of the target RDD, e.g. for operations like `first()`</span></span><br><span class="line"><span class="comment">  * @param resultHandler callback to pass each result to</span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runJob</span></span>[<span class="type">T</span>, <span class="type">U</span>: <span class="type">ClassTag</span>](</span><br><span class="line">     rdd: <span class="type">RDD</span>[<span class="type">T</span>],</span><br><span class="line">     func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">U</span>,</span><br><span class="line">     partitions: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">     resultHandler: (<span class="type">Int</span>, <span class="type">U</span>) =&gt; <span class="type">Unit</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">   ...</span><br><span class="line">   run job</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">// job completed</span></span><br><span class="line">   rdd.doCheckpoint()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>Check point code in RDD.</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Performs the checkpointing of this RDD by saving this. It is called after a job using this RDD</span></span><br><span class="line"><span class="comment">  * has completed (therefore the RDD has been materialized and potentially stored in memory).</span></span><br><span class="line"><span class="comment">  * doCheckpoint() is called recursively on the parent RDDs.</span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"><span class="keyword">private</span>[spark] <span class="function"><span class="keyword">def</span> <span class="title">doCheckpoint</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">   <span class="type">RDDOperationScope</span>.withScope(sc, <span class="string">&quot;checkpoint&quot;</span>, allowNesting = <span class="literal">false</span>, ignoreParent = <span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!doCheckpointCalled) &#123;</span><br><span class="line">       doCheckpointCalled = <span class="literal">true</span></span><br><span class="line">       <span class="keyword">if</span> (checkpointData.isDefined) &#123;</span><br><span class="line">         <span class="keyword">if</span> (checkpointAllMarkedAncestors) &#123;</span><br><span class="line">           <span class="comment">// TODO We can collect all the RDDs that needs to be checkpointed, and then checkpoint</span></span><br><span class="line">           <span class="comment">// them in parallel.</span></span><br><span class="line">           <span class="comment">// Checkpoint parents first because our lineage will be truncated after we</span></span><br><span class="line">           <span class="comment">// checkpoint ourselves</span></span><br><span class="line">           dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class="line">         &#125;</span><br><span class="line">         checkpointData.get.checkpoint()</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Color-FaaS</title>
      <link href="/2023/09/25/Color-FaaS/"/>
      <url>/2023/09/25/Color-FaaS/</url>
      
        <content type="html"><![CDATA[<h1 id="Color-FaaS-Design-Doc"><a href="#Color-FaaS-Design-Doc" class="headerlink" title="Color FaaS Design Doc"></a>Color FaaS Design Doc</h1><p>Designed By Hanzhong Liu, Xi Shi</p><p>Video: <a href="https://www.youtube.com/watch?v=QDuIaaMpTBo">https://www.youtube.com/watch?v=QDuIaaMpTBo</a></p><h2 id="High-Level-Design"><a href="#High-Level-Design" class="headerlink" title="High Level Design"></a>High Level Design</h2><h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><p>I plan to design a FaaS platform called Color FaaS. Color FaaS will has the ability to process many kinds of task like AWS Lambda. The platform will include user registration, function creation and management, billing and payment.</p><p><strong>User case 1</strong>: Development</p><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>A User want to deploy a application in cloud environment</td></tr><tr><td>Path</td><td>1. User must develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file, and the function file is successfully created <br />3. User test this function from web browser.<br />4. System calls the function and returns the result</td></tr></tbody></table><p><strong>User case 2</strong>: Pay the bill</p><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Pay the bill</td></tr><tr><td>Path</td><td>1. User login into the platftom<br />2. System verifies that user information is correct<br />3. User enter the account info page<br />4. System return the web page to user<br />5. User click â€œbillâ€ button<br />6. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />7. User click â€œPayâ€ button<br />8. System redirects to the payment page<br />9. User enter all information in the payment form and submit<br />10. System deducts the fee and completes the payment</td></tr></tbody></table><p><strong>User case 3</strong>: Manage function</p><table><thead><tr><th>Items</th><th></th></tr></thead><tbody><tr><td>Actor</td><td>Developer</td></tr><tr><td>Goal</td><td>Trace  the running status of a Func</td></tr><tr><td>Path</td><td>1. User login into the platform<br />2. System verifies that user information is correct<br />3. User enter Task manage page<br />4. System return the manage page<br />5. User use search to find the target Func<br />6. System search from the database and return it to user<br />7. User look at the running status of the function</td></tr></tbody></table><h3 id="Architectural-design"><a href="#Architectural-design" class="headerlink" title="Architectural design"></a>Architectural design</h3><p>The system is divided into three layers: the website, the gateway, and the cluster. The website is primarily responsible for user interaction and needs to connect to the database to store user information. The gateway layer is a simplified implementation that can be replaced with gateways like AWS ELB (Elastic Load Balancer). The cluster is the core of the entire Color FaaS platform. Here, I have designed a decentralized resource scheduler and use Docker for handling user tasks.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/2023-09-2716.58.19.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><p>In Website layer, we use Java Serverlet to develop a Web application.We also use Mysql to store userâ€™s information. Website will provide user with functions include: add/delete a Func, pay for the bill, trace Func status.</p><p>For GateWay, all request will be send to gateway, and gateway will write infomation about the task into DB. In the end, gateway will sent task to Core cluster.</p><p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>worker</strong> program will run in In these servers. When a task is sent to a worker, it will stand up a Docker container and run this task in that container. Because, image of a container is very big, so worker will use LRU to cache some containers.</p><h2 id="Website-Detail-Design"><a href="#Website-Detail-Design" class="headerlink" title="Website Detail Design"></a>Website Detail Design</h2><h3 id="UI-Design-Prototype"><a href="#UI-Design-Prototype" class="headerlink" title="UI Design / Prototype"></a>UI Design / Prototype</h3><h4 id="Login-page"><a href="#Login-page" class="headerlink" title="- Login page"></a>- Login page</h4><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/login.png" alt="login"></p><h4 id="Register-page"><a href="#Register-page" class="headerlink" title="- Register page"></a>- Register page</h4><p><img src="/Users/lhz/Desktop/SW/register.png" alt="register"></p><h4 id="Func-manage-page"><a href="#Func-manage-page" class="headerlink" title="- Func manage page"></a>- Func manage page</h4><p>From this page, user can Add, delete, or modify a function.</p><p><img src="/Users/lhz/Desktop/SW/func.png" alt="register"></p><h4 id="Task-manage-page"><a href="#Task-manage-page" class="headerlink" title="- Task manage page"></a>- Task manage page</h4><p>This page shows all the userâ€™s functions running.</p><p>![æˆªå±2023-10-01 11.43.41](/Users/lhz/Library/Application Support/typora-user-images/æˆªå±2023-10-01 11.43.41.png)</p><h4 id="Account-info-page"><a href="#Account-info-page" class="headerlink" title="- Account info page"></a>- Account info page</h4><p>This page shows the bill and account balance, and the user can pay the bill or top up the money.</p><p><img src="/Users/lhz/Desktop/SW/account.png" alt="register"></p><h3 id="Database-Design"><a href="#Database-Design" class="headerlink" title="Database Design"></a>Database Design</h3><h4 id="User-Info-Table"><a href="#User-Info-Table" class="headerlink" title="- User Info Table:"></a>- User Info Table:</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>User_ID</td><td>Bigint</td><td></td></tr><tr><td>User_Email</td><td>varchar(50)</td><td></td></tr><tr><td>User_Name</td><td>Varchar(20)</td><td></td></tr><tr><td>User_Password</td><td>varchar(20)</td><td></td></tr><tr><td>User_Balance</td><td>Bigint</td><td></td></tr></tbody></table><h4 id="Bill-Table"><a href="#Bill-Table" class="headerlink" title="- Bill Table"></a>- Bill Table</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>Bill_ID</td><td>Bigint</td><td></td></tr><tr><td>User_ID</td><td>Bigint</td><td>Index</td></tr><tr><td>Bill_Date</td><td>Datetime</td><td></td></tr><tr><td>Bill_Balance</td><td>Bigint</td><td></td></tr><tr><td>Bill_Detail</td><td>Text</td><td>A JSON inclueds all unpaid function running recordsâ€™ ID {1,2,3}</td></tr><tr><td>Status</td><td>int</td><td>0 unsay, 1 paid</td></tr></tbody></table><h4 id="Function-Table"><a href="#Function-Table" class="headerlink" title="- Function Table"></a>- Function Table</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>Func_ID</td><td>Bigint</td><td></td></tr><tr><td>User_ID</td><td>Bigint</td><td></td></tr><tr><td>Func_Args</td><td>JSON</td><td>{â€œnum1â€:int,â€num2â€,int}</td></tr><tr><td>Func_Path</td><td>varchar(200)</td><td>path of funcâ€™s code in OSS like S3</td></tr><tr><td>Func_Explanation</td><td>varchar(500)</td><td></td></tr><tr><td>Func_Output</td><td>Int</td><td>0=sync / 1=async</td></tr><tr><td>Func_Resource</td><td>JSON</td><td>{â€œCPUâ€:4,â€MEMâ€:1024m,â€DISKâ€:1024m}</td></tr></tbody></table><h4 id="Func-Running-Record"><a href="#Func-Running-Record" class="headerlink" title="- Func Running Record"></a>- Func Running Record</h4><table><thead><tr><th>tem</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>Running_ID</td><td>Bigint</td><td></td></tr><tr><td>Func_ID</td><td>Bigint</td><td></td></tr><tr><td>Running_Time</td><td>Bigint</td><td>Example: 100ms</td></tr><tr><td>Status</td><td>Int</td><td>0: fail, 1 success, 2 pending</td></tr><tr><td>Input</td><td>Text</td><td>A input json</td></tr><tr><td>Running_Date</td><td>Datetime</td><td></td></tr><tr><td>Payment_Status</td><td>Int</td><td>0 unsay, 1 paid</td></tr></tbody></table><h4 id="Billing-Unit"><a href="#Billing-Unit" class="headerlink" title="- Billing Unit"></a>- Billing Unit</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>ID</td><td>Bitint</td><td></td></tr><tr><td>Resource_Type</td><td>Int</td><td>CPU / MEM /  DISK</td></tr><tr><td>Price</td><td>float</td><td>Example: 0.01$/ms</td></tr></tbody></table><h4 id="Account-Info-History"><a href="#Account-Info-History" class="headerlink" title="- Account Info History"></a>- Account Info History</h4><table><thead><tr><th>Item</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>ID</td><td>Bitint</td><td></td></tr><tr><td>Date</td><td>Datetime</td><td>CPU / MEM /  DISK</td></tr><tr><td>Type</td><td>Int</td><td></td></tr><tr><td>Account_num</td><td>varchar(20)</td><td></td></tr><tr><td>Bill_ID</td><td>Int</td><td></td></tr><tr><td>Money</td><td>Bigint</td><td></td></tr><tr><td>User_ID</td><td>Bigint</td><td></td></tr></tbody></table><h4 id="ER"><a href="#ER" class="headerlink" title="- ER"></a>- ER</h4><p><img src="/Users/lhz/Desktop/SW/ER.jpg"></p><h4 id="SQL-Code"><a href="#SQL-Code" class="headerlink" title="- SQL Code"></a>- SQL Code</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Account_Info_History</span><br><span class="line">(</span><br><span class="line">    ID          <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    <span class="type">Date</span>        <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">null</span>,</span><br><span class="line">    Type        <span class="type">int</span>         <span class="keyword">null</span> comment <span class="string">&#x27;1:money in, pay for a bill&#x27;</span>,</span><br><span class="line">    Account_Num <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">null</span> comment <span class="string">&#x27;for type 1&#x27;</span>,</span><br><span class="line">    Bill_ID     <span class="type">bigint</span>      <span class="keyword">null</span> comment <span class="string">&#x27;for type 2&#x27;</span>,</span><br><span class="line">    Money       <span class="type">bigint</span>      <span class="keyword">null</span> comment <span class="string">&#x27;for type 1, it is a positive num.&#x27;</span>,</span><br><span class="line">    User_ID     <span class="type">bigint</span>      <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Bill</span><br><span class="line">(</span><br><span class="line">    Bill_ID      <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    User_ID      <span class="type">bigint</span>   <span class="keyword">null</span>,</span><br><span class="line">    Bill_Date    datetime <span class="keyword">null</span>,</span><br><span class="line">    Bill_Balance <span class="keyword">double</span>   <span class="keyword">null</span>,</span><br><span class="line">    Bill_Detail  text     <span class="keyword">null</span>,</span><br><span class="line">    Status       <span class="type">int</span>      <span class="keyword">null</span> comment <span class="string">&#x27;&quot;0 unpay, 1paid&quot;&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index User_ID</span><br><span class="line">    <span class="keyword">on</span> Bill (User_ID);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Billing_Units</span><br><span class="line">(</span><br><span class="line">    ID            <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    Resource_Type <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">null</span>,</span><br><span class="line">    Price         <span class="keyword">double</span>      <span class="keyword">null</span> comment <span class="string">&#x27;Example: 0.01$/ms&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Func_Running_Record</span><br><span class="line">(</span><br><span class="line">    Running_ID     <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    Func_ID        <span class="type">bigint</span>   <span class="keyword">null</span>,</span><br><span class="line">    Running_Time   <span class="type">int</span>      <span class="keyword">null</span> comment <span class="string">&#x27;100ms&#x27;</span>,</span><br><span class="line">    Status         <span class="type">int</span>      <span class="keyword">null</span> comment <span class="string">&#x27;0: fail, 1 success, 2 pending&#x27;</span>,</span><br><span class="line">    Input          text     <span class="keyword">null</span>,</span><br><span class="line">    Running_Date   datetime <span class="keyword">null</span>,</span><br><span class="line">    Payment_Status <span class="type">int</span>      <span class="keyword">null</span> comment <span class="string">&#x27;&quot;0 unpay, 1 paid&quot;&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Functions</span><br><span class="line">(</span><br><span class="line">    Func_ID            <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    User_ID            <span class="type">bigint</span>       <span class="keyword">null</span>,</span><br><span class="line">    Func_Args          text         <span class="keyword">null</span>,</span><br><span class="line">    Func_Path          <span class="type">varchar</span>(<span class="number">300</span>) <span class="keyword">null</span>,</span><br><span class="line">    Func_Explanation   <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">null</span>,</span><br><span class="line">    Func_Output        <span class="type">int</span>          <span class="keyword">null</span> comment <span class="string">&#x27;0=sync / 1=async&#x27;</span>,</span><br><span class="line">    Func_Resource_CPU  <span class="type">int</span>          <span class="keyword">null</span>,</span><br><span class="line">    Func_Resource_Mem  <span class="type">int</span>          <span class="keyword">null</span>,</span><br><span class="line">    Func_Resource_Disk <span class="type">int</span>          <span class="keyword">null</span>,</span><br><span class="line">    Func_Name          <span class="type">varchar</span>(<span class="number">50</span>)  <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index User_ID</span><br><span class="line">    <span class="keyword">on</span> Functions (User_ID);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> User_Info</span><br><span class="line">(</span><br><span class="line">    User_ID       <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    User_Email    <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">null</span>,</span><br><span class="line">    User_Password <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">null</span>,</span><br><span class="line">    User_Balance  <span class="type">bigint</span>      <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Core-Cluster-Detail-Design"><a href="#Core-Cluster-Detail-Design" class="headerlink" title="Core Cluster Detail Design"></a>Core Cluster Detail Design</h2><p>**In development! **</p><p>In core cluster, there are many servers. All servers will be managed by zookeeper. All nodes can perform the scheduling function. Zookeeper will elect a leader for scheduling.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.10.24.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" /><p>The worker nodes will regularly report resource usage to the master node, and the master node will use the progress of DRF algorithm based on resource usage information</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.11.11.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="700" align="bottom" /><p>The following figure shows the module division of the whole scheduling system(For master):</p><img src="/Users/lhz/Desktop/SW/f.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="500" align="bottom" />]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Distributed-sys-mp1-design</title>
      <link href="/2023/09/24/Distributed-sys-mp1-design/"/>
      <url>/2023/09/24/Distributed-sys-mp1-design/</url>
      
        <content type="html"><![CDATA[<h1 id="MP1-Design-Doc"><a href="#MP1-Design-Doc" class="headerlink" title="MP1 Design Doc"></a>MP1 Design Doc</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In modern social networking applications, user login, mutual following, viewing lists, and timelines are among the common functionalities. In this project, I have created a simple social networking application called SNS from skeleton, showcasing the fundamental principles and operations of these features.</p><h2 id="Detailed-Design"><a href="#Detailed-Design" class="headerlink" title="Detailed Design"></a>Detailed Design</h2><h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p>For a successful login, the client needs to connect to the server and obtain a stub. The client sends its username to the server, and if the server responds with â€œOK,â€ the login is successful.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ  mp1 ./tsc -u test</span><br><span class="line"></span><br><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; </span><br></pre></td></tr></table></figure><p>On the server-side, it starts by traversing the client database (client_db) to determine if the client is already logged in. If not, it creates a new Client object and initializes it. Subsequently, it creates a timeline file locally named â€œusername.txt.â€ If it detects that the user is already logged in, it returns a â€œdenyâ€ status.</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.26.07.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="300" align="bottom" /><p>The timeline file has the following format:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[username2] [msg2] [timestamp2]</span><br><span class="line">[username1] [msg1] [timestamp1]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Where the most recent information is stored at the top.</span><br></pre></td></tr></table></figure><h3 id="Follow"><a href="#Follow" class="headerlink" title="Follow"></a>Follow</h3><p>On the client-side, a request is constructed with the username set as the userâ€™s name and the arg set as username2. The request is then sent to the server. If an â€œOKâ€ response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; FOLLOW default</span><br><span class="line">Command completed successfully</span><br><span class="line">Cmd&gt; </span><br></pre></td></tr></table></figure><p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns â€œNO_TARGETâ€ in msg. If username is equal to username2, it returns â€œCanâ€™t follow selfâ€ since users cannot follow themselves. If the user is already following username2, it returns â€œRE-FOLLOW.â€ Subsequently, the server establishes a direct relationship between username and username2 and returns â€œOK.â€</p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.20.06.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="400" align="bottom" /><h3 id="Unfollow"><a href="#Unfollow" class="headerlink" title="Unfollow"></a>Unfollow</h3><p>On the client-side, a request is constructed with the username set as the userâ€™s name and the arg set as username2. The request is then sent to the server. If an â€œOKâ€ response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; FOLLOW default</span><br><span class="line">Command completed successfully</span><br><span class="line">Cmd&gt; UNFOLLOW default</span><br><span class="line">Command completed successfully</span><br><span class="line">Cmd&gt; </span><br></pre></td></tr></table></figure><p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns â€œNO_TARGET.â€ Otherwise, it removes the relationship between the two users and returns â€œOK.â€</p><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><p>On the server-side, it constructs a ListReply. It iterates through the client database, adding all usernames to the ListReply. Then, it locates username and iterates through its followers, adding them all to the ListReply too.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; LIST</span><br><span class="line">Command completed successfully</span><br><span class="line">All users: lhz, default, </span><br><span class="line">Followers: </span><br><span class="line">Cmd&gt; LIST</span><br><span class="line">Command completed successfully</span><br><span class="line">All users: lhz, default, </span><br><span class="line">Followers: lhz, </span><br><span class="line">Cmd&gt; </span><br></pre></td></tr></table></figure><h3 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h3><p>On the client-side, it begins by establishing a stream connection. It constructs a message request with the message set as â€œjoin_timeline.â€ Afterward, two threads are started: read and write. The read thread continuously reads messages from the stream, while the write thread constantly reads user input and sends it to the server by stream.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">User:</span><br><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; TIMELINE</span><br><span class="line">Command completed successfully</span><br><span class="line">Now you are in the timeline</span><br><span class="line">p1</span><br><span class="line">p2</span><br><span class="line">p3</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Follower:</span><br><span class="line">========= TINY SNS CLIENT =========</span><br><span class="line"> Command Lists and Format:</span><br><span class="line"> FOLLOW &lt;username&gt;</span><br><span class="line"> UNFOLLOW &lt;username&gt;</span><br><span class="line"> LIST</span><br><span class="line"> TIMELINE</span><br><span class="line">=====================================</span><br><span class="line">Cmd&gt; FOLLOW default</span><br><span class="line">Command completed successfully</span><br><span class="line">Cmd&gt; TIMELINE</span><br><span class="line">Command completed successfully</span><br><span class="line">Now you are in the timeline</span><br><span class="line">default (Sun Sep 24 22:31:15 2023) &gt;&gt; p1</span><br><span class="line">default (Sun Sep 24 22:31:16 2023) &gt;&gt; p2</span><br><span class="line">default (Sun Sep 24 22:31:17 2023) &gt;&gt; p3</span><br></pre></td></tr></table></figure><p>On the server-side, upon receiving the â€œjoin_timelineâ€ request, it saves the stream in the client database. It then reads up to 20 lines from the current userâ€™s timeline file, parses them into messages, and sends them to the client. When the server receives a message, it iterates through all followers, individually checking if their stream is not null. If itâ€™s not null, the server sends the message directly to the client through the stream. The message is then saved at the top of the followerâ€™s timeline file.</p><img src="/Users/lhz/Desktop/æˆªå±2023-09-25 23.33.01.png" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="350" align="bottom" />]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spark Memory Manager</title>
      <link href="/2023/09/14/Spark-Memory-Manager/"/>
      <url>/2023/09/14/Spark-Memory-Manager/</url>
      
        <content type="html"><![CDATA[<p>UnifiedMemoryManager:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// acquireStorageMemory</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">acquireStorageMemory</span></span>(</span><br><span class="line">      blockId: <span class="type">BlockId</span>,</span><br><span class="line">      numBytes: <span class="type">Long</span>,</span><br><span class="line">      memoryMode: <span class="type">MemoryMode</span>): <span class="type">Boolean</span> = synchronized &#123;</span><br><span class="line">    assertInvariants()</span><br><span class="line">    assert(numBytes &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> (executionPool, storagePool, maxMemory) = memoryMode <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">ON_HEAP</span> =&gt; (</span><br><span class="line">        onHeapExecutionMemoryPool,</span><br><span class="line">        onHeapStorageMemoryPool,</span><br><span class="line">        maxOnHeapStorageMemory)</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">OFF_HEAP</span> =&gt; (</span><br><span class="line">        offHeapExecutionMemoryPool,</span><br><span class="line">        offHeapStorageMemoryPool,</span><br><span class="line">        maxOffHeapStorageMemory)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (numBytes &gt; maxMemory) &#123;</span><br><span class="line">      <span class="comment">// Fail fast if the block simply won&#x27;t fit</span></span><br><span class="line">      logInfo(<span class="string">s&quot;Will not store <span class="subst">$blockId</span> as the required space (<span class="subst">$numBytes</span> bytes) exceeds our &quot;</span> +</span><br><span class="line">        <span class="string">s&quot;memory limit (<span class="subst">$maxMemory</span> bytes)&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (numBytes &gt; storagePool.memoryFree) &#123;</span><br><span class="line">      <span class="comment">// There is not enough free memory in the storage pool, so try to borrow free memory from</span></span><br><span class="line">      <span class="comment">// the execution pool.</span></span><br><span class="line">      <span class="keyword">val</span> memoryBorrowedFromExecution = <span class="type">Math</span>.min(executionPool.memoryFree,</span><br><span class="line">        numBytes - storagePool.memoryFree)</span><br><span class="line">      executionPool.decrementPoolSize(memoryBorrowedFromExecution)</span><br><span class="line">      storagePool.incrementPoolSize(memoryBorrowedFromExecution)</span><br><span class="line">    &#125;</span><br><span class="line">    storagePool.acquireMemory(blockId, numBytes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Try to acquire up to `numBytes` of execution memory for the current task and return the</span></span><br><span class="line"><span class="comment">   * number of bytes obtained, or 0 if none can be allocated.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This call may block until there is enough free memory in some situations, to make sure each</span></span><br><span class="line"><span class="comment">   * task has a chance to ramp up to at least 1 / 2N of the total memory pool (where N is the # of</span></span><br><span class="line"><span class="comment">   * active tasks) before it is forced to spill. This can happen if the number of tasks increase</span></span><br><span class="line"><span class="comment">   * but an older task had a lot of memory already.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">private</span>[memory] <span class="function"><span class="keyword">def</span> <span class="title">acquireExecutionMemory</span></span>(</span><br><span class="line">      numBytes: <span class="type">Long</span>,</span><br><span class="line">      taskAttemptId: <span class="type">Long</span>,</span><br><span class="line">      memoryMode: <span class="type">MemoryMode</span>): <span class="type">Long</span> = synchronized &#123;</span><br><span class="line">    assertInvariants()</span><br><span class="line">    assert(numBytes &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> (executionPool, storagePool, storageRegionSize, maxMemory) = memoryMode <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">ON_HEAP</span> =&gt; (</span><br><span class="line">        onHeapExecutionMemoryPool,</span><br><span class="line">        onHeapStorageMemoryPool,</span><br><span class="line">        onHeapStorageRegionSize,</span><br><span class="line">        maxHeapMemory)</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">OFF_HEAP</span> =&gt; (</span><br><span class="line">        offHeapExecutionMemoryPool,</span><br><span class="line">        offHeapStorageMemoryPool,</span><br><span class="line">        offHeapStorageMemory,</span><br><span class="line">        maxOffHeapMemory)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Grow the execution pool by evicting cached blocks, thereby shrinking the storage pool.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * When acquiring memory for a task, the execution pool may need to make multiple</span></span><br><span class="line"><span class="comment">     * attempts. Each attempt must be able to evict storage in case another task jumps in</span></span><br><span class="line"><span class="comment">     * and caches a large block between the attempts. This is called once per attempt.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maybeGrowExecutionPool</span></span>(extraMemoryNeeded: <span class="type">Long</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (extraMemoryNeeded &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// There is not enough free memory in the execution pool, so try to reclaim memory from</span></span><br><span class="line">        <span class="comment">// storage. We can reclaim any free memory from the storage pool. If the storage pool</span></span><br><span class="line">        <span class="comment">// has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim</span></span><br><span class="line">        <span class="comment">// the memory that storage has borrowed from execution.</span></span><br><span class="line">        <span class="keyword">val</span> memoryReclaimableFromStorage = math.max(</span><br><span class="line">          storagePool.memoryFree,</span><br><span class="line">          storagePool.poolSize - storageRegionSize)</span><br><span class="line">        <span class="keyword">if</span> (memoryReclaimableFromStorage &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// Only reclaim as much space as is necessary and available:</span></span><br><span class="line">          <span class="keyword">val</span> spaceToReclaim = storagePool.freeSpaceToShrinkPool(</span><br><span class="line">            math.min(extraMemoryNeeded, memoryReclaimableFromStorage))</span><br><span class="line">          storagePool.decrementPoolSize(spaceToReclaim)</span><br><span class="line">          executionPool.incrementPoolSize(spaceToReclaim)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The size the execution pool would have after evicting storage memory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The execution memory pool divides this quantity among the active tasks evenly to cap</span></span><br><span class="line"><span class="comment">     * the execution memory allocation for each task. It is important to keep this greater</span></span><br><span class="line"><span class="comment">     * than the execution pool size, which doesn&#x27;t take into account potential memory that</span></span><br><span class="line"><span class="comment">     * could be freed by evicting storage. Otherwise we may hit SPARK-12155.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Additionally, this quantity should be kept below `maxMemory` to arbitrate fairness</span></span><br><span class="line"><span class="comment">     * in execution memory allocation across tasks, Otherwise, a task may occupy more than</span></span><br><span class="line"><span class="comment">     * its fair share of execution memory, mistakenly thinking that other tasks can acquire</span></span><br><span class="line"><span class="comment">     * the portion of storage memory that cannot be evicted.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">computeMaxExecutionPoolSize</span></span>(): <span class="type">Long</span> = &#123;</span><br><span class="line">      maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executionPool.acquireMemory(</span><br><span class="line">      numBytes, taskAttemptId, maybeGrowExecutionPool, () =&gt; computeMaxExecutionPoolSize)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>StorageMemoryPool:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Acquire N bytes of storage memory for the given block, evicting existing ones if necessary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param blockId the ID of the block we are acquiring storage memory for</span></span><br><span class="line"><span class="comment"> * @param numBytesToAcquire the size of this block</span></span><br><span class="line"><span class="comment"> * @param numBytesToFree the amount of space to be freed through evicting blocks</span></span><br><span class="line"><span class="comment"> * @return whether all N bytes were successfully granted.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">acquireMemory</span></span>(</span><br><span class="line">    blockId: <span class="type">BlockId</span>,</span><br><span class="line">    numBytesToAcquire: <span class="type">Long</span>,</span><br><span class="line">    numBytesToFree: <span class="type">Long</span>): <span class="type">Boolean</span> = lock.synchronized &#123;</span><br><span class="line">  assert(numBytesToAcquire &gt;= <span class="number">0</span>)</span><br><span class="line">  assert(numBytesToFree &gt;= <span class="number">0</span>)</span><br><span class="line">  assert(memoryUsed &lt;= poolSize)</span><br><span class="line">  <span class="keyword">if</span> (numBytesToFree &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    memoryStore.evictBlocksToFreeSpace(<span class="type">Some</span>(blockId), numBytesToFree, memoryMode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> If the memory store evicts blocks, then those evictions will synchronously call</span></span><br><span class="line">  <span class="comment">// back into this StorageMemoryPool in order to free memory. Therefore, these variables</span></span><br><span class="line">  <span class="comment">// should have been updated.</span></span><br><span class="line">  <span class="keyword">val</span> enoughMemory = numBytesToAcquire &lt;= memoryFree</span><br><span class="line">  <span class="keyword">if</span> (enoughMemory) &#123;</span><br><span class="line">    _memoryUsed += numBytesToAcquire</span><br><span class="line">  &#125;</span><br><span class="line">  enoughMemory</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>853. Car Fleet</title>
      <link href="/2023/09/01/853-Car-Fleet/"/>
      <url>/2023/09/01/853-Car-Fleet/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>There are <code>n</code> cars going to the same destination along a one-lane road. The destination is <code>target</code> miles away.</p><p>You are given two integer array <code>position</code> and <code>speed</code>, both of length <code>n</code>, where <code>position[i]</code> is the position of the <code>ith</code> car and <code>speed[i]</code> is the speed of the <code>ith</code> car (in miles per hour).</p><p>A car can never pass another car ahead of it, but it can catch up to it and drive bumper to bumper <strong>at the same speed</strong>. The faster car will <strong>slow down</strong> to match the slower carâ€™s speed. The distance between these two cars is ignored (i.e., they are assumed to have the same position).</p><p>A <strong>car fleet</strong> is some non-empty set of cars driving at the same position and same speed. Note that a single car is also a car fleet.</p><p>If a car catches up to a car fleet right at the destination point, it will still be considered as one car fleet.</p><p>Return <em>the <strong>number of car fleets</strong> that will arrive at the destination</em>.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input: target = 12, position = [10,8,0,5,3], speed = [2,4,1,1,3]</span><br><span class="line">Output: 3</span><br><span class="line">Explanation:</span><br><span class="line">The cars starting at 10 (speed 2) and 8 (speed 4) become a fleet, meeting each other at 12.</span><br><span class="line">The car starting at 0 does not catch up to any other car, so it is a fleet by itself.</span><br><span class="line">The cars starting at 5 (speed 1) and 3 (speed 3) become a fleet, meeting each other at 6. The fleet moves at speed 1 until it reaches target.</span><br><span class="line">Note that no other cars meet these fleets before the destination, so the answer is 3.</span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Firstly, this problem give me some positions. These position a unsorted. So it is obvious that the first step should be sort these cars by position.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[][] cars=<span class="keyword">new</span> <span class="title class_">int</span>[position.length][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;position.length;i++)&#123;</span><br><span class="line">        cars[i][<span class="number">0</span>]=position[i];</span><br><span class="line">        cars[i][<span class="number">1</span>]=speed[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Arrays.sort(cars,(a,b)-&gt;(a[<span class="number">0</span>]-b[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure><p>And then, after the sort, we can fint that when there are two cars(first are is in i, second is in j, i&lt;j). There are two situations:</p><ol><li>First car need n time unit to array target and second car need m time unit to array target. If n&lt;=m, these two cars will always become a car fleet.</li><li>First car need n time unit to array target and second car need m time unit to array target. If n&gt;m, these two cars will not become a car fleet.</li></ol><p>So, we can use a stack to record car fleets. If a new carâ€™s array time is small than peek in stack, we merge this car into peek fleet. On the contrary, the car can make up a new fleet. I just push this car into stack;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">carFleet</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] position, <span class="type">int</span>[] speed)</span> &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="type">int</span>[][] cars=<span class="keyword">new</span> <span class="title class_">int</span>[position.length][<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;position.length;i++)&#123;</span><br><span class="line">            cars[i][<span class="number">0</span>]=position[i];</span><br><span class="line">            cars[i][<span class="number">1</span>]=speed[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Arrays.sort(cars,(a,b)-&gt;(a[<span class="number">0</span>]-b[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">        List&lt;<span class="type">int</span>[]&gt; stack=<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;cars.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(stack.size()==<span class="number">0</span>)&#123;</span><br><span class="line">                stack.add(cars[i]);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">double</span> time=((target-cars[i][<span class="number">0</span>])*<span class="number">1.0</span>) / (cars[i][<span class="number">1</span>]*<span class="number">1.0</span>);</span><br><span class="line">            <span class="comment">// stack.get(stack.size()-1)[1]</span></span><br><span class="line">            <span class="keyword">while</span>(stack.size()!=<span class="number">0</span> &amp;&amp; ((target-stack.get(stack.size()-<span class="number">1</span>)[<span class="number">0</span>])*<span class="number">1.0</span>) / (stack.get(stack.size()-<span class="number">1</span>)[<span class="number">1</span>]*<span class="number">1.0</span>) &lt;= time)&#123;</span><br><span class="line">                stack.remove(stack.size()-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            stack.add(cars[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stack.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>823. Binary Trees With Factors</title>
      <link href="/2023/08/28/823-Binary-Trees-With-Factors/"/>
      <url>/2023/08/28/823-Binary-Trees-With-Factors/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>Given an array of unique integers, <code>arr</code>, where each integer <code>arr[i]</code> is strictly greater than <code>1</code>.</p><p>We make a binary tree using these integers, and each number may be used for any number of times. Each non-leaf nodeâ€™s value should be equal to the product of the values of its children.</p><p>Return <em>the number of binary trees we can make</em>. The answer may be too large so return the answer <strong>modulo</strong> <code>1^9 + 7</code>.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: arr = [2,4]</span><br><span class="line">Output: 3</span><br><span class="line">Explanation: We can make these trees: [2], [4], [4, 2, 2]</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: arr = [2,4,5,10]</span><br><span class="line">Output: 7</span><br><span class="line">Explanation: We can make these trees: [2], [4], [5], [10], [4, 2, 2], [10, 2, 5], [10, 5, 2].</span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>In this question, itâ€™s easy to find that for each number n, it is a child question which has no connect with what the parent of this number is. So, we can use the memorized dfs to solve this problem.</p><p>In addition, for number n, i assume that this number can be devided into arr[i]*arr[j]; So dfs(n) = dfs(arr[i]) * dis(arr[j]). This is because for each legal child tree with arr[i] as the root, it can be combine with each legal child tree with arr[j] as the root. So, i can sort the arr, and find out all arr[i] and arr[j] pairs. </p><p>There is a important point, when multiply two ints together and storage it into a long. These to Int number may over the limit. So, to get the right ans, i need to transfer in to long firstly. And that make the multiply.</p><p>My solution is as below: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> (<span class="type">int</span>) <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line">    Map&lt;Integer,Integer&gt; con=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numFactoredBinaryTrees</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">      </span><br><span class="line">      Arrays.sort(arr);</span><br><span class="line"></span><br><span class="line">      Set&lt;Integer&gt; arrSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">        arrSet.add(arr[i]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">        ans+=dfs(arr[i],arr,arrSet);</span><br><span class="line">        ans %= mod;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> ans;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> nowNum,<span class="type">int</span>[] arr,Set&lt;Integer&gt; arrSet)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(con.containsKey(nowNum)) <span class="keyword">return</span> con.get(nowNum);</span><br><span class="line">      </span><br><span class="line">      <span class="type">long</span> res=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(arr[i]&gt;=nowNum) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> r=nowNum/arr[i];</span><br><span class="line">        <span class="keyword">if</span>(nowNum==arr[i]*r &amp;&amp; arrSet.contains(r))&#123;</span><br><span class="line">          <span class="comment">//System.out.println(nowNum+&quot;-&gt;&quot;+r+&quot; &quot;+arr[i]); </span></span><br><span class="line">          res+=((<span class="number">1l</span>)*dfs(r,arr,arrSet)) * ((<span class="number">1l</span>)*dfs(arr[i],arr,arrSet));</span><br><span class="line">          res %= mod;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      res %= mod;</span><br><span class="line">      con.put(nowNum,(<span class="type">int</span>)res);</span><br><span class="line">      <span class="comment">//if(res != (int)res) System.out.println(&quot;error&quot;);</span></span><br><span class="line">      <span class="keyword">return</span> (<span class="type">int</span>)res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// s1: sort</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">4 2 2</span></span><br><span class="line"><span class="comment">  4</span></span><br><span class="line"><span class="comment"> /  \</span></span><br><span class="line"><span class="comment">2    2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MapRedece lab</title>
      <link href="/2023/08/27/MapRedece/"/>
      <url>/2023/08/27/MapRedece/</url>
      
        <content type="html"><![CDATA[<h2 id="Why-Map-Reduce"><a href="#Why-Map-Reduce" class="headerlink" title="Why Map Reduce"></a>Why Map Reduce</h2><p>When we need to figure out how many word in a great amount of web pages, the easist way is load file one by one and count up the words in them. The way may very slow and we canâ€™t get the answer  in a resonable time. So, one better solution is load all files into memory, and then count the word in them in one time. But this approach may need a very big memory. Normal computer will not have such a high config in most of time. To balance the conflict of â€œone by oneâ€ and â€œload in on timeâ€, MapReduce algorithm was posted by Jeff Dean when he worked in google.</p><p>The whole process of MapReduce is in the graph below:</p><ol><li>Split files into some small part</li><li>Send these splits to workers, and workers will make the map process</li><li>Map: count up the number of each word in split<ol><li>like this: Word1 number1 Word2 number2 Word1 number3</li></ol></li></ol><p>![](/Users/lhz/Library/Application Support/typora-user-images/æˆªå±2023-08-27 09.42.55.png)</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>test</title>
      <link href="/2023/08/08/test-1/"/>
      <url>/2023/08/08/test-1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/a.png" alt="a"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>WASMEdge Runtime Structure</title>
      <link href="/2023/03/15/WASM-Runtime-Structure/"/>
      <url>/2023/03/15/WASM-Runtime-Structure/</url>
      
        <content type="html"><![CDATA[<p>Questionï¼š</p><p>æ‹·è´æ•°æ®ç²’åº¦é—®é¢˜ï¼š</p><p><strong>Minï¼š</strong>Page ï¼ˆMitosisï¼‰</p><p>Mixtureï¼šé’ˆå¯¹Functionæ¯æ¬¡æ‹·è´å®Œæ•´instanceã€‚é’ˆå¯¹memoryç­‰ï¼Œåˆ™æŒ‰é¡µæ‹·è´ã€‚</p><p>Instanceï¼šæ¯æ¬¡æ‹·è´ä¸€ä¸ªinstanceï¼Œä¾‹å¦‚ä¸€ä¸ªFunctionInstance</p><p>Module ï¼šæ¯æ¬¡æ‹·è´ä¸€ä¸ªmodule</p><p><strong>Max:</strong> .wasm / .so ï¼ˆFaasmï¼‰</p><hr><p><strong>Planï¼š</strong>å…ˆç”¨Tcpåšæµ‹è¯•ï¼Œåšå¥½æ¨¡å—åŒ–ï¼Œæ–¹ä¾¿åé¢æ”¹quicã€‚å…ˆåšNo COW</p><p><strong>Running Nodeï¼š</strong></p><p>1.åœ¨TableInstanceã€FunctionInstanceç­‰.cppæ–‡ä»¶ï¼Œå¢åŠ ååºåˆ—åŒ–åˆå§‹åŒ–å‡½æ•°ï¼ˆåŸå§‹åªæœ‰ä¸€ä¸ªä»Modæ•°æ®åˆå§‹åŒ–çš„å‡½æ•°ï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">instantiate</span>(Module &amp;Mod) <span class="comment">//åŸå§‹åˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line"><span class="built_in">instantiate</span>(String obj)  <span class="comment">//ååºåˆ—åŒ–åˆå§‹åŒ–</span></span><br><span class="line">  </span><br><span class="line"><span class="built_in">instantiate_userfault</span>()  <span class="comment">//userfalutä¼ªåˆå§‹åŒ–</span></span><br><span class="line"><span class="built_in">instantiate_userfault</span>(String obj, fault_ref)  <span class="comment">//userfault handle</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.åœ¨module.cppï¼Œå¢åŠ ä¸€ä¸ªinstantiateå‡½æ•°çš„é‡è½½ï¼Œè¿›è¡Œremoteåˆå§‹åŒ–runtimeã€‚æ­¤instantiateå‡½æ•°ï¼Œè°ƒç”¨ç¬¬1æ¡ä¸­çš„ååºåˆ—åŒ–åˆå§‹åŒ–å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p><p><strong>Memory Nodeï¼š</strong></p><p>3.è®¾è®¡ä¸€ä¸ªâ€œé•œåƒç±»â€ï¼Œç”¨äºâ€é•œåƒâ€å’Œâ€å‚¨å­˜â€åºåˆ—åŒ–åçš„runtimeæ•°æ®ã€‚å¹¶è®¾è®¡ä¸€ä¸ªnetworkæ–¹æ³•ï¼Œç”¨äºç›‘å¬ç½‘ç»œè¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚å‘é€ç›¸åº”çš„runtimeæ•°æ®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;FunctionInstance *&gt; FuncInsts; <span class="comment">// ä¸éœ€è¦postcopy,ç›´æ¥æ‹·è´FuncSecå³å¯</span></span><br><span class="line">std::vector&lt;TableInstance *&gt; TabInsts;     <span class="comment">// ä¸éœ€è¦postcopy,ç›´æ¥æ‹·è´TabSecå³å¯</span></span><br><span class="line">std::vector&lt;MemoryInstance *&gt; MemInsts;    <span class="comment">// éœ€è¦PostCopy</span></span><br><span class="line">std::vector&lt;GlobalInstance *&gt; GlobInsts;   <span class="comment">// ç›´æ¥æ‹·è´ GlobSec</span></span><br><span class="line">std::vector&lt;ElementInstance *&gt; ElemInsts;  <span class="comment">// ç›´æ¥æ‹·è´ ElemSec</span></span><br><span class="line">std::vector&lt;DataInstance *&gt; DataInsts;     <span class="comment">// éœ€è¦PostCopy</span></span><br></pre></td></tr></table></figure><h3 id="No-COW"><a href="#No-COW" class="headerlink" title="No COW"></a>No COW</h3><p>ä¸€æ¬¡æ€§æ‹·è´ï¼šStoreï¼ŒConfã€‚ä¹‹åç›´æ¥æ‰§è¡Œ</p><h3 id="COW"><a href="#COW" class="headerlink" title="COW"></a>COW</h3><p>åªæ‹·è´Confï¼Œæ‹·è´Storeçš„å¤§å°ã€‚ç„¶åè¿›è¡Œuserfaultåˆå§‹åŒ–ã€‚ä¹‹åæ‰§è¡Œï¼Œé‡åˆ°faultï¼Œåˆ™åˆ©ç”¨handleçº¿ç¨‹å¤„ç†</p><h2 id="WASMEdgeåˆ†æ"><a href="#WASMEdgeåˆ†æ" class="headerlink" title="WASMEdgeåˆ†æ"></a>WASMEdgeåˆ†æ</h2><p>1.wasmç›¸å…³æ•°æ®å­˜å‚¨åœ¨Storeä¸­</p><p>2.ä¸€ä¸ªwasmç¨‹åºç”±å¤šä¸ªmodulesç»„æˆ</p><p><strong>å¯åŠ¨æµç¨‹ï¼š</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¾…è¿è¡Œæ–‡ä»¶å¾…è·¯å¾„</span></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> InputPath = std::filesystem::<span class="built_in">absolute</span>(SoName.<span class="built_in">value</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************/</span> </span><br><span class="line"><span class="comment">// æ ¹æ®Configï¼Œåˆå§‹åŒ–VM</span></span><br><span class="line"><span class="comment">// éœ€è¦åŒ…å«å…¨éƒ¨cliå‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function">VM::VM <span class="title">VM</span><span class="params">(Conf)</span></span>;</span><br><span class="line">-&gt; <span class="built_in">unsafeInitVM</span>(); </span><br><span class="line">-&gt; <span class="built_in">unsafeLoadBuiltInHosts</span>();     åŠ è½½ <span class="function">BuiltInModInsts</span></span><br><span class="line"><span class="function"> <span class="title">unsafeRegisterBuiltInHosts</span><span class="params">()</span></span>; ç™»è®° ExecutorEngine.registerModule</span><br><span class="line"> -&gt; <span class="built_in">instantiate</span>(StoreMgr, Mod, Name)</span><br><span class="line"><span class="comment">/*******************/</span> </span><br><span class="line">      </span><br><span class="line"><span class="comment">/*******************/</span>    </span><br><span class="line"><span class="comment">// åˆå§‹åŒ–moduleï¼ŒåŒ…å«TableSecã€FunctionSecç­‰</span></span><br><span class="line"><span class="comment">// æ ¹æ®moduleï¼Œåˆå§‹åŒ–stack</span></span><br><span class="line">      </span><br><span class="line">VM.<span class="built_in">loadWasm</span>(InputPath.<span class="built_in">u8string</span>());</span><br><span class="line">-&gt; LoaderEngine.<span class="built_in">parseModule</span>(Path)</span><br><span class="line">-&gt; FMgr.<span class="built_in">setPath</span>(FilePath)</span><br><span class="line">-&gt; <span class="keyword">module</span>.<span class="built_in">loadModule</span>()                  <span class="comment">//è¯»å–æ–‡ä»¶ï¼Œåˆå§‹åŒ–module </span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ– VM.Mod</span></span><br><span class="line"></span><br><span class="line">VM.<span class="built_in">validate</span>();</span><br><span class="line">-&gt; ValidatorEngine.<span class="built_in">validate</span>(*Mod.<span class="built_in">get</span>())   <span class="comment">//éªŒè¯module</span></span><br><span class="line">                                            <span class="comment">//å³ä¸Šä¸€æ­¥è·å¾—çš„ VM.Mod</span></span><br><span class="line"></span><br><span class="line">VM.<span class="built_in">instantiate</span>();</span><br><span class="line">-&gt; ExecutorEngine.<span class="built_in">instantiateModule</span>(StoreRef, *Mod.<span class="built_in">get</span>())</span><br><span class="line">-&gt; <span class="built_in">instantiate</span>(StoreMgr, Mod)         <span class="comment">//åˆå§‹åŒ–StackManager + åˆå§‹åŒ–moduleä¸­çš„å‚æ•°ï¼ˆå‚è€ƒæ–‡æ¡£ï¼‰</span></span><br><span class="line">-&gt; åˆå§‹åŒ– ActiveModInst                <span class="comment">//åç»­ä½¿ç”¨ActiveModInstè¿›è¡Œå‡½æ•°è°ƒç”¨</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/********************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ,WASI</span></span><br><span class="line">WasiMod-&gt;<span class="built_in">getEnv</span>().<span class="built_in">init</span>(</span><br><span class="line">      Dir.<span class="built_in">value</span>(),</span><br><span class="line">      InputPath.<span class="built_in">filename</span>()</span><br><span class="line">      Args.<span class="built_in">value</span>(), Env.<span class="built_in">value</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–è¾“å…¥å‚æ•°</span></span><br><span class="line">std::vector&lt;ValVariant&gt; FuncArgs;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡Œ</span></span><br><span class="line">VM.<span class="built_in">asyncExecute</span>(FuncName, FuncArgs, FuncArgTypes);</span><br><span class="line">-&gt; ExecutorEngine.<span class="built_in">invoke</span>(*FuncInst, Params, ParamTypes)</span><br><span class="line">-&gt; <span class="built_in">runFunction</span>(StackMgr, FuncInst, Params) </span><br><span class="line">FuncInstæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘Stackä¸­çš„å‡½æ•°ä½ç½®</span><br><span class="line"></span><br><span class="line"><span class="comment">//Endï¼šè¾“å‡ºæ‰§è¡Œç»“æœ</span></span><br></pre></td></tr></table></figure><h2 id="Remote-Migration-steps"><a href="#Remote-Migration-steps" class="headerlink" title="Remote Migration steps"></a>Remote Migration steps</h2><h3 id="Step1-VM-init"><a href="#Step1-VM-init" class="headerlink" title="Step1: VM init"></a>Step1: VM init</h3><p>è¿™ä¸€æ­¥ï¼Œéœ€è¦ä»è¿œç«¯æ‹·è´Confã€‚ç„¶åè¿”åºåˆ—åŒ–Confè¿›è¡Œåˆå§‹åŒ–ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">VM</span>(<span class="type">const</span> Configure &amp;Conf):</span><br><span class="line">  <span class="built_in">Conf</span>(Conf)                                            <span class="comment">// ç»™æœ¬åœ°å˜é‡Confèµ‹å€¼</span></span><br><span class="line">  <span class="built_in">Stage</span>(VMStage::Inited),                               <span class="comment">// é»˜è®¤Initå‚æ•°ï¼Œä¸ç”¨æ”¹</span></span><br><span class="line">  <span class="built_in">LoaderEngine</span>(Conf, &amp;Executor::Executor::Intrinsics),  <span class="comment">// æŠŠConfèµ‹å€¼ç»™LoaderEngine    Loader</span></span><br><span class="line">  <span class="built_in">ValidatorEngine</span>(Conf),                                <span class="comment">// æŠŠConfèµ‹å€¼ç»™ValidatorEngine Validator</span></span><br><span class="line">  <span class="built_in">ExecutorEngine</span>(Conf, &amp;Stat),                          <span class="comment">// æŠŠConfèµ‹å€¼ç»™ExecutorEngine  Executor</span></span><br><span class="line">  <span class="built_in">Store</span>(std::<span class="built_in">make_unique</span>&lt;Runtime::StoreManager&gt;()),     <span class="comment">// æŠŠStoreèµ‹å€¼ä¸ºæ–°å®ä¾‹åŒ–çš„StoreManager</span></span><br><span class="line">  <span class="built_in">StoreRef</span>(*Store.<span class="built_in">get</span>())                                <span class="comment">// æŠŠStoreRefèµ‹å€¼ä¸ºStoreçš„æŒ‡é’ˆ</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">unsafeLoadBuiltInHosts</span>();                           <span class="comment">// åŠ è½½Wasiï¼Ÿ</span></span><br><span class="line">    <span class="built_in">unsafeRegisterBuiltInHosts</span>();                       <span class="comment">// åœ¨ExecutorEngineå­˜å‚¨ï¼ŒStoreRefå’ŒWASIå¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Stpe2-Module-amp-Stack-init"><a href="#Stpe2-Module-amp-Stack-init" class="headerlink" title="Stpe2: Module &amp; Stack init"></a>Stpe2: Module &amp; Stack init</h3><p>å°†ä»¥ä¸‹ä¸‰æ­¥ï¼šVM.loadWasm() -&gt; VM.validate() -&gt; VM.instantiate()</p><p>ç”±æœ¬åœ°è¯»å–æ–‡ä»¶ä»è€Œå®ä¾‹åŒ–moduleï¼Œæ”¹ä¸ºäº‘ç«¯è·å–ã€‚éœ€è¦æ‹·è´å¾ˆå¤šä¸ªç»†å°çš„å˜é‡ï¼Œä¸€ä¸ªéƒ½ä¸èƒ½æ¼æ‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®ä¾‹åŒ– VM.Mod </span></span><br><span class="line"> <span class="comment">// 1.Postcopy VM.Mod</span></span><br><span class="line"> <span class="comment">// 2.ä¿®æ”¹Stage Stage = VMStage::Loaded</span></span><br><span class="line">VM.<span class="built_in">loadWasm</span>(InputPath.<span class="built_in">u8string</span>());</span><br><span class="line"></span><br><span class="line"> <span class="comment">// éªŒè¯VM.Mod</span></span><br><span class="line"> <span class="comment">// 1.ä¿®æ”¹Stage</span></span><br><span class="line">VM.<span class="built_in">validate</span>();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//  Stage = VMStage::Instantiated;</span></span><br><span class="line"> <span class="comment">//  å®ä¾‹åŒ– ActiveModInst</span></span><br><span class="line"> <span class="comment">// 1.Postcopy StoreRef            (StoreMgr.registerModule)   åˆå§‹åŒ– StoreRefä¸­çš„å‚æ•°ï¼Œ</span></span><br><span class="line"> <span class="comment">//                                                            NamedModï¼Œä¸€ä¸ªmapï¼Œå‚¨å­˜äº†æ‰€æœ‰Module</span></span><br><span class="line"> <span class="comment">// 2.Postcopy StackMgr            (StackManager StackMgr)     å®Œæ•´çš„è¿›è¡Œååºåˆ—åŒ–ï¼ˆå¯èƒ½ä¸ç”¨æ‹·è´å®é™…ä¸Šï¼‰</span></span><br><span class="line"> <span class="comment">// 3.Postcopy ActiveModInst       (ActiveModInst)             å®Œæ•´çš„è¿›è¡Œååºåˆ—åŒ–</span></span><br><span class="line"> <span class="comment">//                                                            (è¿™ä¸ªå‚æ•°å®é™…ä¸ŠStoreä¸­å·²ç»åŒ…å«ï¼Œå› æ­¤å¯èƒ½ä¸éœ€è¦æ‹·è´)</span></span><br><span class="line">VM.<span class="built_in">instantiate</span>();</span><br></pre></td></tr></table></figure><p>No COWï¼šéœ€è¦ä»è¿œç«¯æ‹·è´moduleï¼Œç›´æ¥ååºåˆ—åŒ–</p><p>COWï¼šå…ˆå‡åˆå§‹åŒ–ï¼Œé‡åˆ°äº†page faultå†ä»è¿œç«¯æ‹·è´</p><p><strong>å‚è€ƒï¼š</strong></p><p>moduleæœ¬åœ°åŠ è½½å®ç°ï¼š<strong>lib/loader/ast/module.cpp</strong></p><p>moduleå®šä¹‰ï¼š <strong>include/ast/module.h</strong></p><p>StoreMgrã€moduleInstanceåˆå§‹åŒ–ï¼š<strong>lib/executor/instantiate/module.cpp</strong><br>                                                            lib/executor/instantiate/data.cpp</p><h3 id="moduleInstanceå®ä¾‹åŒ–"><a href="#moduleInstanceå®ä¾‹åŒ–" class="headerlink" title="moduleInstanceå®ä¾‹åŒ–"></a>moduleInstanceå®ä¾‹åŒ–</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰</span></span><br><span class="line">std::unique_ptr&lt;Runtime::Instance::ModuleInstance&gt; ModInst;</span><br><span class="line"></span><br><span class="line">ModInst = std::<span class="built_in">make_unique</span>&lt;Runtime::Instance::ModuleInstance&gt;(Name.<span class="built_in">value</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ– FuncType</span></span><br><span class="line">ModInst-&gt;<span class="built_in">addFuncType</span>(FuncType);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ImportSec</span></span><br><span class="line">AST::ImportSection &amp;ImportSec = Mod.<span class="built_in">getImportSection</span>();</span><br><span class="line"><span class="built_in">instantiate</span>(StoreMgr, *ModInst, ImportSec)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//åˆå§‹åŒ–FuncSecï¼ŒCodeSec</span></span><br><span class="line"><span class="type">const</span> AST::FunctionSection &amp;FuncSec = Mod.<span class="built_in">getFunctionSection</span>();</span><br><span class="line"><span class="type">const</span> AST::CodeSection &amp;CodeSec = Mod.<span class="built_in">getCodeSection</span>();</span><br><span class="line"><span class="built_in">instantiate</span>(*ModInst, FuncSec, CodeSec);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ– TabSec</span></span><br><span class="line">AST::TableSection &amp;TabSec = Mod.<span class="built_in">getTableSection</span>();</span><br><span class="line"><span class="built_in">instantiate</span>(*ModInst, TabSec);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ– MemSec</span></span><br><span class="line"><span class="type">const</span> AST::MemorySection &amp;MemSec = Mod.<span class="built_in">getMemorySection</span>();</span><br><span class="line"><span class="built_in">instantiate</span>(*ModInst, MemSec);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// åˆå§‹åŒ– GlobSec</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ExportSec</span></span><br><span class="line"><span class="type">const</span> AST::ExportSection &amp;ExportSec = Mod.<span class="built_in">getExportSection</span>();</span><br><span class="line"><span class="built_in">instantiate</span>(*ModInst, ExportSec);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ElemSec</span></span><br><span class="line"><span class="built_in">instantiate</span>(StackMgr, *ModInst, ElemSec)</span><br><span class="line">  </span><br><span class="line"><span class="comment">//åˆå§‹åŒ–   DataSec</span></span><br><span class="line"><span class="built_in">instantiate</span>(StackMgr, *ModInst, DataSec)</span><br><span class="line">  </span><br></pre></td></tr></table></figure><hr><p><a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-16%2011.32.20.png" alt="æˆªå±2023-03-16 11.32.20"></p><p><a href="https://juejin.cn/post/6844904062148689933">https://juejin.cn/post/6844904062148689933</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Best Time to Buy and Sell Stock</title>
      <link href="/2023/03/15/Best-Time-to-Buy-and-Sell-Stock/"/>
      <url>/2023/03/15/Best-Time-to-Buy-and-Sell-Stock/</url>
      
        <content type="html"><![CDATA[<h2 id="Question-1"><a href="#Question-1" class="headerlink" title="Question 1"></a>Question 1</h2><p>You are given an integer array prices where prices[i] is the price of a given stock on the i^th day.</p><p>On each day, you may decide to buy and/or sell the stock. You can only hold at most one share of the stock at any time. However, you can buy it then immediately sell it on the same day.</p><p>Find and return the maximum profit you can achieve.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input: prices = [7,1,5,3,6,4]</span><br><span class="line">Output: 7</span><br><span class="line">Explanation: Buy on day 2 (price = 1) and sell on day 3 (price = 5), profit = 5-1 = 4.</span><br><span class="line">Then buy on day 4 (price = 3) and sell on day 5 (price = 6), profit = 6-3 = 3.</span><br><span class="line">Total profit is 4 + 3 = 7.</span><br></pre></td></tr></table></figure><h3 id="Solution-01"><a href="#Solution-01" class="headerlink" title="Solution 01"></a>Solution 01</h3><p>dp(i,0) mains that the max profit i can get when i have no stock in day_i;<br>dp(i,1) mains that the max profit i can grt when i have a stock in day_i;</p><p>So,i can get this equationï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp[i][0]=max&#123;dp[iâˆ’1][0],dp[iâˆ’1][1]+prices[i]&#125;</span><br><span class="line">dp[i][1]=max&#123;dp[iâˆ’1][1],dp[iâˆ’1][0]âˆ’prices[i]&#125;</span><br></pre></td></tr></table></figure><p>The time complexity of the solution is o(n).</p><h3 id="Solution-02"><a href="#Solution-02" class="headerlink" title="Solution 02"></a>Solution 02</h3><p>For this example: [1,2,3]. It is obvious that i need to buy stock on day_1 and sell it on day_3. However i can do this:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">day 1: buy</span><br><span class="line">day 2: sell and buy; profit: 1</span><br><span class="line">day 3: sell; profit: 1</span><br><span class="line">Total profit:2</span><br></pre></td></tr></table></figure><p>The profit of this choice is the same as only buying and selling for one time. So i can get the ans by calculating all increasing subsequence.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ans=SUM&#123; prices[i]-prices[i-1] &#125; (prices[i] &gt; prices[i-1])</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Postcopy &amp; user-fault &amp; WASM</title>
      <link href="/2023/03/08/User-space-page-fault-handling/"/>
      <url>/2023/03/08/User-space-page-fault-handling/</url>
      
        <content type="html"><![CDATA[<h2 id="Migration-of-WebAssembly-runtime-by-Postcopy"><a href="#Migration-of-WebAssembly-runtime-by-Postcopy" class="headerlink" title="Migration of WebAssembly runtime by Postcopy"></a>Migration of WebAssembly runtime by Postcopy</h2><p>User space page faultåœ¨Live migration of virtual machineså·²ç»æœ‰å¤§é‡è¿ç”¨ï¼ˆKVMï¼ŒOpenStackï¼ŒCRIU Lazy migrationï¼‰ï¼Œè¿™ä¸€æ€è·¯è¢«ç§°ä¸ºPostcopyã€‚ç›®å‰å°šæœªå‘ç°è¿™ä¸€æŠ€æœ¯åº”ç”¨äºWASM runtimeçš„çŠ¶æ€è¿ç§»ã€‚ç»“åˆMitosisçš„å…ˆä¾‹ï¼Œæˆ–è®¸PostcopyæŠ€æœ¯å¯ä»¥è‰¯å¥½çš„ä¸WASM runtimeç»“åˆï¼Œä»è€Œå®ç°å¯ä»¥å¿«é€Ÿå¤§é‡å¯åŠ¨å®ä¾‹çš„Serverlesså¹³å°ã€‚</p><p>ï¼ˆç›®å‰åªæ‰¾åˆ°äº†ä¸€ç¯‡21å¹´çš„è®ºæ–‡ï¼Œå…¶ä¸­æåˆ°äº†ä»–ä»¬è®¡åˆ’ç»“åˆPostcopy+wasmåšè¾¹ç¼˜è®¡ç®—ã€‚ä½†æ˜¯ä»–ä»¬ç›®å‰è¿˜æ²¡æœ‰å‘è¡¨ç›¸å…³åç»­è¿›å±•ï¼Œä¸çŸ¥é“æ˜¯å› ä¸ºä»–ä»¬æ²¡æœ‰ç»§ç»­æ·±å…¥ï¼Œè¿˜æ˜¯é‡åˆ°äº†éšœç¢ï¼‰</p><h2 id="è®¾è®¡æ–¹æ¡ˆ"><a href="#è®¾è®¡æ–¹æ¡ˆ" class="headerlink" title="è®¾è®¡æ–¹æ¡ˆ"></a>è®¾è®¡æ–¹æ¡ˆ</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-10%2010.34.24.png" alt="æˆªå±2023-03-10 10.34.24"></p><p>Stepsï¼š</p><ol><li>Running nodeå¯åŠ¨ï¼Œä»Memory nodeè·å–é™¤å†…å­˜å¤–çš„å…¨éƒ¨æ•°æ®</li><li>Running nodeåˆå§‹åŒ–è™šæ‹Ÿæœºå†…å­˜ï¼ˆä¸è¿›è¡Œæ˜ å°„ï¼‰ï¼Œå°†è¿™äº›å†…å­˜æ ‡è®°ä¸ºuserfault</li><li>Running nodeè¿è¡Œï¼Œè‹¥accessåˆ°äº†æœªè¢«åˆ†é…çš„pageï¼Œåˆ™è§¦å‘page fault</li><li>å†…æ ¸è¯†åˆ«åˆ°è¯¥é¡µä¸ºuserfault pageï¼Œå°†å‘ç”Ÿé”™è¯¯çš„åœ°å€å‘é€ç»™ç”¨æˆ·æ€çš„handle</li><li>handleä½¿ç”¨XQUICè·å–Memory nodeä¸­ç›¸åº”çš„pageï¼Œåˆå§‹åŒ–è¯¥page</li><li>WASM runtimeè¢«å”¤é†’ï¼Œç»§ç»­è¿è¡Œ</li></ol><p>ç»“åˆPostcopy+WASMæŠ€æœ¯ï¼Œåº”è¯¥å¯ä»¥å®ç°ä¼˜äºåŸç”ŸFaasmï¼Œä¼˜äºCRIUï¼Œä½†æ…¢äºMITOSISçš„ä¸€ç§å¯åŠ¨ç­–ç•¥ã€‚åŒæ—¶è¿™ä¸€ç­–ç•¥ä¼šæ¯”MITOSISæœ‰æ›´å¥½çš„é€šç”¨æ€§ã€‚</p><p>æ­¤å¤–ï¼ŒPostcopy+WASMæ¯”èµ·Mitosiså’ŒCRIUè¿™ç±»â€œå®¹å™¨è¿ç§»â€å·¥å…·æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œè¿™ä¸¤ç§æŠ€æœ¯åœ¨è¿ç§»å®¹å™¨çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¸å¯é¿å…å¸¦æœ‰ä¸€äº›â€œæ­»é‡â€ï¼Œå³å®¹å™¨æœ¬èº«è¿è¡Œæ—¶ç›¸å…³çš„ä¸Šä¸‹æ–‡ã€‚è€ŒPostcopy+WASMåªéœ€åŠ¨æ€è¿ç§»å’Œç¨‹åºè´Ÿè½½æœ¬èº«ç›¸å…³çš„Pageï¼Œå› æ­¤æˆ–è®¸å¯ä»¥åœ¨ä¸€å®šæ¡ä»¶ä¸‹å–å¾—ä¸€å®šä¼˜åŠ¿ã€‚</p><p>Follow Upï¼š</p><p>1.ç”±äºWASMè™šæ‹Ÿæœºå†…ï¼Œå„ç§æ¨¡å—å¤§å°å·²çŸ¥ï¼Œæˆ–è®¸å¯ä»¥æ ¹æ®è¿™ä¸ªåšä¸€äº›è§„åˆ’ç®—æ³•</p><p>2.å°†éƒ¨åˆ†å·¥ä½œæ”¾å…¥eBPFè™šæ‹Ÿæœºï¼Œä»è€Œå®ç°åŠ é€Ÿ</p><h2 id="æ¨¡æ‹Ÿæµ‹è¯•"><a href="#æ¨¡æ‹Ÿæµ‹è¯•" class="headerlink" title="æ¨¡æ‹Ÿæµ‹è¯•"></a>æ¨¡æ‹Ÿæµ‹è¯•</h2><p>ä»£ç ä»“åº“ï¼š<a href="https://github.com/muchengl/userfault-test.git">https://github.com/muchengl/userfault-test.git</a></p><p>ç¼–å†™ä»£ç è¿›è¡Œæ¨¡æ‹Ÿæµ‹è¯•ï¼Œæœ¬ä»£ç åˆ†ä¸ºServerç«¯å’ŒClientç«¯ã€‚Serverç«¯å¯¹åº”Memory Nodeï¼ŒClientç«¯å¯¹åº”Running Nodeã€‚</p><p><strong>Serverç«¯</strong>ä½¿ç”¨mallocç”³è¯·å†…å­˜ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚<strong>Clientç«¯</strong>ä½¿ç”¨mmapåˆå§‹åŒ–å†…å­˜ï¼Œå°†fdå‚æ•°è®¾ç½®ä¸º-1ï¼Œä»è€Œè·å¾—å¤§é‡æœªè¢«æ˜ å°„çš„å†…å­˜ã€‚å¹¶å°†è¿™äº›å†…å­˜æ ‡è®°ä¸ºUFFD_EVENT_PAGEFAULTï¼Œå³å†…æ ¸åº”å°†è¯¥å†…å­˜çš„Page faultäº¤ç»™ç”¨æˆ·å¤„ç†ã€‚Clientç«¯å¼€å¯ä¸€ä¸ªfaultè§¦å‘çº¿ç¨‹ï¼Œä¸æ–­æŒ‰é¡ºåºaccess pageï¼Œè§¦å‘page faultã€‚clientç«¯ç›‘å¬æè¿°ç¬¦uffdï¼Œè·å–å†…æ ¸ä¼ æ¥çš„user faultä¿¡æ¯ï¼Œå¹¶é€šè¿‡udpåè®®ï¼Œä»serverç«¯è·å–ç›¸åº”çš„pageï¼Œè¿›è¡Œå†…å­˜åˆå§‹åŒ–ã€‚</p><p>åœ¨ä¸¤å°Ali Cloudäº‘æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œæµ‹è¯•ï¼ŒUnuntu 20.04ç³»ç»Ÿï¼Œ1Gå†…å­˜ï¼Œ2æ ¸CPUï¼Œåœ¨åŒä¸€è™šæ‹Ÿå­ç½‘å†…ä½¿ç”¨UDPè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œæ¯ç»„æµ‹é‡è¿›è¡Œ10æ¬¡ï¼Œå–CPUè¿è¡Œæ—¶é—´çš„å¹³å‡å€¼ã€‚å¯ä»¥å‘ç°ï¼Œè¿œç¨‹æ‹·è´æ€»æ—¶é—´ä¸é¡µæ•°å‘ˆæ­£æ¯”ã€‚åœ¨æ‹·è´å†…å­˜ä¸º100Mæ—¶ï¼ˆ25000é¡µï¼‰ï¼Œè¾ƒä¼˜æƒ…å†µä¸‹éœ€è¦çº¦0.97ç§’çš„æ—¶é—´ã€‚</p><table><thead><tr><th align="center">å­—æ®µåç§°</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">Fault process time</td><td align="center">Faultè§¦å‘çº¿ç¨‹çš„æ€»è¿è¡Œæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è´Ÿè½½ä»£ç çš„å®é™…è¿è¡Œæ—¶é—´</td></tr><tr><td align="center">Init time</td><td align="center">Clientç«¯åˆå§‹åŒ–æ—¶é—´</td></tr><tr><td align="center">IO time</td><td align="center">ç­‰å¾…å†…æ ¸é€šè¿‡fdä¼ è¾“User Faultç›¸å…³ä¿¡æ¯çš„æ—¶é—´ï¼ˆpollè½®è¯¢ï¼‰</td></tr><tr><td align="center">Network time</td><td align="center">UDPåè®®é€šä¿¡æ—¶é—´</td></tr><tr><td align="center">Server time</td><td align="center">Serverç«¯è·å–pageï¼Œå¹¶é€šè¿‡UDPå‘é€çš„æ—¶é—´</td></tr><tr><td align="center">Handle time</td><td align="center">è·å–åˆ°è¿œç¨‹é¡µåï¼Œåˆå§‹åŒ–å†…å­˜ï¼Œå¹¶å¯¹è¿œç¨‹é¡µä¸­çš„æ•°æ®è¿›è¡Œæ‹·è´çš„æ—¶é—´</td></tr><tr><td align="center">Total time</td><td align="center">Total time=Network + Server + Handle + IO + Init<br />ç”¨äºè¯æ˜Networkã€Serverã€Handleã€IOã€Initå¯ä»£è¡¨æ•´ä¸ªè¿è¡Œæµç¨‹</td></tr></tbody></table><p>ç»è®¡ç®—ï¼šFault process time â‰ˆ Total time</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2014.03.01.png" alt="æˆªå±2023-03-13 14.03.01"></p><p>æ•°æ®åˆ†æå’Œæ€»ç»“ï¼š</p><ul><li><p>Networkå ç”¨äº†çº¦7%çš„æ—¶é—´ï¼ŒçœŸå®ç¯å¢ƒä¸‹ç”±äºä¸ä¼šä½¿ç”¨UDPï¼Œè¿™ä¸€æ—¶é—´å æ¯”å¯èƒ½ä¼šæ›´å¤§ã€‚</p></li><li><p>IO timeå æ¯”è¾ƒå¤§ï¼Œä¸º53%ï¼Œè¿™ä¸€æ—¶é—´åœ¨æœ¬åœ°è™šæ‹Ÿæœºæµ‹è¯•ä¸­æ˜¾è‘—é™ä½ï¼Œå› æ­¤æˆ–ä¸CPUæ€§èƒ½æœ‰è¾ƒå¤§å…³ç³»ã€‚</p><p>  (æœ¬æµ‹è¯•ä¸­ï¼Œä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„ç©å…·çº§æœåŠ¡å™¨ï¼Œcpuä¸»é¢‘å’Œå†…å­˜è¯»å†™é€Ÿåº¦å¯èƒ½è¢«é™åˆ¶äº†)</p></li><li><p>æ•°æ®è¯»å–å’Œæ‹·è´éƒ¨åˆ†ï¼ˆServerã€Handleï¼‰ï¼Œå ç”¨äº†40%å·¦å³çš„æ—¶é—´ã€‚å¯¹æ¯”MITOSISï¼Œmisosisä½¿ç”¨rdmaé¿å…äº†åœ¨serverç«¯çš„å†…å­˜æ‹·è´ï¼Œå› æ­¤ä¼šæ…¢äºmisosisã€‚</p></li><li><p>æœ¬æµ‹è¯•ä¸­ï¼Œæµ‹è¯•è´Ÿè½½ä¸ºâ€œæŒ‰é¡ºåºè®¿é—®å†…å­˜â€ï¼Œè¿™ä¸€æµ‹è¯•ä¸çœŸå®ç¯å¢ƒæœ‰è¾ƒå¤§åŒºåˆ«ï¼Œå› æ­¤ä¸èƒ½ä»£è¡¨å°†Postcopyå®é™…å¼•å…¥wasmåçš„å®é™…æ€§èƒ½ã€‚</p></li></ul><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2011.30.41.png" alt="æˆªå±2023-03-13 11.30.41"></p><p>é™„æ•°æ®ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2012.37.29.png" alt="æˆªå±2023-03-13 12.37.29"></p><h2 id="èµ„æ–™æ”¶é›†"><a href="#èµ„æ–™æ”¶é›†" class="headerlink" title="èµ„æ–™æ”¶é›†"></a>èµ„æ–™æ”¶é›†</h2><p>User space page fault handlingç›¸å…³æ—©æœŸæ–‡ç« ï¼š<br><a href="https://lwn.net/Articles/550555/">https://lwn.net/Articles/550555/</a><br><a href="https://lwn.net/Articles/615086/">https://lwn.net/Articles/615086/</a></p><h3 id="PostcopyåŸå§‹è®ºæ–‡ï¼š"><a href="#PostcopyåŸå§‹è®ºæ–‡ï¼š" class="headerlink" title="PostcopyåŸå§‹è®ºæ–‡ï¼š"></a>PostcopyåŸå§‹è®ºæ–‡ï¼š</h3><p><a href="https://kartikgopalan.github.io/publications/hines09postcopy.pdf">https://kartikgopalan.github.io/publications/hines09postcopy.pdf</a></p><h3 id="CRIU-Lazy-migration"><a href="#CRIU-Lazy-migration" class="headerlink" title="CRIU Lazy migration:"></a>CRIU Lazy migration:</h3><p><a href="https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers">https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers</a><br><a href="https://criu.org/Lazy_migration">https://criu.org/Lazy_migration</a><br><a href="https://lisas.de/~adrian/pdf/lazy-process-migration.pdf">https://lisas.de/~adrian/pdf/lazy-process-migration.pdf</a></p><h3 id="Postcopyåœ¨kvmçš„åº”ç”¨ï¼š"><a href="#Postcopyåœ¨kvmçš„åº”ç”¨ï¼š" class="headerlink" title="Postcopyåœ¨kvmçš„åº”ç”¨ï¼š"></a>Postcopyåœ¨kvmçš„åº”ç”¨ï¼š</h3><p><a href="https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja">https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2022.10.22.png" alt="æˆªå±2023-03-09 22.10.22"></p><p>RedHatåœ¨KVMè¿ç§»ä¸­çš„å®è·µpptï¼š<br><a href="http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf">http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf</a><br><a href="https://wiki.qemu.org/Features/PostCopyLiveMigration">https://wiki.qemu.org/Features/PostCopyLiveMigration</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2017.42.42.png" alt="æˆªå±2023-03-09 17.42.42"></p><ol><li>çº¿ç¨‹1è®¿é—®äº†ä¸€ä¸ªæœªè¢«æ˜ å°„çš„pageï¼Œå‘ç”Ÿuserfault<br> get_user_pages_locked()<br> get_user_pages_unlocked()<br> è¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥é¿å…å†…æ ¸å¤„ç†faultï¼Œè€Œæ˜¯äº¤ç»™ç”¨æˆ·çº¿ç¨‹å¤„ç†</li><li>çº¿ç¨‹2æ”¶åˆ°å†…æ ¸çš„é€šçŸ¥â€”â€”userfaultåœ¨æŸä¸ªåœ°å€è¢«è§¦å‘äº†</li><li>çº¿ç¨‹2å°†æ­¤pageä»â€œmemory nodeâ€ä¼ è¾“è¿‡æ¥ï¼ˆè¿™å’Œmitosisçš„â€œseedâ€å¾ˆç±»ä¼¼ï¼‰</li><li>çº¿ç¨‹2å°†å‘ç”Ÿé”™è¯¯çš„pageè¿›è¡Œæ˜ å°„<br> remap_anon_pages()</li><li>çº¿ç¨‹2å‘ŠçŸ¥å†…æ ¸ï¼Œå†…æ ¸å”¤é†’çº¿ç¨‹1</li><li>çº¿ç¨‹1å°è¯•è®¿é—®fault pageï¼Œå¹¶ç»§ç»­æ‰§è¡Œä¸‹å»</li></ol><h3 id="Ubuntuå¯¹userfaultfdçš„æ”¯æŒ"><a href="#Ubuntuå¯¹userfaultfdçš„æ”¯æŒ" class="headerlink" title="Ubuntuå¯¹userfaultfdçš„æ”¯æŒ"></a>Ubuntuå¯¹userfaultfdçš„æ”¯æŒ</h3><p><a href="https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html">https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/flow.png" alt="img"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ChatRepo handbook</title>
      <link href="/2023/03/07/ChatRepo-handbook/"/>
      <url>/2023/03/07/ChatRepo-handbook/</url>
      
        <content type="html"><![CDATA[<h1 id="chatrepo"><a href="#chatrepo" class="headerlink" title="chatrepo"></a>chatrepo</h1><p>Chat with your github repo with ChatGPT in Github Actions</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-08%2016.20.01.png&quot; width = 800 /&gt; &lt;/div&gt;</span><br></pre></td></tr></table></figure><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ChatRepoï¼ŒåŸºäºChatGPTï¼Œä½¿ç”¨Github app + Probot + Vercelæ„å»ºã€‚</p><h3 id="1ï¼‰å¹³å°æ•´ä½“è¿è¡Œé€»è¾‘"><a href="#1ï¼‰å¹³å°æ•´ä½“è¿è¡Œé€»è¾‘" class="headerlink" title="1ï¼‰å¹³å°æ•´ä½“è¿è¡Œé€»è¾‘"></a>1ï¼‰å¹³å°æ•´ä½“è¿è¡Œé€»è¾‘</h3><ol><li>é…ç½®å¥½git app</li><li>ç”¨æˆ·æäº¤issue</li><li>ä»“åº“è§¦å‘appè¿è¡Œ</li><li>appå‘æŒ‡å®šçš„webhookç‚¹ï¼Œå‘ç”¨æˆ·çš„isseuç›¸å…³å‚æ•°</li><li>vercel serverlesså¹³å°å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹è®¡ç®—</li><li>æœ€åæŠŠç”Ÿæˆçš„ç­”æ¡ˆå†™å›issue</li></ol><div align="center"> <img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.05.png" width = 800 /> </div><h3 id="2ï¼‰å¼€å‘è€…æµ‹é€»è¾‘"><a href="#2ï¼‰å¼€å‘è€…æµ‹é€»è¾‘" class="headerlink" title="2ï¼‰å¼€å‘è€…æµ‹é€»è¾‘"></a>2ï¼‰å¼€å‘è€…æµ‹é€»è¾‘</h3><div align="center"> <img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.14.png" width = 700 /> </div><p>å¯¹äºå¼€å‘è€…ï¼Œä¸ºäº†æ­å»ºChatRepoå¹³å°ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li><p>ç”³è¯·ä¸€ä¸ªGit Appï¼Œgit appåªæœ‰å…¬å¼€å’Œç§æœ‰ä¸¤ç§é€‰é¡¹ã€‚ç”±äºchatrepoå«æœ‰chatGPT tokenï¼Œå› æ­¤ä¸èƒ½å…¬å¼€ï¼Œåªèƒ½ç§æœ‰ç”³è¯·ä¸€ä¸ªï¼ˆæ­¤å¤„webhookéšä¾¿å¡«ä¸€ä¸ªï¼‰ã€‚<br><a href="https://github.com/settings/apps/new">https://github.com/settings/apps/new</a></p></li><li><p>åˆ›å»ºChatRepoä»“åº“ï¼Œé‡Œé¢æ”¾ChatRepoä»£ç ï¼ˆè¿™ä¸ªæˆ‘ä»¬å·²ç»æœ‰äº†ï¼‰</p></li><li><p>åœ¨vercelå¹³å°ï¼Œä»githubå¯¼å…¥ChatRepoä»“åº“ï¼Œåç»­è¯¥å¹³å°ä¼šè‡ªåŠ¨æ„å»º<br> <a href="https://vercel.com/new">https://vercel.com/new</a></p></li><li><p>æ­¤æ—¶ï¼ŒChatRepoæ²¡æœ‰ä»»ä½•éšç§æ•°æ®ï¼ˆGit Appçš„å¯†é’¥å’ŒchatGPT tokenï¼‰ï¼Œå› æ­¤éœ€è¦åœ¨vercelå¹³å°çš„ç¯å¢ƒå˜é‡é‡ŒåŠ å…¥ï¼š</p></li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.24.53.png" alt="æˆªå±2023-03-07 20.24.53"></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.25.13.png" alt="æˆªå±2023-03-07 20.25.13"><br>5. é‡å¯vercelå¹³å°ä¸Šçš„æœåŠ¡ï¼Œè½½å…¥ç¯å¢ƒå˜é‡</p><ol start="6"><li>åœ¨Git Appé…ç½®é¡µé¢ä¿®æ”¹Appçš„æƒé™ï¼š<br><a href="https://github.com/settings/apps/[your">https://github.com/settings/apps/[your</a> app name]/permissions</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æŠŠè¿™å‡ é¡¹è®¾ç½®ä¸ºå¯è¯»å†™ï¼š</span><br><span class="line">Commit statuses</span><br><span class="line">Contents</span><br><span class="line">Discussions</span><br><span class="line">Issues</span><br></pre></td></tr></table></figure><p>åœ¨äº‹ä»¶å¤„ï¼Œå‹¾é€‰ä»¥ä¸‹äº‹ä»¶ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.28.55.png" alt="æˆªå±2023-03-07 20.28.55"></p><ol start="7"><li>æ­¤æ—¶Vercelå¹³å°ä¼šåˆ†é…ä¸€ä¸ªDominï¼Œå°†appçš„webhookè®¾ç½®ä¸ºï¼š<pre><code> domin+/api/github/webhooks</code></pre></li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.36.20.png" alt="æˆªå±2023-03-07 20.36.20"><br>åº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ä¸€ä¸ªé“¾æ¥ï¼š<a href="https://chatbot-rosy.vercel.app/api/github/webhooks">https://chatbot-rosy.vercel.app/api/github/webhooks</a></p><ol start="8"><li><p>å®‰è£…Git Appï¼Œé€‰æ‹©éœ€è¦ChatRepoçš„ä»“åº“<br><a href="https://github.com/settings/apps/[your">https://github.com/settings/apps/[your</a> app name]/installations</p></li><li><p>åœ¨ä»“åº“æ–°å»ºä¸€ä¸ªissueï¼Œè¿›è¡Œæµ‹è¯•ã€‚å¦‚æœä¸€åˆ‡æ— è¯¯ï¼Œåˆ™å¯ä»¥çœ‹åˆ°CharRepoä¸Šçº¿è‡ªåŠ¨å›ç­”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ ¼å¼ï¼š</span><br><span class="line">/Bot xxxxx</span><br><span class="line">å’Œchat gpaæ™®é€šèŠå¤©</span><br><span class="line">/chatrepo xxxxx</span><br><span class="line">è¯¢é—®charrepoä»“åº“ç›¸å…³é—®é¢˜</span><br></pre></td></tr></table></figure></li></ol><h2 id="3-å¼€å‘è€…æ¨¡å¼"><a href="#3-å¼€å‘è€…æ¨¡å¼" class="headerlink" title="3) å¼€å‘è€…æ¨¡å¼"></a>3) å¼€å‘è€…æ¨¡å¼</h2><p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ­å»ºä¸€ä¸ªæœ¬åœ°å¼€å‘ç¯å¢ƒï¼š</p><p>å‚è€ƒï¼š<a href="https://probot.github.io/docs/development/#running-the-app-locally">https://probot.github.io/docs/development/#running-the-app-locally</a></p><p>1.ç¯å¢ƒåˆå§‹åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><p>2.æ ¹æ®æç¤ºï¼Œè®¿é—®localhost:3000</p><p>3.æ ¹æ®æŒ‡ç¤ºåˆ›å»ºä¸€ä¸ªæ–°çš„Git App</p><p>4.æ­¤æ—¶ï¼Œprebotä¼šåˆ›å»ºä¸€ä¸ª.envæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GPT_KEY= [your chatGPT token]</span><br></pre></td></tr></table></figure><p>ä¸è¦å°†æ­¤æ–‡ä»¶ä¸Šä¼ åˆ°git</p><p>5.å‚è€ƒç¬¬äºŒç« ï¼Œè®¾ç½®appæƒé™ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªrepoå®‰è£…è¯¥app</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1653. Minimum Deletions to Make String Balanced</title>
      <link href="/2023/03/05/lc1653-Minimum-Deletions-to-Make-String-Balanced/"/>
      <url>/2023/03/05/lc1653-Minimum-Deletions-to-Make-String-Balanced/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>You are given a string s consisting only of characters â€˜aâ€™ and â€˜bâ€™.</p><p>You can delete any number of characters in s to make s balanced. s is balanced if there is no pair of indices (i,j) such that i &lt; j and s[i] = â€˜bâ€™ and s[j]= â€˜aâ€™.</p><p>Return the minimum number of deletions needed to make s balanced.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: s = &quot;aababbab&quot;</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: You can either:</span><br><span class="line">Delete the characters at 0-indexed positions 2 and 6 (&quot;aababbab&quot; -&gt; &quot;aaabbb&quot;), or</span><br><span class="line">Delete the characters at 0-indexed positions 3 and 6 (&quot;aababbab&quot; -&gt; &quot;aabbbb&quot;).</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: s = &quot;bbaaaaabb&quot;</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: The only solution is to delete the first two characters.</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>1 &lt;= s.length &lt;= 105</code></li><li><code>s[i]</code> is <code>&#39;a&#39;</code> or <code>&#39;b&#39;</code>.</li></ul><h2 id="My-solution"><a href="#My-solution" class="headerlink" title="My solution"></a>My solution</h2><p>Very unfortunate, my solution is not the best solution.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minimumDeletions</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="comment">// The first way is to delete b before a</span></span><br><span class="line">        <span class="comment">// The second option is to delete a after b</span></span><br><span class="line">        <span class="comment">// In some conditions, I need to combine the two ways.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// aababbab</span></span><br><span class="line">        <span class="comment">// aaabbb</span></span><br><span class="line">        <span class="comment">// aabbbb</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// dp[i][1] end with a</span></span><br><span class="line">        <span class="comment">// dp[i][2] end with b</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// dp[i][1] = dp[i-1][1]                    (s[i]==a)</span></span><br><span class="line">        <span class="comment">// dp[i][1] = dp[i-1][1]+1                  (s[i]==b)</span></span><br><span class="line">        <span class="comment">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2]+1)  (s[i]==a) </span></span><br><span class="line">        <span class="comment">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2])    (s[i]==b)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ans = Min(dp[i][1],dp[i][2])</span></span><br><span class="line">      </span><br><span class="line">        <span class="type">int</span> dp[][]=<span class="keyword">new</span> <span class="title class_">int</span>[s.length()+<span class="number">1</span>][<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            <span class="type">char</span> c=s.charAt(i);</span><br><span class="line">            i++; <span class="comment">//This avoids judging boundaries</span></span><br><span class="line">            <span class="keyword">if</span>(c==<span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line">                dp[i][<span class="number">1</span>] = dp[i-<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">                dp[i][<span class="number">2</span>] = Math.min(dp[i-<span class="number">1</span>][<span class="number">1</span>],dp[i-<span class="number">1</span>][<span class="number">2</span>]+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                dp[i][<span class="number">1</span>] = dp[i-<span class="number">1</span>][<span class="number">1</span>]+<span class="number">1</span>;</span><br><span class="line">                dp[i][<span class="number">2</span>] = Math.min(dp[i-<span class="number">1</span>][<span class="number">1</span>],dp[i-<span class="number">1</span>][<span class="number">2</span>]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i--;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.min(dp[s.length()][<span class="number">1</span>],dp[s.length()][<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Best-solution"><a href="#Best-solution" class="headerlink" title="Best solution"></a>Best solution</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minimumDeletions</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Delete all b to the left of this point</span></span><br><span class="line">        <span class="comment">// Delete all a to the right of this point</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// I just need to know the number of a to the left of any point.</span></span><br><span class="line">        <span class="comment">// And i need to know the number of a and b in the whole string.</span></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> num_a=<span class="number">0</span>,num_b=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            <span class="type">char</span> c=s.charAt(i);</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="string">&#x27;a&#x27;</span>) num_a++;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> con_a=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ans=num_a;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">             <span class="type">char</span> c=s.charAt(i);</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="string">&#x27;a&#x27;</span>) num_a--;</span><br><span class="line">            <span class="keyword">else</span> num_b++;</span><br><span class="line"></span><br><span class="line">            ans=Math.min(ans,num_a+num_b);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>eBPF(XDP &amp; sockopts)åŠ é€Ÿæ•°æ®ä¼ è¾“é—®é¢˜</title>
      <link href="/2023/02/27/XDP%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E9%97%AE%E9%A2%98%E7%BB%BC%E8%BF%B0/"/>
      <url>/2023/02/27/XDP%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E9%97%AE%E9%A2%98%E7%BB%BC%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<p>Best choice is XQUICï¼XQUIC Yesï¼</p><h2 id="1ï¼‰XDPç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ"><a href="#1ï¼‰XDPç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ" class="headerlink" title="1ï¼‰XDPç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ"></a>1ï¼‰XDPç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ</h2><p>ç»ç ”ç©¶ï¼ŒåŸºäºxdpè¿›è¡ŒserverlessæœåŠ¡å¯åŠ¨åŠ é€Ÿè¿™ä¸€é—®é¢˜ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå­é—®é¢˜ï¼š</p><pre><code> 1. å¦‚ä½•åœ¨WASM runtimeä¸­è¿œç¨‹æ¢å¤è¿è¡ŒçŠ¶æ€ 2. å¦‚ä½•ä½¿ç”¨XDPè¿›è¡Œé«˜æ•ˆçš„æ•°æ®ä¼ è¾“ï¼Ÿ(æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆï¼Ÿ)</code></pre><p>æˆ‘è®¤ä¸ºä¸¤ä¸ªé—®é¢˜ä¸­ï¼Œé—®é¢˜2ä¼˜å…ˆçº§æ›´é«˜ã€‚å› ä¸ºäº‹å®ä¸Šè¿™ä¸€é—®é¢˜å¯ä»¥æ‹“å±•ä¸ºï¼šé€šè¿‡ xdp + sockopts å®ç°é€šç”¨çš„ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆã€‚</p><p>ç›®å‰ç½‘ç»œä¸Šæš‚æ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆï¼ˆå…·ä½“å‚è€ƒç¬¬äºŒèŠ‚ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥å®Œæˆè¿™ç§æ–¹æ¡ˆï¼Œåˆ™è¯¥æ–¹æ¡ˆä¸ä»…å¯ä»¥ç”¨äºserverlessåŠ é€Ÿï¼Œè¿˜å¯ä»¥åº”ç”¨äºå¾ˆå¤šå¾ˆå¤šåœºæ™¯ï¼Œå°†å…·æœ‰å¾ˆå¥½çš„å‰æ™¯ã€‚</p><p>åˆæ­¥æ„æƒ³ï¼šç”±äºxdpæœ¬èº«å¹¶ä¸å…·å¤‡å®Œæ•´çš„åè®®æ ˆï¼Œä¹Ÿä¸èƒ½ä¿è¯æ•°æ®åŒ…çš„å®Œæ•´æ€§ã€‚è¯¥è®¾æ–½ä½¿ç”¨ebpf-xdpæŠ€æœ¯æ›¿æ¢æŸç§ç½‘ç»œåè®®çš„åº•å±‚ï¼Œä»è€Œå®ç°ä¸€ç§é«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2019.33.35.png" alt="æˆªå±2023-02-27 19.33.35"></p><h2 id="2ï¼‰eBPFåœ¨ç½‘ç»œåŠ é€Ÿä¸­çš„å®ä¾‹"><a href="#2ï¼‰eBPFåœ¨ç½‘ç»œåŠ é€Ÿä¸­çš„å®ä¾‹" class="headerlink" title="2ï¼‰eBPFåœ¨ç½‘ç»œåŠ é€Ÿä¸­çš„å®ä¾‹"></a>2ï¼‰eBPFåœ¨ç½‘ç»œåŠ é€Ÿä¸­çš„å®ä¾‹</h2><p>AF_XDPæŠ€æœ¯è¾ƒæ–°ï¼Œä¸”AF_XDPçš„è®¾è®¡ä¸»è¦æ˜¯é’ˆå¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œç›®å‰å¯ä»¥æ‰¾åˆ°ä¸€äº›AF_XDPåœ¨ç½‘å…³ç­‰åº”ç”¨çš„ä½¿ç”¨å®ä¾‹ã€‚è¿™æ˜¯ç”±äºxdpçš„æ€§è´¨ï¼Œ1ï¼‰æˆªè·ç½‘ç»œæ•°æ®åŒ…ï¼Œ2ï¼‰å¹¶é‡å®šå‘åŒ…åˆ°ç”¨æˆ·æ€è¿›è¡Œå¤„ç†ï¼Œ3ï¼‰æœ€åå°†æ•°æ®åŒ…ä¼ è¾“å‡ºå»ã€‚è¿™ä¸€ç‰¹æ€§éå¸¸é€‚åˆåº”ç”¨äºç½‘å…³åº”ç”¨ã€‚</p><p>æ­¤å¤–XDPåœ¨é»‘åå•å¤„ç†å’ŒæŠµå¾¡DDosæ”»å‡»ç­‰æ–¹é¢å·²æœ‰è¾ƒå¤šå®è·µã€‚</p><p>ä½†ç›®å‰æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ä½¿ç”¨AF_XDPè¿›è¡Œæ•°æ®ä¼ è¾“çš„å®è·µã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºeBPFè¿›è¡Œç½‘ç»œåŠ é€Ÿçš„åº”ç”¨å®ä¾‹ï¼š</p><h3 id="AF-XDPåœ¨Bç«™CDNèŠ‚ç‚¹QUICç½‘å…³çš„åº”ç”¨å’Œè½åœ°"><a href="#AF-XDPåœ¨Bç«™CDNèŠ‚ç‚¹QUICç½‘å…³çš„åº”ç”¨å’Œè½åœ°" class="headerlink" title="AF_XDPåœ¨Bç«™CDNèŠ‚ç‚¹QUICç½‘å…³çš„åº”ç”¨å’Œè½åœ°"></a>AF_XDPåœ¨Bç«™CDNèŠ‚ç‚¹QUICç½‘å…³çš„åº”ç”¨å’Œè½åœ°</h3><p>åŸæ–‡åœ°å€ï¼š<a href="https://www.bilibili.com/read/cv20778694">https://www.bilibili.com/read/cv20778694</a></p><p>ç±»ä¼¼çš„ä¸œè¥¿ï¼š<a href="https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html">https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html</a></p><p>åŸºäºAF_XDPçš„QUICç½‘å…³ï¼ŒXDPç¨‹åºå¯¹æ•°æ®å¸§è¿›è¡Œè¿‡æ»¤ï¼ŒæŠŠå‘ç»™quic-serverçš„HTTP/3è¯·æ±‚æ‰€å¯¹åº”çš„æ•°æ®å¸§é‡å®šå‘åˆ°quic-serverç»´æŠ¤çš„xskä¸­ã€‚ </p><p>åŸºäºAF_XDPçš„QUICç½‘å…³ä¸åŸç”Ÿç½‘å…³å¯¹æ¯”ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2017.52.21.png" alt="æˆªå±2023-02-27 17.52.21"></p><p>åŸºäºAF_XDPçš„QUICç½‘å…³æ‰§è¡Œé€»è¾‘ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2020.01.25.png" alt="æˆªå±2023-02-27 20.01.25"></p><h3 id="2ï¼‰lstio"><a href="#2ï¼‰lstio" class="headerlink" title="2ï¼‰lstio"></a>2ï¼‰lstio</h3><p>ä»‹ç»ï¼š<a href="https://istio.io/v1.15/blog/2022/merbridge/">https://istio.io/v1.15/blog/2022/merbridge/</a></p><p>lstioä½¿ç”¨äº†sockoptsè¿›è¡Œäº†åŒæœºå™¨ä¸‹çš„ç½‘ç»œé€šä¿¡åŠ é€Ÿã€‚</p><p>åŸç”Ÿç½‘ç»œä¼ è¾“è·¯å¾„ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5.png" alt="5"></p><p>ä½¿ç”¨sockoptsè¿›è¡Œè·¨æœºå™¨åŠ é€Ÿï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/6.png" alt="6"></p><p>ä½¿ç”¨sockoptsè¿›è¡ŒåŒæœºå™¨åŠ é€Ÿï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2018.52.48.png" alt="æˆªå±2023-02-27 18.52.48"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>eBPF AF_XDPå­¦ä¹ </title>
      <link href="/2023/02/21/eBPF-XDP/"/>
      <url>/2023/02/21/eBPF-XDP/</url>
      
        <content type="html"><![CDATA[<p>å®˜æ–¹æ•™ç¨‹åœ°å€ï¼ˆ19å¹´ç‰ˆæœ¬ï¼Œæœ‰äº›æ—§ï¼ŒåŒ…ä¾èµ–å…³ç³»å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼‰ï¼š<a href="https://github.com/xdp-project/xdp-tutorial">https://github.com/xdp-project/xdp-tutorial</a></p><p><strong>What is AF_XDP?</strong></p><p>AF_XDPæ˜¯ä¸€ä¸ªä¸ºé«˜æ€§èƒ½æ•°æ®åŒ…å¤„ç†è€Œä¼˜åŒ–çš„è§£å†³æ–¹æ¡ˆ</p><p>ä½¿ç”¨XDPç¨‹åºä¸­çš„XDP_REDIRECTåŠ¨ä½œï¼Œè¯¥ç¨‹åºå¯ä»¥ä½¿ç”¨bpf_redirect_map()å‡½æ•°å°†å…¥å¸§é‡å®šå‘åˆ°å…¶ä»–æ”¯æŒXDPçš„netdevã€‚AF_XDP socketä½¿XDPç¨‹åºèƒ½å¤Ÿå°†å¸§é‡å®šå‘åˆ°ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜ç¼“å†²åŒºï¼Œä»è€Œåœ¨ç”¨æˆ·æ€å¯¹æ•°æ®åŒ…è¿›è¡Œå„ç§å¤„ç†</p><h2 id="1ï¼‰XDPç¨‹åºEasy-Example"><a href="#1ï¼‰XDPç¨‹åºEasy-Example" class="headerlink" title="1ï¼‰XDPç¨‹åºEasy Example"></a>1ï¼‰XDPç¨‹åºEasy Example</h2><p>ä¸‹åˆ—ç¨‹åºå¯ä»¥ç”¨äºåœ¨é­å—DDosæ”»å‡»æ—¶ä½¿ç”¨ï¼Œä½œç”¨æ˜¯ä¸¢å¼ƒæ‰€æœ‰ç½‘ç»œæ•°æ®åŒ…(ä¸è¦éšæ„åœ¨å®é™…ç½‘å¡è·‘è¿™ä¸ªç¨‹åºï¼Œå½“æ­¤ç¨‹åºåŠ è½½æˆåŠŸçš„ç¬é—´ï¼Œsshé“¾æ¥å°±ä¼šå¤±æ•ˆï¼Œç„¶åå°±åªèƒ½é‡å¯æœåŠ¡å™¨äº†)ï¼š</p><p>XDPå†…æ ¸ç¨‹åºï¼Œä¼šè¢«ç¼–è¯‘ä¸º.oæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;xdp&quot;</span>)</span><br><span class="line"><span class="type">int</span>  <span class="title function_">xdp_prog_simple</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŠ è½½XDP bpfæ¨¡å—çš„æ ¸å¿ƒç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">xdp_link_attach</span><span class="params">(<span class="type">int</span> ifindex, __u32 xdp_flags, <span class="type">int</span> prog_fd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Next assignment this will move into ../common/ */</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* libbpf provide the XDP net_device link-level hook attach helper */</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * é€šè¿‡helperè¿›è¡ŒåŠ è½½</span></span><br><span class="line"><span class="comment">   * ifindex ç½‘å¡è®¾å¤‡ç¼–å·</span></span><br><span class="line"><span class="comment">   * prog_fd bpfæ¨¡å—çš„fd</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);</span><br><span class="line"><span class="keyword">if</span> (err == -EEXIST &amp;&amp; !(xdp_flags &amp; XDP_FLAGS_UPDATE_IF_NOEXIST)) &#123;</span><br><span class="line"><span class="comment">/* Force mode didn&#x27;t work, probably because a program of the</span></span><br><span class="line"><span class="comment"> * opposite type is loaded. Let&#x27;s unload that and try loading</span></span><br><span class="line"><span class="comment"> * again.</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨SKB_MODEè¿›è¡ŒåŠ è½½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__u32 old_flags = xdp_flags;</span><br><span class="line"></span><br><span class="line">xdp_flags &amp;= ~XDP_FLAGS_MODES;</span><br><span class="line">xdp_flags |= (old_flags &amp; XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;</span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, <span class="number">-1</span>, xdp_flags);</span><br><span class="line"><span class="keyword">if</span> (!err)</span><br><span class="line">err = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// æ— æ³•è®°è½½ï¼Œdo something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> EXIT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨libbpfä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨libbpfæä¾›çš„åŠ è½½å·¥å…·å‡½æ•°è¿›è¡ŒåŠ è½½ã€‚</p><h2 id="2ï¼‰XDPå†…æ ¸ç¨‹åºå‚æ•°"><a href="#2ï¼‰XDPå†…æ ¸ç¨‹åºå‚æ•°" class="headerlink" title="2ï¼‰XDPå†…æ ¸ç¨‹åºå‚æ•°"></a>2ï¼‰XDPå†…æ ¸ç¨‹åºå‚æ•°</h2><h3 id="XDPè¾“å‡ºå‚æ•°ï¼š"><a href="#XDPè¾“å‡ºå‚æ•°ï¼š" class="headerlink" title="XDPè¾“å‡ºå‚æ•°ï¼š"></a>XDPè¾“å‡ºå‚æ•°ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">xdp_action</span> &#123;</span></span><br><span class="line">XDP_ABORTED = <span class="number">0</span>, <span class="comment">// Drop packet while raising an exception</span></span><br><span class="line">XDP_DROP, <span class="comment">//ä¸¢å¼ƒ</span></span><br><span class="line">XDP_PASS, <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">XDP_TX,   <span class="comment">//ä»åŒä¸€ç½‘è¯¾è¿”å›è¯¥æ•°æ®åŒ…</span></span><br><span class="line">XDP_REDIRECT, <span class="comment">//é‡å®šå‘ï¼ŒAF_XDPå¯ä»¥å°†æ•°æ®åŒ…é‡å®šå‘åˆ°ç”¨æˆ·æ€ï¼Œè¿›è¡Œå¤„ç†</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="XDPè¾“å…¥å‚æ•°ï¼š"><a href="#XDPè¾“å…¥å‚æ•°ï¼š" class="headerlink" title="XDPè¾“å…¥å‚æ•°ï¼š"></a>XDPè¾“å…¥å‚æ•°ï¼š</h3><p><strong>data</strong>å’Œ<strong>data_end</strong>å­—æ®µåˆ†åˆ«æ˜¯æ•°æ®åŒ…å¼€å§‹å’Œç»“æŸçš„æŒ‡é’ˆï¼Œå®ƒä»¬æ˜¯ç”¨æ¥è·å–å’Œè§£æä¼ æ¥çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå€¼æ˜¯<strong>data_meta</strong>æŒ‡é’ˆï¼Œåˆå§‹é˜¶æ®µå®ƒæ˜¯ä¸€ä¸ªç©ºé—²çš„å†…å­˜åœ°å€ï¼Œä¾›XDPç¨‹åºä¸å…¶ä»–å±‚äº¤æ¢æ•°æ®åŒ…å…ƒæ•°æ®æ—¶ä½¿ç”¨ã€‚æœ€åä¸¤ä¸ªå­—æ®µåˆ†åˆ«æ˜¯æ¥æ”¶æ•°æ®åŒ…çš„æ¥å£å’Œå¯¹åº”çš„RXé˜Ÿåˆ—çš„ç´¢å¼•ã€‚å½“è®¿é—®è¿™ä¸¤ä¸ªå€¼æ—¶ï¼ŒBPFä»£ç ä¼šåœ¨å†…æ ¸å†…éƒ¨é‡å†™ï¼Œä»¥è®¿é—®å®é™…æŒæœ‰è¿™äº›å€¼çš„å†…æ ¸ç»“æ„<strong>struct xdp_rxq_info</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xdp_md</span> &#123;</span></span><br><span class="line">__u32 data;</span><br><span class="line">__u32 data_end;</span><br><span class="line">__u32 data_meta;</span><br><span class="line"><span class="comment">// Below access go through struct xdp_rxq_info</span></span><br><span class="line">__u32 ingress_ifindex; <span class="comment">// rxq-&gt;dev-&gt;ifindex</span></span><br><span class="line">__u32 rx_queue_index;  <span class="comment">// rxq-&gt;queue_index</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="3ï¼‰Libbpfä¸­ä½¿ç”¨AF-XDP"><a href="#3ï¼‰Libbpfä¸­ä½¿ç”¨AF-XDP" class="headerlink" title="3ï¼‰Libbpfä¸­ä½¿ç”¨AF_XDP"></a>3ï¼‰Libbpfä¸­ä½¿ç”¨AF_XDP</h2><p>ç”±äºç°åœ¨libbpfå·²ç»åœæ­¢äº†å¯¹AF_xdp socket(xsk)çš„ç›´æ¥æ”¯æŒï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥åœ¨libpbfé¡¹ç›®ä¸­æ‰‹åŠ¨å¼•å…¥XDP-TOOLï¼Œä»¥è·å–xdpå…¨éƒ¨åŠŸèƒ½<br><a href="https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96">https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96</a><br>XDP tools: <a href="https://github.com/xdp-project/xdp-tools">https://github.com/xdp-project/xdp-tools</a></p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p>å°†xdp-toolsåŒ…åŠ å…¥libbpfé¡¹ç›®ç›®å½•</p></li><li><p>ä¿®æ”¹makefileï¼Œå¯¹xdp-toolsè¿›è¡Œç¼–è¯‘é“¾æ¥</p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŠ å…¥ç¼–è¯‘xdp-toolçš„éƒ¨åˆ†</span></span><br><span class="line">XDPTOOL_SRC := <span class="variable">$(<span class="built_in">abspath</span> ../../xdp-tools)</span> <span class="comment">#å¾…ç¼–è¯‘æ–‡ä»¶</span></span><br><span class="line">LIBXDP_SOURCES := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(XDPTOOL_SRC)</span>/lib/libxdp/libxdp*.[ch])</span> $(<span class="variable">$(XDPTOOL_SRC)</span>/lib/libxdp/xsk.c)</span><br><span class="line">XDPTOOL := <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(OUTPUT)</span>/libxdp.a)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(XDPTOOL)</span>: <span class="variable">$(LIBXDP_SOURCES)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> msg,LIB,<span class="variable">$@</span>)</span></span><br><span class="line"><span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> -C <span class="variable">$(XDPTOOL_SRC)</span> BUILD_STATIC_ONLY=1\</span><br><span class="line">OBJDIR=<span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>/xdptool DESTDIR=<span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>      \</span><br><span class="line">INCLUDEDIR= LIBDIR= UAPIDIR=      \</span><br><span class="line">libxdp_install</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€åç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥xdp-tool</span></span><br><span class="line"><span class="variable">$(APPS)</span>: %: <span class="variable">$(OUTPUT)</span>/%.o <span class="variable">$(XDPTOOL)</span> <span class="variable">$(LIBBPF_OBJ)</span>| <span class="variable">$(OUTPUT)</span>  </span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> msg,BINARY,<span class="variable">$@</span>)</span></span><br><span class="line"><span class="variable">$(Q)</span><span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> <span class="variable">$(ALL_LDFLAGS)</span> -lpthread -lelf -lz -o <span class="variable">$@</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ç”¨æˆ·æ€bpfç¨‹åºä¸­å¼•å…¥ #include &lt;xdp/xsk.h&gt;ï¼Œåç»­å³å¯ä½¿ç”¨AF_XDPçš„åŠŸèƒ½</p></li><li><p>åˆ©ç”¨Libbpfä¸­çš„å¸®åŠ©å‡½æ•°attach xdpç¨‹åºï¼š</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å…¨éƒ¨ç½‘å¡ä¿¡æ¯çš„å·¥å…·å‡½æ•°</span></span><br><span class="line"><span class="comment">// å‚è€ƒæ­¤åšå®¢ https://blog.csdn.net/Rong_Toa/article/details/109118585</span></span><br><span class="line"><span class="type">int</span> ret = get_ifinfo(ifdisplay, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attack bpf sec to all IF devs</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;ret;i++)&#123;</span><br><span class="line">bpf_program__attach_xdp (skel-&gt;progs.xdp_prog, i);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥åœ¨pipeä¸­çœ‹åˆ°XDPåŒ…çš„ä¿¡æ¯</p><h2 id="4ï¼‰åˆ©ç”¨AF-XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€"><a href="#4ï¼‰åˆ©ç”¨AF-XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€" class="headerlink" title="4ï¼‰åˆ©ç”¨AF XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€"></a>4ï¼‰åˆ©ç”¨AF XDPå°†æ•°æ®åŒ…redirectåˆ°ç”¨æˆ·æ€</h2><h3 id="å‚è€ƒèµ„æ–™ï¼š"><a href="#å‚è€ƒèµ„æ–™ï¼š" class="headerlink" title="å‚è€ƒèµ„æ–™ï¼š"></a>å‚è€ƒèµ„æ–™ï¼š</h3><p><a href="https://www.kernel.org/doc/html/next/networking/af_xdp.html">https://www.kernel.org/doc/html/next/networking/af_xdp.html</a><br><a href="https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/">https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/</a></p><h3 id="AF-XDPç”¨æˆ·æ€ä¸å†…æ ¸äº¤æ¢æ•°æ®åŒ…åŸç†ï¼š"><a href="#AF-XDPç”¨æˆ·æ€ä¸å†…æ ¸äº¤æ¢æ•°æ®åŒ…åŸç†ï¼š" class="headerlink" title="AF_XDPç”¨æˆ·æ€ä¸å†…æ ¸äº¤æ¢æ•°æ®åŒ…åŸç†ï¼š"></a>AF_XDPç”¨æˆ·æ€ä¸å†…æ ¸äº¤æ¢æ•°æ®åŒ…åŸç†ï¼š</h3><p>AF_XDPåœ¨åœ¨ç”¨æˆ·å’Œå†…æ ¸ä¹‹é—´ï¼Œå£°æ˜äº†ä¸€å—å…¬å…±çš„å†…å­˜åŒºåŸŸï¼šUMEMã€‚xdpå†…æ ¸ç¨‹åºä¼šå°†xdpæ•°æ®åŒ…å­˜å‚¨åœ¨UMEMé‡Œï¼Œ<br>åŒæ—¶æœ‰å››ç§ringï¼šFILL, COMPLETION, RX , TXã€‚å†…æ ¸å°†æŒ‡å‘UMEMä¸­æ•°æ®åŒ…çš„æŒ‡é’ˆæ”¾å…¥RX queueé‡Œã€‚ä¾›ç”¨æˆ·ç©ºé—´æ¶ˆè´¹ã€‚åŒæ—¶ç”¨æˆ·æ€å¯ä»¥é€šè¿‡å†™å…¥TX queueï¼Œå°†æ•°æ®åŒ…ä¼ å›å†…æ ¸å¤„ç†ã€‚å†…æ ¸å¤„ç†è¯¥æ•°æ®åŒ…ä¹‹åï¼Œå°†TXæè¿°ç¬¦æ”¾å…¥completion queueé‡Œï¼Œè¡¨ç¤ºå¤„ç†å®Œæˆã€‚æœ€åç”¨æˆ·ç©ºé—´å¯ä»¥åœ¨Fill queueæˆ–TXé˜Ÿåˆ—é‡Œå›æ”¶æè¿°ç¬¦ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png" alt="image7-6"></p><p>ä¸€å¼ å¾ˆæœ‰å¯å‘æ„ä¹‰çš„å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png" alt="unnamed1"></p><h2 id="5ï¼‰AF-XDPä»£ç è¯¦è§£"><a href="#5ï¼‰AF-XDPä»£ç è¯¦è§£" class="headerlink" title="5ï¼‰AF_XDPä»£ç è¯¦è§£"></a>5ï¼‰AF_XDPä»£ç è¯¦è§£</h2><ol><li><p>åˆ†é…å’Œåˆå§‹åŒ–UMEM</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_umem_info</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_ring_prod</span> <span class="title">fq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_ring_cons</span> <span class="title">cq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_umem</span> *<span class="title">umem</span>;</span></span><br><span class="line"><span class="type">void</span> *buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_umem_info</span> *<span class="title">umem</span>;</span></span><br><span class="line"><span class="type">void</span> *packet_buffer;</span><br><span class="line"><span class="type">uint64_t</span> packet_buffer_size = NUM_FRAMES * FRAME_SIZE;</span><br><span class="line"><span class="comment">// è¿›è¡Œå†…å­˜å¯¹é½</span></span><br><span class="line">posix_memalign(&amp;packet_buffer,</span><br><span class="line">   getpagesize(), <span class="comment">/* PAGE_SIZE aligned */</span></span><br><span class="line">   packet_buffer_size)</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–UMEM</span></span><br><span class="line">umem = configure_xsk_umem(packet_buffer, packet_buffer_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// configure_xsk_umem å‡½æ•°å®šä¹‰</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> xsk_umem_info *<span class="title function_">configure_xsk_umem</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">uint64_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_umem_info</span> *<span class="title">umem</span>;</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="comment">// å£°æ˜ä¸€å—å†…å­˜ç©ºé—´</span></span><br><span class="line">umem = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(*umem));</span><br><span class="line"><span class="keyword">if</span> (!umem)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// è¿›è¡Œumemeåˆ›å»º</span></span><br><span class="line">ret = xsk_umem__create(&amp;umem-&gt;umem, buffer, size, &amp;umem-&gt;fq, &amp;umem-&gt;cq,</span><br><span class="line">       <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">errno = -ret;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">umem-&gt;buffer = buffer;</span><br><span class="line"><span class="keyword">return</span> umem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¼€å¯AF_XDP socket (xsk)</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_socket_info</span> *<span class="title">xsk_socket</span>;</span></span><br><span class="line">xsk_socket = xsk_configure_socket(umem);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥å‡½æ•°å†™æ­»äº†éƒ¨åˆ†å‚æ•°ï¼Œå®é™…ä½¿ç”¨åº”é€šè¿‡å˜é‡ä¼ å…¥è¿™äº›å‚æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> xsk_socket_info *<span class="title function_">xsk_configure_socket</span><span class="params">(<span class="keyword">struct</span> xsk_umem_info *umem)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_socket_config</span> <span class="title">xsk_cfg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_socket_info</span> *<span class="title">xsk_info</span>;</span></span><br><span class="line"><span class="type">uint32_t</span> idx;</span><br><span class="line"><span class="type">uint32_t</span> prog_id = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">xsk_info = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(*xsk_info));</span><br><span class="line"><span class="keyword">if</span> (!xsk_info)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">xsk_info-&gt;umem = umem;</span><br><span class="line">xsk_cfg.rx_size = XSK_RING_CONS__DEFAULT_NUM_DESCS;</span><br><span class="line">xsk_cfg.tx_size = XSK_RING_PROD__DEFAULT_NUM_DESCS;</span><br><span class="line">xsk_cfg.libbpf_flags = <span class="number">0</span>;</span><br><span class="line">xsk_cfg.xdp_flags = <span class="number">0</span>; <span class="comment">//***</span></span><br><span class="line">xsk_cfg.bind_flags = <span class="number">0</span>; <span class="comment">//***</span></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">* int xsk_socket__create(</span></span><br><span class="line"><span class="comment">*  struct xsk_socket **xsk,</span></span><br><span class="line"><span class="comment">*  const char *ifname, </span></span><br><span class="line"><span class="comment">*     __u32 queue_id,</span></span><br><span class="line"><span class="comment">*  struct xsk_umem *umem,</span></span><br><span class="line"><span class="comment">*  struct xsk_ring_cons *rx,</span></span><br><span class="line"><span class="comment">*  struct xsk_ring_prod *tx,</span></span><br><span class="line"><span class="comment">*  const struct xsk_socket_config *config);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// æŒ‡å®šå°†Af_XDPé™„åŠ åœ¨veth-adv03ç½‘å¡ä¸Š</span></span><br><span class="line">ret = xsk_socket__create(&amp;xsk_info-&gt;xsk, <span class="string">&quot;veth-adv03&quot;</span>,</span><br><span class="line"> <span class="number">0</span>, umem-&gt;umem, &amp;xsk_info-&gt;rx,</span><br><span class="line"> &amp;xsk_info-&gt;tx, &amp;xsk_cfg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> error_exit;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span><br><span class="line"><span class="comment">// ifindex ,prog_id, xdp_flags</span></span><br><span class="line">ret = bpf_get_link_xdp_id(<span class="number">0</span>, &amp;prog_id, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> error_exit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialize umem frame allocation */</span></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–UMEM</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_FRAMES; i++)</span><br><span class="line">xsk_info-&gt;umem_frame_addr[i] = i * FRAME_SIZE;</span><br><span class="line"></span><br><span class="line">xsk_info-&gt;umem_frame_free = NUM_FRAMES;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Stuff the receive path with buffers, we assume we have enough */</span></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–RXé˜Ÿåˆ—</span></span><br><span class="line">ret = xsk_ring_prod__reserve(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class="line">     XSK_RING_PROD__DEFAULT_NUM_DESCS,</span><br><span class="line">     &amp;idx);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)</span><br><span class="line"><span class="keyword">goto</span> error_exit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; XSK_RING_PROD__DEFAULT_NUM_DESCS; i ++)</span><br><span class="line">*xsk_ring_prod__fill_addr(&amp;xsk_info-&gt;umem-&gt;fq, idx++) =</span><br><span class="line">xsk_alloc_umem_frame(xsk_info);</span><br><span class="line"></span><br><span class="line">xsk_ring_prod__submit(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class="line">      XSK_RING_PROD__DEFAULT_NUM_DESCS);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> xsk_info;</span><br><span class="line"></span><br><span class="line">error_exit:</span><br><span class="line">errno = -ret;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>å®šæ•°è¾“å‡ºxdpæ•°æ®åŒ…æ•°æ®</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_t</span> stats_poll_thread;</span><br><span class="line"><span class="type">int</span> ret = pthread_create(&amp;stats_poll_thread, <span class="literal">NULL</span>, stats_poll,xsk_socket);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> global_exit;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">stats_poll</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> interval = <span class="number">2</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xsk_socket_info</span> *<span class="title">xsk</span> =</span> arg;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">stats_record</span> <span class="title">previous_stats</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">previous_stats.timestamp = gettime();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Trick to pretty printf with thousands separators use %&#x27; */</span></span><br><span class="line">setlocale(LC_NUMERIC, <span class="string">&quot;en_US&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!global_exit) &#123;</span><br><span class="line">sleep(interval);</span><br><span class="line">xsk-&gt;stats.timestamp = gettime();</span><br><span class="line">stats_print(&amp;xsk-&gt;stats, &amp;previous_stats);</span><br><span class="line">previous_stats = xsk-&gt;stats;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>ä»RXé˜Ÿåˆ—ä¸­pollæ•°æ®ï¼Œå¹¶è¿›è¡Œå¤„ç†ï¼ˆæ­¤ç« èŠ‚æœªå®Œæˆï¼‰</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">rx_and_process(xsk_socket);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rx_and_process</span><span class="params">(<span class="keyword">struct</span> xsk_socket_info *xsk_socket)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[2];</span></span><br><span class="line"><span class="type">int</span> ret, nfds = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(fds, <span class="number">0</span>, <span class="keyword">sizeof</span>(fds));</span><br><span class="line">fds[<span class="number">0</span>].fd = xsk_socket__fd(xsk_socket-&gt;xsk);</span><br><span class="line">fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!global_exit) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;skb-mode&quot;</span>) &#123;</span><br><span class="line">ret = poll(fds, nfds, <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span> || ret &gt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">handle_receive_packets(xsk_socket); <span class="comment">//ç”¨æˆ·æ€å¤„ç†xdpæ•°æ®åŒ…æ ¸å¿ƒå‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">handle_receive_packets</span><span class="params">(<span class="keyword">struct</span> xsk_socket_info *xsk)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> rcvd, stock_frames, i;</span><br><span class="line"><span class="type">uint32_t</span> idx_rx = <span class="number">0</span>, idx_fq = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">rcvd = xsk_ring_cons__peek(&amp;xsk-&gt;rx, RX_BATCH_SIZE, &amp;idx_rx);</span><br><span class="line"><span class="keyword">if</span> (!rcvd)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Stuff the ring with as much frames as possible */</span></span><br><span class="line">stock_frames = xsk_prod_nb_free(&amp;xsk-&gt;umem-&gt;fq,</span><br><span class="line">xsk_umem_free_frames(xsk));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (stock_frames &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">ret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, stock_frames,</span><br><span class="line">     &amp;idx_fq);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This should not happen, but just in case */</span></span><br><span class="line"><span class="keyword">while</span> (ret != stock_frames)</span><br><span class="line">ret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, rcvd,</span><br><span class="line">     &amp;idx_fq);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; stock_frames; i++)</span><br><span class="line">*xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) =</span><br><span class="line">xsk_alloc_umem_frame(xsk);</span><br><span class="line"></span><br><span class="line">xsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq, stock_frames);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Process received packets */</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rcvd; i++) &#123;</span><br><span class="line"><span class="type">uint64_t</span> addr = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx)-&gt;addr;</span><br><span class="line"><span class="type">uint32_t</span> len = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++)-&gt;len;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!process_packet(xsk, addr, len))</span><br><span class="line">xsk_free_umem_frame(xsk, addr);</span><br><span class="line"></span><br><span class="line">xsk-&gt;stats.rx_bytes += len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xsk_ring_cons__release(&amp;xsk-&gt;rx, rcvd);</span><br><span class="line">xsk-&gt;stats.rx_packets += rcvd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do we need to wake up the kernel for transmission */</span></span><br><span class="line">complete_tx(xsk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æ•°æ®åŒ…æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">process_packet</span><span class="params">(<span class="keyword">struct</span> xsk_socket_info *xsk,</span></span><br><span class="line"><span class="params">   <span class="type">uint64_t</span> addr, <span class="type">uint32_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> *pkt = xsk_umem__get_data(xsk-&gt;umem-&gt;buffer, addr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Lesson#3: Write an IPv6 ICMP ECHO parser to send responses</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Some assumptions to make it easier:</span></span><br><span class="line"><span class="comment"> * - No VLAN handling</span></span><br><span class="line"><span class="comment"> * - Only if nexthdr is ICMP</span></span><br><span class="line"><span class="comment"> * - Just return all data with MAC/IP swapped, and type set to</span></span><br><span class="line"><span class="comment"> *   ICMPV6_ECHO_REPLY</span></span><br><span class="line"><span class="comment"> * - Recalculate the icmp checksum */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint32_t</span> tx_idx = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint8_t</span> tmp_mac[ETH_ALEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">tmp_ip</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> =</span> (<span class="keyword">struct</span> ethhdr *) pkt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipv6hdr</span> *<span class="title">ipv6</span> =</span> (<span class="keyword">struct</span> ipv6hdr *) (eth + <span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icmp6hdr</span> *<span class="title">icmp</span> =</span> (<span class="keyword">struct</span> icmp6hdr *) (ipv6 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ntohs(eth-&gt;h_proto) != ETH_P_IPV6 ||</span><br><span class="line">    len &lt; (<span class="keyword">sizeof</span>(*eth) + <span class="keyword">sizeof</span>(*ipv6) + <span class="keyword">sizeof</span>(*icmp)) ||</span><br><span class="line">    ipv6-&gt;nexthdr != IPPROTO_ICMPV6 ||</span><br><span class="line">    icmp-&gt;icmp6_type != ICMPV6_ECHO_REQUEST)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(tmp_mac, eth-&gt;h_dest, ETH_ALEN);</span><br><span class="line"><span class="built_in">memcpy</span>(eth-&gt;h_dest, eth-&gt;h_source, ETH_ALEN);</span><br><span class="line"><span class="built_in">memcpy</span>(eth-&gt;h_source, tmp_mac, ETH_ALEN);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(&amp;tmp_ip, &amp;ipv6-&gt;saddr, <span class="keyword">sizeof</span>(tmp_ip));</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;ipv6-&gt;saddr, &amp;ipv6-&gt;daddr, <span class="keyword">sizeof</span>(tmp_ip));</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;ipv6-&gt;daddr, &amp;tmp_ip, <span class="keyword">sizeof</span>(tmp_ip));</span><br><span class="line"></span><br><span class="line">icmp-&gt;icmp6_type = ICMPV6_ECHO_REPLY;</span><br><span class="line"></span><br><span class="line">csum_replace2(&amp;icmp-&gt;icmp6_cksum,</span><br><span class="line">      htons(ICMPV6_ECHO_REQUEST &lt;&lt; <span class="number">8</span>),</span><br><span class="line">      htons(ICMPV6_ECHO_REPLY &lt;&lt; <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here we sent the packet out of the receive port. Note that</span></span><br><span class="line"><span class="comment"> * we allocate one entry and schedule it. Your design would be</span></span><br><span class="line"><span class="comment"> * faster if you do batch processing/transmission */</span></span><br><span class="line"></span><br><span class="line">ret = xsk_ring_prod__reserve(&amp;xsk-&gt;tx, <span class="number">1</span>, &amp;tx_idx);</span><br><span class="line"><span class="keyword">if</span> (ret != <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">/* No more transmit slots, drop the packet */</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;addr = addr;</span><br><span class="line">xsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;len = len;</span><br><span class="line">xsk_ring_prod__submit(&amp;xsk-&gt;tx, <span class="number">1</span>);</span><br><span class="line">xsk-&gt;outstanding_tx++;</span><br><span class="line"></span><br><span class="line">xsk-&gt;stats.tx_bytes += len;</span><br><span class="line">xsk-&gt;stats.tx_packets++;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>å®Œæ•´ä»£ç ï¼š</p><p>åœ¨ç”¨æˆ·æ€è¾“å‡ºxdpåŒ…æ•°æ®ï¼Œè¿è¡Œç»“æœï¼š</p><p><img src="https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2023-02-25%2021.36.18.png?raw=true" alt="æˆªå±2023-02-25 21.36.18"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1792 Maximum Average Pass Ratio</title>
      <link href="/2023/02/19/lc1792-Maximum-Average-Pass-Ratio/"/>
      <url>/2023/02/19/lc1792-Maximum-Average-Pass-Ratio/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>There is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.</p><p>You are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.</p><p>The pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.</p><p>Return the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: classes = [[1,2],[3,5],[2,2]], extraStudents = 2</span><br><span class="line">Output: 0.78333</span><br><span class="line">Explanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4</span><br><span class="line">Output: 0.53485</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public double maxAverageRatio(int[][] classes, int extraStudents) &#123;</span><br><span class="line"></span><br><span class="line">        // So this is a two-dimensional array</span><br><span class="line">        PriorityQueue&lt;int[]&gt; queue = new PriorityQueue&lt;int[]&gt;(</span><br><span class="line">         (a, b) -&gt; &#123;</span><br><span class="line">            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);</span><br><span class="line">            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);</span><br><span class="line">            if (val1 == val2) &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">            return val1 &lt; val2 ? 1 : -1;</span><br><span class="line">        &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;classes.length;i++)&#123;</span><br><span class="line">            queue.add(classes[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // while(!queue.isEmpty())&#123;</span><br><span class="line">        //     int[] item=queue.poll();</span><br><span class="line">        //     System.out.println(item[0]+&quot; &quot;+item[1]);</span><br><span class="line">        // &#125;</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;extraStudents;i++)&#123;</span><br><span class="line">            int[] item=queue.poll();</span><br><span class="line">            item[0]++;</span><br><span class="line">            item[1]++;</span><br><span class="line">            queue.add(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        double ans=0;</span><br><span class="line">        while(!queue.isEmpty())&#123;</span><br><span class="line">            int[] item=queue.poll();</span><br><span class="line">            ans+=((double)item[0])/((double)item[1]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        return ans/classes.length;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// dp[i][j] The max pass ratio for first i class,first j extra student</span><br><span class="line">// dp[i][j]=MAX&#123; dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)&#125;</span><br><span class="line">// Time complexityï¼šO(l * extraStudents^2)</span><br><span class="line">// This algorithm seems too complicated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// So Use a greedy idea.</span><br><span class="line">// I define a priority queue</span><br><span class="line">// And the queue storage the classes and sort them by pass ratio from small to big.</span><br><span class="line"></span><br><span class="line">// I keep pulling classes from the head of the queue</span><br><span class="line">// Adding a extra student to this class and push this class back to queue.</span><br><span class="line"></span><br><span class="line">// When all extra student were used, the average pass retio has been maximized</span><br><span class="line">// the time complexity is o(log(l)*extraStudentNum)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1237  Find Positive Integer Solution for a Given Equation</title>
      <link href="/2023/02/18/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/"/>
      <url>/2023/02/18/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/</url>
      
        <content type="html"><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>Given a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.</p><p>While the exact formula is hidden, the function is monotonically increasing, i.e.:</p><p>f(x, y) &lt; f(x + 1, y)<br>f(x, y) &lt; f(x, y + 1)<br>The function interface is defined like this:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface CustomFunction &#123;</span><br><span class="line">public:</span><br><span class="line">  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.</span><br><span class="line">  int f(int x, int y);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>We will judge your solution as follows:</p><p>The judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.<br>The judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.<br>The judge will call your findSolution and compare your results with the answer key.<br>If your results match the answer key, your solution will be Accepted.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: function_id = 1, z = 5</span><br><span class="line">Output: [[1,4],[2,3],[3,2],[4,1]]</span><br><span class="line">Explanation: The hidden formula for function_id = 1 is f(x, y) = x + y.</span><br><span class="line">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class="line">x=1, y=4 -&gt; f(1, 4) = 1 + 4 = 5.</span><br><span class="line">x=2, y=3 -&gt; f(2, 3) = 2 + 3 = 5.</span><br><span class="line">x=3, y=2 -&gt; f(3, 2) = 3 + 2 = 5.</span><br><span class="line">x=4, y=1 -&gt; f(4, 1) = 4 + 1 = 5.</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: function_id = 2, z = 5</span><br><span class="line">Output: [[1,5],[5,1]]</span><br><span class="line">Explanation: The hidden formula for function_id = 2 is f(x, y) = x * y.</span><br><span class="line">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class="line">x=1, y=5 -&gt; f(1, 5) = 1 * 5 = 5.</span><br><span class="line">x=5, y=1 -&gt; f(5, 1) = 5 * 1 = 5.</span><br></pre></td></tr></table></figure><h2 id="Solution-01"><a href="#Solution-01" class="headerlink" title="Solution 01"></a>Solution 01</h2><p>So, can i call the funtion f like this?<br>customfunction.f(x,y);</p><p>Ok, the z ranges from 1 to 100. And x and y range from 1 to 1000.<br>So. Thatâ€™s not a huge amount of data.</p><p>The easy idea it to try each xy pairs. I need try a million time to get all pairs. </p><p>Considering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findSolution</span><span class="params">(CustomFunction customfunction, <span class="type">int</span> z)</span> &#123;</span><br><span class="line">        <span class="comment">// customfunction.f(x,y);</span></span><br><span class="line">        <span class="comment">// z ranges from 1 to 100</span></span><br><span class="line">        <span class="comment">// 1 &lt;= x, y &lt;= 1000</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// the easy idea is try each x and y to get all pairs.</span></span><br><span class="line">        <span class="comment">// I only need to try a million times to get all answer</span></span><br><span class="line">        <span class="comment">// Let&#x27;s consider that f is an increasing function. so i can do it by multiplying</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// for each x, Use the dichotomy to find y</span></span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; ans=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> x=<span class="number">1</span>;x&lt;<span class="number">1000</span>;x++)&#123; <span class="comment">// trying all possible x</span></span><br><span class="line">            <span class="type">int</span> l=<span class="number">1</span>,r=<span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">while</span>(l&lt;=r)&#123; <span class="comment">// for each x, using dichotomy to find the target y.</span></span><br><span class="line">                <span class="type">int</span> mid=(l+r)/<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span>(customfunction.f(x,mid)==z)&#123;</span><br><span class="line">                    List&lt;Integer&gt; item=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                    item.add(x);</span><br><span class="line">                    item.add(mid);</span><br><span class="line">                    ans.add(item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(customfunction.f(x,mid)&gt;z) r=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> l=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="solution-02"><a href="#solution-02" class="headerlink" title="solution 02"></a>solution 02</h2><p>// x=500 y=100;  fâ€™s return value is  z.<br>// And than, x goes up to 501.<br>// x=501 y!=100-1000<br>// Beacuse function f is increasing. So y canâ€™t be a bigger number than 100.<br>// Based on this idea, i can reduce the time complexity to O(x+y)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findSolution</span><span class="params">(CustomFunction customfunction, <span class="type">int</span> z)</span> &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class="line">        <span class="type">int</span> y=<span class="number">1000</span>; <span class="comment">// I&#x27;m defining y here as the maximum 1000</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">1</span>; x &lt;= <span class="number">1000</span> &amp;&amp; y &gt;= <span class="number">1</span>; x++) &#123; <span class="comment">// trying each x, and keep y bigger than 1</span></span><br><span class="line">            <span class="keyword">while</span> (y &gt;= <span class="number">1</span> &amp;&amp; customfunction.f(x, y) &gt; z) &#123;  <span class="comment">// Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)&gt;z</span></span><br><span class="line">                y--;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// At this time, judge whether f(x,y) equals z;</span></span><br><span class="line">          <span class="comment">// if it&#x27;s true,add this pair the ans list.</span></span><br><span class="line">            <span class="keyword">if</span> (y &gt;= <span class="number">1</span> &amp;&amp; customfunction.f(x, y) == z) &#123;</span><br><span class="line">                List&lt;Integer&gt; pair = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">                pair.add(x);</span><br><span class="line">                pair.add(y);</span><br><span class="line">                res.add(pair);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc1139 Largest 1-Bordered Square</title>
      <link href="/2023/02/17/lc1139-Largest-1-Bordered-Square/"/>
      <url>/2023/02/17/lc1139-Largest-1-Bordered-Square/</url>
      
        <content type="html"><![CDATA[<p>Given a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesnâ€™t exist in the grid.</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: grid = [[1,1,1],[1,0,1],[1,1,1]]</span><br><span class="line">Output: 9</span><br><span class="line"></span><br><span class="line">Example 2:</span><br><span class="line">Input: grid = [[1,1,0,0]]</span><br><span class="line">Output: 1</span><br></pre></td></tr></table></figure><p>The easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ï¼š</p><ol><li><p>storage the number of consecutive ones in the direction of vertical and horizontal for each points.</p></li><li><p>Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i use a array con[i][j][0] and con[i][j][1].</span><br><span class="line"></span><br><span class="line">con[i][j][0] 1 -</span><br><span class="line">con[i][j][1] 1 |</span><br><span class="line"></span><br><span class="line">*---*</span><br><span class="line">|   |</span><br><span class="line">|   |</span><br><span class="line">|   |</span><br><span class="line">*---P</span><br><span class="line">try 3</span><br><span class="line">if con[i-2][j][0]&gt;=3 &amp;&amp; con[i][j-2][1]&gt;=3 </span><br><span class="line">the square can be formedï¼›</span><br><span class="line">Update the area of the largest rectangleï¼›</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int largest1BorderedSquare(int[][] grid) &#123;</span><br><span class="line"></span><br><span class="line">        // con[i][j][0] number of 1 in the direction of y</span><br><span class="line">        // The number of consecutive ones in the vertical direction</span><br><span class="line">        // con[i][j][1] number of 1 in the direction of x</span><br><span class="line">        // The number of consecutive ones in the horizontal direction</span><br><span class="line"></span><br><span class="line">        int m=grid.length,n=grid[0].length;</span><br><span class="line"></span><br><span class="line">        int[][][] con=new int[m][n][2];</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class="line">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class="line">                if(grid[i][j]==1)&#123;</span><br><span class="line">                    if(i&gt;0) con[i][j][1]=con[i-1][j][1]+1;</span><br><span class="line">                    else con[i][j][1]=1;</span><br><span class="line">                    if(j&gt;0) con[i][j][0]=con[i][j-1][0]+1;</span><br><span class="line">                    else con[i][j][0]=1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //System.out.println(con[2][2][0]+&quot; &quot;+con[2][2][1]);</span><br><span class="line">        //System.out.println(con[2][0][0]+&quot; &quot;+con[2][0][1]);</span><br><span class="line">        //System.out.println(con[0][2][0]+&quot; &quot;+con[0][2][1]);</span><br><span class="line"></span><br><span class="line">        int ans=0;</span><br><span class="line">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class="line">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class="line">                // I need to go through the length of the edge from the largest to the smallest</span><br><span class="line">                for(int k=Math.min(con[i][j][0],con[i][j][1]);k&gt;0;k--)&#123;</span><br><span class="line">                    </span><br><span class="line">                    // *---k</span><br><span class="line">                    // ï½œ   |</span><br><span class="line">                    // ï½œ.  |</span><br><span class="line">                    // ï½œ.  |</span><br><span class="line">                    // k---p</span><br><span class="line">                    if(con[i-k+1][j][0]&gt;=k &amp;&amp; con[i][j-k+1][1]&gt;=k)&#123;</span><br><span class="line">                        ans=Math.max(ans,k*k);</span><br><span class="line">                        //System.out.println(i+&quot; &quot;+j+&quot; &quot;+k+&quot; &quot;+);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return ans;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>lc 1234 - Sliding window</title>
      <link href="/2023/02/13/lc-1234-Sliding-window/"/>
      <url>/2023/02/13/lc-1234-Sliding-window/</url>
      
        <content type="html"><![CDATA[<h2 id="Puzzle"><a href="#Puzzle" class="headerlink" title="Puzzle"></a>Puzzle</h2><p>You are given a string s of length n containing only four kinds of characters: â€˜Qâ€™, â€˜Wâ€™, â€˜Eâ€™, and â€˜Râ€™.</p><p>A string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.</p><p>Return the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Input: s = &quot;QWER&quot;</span><br><span class="line">Output: 0</span><br><span class="line">Explanation: s is already balanced.</span><br><span class="line"></span><br><span class="line">Input: s = &quot;QQWE&quot;</span><br><span class="line">Output: 1</span><br><span class="line">Explanation: We need to replace a &#x27;Q&#x27; to &#x27;R&#x27;, so that &quot;RQWE&quot; (or &quot;QRWE&quot;) is balanced.</span><br><span class="line"></span><br><span class="line">Input: s = &quot;QQQW&quot;</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: We can replace the first &quot;QQ&quot; to &quot;ER&quot;. </span><br></pre></td></tr></table></figure><h2 id="My-Answer"><a href="#My-Answer" class="headerlink" title="My Answer"></a>My Answer</h2><h3 id="Idea1-fault"><a href="#Idea1-fault" class="headerlink" title="Idea1 (fault)"></a>Idea1 (fault)</h3><p>// For each string, I can replace the entire string to solve the problem<br>// But that doesnâ€™t satisfy the problem that i need to find the minimum Length of the subString<br>// Assume the followingï¼š<br>// xxxx ã€sub stringã€‘ xxxx<br>// For the strings on both sides, the balance has been reached</p><p>// so i only need to  rplace the ã€sub stringã€‘, the section.<br>// it no need for me to know how to replace it ,or which kinds of characters in the ã€sub stringã€‘<br>// So now the question becomes, how do you find aã€sub stringã€‘which can keep two sides strings balanced. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// dp[i][j] = true / false</span><br><span class="line">// dp[0][n-1] =true</span><br><span class="line">// dp[i][j]= true (  dp[i-2][j+2]==true &amp;&amp; s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )</span><br><span class="line">// dp[i][j]= false </span><br></pre></td></tr></table></figure><p>However, the time complexity of this answer is o(n^2). And this state transition equation doesnâ€™t work.</p><h2 id="Idea2"><a href="#Idea2" class="headerlink" title="Idea2"></a>Idea2</h2><p>Actually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to stringâ€™s length/4. So , what i need to do is keep the num of each character in both side of the sub string less than stringâ€™s length divided by 4.  As long as itâ€™s less than a quarter, I can complete the missing part in the sub string.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(<span class="type">int</span>[] con,<span class="type">int</span> qtr)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(con[<span class="string">&#x27;Q&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;W&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;E&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class="string">&#x27;R&#x27;</span>-<span class="string">&#x27;A&#x27;</span>]&lt;=qtr) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>To find the minimum sub string, i can maintain a array to storage each characterâ€™s number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun windowâ€™s size.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">balancedString</span><span class="params">(String s)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] con=<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>]; <span class="comment">// QWER</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            con[s.charAt(i)-<span class="string">&#x27;A&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ans=s.length();</span><br><span class="line">        <span class="type">int</span> qtr=s.length()/<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> r=<span class="number">0</span>,l=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//if(check(con,qtr)) return 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(r=<span class="number">0</span>;r&lt;s.length();r++)&#123;</span><br><span class="line">            con[s.charAt(r)-<span class="string">&#x27;A&#x27;</span>]--;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(l&lt;s.length() &amp;&amp; check(con,qtr))&#123;</span><br><span class="line">            </span><br><span class="line">                ans=Math.min(ans,r-l+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//System.out.println(r+&quot; &quot;+l);</span></span><br><span class="line">                l++;</span><br><span class="line">                con[s.charAt(l-<span class="number">1</span>)-<span class="string">&#x27;A&#x27;</span>]++;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>libbpf spinglock &amp; map</title>
      <link href="/2023/02/10/libbpf-01/"/>
      <url>/2023/02/10/libbpf-01/</url>
      
        <content type="html"><![CDATA[<h2 id="minimal"><a href="#minimal" class="headerlink" title="minimal"></a>minimal</h2><ol><li>bpfç¨‹åºï¼Œè¿™ä¸€ä»£ç ä¼šè¢«åŠ è½½è¿›bpfè™šæ‹Ÿæœºï¼Œç”±äº‹ä»¶è§¦å‘æ‰§è¡Œã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> my_pid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ ELF section</span></span><br><span class="line">SEC(<span class="string">&quot;tp/syscalls/sys_enter_write&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_tp</span><span class="params">(<span class="type">void</span> *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// globleå˜é‡ï¼Œè¯»å–pid</span></span><br><span class="line"><span class="type">int</span> pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pid != my_pid)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‘pipeå‘é€å­—ç¬¦ä¸²</span></span><br><span class="line">bpf_printk(<span class="string">&quot;BPF triggered from PID %d.\n&quot;</span>, pid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ç”¨æˆ·ç©ºé—´ä»£ç </li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;minimal.skel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">libbpf_print_fn</span><span class="params">(<span class="keyword">enum</span> libbpf_print_level level, <span class="type">const</span> <span class="type">char</span> *format, va_list args)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, format, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">minimal_bpf</span> *<span class="title">skel</span>;</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">libbpf_set_strict_mode(LIBBPF_STRICT_ALL);</span><br><span class="line"><span class="comment">/* Set up libbpf errors and debug info callback */</span></span><br><span class="line">libbpf_set_print(libbpf_print_fn);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Open BPF application */</span></span><br><span class="line">skel = minimal_bpf__open();</span><br><span class="line"><span class="keyword">if</span> (!skel) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to open BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ensure BPF program only handles write() syscalls from our process */</span></span><br><span class="line">skel-&gt;bss-&gt;my_pid = getpid();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Load &amp; verify BPF programs */</span></span><br><span class="line">err = minimal_bpf__load(skel);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to load and verify BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attach tracepoint handler */</span></span><br><span class="line">err = minimal_bpf__attach(skel);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF skeleton\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &quot;</span></span><br><span class="line">       <span class="string">&quot;to see output of the BPF programs.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">/* è§¦å‘bpfç¨‹åºï¼Œç”¨äºæµ‹è¯• */</span></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">minimal_bpf__destroy(skel);</span><br><span class="line"><span class="keyword">return</span> -err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="bpf-Spinlocks"><a href="#bpf-Spinlocks" class="headerlink" title="bpf Spinlocks"></a>bpf Spinlocks</h2><p><a href="https://libbpf.readthedocs.io/en/latest/program_types.html">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p><p><a href="https://libbpf.readthedocs.io/en/latest/program_types.html">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p><p>spinglockç›®å‰æ— æ³•ç”¨äºtrackingå’Œsccket filterç›¸å…³ELF</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png" alt="æˆªå±2023-02-10 18.15.29"></p><p><a href="https://www.edony.ink/deepinsight-of-ebpf-map/">https://www.edony.ink/deepinsight-of-ebpf-map/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ServerlessæœåŠ¡å¿«é€Ÿå¯åŠ¨æ–¹æ¡ˆ</title>
      <link href="/2023/02/06/MITOSIS-by-WASM-ebpf-in-Faasm/"/>
      <url>/2023/02/06/MITOSIS-by-WASM-ebpf-in-Faasm/</url>
      
        <content type="html"><![CDATA[<p>Versionï¼š2023-3-5</p><h2 id="1-é—®é¢˜ç»¼è¿°"><a href="#1-é—®é¢˜ç»¼è¿°" class="headerlink" title="1. é—®é¢˜ç»¼è¿°"></a>1. é—®é¢˜ç»¼è¿°</h2><p>ç°å°è¯•ä½¿ç”¨WASMã€eBPFç­‰æŠ€æœ¯ä¼˜åŒ–ServerlessæœåŠ¡ã€‚è¿™ä¸€ä¼˜åŒ–å¯ä»¥é’ˆå¯¹ï¼šå®ä¾‹å¯åŠ¨é€Ÿåº¦ã€å®ä¾‹ä¸å¤–ç•Œäº¤äº’èƒ½åŠ›ã€å®ä¾‹è°ƒåº¦ç­‰æ–¹é¢ã€‚</p><p>é€»è¾‘ä¸Šæ¥è¯´ï¼Œä¸€ä¸ªServerlesså®ä¾‹çš„è¿è¡Œï¼Œå¿…ç„¶ç»è¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š<br>    1.è·å–å¾…è¿è¡Œè´Ÿè½½ï¼ˆè´Ÿè½½å¯ä»¥æ˜¯:WebAssemblyã€javaå­—èŠ‚ç ã€goå­—èŠ‚ç ç­‰ï¼Œæ˜¯å¾…è¿è¡Œçš„æ ¸å¿ƒé€»è¾‘ï¼‰<br>    2.å®ä¾‹åŠ è½½è´Ÿè½½ï¼Œè¿›è¡Œå¯åŠ¨<br>    3.å®ä¾‹æ¥å—å¾…å¤„ç†æ•°æ®ï¼Œè¿›è¡Œè¿ç®—ï¼Œå¹¶è¿”å›ç»“æœ<br>    4.è¿è¡Œç»“æŸï¼Œå®ä¾‹é”€æ¯</p><p><strong>é’ˆå¯¹æ­¥éª¤1</strong>ï¼Œè·å–è´Ÿè½½çš„å¸¸è§„æ–¹å¼æ˜¯ä»å¯¹è±¡å­˜å‚¨æœåŠ¡ä¸‹è½½è´Ÿè½½ï¼Œè¿™ä¸€æ–¹æ³•æ˜¾ç„¶è¾ƒæ…¢ã€‚<strong>AWS Lambda</strong>å¯¹æ­¤æå‡ºäº†â€é¢„ç½®å¹¶å‘â€ï¼Œè¿™ä¸€æœåŠ¡å¯ä»¥åœ¨ç”¨æˆ·çš„è™šæ‹Ÿå­ç½‘ä¸­ç»´æŒä¸€ä¸ªæ´»è·ƒçš„Lambdaå®ä¾‹ï¼Œä»è€Œé¿å…å†·å¯åŠ¨ã€‚ <strong>MITOSIS</strong>æŸç§æ„ä¹‰ä¸Šå¯ä»¥è¯´æ˜¯å¯¹â€é¢„ç½®å¹¶å‘â€è¿›è¡Œäº†æè‡´çš„ä¼˜åŒ–ï¼Œå³ä½¿ç”¨RDMAä»ä¸€ä¸ªæ´»è·ƒçš„å®ä¾‹â€”â€”Seedè¿›è¡Œè¿œç¨‹å…‹éš†ï¼Œå¹¶ä½¿ç”¨COWæ¸è¿›å¼çš„è·å–å†…å­˜æ•°æ®ã€‚<strong>Faasm</strong>é’ˆå¯¹æ­¤é—®é¢˜ï¼Œåˆ™å¼•å…¥äº†ä¸€ä¸ªKVæ•°æ®åº“ï¼Œå­˜å‚¨å„ä¸ªserverä¸Šå®ä¾‹çš„è¿è¡Œæƒ…å†µï¼Œä»è€Œå®ç°äº†åœ¨å·²å­˜åœ¨ç›®æ ‡å®ä¾‹çš„serverä¸Šå¤„ç†ä»»åŠ¡ï¼Œå°½å¯èƒ½é¿å…å†·å¯åŠ¨ã€‚è¿™ä¸€ä¼˜åŒ–æ˜¯ä¸€ç§è°ƒåº¦ç­–ç•¥ä¸Šçš„ä¼˜åŒ–ã€‚</p><p>æ¦‚æ‹¬æ¥è¯´ï¼Œæ­¥éª¤ä¸€çš„ä¼˜åŒ–æœ‰ä¸‰ä¸ªæ–¹é¢ï¼š<br>    1.å°†å®ä¾‹è´Ÿè½½å­˜æ”¾æ¯”è¾ƒâ€œè¿‘â€çš„åœ°æ–¹ï¼Œå¦‚ä¿ç•™ä¸€ä¸ªæ´»è·ƒå®ä¾‹<br>    2.ä½¿ç”¨å°½å¯èƒ½å¿«é€Ÿçš„æ–¹å¼è·å–è´Ÿè½½ï¼Œå¦‚RDMA<br>    3.é¿å…å†·å¯åŠ¨ï¼Œè¿›è¡Œè°ƒåº¦ä¼˜åŒ–</p><p><strong>é’ˆå¯¹æ­¥éª¤2</strong>ï¼Œå¯ä»¥å°è¯•ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦æœ¬èº«ï¼Œå¸¸è§æ–¹å¼æœ‰ä¼˜åŒ–ç¼–è¯‘äº§ç‰©ã€å‡å°å†…å­˜é…ç½®ç­‰ï¼Œç›®å‰æˆ‘ä»¬å°è¯•é‡‡ç”¨çš„ä¼˜åŒ–ç­–ç•¥æ˜¯ä½¿ç”¨WASMã€‚ï¼ˆFaasmé’ˆå¯¹æ­¤æ­¥éª¤ï¼Œä½¿ç”¨äº†ç›´æ¥é€šè¿‡WASM runtimeé•œåƒå¯åŠ¨çš„æ–¹æ³•ï¼Œä¼˜åŒ–äº†WASMå®¹å™¨å¯åŠ¨çš„é€Ÿåº¦ï¼‰</p><p><strong>é’ˆå¯¹æ­¥éª¤3</strong>ï¼ŒåŸç”ŸWASMéœ€ä½¿ç”¨WASIä¸ç³»ç»Ÿäº¤äº’ï¼Œè¿™ä¸€æ–¹æ³•å¯èƒ½æ€§èƒ½è¾ƒå·®/é€‚ç”¨èŒƒå›´è¾ƒå°ã€‚å› æ­¤å°è¯•é‡‡ç”¨WASM-eBPFå·¥å…·ï¼Œå°†éƒ¨åˆ†è¿ç®—ä¸‹æ²‰åˆ°eBPFè™šæ‹Ÿæœºè¿›è¡Œï¼Œä»è€Œè·å¾—serverlessæœåŠ¡ä¸å¤–ç•Œæ›´å¥½çš„äº¤äº’èƒ½åŠ›ã€‚</p><p>æ³¨ï¼šç²—ç•¥ä¼°è®¡ï¼Œå®é™…ä½¿ç”¨ä¸­ServerlessæœåŠ¡ç»å¤§å¤šæ•°çš„å¯¹å¤–äº¤äº’éƒ½æ˜¯ç½‘ç»œäº¤äº’ï¼Œä¸»è¦æ˜¯è¯»å†™æ•°æ®ã€‚</p><p><strong>é’ˆå¯¹æ­¥éª¤4</strong>ï¼Œæš‚æ— ä¼˜åŒ–æªæ–½</p><h2 id="2-åŠ é€ŸServerlesså¯åŠ¨çš„æ–¹æ¡ˆï¼ˆè¿è¡ŒçŠ¶æ€æ¢å¤çš„ä¸‰ç§è·¯çº¿ï¼‰"><a href="#2-åŠ é€ŸServerlesså¯åŠ¨çš„æ–¹æ¡ˆï¼ˆè¿è¡ŒçŠ¶æ€æ¢å¤çš„ä¸‰ç§è·¯çº¿ï¼‰" class="headerlink" title="2. åŠ é€ŸServerlesså¯åŠ¨çš„æ–¹æ¡ˆï¼ˆè¿è¡ŒçŠ¶æ€æ¢å¤çš„ä¸‰ç§è·¯çº¿ï¼‰"></a>2. åŠ é€ŸServerlesså¯åŠ¨çš„æ–¹æ¡ˆï¼ˆè¿è¡ŒçŠ¶æ€æ¢å¤çš„ä¸‰ç§è·¯çº¿ï¼‰</h2><p>ç”±äºåŸç”ŸMITOSISå¯¹RDMAç¡¬ä»¶æœ‰ç¡¬æ€§è¦æ±‚ï¼Œä¸”éœ€è¦ä¿®æ”¹å†…æ ¸ï¼Œé€šç”¨æ€§ç›¸å¯¹è¾ƒä½ã€‚å› æ­¤å°è¯•åˆ©ç”¨WASM+eBPF+XDPç­‰ï¼Œå®ç°ä¸€ç§æ›´å‹å¥½çš„Serverlesså¿«é€Ÿå¯åŠ¨ç­–ç•¥ï¼Œä»¥ä¸‹å°†è¿™ä¸€ç­–ç•¥ç§°ä¸ºMITOSIS-eBPFã€‚ï¼ˆæ­¤å¤„çš„mitosiså–è‹±æ–‡æœ¬èº«æ„æ€ï¼šæœ‰ä¸åˆ†è£‚ï¼Œè¿™æ˜¯ç”±äºä¸‹åˆ—æ–¹æ¡ˆæ€è·¯ä¾ç„¶ä¸åŸç”Ÿmitosisç±»ä¼¼ï¼Œæ˜¯ä»ä¸€ä¸ªæ´»è·ƒå®ä¾‹å¿«é€Ÿåˆ†è£‚å‡ºå¤§é‡å­å®ä¾‹ï¼‰</p><p>ç›®å‰å®ç°MITOSIS-eBPFæœ‰ä¸‰ç§æ€è·¯ï¼š </p><h3 id="1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹"><a href="#1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹" class="headerlink" title="1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹"></a>1ï¼‰åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹</h3><p>åœ¨å†…æ ¸æ¢å¤è¿›ç¨‹çŠ¶æ€ï¼Œè¿™ä¸€æ€è·¯ä¸åŸç”ŸMITOSISä¸€è‡´ï¼Œéœ€å®ç°ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å¯¹â€œè¢«Forkè¿›ç¨‹â€è¿›è¡ŒMetadataå¿«ç…§ï¼Œå¹¶å°†æ­¤å¿«ç…§ä¼ é€’ç»™â€œå­è¿›ç¨‹â€</li><li>å­è¿›ç¨‹éœ€æ ¹æ®pteæ¢çŸ¥è¯¥Pageæ˜¯å¦åœ¨æœ¬åœ°ï¼Œè‹¥ä¸åœ¨æœ¬åœ°ï¼Œåˆ™éœ€è¦è¿›è¡Œè¿œç¨‹é¡µè·å–</li><li>MITOSIS-eBPFéœ€è¦èƒ½å¤Ÿè¯»å–æŒ‡å®šè¿›ç¨‹çš„æ•°æ®ï¼Œä»è€Œé€šè¿‡rpc/XQUICç­‰æ–¹å¼ä¼ é€’ç»™å­è¿›ç¨‹</li></ol><p>å…¶ä¸­æ­¥éª¤äºŒï¼ŒåŸç”ŸMITOSISçš„å®ç°æ–¹å¼æ˜¯åˆ©ç”¨pteä¸­æœªè¢«ä½¿ç”¨çš„é«˜ä½ä½œä¸ºæ ‡è®°ï¼Œä»è€Œåˆ¤æ–­è¯¥pageæ˜¯å¦åœ¨æœ¬åœ°ã€‚è¿™ä¸€æ“ä½œæ¶‰åŠå†…æ ¸ä¿®æ”¹ï¼Œä¼¼ä¹æ— æ³•é€šè¿‡eBPFå®ç°ï¼Œå› æ­¤â€œåœ¨å†…æ ¸æ¢å¤è¿›ç¨‹â€è¿™ä¸€æ–¹æ¡ˆæ— æ³•é¿å…ä¿®æ”¹å†…æ ¸ã€‚</p><p>æ­¤å¤–ï¼ŒXDPæœ¬èº«ä¸å…·æœ‰å®Œæ•´çš„åè®®æ ˆï¼Œæ— æ³•ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é ã€‚åŸºäºAF_XDPçš„æˆç†Ÿæ•°æ®ä¼ è¾“å·¥å…·XQUICï¼Œå®ç°çš„æ˜¯ä¸€ä¸ªçº¯ç”¨æˆ·æ€çš„åè®®æ ˆï¼Œå› æ­¤ä¼¼ä¹ä¸é€‚åˆå¯¹å†…æ ¸çš„Pageè¿›è¡Œä¼ è¾“ã€‚</p><h3 id="2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæ— COWï¼‰"><a href="#2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæ— COWï¼‰" class="headerlink" title="2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæ— COWï¼‰"></a>2ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæ— COWï¼‰</h3><p>ä»¥Faasmä¸ºä¾‹ï¼ŒFaasmä¼šå°†å®¹å™¨å¿«ç…§ä¿å­˜åœ¨AWS S3ä¸­ï¼Œæ”¶åˆ°ç›¸åº”è¯·æ±‚æ—¶è¿›è¡Œä¸‹è½½ï¼Œå¹¶æ ¹æ®å¿«ç…§è¿›è¡Œè¿è¡ŒçŠ¶æ€æ¢å¤ã€‚ä¸ºäº†è§£å†³S3è¯»å–é€Ÿåº¦è¾ƒæ…¢çš„é—®é¢˜ï¼Œå¯ä»¥åœ¨Faasmä¸­æ·»åŠ ä¸€ä¸ªç±»ä¼¼MITOSISçš„ç‰¹æ€§ï¼šå³ä»»æ„ä¸¤ä¸ªFaasmå®ä¾‹ä¹‹é—´ï¼Œå¯ä»¥è¿›è¡Œå®¹å™¨çŠ¶æ€æ‹·è´ã€‚å…·ä½“ç»†èŠ‚å¦‚ä¸‹ï¼š</p><ol><li>å½“ä¸€ä¸ªFaasmå®¹å™¨æ”¶åˆ°äº†â€œæ‹·è´è¯·æ±‚â€åï¼Œå¯¹è‡ªèº«çš„å®¹å™¨çŠ¶æ€è¿›è¡Œå¿«ç…§ã€‚ä¹‹åä½¿ç”¨åŸºäºxdp (XQUIC)çš„æ•°æ®ä¼ è¾“æ–¹å¼å°†å¿«ç…§å‘é€è‡³å‘èµ·â€œæ‹·è´è¯·æ±‚â€çš„å®ä¾‹</li><li>Faasmè¢«æ‹·è´åï¼Œå°†å¿«ç…§ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸‹æ¬¡è¢«æ‹·è´å°±ä¸éœ€è¦å†æ¬¡ç”Ÿæˆå¿«ç…§ã€‚åŒæ—¶ä¹‹åå…¶ä»–Faasmå®ä¾‹éƒ½é€šè¿‡è¯¥fassmè¿›è¡Œå¿«ç…§è·å–(å¯èƒ½éœ€è¦åœ¨kvæ•°æ®åº“ä¸­åŠ å…¥è®°å½•)ã€‚</li></ol><p>åœ¨åŠ é€Ÿå†·å¯åŠ¨æ–¹é¢ï¼ŒFaasmæœ¬èº«æœ‰ä½¿ç”¨kvæ•°æ®åº“å¯»æ‰¾å·²å­˜åœ¨ç›®æ ‡è´Ÿè½½çš„å®ä¾‹çš„æœºåˆ¶ã€‚è¿™ä¸€æœºåˆ¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œè‹¥æŸä¸€è¯·æ±‚å¤§é‡å­˜åœ¨ï¼Œåˆ™å°†ä¼šæœ‰å¤§é‡wasmå®ä¾‹åœ¨åŒä¸€serverä¸Šå¯åŠ¨ã€‚æ­¤æ—¶ï¼Œâ€œè¿œç¨‹çŠ¶æ€æ¢å¤â€å°±å¯ä»¥å¸®åŠ©å®ç°å¿«é€Ÿè·¨æœºå™¨å¯åŠ¨å®ä¾‹ï¼Œæˆ–å¯ä»¥æå‡faasmçš„æ€§èƒ½ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-01%2020.41.43.png" alt="æˆªå±2023-03-01 20.41.43"></p><p>è¿™ä¸€æ–¹æ¡ˆä»…ä»…é’ˆå¯¹Faasmæˆ–å…¶ä»–serverlesså¹³å°è¿›è¡Œæ‹“å±•ï¼Œæ— æ³•å½¢æˆé€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå±äºä¸€ä¸ªå·¥ç¨‹æ€§é—®é¢˜ã€‚</p><h3 id="3ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæœ‰COWï¼‰"><a href="#3ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæœ‰COWï¼‰" class="headerlink" title="3ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæœ‰COWï¼‰"></a>3ï¼‰åœ¨ç”¨æˆ·æ€WASMè™šæ‹Ÿæœºä¸­æ¢å¤è¿›ç¨‹ï¼ˆæœ‰COWï¼‰</h3><p><strong>è¿›ä¸€æ­¥ç ”ç©¶</strong>ï¼š<a href="https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/">https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/</a></p><p>é’ˆå¯¹Faasmè¿™ä¸€Serverlesså¹³å°ï¼ŒFaasmä¸­çš„Functionå®é™…è¿è¡Œåœ¨WASMè™šæ‹Ÿæœºä¸­ã€‚å› æ­¤æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œè¿œç¨‹Forkï¼š</p><ol><li>å­è¿›ç¨‹çš„WASMè™šæ‹Ÿæœºåˆå§‹åŒ–</li><li>åˆ©ç”¨XQUICï¼Œä»â€œè¢«Forkè¿›ç¨‹â€è·å–â€œå…ƒæ•°æ®â€ï¼Œåœ¨WASMè™šæ‹Ÿæœºä¸­è¿›è¡ŒçŠ¶æ€æ¢å¤</li><li>è‹¥å­è¿›ç¨‹çš„WASMè™šæ‹Ÿæœºé‡åˆ°â€œç¼ºé¡µâ€ï¼Œåˆ™åˆ©ç”¨XQUICä»è¿›è¡Œè¿œç¨‹é¡µè·å–</li></ol><p>è¿™ä¸€æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š</p><ol><li>Faasmä½¿ç”¨äº†Photo Faasletå¿«ç…§+COWè¿›è¡Œå†·å¯åŠ¨åŠ é€Ÿï¼Œå› æ­¤â€œåœ¨WASMè™šæ‹Ÿæœºä¸­è¿ç”¨COWæ¢å¤è¿›ç¨‹çŠ¶æ€â€çš„å¯è¡Œæ€§å·²çŸ¥</li><li>å’ŒMITOSISæ€è·¯å®Œå…¨ä¸€è‡´ï¼Œä½†å…¨éƒ¨åœ¨ç”¨æˆ·æ€å®Œæˆï¼Œé¿å…ä¿®æ”¹å†…æ ¸</li></ol><p>è¿™ä¸€æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š</p><ol><li><p>è¿™ä¸€æ–¹æ¡ˆéœ€è¦æ”¹WASM runtimeçš„æºä»£ç ï¼Œä¸æ˜¯é€šç”¨è§£å†³æ–¹æ¡ˆã€‚</p></li><li><p>ç”±äºç”¨æˆ·æ€COWè¿‡ç¨‹è·¨è¶Šäº†è¾ƒå¤šå±‚ï¼Œè‹¥Functionæ¶‰åŠè¾ƒå¤šçš„è¿œç¨‹é¡µè·å–ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œè¾ƒæ…¢ï¼Œç”šè‡³æœ‰å¯èƒ½æ…¢äºåŸç”ŸFaasmçš„å†·å¯åŠ¨ã€‚</p></li></ol><h2 id="3-åœ¨WASMè™šæ‹Ÿæœºä¸­COWæ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯"><a href="#3-åœ¨WASMè™šæ‹Ÿæœºä¸­COWæ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯" class="headerlink" title="3. åœ¨WASMè™šæ‹Ÿæœºä¸­COWæ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯"></a>3. åœ¨WASMè™šæ‹Ÿæœºä¸­COWæ¢å¤è¿›ç¨‹çš„å¯è¡Œæ€§è®ºè¯</h2><h3 id="1-Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€"><a href="#1-Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€" class="headerlink" title="1.Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€"></a>1.Faasmæ€ä¹ˆå®ç°cowçš„ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨WAVMé‡Œæ¢å¤è¿è¡ŒçŠ¶æ€</h3><p>Faasmç”¨äº†WARMé‡Œçš„AOTæ¥å£è¿›è¡Œå¿«ç…§ç”Ÿæˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">aot_comp_context_t</span> <span class="title function_">aot_create_comp_context</span><span class="params">(<span class="type">aot_comp_data_t</span> comp_data, <span class="type">aot_comp_option_t</span> option)</span>;</span><br></pre></td></tr></table></figure><p>WAMRæºä»£ç åˆ†æï¼š</p><p><em><strong>WAMR runtime(WAMR)çš„å†…å­˜ç»“æ„æ˜¯åˆ†é¡µçš„ï¼Œä¸”é¡µæ˜¯åœ¨å†…å­˜ä¸Šè¿ç»­çš„ç‰‡æ®µï¼Œæœ‰æ˜ç¡®çš„èµ·å§‹åœ°å€å’ŒPage sizeï¼ˆæ•°ç»„ï¼‰ï¼Œå› æ­¤ä¹Ÿè®¸å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„è¿›è¡Œè¿œç¨‹é¡µæ‹·è´ï¼Œéœ€è¦æ”¹AOTçš„ä»£ç ã€‚</strong></em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Compiler context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AOTCompContext</span> &#123;</span></span><br><span class="line">    AOTCompData *comp_data;      <span class="comment">// å†…å­˜æ•°æ®ï¼Œæ˜¯åˆ†é¡µçš„</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Many llvm config data</span></span><br><span class="line">...</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* Function contexts */</span></span><br><span class="line">    AOTFuncContext **func_ctxes; <span class="comment">// å‡½æ•°context</span></span><br><span class="line">    uint32 func_ctx_count;       <span class="comment">// ç¨‹åºè®¡æ•°å™¨</span></span><br><span class="line">    <span class="type">char</span> **custom_sections_wp;</span><br><span class="line">    uint32 custom_sections_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3rd-party toolchains */</span></span><br><span class="line">    <span class="comment">/* External llc compiler, if specified, wamrc will emit the llvm-ir file and</span></span><br><span class="line"><span class="comment">     * invoke the llc compiler to generate object file.</span></span><br><span class="line"><span class="comment">     * This can be used when we want to benefit from the optimization of other</span></span><br><span class="line"><span class="comment">     * LLVM based toolchains */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *external_llc_compiler;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *llc_compiler_flags;</span><br><span class="line">    <span class="comment">/* External asm compiler, if specified, wamrc will emit the text-based</span></span><br><span class="line"><span class="comment">     * assembly file (.s) and invoke the llc compiler to generate object file.</span></span><br><span class="line"><span class="comment">     * This will be useful when the upstream LLVM doesn&#x27;t support to emit object</span></span><br><span class="line"><span class="comment">     * file for some architecture (such as arc) */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *external_asm_compiler;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *asm_compiler_flags;</span><br><span class="line">&#125; AOTCompContext;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AOTCompData</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Import memories */</span></span><br><span class="line">    uint32 import_memory_count;</span><br><span class="line">    AOTImportMemory *import_memories;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Memories */</span></span><br><span class="line">    uint32 memory_count;</span><br><span class="line">    AOTMemory *memories;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  typedef struct AOTMemory &#123;</span></span><br><span class="line"><span class="comment">    uint32 memory_flags;</span></span><br><span class="line"><span class="comment">    uint32 num_bytes_per_page;</span></span><br><span class="line"><span class="comment">    uint32 mem_init_page_count;</span></span><br><span class="line"><span class="comment">    uint32 mem_max_page_count;</span></span><br><span class="line"><span class="comment">&#125; AOTMemory;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Memory init data info */</span></span><br><span class="line">    uint32 mem_init_data_count;</span><br><span class="line">    AOTMemInitData **mem_init_data_list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Import tables */</span></span><br><span class="line">    uint32 import_table_count;</span><br><span class="line">    AOTImportTable *import_tables;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Tables */</span></span><br><span class="line">    uint32 table_count;</span><br><span class="line">    AOTTable *tables;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Table init data info */</span></span><br><span class="line">    uint32 table_init_data_count;</span><br><span class="line">    AOTTableInitData **table_init_data_list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Import globals */</span></span><br><span class="line">    uint32 import_global_count;</span><br><span class="line">    AOTImportGlobal *import_globals;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Globals */</span></span><br><span class="line">    uint32 global_count;</span><br><span class="line">    AOTGlobal *globals;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Function types */</span></span><br><span class="line">    uint32 func_type_count;</span><br><span class="line">    AOTFuncType **func_types;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Import functions */</span></span><br><span class="line">    uint32 import_func_count;</span><br><span class="line">    AOTImportFunc *import_funcs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Functions */</span></span><br><span class="line">    uint32 func_count;</span><br><span class="line">    AOTFunc **funcs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Custom name sections */</span></span><br><span class="line">    <span class="type">const</span> uint8 *name_section_buf;</span><br><span class="line">    <span class="type">const</span> uint8 *name_section_buf_end;</span><br><span class="line">    uint8 *aot_name_section_buf;</span><br><span class="line">    uint32 aot_name_section_size;</span><br><span class="line"></span><br><span class="line">    uint32 global_data_size;</span><br><span class="line"></span><br><span class="line">    uint32 start_func_index;</span><br><span class="line">    uint32 malloc_func_index;</span><br><span class="line">    uint32 free_func_index;</span><br><span class="line">    uint32 retain_func_index;</span><br><span class="line"></span><br><span class="line">    uint32 aux_data_end_global_index;</span><br><span class="line">    uint32 aux_data_end;</span><br><span class="line">    uint32 aux_heap_base_global_index;</span><br><span class="line">    uint32 aux_heap_base;</span><br><span class="line">    uint32 aux_stack_top_global_index;</span><br><span class="line">    uint32 aux_stack_bottom;</span><br><span class="line">    uint32 aux_stack_size;</span><br><span class="line"></span><br><span class="line">    WASMModule *wasm_module;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WASM_ENABLE_DEBUG_AOT != 0</span></span><br><span class="line">    <span class="type">dwar_extractor_handle_t</span> extractor;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; AOTCompData;</span><br></pre></td></tr></table></figure><h3 id="2-ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ"><a href="#2-ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ" class="headerlink" title="2.ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ"></a>2.ebpfé«˜é€Ÿç½‘ç»œé€šä¿¡æ–¹æ¡ˆ</h3><p>XQUIC</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Faasm / WASM serverless</title>
      <link href="/2023/02/05/Faasm-WASM-serverless/"/>
      <url>/2023/02/05/Faasm-WASM-serverless/</url>
      
        <content type="html"><![CDATA[<p>è®ºæ–‡åœ°å€ï¼š<a href="https://arxiv.org/abs/2002.09344">https://arxiv.org/abs/2002.09344</a></p><h2 id="Faaslet-Faasmæ€»ç»“"><a href="#Faaslet-Faasmæ€»ç»“" class="headerlink" title="Faaslet/Faasmæ€»ç»“"></a>Faaslet/Faasmæ€»ç»“</h2><h3 id="1ï¼‰Faaslet"><a href="#1ï¼‰Faaslet" class="headerlink" title="1ï¼‰Faaslet"></a>1ï¼‰Faaslet</h3><p>Faasletæ˜¯ä¸€ç§software-based isolationã€‚è¿™æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½æ— æœåŠ¡è®¡ç®—çš„éš”ç¦»æŠ½è±¡ã€‚Faasletä½¿ç”¨WebAssemblyæä¾›çš„è½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼Œ<em>software-fault isolation</em>, provided by <em>WebAssembly</em>ï¼‰æ¥éš”ç¦»å·²æ‰§è¡Œå‡½æ•°çš„å†…å­˜ï¼Œå¹¶å…è®¸åŒä¸€åœ°å€ç©ºé—´çš„å‡½æ•°ä¹‹é—´å…±äº«å†…å­˜åŒºåŸŸã€‚</p><p>Faasletå…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ol><li><a href="#is">éš”ç¦»</a>ï¼šæ¯ä¸ªfassletç”±ä¸€ä¸ªthreadè¿›è¡Œæ‰§è¡Œï¼Œåˆ©ç”¨CGroupè¿›è¡Œçº¦æŸ</li><li>ä¸ºå®ç°é«˜æ•ˆçš„Functioné—´é€šä¿¡ï¼Œ1ï¼‰æä¾›æœ¬åœ°<a href="#memy">å…±äº«å†…å­˜æœºåˆ¶</a>ï¼ˆç”±WASMçš„ç‰¹æ€§ä¿è¯å†…å­˜å®‰å…¨ï¼Œ<a href="https://zhuanlan.zhihu.com/p/386849387">WASMå†…å­˜æ¨¡å‹</a>ï¼‰ã€‚2ï¼‰åŒæ—¶æä¾›ç”±distributed key-value store (KVSï¼ŒRedis)æ”¯æŒçš„å…¨å±€çŠ¶æ€å…±äº«</li><li>ä¸ºäº†Functionå¯ä»¥<strong>å®‰å…¨</strong>ä¸”<strong>é«˜æ•ˆ</strong>çš„è¿›è¡ŒåŠŸèƒ½è°ƒç”¨ï¼Œå®ç°äº†<a href="#inter">Host interface</a> APIï¼ˆç±»<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">POSIX</a>çš„å­é›†ï¼ŒåŸºäºWASIï¼‰ï¼Œfunctionå¯ä»¥è°ƒç”¨APIä»¥ä½¿ç”¨å„ç§ç³»ç»ŸåŠŸèƒ½ï¼ˆç›¸å½“äºåœ¨å‡½æ•°å’Œosä¹‹é—´åŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼Œå®ç°äº†ä½æ°´å¹³çš„è™šæ‹ŸåŒ–ï¼‰ã€‚ä½¿ç”¨message busä¸çˆ¶è¿›ç¨‹é€šä¿¡ï¼Œæ¥æ”¶å‡½æ•°è°ƒç”¨ã€å…±äº«ã€è°ƒç”¨å’Œç­‰å¾…å…¶ä»–å‡½æ•°ç­‰ä¿¡æ¯</li><li>å¿«é€Ÿå¯åŠ¨ï¼ŒFaasmä½¿ç”¨å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ä¸­çš„Proto-Faasletå¿«ç…§ä¼˜åŒ–å†·å¯åŠ¨æ—¶é—´ ã€‚</li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png" alt="æˆªå±2023-02-06 12.58.20"></p><h3 id="2ï¼‰Faasm"><a href="#2ï¼‰Faasm" class="headerlink" title="2ï¼‰Faasm"></a>2ï¼‰Faasm</h3><p>Faasmæ˜¯ä¸€ä¸ªè´Ÿè´£è°ƒåº¦Faasletçš„runtimeã€‚Faasmå¯ä»¥ç®¡ç†å¤šä¸ªFaasletã€‚Faasmé€šè¿‡Faasletçš„çŠ¶æ€å…±äº«æœºåˆ¶è¿›è¡Œè°ƒåº¦ã€‚</p><p>å¦‚ä¸‹å›¾ï¼ŒABCä¸‰ä¸ªå‡½æ•°è°ƒç”¨äº‹ä»¶ï¼ŒFaasm instance1å…·æœ‰å®ä¾‹Aï¼Œå› æ­¤ç›´æ¥æ‰§è¡Œã€‚Faasm instance1 ç¼ºå°‘BCå®ä¾‹ï¼Œä¸ºäº†é¿å…å†·å¯åŠ¨ï¼Œåˆ™å°†BCä»»åŠ¡å…±äº«åˆ°Faasm instance2.</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png" alt="æˆªå±2023-02-06 14.19.51"></p><p>æ­¤å¤–ï¼ŒFaasmä½¿ç”¨LLVMç¼–è¯‘functionï¼Œç”¨WAVMè¿›è¡Œæ‰§è¡Œã€‚</p><blockquote><p>ç¼–è¯‘è¿‡ç¨‹ï¼š<br>(1) ç”¨æˆ·è°ƒç”¨Faasletå·¥å…·é“¾å°†å‡½æ•°ç¼–è¯‘æˆWebAssemblyäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé“¾æ¥åˆ°Faaslet host interfaceçš„ç‰¹å®šè¯­è¨€å£°æ˜;<br>(2) ç”Ÿæˆä¸€ä¸ªç”±WebAssemblyåˆ›å»ºçš„â€œobject file with machine codeâ€<br>(3) Host interfaceä¸machine codeé“¾æ¥ä»¥ç”ŸæˆFaasletå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆFaaslet executableï¼‰</p></blockquote><h2 id="å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°"><a href="#å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°" class="headerlink" title="å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°"></a>å¦‚ä½•åŸºäºWASMè®¾è®¡ä¸€ä¸ªserverlesså¹³å°</h2><p>ç”±äºWASMå…·æœ‰<strong>å†…å­˜å®‰å…¨</strong>çš„ç‰¹æ€§ï¼Œä½¿ç”¨WASMå®ç°è½»é‡çº§çš„éš”ç¦»ï¼Œä»¥å–å¾—è¾ƒé«˜çš„æ€§èƒ½ï¼š</p><ol><li>å°†ç”¨æˆ·functionç¼–è¯‘æˆWebAssemblyï¼Œé‡‡ç”¨WASM runtimeï¼ˆä¾‹å¦‚WAVMï¼‰å¯¹functionè¿›è¡Œ<strong>æ‰§è¡Œ</strong>ã€‚</li><li><strong>æ‰§è¡Œ</strong>æ“ä½œç”±â€œè°ƒåº¦å™¨â€è¿›è¡Œï¼ˆFaasmï¼‰ï¼Œâ€œè°ƒåº¦å™¨â€ä½¿ç”¨ä¸€ä¸ªâ€œæ‰§è¡Œçº¿ç¨‹â€è¿›è¡Œfunctionæ‰§è¡Œå’Œè°ƒåº¦ï¼Œå¹¶ä½¿ç”¨CGroupå¯¹â€œæ‰§è¡Œçº¿ç¨‹â€è¿›è¡Œçº¦æŸã€‚</li><li>ä¸ºäº†å®ç°å®Œæ•´çš„serverlesså¹³å°ï¼Œä¾‹å¦‚æä¾›ioè°ƒç”¨ã€functioné—´çŠ¶æ€å…±äº«ï¼Œéœ€è¦åŠ å…¥ç›¸åº”çš„APIæ”¯æŒï¼ˆFaaaletsæä¾›äº†ç›¸åº”çš„APIâ€”â€”Host interfaceï¼‰ï¼Œä¾›ç”¨æˆ·functionè°ƒç”¨ã€‚</li></ol><hr><p><em>ç»†èŠ‚éƒ¨åˆ†</em>:</p><h2 id="Faasletæ¦‚è¿°"><a href="#Faasletæ¦‚è¿°" class="headerlink" title="Faasletæ¦‚è¿°"></a>Faasletæ¦‚è¿°</h2><p>Faasletæ˜¯ä¸€ç§software-based isolationã€‚è¿™æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½æ— æœåŠ¡å™¨è®¡ç®—çš„æ–°çš„éš”ç¦»æŠ½è±¡ã€‚Faasletä½¿ç”¨WebAssemblyæä¾›çš„è½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼Œ<em>software-fault isolation</em> (SFI), provided by <em>WebAssembly</em>ï¼‰æ¥éš”ç¦»å·²æ‰§è¡Œå‡½æ•°çš„å†…å­˜ï¼ŒåŒæ—¶å…è®¸åŒä¸€åœ°å€ç©ºé—´çš„å‡½æ•°ä¹‹é—´å…±äº«å†…å­˜åŒºåŸŸã€‚</p><p> FAASMæ˜¯ä¸€ä¸ªåŸºäºFaasletçš„runtimeï¼Œä½¿ç”¨æ ‡å‡†çš„Linux cgroupséš”ç¦»å…¶ä»–èµ„æºï¼Œå¦‚CPUå’Œç½‘ç»œã€‚å¹¶ä¸ºç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿè®¿é—®å’ŒåŠ¨æ€åŠ è½½æä¾›ä¸€ä¸ªä½çº§åˆ«çš„POSIXä¸»æœºæ¥å£</p><blockquote><p>ç°åœ¨çš„å®¹å™¨/vmï¼Œå¯åŠ¨æ…¢ï¼Œå†…å­˜å ç”¨å¤§</p></blockquote><p>æ— æœåŠ¡å™¨è®¡ç®—å¯ä»¥é€šè¿‡ä¸€ç§æ–°çš„isolation abstractionï¼Œä»¥æ›´å¥½åœ°æ”¯æŒæ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºï¼š</p><p>(i) åœ¨å‡½æ•°ä¹‹é—´ï¼Œæä¾›å¼ºçš„<strong>å†…å­˜å’Œèµ„æºéš”ç¦»</strong>ï¼Œä¿è¯å®‰å…¨æ€§<br>(ii) æ”¯æŒé«˜æ•ˆçš„<strong>çŠ¶æ€å…±äº«</strong>ã€‚æ•°æ®åº”è¯¥ä¸åŠŸèƒ½å…±å­˜ï¼ˆco-locatedï¼‰ï¼Œå¹¶ç›´æ¥è·å–ï¼Œå°½é‡å‡å°‘æ•°æ®è¿è¾“<br>(iii) å…è®¸åœ¨å¤šä¸ªä¸»æœºä¸Šæ‰©å±•çŠ¶æ€<br>(iv) ä½å†…å­˜æ¶ˆè€—ï¼Œå…è®¸åœ¨ä¸€å°æœºå™¨ä¸Šæœ‰è®¸å¤šå®ä¾‹ï¼›<br>(v) å¿«é€Ÿçš„å®ä¾‹åŒ–<br>(vi) æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€</p><p>ä¸ºäº†å®ç°ä»¥ä¸Šç‰¹æ€§ï¼ŒFaasletå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ol><li><strong>Faaslesè½»é‡çº§çš„éš”ç¦»</strong><br> Faasletä¾èµ–äºè½¯ä»¶æ•…éšœéš”ç¦»ï¼ˆSFIï¼‰ï¼Œå®ƒå°†å‡½æ•°é™åˆ¶åœ¨å¯¹å…¶è‡ªèº«å†…å­˜çš„è®¿é—®ã€‚ä¸€ä¸ªä¸Faasletå‡½æ•°ï¼Œè¿åŒå…¶åº“å’Œè¯­è¨€è¿è¡Œæ—¶çš„ä¾èµ–ï¼Œè¢«ç¼–è¯‘æˆWebAssemblyã€‚FAASMè¿è¡Œæ—¶åœ¨ä¸€ä¸ªåœ°å€ç©ºé—´å†…æ‰§è¡Œå¤šä¸ªFaasletï¼Œæ¯ä¸ªéƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çº¿ç¨‹ã€‚ä¸ºäº†å®ç°èµ„æºéš”ç¦»ï¼Œæ¯ä¸ªçº¿ç¨‹çš„CPUå‘¨æœŸä½¿ç”¨Linux cgroupsè¿›è¡Œçº¦æŸï¼Œç½‘ç»œè®¿é—®ä½¿ç”¨â€œ<em>network namespaces</em>â€å’Œâ€œ<em>traffic shaping</em>â€è¿›è¡Œé™åˆ¶ã€‚</li><li><strong>faaslet é«˜æ•ˆæœ¬åœ°/å…¨å±€çŠ¶æ€è®¿é—®</strong><br> ç”±äºfaasletå…±äº«ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œå®ƒä»¬å¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨æœ¬åœ°çŠ¶æ€è®¿é—®å…±äº«å†…å­˜åŒºåŸŸã€‚è¿™å…è®¸æ•°æ®å’Œå‡½æ•°çš„å…±åŒå®šä½ï¼Œå¹¶é¿å…ä¸²è¡ŒåŒ–çš„å¼€é”€ã€‚faasletä½¿ç”¨ä¸¤å±‚çŠ¶æ€æ¶æ„ï¼Œæœ¬åœ°å±‚æä¾›å†…å­˜å…±äº«ï¼Œå…¨å±€å±‚æ”¯æŒè·¨ä¸»æœºåˆ†å¸ƒå¼è®¿é—®çŠ¶æ€ã€‚<br> Faasmè¿è¡Œæ—¶ä¸ºFaasletæä¾›äº†ä¸€ä¸ªçŠ¶æ€ç®¡ç†APIï¼Œå¯ä»¥å¯¹ä¸¤å±‚çš„çŠ¶æ€è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚</li><li><strong>faasletå¿«é€Ÿåˆå§‹åŒ–</strong><br> ä¸ºäº†å‡å°‘Faasletç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶çš„å†·å¯åŠ¨æ—¶é—´ï¼ŒFaasletä»suspended stateå¯åŠ¨<br> suspended stateï¼šFAASMé¢„å…ˆåˆå§‹åŒ–ä¸€ä¸ªFaasletï¼Œå¹¶å¯¹å…¶å†…å­˜è¿›è¡Œå¿«ç…§ä»¥è·å¾—ä¸€ä¸ªåŸå§‹Faasletã€‚proto-Faasletç”¨äºå¿«é€Ÿåˆ›å»ºæ–°çš„Faasletå®ä¾‹ï¼Œå¯ä»¥é¿å…åˆå§‹åŒ–è¯­è¨€è¿è¡Œåº“çš„æ—¶é—´ã€‚ç†è®ºä¸Šproto - faasletæ”¯æŒè·¨ä¸»æœºæ¢å¤ï¼Œå¹¶ä¸”ä¸æ“ä½œç³»ç»Ÿæ— å…³ã€‚<br> ï¼ˆè¿™ä¸€å—ç±»ä¼¼MITOSISï¼Œæ˜¯ç›´æ¥ä½¿ç”¨äº†ä»å†…å­˜æ¢å¤è¿è¡ŒçŠ¶æ€ï¼‰</li><li><strong>Faaslet Host interface</strong><br> Faasleté€šè¿‡POSIX-like callsä¸ä¸»æœºç¯å¢ƒè¿›è¡Œäº¤äº’ã€‚åŒ…æ‹¬ç½‘ç»œã€æ–‡ä»¶I/Oã€å…¨å±€çŠ¶æ€è®¿é—®å’Œåº“åŠ è½½/é“¾æ¥ã€‚ä¸»æœºæ¥å£æä¾›äº†è¶³å¤Ÿçš„è™šæ‹ŸåŒ–ä»¥ç¡®ä¿éš”ç¦»ï¼ŒåŒæ—¶å¢åŠ çš„å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li></ol><p>FAASM runtimeä½¿ç”¨LLVMç¼–è¯‘å™¨å·¥å…·é“¾å°†åº”ç”¨ç¨‹åºè½¬æ¢ä¸ºWebAssemblyï¼Œè¿™ä¸€æ–¹æ³•æ”¯æŒç”¨å¤šç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„å‡½æ•°ã€‚å¯ç°æœ‰çš„æ— æœåŠ¡å™¨å¹³å°é›†æˆï¼Œä¾‹å¦‚Knativeã€‚</p><h2 id="Faaslet-detail-design"><a href="#Faaslet-detail-design" class="headerlink" title="Faaslet detail design"></a>Faaslet detail design</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png" alt="æˆªå±2023-02-06 12.58.20"></p><ol><li><p><a id="memy">å†…å­˜è®¾è®¡</a>ï¼šå‡½æ•°è¢«ç¼–è¯‘ä¸ºWebAssemblyï¼Œè¢«æ”¾ç½®åœ¨å®ƒè‡ªå·±çš„ç§æœ‰è¿ç»­å†…å­˜åŒºåŸŸä¸­ã€‚åŒæ—¶Faasletä¹Ÿæ”¯æŒå…±äº«å†…å­˜åŒºåŸŸï¼Œè¿™å…è®¸Faasletåœ¨WebAssemblyçš„å†…å­˜å®‰å…¨ä¿è¯çš„çº¦æŸä¸‹è®¿é—®å…±äº«çš„å†…å­˜çŠ¶æ€(å½“éœ€è¦å†…å­˜å…±äº«æ—¶ï¼ŒFaasletæ‰©å±•WASMçš„å­—èŠ‚æ•°ç»„ï¼Œä½†å°†æ–°é¡µé¢æ˜ å°„åˆ°å…¬å…±è¿›ç¨‹å†…å­˜çš„æŒ‡å®šåŒºåŸŸï¼ˆmmapï¼‰ã€‚ç„¶åå¯ä»¥ç»™å‡½æ•°ä¸€ä¸ªæŒ‡å‘å­—èŠ‚æ•°ç»„æ–°åŒºåŸŸçš„æŒ‡é’ˆï¼Œä½†æ‰€æœ‰è®¿é—®éƒ½åœ¨å…±äº«åŒºåŸŸä¸Šæ‰§è¡Œ)ã€‚<br> <img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png" alt="æˆªå±2023-02-06 15.22.09"></p></li><li><p><a id="is">éš”ç¦»</a>ï¼šfaasletç¡®ä¿äº†å…¬å¹³çš„èµ„æºè®¿é—®ã€‚å¯¹äºCPUéš”ç¦»ï¼Œä½¿ç”¨â€œLinux cgroupsçš„CPUå­é›†â€ã€‚æ¯ä¸ªå‡½æ•°éƒ½ç”±å…±äº«è¿è¡Œæ—¶è¿›ç¨‹çš„ä¸“ç”¨çº¿ç¨‹æ‰§è¡Œï¼Œè¿™ä¸ªçº¿ç¨‹è¢«åˆ†é…äº†ä¸€ä¸ªcgroupã€‚</p></li><li><p>IOæ¥å£ï¼šFaasleté€šè¿‡ç½‘ç»œå‘½åç©ºé—´ã€è™šæ‹Ÿç½‘ç»œæ¥å£å’Œæµé‡æ•´å½¢å®ç°å®‰å…¨å…¬å¹³çš„ç½‘ç»œè®¿é—®ã€‚æ¯ä¸ªFaasletåœ¨å•ç‹¬çš„åç§°ç©ºé—´ä¸­éƒ½æœ‰è‡ªå·±çš„ç½‘ç»œæ¥å£ï¼Œä½¿ç”¨iptablesè§„åˆ™è¿›è¡Œé…ç½®ã€‚ä¸ºäº†ç¡®ä¿å…±äº«ç§Ÿæˆ·ä¹‹é—´çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªFaasletä½¿ç”¨tcåœ¨å…¶è™šæ‹Ÿç½‘ç»œæ¥å£ä¸Šåº”ç”¨æµé‡æ•´å½¢ï¼Œä»è€Œå¼ºåˆ¶æ‰§è¡Œå…¥å£å’Œå‡ºå£æµé‡é€Ÿç‡é™åˆ¶ã€‚</p></li><li><p><a id="inter">Faaslet host interface</a>ï¼šFaaslet host interfaceæ˜¯ä¸€ä¸ªvirtualisation layerï¼Œæä¾›äº†ä¸€ç³»åˆ—APIï¼Œä»¥éš”ç¦»å‡½æ•°äºå¤–ç•Œç¯å¢ƒã€‚è¿™äº›æ¥å£åŸºäºWASIï¼ˆè¿™ä¸ªè®¾è®¡æœ‰ç‚¹ç±»ä¼¼gVisorï¼Œä½†æ˜¯gVisoræ˜¯æ¨¡æ‹Ÿäº†æ•´ä¸ªå†…æ ¸ï¼‰</p></li></ol><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png" alt="æˆªå±2023-02-06 13.15.25"></p><ol start="5"><li>Faasletä½¿ç”¨message busä¸çˆ¶è¿›ç¨‹ï¼ˆFaasmï¼‰é€šä¿¡ï¼Œæ¥æ”¶å‡½æ•°è°ƒç”¨ï¼Œå…±äº«å·¥ä½œï¼Œè°ƒç”¨å’Œç­‰å¾…å…¶ä»–å‡½æ•°ç­‰ä¿¡æ¯ã€‚</li><li>Proto Faasletå¿«ç…§åŒ…æ‹¬å‡½æ•°çš„å †æ ˆï¼ŒWebAssemblyè§„èŒƒçš„å‡½æ•°è¡¨ã€å †æ ˆæŒ‡é’ˆå’Œæ•°æ®ã€‚Faasmä½¿ç”¨copy-on-write memory mappingå°†å¿«ç…§è¿˜åŸåˆ°æ–°çš„Faasletä¸­ã€‚Faasmæä¾›äº†ä¸€ä¸ªHttp end pointï¼Œä¾‹å¦‚s3ï¼Œä»¥ä¾›ä¸Šä¼ å¿«ç…§.</li></ol><h2 id="FaasletçŠ¶æ€å…±äº«"><a href="#FaasletçŠ¶æ€å…±äº«" class="headerlink" title="FaasletçŠ¶æ€å…±äº«"></a>FaasletçŠ¶æ€å…±äº«</h2><p>Faasletæä¾›äº†ä¸¤å±‚æ¶æ„çš„çŠ¶æ€å…±äº«æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å¯å¸®åŠ©å®ç°Faasmçš„è°ƒåº¦ã€‚</p><p>æœ¬åœ°å±‚ï¼šæä¾›å¯¹åŒä¸€ä¸»æœºä¸Šçš„çŠ¶æ€çš„å…±äº«å†…å­˜è®¿é—®;</p><p>å…¨å±€å±‚ï¼šå…è®¸Faasletåœ¨ä¸»æœºé—´åŒæ­¥çŠ¶æ€ã€‚å…¨å±€å±‚ä½¿ç”¨distributed key-value store (KVS)å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼æ˜¯redisã€‚</p><p>DDOséšè—äº†ä¸¤å±‚çŠ¶æ€æ¶æ„ï¼Œæä¾›äº†å¯¹åˆ†å¸ƒå¼æ•°æ®çš„é€æ˜çš„è®¿é—®ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png" alt="æˆªå±2023-02-06 18.31.18"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MITOSIS test</title>
      <link href="/2023/02/02/MITOSIS-test/"/>
      <url>/2023/02/02/MITOSIS-test/</url>
      
        <content type="html"><![CDATA[<p>æœåŠ¡å™¨æ— rootæƒé™ï¼Œéœ€ä¿®æ”¹Kernelï¼Œå› æ­¤ç”¨KVMï¼ŒæŠŠdeviceæ˜ å°„åˆ°KVMé‡Œã€‚</p><h2 id="æœåŠ¡å™¨ç‰©ç†é…ç½®"><a href="#æœåŠ¡å™¨ç‰©ç†é…ç½®" class="headerlink" title="æœåŠ¡å™¨ç‰©ç†é…ç½®"></a>æœåŠ¡å™¨ç‰©ç†é…ç½®</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png" alt="æˆªå±2023-02-02 20.44.46"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig</span><br><span class="line">enp65s0f0np0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 429758  bytes 103736820 (103.7 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 804262  bytes 138138879 (138.1 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">enp66s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 431116  bytes 104497752 (104.4 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 811031  bytes 138523138 (138.5 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">enp66s0d1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class="line">        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 434024  bytes 104743872 (104.7 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 791748  bytes 136537921 (136.5 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><h2 id="KVMå®‰è£…ubuntu18-04"><a href="#KVMå®‰è£…ubuntu18-04" class="headerlink" title="KVMå®‰è£…ubuntu18.04"></a>KVMå®‰è£…ubuntu18.04</h2><p>æ•™ç¨‹ï¼š<a href="https://www.jianshu.com/p/d0e4ed80b8a1">https://www.jianshu.com/p/d0e4ed80b8a1</a></p><p>ä¸‹è½½ubuntué•œåƒï¼š<a href="http://mirrors.zju.edu.cn/ubuntu-releases/16.04/">http://mirrors.zju.edu.cn/ubuntu-releases/16.04/</a></p><h3 id="å®‰è£…ubuntuï¼š"><a href="#å®‰è£…ubuntuï¼š" class="headerlink" title="å®‰è£…ubuntuï¼š"></a>å®‰è£…ubuntuï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args=<span class="string">&#x27;console=ttyS0&#x27;</span></span><br></pre></td></tr></table></figure><p>å‡ºç°æƒé™ä¸è¶³æŠ¥é”™ï¼Œæ‰§è¡Œï¼šchmod 755 ~ï¼Œåé‡æ–°æ‰§è¡Œå‘½ä»¤å®‰è£…</p><h3 id="ssh-ç™»å½•è™šæ‹Ÿæœºï¼š"><a href="#ssh-ç™»å½•è™šæ‹Ÿæœºï¼š" class="headerlink" title="ssh ç™»å½•è™šæ‹Ÿæœºï¼š"></a>ssh ç™»å½•è™šæ‹Ÿæœºï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ virsh list <span class="comment">#è·å–ç›®æ ‡è™šæ‹Ÿæœºå</span></span><br><span class="line">$ virsh domifaddr [<span class="built_in">id</span> | name] <span class="comment">#è·å–è™šæ‹Ÿæœºä¿¡æ¯</span></span><br><span class="line"> Name       MAC address          Protocol     Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"> vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24</span><br><span class="line"> </span><br><span class="line">$ ssh username@192.168.122.116</span><br></pre></td></tr></table></figure><h3 id="æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤"><a href="#æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤" class="headerlink" title="æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤"></a>æ— æ³•è¿›å…¥å‘½ä»¤è¡Œé—®é¢˜ä¿®å¤</h3><p>å®‰è£…å®Œæ¯•åç›´æ¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ— æ³•ç™»å½•ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ virsh console ubuntu18</span><br><span class="line">Connected to domain <span class="string">&#x27;ubuntu18&#x27;</span></span><br><span class="line">Escape character is ^] (Ctrl + ]) <span class="comment">#å¡åœ¨è¿™é‡Œ</span></span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…è™šæ‹Ÿæœºæ—¶ï¼Œåº”é€‰æ‹©å®‰è£…openSSHæœåŠ¡ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨sshç™»å½•è™šæ‹Ÿæœºã€‚</p><p><a href="https://blog.csdn.net/weixin_28730403/article/details/111975038">https://blog.csdn.net/weixin_28730403/article/details/111975038</a><br><a href="https://blog.csdn.net/qq_36885515/article/details/112367143">https://blog.csdn.net/qq_36885515/article/details/112367143</a></p><h2 id="RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM"><a href="#RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM" class="headerlink" title="RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM"></a>RDMAç½‘å¡è®¾å¤‡ç©¿é€åˆ°KVM</h2><p><a href="https://blog.csdn.net/zhongbeida_xue/article/details/103602105">https://blog.csdn.net/zhongbeida_xue/article/details/103602105</a></p><ol><li><p>lspci | grep Ethernetï¼Œè·å–hostä¸»æœºä¸Šçš„ç½‘å¡åˆ—è¡¨</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep Ethernet</span><br><span class="line">41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class="line">41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class="line">42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]</span><br></pre></td></tr></table></figure></li><li><p>vim pci-01.xml ï¼Œå»ºç«‹ç›´è¿è®¾å¤‡å®šä¹‰æ–‡ä»¶</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x41&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>virsh attach-device [kvm-name] [config.xml]ï¼Œè¿›è¡Œè®¾å¤‡ç›´è¿<br> åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œlspciï¼Œå¯ä»¥å‘ç°å‡ºç°äº†ï¼Œå› æ­¤RDMAç›´è¿æ¥å·²ç”Ÿæ•ˆ</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…MITOSIS-core"><a href="#å®‰è£…MITOSIS-core" class="headerlink" title="å®‰è£…MITOSIS core"></a>å®‰è£…MITOSIS core</h2><p>1.å®‰è£…rust</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://sh.rustup.rs -sSf | sh</span><br><span class="line"></span><br><span class="line">$ rustup install nightly-2022-02-04  <span class="comment"># å®‰è£…mitosisæ‰€éœ€çš„å·¥å…·é“¾</span></span><br><span class="line">$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu</span><br><span class="line"></span><br><span class="line">$ apt-get install clang-9</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>eBPFå­¦ä¹ -01</title>
      <link href="/2023/01/19/eBPF%E5%AD%A6%E4%B9%A0-01/"/>
      <url>/2023/01/19/eBPF%E5%AD%A6%E4%B9%A0-01/</url>
      
        <content type="html"><![CDATA[<h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>å®‰è£…eBPFæ•™ç¨‹ï¼ˆFor ubuntu 18.04ï¼‰ï¼š<br><a href="https://blog.csdn.net/qq_33344148/article/details/123255679">https://blog.csdn.net/qq_33344148/article/details/123255679</a></p><p>åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°å„ä¸ªå†…æ ¸ç‰ˆæœ¬bccçš„releaseï¼Œå¯ä»¥è¿›è¡Œæ‰‹å·¥ä¸‹è½½ï¼š<br><a href="https://github.com/iovisor/bcc/releases/">https://github.com/iovisor/bcc/releases/</a></p><p>eBPF BCCï¼š<br><a href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a></p><p>Py BCCå¼€å‘æ•™ç¨‹ï¼š<br>å®˜æ–¹ï¼š<a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md">https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md</a><br>ä¸­æ–‡ï¼š<a href="https://blog.cyru1s.com/posts/ebpf-bcc.html">https://blog.cyru1s.com/posts/ebpf-bcc.html</a></p><h2 id="Example-01"><a href="#Example-01" class="headerlink" title="Example-01"></a>Example-01</h2><p>è¯¥ä»£ç å¯¹clone sys callè¿›è¡Œè¿½è¸ªã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># define BPF program</span></span><br><span class="line">prog = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string">    bpf_trace_printk(&quot;Hello, World!\\n&quot;);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=prog)</span><br><span class="line"><span class="comment"># æ·»åŠ æ¢æµ‹ç‚¹ï¼Œè¿½è¸ªcloneï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªæ¢æµ‹ç‚¹</span></span><br><span class="line">b.attach_kprobe(event=b.get_syscall_fnname(<span class="string">&quot;clone&quot;</span>), fn_name=<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># headerï¼Œè¡¨å¤´</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-18s %-16s %-6s %s&quot;</span> % (<span class="string">&quot;TIME(s)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;MESSAGE&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># format output</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment"># ä»trace_pipeè¿”å›å¤šä¸ªå‚æ•°</span></span><br><span class="line">        (task, pid, cpu, flags, ts, msg) = b.trace_fields()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line">    printb(<span class="string">b&quot;%-18.9f %-16s %-6d %s&quot;</span> % (ts, task, pid, msg))</span><br></pre></td></tr></table></figure><h2 id="Example-02"><a href="#Example-02" class="headerlink" title="Example-02"></a>Example-02</h2><p>è¯¥ä»£ç ç”¨äºè¿ç»­æ‰§è¡ŒsyncæŒ‡ä»¤æ—¶è¿›è¡Œæ‰“å°</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// åˆ›å»ºä¸€ä¸ªåä¸º last çš„ BPF hash æ˜ å°„</span></span><br><span class="line"><span class="string">BPF_HASH(last);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int do_trace(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">    u64 ts, *tsp, delta, key = 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // attempt to read stored timestamp</span></span><br><span class="line"><span class="string">    // è¯»å–å­˜å‚¨çš„ä¸Šä¸€æ¬¡æ—¶é—´æˆ³</span></span><br><span class="line"><span class="string">    tsp = last.lookup(&amp;key);</span></span><br><span class="line"><span class="string">    if (tsp != NULL) &#123;</span></span><br><span class="line"><span class="string">        // è®¡ç®—è¿‡äº†å¤šä¹…</span></span><br><span class="line"><span class="string">        delta = bpf_ktime_get_ns() - *tsp;</span></span><br><span class="line"><span class="string">        // å°äº1ç§’</span></span><br><span class="line"><span class="string">        if (delta &lt; 1000000000) &#123;</span></span><br><span class="line"><span class="string">            // output if time is less than 1 second</span></span><br><span class="line"><span class="string">            bpf_trace_printk(&quot;%d\\n&quot;, delta / 1000000);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        last.delete(&amp;key);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // update stored timestamp</span></span><br><span class="line"><span class="string">    // æ›´æ–°æ—¶é—´æˆ³</span></span><br><span class="line"><span class="string">    ts = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">    last.update(&amp;key, &amp;ts);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">b.attach_kprobe(event=b.get_syscall_fnname(<span class="string">&quot;sync&quot;</span>), fn_name=<span class="string">&quot;do_trace&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Tracing for quick sync&#x27;s... Ctrl-C to end&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># format output</span></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ä»trace pipeä¸­è¯»å–æ•°æ®ï¼Œåªæœ‰æœ‰æ•°æ®æ—¶æ‰ä¼šè¯»å–ï¼Œå¦åˆ™é˜»å¡</span></span><br><span class="line">        (task, pid, cpu, flags, ts, ms) = b.trace_fields()</span><br><span class="line">        <span class="keyword">if</span> start == <span class="number">0</span>:</span><br><span class="line">            start = ts</span><br><span class="line">        ts = ts - start</span><br><span class="line">        printb(<span class="string">b&quot;At time %.2f s: multiple syncs detected, last %s ms ago&quot;</span> % (ts, ms))</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RDMA-soft config</title>
      <link href="/2023/01/17/RDMA-soft-config/"/>
      <url>/2023/01/17/RDMA-soft-config/</url>
      
        <content type="html"><![CDATA[<p><a href="https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020">modprobe</a> rdma_rxe</p><p>rxe_cfg start</p><p>ifconfig</p><p>rxe_cfg add ens33</p><p>æˆ‘åœ¨è¿è¡ŒäºVMwareä¸­çš„ubuntuç¯å¢ƒæ­å»ºäº†Soft-RoCEè½¯ä»¶æ¨¡æ‹Ÿç¯å¢ƒï¼Œå¹¶æˆåŠŸæµ‹è¯•äº†ä¸¤å°è™šæ‹Ÿæœºå™¨é—´çš„é€šä¿¡ï¼Œä½†æ˜¯MITOSISä¼¼ä¹éœ€è¦â€œA machine with Mellanox RDMA-capable IB NIC â€ï¼ŒRoCEå’ŒIBä¸¤ç§RDMAæŠ€æœ¯æœ‰ä¸€å®šåŒºåˆ«ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´æ— æ³•æˆåŠŸã€‚</p><p>åœ¨MITOSISçš„readmeä¸­æœ‰è¿™ä¹ˆä¸€å¥â€œIn principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. â€ï¼Œæ„æ€åº”è¯¥æ˜¯ä¸æ”¯æŒRoCEï¼Ÿä½†æ˜¯ï¼Œæˆ‘ç›®å‰æ²¡æœ‰æ‰¾åˆ°è½¯ä»¶æ¨¡æ‹ŸIBçš„æ–¹å¼</p><p>IBï¼ˆInfiniBandï¼‰ï¼šåŸºäº InfiniBand æ¶æ„çš„ RDMA æŠ€æœ¯ï¼Œç”± IBTAï¼ˆInfiniBand Trade Associationï¼‰æå‡ºã€‚æ­å»ºåŸºäº IB æŠ€æœ¯çš„ RDMA ç½‘ç»œéœ€è¦ä¸“ç”¨çš„ IB ç½‘å¡å’Œ IB äº¤æ¢æœºã€‚</p><p>iWARPï¼ˆInternet Wide Area RDMA Protocalï¼‰ï¼šåŸºäº TCP/IP åè®®çš„ RDMA æŠ€æœ¯ï¼Œç”± IETF æ ‡ å‡†å®šä¹‰ã€‚iWARP æ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ä¸Šä½¿ç”¨ RDMA æŠ€æœ¯ï¼Œä½†æœåŠ¡å™¨éœ€è¦ä½¿ç”¨æ”¯æŒiWARP çš„ç½‘å¡ã€‚</p><p>RoCEï¼ˆRDMA over Converged Ethernetï¼‰ï¼šåŸºäºä»¥å¤ªç½‘çš„ RDMA æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ç”± IBTA æå‡ºã€‚RoCEæ”¯æŒåœ¨æ ‡å‡†ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½ä¸Šä½¿ç”¨RDMAæŠ€æœ¯ï¼Œä½†æ˜¯éœ€è¦äº¤æ¢æœºæ”¯æŒæ— æŸä»¥å¤ªç½‘ä¼ è¾“ï¼Œéœ€è¦æœåŠ¡å™¨ä½¿ç”¨ RoCE ç½‘å¡ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab5 COW</title>
      <link href="/2023/01/15/MIT-6-s081-Lab5-COW/"/>
      <url>/2023/01/15/MIT-6-s081-Lab5-COW/</url>
      
        <content type="html"><![CDATA[<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>COWæ ‡å¿—ä½ï¼Œ/rich.hã€‚å‚¨å­˜åœ¨ä¿ç•™ä½é‡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define COW_FLAG (1L &lt;&lt; 8)</span><br></pre></td></tr></table></figure><p>å¤åˆ¶å†…å­˜çš„ä»£ç ï¼Œåœ¨forkä¸­æœ‰è¢«è°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">uvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">&#123;</span><br><span class="line">    pte_t *pte;</span><br><span class="line">    uint64 pa, i;</span><br><span class="line">    int flags;</span><br><span class="line"></span><br><span class="line">    for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">        if((pte = walk(old, i, 0)) == 0)</span><br><span class="line">            panic(&quot;uvmcopy: pte should exist&quot;);</span><br><span class="line">        if((*pte &amp; PTE_V) == 0)</span><br><span class="line">            panic(&quot;uvmcopy: page not present&quot;);</span><br><span class="line"></span><br><span class="line">        // æ—§è¿›ç¨‹çš„ç‰©ç†å†…å­˜</span><br><span class="line">        pa = PTE2PA(*pte);</span><br><span class="line"></span><br><span class="line">        // COW</span><br><span class="line">        *pte = (*pte &amp; ~PTE_W) | COW_FLAG;</span><br><span class="line">        flags = PTE_FLAGS(*pte);</span><br><span class="line"></span><br><span class="line">        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)&#123;</span><br><span class="line">            goto err;</span><br><span class="line">        &#125;</span><br><span class="line">        con[getrefindex((uint64*)pa)]++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">uvmunmap(new, 0, i / PGSIZE, 1);</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†å†…å­˜éæ³•è®¿é—®ï¼ˆé¡µï¼‰ä¸­æ–­çš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">else if(r_scause() == 15)&#123;</span><br><span class="line">//      printf(&quot;page\n&quot;);</span><br><span class="line">        struct proc *p = myproc();</span><br><span class="line"></span><br><span class="line">        /* ã€xv6å¯¹é¡µçš„æ“æ§ç²’åº¦ä¸ºPageã€‘</span><br><span class="line">         * éœ€è¦å°†å½“å‰è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„pageè¿›è¡Œæ‹·è´</span><br><span class="line">         * ç”±äºè™šæ‹Ÿåœ°å€å¯èƒ½æŒ‡å‘é¡µçš„ä¸­é—´</span><br><span class="line">         * å› æ­¤éœ€è¦å‘ä¸‹å¯¹å…¶åˆ°é¡µçš„è¾¹ç•Œ</span><br><span class="line">         * ä»è€Œå°†è¿™ä¸€é¡µå…¨éƒ¨éƒ½è¿›è¡Œæ‹·è´ï¼ˆCOWï¼‰</span><br><span class="line">         */</span><br><span class="line">        uint64 va=PGROUNDDOWN(r_stval()); // è™šæ‹Ÿåœ°å€</span><br><span class="line"></span><br><span class="line">        pte_t *pte; // pte</span><br><span class="line">        pte = walk(p-&gt;pagetable, va, 0);</span><br><span class="line"></span><br><span class="line">        if(*pte &amp; COW_FLAG)&#123; //æ˜¯cowé¡µé¢</span><br><span class="line">            uint64 pa=PTE2PA(*pte); // ç‰©ç†åœ°å€</span><br><span class="line"></span><br><span class="line">            char *mem;</span><br><span class="line">            //åˆ†é…ä¸€é¡µæ–°å†…å­˜</span><br><span class="line">            if((mem = kalloc()) == 0)</span><br><span class="line">                panic(&quot;uvmtrap: pte alloc exist&quot;);</span><br><span class="line"></span><br><span class="line">            // æ‹·è´æ—§æ•°æ®çš„å€¼åˆ°æ–°page</span><br><span class="line">            memmove(mem, (char*)pa, PGSIZE);</span><br><span class="line"></span><br><span class="line">            int flags = PTE_FLAGS(*pte);</span><br><span class="line"></span><br><span class="line">            flags =flags | PTE_W;</span><br><span class="line">            flags &amp;= ~COW_FLAG;</span><br><span class="line">//            *pte &amp;=~PTE_V;</span><br><span class="line">            // è¿›è¡Œå†…å­˜æ˜ å°„</span><br><span class="line">            mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, flags);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            kfree((void*)pa);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å†…å­˜ä»£ç ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// derf.h</span><br><span class="line">extern int con[];</span><br><span class="line">extern int getrefindex(void*);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">kfree(void *pa)</span><br><span class="line">&#123;</span><br><span class="line">  struct run *r;</span><br><span class="line"></span><br><span class="line">  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP) &#123;</span><br><span class="line">      panic(&quot;kfree&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  con[getrefindex(pa)]--;</span><br><span class="line">  //printf(&quot;%d&quot;,con[(uint64)pa/PGSIZE]);</span><br><span class="line">  if(con[getrefindex(pa)]&gt;0)&#123;</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Fill with junk to catch dangling refs.</span><br><span class="line">  memset(pa, 1, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r-&gt;next = kmem.freelist;</span><br><span class="line">  kmem.freelist = r;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png" alt="æˆªå±2023-01-16 10.31.45"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MITOSIS note</title>
      <link href="/2023/01/13/MITOSIS-learning/"/>
      <url>/2023/01/13/MITOSIS-learning/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ProjectMitosisOS">MITOSIS Repo</a></p><h2 id="Remote-Fork-C-R"><a href="#Remote-Fork-C-R" class="headerlink" title="Remote Fork(C/R)"></a>Remote Fork(C/R)</h2><p>ç°æœ‰å®¹å™¨åªèƒ½é€šè¿‡C/Rçš„æ–¹æ³•è¿›è¡Œè¿œç¨‹Forkã€‚è¿™ç§æ–¹æ³•éœ€è¦çˆ¶è¿›ç¨‹é¦–å…ˆéœ€è¦<em>checkpoints</em> its statesï¼Œå¹¶å°†stateå‚¨å­˜åˆ°æ–‡ä»¶é‡Œã€‚åœ¨é€šè¿‡remote file copyæˆ–distributed file systemå°†æ–‡ä»¶å¤åˆ¶åˆ°å­è¿›ç¨‹ã€‚å­è¿›ç¨‹æ ¹æ®æ–‡ä»¶ä¿¡æ¯å¯¹å¤«è¿›ç¨‹è¿›è¡Œæ¢å¤ã€‚ç”±äºC/Réœ€è¦å¤åˆ¶å…¨éƒ¨å†…å­˜ä¿¡æ¯ï¼Œå› æ­¤å¾ˆæ…¢ã€‚ä¾‹å¦‚éœ€è¦å¯¹1Gå†…å­˜è¿›è¡Œæ‹·è´ï¼ŒC/Rç”šè‡³æ¯”å†·å¯åŠ¨è¿˜è¦æ…¢2.7å€ã€‚</p><h2 id="MITOSIS"><a href="#MITOSIS" class="headerlink" title="MITOSIS"></a>MITOSIS</h2><p>MITOSISã€maÉªËˆtoÊŠsÉªsã€‘é€šè¿‡RDMAæ¨¡æ‹Ÿæœ¬åœ°Forkæ¥å®ç°é«˜æ•ˆçš„è¿œç¨‹åˆ†å‰ï¼ˆå…·æœ‰ç±»ä¼¼COWæœºåˆ¶ï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png" alt="æˆªå±2023-01-16 11.36.26"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†çˆ¶å¯¹è±¡çš„Metadata(ä¾‹å¦‚é¡µè¡¨)å¤åˆ¶åˆ°ä¸€ä¸ªå‹ç¼©æè¿°ç¬¦æ¥æ´¾ç”Ÿå­å¯¹è±¡ã€‚Note:ä¸å°†çˆ¶è¿›ç¨‹çš„å†…å­˜é¡µå¤åˆ¶åˆ°æè¿°ç¬¦ä¸­ã€‚ç„¶åé€šè¿‡RDMAå°†æè¿°ç¬¦å¤åˆ¶åˆ°å­è¿›ç¨‹ä»¥æ¢å¤çˆ¶è¿›ç¨‹çš„Metadataã€‚å­è¿›ç¨‹çš„â€œè¿œç¨‹å†…å­˜è®¿é—®â€ä¼šè§¦å‘é¡µé¢é”™è¯¯ï¼Œå†…æ ¸å°†è¯»åŒºè¯»å–è¿œç¨‹é¡µé¢ã€‚é¿å…äº†ä¼ è¾“æ•´ä¸ªå®¹å™¨çŠ¶æ€ã€‚åŒæ—¶ï¼ŒMITOSISç›´æ¥ä½¿ç”¨å•è¾¹RDMA Readæ¥è¯»å–è¿œç¨‹ç‰©ç†å†…å­˜ï¼Œç»•è¿‡æ‰€æœ‰è½¯ä»¶å¼€é”€ã€‚</p><h3 id="MITOSISå’ŒC-R-forkçš„æ¯”è¾ƒ"><a href="#MITOSISå’ŒC-R-forkçš„æ¯”è¾ƒ" class="headerlink" title="MITOSISå’ŒC/R forkçš„æ¯”è¾ƒ"></a>MITOSISå’ŒC/R forkçš„æ¯”è¾ƒ</h3><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png" alt="æˆªå±2023-01-14 13.40.51"></p><p><strong>MITOSISç”±ä»¥ä¸‹å››ä¸ªæ¨¡å—ç»„æˆï¼š</strong></p><p>The <em>fork orchestrator</em> rehearsals the remote fork executionï¼›å‡†å¤‡forkå’Œè¿›è¡Œforkï¼Œä½¿ç”¨rpcè¿›è¡Œæ ¡éªŒ</p><p>The <em>network daemon</em> manages a scalable RDMA connection poolï¼›å•ä¾§RDMAï¼Œç»´æŠ¤RDMAè¿æ¥pool</p><p>Extend OSâ€™s <em>virtual memory subsystems</em> to utilize the remote memory with RDMA ï¼›è¿œç¨‹å†…å­˜è®¿é—®</p><p><em>Fallback daemon</em> provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMAï¼›æ¢å¤æœºåˆ¶ï¼Œå›é€€åˆ°RPC</p><h2 id="1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork"><a href="#1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork" class="headerlink" title="1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork"></a>1ï¼‰å‡†å¤‡forkå’Œè¿›è¡Œfork</h2><h3 id="1-fork-prepare"><a href="#1-fork-prepare" class="headerlink" title="1.fork_prepare"></a>1.fork_prepare</h3><p>å‡†å¤‡forkï¼Œä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“ä¿å­˜ï¼š</p><ul><li>CPUå¯„å­˜å™¨çŠ¶æ€ï¼ˆç”¨äºæ¢å¤è¿è¡ŒçŠ¶æ€ï¼‰</li><li>cGroupå’ŒNamespaceï¼ˆç”¨äºè¿›è¡Œå®¹å™¨åŒ–ï¼‰</li><li>é¡µè¡¨å’Œè™šæ‹Ÿå†…å­˜åŒºï¼ˆç”¨äºè¿œç¨‹å†…å­˜è®¿é—®ï¼‰</li><li>æ‰“å¼€æ–‡ä»¶ä¿¡æ¯ï¼ˆé‡æ–°æ‰“å¼€æ–‡ä»¶ï¼Œä½¿ç”¨CRIUï¼‰</li></ul><p>ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œç»“æ„ä½“å¾ˆå°ï¼Œå¤§æ¦‚æ˜¯KBçº§åˆ«</p><h3 id="2-fork-resume"><a href="#2-fork-resume" class="headerlink" title="2.fork_resume"></a>2.fork_resume</h3><p>fork_resumeä»çˆ¶è¿›ç¨‹è·å–descriptorï¼Œå¹¶æ¢å¤æ‰§è¡ŒçŠ¶æ€ã€‚</p><p>ä½¿ç”¨oneside RDMAè·å–descriptorã€‚é¦–å…ˆå­è¿›ç¨‹é€šè¿‡RPCå‘çˆ¶è¿›ç¨‹å‘ä¸€ä¸ªauthentication RPCï¼Œè‹¥è®¤è¯é€šè¿‡ï¼Œåˆ™çˆ¶è¿›ç¨‹ä¼šè¿”å›descriptorâ€™s stored addresså’Œpayloadã€‚ä¹‹åå­è¿›ç¨‹å°±å¯ä»¥ä½¿ç”¨oneside RDMAè·å–descriptorã€‚</p><p>è·å–åˆ°descriptoråï¼Œæ¢å¤å®¹å™¨çŠ¶æ€ã€‚(1)è®¾ç½®cgroupså’Œå‘½åç©ºé—´ä»¥åŒ¹é…çˆ¶æ“ä½œç³»ç»Ÿçš„è®¾ç½® (2)åˆ‡æ¢:ç”¨çˆ¶è¿›ç¨‹çš„CPUå¯„å­˜å™¨ã€é¡µè¡¨å’ŒI/Oæè¿°ç¬¦æ›¿æ¢è°ƒç”¨æ–¹çš„CPUå¯„å­˜å™¨ã€‚æ­¤å¤–å¼•å…¥SOCKä»¥å®Œæˆå¿«é€Ÿå®¹å™¨æ¢å¤ã€‚</p><h2 id="2ï¼‰å•ä¾§RDMA"><a href="#2ï¼‰å•ä¾§RDMA" class="headerlink" title="2ï¼‰å•ä¾§RDMA"></a>2ï¼‰å•ä¾§RDMA</h2><p>RDMAï¼šæœ‰ä¸‰ç§QPç±»å‹</p><p>RDMAè¿æ¥æ¶ˆè€—è¾ƒå¤§ï¼Œé€Ÿåº¦è¾ƒæ…¢ã€‚å› æ­¤ä½¿ç”¨æ— è¿æ¥çš„oneside RDMAã€‚å› æ­¤æ”¹è¿›RDMAè¿æ¥ï¼ˆDCT-dynamic connected transportï¼‰ï¼ŒDCTä¿ç•™äº†RCçš„åŠŸèƒ½ï¼Œå¹¶è¿›ä¸€æ­¥æä¾›äº†ä¸€ç§æ— è¿æ¥çš„æ–¹å¼:å•ä¸ªDCQPå¯ä»¥ä¸ä¸åŒçš„èŠ‚ç‚¹é€šä¿¡ã€‚</p><p>ç›®æ ‡èŠ‚ç‚¹åªéœ€è¦åˆ›å»ºä¸€ä¸ªDCï¼Œè¯¥DCç”±èŠ‚ç‚¹çš„RDMAåœ°å€å’Œ12B DC keyæ ‡è¯†ã€‚åœ¨çŸ¥é“keyåï¼Œå­èŠ‚ç‚¹å¯ä»¥åœ¨æ²¡æœ‰è¿æ¥çš„æƒ…å†µä¸‹å‘ç›¸åº”çš„ç›®æ ‡å‘é€å•ä¾§RDMAè¯·æ±‚ï¼Œç¡¬ä»¶ä¼šæ‰¿è½½æ•°æ®å¤„ç†è¿æ¥ï¼Œé€Ÿåº¦æå¿«(1Î¼sä»¥å†…).</p><p>åŸºäºDCTï¼Œç½‘ç»œå®ˆæŠ¤è¿›ç¨‹ç®¡ç†ä¸€ä¸ªå°å‹å†…æ ¸ç©ºé—´DCQPæ± ï¼Œç”¨äºå¤„ç†æ¥è‡ªå­è¿›ç¨‹çš„RDMAè¯·æ±‚ã€‚é€šå¸¸ï¼Œæ¯ä¸ªcpuä¸€ä¸ªDCQPå°±è¶³ä»¥å……åˆ†åˆ©ç”¨RDMAã€‚ä½†æ˜¯ï¼Œä»…ä½¿ç”¨DCTæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå­©å­éœ€è¦æå‰çŸ¥é“DCT keyæ‰èƒ½ä¸çˆ¶æ¯é€šä¿¡ã€‚å› æ­¤ï¼ŒMITOSISå®ç°äº†ä¸€ä¸ªå†…æ ¸ç©ºé—´â€fast RPCâ€æ¥å¼•å¯¼DCTã€‚fastæ˜¯ä¸€ä¸ªåŸºäºudçš„RPCï¼Œæ”¯æŒæ— è¿æ¥ã€‚ä½¿ç”¨RPCï¼Œæˆ‘ä»¬åœ¨RPCè¯·æ±‚ä¸­è£…è½½ä¸çˆ¶å¯¹è±¡å…³è”çš„DCTé”®ï¼Œä»¥æŸ¥è¯¢çˆ¶å¯¹è±¡çš„æè¿°ç¬¦ã€‚ä¸ºäº†èŠ‚çœCPUèµ„æºï¼Œæˆ‘ä»¬åªéƒ¨ç½²äº†ä¸¤ä¸ªå†…æ ¸çº¿ç¨‹æ¥å¤„ç†rpc.</p><h2 id="3ï¼‰Virtual-memory-management"><a href="#3ï¼‰Virtual-memory-management" class="headerlink" title="3ï¼‰Virtual memory management"></a>3ï¼‰Virtual memory management</h2><p>ä¸ºäº†æé«˜resumeæ•ˆç‡ï¼Œç›´æ¥å°†å­èŠ‚ç‚¹æ˜ å°„é¡µé¢çš„é¡µè¡¨é¡¹(PTE)è®¾ç½®ä¸ºçˆ¶èŠ‚ç‚¹çš„ç‰©ç†åœ°å€(PA)ã€‚ä½¿ç”¨ä¸€ä¸ªPTEä¸­çš„remote bitæ¥è¿›è¡ŒåŒºåˆ†ï¼ˆremote bitä½äºPTEæœªè¢«åˆ©ç”¨çš„é«˜ä½ï¼‰ã€‚åœ¨resumeè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šè®¾ç½®remote bitå¹¶æ¸…é™¤present bitï¼Œå½“å­è¿›ç¨‹è®¿é—®é‡Œè¯¥PTEï¼Œå°±ä¼šè¿›å…¥ç¼ºé¡µä¸­æ–­ï¼Œä»è€Œå‡ºå‘RDMAè¿œç¨‹è¯»å–ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png" alt="æˆªå±2023-01-16 13.18.22"></p><p>å¦‚æœé”™è¯¯é¡µæ²¡æœ‰æ˜ å°„åˆ°çˆ¶é¡µï¼Œä¾‹å¦‚å †æ ˆå¢é•¿ï¼Œæˆ‘ä»¬å°±åƒå¤„ç†æ™®é€šçš„é¡µé”™è¯¯ä¸€æ ·åœ¨æœ¬åœ°å¤„ç†å®ƒã€‚<br>å¦åˆ™ï¼Œæ£€æŸ¥æ•…éšœè™šæ‹Ÿåœ°å€VA (virtual address)æ˜¯å¦æ˜ å°„äº†è¿œç«¯PAã€‚ä½¿ç”¨å•è¾¹RDMAå°†è¿œç¨‹pageè¯»åˆ°æœ¬åœ°é¡µã€‚å¤§å¤šæ•°å­é¡µé¢éƒ½å¯ä»¥é€šè¿‡RDMAæ¢å¤ã€‚åœ¨é”™è¿‡æ˜ å°„çš„æƒ…å†µä¸‹ï¼Œåˆ™ä½¿ç”¨RPCæ˜ å°„ã€‚</p><p>RPCï¼šæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ªå›é€€å®ˆæŠ¤è¿›ç¨‹ï¼Œè¯¥å®ˆæŠ¤è¿›ç¨‹ç”Ÿæˆå†…æ ¸çº¿ç¨‹æ¥å¤„ç†å­èŠ‚ç‚¹çš„é¡µè¯·æ±‚ï¼ˆåŒ…å«çˆ¶èŠ‚ç‚¹æ ‡è¯†ç¬¦å’Œè¯·æ±‚çš„è™šæ‹Ÿåœ°å€ï¼‰ã€‚å›é€€é€»è¾‘: åœ¨æ£€æŸ¥è¯·æ±‚çš„æœ‰æ•ˆæ€§ä¹‹åï¼Œå®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹å°†ä»£è¡¨çˆ¶è¿›ç¨‹åŠ è½½é¡µé¢ã€‚å¦‚æœåŠ è½½æˆåŠŸï¼Œæˆ‘ä»¬å°†æŠŠç»“æœå‘å›ç»™å­è¿›ç¨‹ã€‚</p><p><strong>Access control and isolation</strong></p><p>æˆ‘ä»¬éœ€è¦æ‹’ç»å¯¹ä¸å†å±äºçˆ¶èŠ‚ç‚¹çš„æ˜ å°„é¡µçš„è®¿é—®ï¼Œå¹¶æ­£ç¡®éš”ç¦»å¯¹ä¸åŒå®¹å™¨çš„è®¿é—®ã€‚</p><p>ç›´æ¥æš´éœ²çˆ¶èŠ‚ç‚¹çš„ç‰©ç†å†…å­˜å¯ä»¥æé«˜è¿œç¨‹forkçš„é€Ÿåº¦ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éœ€è¦æ‹’ç»å¯¹ä¸å†å±äºçˆ¶èŠ‚ç‚¹çš„æ˜ å°„é¡µçš„è®¿é—®ï¼Œå¹¶æ­£ç¡®éš”ç¦»å¯¹ä¸åŒå®¹å™¨çš„è®¿é—®ã€‚ç”±äºæˆ‘ä»¬ä»¥cpuæ—è·¯çš„æ–¹å¼é€šè¿‡å•è¾¹RDMAå…¬å¼€å†…å­˜ï¼Œå› æ­¤åªèƒ½åˆ©ç”¨RNICè¿›è¡Œæ§åˆ¶ã€‚</p><p>MITOSISç”¨ä¸€ç§åŸºäºè¿æ¥çš„å†…å­˜è®¿é—®æ§åˆ¶æ–¹æ³•ã€‚å°†ä¸åŒçš„RDMAè¿æ¥åˆ†é…åˆ°çˆ¶è™šæ‹Ÿå†…å­˜åŒºåŸŸ(VMA)çš„ä¸åŒéƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼Œæ¯ä¸ªVMAä¸€ä¸ªè¿æ¥ã€‚å¦‚æœæ˜ å°„çš„ç‰©ç†é¡µä¸å†å±äºçˆ¶é¡µï¼Œæˆ‘ä»¬å°†ç ´åä¸è¯¥é¡µçš„VMAç›¸å…³çš„è¿æ¥ã€‚å› æ­¤ï¼Œchildå¯¹é¡µé¢çš„è®¿é—®å°†è¢«RNICæ‹’ç»ã€‚æ‰€æœ‰è¿æ¥éƒ½åœ¨å†…æ ¸ä¸­è¿›è¡Œç®¡ç†ï¼Œä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·è®¿é—®é”™è¯¯çš„è¿œç¨‹å®¹å™¨å†…å­˜ã€‚</p><p>ä¸ºäº†å®ç°åŸºäºè¿æ¥çš„è®¿é—®æ§åˆ¶ï¼Œæ¯ä¸ªè¿æ¥åœ¨åˆ›å»ºå’Œå­˜å‚¨æ—¶éƒ½å¿…é¡»é«˜æ•ˆã€‚å¹¸è¿çš„æ˜¯ï¼ŒDCQPå¾ˆå¥½åœ°æ»¡è¶³äº†è¿™äº›è¦æ±‚ã€‚åœ¨å­ç«¯ï¼Œæ¯ä¸ªè¿æ¥(DC key)åªæ¶ˆè€—12B ï¼Œä¸åŒçš„DCè¿æ¥å¯ä»¥å…±äº«ç›¸åŒçš„DCQPã€‚parent-side DC target consumes 144Bã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png" alt="æˆªå±2023-01-16 13.34.56"></p><p>å›¾ç‰‡è¡¨ç¤ºäº†åŸºäºdctçš„è®¿é—®æ§åˆ¶ã€‚åœ¨å‡†å¤‡åˆ†å‰æ—¶ï¼ŒMITOSISä»ç›®æ ‡æ± ä¸­é€‰æ‹©ä¸€ä¸ªDCç›®æ ‡åˆ†é…ç»™æ¯ä¸ªparent VMAã€‚poolåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œå¹¶åœ¨åå°å®šæœŸå¡«å……ã€‚è¿™äº›ç›®æ ‡çš„DC keyè¢«è£…è½½åœ¨çˆ¶è¿›ç¨‹çš„æè¿°ç¬¦ä¸­ï¼Œä»¥ä¾¿å­è¿›ç¨‹åœ¨æ¢å¤è¿‡ç¨‹ä¸­å¯ä»¥å°†å®ƒä»¬è®°å½•åœ¨VMAä¸­ã€‚åœ¨è¯»å–çˆ¶èŠ‚ç‚¹çš„pageæ—¶ï¼Œå­èŠ‚ç‚¹å°†ä½¿ç”¨ä¸é¡µé¢VMAå¯¹åº”çš„keyæ¥å‘å‡ºRDMAè¯·æ±‚ã€‚ä½¿ç”¨æ­¤æ–¹æ¡ˆï¼Œå¦‚æœparentæƒ³è¦æ‹’ç»å¯¹è¯¥é¡µçš„è®¿é—®ï¼Œå®ƒå¯ä»¥é”€æ¯ç›¸åº”çš„DCç›®æ ‡ã€‚</p><h2 id="Pre-fetching-and-caching"><a href="#Pre-fetching-and-caching" class="headerlink" title="Pre-fetching and caching"></a>Pre-fetching and caching</h2><p>æ­¤å¤„ä¼¼ä¹æœ‰ä¸€å®šä¼˜åŒ–ç©ºé—´ï¼Ÿå¯ä»¥é‡‡ç”¨è®¡æ•°æ³•æå‡cacheå‘½ä¸­ç‡ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab4 Trap</title>
      <link href="/2023/01/13/MIT-6-s081-Lab4/"/>
      <url>/2023/01/13/MIT-6-s081-Lab4/</url>
      
        <content type="html"><![CDATA[<h2 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int g(int x) &#123;</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 &lt;g&gt;:</span><br><span class="line">#include &quot;kernel/param.h&quot;</span><br><span class="line">#include &quot;kernel/types.h&quot;</span><br><span class="line">#include &quot;kernel/stat.h&quot;</span><br><span class="line">#include &quot;user/user.h&quot;</span><br><span class="line"></span><br><span class="line">int g(int x) &#123;</span><br><span class="line">   0:1141                addisp,sp,-16</span><br><span class="line">   2:e422                sds0,8(sp)</span><br><span class="line">   4:0800                addis0,sp,16</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line">   6:250d                addiwa0,a0,3</span><br><span class="line">   8:6422                lds0,8(sp)</span><br><span class="line">   a:0141                addisp,sp,16</span><br><span class="line">   c:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000000e &lt;f&gt;:</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">   e:1141                addisp,sp,-16</span><br><span class="line">  10:e422                sds0,8(sp)</span><br><span class="line">  12:0800                addis0,sp,16</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line">  14:250d                addiwa0,a0,3</span><br><span class="line">  16:6422                lds0,8(sp)</span><br><span class="line">  18:0141                addisp,sp,16</span><br><span class="line">  1a:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  1c:1141                addisp,sp,-16</span><br><span class="line">  1e:e406                sdra,8(sp)</span><br><span class="line">  20:e022                sds0,0(sp)</span><br><span class="line">  22:0800                addis0,sp,16</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  24:4635                lia2,13</span><br><span class="line">  26:45b1                lia1,12</span><br><span class="line">  28:00000517          auipca0,0x0</span><br><span class="line">  2c:7a850513          addia0,a0,1960 # 7d0 &lt;malloc+0xe8&gt;</span><br><span class="line">  30:00000097          auipcra,0x0</span><br><span class="line">  34:600080e7          jalr1536(ra) # 630 &lt;printf&gt;</span><br><span class="line">  exit(0);</span><br><span class="line">  38:4501                lia0,0</span><br><span class="line">  3a:00000097          auipcra,0x0</span><br><span class="line">  3e:28e080e7          jalr654(ra) # 2c8 &lt;exit&gt;</span><br><span class="line"></span><br><span class="line">0000000000000042 &lt;_main&gt;:</span><br><span class="line">//</span><br><span class="line">// wrapper so that it&#x27;s OK if main() does not call exit().</span><br><span class="line">//</span><br><span class="line">void</span><br><span class="line">_main()</span><br><span class="line">&#123;</span><br><span class="line">  42:1141                addisp,sp,-16</span><br><span class="line">  44:e406                sdra,8(sp)</span><br><span class="line">  46:e022                sds0,0(sp)</span><br><span class="line">  48:0800                addis0,sp,16</span><br><span class="line">  extern int main();</span><br><span class="line">  main();</span><br><span class="line">  4a:00000097          auipcra,0x0</span><br><span class="line">  4e:fd2080e7          jalr-46(ra) # 1c &lt;main&gt;</span><br><span class="line">  exit(0);</span><br><span class="line">  52:4501                lia0,0</span><br><span class="line">  54:00000097          auipcra,0x0</span><br><span class="line">  58:274080e7          jalr628(ra) # 2c8 &lt;exit&gt;</span><br><span class="line"></span><br><span class="line">000000000000005c &lt;strcpy&gt;:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="RISC-V-trap-machinery"><a href="#RISC-V-trap-machinery" class="headerlink" title="RISC-V trap machinery"></a>RISC-V trap machinery</h2><ul><li>stvec ï¼šå†…æ ¸åœ¨è¿™é‡Œå†™å…¥å®ƒçš„trapå¤„ç†ç¨‹åºçš„åœ°å€;RISC-Vè·³è½¬åˆ°stvecä¸­çš„åœ°å€æ¥å¤„ç†trapã€‚</li><li>sepcï¼šå½“ä¸€ä¸ªtrapå‘ç”Ÿæ—¶ï¼ŒRISC-Vå°†ç¨‹åºè®¡æ•°å™¨ä¿å­˜åœ¨è¿™é‡Œ(å› ä¸ºpcä¼šè¢«stvecä¸­çš„å€¼è¦†ç›–)ã€‚sret (return from trap)æŒ‡ä»¤å°†sepcå¤åˆ¶åˆ°pcä¸Šã€‚å†…æ ¸å¯ä»¥ç¼–å†™sepcæ¥æ§åˆ¶sretçš„ä½ç½®ã€‚</li><li>scauseï¼šRISC-Våœ¨è¿™é‡Œæ”¾äº†ä¸€ä¸ªæ•°å­—æ¥æè¿°trapçš„åŸå› ã€‚</li><li>sscratchï¼š trapå¤„ç†ç¨‹åºä»£ç ä½¿ç”¨sscratchæ¥é¿å…åœ¨ ä¿å­˜ç”¨æˆ·å¯„å­˜å™¨ä¹‹å‰è¦†ç›–ç”¨æˆ·å¯„å­˜å™¨ã€‚</li><li>sstatusï¼šsstatusä¸­çš„SIEä½æ§åˆ¶æ˜¯å¦å¯ç”¨è®¾å¤‡ä¸­æ–­ã€‚å¦‚æœå†…æ ¸æ¸…é™¤äº†SIE, RISC-Vå°†å»¶è¿Ÿè®¾å¤‡ä¸­æ–­ï¼Œç›´åˆ°å†…æ ¸è®¾ç½®äº†SIEã€‚SPPä½è¡¨ç¤ºtrapæ¥è‡ªç”¨æˆ·æ¨¡å¼è¿˜æ˜¯ç®¡ç†æ¨¡å¼ï¼Œå¹¶æ§åˆ¶sretè¿”å›å“ªç§æ¨¡å¼ã€‚</li></ul><p>RISC-Vä¸­æ–­å‘ç”Ÿè¿‡ç¨‹ï¼š</p><ol><li>å¦‚æœè®¾å¤‡ä¸­æ–­ï¼Œä¸”sstatus SIEä½ä¸ºæ¸…é›¶ï¼Œåˆ™æ— éœ€æ‰§è¡Œä»¥ä¸‹æ“ä½œ</li><li>é€šè¿‡æ¸…é™¤sstatusä¸­çš„SIEä½æ¥ç¦ç”¨ä¸­æ–­ã€‚</li><li>Copy the pc to sepc.</li><li>å°†å½“å‰æ¨¡å¼(useræˆ–supervisor)ä¿å­˜åœ¨sstatusçš„SPPä½ä¸­ã€‚</li><li>è®¾ç½®åŸå› ä»¥åæ˜ é™·é˜±çš„åŸå› ã€‚</li><li>Set the mode to supervisor</li><li>Copy stvec to the pc.</li><li>åœ¨æ–°çš„pcä½ç½®å¼€å§‹æ‰§è¡Œ</li></ol><h2 id="User-Trap"><a href="#User-Trap" class="headerlink" title="User Trap"></a>User Trap</h2><p>ç”¨æˆ·ä¸­æ–­å½“ç”¨æˆ·è°ƒç”¨äº†ecallæŒ‡ä»¤æ—¶å‘ç”Ÿï¼ˆæˆ–å‘ç”Ÿäº†éæ³•æ“ä½œæˆ–ç¡¬ä»¶ä¸­æ–­ï¼‰ã€‚</p><p>ç”¨æˆ·å‘ç”Ÿä¸­æ–­ï¼š<br>step1: uservec<br>step2: usertrap</p><p>å½“ä¸­æ–­è¿”å›ï¼š<br>step1: usertrapret<br>step2: userret</p><h3 id="1-å‘ç”Ÿä¸­æ–­"><a href="#1-å‘ç”Ÿä¸­æ–­" class="headerlink" title="1. å‘ç”Ÿä¸­æ–­"></a>1. å‘ç”Ÿä¸­æ–­</h3><p>TRAMPOLINE pageåœ¨ç¨‹åºåˆå§‹åŒ–æ—¶æ”¾ç½®ï¼Œä½äºuserè™šæ‹Ÿåœ°å€çš„é¡¶éƒ¨ï¼ŒåŒæ—¶TRAMPOLINEåœ¨å†…æ ¸é¡µè¡¨ä¹Ÿè¢«æ˜ å°„ã€‚ä¸”æ²¡æœ‰ PTE_Uæ ‡å¿—ã€‚å› æ­¤trap handleråœ¨åˆ‡æ¢åˆ°å†…æ ¸pageåå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png" alt="æˆªå±2023-01-13 23.20.51"></p><p>ä¸ºäº†ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œuservecä¼šå°†ç”¨æˆ·å¯„å­˜å™¨çŠ¶æ€ä¿å­˜åœ¨TRAPFRAMEï¼ˆä¸€ä¸ªç»“æ„ä½“ï¼‰ã€‚TRAPFRAME åœ¨ TRAMPOLINEä¹‹ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct trapframe &#123;</span><br><span class="line">  /*   0 */ uint64 kernel_satp;   // kernel page table</span><br><span class="line">  /*   8 */ uint64 kernel_sp;     // top of process&#x27;s kernel stack</span><br><span class="line">  /*  16 */ uint64 kernel_trap;   // usertrap()</span><br><span class="line">  /*  24 */ uint64 epc;           // saved user program counter</span><br><span class="line">  /*  32 */ uint64 kernel_hartid; // saved kernel tp</span><br><span class="line">  /*  40 */ uint64 ra;</span><br><span class="line">  /*  48 */ uint64 sp;</span><br><span class="line">  /*  56 */ uint64 gp;</span><br><span class="line">  /*  64 */ uint64 tp;</span><br><span class="line">  /*  72 */ uint64 t0;</span><br><span class="line">  /*  80 */ uint64 t1;</span><br><span class="line">  ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>TRAPFRAMEä¸­ä¿å­˜äº†å†…æ ¸pageçš„ä¿¡æ¯å’Œcpuä¿¡æ¯ï¼Œuservecä»è¿™é‡Œè·å–ä¿¡æ¯ã€‚ç„¶åæ‰§è¡Œusertrapã€‚</p><p> usertrapçš„å·¥ä½œæ˜¯ç¡®å®štrapçš„åŸå› , è¿è¡Œtrapå¹¶è¿”å›ã€‚usertrapé¦–å…ˆä¼šä¿å­˜sepcï¼ˆç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ï¼‰ã€‚å¦‚æœè¯¥trapæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™usertrapè°ƒç”¨sycallæ¥å¤„ç†å®ƒ;å¦‚æœè®¾å¤‡ä¸­æ–­ï¼Œdevintr;å¦åˆ™å®ƒæ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œå†…æ ¸ä¼šç»ˆæ­¢å‘ç”Ÿæ•…éšœçš„è¿›ç¨‹ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨è·¯å¾„åœ¨ä¿å­˜çš„ç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ä¸Šå¢åŠ äº†4ï¼Œå› ä¸ºRISC-Våœ¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä»£ç éœ€è¦åœ¨åç»­æŒ‡ä»¤å¤„æ¢å¤æ‰§è¡Œï¼ˆä¸èƒ½åå¤æ‰§è¡Œsys callï¼‰ã€‚åœ¨é€€å‡ºè¿‡ç¨‹ä¸­ï¼Œusertrapæ£€æŸ¥è¿›ç¨‹æ˜¯å¦å·²ç»è¢«æ€æ­»æˆ–åº”è¯¥äº§ç”ŸCPU(å¦‚æœè¿™ä¸ªtrapæ˜¯ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­)ã€‚</p><h3 id="2-ä¸­æ–­è¿”å›"><a href="#2-ä¸­æ–­è¿”å›" class="headerlink" title="2. ä¸­æ–­è¿”å›"></a>2. ä¸­æ–­è¿”å›</h3><p>è¿”å›ç¬¬ä¸€æ­¥æ˜¯è¿è¡Œusertrapretã€‚ç„¶åæ‰§è¡Œuserretã€‚è¿™ä¿©æ¢å¤äº†ä¸€äº›å¯„å­˜å™¨çŠ¶æ€ï¼Œè¿”å›ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="initcode-Sï¼ˆå¦‚ä½•è°ƒç”¨sys-callï¼‰"><a href="#initcode-Sï¼ˆå¦‚ä½•è°ƒç”¨sys-callï¼‰" class="headerlink" title="initcode.Sï¼ˆå¦‚ä½•è°ƒç”¨sys callï¼‰"></a>initcode.Sï¼ˆå¦‚ä½•è°ƒç”¨sys callï¼‰</h2><p>initcode.Så°†execçš„å‚æ•°æ”¾åœ¨å¯„å­˜å™¨a0å’Œa1ä¸­ï¼Œå¹¶å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨a7ä¸­ã€‚ç³»ç»Ÿè°ƒç”¨å·åŒ¹é…syscallsæ•°ç»„ä¸­çš„æ¡ç›®ï¼Œsyscallsæ•°ç»„æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ(kernel/syscall.c:107)ã€‚è°ƒç”¨æŒ‡ä»¤è¢«æ•è·åˆ°å†…æ ¸ä¸­ï¼Œå¹¶å¯¼è‡´uservecã€usertrapå’Œsycallæ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">la a0, init</span><br><span class="line">la a1, argv</span><br><span class="line">li a7, SYS_exec</span><br><span class="line">ecall</span><br></pre></td></tr></table></figure><p>Syscall (kernel/ Syscall .c:132) ä»trapframeä¸­ä¿å­˜çš„a7ä¸­è·å–ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¹¶ä½¿ç”¨å®ƒç´¢å¼•åˆ°ç³»ç»Ÿè°ƒç”¨ä¸­ã€‚å¯¹äºç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œa7åŒ…å«SYS_exec (ker- nel/ sycall .h:8)ï¼Œå¯¼è‡´è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å®ç°å‡½æ•°SYS_execã€‚</p><p>å½“sys_execè¿”å›æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨å°†è¿”å›å€¼è®°å½•åœ¨p-&gt;trapframe-&gt;a0ä¸­ã€‚è¿™å°†å¯¼è‡´å¯¹exec()çš„åŸå§‹ç”¨æˆ·ç©ºé—´è°ƒç”¨è¿”å›è¯¥å€¼ï¼Œå› ä¸ºRISC-Vä¸Šçš„Ccallçº¦å®šå°†è¿”å›å€¼æ”¾åœ¨a0ä¸­ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨é€šå¸¸è¿”å›è´Ÿæ•°è¡¨ç¤ºé”™è¯¯ï¼Œè¿”å›é›¶æˆ–æ­£æ•°è¡¨ç¤ºæˆåŠŸã€‚å¦‚æœç³»ç»Ÿè°ƒç”¨å·æ— æ•ˆï¼Œç³»ç»Ÿè°ƒç”¨å°†æ‰“å°é”™è¯¯å¹¶è¿”å›âˆ’1ã€‚</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png" alt="æˆªå±2023-01-15 00.09.58"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab3 Page Table</title>
      <link href="/2023/01/10/MIT6-s081-Lab3-Page-Table/"/>
      <url>/2023/01/10/MIT6-s081-Lab3-Page-Table/</url>
      
        <content type="html"><![CDATA[<h2 id="é¡µè¡¨ç»“æ„æ¨å¯¼"><a href="#é¡µè¡¨ç»“æ„æ¨å¯¼" class="headerlink" title="é¡µè¡¨ç»“æ„æ¨å¯¼"></a>é¡µè¡¨ç»“æ„æ¨å¯¼</h2><p>RICS-Væ¶æ„ï¼Œ2^39bitå†…å­˜å¯ç”¨ï¼Œ2^37Byteã€‚æ¯é¡µæ˜¯4096Byteï¼Œ2^12 Byte</p><p>é€»è¾‘ä¸Šï¼Œé¡µè¡¨éœ€è¦2^27ä¸ªpteï¼Œä»¥æ˜ å°„å…¨éƒ¨ç‰©ç†åœ°å€(pteæ˜¯é¡µè¡¨ä¸­å¯¹ä»¥åº”ä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€çš„ä¿¡æ¯å­˜å‚¨å•å…ƒ)ã€‚</p><p>æ¯ä¸ªpteåŒ…å«64bitï¼ˆ44bit PNNï¼Œä¸€äº›Flagï¼‰ã€‚ä»¥ä¸‹ä¸ºpteç»“æ„ï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png" alt="æˆªå±2023-01-11 13.57.28"></p><p>ä½†æ˜¯ï¼Œ2^27ä¸ªpteéœ€è¦å†…å­˜ï¼š2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MBã€‚è‹¥å­˜å‚¨å…¨éƒ¨è¿›ç¨‹çš„pteåˆ™éœ€è¦å ç”¨å¤§é‡å†…å­˜ã€‚å› æ­¤ä½¿ç”¨ä¸‰çº§é¡µè¡¨ç»“æ„ï¼š</p><p>ä¸€ä¸ªé¡µè¡¨é¡µï¼ŒåŒ…å«512ä¸ªpteã€‚512^3=(2^9)^3ï¼Œå› æ­¤ç†è®ºä¸Šå¯ä»¥ä½¿ç”¨ä¸‰çº§é¡µè¡¨è¡¨ç¤ºå…¨éƒ¨çš„ç‰©ç†åœ°å€ã€‚å½“ä¸€å—è™šæ‹Ÿåœ°å€æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œåˆ™ç›¸åº”çš„é¡µè¡¨ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨å†…å­˜ã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png" alt="æˆªå±2023-01-11 13.30.54"></p><p>æ ¹æ®è™šæ‹Ÿåœ°å€ï¼Œè·å–ç›¸åº”pte (è‹¥è¯¥è™šæ‹Ÿåœ°å€æœªè¢«åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„é¡µè¡¨åˆå§‹åŒ–)ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// pagetable æ ¹é¡µè¡¨</span><br><span class="line">// va è™šæ‹Ÿåœ°å€</span><br><span class="line">// allocæ˜¯å¦åˆå§‹åŒ–</span><br><span class="line">pte_t* walk(pagetable_t pagetable, uint64 va, int alloc)&#123;</span><br><span class="line">  if(va &gt;= MAXVA)</span><br><span class="line">    panic(&quot;walk&quot;);</span><br><span class="line"></span><br><span class="line">// ä¸‰çº§é¡µè¡¨</span><br><span class="line">  for(int level = 2; level &gt; 0; level--) &#123;</span><br><span class="line">    pte_t *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">    if(*pte &amp; PTE_V) &#123; //å·²ç»åˆ†é…</span><br><span class="line">      pagetable = (pagetable_t)PTE2PA(*pte); //è·³è½¬åˆ°ä¸‹ä¸€çº§é¡µè¡¨</span><br><span class="line">    &#125; else &#123; // ä¸ºåˆ†é…æ­¤çº§é¡µè¡¨</span><br><span class="line">      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //åˆ†é…ä¸€é¡µï¼Œå¹¶è·³è½¬åˆ°ä¸‹ä¸€çº§é¡µè¡¨</span><br><span class="line">        return 0;</span><br><span class="line">      memset(pagetable, 0, PGSIZE); //åˆå§‹åŒ–é¡µ</span><br><span class="line">      *pte = PA2PTE(pagetable) | PTE_V; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return &amp;pagetable[PX(0, va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸åœ°å€ç©ºé—´"><a href="#å†…æ ¸åœ°å€ç©ºé—´" class="headerlink" title="å†…æ ¸åœ°å€ç©ºé—´"></a>å†…æ ¸åœ°å€ç©ºé—´</h2><h2 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h2><h2 id="Labç»“æœ"><a href="#Labç»“æœ" class="headerlink" title="Labç»“æœ"></a>Labç»“æœ</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png" alt="æˆªå±2023-01-13 15.03.29"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.s081 Lab2 System Call</title>
      <link href="/2023/01/10/6-s081-Lab2-System-Call/"/>
      <url>/2023/01/10/6-s081-Lab2-System-Call/</url>
      
        <content type="html"><![CDATA[<h2 id="xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ"><a href="#xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ" class="headerlink" title="xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ"></a>xv6ç³»ç»Ÿç”¨æˆ·æ€è°ƒç”¨syscallè¿‡ç¨‹åˆ†æ</h2><ul><li>/user/usys.S æ˜¯ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€çš„æ±‡ç¼–è„šæœ¬ï¼Œè¯¥æ–‡ä»¶ç”±usys.plç”Ÿæˆ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global sysinfo</span><br><span class="line">sysinfo:</span><br><span class="line"> li a7, SYS_sysinfo  # å°†syscallçš„æ ‡è¯†å†™å…¥a7å¯„å­˜å™¨</span><br><span class="line"> ecall               # ä½¿ç”¨ecallæŒ‡ä»¤ï¼Œä½¿ç”¨a7å¯„å­˜å™¨ï¼Œè¿›å…¥å†…æ ¸æ€</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure><ul><li>/kernal/syscall.cï¼Œè¯¥å‡½æ•°è·å–ç”¨æˆ·æ€ä¼ é€’çš„syscall idï¼Œå¹¶è¿›è¡Œè°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void syscall(void) &#123;</span><br><span class="line">  int num;</span><br><span class="line">  struct proc *p = myproc(); //è·å–è¿›å…¥å†…æ ¸æ€çš„è¿›ç¨‹</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;    //è·å–éœ€è¦æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨idï¼Œè¯¥idç”±usys.Så†™å…¥äº†a7å¯„å­˜å™¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123; # ä½¿ç”¨syscallçš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨</span><br><span class="line">  </span><br><span class="line">    // Use num to lookup the system call function for num, call it,</span><br><span class="line">    // and store its return value in p-&gt;trapframe-&gt;a0</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num](); #å°†syscallè¿”å›å€¼ä¿å­˜åœ¨a0å¯„å­˜å™¨ï¼Œé€šè¿‡æ­¤æ–¹æ³•å°†è¿”å›å€¼ä¼ é€’ç»™ç”¨æˆ·æ€</span><br><span class="line">    </span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    printf(&quot;%d %s: unknown sys call %d\n&quot;,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = -1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/kernal/sysproc.cï¼Œè¯¥æ–‡ä»¶æ˜¯lab2ä¸­syscallçš„å®ç°ä»£ç æ–‡ä»¶</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//å®ç°syscall,è¯¥å‡½æ•°éœ€åœ¨syscall.cä¸­å£°æ˜</span><br><span class="line">uint64 sys_trace(void)&#123;</span><br><span class="line"></span><br><span class="line">// è·å–system call å‚æ•°</span><br><span class="line">    int muskid;</span><br><span class="line">    argint(0,&amp;muskid);</span><br><span class="line"></span><br><span class="line">    return trace(muskid); //do something and return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ syscallæµç¨‹"><a href="#æ·»åŠ syscallæµç¨‹" class="headerlink" title="æ·»åŠ syscallæµç¨‹"></a>æ·»åŠ syscallæµç¨‹</h2><ol><li><p>åœ¨syscall.hä¸­æ·»åŠ ä¸€ä¸ªsyscall id</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define SYS_trace  22</span><br><span class="line">#define SYS_sysinfo  23</span><br></pre></td></tr></table></figure></li><li><p>åœ¨syscall.cä¸­æ·»åŠ syscallçš„å‡½æ•°å®šä¹‰</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extern uint64 sys_trace(void);</span><br><span class="line">extern uint64 sys_sysinfo(void);</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[SYS_trace]   sys_trace,</span><br><span class="line">[SYS_sysinfo]   sys_sysinfo</span><br></pre></td></tr></table></figure></li><li><p>åœ¨sysprocä¸­å®ç°syscallå‡½æ•°</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uint64 sys_trace(void)&#123;</span><br><span class="line">    int muskid;</span><br><span class="line"></span><br><span class="line">    // è·å–system call å‚æ•°</span><br><span class="line">    argint(0,&amp;muskid);</span><br><span class="line"></span><br><span class="line">    return trace(muskid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨/user/usys.plåŠ å…¥ç³»ç»Ÿè°ƒç”¨å£°æ˜</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry(&quot;trace&quot;);</span><br><span class="line">entry(&quot;sysinfo&quot;);</span><br></pre></td></tr></table></figure></li></ol><p>è¿™æ ·ä»¥æ¥ï¼Œç”¨æˆ·æ€å‘å†…æ ¸æ€ä¼ é€’syscall id(a7)ï¼Œå†…æ ¸æ€æ ¹æ®idå¯¹ç›¸åº”çš„syscallè¿›è¡Œè°ƒç”¨ï¼Œå¹¶å°†è¿”å›å€¼å‚¨å­˜åœ¨a0å¯„å­˜å™¨ã€‚</p><h2 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h2><h2 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png" alt="æˆªå±2023-01-10 02.03.22"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Log framework High level design</title>
      <link href="/2022/12/06/Log-fremawork-High-level-design/"/>
      <url>/2022/12/06/Log-fremawork-High-level-design/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºäº†æå‡goè¯­è¨€çš„ç†Ÿç»ƒç¨‹åº¦ï¼Œä½¿ç”¨goè¯­è¨€ç¼–å†™ä¸€ä¸ªeasy log framework. This is the high level design for this framework.</p><h2 id="Requirement-Analysis"><a href="#Requirement-Analysis" class="headerlink" title="Requirement Analysis"></a>Requirement Analysis</h2><h3 id="1-Log-levels"><a href="#1-Log-levels" class="headerlink" title="1. Log levels"></a>1. Log levels</h3><p>â€‹    ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE</p><h3 id="2-Basic-requirement"><a href="#2-Basic-requirement" class="headerlink" title="2. Basic requirement"></a>2. Basic requirement</h3><p>ç”¨æˆ·éœ€è¦åœ¨æ¯ä¸ªéœ€è¦ä½¿ç”¨æ—¥å¿—çš„ç±»ä¸­å£°æ˜ä¸€ä¸ªEasyLogå¯¹è±¡ã€‚åˆ©ç”¨å·¥å‚æ¨¡å¼å£°æ˜ï¼Œå·¥å‚æ–¹æ³•å¯é€‰ä¸€ä¸‹å‡ ç§å‚æ•°ï¼š</p><ul><li></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cross-domain security in SSO</title>
      <link href="/2022/12/01/Cross-domain-security-in-SSO/"/>
      <url>/2022/12/01/Cross-domain-security-in-SSO/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºCasdoor Flutter Sdké‡åˆ°äº†è·¨åŸŸé—®é¢˜ï¼Œæ•…è°ƒç ”Oktaå’ŒAuth0çš„è·¨åŸŸé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæ–¹æ¡ˆåˆæ­¥æ•´ç†å¦‚ä¸‹ï¼š</p><h2 id="è§£å†³ç­–ç•¥"><a href="#è§£å†³ç­–ç•¥" class="headerlink" title="è§£å†³ç­–ç•¥"></a>è§£å†³ç­–ç•¥</h2><p>åœ¨å•ç‚¹ç™»å½•ç³»ç»Ÿä¸­ï¼ŒSingle-Page Appéœ€è¦ä»æµè§ˆå™¨è·¨åŸŸè®¿é—®SSOæœåŠ¡å™¨ã€‚ä¸ºæ”¯æŒè¿™ä¸€éœ€æ±‚ï¼Œå•ç‚¹ç™»å½•ç³»ç»Ÿåº”æ”¯æŒé…ç½®â€œAllowed Web Originsâ€å’Œâ€œAllowed APIâ€ã€‚SSOæœåŠ¡å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªé…ç½®å¯¹è·¨åŸŸè¯·æ±‚è¿›è¡Œæ ¡éªŒã€‚</p><blockquote><p>å®šä¹‰ï¼š</p><ul><li><p><strong>Single-Page App</strong>ï¼šå•é¡µåº”ç”¨ã€‚ä¸ºä¸åŒ…å«åç«¯çš„çº¯webé¡µé¢</p></li><li><p><strong>Allowed Web Origins</strong>ï¼šå…è®¸è·¨åŸŸè®¿é—®çš„ç½‘ç»œæº(Web Origin)ã€‚å°½ç®¡Single-Page Appä¸åŒ…å«åç«¯ï¼Œä½†å…¶ä¾ç„¶ä¼šæŒ‚åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šä»¥æ”¯æŒç”¨æˆ·è®¿é—®ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„Hostå°±æ˜¯Web Origin</p></li><li><p> <strong>Allowed API</strong>ï¼šæ”¯æŒè·¨åŸŸè®¿é—®çš„API</p></li></ul></blockquote><p>ä»¥ä¸‹ä¸ºOktaå’ŒAuth0å¯¹ä¸¤ç§é…ç½®çš„æ”¯æŒæƒ…å†µï¼š</p><table><thead><tr><th align="center"></th><th align="center">Okta</th><th align="center">Auth0</th></tr></thead><tbody><tr><td align="center">Allowed Web Origins</td><td align="center">âœ…</td><td align="center">âœ…</td></tr><tr><td align="center">Allowed API</td><td align="center">âœ…</td><td align="center">â­•ï¸</td></tr></tbody></table><p>å¯¹äºJs sdkï¼Œéœ€å¯¹è·¨åŸŸè®¿é—®çš„è¯·æ±‚å¤´è¿›è¡Œé…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">referrer : Web Origin/path</span><br><span class="line">origin : Web Origin</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œéœ€é’ˆå¯¹Tokençš„å­˜å‚¨æ¨¡å¼æä¾›å®‰å…¨ä¿éšœï¼Œä¾‹å¦‚localstorageå’Œè®¾å®šè¿‡æœŸç­–ç•¥ã€‚<br>ï¼ˆOktaå’ŒAuth0çš„æ•´ä¸ªè·¨åŸŸæ”¯æŒé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæš‚æœªå¼„æ¸…æ•´ä¸ªæµç¨‹å…¨éƒ¨ç»†èŠ‚ï¼‰</p><h2 id="Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"><a href="#Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ" class="headerlink" title="Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"></a>Oktaå¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ</h2><p>Oktaè·¨åŸŸé…ç½®æ•™ç¨‹ï¼š<a href="https://developer.okta.com/docs/guides/enable-cors/main/">https://developer.okta.com/docs/guides/enable-cors/main/</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png" alt="æˆªå±2022-12-01 19.50.59"></p><p>Okta js sdk repoï¼š<a href="https://github.com/okta/okta-auth-js">https://github.com/okta/okta-auth-js</a><br>Okta js sdkæ•™ç¨‹ï¼š<a href="https://developer.okta.com/docs/guides/auth-js/main/">https://developer.okta.com/docs/guides/auth-js/main/</a></p><h2 id="Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"><a href="#Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ" class="headerlink" title="Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ"></a>Auth0å¯¹è·¨åŸŸé—®é¢˜çš„æ”¯æŒ</h2><p>Auth0 js sdkæ•™ç¨‹ï¼š<a href="https://auth0.com/docs/quickstart/spa/vanillajs/interactive">https://auth0.com/docs/quickstart/spa/vanillajs/interactive</a></p><p><img src="https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.48.51.png?raw=true" alt="æˆªå±2022-12-01 19.48.51"></p><p>Auth0 js sdk: <a href="https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js">https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Study Notes about Virtualization 01</title>
      <link href="/2022/11/29/Study-Notes-about-Virtualization-01/"/>
      <url>/2022/11/29/Study-Notes-about-Virtualization-01/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-runtime-environment"><a href="#Docker-runtime-environment" class="headerlink" title="Docker runtime environment"></a>Docker runtime environment</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg" alt="img_3faaf387af747fdecd5530e05bfceeb0"></p><p>Dockeråˆå§‹å‘å±•é«˜åº¦å°é—­ï¼ŒåæœŸè½¬å‘å¼€æ”¾è·¯çº¿ã€‚æ­¤æ—¶Dockerçš„è¿è¡Œä¾èµ–ä¸ºRuncã€‚Runcæ˜¯ä¸€ä¸ªå®ç°äº†OCIï¼ˆ<a href="https://www.opencontainers.org/">Open Container Initiative</a>ï¼‰åè®®çš„ç»„ä»¶ã€‚å› æ­¤å¯ä»¥é€šè¿‡æ”¯æŒOCIåè®®ï¼Œå®ç°å¯¹Runcçš„æ›¿æ¢ï¼Œä»è€Œå®ç°è‡ªå·±çš„Dockerè¿è¡Œæ—¶ä¾èµ–ã€‚</p><p>Userful Linkï¼š<br>Blogï¼š<a href="https://xuanwo.io/2019/08/06/oci-intro/">https://xuanwo.io/2019/08/06/oci-intro/</a><br>OCI Repoï¼š<a href="https://github.com/opencontainers/runtime-spec">https://github.com/opencontainers/runtime-spec</a></p><h2 id="gVisor"><a href="#gVisor" class="headerlink" title="gVisor"></a>gVisor</h2><p><a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html%EF%BC%89">gVisor</a>æ˜¯ä¸€ä¸ªè°·æ­Œçš„å¼€æºé¡¹ç›®ã€‚å®ç°äº†OCIåè®®ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºDockerçš„runtimeã€‚Dockerå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œç¨‹åºæœ‰å¯èƒ½é€ƒé€¸å‡ºContainerï¼Œä»è€Œå¨èƒæ“ä½œç³»ç»Ÿæœ¬èº«è¿è¡Œã€‚å› æ­¤éœ€è¦ä¸€æ¬¾æ›´åŠ å®‰å…¨çš„Runtime applicationã€‚gVisorå°±æ˜¯è¿™æ ·çš„ä¸€æ¬¾appã€‚</p><p>gVisoræ˜¯ä¸€ä¸ªsandboxï¼Œå®ç°äº†ä¸€ä¸ªâ€œåº”ç”¨å†…æ ¸â€â€”â€”Sentryã€‚åŸç†æ˜¯åŠ«æŒäº†åº”ç”¨ç¨‹åºçš„å…¨éƒ¨sys callï¼Œåˆ©ç”¨Ptrace(or KVM)ã€‚SentryåŠ«æŒåˆ°sys callåï¼Œä½¿ç”¨goè¯­è¨€æ¨¡æ‹Ÿå‡ºäº†sys callçš„åŠŸèƒ½ï¼Œä»è€Œå®ç°äº†ä¸€ä¸ªè™šæ‹Ÿå†…æ ¸ã€‚éš”ç¦»äº†ç¨‹åºå’ŒHost Kernelã€‚</p><p>åŒæ—¶gVisoræœ‰ä¸€ä¸ªGoferæ¨¡å—ï¼Œç”¨äºå¤„ç†åº”ç”¨ç¨‹åºçš„IOã€‚</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png" alt="665372-20210108180022427-177964885"></p><h2 id="Learning-Plan"><a href="#Learning-Plan" class="headerlink" title="Learning Plan"></a>Learning Plan</h2><ul><li>Step1: å­¦å®Œgo</li><li>Step2: çœ‹<a href="https://github.com/opencontainers/runc">Runc</a>çš„ä»£ç ï¼Œç ”ç©¶OCIæ€ä¹ˆå®ç°çš„</li><li>Step3: çœ‹<a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html">gVisor</a>çš„ä»£ç ï¼Œç ”ç©¶å®ç°ç»†èŠ‚</li><li>Step4: å®ç°ä¸€ä¸ªè‡ªå·±çš„Docker runtimeï¼Œè¿™ä¸ªRuntimeåº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š<ul><li>ä½¿ç”¨goå®ç°</li><li>ç®€å•è½»é‡ï¼Œä½†å…·æœ‰å®Œå¤‡çš„åŠŸèƒ½ï¼Œå¯ä»¥å®Œç¾çš„ä½œä¸ºä¸€ä¸ªOJç³»ç»Ÿçš„Sandbox</li><li>åˆ©ç”¨Ptraceå®ç°</li><li>æ”¯æŒä½¿ç”¨jsonè‡ªå®šä¹‰sys callçš„è°ƒç”¨è§„åˆ™ï¼ˆAllow Listï¼‰ï¼Œä»¥åŠè¿›è¡Œå†…å­˜æ—¶é—´é™åˆ¶ï¼Œ<del>å¹¶å®ç°ä¸€å¥—ç®€æ˜“çš„å¯¹å¤–äº¤äº’æ¥å£(<a href="https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto">CRI</a>)</del></li><li>æ”¯æŒOCIï¼Œå¯ä»¥ä½œä¸ºDockerçš„runtimeï¼Œæ”¯æŒK8Såˆ†å‘éƒ¨ç½²user codeï¼Œä»è€Œå¯ä»¥ä½œä¸ºOJç³»ç»Ÿçš„è¯„æµ‹é›†ç¾¤Workerï¼Œ</li><li>ä¸¥æ ¼ä¿è¯é«˜ä»£ç è´¨é‡ï¼Œä¿è¯é«˜å¯è¯»æ€§ï¼Œå¯ç»´æŠ¤æ€§</li></ul></li></ul><p>â€‹    </p>]]></content>
      
      
      
        <tags>
            
            <tag> Virtualization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Casdoor Flutter Sdk Bug Fix</title>
      <link href="/2022/11/27/Casdoor-Flutter-Sdk-Bug-Fix/"/>
      <url>/2022/11/27/Casdoor-Flutter-Sdk-Bug-Fix/</url>
      
        <content type="html"><![CDATA[<h2 id="1-å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜"><a href="#1-å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜" class="headerlink" title="1.å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜"></a>1.å®‰å“ï¼Œä¸èƒ½è·³è½¬å›appé—®é¢˜</h2><p>å®‰è£…äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹æµè§ˆå™¨ï¼Œå°±è§£å†³é—®é¢˜äº†ï¼Œå› æ­¤sdkçš„ä»£ç æœ¬èº«åº”è¯¥æ˜¯æ˜¯æ­£ç¡®çš„ï¼ˆåŸå§‹æµè§ˆå™¨ä¸èƒ½è·³è½¬çš„é—®é¢˜æš‚ä¸æ¸…æ¥šåŸå› ï¼Œè¿˜éœ€ç ”ç©¶ï¼‰  </p><h2 id="2-Flutter-webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜"><a href="#2-Flutter-webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜" class="headerlink" title="2.Flutter webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜"></a>2.Flutter webç«¯å­˜åœ¨è·¨åŸŸé—®é¢˜</h2><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg" alt="5DC1E696AFA5781CE5B8C30C59AEFA8F"></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg" alt="D306359D80BF70C7E5350EE14321E2DF"></p><p>è¿™ä¸ªé—®é¢˜ç½‘ä¸Šæœ‰å¾ˆå¤šè®¨è®ºï¼Œå•ä»Flutterçš„è§’åº¦æ¥è¯´ï¼Œå¥½åƒæ²¡æœ‰å®Œç¾è§£å†³æ–¹æ¡ˆã€‚ </p><blockquote><p>è¿™ä¸€å—æˆ‘ä¸æ¸…æ¥šæˆ‘ç†è§£çš„å¯¹ä¸å¯¹ï¼š</p><p>æˆ‘ç ”ç©¶äº†ä¸€ä¸‹Casdoor js sdkçš„é€»è¾‘ï¼Œä½¿ç”¨äº†js sdkçš„é¡¹ç›®é‡Œï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°æµè§ˆå™¨ç›´æ¥å‘Casdoorå‘é€è¯·æ±‚è·å–tokençš„ä¾‹å­ã€‚ </p><p>1.casdoor-python-vue-sdk-exampleè¿™ä¸ªrepoï¼Œtokenæ˜¯é€šè¿‡åç«¯çš„pyç¨‹åºè·å–çš„ï¼Œåº”è¯¥ä¸æ˜¯æµè§ˆå™¨ç›´æ¥å‘casdoorå‘è¯·æ±‚ã€‚</p><p>2.casdoor-raw-js-exampleè¿™ä¸ªrepoï¼Œæ˜¯ç”¨node.jså¯åŠ¨é¡¹ç›®ï¼ˆå¹¶ä¸”å¯åŠ¨äº†ä¸€ä¸ªä»£ç†serverï¼Œç”±è¿™ä¸ªserverå‘Casdoorå‘é€è¯·æ±‚ï¼‰ï¼Œä¹Ÿä¸æ˜¯åŸç”Ÿjsåœ¨æµè§ˆå™¨ç›´æ¥è¯·æ±‚tokenã€‚</p></blockquote><p>ä½†æ˜¯Flutter-webå°±ç­‰äºæ˜¯ç¼–è¯‘å‡ºæ¥ä¸€ä¸ªé™æ€webé¡¹ç›®ï¼ŒåŸç”Ÿè¿è¡Œåœ¨æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä¸­çš„åŸç”Ÿjsç›´æ¥å»è¯·æ±‚å…¶ä»–åŸŸåä¸‹çš„casdoorå¿…ç„¶é‡åˆ°è·¨åŸŸé—®é¢˜</p><p>ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç›®å‰æƒ³åˆ°äº†å››ç§æ–¹æ³•ï¼š</p><ul><li>ä¸ºCasdoorçš„tokenè·å–æ¥å£æ·»åŠ CORSè·¨åŸŸèµ„æºåˆ†äº«æ”¯æŒ</li><li>ç”¨Flutterè°ƒç”¨åŸç”Ÿjsä»£ç ï¼Œé€šè¿‡ä¸€äº›ä¸å¤ªä¼˜ç¾çš„åŸç”Ÿjsæ–¹å¼ç»•è¿‡è·¨åŸŸé—®é¢˜</li><li>åœ¨Flutterå†…ç½®ä¸€ä¸ªä»£ç†ç¨‹åºï¼ˆç±»ä¼¼casdoor-raw-js-exampleï¼‰.ä½†æ˜¯è¿™æ ·æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œå› ä¸ºè¿™ä¸ªä»£ç†å¿…é¡»åœ¨Dartç¯å¢ƒä¸‹æ‰èƒ½å¯åŠ¨ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€æ²¡ç”¨ã€‚</li><li>è°ƒæ•´Flutter webçš„é€»è¾‘ï¼Œä¸å†æä¾›å…¶ç›´æ¥è·å–tokençš„åŠŸèƒ½ã€‚æˆ–å‘ŠçŸ¥ç”¨æˆ·ï¼Œç›´æ¥ç”¨Flutter webæ•´åˆCasdoorä¼šé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œå»ºè®®ç»“åˆåç«¯ä½¿ç”¨</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tree Generator (éšæœºç”Ÿæˆä¸€é¢—æ ‘)</title>
      <link href="/2022/11/23/Tree/"/>
      <url>/2022/11/23/Tree/</url>
      
        <content type="html"><![CDATA[<p>This is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.</p><p>Link: <a href="https://muchengl.github.io/tree/">https://muchengl.github.io/tree/</a></p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png" alt="æˆªå±2022-11-23 14.06.22"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Casdoor Flutter Sdk Test</title>
      <link href="/2022/11/21/Casdoor-Flutter-sdk-Test/"/>
      <url>/2022/11/21/Casdoor-Flutter-sdk-Test/</url>
      
        <content type="html"><![CDATA[<h2 id="Step-1-Clone-casdoor-flutter-example-from-Github"><a href="#Step-1-Clone-casdoor-flutter-example-from-Github" class="headerlink" title="Step 1: Clone casdoor-flutter-example from Github"></a>Step 1: Clone casdoor-flutter-example from Github</h2><p>Link: <a href="https://github.com/casdoor/casdoor-flutter-example">https://github.com/casdoor/casdoor-flutter-example</a></p><h2 id="Step-2-Test-in-Chrome-Web"><a href="#Step-2-Test-in-Chrome-Web" class="headerlink" title="Step 2: Test in Chrome(Web)"></a>Step 2: Test in Chrome(Web)</h2><p>Encountered a cross-domain problem. So the token could not be obtained.</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cross-domain code</span></span><br><span class="line"><span class="comment">// Post: localhost -&gt; door.casdoor.com</span></span><br><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> _casdoor.requestOauthAccessToken(code);</span><br></pre></td></tr></table></figure><p>Error:</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png" alt="æˆªå±2022-11-26 14.12.45"></p><h2 id="Step-3-Test-in-Android-Emulator"><a href="#Step-3-Test-in-Android-Emulator" class="headerlink" title="Step 3: Test in Android Emulator"></a>Step 3: Test in Android Emulator</h2><p>Android app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)</p><p>Graphicï¼š</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png" alt="æˆªå±2022-11-26 14.41.25"></p><h2 id="Step-4-Test-in-IOS-Emulator"><a href="#Step-4-Test-in-IOS-Emulator" class="headerlink" title="Step 4: Test in IOS Emulator"></a>Step 4: Test in IOS Emulator</h2><p>Working well.</p><p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png" alt="æˆªå±2022-11-26 15.38.58"></p>]]></content>
      
      
      
        <tags>
            
            <tag> casdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Amazon internship Doc</title>
      <link href="/2022/11/19/Amazon-Doc/"/>
      <url>/2022/11/19/Amazon-Doc/</url>
      
        <content type="html"><![CDATA[<object data="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf" type="application/pdf" width="700px" height="800px" >    <embed src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf">        <p>This browser does not support PDFs. Please download the PDF to view it: <a href="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf">Download PDF</a>.</p>    </embed></object>]]></content>
      
      
      
        <tags>
            
            <tag> intern </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OS Learning 01</title>
      <link href="/2022/11/13/OS%20Learning%2001/"/>
      <url>/2022/11/13/OS%20Learning%2001/</url>
      
        <content type="html"><![CDATA[<h1 id="C-basic-knowledge"><a href="#C-basic-knowledge" class="headerlink" title="C basic knowledge"></a>C basic knowledge</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spin()</span><br></pre></td></tr></table></figure><p>ç­‰ä¸€ç§’é’Ÿè¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert( è¡¨è¾¾å¼ );</span><br></pre></td></tr></table></figure><p>è‹¥è¡¨è¾¾å¼å€¼ä¸º0ï¼Œåˆ™ç»ˆæ­¢ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(num);</span><br><span class="line"><span class="type">int</span> *p=<span class="built_in">malloc</span>(num);</span><br></pre></td></tr></table></figure><p>åŠ¨æ€åˆ†é…å†…å­˜å‡½æ•°ï¼Œåˆ†é…é•¿åº¦ä¸ºnumå­—èŠ‚çš„å†…å­˜å—ï¼Œéœ€è¦ä½¿ç”¨freeé‡Šæ”¾ã€‚</p><p>pæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œè¡¨ç¤ºå†…å­˜ä¸­çš„ä¸€ä¸ªåœ°å€ã€‚*pè¡¨ç¤ºè¿™ä¸ªåœ°å€å†…å­˜ä¸­å­˜çš„å€¼ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> Operation Systems Three Easy Pieces </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>first-blog Test</title>
      <link href="/2022/11/13/my-first-blog/"/>
      <url>/2022/11/13/my-first-blog/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg" alt="1"></p><h1 id="Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰"><a href="#Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰" class="headerlink" title="Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰"></a>Springå­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰</h1><h3 id="1-ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£"><a href="#1-ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£" class="headerlink" title="1.ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£"></a>1.ä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬çš„ç†è§£</h3><h3 id="2-Springç¨‹åºç»“æ„"><a href="#2-Springç¨‹åºç»“æ„" class="headerlink" title="2.Springç¨‹åºç»“æ„"></a>2.Springç¨‹åºç»“æ„</h3><ul><li>å®ä½“ç±»ï¼ˆpojoï¼‰<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liu.pojo;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String str;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStr</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;str=&#x27;&quot;</span> + str + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>é…ç½®æ–‡ä»¶<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>æµ‹è¯•ç±»<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–Springçš„ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Hello hello=(Hello)context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰"><a href="#3-setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰" class="headerlink" title="3.setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰"></a>3.setæ³¨å…¥æ–¹æ³•ï¼ˆdiï¼‰</h3></li><li>å®ä½“ç±»<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Students</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    <span class="keyword">private</span> String[] book;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobby;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; card;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; game;</span><br><span class="line">    <span class="keyword">private</span> Properties info;</span><br><span class="line">    <span class="keyword">private</span> String wife;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>é…ç½®æ–‡ä»¶<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;address&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Address&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.pojo.Students&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        æ™®é€šå€¼æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;åˆ˜ç€šä¸­&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        beanæ³¨å…¥ï¼Œä½¿ç”¨ref--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;address&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              æ•°ç»„æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;book&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‚²æ…¢ä¸åè§<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‘¼å•¸å±±åº„<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>ç“¦å°”ç™»æ¹–<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              åˆ—è¡¨æ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‚²æ…¢ä¸åè§<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>å‘¼å•¸å±±åº„<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>ç“¦å°”ç™»æ¹–<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              mapæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;é¥­å¡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;å·¥èµ„å¡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--              é›†åˆæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;game&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span>åƒé¸¡<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span>lol<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        propertiesæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;administrator&quot;</span>&gt;</span>administrator@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;support&quot;</span>&gt;</span>support@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;development&quot;</span>&gt;</span>development@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        nullæ³¨å…¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">null</span>&gt;</span><span class="tag">&lt;/<span class="name">null</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰"><a href="#4-è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰" class="headerlink" title="4.è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰"></a>4.è‡ªåŠ¨è£…é…ï¼ˆautowiringï¼‰</h3>è‡ªåŠ¨è£…é…é¦–å…ˆä¼šæ ¹æ®nameå¯»æ‰¾å¯¹è±¡ï¼Œ<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;1&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;dog1&quot;)</span><span class="comment">//è‹¥dogå¯¹è±¡ä¸å”¯ä¸€ï¼Œéœ€è®¾ç½®ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;context:annotation-config/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;cat&quot;</span> class=<span class="string">&quot;com.liu.pojo.Cat&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dog1&quot;</span> class=<span class="string">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dog2&quot;</span> class=<span class="string">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;people&quot;</span> class=<span class="string">&quot;com.liu.pojo.People&quot;</span> autowire=<span class="string">&quot;byName&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><h3 id="5-æ³¨è§£ç¼–ç¨‹"><a href="#5-æ³¨è§£ç¼–ç¨‹" class="headerlink" title="5.æ³¨è§£ç¼–ç¨‹"></a>5.æ³¨è§£ç¼–ç¨‹</h3></li><li>é…ç½®æ–‡ä»¶ï¼ˆxmlï¼‰ä¸æ³¨è§£å¹¶å­˜<ul><li>daoå±‚ï¼š@Repository</li><li>pojoå±‚ï¼š@Component</li><li>serviceï¼š@Service</li><li>Controllerå±‚ï¼š@Controller<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//ç­‰ä»·äº&lt;bean id=&quot;user&quot; class=&quot;com.liu.pojo.User&quot;/&gt;</span></span><br><span class="line"><span class="meta">@Scope(&quot;singleton&quot;)</span><span class="comment">//å•ä¾‹ï¼ŒprototypeåŸå‹æ¨¡å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;lhz&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.liu&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    æ‰«æåŒ…ä¸‹çš„æ³¨è§£--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="6-ä»£ç†æ¨¡å¼"><a href="#6-ä»£ç†æ¨¡å¼" class="headerlink" title="6.ä»£ç†æ¨¡å¼"></a>6.ä»£ç†æ¨¡å¼</h3><h3 id="7-é¢å‘åˆ‡é¢ç¼–ç¨‹-aop"><a href="#7-é¢å‘åˆ‡é¢ç¼–ç¨‹-aop" class="headerlink" title="7.é¢å‘åˆ‡é¢ç¼–ç¨‹(aop)"></a>7.é¢å‘åˆ‡é¢ç¼–ç¨‹(aop)</h3><p>é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ˜¯åœ¨ä¸æ”¹å˜åŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šï¼Œå¢å¼ºä»£ç çš„åŠŸèƒ½ã€‚Spring-aopæœ‰ä¸‰ç§å®ç°æ–¹å¼ã€‚</p><ul><li>æ–¹æ³•ä¸€ï¼šSpringåŸç”ŸAPIæ¥å£å®ç°<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.service.UserServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;afterLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.log.AfterLog&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;beforeLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.log.BeforeLog&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--æ–¹å¼1:åŸç”ŸSpringçš„APIæ¥å£--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;afterLog&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;beforeLog&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>åœ¨ä¸€ä¸ªåŒ…ä¸‹å»ºç«‹ä»¥ä¸‹ä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«ä½œä¸ºæ‰§è¡Œå‰å’Œæ‰§è¡Œå<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeforeLog</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] objects, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(target.getClass().getName()+<span class="string">&quot;çš„&quot;</span>+method.getName()+<span class="string">&quot;è¢«æ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterLog</span> <span class="keyword">implements</span> <span class="title class_">AfterReturningAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(Object o, Method method, Object[] objects, Object o1)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œäº†&quot;</span>+method.getName()+<span class="string">&quot;æ–¹æ³•ï¼Œè¿”å›ç»“æœä¸ºï¼š&quot;</span>+o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æ–¹æ³•äºŒï¼šä½¿ç”¨è‡ªå®šä¹‰ç±»<br>å®šä¹‰ä¸€ä¸ªDiyPointCutç±»ï¼Œåœ¨é‡Œé¢å†™afterå’Œbeforeæ–¹æ³•<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ–¹å¼2ï¼šè‡ªå®šä¹‰ç±»--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;diy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.diy.DiyPointCut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è‡ªå®šä¹‰åˆ‡é¢--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;diy&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--åˆ‡ç‚¹--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é€šçŸ¥--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyPointCut</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========æ–¹æ³•æ‰§è¡Œå========&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========æ–¹æ³•æ‰§è¡Œå‰========&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æ³¨è§£<br>éœ€åœ¨xmlæ–‡ä»¶ä¸­å¼€å¯æ³¨è§£<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ–¹å¼3--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span><span class="comment">&lt;!--å¼€å¯æ³¨è§£--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;annotationPointCut&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.diy.AnnotationPointCut&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span><span class="comment">//æ ‡è®°ä¸ºåˆ‡é¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationPointCut</span> &#123;</span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===æ–¹æ³•æ‰§è¡Œå‰===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===æ–¹æ³•æ‰§è¡Œå===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-Springå’ŒMyBatisæ•´åˆ"><a href="#8-Springå’ŒMyBatisæ•´åˆ" class="headerlink" title="8.Springå’ŒMyBatisæ•´åˆ"></a>8.Springå’ŒMyBatisæ•´åˆ</h3>éœ€ä½¿ç”¨mavenå¯¼å…¥ç›¸åº”çš„jaråŒ…<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--æµ‹è¯•--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--æ³¨è§£--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        springä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        Springæ“æ§æ•°æ®åº“--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        aopç»‡å…¥åŒ…--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>Spring-Mybatisä½¿ç”¨Springå°†Mybatisçš„é…ç½®æ•´åˆï¼Œå¯ä»¥é€‰æ‹©åœ¨åŸæ¥çš„MyBatis-configæ–‡ä»¶ä¸­é…ç½®ä¸€äº›ç®€å•çš„Mapperæ³¨å†Œå’Œå¼•ç”¨åˆ«åï¼Œåœ¨Spring-dao.xmlæ–‡ä»¶ä¸­å†™å„ç§é…ç½®ï¼Œæœ€ååœ¨applicationContext.xmlæ–‡ä»¶ä¸­æ³¨å†Œå„ä¸ªç±»ã€‚ä¸Mybatisä¸åŒï¼ŒSpring-Mybatisåªèƒ½è·å¾—SqlSessionFactoryBeanå’ŒSqlSessionTemplateã€‚Spring-Mybatisæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚</li><li>ç¬¬ä¸€ç§æ–¹å¼</li></ul><p>é¦–å…ˆéœ€è¦å»ºç«‹å®ä½“ç±»ï¼Œå¹¶å»ºç«‹æ¥å£å’Œå¯¹åº”çš„xmlæ–‡ä»¶ï¼Œç„¶åå¼€å§‹é…ç½®xmlæ–‡ä»¶<br>MyBatis-config.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    å¼•ç”¨åˆ«å--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.liu.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Spring-dao.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    datasourceæ•°æ®æº--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis?useSSl=true<span class="symbol">&amp;amp;</span>useUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=utf-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    sqlSessionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        ç»‘å®šMyBatisé…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ³¨å†Œæ¥å£ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>applicationContext.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-dao.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentsMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liu.dao.StudentsMapperImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨å®Œæˆxmlé…ç½®ä¹‹åï¼Œä¸€èˆ¬å¯ä»¥å»ºç«‹ä¸€ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå¹¶åœ¨è¿™ä¸ªç±»è·å–sqlSession,åœ¨applicationæ–‡ä»¶ä¸­æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶å°†sqlSessioné€šè¿‡setæ³¨å…¥è¿™ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentsMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">StudentsMapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SqlSessionTemplate sqlSession;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSqlSession</span><span class="params">(SqlSessionTemplate sqlSession)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Students&gt; <span class="title function_">getStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);</span><br><span class="line">        <span class="keyword">return</span> studentsMapper.getStudents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±å¯ä»¥è¿›è¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);<span class="comment">//Springé…ç½®æ–‡ä»¶</span></span><br><span class="line">        StudentsMapper studentsMapper=context.getBean(<span class="string">&quot;studentsMapper1&quot;</span>,StudentsMapper.class);<span class="comment">//æ¥å£ï¼Œè·å–å®ç°ç±»</span></span><br><span class="line">        List&lt;Students&gt; list=studentsMapper.getStudents();</span><br><span class="line">        <span class="keyword">for</span> (Students students : list) &#123;</span><br><span class="line">            System.out.println(students);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>æ–¹æ³•äºŒ<br>å‘æ¥å£çš„å®ç°ç±»æ³¨å…¥sqlSeeeionFectoryï¼Œè¯¥å®ç°ç±»éœ€ç»§æ‰¿SqlSessionDaoSupport</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentsMapperImpl2</span> <span class="keyword">extends</span> <span class="title class_">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title class_">StudentsMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Students&gt; <span class="title function_">getStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);<span class="comment">//æ­¤å¤„ä½¿ç”¨getSqlSession()</span></span><br><span class="line">        <span class="keyword">return</span> studentsMapper.getStudents();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥sqlSessionFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;studentsMapper2&quot;</span> class=<span class="string">&quot;com.liu.dao.StudentsMapperImpl2&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;sqlSessionFactory&quot;</span> ref=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
