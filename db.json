{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"themes/cactus/source/css/rtl.styl","path":"css/rtl.styl","modified":0,"renderable":1},{"_id":"themes/cactus/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/favicon-192x192.png","path":"images/favicon-192x192.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/js/search.js","path":"js/search.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","path":"lib/clipboard/clipboard.min.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","path":"lib/jquery/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","path":"lib/meslo-LG/MesloLGL-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGL-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","path":"lib/meslo-LG/MesloLGL-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","path":"lib/meslo-LG/MesloLGL-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","path":"lib/meslo-LG/MesloLGM-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGM-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","path":"lib/meslo-LG/MesloLGM-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","path":"lib/meslo-LG/MesloLGM-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","path":"lib/meslo-LG/MesloLGS-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGS-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","path":"lib/meslo-LG/MesloLGS-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","path":"lib/meslo-LG/MesloLGS-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","path":"lib/vazir-font/Vazir-Black.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","path":"lib/vazir-font/Vazir-Black.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","path":"lib/vazir-font/Vazir-Black.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","path":"lib/vazir-font/Vazir-Black.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","path":"lib/vazir-font/Vazir-Bold.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","path":"lib/vazir-font/Vazir-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","path":"lib/vazir-font/Vazir-Bold.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","path":"lib/vazir-font/Vazir-Bold.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","path":"lib/vazir-font/Vazir-Light.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","path":"lib/vazir-font/Vazir-Light.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","path":"lib/vazir-font/Vazir-Light.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","path":"lib/vazir-font/Vazir-Light.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","path":"lib/vazir-font/Vazir-Medium.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","path":"lib/vazir-font/Vazir-Medium.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","path":"lib/vazir-font/Vazir-Medium.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","path":"lib/vazir-font/Vazir-Medium.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.eot","path":"lib/vazir-font/Vazir-Regular.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.ttf","path":"lib/vazir-font/Vazir-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.woff","path":"lib/vazir-font/Vazir-Regular.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.woff2","path":"lib/vazir-font/Vazir-Regular.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","path":"lib/vazir-font/Vazir-Thin.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","path":"lib/vazir-font/Vazir-Thin.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","path":"lib/vazir-font/Vazir-Thin.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","path":"lib/vazir-font/Vazir-Thin.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.eot","path":"lib/vazir-font/Vazir-Variable.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.ttf","path":"lib/vazir-font/Vazir-Variable.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.woff","path":"lib/vazir-font/Vazir-Variable.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.woff2","path":"lib/vazir-font/Vazir-Variable.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","path":"lib/vazir-font/font-face.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","path":"lib/font-awesome/webfonts/fa-brands-400.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","path":"lib/font-awesome/webfonts/fa-regular-400.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","path":"lib/font-awesome/webfonts/fa-solid-900.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-v4compatibility.ttf","path":"lib/font-awesome/webfonts/fa-v4compatibility.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-v4compatibility.woff2","path":"lib/font-awesome/webfonts/fa-v4compatibility.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","path":"lib/justified-gallery/css/justifiedGallery.min.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","path":"lib/justified-gallery/js/jquery.justifiedGallery.min.js","modified":0,"renderable":1},{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/about-me/avatar_image.png","path":"about-me/avatar_image.png","modified":0,"renderable":0},{"_id":"source/about-me/icons-github.png","path":"about-me/icons-github.png","modified":0,"renderable":0},{"_id":"source/about-me/icons-linkedin.png","path":"about-me/icons-linkedin.png","modified":0,"renderable":0},{"_id":"source/about-me/icons-twitter.png","path":"about-me/icons-twitter.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"a3212b925b4321bc53a33f411bd9753fc96eca6d","modified":1743990790728},{"_id":"source/_posts/.DS_Store","hash":"e1a2ee238cdad27de771a0a36d15ddb13b2d3017","modified":1677678176350},{"_id":"source/_posts/6-s081-Lab2-System-Call.md","hash":"47374a5f05cd9a6673114e5e6fb676d56bc91c43","modified":1673600537528},{"_id":"source/_posts/Amazon-Doc.md","hash":"5744594546027d2ae5da89c79633f4fd3099e4d4","modified":1669180487724},{"_id":"source/_posts/Casdoor-Flutter-Sdk-Bug-Fix.md","hash":"fa11dd4aef94279cda4b2f8e31175e2ab568f902","modified":1669738231490},{"_id":"source/_posts/Cross-domain-security-in-SSO.md","hash":"ab6e74ffb6eb5423b55843d85f864f80c14d7bff","modified":1669897052070},{"_id":"source/_posts/Casdoor-Flutter-sdk-Test.md","hash":"9097949128ffc68923ea23460deda1d48ccec52f","modified":1669738301757},{"_id":"source/_posts/Faasm-WASM-serverless.md","hash":"632a305096eecfd15f44464a1cb9b1c635a8574b","modified":1675689914696},{"_id":"source/_posts/MIT-6-s081-Lab5-COW.md","hash":"1fd99e897fb8d4965f1e6245c68babde1d79b0a0","modified":1673836311797},{"_id":"source/_posts/MIT-6-s081-Lab4.md","hash":"7841b5722af1df992893133a6ab1653849c8c9eb","modified":1673712629896},{"_id":"source/_posts/MITOSIS-by-WASM-ebpf-in-Faasm.md","hash":"4dcd226de3782c055500d294c082cfffbff6b811","modified":1678459486987},{"_id":"source/_posts/Log-fremawork-High-level-design.md","hash":"f831937d0d8c9c7d91354cad13315e82fb6b26e9","modified":1670333290822},{"_id":"source/_posts/MITOSIS-learning.md","hash":"269aaf5b335e2c6b1fc18203bdf9149b959e0c1e","modified":1675077324052},{"_id":"source/_posts/MIT6-s081-Lab3-Page-Table.md","hash":"7da74df9d9e4773b1071564f9ca8df3a0d5e2e6f","modified":1673600528612},{"_id":"source/_posts/MITOSIS-test.md","hash":"d958bd39261304a93773115873a0fc097c8f4f9b","modified":1675568121677},{"_id":"source/_posts/RDMA-soft-config.md","hash":"9f26d05caf52cb397a76d9209a3ece383ee5ea6d","modified":1675083552475},{"_id":"source/_posts/Study-Notes-about-Virtualization-01.md","hash":"88a2df459b7ceafcb4104838cf2be63f758ec885","modified":1669785968474},{"_id":"source/_posts/OS Learning 01.md","hash":"41827d90010b3033042911dc66e022fae14604be","modified":1668416103436},{"_id":"source/_posts/XDP数据传输问题综述.md","hash":"ddfdee77e6092ddd35837a7103c7633b48ce4cef","modified":1677673866181},{"_id":"source/_posts/eBPF-XDP.md","hash":"6e387beb8bf3118ced6de25f83f27780d8db26b1","modified":1677484020256},{"_id":"source/_posts/Tree.md","hash":"cdf3088d051a63c02b520ab3ed97f7675c3cc4c9","modified":1669183652486},{"_id":"source/_posts/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation.md","hash":"2e7de33680537114089482e344042f06e0882ba0","modified":1676704017660},{"_id":"source/_posts/eBPF学习-01.md","hash":"54f9fd2c7d8515ef63deb0668a586145d74ec8a6","modified":1675062877226},{"_id":"source/_posts/lc-1234-Sliding-window.md","hash":"4de5474ea3b1712399ce7414f89c8ced374df8c7","modified":1676273401704},{"_id":"source/_posts/lc1139-Largest-1-Bordered-Square.md","hash":"e69d3813db8f2d389f3c274ae75e8546d45d9a70","modified":1676627554119},{"_id":"source/_posts/my-first-blog.md","hash":"e6b48df2f9306b8ac050bbbb302ebcdddbc7b12e","modified":1669445886395},{"_id":"source/_posts/lc1792-Maximum-Average-Pass-Ratio.md","hash":"6cf58b5ed8857524de694388f23df68b589bb453","modified":1676789258044},{"_id":"source/search/index.md","hash":"f5b41276a808a81cab5429e8c400e46c79751b3b","modified":1668332202311},{"_id":"source/_posts/libbpf-01.md","hash":"e8b4bba285a564873a6a69547cacf46ce5cc3164","modified":1676292189806},{"_id":"source/tree/index.html","hash":"8d3209e580bca493a788d59487b00f00d04a38d7","modified":1669116818376},{"_id":"source/about-me/index.md","hash":"2cb9aa9c57ac696e9b7a857046097079a11d4c6c","modified":1743279250258},{"_id":"themes/cactus/.gitignore","hash":"72267ee409a324fc197c150b3c4bf28b87b709a8","modified":1668331454411},{"_id":"themes/cactus/.stylintrc","hash":"eb5f48e83657928cb0cbee031373b2cd36ca0083","modified":1668331454411},{"_id":"themes/cactus/.jshintrc","hash":"2548bd6ce44422edc7e6f9f68061ab47f26c4f57","modified":1668331454411},{"_id":"themes/cactus/.DS_Store","hash":"d59cca64f4ddde7913577c82a12d125d4be0f3e4","modified":1668605077079},{"_id":"themes/cactus/LICENSE","hash":"346ece39a983b0e7858c11f785cd846cef9eb875","modified":1668331454412},{"_id":"themes/cactus/README.md","hash":"778ff0b9caf666d2c0dc3413e26ffb862f354173","modified":1668331454412},{"_id":"themes/cactus/gulpfile.js","hash":"e60630581a5ce8ec2100e7d6d50db71aef654c39","modified":1668331454412},{"_id":"themes/cactus/scripts/cdn.js","hash":"887edec364d51efa7c524446483188c6ad05adaf","modified":1668331454419},{"_id":"themes/cactus/scripts/errror_404.js","hash":"f83b290e47cb78a2754152fccc34e571a72087bd","modified":1668331454419},{"_id":"themes/cactus/scripts/thumbnail.js","hash":"df8829fd8c3119650037eba5ec11bdce06acff9d","modified":1668331454420},{"_id":"themes/cactus/scripts/merge-configs.js","hash":"2048c3415d96b17b9d84aa44bc0c25f1210525f8","modified":1668331454419},{"_id":"themes/cactus/scripts/page_title.js","hash":"fa662dbdb82779af1b95e35ed7ccdf4866a53dee","modified":1668331454420},{"_id":"themes/cactus/scripts/meta.js","hash":"654868666b6573b2cee7e750b47ad8a3c2ee13a0","modified":1668331454420},{"_id":"themes/cactus/_config.yml","hash":"4ea5007843f15a004e0328bac7167f283d454ce7","modified":1744480102377},{"_id":"themes/cactus/layout/404.ejs","hash":"b911da998c160cceb8cd7c4dae709a1374ed2491","modified":1668331454414},{"_id":"themes/cactus/package.json","hash":"9d9dfe0e611e69c0db7a7de193a03a253263d504","modified":1668331454419},{"_id":"themes/cactus/source/.DS_Store","hash":"ffaee01d6ca155f3ec060b8436e11c461501a7a7","modified":1668605077080},{"_id":"themes/cactus/layout/archive.ejs","hash":"5a23d506dd65f9b5fd1d44a73d5e04c935a899e2","modified":1668331454418},{"_id":"themes/cactus/layout/layout.ejs","hash":"8504004f2ed78914f806c6699d9bd722318cbe56","modified":1668331454418},{"_id":"themes/cactus/layout/index.ejs","hash":"054397351b38f2ae11f15b17baa1a6753ab1ea9d","modified":1668331454418},{"_id":"themes/cactus/layout/post.ejs","hash":"f9149f294e6142437c58784c41f1d082a61c8b82","modified":1668331454419},{"_id":"themes/cactus/layout/page.ejs","hash":"c5465d5315a7544aa466b01fd8cfb62917a8bb1d","modified":1668331454418},{"_id":"themes/cactus/languages/ar.yml","hash":"81a88b0593fc89de3118d686681b1f69883c847b","modified":1668331454412},{"_id":"themes/cactus/languages/de.yml","hash":"43b2f4e078b042aaae0377a4235216a51ed82e0d","modified":1668331454413},{"_id":"themes/cactus/languages/en.yml","hash":"6a84970bf69c3e9490e5382747ca2b4c4b4dccde","modified":1668331454413},{"_id":"themes/cactus/languages/es.yml","hash":"2b1fc8b0d636123e9ee39017fa20053bd1913a5a","modified":1668331454413},{"_id":"themes/cactus/languages/ca.yml","hash":"b79dd2c21dc6697c635e92db1f661a4b8d5d2305","modified":1668331454413},{"_id":"themes/cactus/languages/default.yml","hash":"6a84970bf69c3e9490e5382747ca2b4c4b4dccde","modified":1668331454413},{"_id":"themes/cactus/languages/fa.yml","hash":"63f32e50953af1c4bd0308a4fca5862b5287c2cb","modified":1668331454413},{"_id":"themes/cactus/languages/fr.yml","hash":"5c07406998f19d219a5a7b65c0d88b6b023f85b2","modified":1668331454413},{"_id":"themes/cactus/languages/it.yml","hash":"62800bcae1f2d2454f87f4bcf4d7593848424f61","modified":1668331454413},{"_id":"themes/cactus/languages/kr.yml","hash":"651fb83991c91b13b53ed55740e5402cf0f1c5e8","modified":1668331454413},{"_id":"themes/cactus/languages/nl.yml","hash":"ac0573352ad2c737a7686bcca498b985e7bd6447","modified":1668331454413},{"_id":"themes/cactus/languages/ru.yml","hash":"81b57fcd1977ef534f4bf303dbc1b4710cc7f057","modified":1668331454414},{"_id":"themes/cactus/languages/pl.yml","hash":"8a2d6dc874d86c38d42c2c861c39590647b5d536","modified":1668331454414},{"_id":"themes/cactus/languages/vi.yml","hash":"f84893c3ec3e45875c90069e14b17ed3016ed973","modified":1668331454414},{"_id":"themes/cactus/languages/tr.yml","hash":"2702914007e6bade9d6861078c0e179ac05bf48c","modified":1668331454414},{"_id":"themes/cactus/languages/zh-CN.yml","hash":"d016060817311addb4c528de440126b975038c31","modified":1668331454414},{"_id":"themes/cactus/languages/zh-TW.yml","hash":"2f4e050c9b35a67f4a7278cec3a949533c2ac16a","modified":1668331454414},{"_id":"themes/cactus/languages/pt-br.yml","hash":"4859aba788a050c2d5d0b997693b0c8c24b349f7","modified":1668331454414},{"_id":"themes/cactus/source/css/_extend.styl","hash":"b6a4e5905a7515dda66919167531a5ab2b3d1fe2","modified":1668331454421},{"_id":"themes/cactus/source/css/_fonts.styl","hash":"354809b5a64e8a47a66c66fd1a28ac597c1460a6","modified":1668331454422},{"_id":"themes/cactus/layout/.DS_Store","hash":"24ec9ba04e441982c3a33390b5205ea1b072fb41","modified":1668603585209},{"_id":"themes/cactus/source/css/.DS_Store","hash":"151d3add3851159e0229b44b525a1af4689d51b7","modified":1668605082083},{"_id":"themes/cactus/source/css/_mixins.styl","hash":"1a9e309523df9685e8d088dcff0a809c58e2c392","modified":1668331454438},{"_id":"themes/cactus/source/css/_util.styl","hash":"2bfeb2e2605dd5235693b00c71a212646d2e0410","modified":1668331454441},{"_id":"themes/cactus/source/css/_variables.styl","hash":"69d9c5e95edcaee5ccd8218262b989ce721cce79","modified":1668331454441},{"_id":"themes/cactus/source/images/apple-touch-icon.png","hash":"57e2def34682655f41a0be2d083f16765ba7858b","modified":1668331454442},{"_id":"themes/cactus/source/css/style.styl","hash":"5d8afa50dd27d083e09d3b09106f98de46e3c7d0","modified":1668604782635},{"_id":"themes/cactus/source/css/rtl.styl","hash":"ff8700e1626feeb53d905a2df2777bda7d1eca50","modified":1668604967756},{"_id":"themes/cactus/source/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1668331454442},{"_id":"themes/cactus/source/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1668331454443},{"_id":"themes/cactus/source/js/main.js","hash":"619ac6529d140711e3b14f739a192bb31c4824ff","modified":1668331454445},{"_id":"themes/cactus/layout/_partial/comments.ejs","hash":"4e75035a427fd137ae7f12940209e8e97845df3b","modified":1668331454415},{"_id":"themes/cactus/layout/_partial/footer.ejs","hash":"12fd63b51472c9c5b8b7d167eb1a96bf1d686c20","modified":1668331454415},{"_id":"themes/cactus/layout/_partial/head.ejs","hash":"95526bec071998144ee0b0fc33f39bb74e5e9c4f","modified":1668331454415},{"_id":"themes/cactus/source/js/search.js","hash":"914a2ce72fb325106c61600200be823b72bfb39f","modified":1668331454445},{"_id":"themes/cactus/layout/_partial/pagination.ejs","hash":"23bf862b3b8a3cd831850504d9b5a24d21b005e7","modified":1668331454415},{"_id":"themes/cactus/layout/_partial/header.ejs","hash":"0e06ee826de1af22a63626456ceb8f2b6c0d1555","modified":1668331454415},{"_id":"themes/cactus/layout/_partial/styles.ejs","hash":"c6bc7e8a422c5bb57f88fed1d1b0694d03e24e74","modified":1668331454418},{"_id":"themes/cactus/layout/_partial/search.ejs","hash":"8b4bf9cf5db0ce762a31fc3baae0f2fc004bece4","modified":1668331454417},{"_id":"themes/cactus/layout/_partial/scripts.ejs","hash":"a901e3c89e4cd1d20a87bfc683b64b6818275946","modified":1668331454417},{"_id":"themes/cactus/source/css/_colors/dark.styl","hash":"9aa43b1f23d5d268dfa36bd942d6ce97b7677c4d","modified":1668331454421},{"_id":"themes/cactus/source/css/_colors/classic.styl","hash":"bc09f8777a6c99030da953dfdb84f793c5e4fd85","modified":1668331454421},{"_id":"themes/cactus/source/css/_colors/light.styl","hash":"d14ef1aa02d0895b6f9321ebfc23a1ec84b054b8","modified":1668331454421},{"_id":"themes/cactus/source/css/_colors/white.styl","hash":"88e93a9d3fe1d0270d65cabdeacc18bd94d45937","modified":1668331454421},{"_id":"themes/cactus/source/css/_partial/comments.styl","hash":"1e90f1fb9d4c155df518cacb5a537e9de9c042c1","modified":1668331454439},{"_id":"themes/cactus/source/css/_partial/article.styl","hash":"258370d8ab98e63804ead9bc030f633ca97a1235","modified":1668331454438},{"_id":"themes/cactus/source/css/_partial/categories.styl","hash":"a43f00e61b3507f130b8a3f8108a4eeca147c2a0","modified":1668331454439},{"_id":"themes/cactus/source/css/_partial/archive.styl","hash":"31aef892437d5734a134c34f2a8a6610a8f671c3","modified":1668331454438},{"_id":"themes/cactus/source/lib/.DS_Store","hash":"9aa169aca50ca82128bc67303d3c87137b2bf4a9","modified":1668603600746},{"_id":"themes/cactus/source/css/_partial/footer.styl","hash":"61c2c7c5f73a0022ec41830bea0812a97f522d7c","modified":1668331454439},{"_id":"themes/cactus/source/css/_partial/index.styl","hash":"59c99f4ea3a73bf47ce030df166c5e33d5de31fb","modified":1668331454439},{"_id":"themes/cactus/source/css/_partial/header.styl","hash":"7f18929e7f4ad6d20da374e8b9f85ce587220a87","modified":1668331454439},{"_id":"themes/cactus/source/css/_partial/search.styl","hash":"159be002780c62a77f46947cf854a7342fba24f4","modified":1668331454440},{"_id":"themes/cactus/source/css/_partial/pagination.styl","hash":"950bf517bbe7adb9a9aa4eb5ddec74ffc7598787","modified":1668331454440},{"_id":"themes/cactus/source/css/_highlight/agate.styl","hash":"53027913ed8d4f75ac3e49e76aad824f0df62da3","modified":1668331454422},{"_id":"themes/cactus/source/css/_partial/tags.styl","hash":"d571d5c7c960300d29c5f0ec3fe1140322ecd6b3","modified":1668331454441},{"_id":"themes/cactus/source/css/_partial/tooltip.styl","hash":"2daff581ec3efaec840cbfdee512195919c32629","modified":1668331454441},{"_id":"themes/cactus/source/css/_highlight/arduino-light.styl","hash":"15e8572585cd708221c513dea4bdd89d8fe56c10","modified":1668331454422},{"_id":"themes/cactus/source/css/_highlight/androidstudio.styl","hash":"2af0861725f97f0ee2ded67c3d2d4548c62b2d16","modified":1668331454422},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-dark.styl","hash":"ce63dd8548688d88254405eedfa75b1d7c82449e","modified":1668331454423},{"_id":"themes/cactus/source/css/_highlight/arta.styl","hash":"b3e81e3e694ceb8deed178adb8b91013c5120e30","modified":1668331454423},{"_id":"themes/cactus/source/css/_highlight/ascetic.styl","hash":"32cff3bef6fac3760fe78f203096477052a90552","modified":1668331454423},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-light.styl","hash":"a5be0744a7ecf4a08f600ade4cfd555afc67bc15","modified":1668331454423},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-dark.styl","hash":"c196ff0ee064af0e507823694ae39020addfc280","modified":1668331454423},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-light.styl","hash":"931435fbc6f974e8ce9e32722680035d248a9dc1","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-light.styl","hash":"344276ca9b27e51d4c907f76afe5d13cf8e60bdf","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-dark.styl","hash":"0bb16a4eff93688f40787abc2f9e56e7d5cc93e7","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-dark.styl","hash":"effbc5d75fa87203c847039869c22031b40d5b7d","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-dark.styl","hash":"10ee3882fca7b97a37bd309d2d35fce9868647bb","modified":1668331454425},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-light.styl","hash":"95228d9f2102fad425536aac44b80b2cba1f5950","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-light.styl","hash":"8c8c2e445abef85273be966d59770e9ced6aac21","modified":1668331454425},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-dark.styl","hash":"9a2e9a1d0a01bbdf158560c3ed1c134e098b2c68","modified":1668331454424},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-light.styl","hash":"2c54cb9bdb259ae3b5b29f63ac2469ed34b08578","modified":1668331454425},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-dark.styl","hash":"84c80e6f67f62fce958d25817c277d2360272617","modified":1668331454425},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-dark.styl","hash":"e32c1c70def8060fce5e790979a126da650ac642","modified":1668331454426},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-light.styl","hash":"f8244c93711c7cb59dd79d2df966806b30d171ea","modified":1668331454426},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-light.styl","hash":"d1a05fdd1ededc9063d181ab25bad55a164aeb4a","modified":1668331454425},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-dark.styl","hash":"2edf385215bbe1985b1a10106525d362667d28c2","modified":1668331454426},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-light.styl","hash":"0597342da6e2d0c5bdcc7d42dabb07322b1a4177","modified":1668331454426},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-dark.styl","hash":"538a14321193cd8abf2ddc484306631e54149ffb","modified":1668331454426},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-light.styl","hash":"efa52713efc468abeeb2b9299704371583b857de","modified":1668331454427},{"_id":"themes/cactus/source/css/_highlight/brown-papersq.png","hash":"3a1332ede3a75a3d24f60b6ed69035b72da5e182","modified":1668331454427},{"_id":"themes/cactus/source/css/_highlight/codepen-embed.styl","hash":"8b7b34484f76a6c2c3b1a9e49abb9b382f439ae8","modified":1668331454427},{"_id":"themes/cactus/source/css/_highlight/dark.styl","hash":"f5e6e75958de59e87fc6be3a1668e870e20bc836","modified":1668331454428},{"_id":"themes/cactus/source/css/_highlight/color-brewer.styl","hash":"2a439d6214430e2f45dd4939b4dfe1fe1a20aa0f","modified":1668331454428},{"_id":"themes/cactus/source/css/_highlight/docco.styl","hash":"b1c176378bb275f2e8caa759f36294e42d614bf1","modified":1668331454428},{"_id":"themes/cactus/source/css/_highlight/darkula.styl","hash":"9717efa9194837ba3fb4d762997d33075dcf8bfa","modified":1668331454428},{"_id":"themes/cactus/source/css/_highlight/far.styl","hash":"aaac3028f5e33123cd123a583cddc9290c45ec8e","modified":1668331454429},{"_id":"themes/cactus/source/css/_highlight/brown-paper.styl","hash":"c2326ba20a5020a66ca7895258d18833327d4334","modified":1668331454427},{"_id":"themes/cactus/source/css/_highlight/foundation.styl","hash":"bf8ddc94b4ad995b8b8805b5a4cf95004553fdac","modified":1668331454429},{"_id":"themes/cactus/source/css/_highlight/github-gist.styl","hash":"48211a03d33e7f7ada0b261162bea06676155a71","modified":1668331454429},{"_id":"themes/cactus/source/css/_highlight/github.styl","hash":"3336aeba324c6d34a6fd41fef9b47bc598f7064c","modified":1668331454429},{"_id":"themes/cactus/source/css/_highlight/googlecode.styl","hash":"bda816beee7b439814b514e6869dc678822be1bc","modified":1668331454429},{"_id":"themes/cactus/source/css/_highlight/grayscale.styl","hash":"bf37d8b8d1e602126c51526f0cc28807440228ed","modified":1668331454430},{"_id":"themes/cactus/source/css/_highlight/gruvbox-dark.styl","hash":"76b744c14fd5600bea64731c05df97c2df75523f","modified":1668331454430},{"_id":"themes/cactus/source/css/_highlight/highlightjs.styl","hash":"0e198b7a59191c7a39b641a4ddd22c948edb9358","modified":1668331454431},{"_id":"themes/cactus/source/css/_highlight/hopscotch.styl","hash":"1378a6bc67a32c0cbff72ab771268b53f9aa586d","modified":1668331454431},{"_id":"themes/cactus/source/css/_highlight/idea.styl","hash":"a02967cb51c16a34e0ee895d33ded2b823d35b21","modified":1668331454432},{"_id":"themes/cactus/source/css/_highlight/hybrid.styl","hash":"b8eb5c69d12f2ee5ebc50265ae271699d7f1a8d3","modified":1668331454431},{"_id":"themes/cactus/source/css/_highlight/index.styl","hash":"002d5596f6379cc87dbd43d9145bc764aa666be1","modified":1668331454432},{"_id":"themes/cactus/source/css/_highlight/ir-black.styl","hash":"53e5d74326a4527b92272bbd6946d4fec92720e8","modified":1668331454432},{"_id":"themes/cactus/source/css/_highlight/kimbie.dark.styl","hash":"45dbb168f22d739d0109745d2decd66b5f94e786","modified":1668331454432},{"_id":"themes/cactus/source/css/_highlight/kimbie.styl","hash":"51b889ca7c6fe178cfbbe28d875a6ea427184441","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/kimbie.light.styl","hash":"61f8baed25be05288c8604d5070afbcd9f183f49","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/magula.styl","hash":"16d323f989b1420a0f72ef989242ece9bf17a456","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/monokai-sublime.styl","hash":"c385b11345894be7e6ce3c5f08663e199933b8e4","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/mono-blue.styl","hash":"4c89a6ae29de67c0700585af82a60607e85df928","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/obsidian.styl","hash":"199e28326be8590883f0813ebbd54fcfaa4750fd","modified":1668331454434},{"_id":"themes/cactus/source/css/_highlight/monokai.styl","hash":"f87be027848ea6bee623a08ad1e17b2f5b7937ee","modified":1668331454433},{"_id":"themes/cactus/source/css/_highlight/paraiso-dark.styl","hash":"f1537bd868579fa018ecdbfd2eb922dcf3ba2cac","modified":1668331454434},{"_id":"themes/cactus/source/css/_highlight/paraiso-light.styl","hash":"d224d1df0eb3395d9eea1344cee945c228af2911","modified":1668331454434},{"_id":"themes/cactus/source/css/_highlight/rainbow.styl","hash":"c0cf97aae3e10fdcd10414547a711c9effbc39b8","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/paraiso.styl","hash":"75f181eece6b71d033ea0c8d6cf00ae7efb9e29b","modified":1668331454434},{"_id":"themes/cactus/source/css/_highlight/pojoaque.jpg","hash":"c5fe6533b88b21f8d90d3d03954c6b29baa67791","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/pojoaque.styl","hash":"4e7b6b046b8575ac749f6aec4e953a62ada27a36","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/railscasts.styl","hash":"b6674db9210e0c4444e4835fff2d1361f3ebd64c","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/school-book.png","hash":"711ec983c874e093bb89eb77afcbdf6741fa61ee","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/school-book.styl","hash":"d43560fe519a931ce6da7d57416d7aa148441b83","modified":1668331454435},{"_id":"themes/cactus/source/css/_highlight/solarized-light.styl","hash":"aa0dd3fd25c464183b59c5575c9bee8756b397f2","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/solarized-dark.styl","hash":"90c9da5aa594383697e5b18892a7f95beb053f55","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-blue.styl","hash":"f24c17d0ab815dcfaab3438cb9fe2ab4839f5e0d","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/sunburst.styl","hash":"af3eec0fd56151e55bbd49c31b151f36717611d8","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-eighties.styl","hash":"28d751075ebabf7d0327a36f725076fe82fdf626","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-bright.styl","hash":"7674fecb6d27350727dc0d2dc93bc018382ebbd0","modified":1668331454436},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night.styl","hash":"16ba09b2db501e4e3e2e7d62595d9bf935bf27c4","modified":1668331454437},{"_id":"themes/cactus/source/css/_highlight/tomorrow.styl","hash":"15779cf6846725c7c35fc56cac39047d7e0aec1c","modified":1668331454437},{"_id":"themes/cactus/source/css/_highlight/vs.styl","hash":"959a746f4b37aacb5d1d6ff1d57e0c045289d75d","modified":1668331454437},{"_id":"themes/cactus/source/css/_highlight/xcode.styl","hash":"5e8532ae8366dcf6a4ef5e4813dc3d42ab3d0a50","modified":1668331454437},{"_id":"themes/cactus/layout/_partial/post/actions_desktop.ejs","hash":"aa6218d8d5af1e26e7a0d805b1ea864eca2b88c5","modified":1668331454416},{"_id":"themes/cactus/layout/_partial/post/actions_mobile.ejs","hash":"79b234ff3c264e66b2e71c819228e62bf92b48e4","modified":1668331454416},{"_id":"themes/cactus/source/css/_highlight/zenburn.styl","hash":"68ff9332ccc03f9389b15b713415cde016f8088f","modified":1668331454438},{"_id":"themes/cactus/layout/_partial/post/category.ejs","hash":"b5bfa049f17868fb09d9d2a7e1d5279fa0381d37","modified":1668331454416},{"_id":"themes/cactus/layout/_partial/post/date.ejs","hash":"6f2d1aa9562df343b797d25705f1945323c465fb","modified":1668331454416},{"_id":"themes/cactus/layout/_partial/post/gallery.ejs","hash":"9aecd8908e8a684f33dc20c02497c0f1774137c7","modified":1668331454416},{"_id":"themes/cactus/layout/_partial/post/share.ejs","hash":"1a294382bd14d979525b8ed934d807bc7d083e4d","modified":1668331454417},{"_id":"themes/cactus/layout/_partial/post/title.ejs","hash":"a060f1c6e3718494a6b1d0e1981ea0bf4e549828","modified":1668331454417},{"_id":"themes/cactus/layout/_partial/post/tag.ejs","hash":"e08fae30da060f49c087f6c121868b08eb55c795","modified":1668331454417},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","hash":"6674f81dd01c76be986cf0a8172d1073e56d7ef4","modified":1668331454446},{"_id":"themes/cactus/source/lib/font-awesome/.DS_Store","hash":"0b544570f6a9760eab176f1e4cbec40521c3fd76","modified":1668392853347},{"_id":"themes/cactus/source/lib/justified-gallery/.DS_Store","hash":"d2f4c5f1a5e35f867aed2f3b1bbc37b6bf730ca0","modified":1668392853353},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","hash":"f6fda2de0348b3e3b7de73267f9f8e97a62f8353","modified":1668331454489},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","hash":"7ea4fd7dd4cd4f480af78a0e2c5849eb921b1aeb","modified":1668331454489},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","hash":"56e632c9196fac364c66f812a3b4635dd999ad1c","modified":1668331454494},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","hash":"6e40d0c7669c1adbcbf034bdc459f7bed4d6676d","modified":1668331454494},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","hash":"50b654d916204c30987d1987abd890ef92085ae3","modified":1668331454498},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","hash":"1c3dbf17411b1f6a6b22c2b76e9d8511586643d0","modified":1668331454497},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","hash":"43a8aaa3fca8721dd32a5d20f7a98dfbc87c97fd","modified":1668331454501},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","hash":"14b3e257c51a6a11d23b2a078017ff340c9777e4","modified":1668331454501},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.woff","hash":"235889d59ddad2b1f3243ccaab7733bd713a2a21","modified":1668331454503},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.woff2","hash":"a9714ffb842afc74836e64de04b52d8c37c87c8a","modified":1668331454503},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","hash":"c0e784de2eb5261cca244928f8a81fd893c3fe16","modified":1668331454506},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","hash":"9b03b1a9071709f5b7dbca13412ecef6cb7a2a67","modified":1668331454506},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.woff","hash":"2e8e6d38d361def5f48baac366f04e3db3ed4828","modified":1668331454509},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.woff2","hash":"e213bb26bc7f10e1df3fe2d03d3ecaecd6e6d371","modified":1668331454509},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","hash":"ba0030e1cd28a8caa7a5bb74b98da7c7bb185c90","modified":1668331454509},{"_id":"themes/cactus/source/css/_partial/post/actions_mobile.styl","hash":"0d2966c1d870392476864af8ee3ba312ba30cb82","modified":1668331454440},{"_id":"themes/cactus/source/css/_partial/post/actions_desktop.styl","hash":"a1f36f9a3fd5ffcd832bf39e9402678978035d48","modified":1668331454440},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","hash":"d1a7eff18db8a47207ea42e34e9d9fbcc66a97a7","modified":1668331454451},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"be22b700cc80c242da898ef8b7bb96adc4e0899f","modified":1668331454451},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-v4compatibility.ttf","hash":"c77fcea87e0c4953f2b0ac92dc49a31c664b6ef7","modified":1668331454455},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","hash":"ad8f48b4022498078b089fcdd1e8b47faf496931","modified":1668331454458},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","hash":"dd3052149d3054f35efb823c68dd78e78aad5875","modified":1668331454457},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-v4compatibility.woff2","hash":"60d794c18c2b58b2b76d2ce17b85c44c48fb2efd","modified":1668331454456},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","hash":"b82d238d4e31fdf618bae8ac11a6c812c03dd0d4","modified":1668331454457},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","hash":"91152bd73e7ff8d943e3bde3ddb0fa0a018e1c21","modified":1668331454487},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","hash":"b65915e3fa57b5c19995d15dc2341d115c1971b9","modified":1668331454489},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","hash":"5c1c680fade45393e4a5bb4548a092cd5ea6811e","modified":1668331454491},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","hash":"122bb778b17a152c426a825ee981610a4bd59bf3","modified":1668331454493},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","hash":"a059359e9bea17dc2ff2ede955a05bf0dc4d00d0","modified":1668331454496},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","hash":"df82b80c4d3b11e70dcd269fc62ac97cbfa0414d","modified":1668331454497},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","hash":"948a091f0fdb8c7ae17d5ef8e51bd8830d65dd9a","modified":1668331454500},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","hash":"d9ec1f9f3fefd57e446cbe86dc297f1ff269b6de","modified":1668331454499},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.eot","hash":"521c01f0eb79a48025e972ecbe21b0d7fb15437b","modified":1668331454502},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Regular.ttf","hash":"643c28c8f8a2bce1a0d62525aa045cd9883773cd","modified":1668331454502},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","hash":"a0ea0bdaef00b35544f9a21d25d35db9a79f7189","modified":1668331454504},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","hash":"6aacb0eecb03c660570b6e159ba5ca97ca7461cf","modified":1668331454505},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.eot","hash":"af46f7f4e10a1440a4c97b350622d279143e6798","modified":1668331454507},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Variable.ttf","hash":"1e08b6373c2e086f24776df9b11e4be6bbcc8a4a","modified":1668331454508},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","hash":"d3cafed4c6596253c1050ee63897aa0f440e4f65","modified":1668331454447},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"98564e5517b7b455e80b2cd503e7bb3b52beb930","modified":1668331454450},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","hash":"cfb2c6122bd53141e939ee4ff991a16a29d1bdce","modified":1668331454449},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"09a731f80844483614ff12f86ccbe41db6736cb5","modified":1668331454455},{"_id":"themes/cactus/source/images/logo.png","hash":"0e3029251dfda26adee2761f71377297e8c26871","modified":1668331454445},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","hash":"b7d24ab1e4fad720f31a2b0cca1904ce1740d846","modified":1668331454469},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","hash":"b542b9591fbf33925d93f0695b6e123a9f0cfd43","modified":1668331454479},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","hash":"926035f0156cccf1b0ca507347f39bf9c510f51e","modified":1668331454484},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","hash":"97f5404656d9547666479ec64c336467000656ef","modified":1668331454454},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","hash":"9a23c6898b0943bd3d96c04df9a0f66e919451d8","modified":1668331454474},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","hash":"93ebc5098cf57a32b7b8d297681f31692c09bdfa","modified":1668331454480},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","hash":"9d757cc9f928fc83b2133283dd639c12b11d94ad","modified":1668331454485},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","hash":"34f7db59f1d023294e69976aa20b7d52b86165a4","modified":1668331454467},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","hash":"6c090d6bff3928fbf8a5f4104e58ed7f421aea7c","modified":1668331454476},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","hash":"58be4b7760e9a84daa81929d046f9a15c4fd1c1a","modified":1668331454477},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","hash":"f9918fb93d6ab6850f5d38069a999c311af78816","modified":1668331454483},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","hash":"20ce1fc7ae1254558ca044ae48283faaa58897e5","modified":1668331454482},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","hash":"de559f8d70d5b1ab2810597bfd0b1b9506f3ef01","modified":1668331454486},{"_id":"public/tree/index.html","hash":"d6792c4df36e4e3d18a2010faabe5ac4cbd94d55","modified":1677678270154},{"_id":"public/search.xml","hash":"45c647e1315ae45ae559b4be5d4137f4c3136173","modified":1751749289430},{"_id":"public/about-me/index.html","hash":"7f9665649d3aaf33cd57e8b2cc4b971d2f4bbcb2","modified":1743370750127},{"_id":"public/search/index.html","hash":"50b7b5339fc705d6ddbdc6b81784c1408cec9ee7","modified":1743533527918},{"_id":"public/2023/01/17/RDMA-soft-config/index.html","hash":"8036e733044c87c3a7b85587c3a32ede6fb31f41","modified":1751749289430},{"_id":"public/2022/11/23/Tree/index.html","hash":"6cf1e043af16fb5196ba8533f6e2e13ce7e40f3b","modified":1743533527918},{"_id":"public/2022/11/19/Amazon-Doc/index.html","hash":"2671b9e54bcecba8741b94a550b9dda9904716aa","modified":1743533527918},{"_id":"public/archives/index.html","hash":"65638d8b1ee9d49dc8c6b5cc893774b2c0c13008","modified":1751749289430},{"_id":"public/archives/page/2/index.html","hash":"296b723d2e7a15eb78c5aca740897f92bdc6d669","modified":1748462468559},{"_id":"public/archives/page/3/index.html","hash":"0f46a22db66d9c0716f57aa047114c5fd4dda566","modified":1751749289430},{"_id":"public/archives/2022/index.html","hash":"0122add106d9d36309370e6e9585f0e565622977","modified":1751749289430},{"_id":"public/archives/2022/11/index.html","hash":"5a891299436c8cd06fceb4b4ac2ae116c493d9a1","modified":1751749289430},{"_id":"public/archives/2022/12/index.html","hash":"cec5706024c1667b62d85932bcd4eaabac749137","modified":1743533527918},{"_id":"public/archives/2023/index.html","hash":"525789b88f468633a017634b756a0e97fd677954","modified":1743533527918},{"_id":"public/archives/2023/page/2/index.html","hash":"902f3f42b517ab7f8a4ac886e87a9c9ec497c502","modified":1751749289430},{"_id":"public/archives/2023/01/index.html","hash":"d5e02d5c09cfb08854c243f4e5dea015488aec42","modified":1751749289430},{"_id":"public/archives/2023/02/index.html","hash":"ac133786d03b10f16c10aaed12e4c1698ad3ed15","modified":1751749289430},{"_id":"public/index.html","hash":"2a690e7f241027173e1897ad674f89d2fc463845","modified":1756777668847},{"_id":"public/page/2/index.html","hash":"fb69ccf42254b2f1ae04fc580cac2e2eaa1dcaad","modified":1743367728478},{"_id":"public/page/3/index.html","hash":"c6e6c6330637971cde484a401241a3ca696bf54d","modified":1743367728478},{"_id":"public/tags/intern/index.html","hash":"20ebde3e91ee169176c54325dc3746b50fdb77d3","modified":1751749289430},{"_id":"public/tags/Casdoor/index.html","hash":"d2f0a6bc4edcc52d51c97bfbcb6c9b0eefa577aa","modified":1743533527918},{"_id":"public/tags/casdoor/index.html","hash":"1f1fd49b770fe8762bbdcd6693d59551df2b1a4e","modified":1743533527918},{"_id":"public/tags/Go/index.html","hash":"f89918a82b78c30919099205725c353e0f3b2d38","modified":1743533527918},{"_id":"public/tags/Operation-Systems-Three-Easy-Pieces/index.html","hash":"cab8839632647b1c922c149a2d2cb52552ecf49a","modified":1743533527918},{"_id":"public/tags/Virtualization/index.html","hash":"b7c2e68ce89bb0a00bec5b803f407b1412d5e64f","modified":1743533527918},{"_id":"public/404.html","hash":"39bcbedb62d3e1d3acfd95b41b5d4ff65d95ff41","modified":1743533527918},{"_id":"public/2023/02/22/eBPF-XDP/index.html","hash":"4fa6333731fcc9c4be7d05d4622552bfc0897e14","modified":1677678270154},{"_id":"public/2023/02/27/XDP数据传输问题综述/index.html","hash":"e2a49ed1d9094cd07b2b3490f353e7487a94714b","modified":1743533527918},{"_id":"public/2023/02/19/lc1792-Maximum-Average-Pass-Ratio/index.html","hash":"c178a3eaa070c437e84ae45273b377b1f8006a99","modified":1743533527918},{"_id":"public/2023/02/18/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/index.html","hash":"12929b8f246f36bc4c69a18aa1dc4e17878abb56","modified":1743533527918},{"_id":"public/2023/02/13/lc-1234-Sliding-window/index.html","hash":"30de0d324176c1f37e7177b772b6ff55a7330452","modified":1743533527918},{"_id":"public/2023/02/17/lc1139-Largest-1-Bordered-Square/index.html","hash":"740d99af19da08692044508716a419e6168c7ab5","modified":1751749289430},{"_id":"public/2023/02/10/libbpf-01/index.html","hash":"c9b5dc7471e1e48e205257312893c3058cecfc86","modified":1743533527918},{"_id":"public/2023/02/07/MITOSIS-by-WASM-ebpf-in-Faasm/index.html","hash":"f103a725d49ff9e488f42b305dc5f3132309c823","modified":1678459491404},{"_id":"public/2023/02/06/Faasm-WASM-serverless/index.html","hash":"3b719f9c7577414ce39c24e310b2927e5e6f62b6","modified":1677678270154},{"_id":"public/2023/02/02/MITOSIS-test/index.html","hash":"25e17d4bcfb3a50e3e6867a55848ae06e5fd9b65","modified":1751749289430},{"_id":"public/2023/01/19/eBPF学习-01/index.html","hash":"aedbe65ae9b9f34cd5f9768e2b7252770109d1c9","modified":1743533527918},{"_id":"public/2023/01/16/MIT-6-s081-Lab5-COW/index.html","hash":"b853f36f685a5d27ba7009f007a8ab21b5f44918","modified":1677678270154},{"_id":"public/2023/01/14/MITOSIS-learning/index.html","hash":"935262c6360935861a210f6a9eac5b3f84185da5","modified":1677678270154},{"_id":"public/2023/01/13/MIT-6-s081-Lab4/index.html","hash":"6a90eb056c2c9fd4c8a9e9660627bc96e1a9bb55","modified":1743533527918},{"_id":"public/2023/01/11/MIT6-s081-Lab3-Page-Table/index.html","hash":"e035a9611188113b27f9a5f8a0351eab3064e644","modified":1677678270154},{"_id":"public/2023/01/10/6-s081-Lab2-System-Call/index.html","hash":"248f342d48c32e3f96f8f214e42cf2beead42f33","modified":1743533527918},{"_id":"public/2022/12/06/Log-fremawork-High-level-design/index.html","hash":"d4326cb7ae28553768a74a025ba59bd8c7063c3d","modified":1751749289430},{"_id":"public/2022/12/01/Cross-domain-security-in-SSO/index.html","hash":"274639d4f3019cd874fb1852914ad9c41b350869","modified":1743533527918},{"_id":"public/2022/11/29/Study-Notes-about-Virtualization-01/index.html","hash":"bfca3324ee2d2d63e329b690f4bee7f1343cf500","modified":1743533527918},{"_id":"public/2022/11/27/Casdoor-Flutter-Sdk-Bug-Fix/index.html","hash":"c13f08de88fd228e3d25f55494ebcb5dfff820ce","modified":1751749289430},{"_id":"public/2022/11/22/Casdoor-Flutter-sdk-Test/index.html","hash":"069dc08ccda3001ce68af17d76ea9f8f9847f02a","modified":1677678270154},{"_id":"public/2022/11/13/OS Learning 01/index.html","hash":"1498a65d9b0cd5921e044e316586a8829f3823f2","modified":1751749289430},{"_id":"public/2022/11/13/my-first-blog/index.html","hash":"256b3d663b0d3d676f412081a96a6b84205e37de","modified":1743533527918},{"_id":"public/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1677678270154},{"_id":"public/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1677678270154},{"_id":"public/images/apple-touch-icon.png","hash":"57e2def34682655f41a0be2d083f16765ba7858b","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Black.woff","hash":"f6fda2de0348b3e3b7de73267f9f8e97a62f8353","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Black.woff2","hash":"7ea4fd7dd4cd4f480af78a0e2c5849eb921b1aeb","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Bold.woff","hash":"56e632c9196fac364c66f812a3b4635dd999ad1c","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Bold.woff2","hash":"6e40d0c7669c1adbcbf034bdc459f7bed4d6676d","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Light.woff","hash":"1c3dbf17411b1f6a6b22c2b76e9d8511586643d0","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Light.woff2","hash":"50b654d916204c30987d1987abd890ef92085ae3","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Medium.woff","hash":"43a8aaa3fca8721dd32a5d20f7a98dfbc87c97fd","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Medium.woff2","hash":"14b3e257c51a6a11d23b2a078017ff340c9777e4","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Regular.woff","hash":"235889d59ddad2b1f3243ccaab7733bd713a2a21","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Regular.woff2","hash":"a9714ffb842afc74836e64de04b52d8c37c87c8a","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Thin.woff","hash":"c0e784de2eb5261cca244928f8a81fd893c3fe16","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Thin.woff2","hash":"9b03b1a9071709f5b7dbca13412ecef6cb7a2a67","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Variable.woff2","hash":"e213bb26bc7f10e1df3fe2d03d3ecaecd6e6d371","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Variable.woff","hash":"2e8e6d38d361def5f48baac366f04e3db3ed4828","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.ttf","hash":"d1a7eff18db8a47207ea42e34e9d9fbcc66a97a7","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"be22b700cc80c242da898ef8b7bb96adc4e0899f","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-v4compatibility.ttf","hash":"c77fcea87e0c4953f2b0ac92dc49a31c664b6ef7","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-v4compatibility.woff2","hash":"60d794c18c2b58b2b76d2ce17b85c44c48fb2efd","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Black.eot","hash":"91152bd73e7ff8d943e3bde3ddb0fa0a018e1c21","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Black.ttf","hash":"b65915e3fa57b5c19995d15dc2341d115c1971b9","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Bold.eot","hash":"5c1c680fade45393e4a5bb4548a092cd5ea6811e","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Bold.ttf","hash":"122bb778b17a152c426a825ee981610a4bd59bf3","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Light.eot","hash":"a059359e9bea17dc2ff2ede955a05bf0dc4d00d0","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Light.ttf","hash":"df82b80c4d3b11e70dcd269fc62ac97cbfa0414d","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Medium.eot","hash":"d9ec1f9f3fefd57e446cbe86dc297f1ff269b6de","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Medium.ttf","hash":"948a091f0fdb8c7ae17d5ef8e51bd8830d65dd9a","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Regular.eot","hash":"521c01f0eb79a48025e972ecbe21b0d7fb15437b","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Regular.ttf","hash":"643c28c8f8a2bce1a0d62525aa045cd9883773cd","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Thin.eot","hash":"a0ea0bdaef00b35544f9a21d25d35db9a79f7189","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Thin.ttf","hash":"6aacb0eecb03c660570b6e159ba5ca97ca7461cf","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Variable.eot","hash":"af46f7f4e10a1440a4c97b350622d279143e6798","modified":1677678270154},{"_id":"public/lib/vazir-font/Vazir-Variable.ttf","hash":"1e08b6373c2e086f24776df9b11e4be6bbcc8a4a","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"98564e5517b7b455e80b2cd503e7bb3b52beb930","modified":1677678270154},{"_id":"public/js/main.js","hash":"619ac6529d140711e3b14f739a192bb31c4824ff","modified":1677678270154},{"_id":"public/js/search.js","hash":"914a2ce72fb325106c61600200be823b72bfb39f","modified":1677678270154},{"_id":"public/css/rtl.css","hash":"9589fac02a34fd9084f805f801889028756bbb65","modified":1677678270154},{"_id":"public/lib/clipboard/clipboard.min.js","hash":"6674f81dd01c76be986cf0a8172d1073e56d7ef4","modified":1677678270154},{"_id":"public/lib/vazir-font/font-face.css","hash":"ba0030e1cd28a8caa7a5bb74b98da7c7bb185c90","modified":1677678270154},{"_id":"public/lib/justified-gallery/css/justifiedGallery.min.css","hash":"dd3052149d3054f35efb823c68dd78e78aad5875","modified":1677678270154},{"_id":"public/css/style.css","hash":"17ec488afd6799fc76ba12be42fcc1042fba3ed3","modified":1677678270154},{"_id":"public/lib/jquery/jquery.min.js","hash":"b82d238d4e31fdf618bae8ac11a6c812c03dd0d4","modified":1677678270154},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"d3cafed4c6596253c1050ee63897aa0f440e4f65","modified":1677678270154},{"_id":"public/lib/justified-gallery/js/jquery.justifiedGallery.min.js","hash":"ad8f48b4022498078b089fcdd1e8b47faf496931","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.ttf","hash":"cfb2c6122bd53141e939ee4ff991a16a29d1bdce","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"09a731f80844483614ff12f86ccbe41db6736cb5","modified":1677678270154},{"_id":"public/images/logo.png","hash":"0e3029251dfda26adee2761f71377297e8c26871","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGL-BoldItalic.ttf","hash":"b7d24ab1e4fad720f31a2b0cca1904ce1740d846","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGM-BoldItalic.ttf","hash":"b542b9591fbf33925d93f0695b6e123a9f0cfd43","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGS-BoldItalic.ttf","hash":"926035f0156cccf1b0ca507347f39bf9c510f51e","modified":1677678270154},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.ttf","hash":"97f5404656d9547666479ec64c336467000656ef","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGL-Italic.ttf","hash":"9a23c6898b0943bd3d96c04df9a0f66e919451d8","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGM-Italic.ttf","hash":"93ebc5098cf57a32b7b8d297681f31692c09bdfa","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGS-Italic.ttf","hash":"9d757cc9f928fc83b2133283dd639c12b11d94ad","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGM-Bold.ttf","hash":"58be4b7760e9a84daa81929d046f9a15c4fd1c1a","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGL-Bold.ttf","hash":"34f7db59f1d023294e69976aa20b7d52b86165a4","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGM-Regular.ttf","hash":"20ce1fc7ae1254558ca044ae48283faaa58897e5","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGL-Regular.ttf","hash":"6c090d6bff3928fbf8a5f4104e58ed7f421aea7c","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGS-Bold.ttf","hash":"f9918fb93d6ab6850f5d38069a999c311af78816","modified":1677678270154},{"_id":"public/lib/meslo-LG/MesloLGS-Regular.ttf","hash":"de559f8d70d5b1ab2810597bfd0b1b9506f3ef01","modified":1677678270154},{"_id":"source/_posts/lc1653-Minimum-Deletions-to-Make-String-Balanced.md","hash":"9dcfefb0376ac82e96eb492e2667967c99393084","modified":1678071194493},{"_id":"public/2023/03/06/lc1653-Minimum-Deletions-to-Make-String-Balanced/index.html","hash":"2f0aad0658d3318671b25b97553aff94b9657468","modified":1678192600320},{"_id":"public/archives/2023/03/index.html","hash":"081b8079ab43712ba21c14d480aaf653424d58f7","modified":1743533527918},{"_id":"source/_posts/ChatRepo-handbook.md","hash":"b32d1be40c42e149dbcf5b6bcdbaba62ceea325c","modified":1678264100461},{"_id":"public/2023/03/07/ChatRepo-handbook/index.html","hash":"49bfff629dee62c7d044aaca28851eae185c4caa","modified":1743533527918},{"_id":"source/_posts/User-space-page-fault-handling.md","hash":"89224177dc7c99ae0d8e00a2143a9108d25f7225","modified":1679216873577},{"_id":"public/2023/03/09/User-space-page-fault-handling/index.html","hash":"247de1b9a7680e24479f43023564d2bdfe9f865e","modified":1679216880335},{"_id":"source/_posts/WASM-Runtime-Structure.md","hash":"a4778609370db768627cf350243f7d079cfb01bc","modified":1679728491135},{"_id":"source/_posts/Best-Time-to-Buy-and-Sell-Stock.md","hash":"28070c623d1974362f1003636a8bf9d275637b61","modified":1678935339714},{"_id":"public/archives/page/4/index.html","hash":"e8388192cd07330b8d38b8b96dbff6cc69ac586b","modified":1751749289430},{"_id":"public/archives/2023/page/3/index.html","hash":"6d136194f513ed196993162d52b8bb74b8de4585","modified":1751749289430},{"_id":"public/page/4/index.html","hash":"5684b0f29b4c1e4b969cb5c70f46d771085728fb","modified":1743367728478},{"_id":"public/2023/03/16/Best-Time-to-Buy-and-Sell-Stock/index.html","hash":"70ab2df02ef772071406a868839a2700189d88c0","modified":1679214961344},{"_id":"public/2023/03/16/WASM-Runtime-Structure/index.html","hash":"8c8074e1a7d8f6838bdb2f4aec795cdde2df8c14","modified":1691508049132},{"_id":"source/_posts/new-blog.md","hash":"2fc8fa4df437ae96603a30d44851de81d07931ce","modified":1690124216638},{"_id":"public/2023/07/23/new-blog/index.html","hash":"feee15291176208e54e8c0b081ec83759373e36d","modified":1690124221178},{"_id":"public/archives/2023/07/index.html","hash":"b917f15052a8b25e72d50a0a2660a71682735a30","modified":1690124221178},{"_id":"source/about-me/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1743373897516},{"_id":"source/_posts/test-1.md","hash":"3f6f9f40c19bd1d2ed177dbc95a5e999fe5ebe82","modified":1691508041826},{"_id":"public/2023/08/08/test-1/index.html","hash":"68c8bd4e1669255c49510a4f394cb147c6a8daaf","modified":1743533527918},{"_id":"public/archives/2023/08/index.html","hash":"91758bbe9498491f43f5544a3e54ef58aa082616","modified":1743533527918},{"_id":"source/_posts/823-Binary-Trees-With-Factors.md","hash":"13daebb62b04e8e8b97af165a5fd0be87f8eceb4","modified":1693250485078},{"_id":"source/_posts/MapRedece.md","hash":"7f1e0635a21e020bfa2c49e5f46c4f10e7672e3e","modified":1693594732410},{"_id":"public/2023/08/27/MapRedece/index.html","hash":"516a3aaf7a73c8ceedf2463be558459058de6a40","modified":1743533527918},{"_id":"public/2023/08/28/823-Binary-Trees-With-Factors/index.html","hash":"cd26fb5efe11b21a69eb9931c4d4025ad73af464","modified":1743533527918},{"_id":"public/2023/03/15/WASM-Runtime-Structure/index.html","hash":"bc3b3348cad2fbb36bfafa623a823655635fe3d2","modified":1743533527918},{"_id":"public/2023/03/15/Best-Time-to-Buy-and-Sell-Stock/index.html","hash":"0b1228756db491dfeaa8295a1fcf80d4fdcd8c9e","modified":1743533527918},{"_id":"public/2023/03/05/lc1653-Minimum-Deletions-to-Make-String-Balanced/index.html","hash":"55ca7065347e741c6a91d1b9894396581aa2f491","modified":1743533527918},{"_id":"public/2023/03/08/User-space-page-fault-handling/index.html","hash":"9c6057e43463d8e532561d0b2a7d5ef0dc201ba9","modified":1743533527918},{"_id":"public/2023/02/21/eBPF-XDP/index.html","hash":"c328335bb56e59542bf88e2299c893a60c69cc4c","modified":1751749289430},{"_id":"public/2023/02/06/MITOSIS-by-WASM-ebpf-in-Faasm/index.html","hash":"9cfdba3138e9b87e73ecb7022aec32c8fe159588","modified":1751749289430},{"_id":"public/2023/02/05/Faasm-WASM-serverless/index.html","hash":"f0c93be7694ada68ff9244f4dec2f2d209807565","modified":1743533527918},{"_id":"public/2023/01/15/MIT-6-s081-Lab5-COW/index.html","hash":"04ac6bf77b4edd229a693b1237b1ad6c8bffe7a9","modified":1743533527918},{"_id":"public/2023/01/13/MITOSIS-learning/index.html","hash":"d37b197098b7dcb5e7ec4444b2c77cf0d9e5afa1","modified":1743533527918},{"_id":"public/2023/01/10/MIT6-s081-Lab3-Page-Table/index.html","hash":"31affc75079a3ba4b439d0c02c0efa9ad2b0f3d7","modified":1751749289430},{"_id":"public/2022/11/21/Casdoor-Flutter-sdk-Test/index.html","hash":"2d667e80cf20d993ac71aff5e462f122e9d9f697","modified":1751749289430},{"_id":"source/_posts/853-Car-Fleet.md","hash":"c70536294016a437d3ce3d9d6dd36e5cfceaa336","modified":1693594542902},{"_id":"public/2023/09/01/853-Car-Fleet/index.html","hash":"cc001945aff0507e102d99db951d0f4d3cc0bf76","modified":1743533527918},{"_id":"public/archives/2023/09/index.html","hash":"d1b69263022ca4dd8350b60d61c13205572caa4a","modified":1743533527918},{"_id":"source/_posts/Spark-Check-Point.md","hash":"32aea7e04fc79ed5fc113825ec73c4a2123c985f","modified":1695680100993},{"_id":"source/_posts/Color-FaaS.md","hash":"4de6e6ae371ba2ed8a410f80eef4ba9e5ba40c66","modified":1696212753696},{"_id":"source/_posts/Distributed-sys-mp1-design.md","hash":"7c062da286e3aba3b6d7b79dbc83b0eea999f51a","modified":1695702902502},{"_id":"source/_posts/Spark-Memory-Manager.md","hash":"283d5ccfd39a72446d8fda63b8bcd7bf879acd81","modified":1694728387947},{"_id":"public/2023/09/14/Spark-Memory-Manager/index.html","hash":"4c79d2b605dae448b183ca74f99895e569b33686","modified":1743533527918},{"_id":"public/2023/09/24/Distributed-sys-mp1-design/index.html","hash":"b27bd0321eabe12b488767761532d01eb069806f","modified":1743533527918},{"_id":"public/2023/09/25/Color-FaaS/index.html","hash":"d979ca2a07b75e41ce998faf14c72c61219ce155","modified":1743533527918},{"_id":"public/2023/09/25/Spark-Check-Point/index.html","hash":"84964a9443615de55b1d5ee5193d84202107abd7","modified":1743533527918},{"_id":"source/_posts/Color-FaaS-2.md","hash":"50b52c598fce8c1b86ca239d3343f762829ece29","modified":1701895725622},{"_id":"public/2023/10/27/Color-FaaS-2/index.html","hash":"0fa9fbc9b6e472330c7305073ba58daf2de35caf","modified":1743533527918},{"_id":"public/archives/2023/page/4/index.html","hash":"ebf3e0cb0452c7bdcf363af383fc52c49fb3edfe","modified":1751749289430},{"_id":"public/archives/2023/10/index.html","hash":"0f806479dbba881772faf7f2dd2cb6884682ced1","modified":1743533527918},{"_id":"source/_posts/2023-Self-Review.md","hash":"e3878886146c166c62a160d84fc6aea16279113c","modified":1703962996720},{"_id":"public/archives/page/5/index.html","hash":"e3bafc726d3ab8b23f302b00e2fcdf8cf9b4fe5d","modified":1751749289430},{"_id":"public/archives/2023/12/index.html","hash":"73291a9478aac7d1df0bb53f2c85eba88d597fd4","modified":1743533527918},{"_id":"public/page/5/index.html","hash":"1f2c9880ef84d341465d53c790cae35cfdd59c61","modified":1743367728478},{"_id":"public/2023/12/26/2023-Self-Review/index.html","hash":"867c7a0c1fe2f5f978dada2793ee318cfda8ef8d","modified":1743533527918},{"_id":"source/_posts/CSCE611-MP1.md","hash":"a7b2173d16a5167a1732c575e372cfef888e45d3","modified":1706215029290},{"_id":"source/_posts/CSCE611-OS-Projest01-Note.md","hash":"b8755d49d1117bfbcbe1dc24585cc2ee8798553e","modified":1707591270949},{"_id":"public/2024/01/25/CSCE611-OS-Projest01-Note/index.html","hash":"cdd9c48339cedf6772c8b86fd23e71e27f2b0118","modified":1743533527918},{"_id":"public/2024/01/23/CSCE611-MP1/index.html","hash":"0d68cc22997d4c215c97f10b6f120a4cf8cda1d1","modified":1743533527918},{"_id":"public/archives/2024/index.html","hash":"086d4d397d8f1fa382ba40e09ae81a3c11831aec","modified":1743533527918},{"_id":"public/archives/2024/01/index.html","hash":"c643acf8acdec7d1853bfbd6dbdb7e120afea152","modified":1743533527918},{"_id":"source/_posts/CSCE611-OS-Project02-Frame-Manager.md","hash":"7dd2afc6eabd6058e35260d34f6b472069ed5608","modified":1707715748558},{"_id":"public/2024/02/10/CSCE611-OS-Project02-Frame-Manager/index.html","hash":"785cbc4596aa76f7c5052c514e31f7877767cdc2","modified":1743533527918},{"_id":"public/archives/2024/02/index.html","hash":"21b5da829c4ae2c2d3e9dddb76256f606a39f4aa","modified":1743533527918},{"_id":"source/_posts/CSCE611-OS-Project03.md","hash":"acab40165772559c01ef255c0fefd5825786a494","modified":1708880703954},{"_id":"source/HW_week5.pdf","hash":"dfc60b80b85a12e1bc62a00cba9f322ecf8221dd","modified":1708572137449},{"_id":"public/2024/02/23/CSCE611-OS-Project03/index.html","hash":"5deab62642807ba8e0a935c6a0ae27e40d706b0c","modified":1743533527918},{"_id":"public/HW_week5.pdf","hash":"dfc60b80b85a12e1bc62a00cba9f322ecf8221dd","modified":1708748623561},{"_id":"source/_posts/CSCE611-OS-Project04-Memory.md","hash":"7053eebbf1e4e0ac1d0c3067bce7ee10ae5c480c","modified":1710960632983},{"_id":"public/2024/03/18/CSCE611-OS-Project04-Memory/index.html","hash":"388e58d0794599741995705a3db980583f7e3070","modified":1743533527918},{"_id":"public/archives/2024/03/index.html","hash":"2ca86032b6e256647af3657863e226f4e14e0e82","modified":1743533527918},{"_id":"source/_posts/CSCE611-OS-Project05-Process.md","hash":"44e0f7a7001c1a2fd889bc04c06259c0a34900a0","modified":1711834650846},{"_id":"source/_posts/CSCE611-OS-Project05-Thread.md","hash":"8c8f10628a18359110c68672c8e580f51045c340","modified":1711735808119},{"_id":"public/2024/03/26/CSCE611-OS-Project05-Process/index.html","hash":"bf7e00e7c983e72fe509966f40ad80467b8dcee8","modified":1743533527918},{"_id":"public/2024/03/24/CSCE611-OS-Project05-Thread/index.html","hash":"32d171ea5a1bdb6d0652656b19a15fcf6a112d24","modified":1743533527918},{"_id":"source/_posts/CSCE611-OS-Project07-File-System.md","hash":"ff5b8c25188f52fe68507d71d134b3896c0764e1","modified":1714765453007},{"_id":"source/_posts/.idea/_posts.iml","hash":"4ae7013efe60fffd2c4ed04a89e0a4fa9acb1706","modified":1713028868221},{"_id":"source/_posts/US-Transgender-Treatment-guidelines.md","hash":"0febefe4f7d7c18920f4343d0b89459993785473","modified":1715801981012},{"_id":"source/_posts/.idea/workspace.xml","hash":"690a182b45ebb11cc4e4c93b2a6f96797841c66c","modified":1713028868226},{"_id":"source/_posts/.idea/modules.xml","hash":"6abd6dcb985048745c9214d67295bdf1597307ee","modified":1713028868224},{"_id":"public/2024/05/15/US-Transgender-Treatment-guidelines/index.html","hash":"2127f1455289c43a76ff41185081a515cb4512e5","modified":1716765702534},{"_id":"public/2022/11/22/Tree/index.html","hash":"4d1c3da6de1f68958b12e544f9ed9ae3be288724","modified":1751749289430},{"_id":"public/2022/11/18/Amazon-Doc/index.html","hash":"30882be340a05c7c5d0c2b8e5546f8ce4260b232","modified":1751749289430},{"_id":"public/archives/2024/05/index.html","hash":"354c4ce1ea6931992108a76adbd3dcb9481efa5d","modified":1743533527918},{"_id":"public/2024/05/03/CSCE611-OS-Project07-File-System/index.html","hash":"7a5be0d01bf3f324d2e378bed5ed8b3d3936856e","modified":1743989569755},{"_id":"public/2023/02/18/lc1792-Maximum-Average-Pass-Ratio/index.html","hash":"2da175053c8d147807b9f5b357b607800ad2c506","modified":1751749289430},{"_id":"public/2023/02/17/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation/index.html","hash":"b7df1a492d3816c97c22728d8aa3f1b303d423c8","modified":1751749289430},{"_id":"public/2023/02/12/lc-1234-Sliding-window/index.html","hash":"fa20ef474d2e8fc626e38a61002b1bdc3f2a4d92","modified":1751749289430},{"_id":"public/2023/02/09/libbpf-01/index.html","hash":"15b6fe3ca50ab6830a79a04cdee0b5d82f4ba269","modified":1751749289430},{"_id":"public/2023/01/18/eBPF学习-01/index.html","hash":"b162e0b76033c2ee88edbb288eef7eea3d2e1926","modified":1751749289430},{"_id":"public/2023/01/09/6-s081-Lab2-System-Call/index.html","hash":"38adde2c7985d3cd4cbed32f259c29a98cf0c952","modified":1751749289430},{"_id":"source/_posts/Framework-SyntaxFlow.md","hash":"06efdef453eddd4e312d95d369b1faabf96cc8a7","modified":1724207262720},{"_id":"public/2024/08/20/Framework-SyntaxFlow/index.html","hash":"bdf2f1018982b162c851eb366753ea3745792f77","modified":1724207268130},{"_id":"public/archives/2024/08/index.html","hash":"c90fdc35589e6d26c583b615869a60d4ccac4841","modified":1724207161498},{"_id":"source/CNAME.txt","hash":"a26573d4e541996bdce9f61807982de80f42f6be","modified":1743031048660},{"_id":"public/CNAME.txt","hash":"a26573d4e541996bdce9f61807982de80f42f6be","modified":1743031092508},{"_id":"source/CNAME","hash":"a26573d4e541996bdce9f61807982de80f42f6be","modified":1743031374719},{"_id":"public/CNAME","hash":"a26573d4e541996bdce9f61807982de80f42f6be","modified":1743031404111},{"_id":"source/about-me/icons-github.png","hash":"cd2e944cfa9e7491e1ef63f23acd8ad97be627ab","modified":1743275134590},{"_id":"source/about-me/icons-linkedin.png","hash":"04547c6e70ca876a8d10cfee2d45c93787c1f133","modified":1743275085950},{"_id":"source/about-me/icons-twitter.png","hash":"82ba7d7cefaa63d038bc0a21ff1e4ff594a52059","modified":1743276816029},{"_id":"source/about-me/avatar_image.png","hash":"382af63d89311eee3c219b13ce7286966b93b2ef","modified":1743274861799},{"_id":"public/about-me/icons-github.png","hash":"cd2e944cfa9e7491e1ef63f23acd8ad97be627ab","modified":1743275158912},{"_id":"public/about-me/icons-linkedin.png","hash":"04547c6e70ca876a8d10cfee2d45c93787c1f133","modified":1743275158912},{"_id":"public/about-me/icons-twitter.png","hash":"82ba7d7cefaa63d038bc0a21ff1e4ff594a52059","modified":1743277572730},{"_id":"public/about-me/avatar_image.png","hash":"382af63d89311eee3c219b13ce7286966b93b2ef","modified":1743275158912},{"_id":"source/index.md","hash":"b37518da6ffc6f0fa632d87673d93fee0930950d","modified":1756777663506},{"_id":"public/writing/index.html","hash":"47c74d53c237a42329885fd3fd91c28baaffd6e5","modified":1751749289430},{"_id":"public/writing/page/2/index.html","hash":"8285dfda1c510999b6fda47396e4e11ef750ad5e","modified":1748462468559},{"_id":"public/writing/page/3/index.html","hash":"c80d93e431af1b37f429465337d347e89ceffb78","modified":1751749289430},{"_id":"public/writing/page/4/index.html","hash":"0daa32a3336bdd3cbdb7556ccb23bd059bfe287d","modified":1751749289430},{"_id":"public/writing/page/5/index.html","hash":"475007803558c7ffb1964d66824f035942143d74","modified":1751749289430},{"_id":"source/_posts/swe-meme.md","hash":"6c4454ee3389edfe068fc53e41b507c7cdb26fd2","modified":1743989556345},{"_id":"public/2025/04/06/swe-meme/index.html","hash":"a7d2333d2c89be78105c206e6f7ae2e37ecedf19","modified":1748462468559},{"_id":"public/archives/2025/index.html","hash":"bde84439846cdfd4dfdd9995a20dc63f43b4ddc1","modified":1751749289430},{"_id":"public/archives/2025/04/index.html","hash":"f23e8ff35c6a2219af9ff4b1ac70839cfa70aac7","modified":1743989569755},{"_id":"source/_posts/如何通过一次实习获得转正？方法论层面的剖析.md","hash":"d5b7a592f8d9723bac24ebea44a312d5d592cd09","modified":1751749277736},{"_id":"source/_posts/辛苦遭逢起一经-，十年学生生涯回顾与未来的展望.md","hash":"764f3d966d4c458042deb68a568d61065e507c8b","modified":1748462429823},{"_id":"public/2025/05/28/如何通过一次实习获得转正？方法论层面的剖析/index.html","hash":"7dd94acfd73d1b1edf05dc46484727c6c86d946a","modified":1751749289430},{"_id":"public/2025/05/28/辛苦遭逢起一经-，十年学生生涯回顾与未来的展望/index.html","hash":"a88e6044b2ebe0a4aa7f3e1c366cbbd1555849fd","modified":1748462468559},{"_id":"public/archives/page/6/index.html","hash":"3664cd4b5e6bbc7f5d982689597fa805728c5d30","modified":1748462468559},{"_id":"public/archives/2025/05/index.html","hash":"2f417f384f6481a6d44242173bd63e45ee5e95fa","modified":1751749289430},{"_id":"public/writing/page/6/index.html","hash":"148dacd38c3a7aa783ac6ed611bd9f7948fe54cf","modified":1748462468559}],"Category":[],"Data":[],"Page":[{"title":"Search","type":"search","_content":"","source":"search/index.md","raw":"---\ntitle: Search\ntype: search\n---\n","date":"2022-11-13T09:36:42.331Z","updated":"2022-11-13T09:36:42.311Z","path":"search/index.html","comments":1,"layout":"page","_id":"clepqbq9p0002b9c9gw016l1q","content":"","site":{"data":{}},"excerpt":"","more":""},{"layout":"false","_content":"\n\n<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\n\n    <meta itemprop=\"description\" name=\"description\" content=\"在线解析和生成括号法表示的树\"/>\n    <meta itemprop=\"name\" content=\"Look-tree\"/>\n    <meta id=\"image\" itemprop=\"image\" content=\"https://ftp.bmp.ovh/imgs/2021/04/c5243f3db403052f.png\"/>\n\n    <title>look-Tree</title>\n\n    <link rel=\"shortcut icon\" href=\"../img/favicon.ico\">\n    <!-- <script src=\"../js/jquery-3.4.1.js\"></script> -->\n    <script src=\"https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js\"></script>\n    <!-- <link href=\"../css/but.css\" rel=\"stylesheet\" type=\"text/css\"/> -->\n    <style>\n        #topbox{\n            box-shadow: 2px 2px 2px 2px rgba(0,0,0,0.1);\n            cursor:pointer;\n            background-color: rgba(0,0,100,0.05);\n            width: 600px;padding: 30px;\n            border-radius: 50px;\n            margin: 0 auto;\n        }\n        #topbox:hover{\n            background-color: rgba(0,100,100,0.06);\n        }\n    </style>\n</head>\n\n<body>\n\n<div style=\"text-align: center\">\n    <hr style=\"color: grey\">\n    <div id=\"topbox\" onclick=\"rand()\">\n        <h1 onclick=\"rand()\" style=\"cursor:pointer;color: black\">Click here！</h1>\n        <h5 onclick=\"rand()\" id=\"tit\" style=\"cursor:pointer;\">Designed by lhz in TUST 2021</h5><br>\n    </div>\n    <SCRIPT>\n        add(1);\n        function add(n){\n            $(\"#tit\").empty();\n            if(n%3==1){\n                $(\"#tit\").text(\"Click here to generate a random parenthesis expression！\");\n            }else if(n%3==2){\n                $(\"#tit\").text(\"Designed by lhz in TUST 2021 \");\n            }\n            else{\n                $(\"#tit\").text(\"look-tree Beta v0.2. If you find a bug,contact the webmaster. Email：1049838691@qq.com\");\n            }\n\n            setTimeout(function () {\n                add(n+1)\n            }, 10000);\n        }\n    </SCRIPT>\n    <br><input type=\"text\" id=\"tree-str\" style=\"width: 700px;height: 30px\" placeholder=\"Enter the expression for the tree here, and make sure that each node has a unique value\"/>\n    <button onclick=\"draw()\">Draw</button><br><br>\n\n    <canvas style=\"width: 1200px;height: 2000px;background-color:rgba(178,200,187,0.2);position: relative\" id=\"map\">\n\n    </canvas>\n    <p id=\"bb\" style=\"color: green\">站长统计，网站访问量：</p>\n    <!-- <script>\n        $.post({\n            url:'/getcon',\n            success:function (data){\n                $('#bb').empty();\n                $('#bb').text(\"站长统计，网站总访问量:\"+data);\n            }\n        })\n    </script> -->\n</div>\n<script>\n    var nodesXY=[]\n    var lines=[]\n    function draw(){\n        //numForEachDeep=[]\n        nodesXY=[]\n        lines=[]\n        nodeInEachDeep=[]\n        var root=treeStr();\n\n        dfsTree(root);\n\n        for(var i=0;i<nodeInEachDeep.length;i++) {\n            var s=''\n            for (var j = 0; j < nodeInEachDeep[i].length; j++) {\n                s += nodeInEachDeep[i][j].num + \" \";\n            }\n            console.log(s)\n        }\n        console.log(\"================================\")\n\n        var node=new Object();\n        node.num=nodeInEachDeep[0][0].num;\n        node.x=600;//此处先确定其中心位置\n        node.y=100;\n        node.childnum=nodeInEachDeep[0][0].childs.length\n        nodesXY.push(node)\n\n\n        var max=25;//能容纳的最大半径 ，会在后期更改\n        var kx=5;//空隙大小\n        for(var i=1;i<nodeInEachDeep.length;i++){//从第二层开始计算\n\n            var s='';\n            var binX=0;//记录当前层的开始位置\n            for(var j=0;j<nodeInEachDeep[i].length;j++){\n                s+=nodeInEachDeep[i][j].num+\" \";\n\n                var preX=0;\n                var preY=0;\n                var childnum=0;\n                for(var k=0;k<nodesXY.length;k++){\n                    if(nodeInEachDeep[i][j].pre.num===nodesXY[k].num){\n                        preX=nodesXY[k].x;\n                        preY=nodesXY[k].y;\n                    }\n                }\n                childnum=nodeInEachDeep[i][j].pre.childs.length;\n                console.log(\"preX:\"+preX)\n\n\n                var conpre=preX\n                while (preX-childnum*(max+kx/2) < binX){\n                    preX++;\n                }\n                //if(preX-childnum*(max+kx/2) < binX)\n\n                for(var k=0;k<childnum;k++){\n\n                    var node=new Object();\n                    node.num=nodeInEachDeep[i][j+k].num;\n                    node.y=preY+100;\n                    node.x=preX-childnum*(max+kx/2)+k*(max*2+kx)+max+kx/2;\n                    console.log(node.num+\"开始位置：\"+node.x)\n                    nodesXY.push(node);\n\n\n                    //记录线的位置\n                    var l=new Object();\n                    l.bx=conpre;\n                    l.by=preY+max;\n                    l.ex=node.x;\n                    l.ey=node.y-max;\n                    lines.push(l)\n\n\n                }\n                binX=nodesXY[nodesXY.length-1].x+max+kx;//更新当前层的最后一个点的位置\n                j+=childnum-1;\n\n            }\n            console.log(s)\n        }\n\n\n        //拿到画布\n        var canvas = document.getElementById('map');\n        canvas.width=1200;\n        canvas.height=2000;\n        var context = canvas.getContext(\"2d\");\n\n        for(var i=0;i<nodesXY.length;i++){\n            console.log(nodesXY[i].num)\n            drewTextInRound(nodesXY[i].x,nodesXY[i].y,max,nodesXY[i].num,context)\n        }\n        for(var i=0;i<lines.length;i++){\n            drewLine(lines[i].bx,lines[i].by,lines[i].ex,lines[i].ey,context)\n\n        }\n\n\n    }\n\n\n    //将字符串转化为树\n    function treeStr() {\n\n        //此处设定最外层没有括号！！！\n\n        var str=$(\"#tree-str\").val();\n\n        if(str[0]==='('){\n            str=str.slice(1,str.length-1)\n        }\n        console.log(str)\n        var stack = [];//栈\n        var deep=1;//记录当前节点深度\n        var root=new Object();//保存根节点\n\n        for(var i=0;i<str.length;i++){\n\n            var node=new Object();\n            if(str[i]===' '){\n                continue;\n            }\n            if(str[i]==='('){//遇到括号，把前一个元素入栈，作为父亲\n\n                //\n                var s=cutstr(str,i,1);//向后找到当前节点的内容\n                //console.log(s+\"   !!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                if(deep===1){//表示为首节点\n                    root=node;\n                    deep++;\n                    node.childs=[];//空\n                    node.pre=stack[stack.length-1];//栈顶元素为父元素\n                    stack.push(node);//入栈，表示一个root\n                    continue;\n                }\n                deep++;\n                node.childs=[];//空\n                node.pre=stack[stack.length-1];//栈顶元素为父元素\n                stack[stack.length-1].childs.push(node);\n                stack.push(node);//入栈，表示一个root\n            }\n            else if(str[i]===')'){\n                stack.pop();//表示上一个节点点所有字节点已经全部完毕，出栈\n                deep--;\n            }\n            else if(str[i]===','){//无效，跳过\n                continue;\n            }\n            else{//字符节点\n\n                //统计当前层有几个节点\n                // if(numForEachDeep.length<deep){\n                //     numForEachDeep.push(1)\n                // }\n                // else{\n                //     numForEachDeep[deep-1]++;\n                // }\n\n\n                var s=cutstr(str,i,0);//向后找到当前节点的内容\n                //console.log(s)\n                i+=s.length-1;\n                //console.log(str[i]+\"!!!!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                node.childs=[]\n                node.pre=null;\n                if(deep===1){//根节点,不是孩子，不处理\n\n                }\n                else if(str[i+1]!='('){//子节点，设置信息;且不是一个跟节点\n                    node.pre=stack[stack.length-1];\n                    stack[stack.length-1].childs.push(node);\n                    console.log(\"当前节点为：\"+node.num+\",当前节点的父亲为：\"+node.pre.num+\",父亲节点的子孩子数量为：\"+node.pre.childs.length)\n\n                }\n\n            }\n        }\n\n        return root;\n    }\n\n    //切出整个字符串\n    function cutstr(str,i,key) {\n        if(key===1) {//向前切\n            for(var j=i-1;j>=0;j--){\n                if(str[j]===',' || str[j]==='('){\n                    return str.slice(j+1,i)\n                }\n                if(j===0 ){\n                    return str.slice(j,i)\n                }\n            }\n\n        }\n        else{//向后切\n            for(var j=i;j<str.length;j++){\n                if(str[j]===',' || str[j]===')' || str[j]==='(') {\n\n                    return str.slice(i, j)\n                }\n            }\n        }\n\n    }\n\n\n    var nodeInEachDeep=[]//顺序储存每一层的节点，方便后边一层一层画\n    //计算节点参数\n    function dfsTree(node) {\n        var deep=node.deep;\n        if(nodeInEachDeep.length<deep){\n            nodeInEachDeep.push([]);\n            nodeInEachDeep[deep-1].push(node);\n        }\n        else{\n            nodeInEachDeep[deep-1].push(node);\n        }\n\n        if(node.pre!=undefined)\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+node.pre.num+\",当前节点的孩子数量为：\"+node.childs.length)\n        else\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+\"null\"+\",当前节点的孩子数量为：\"+node.childs.length)\n\n        for(var i=0;i<node.childs.length;i++){\n            console.log(\"节点\"+node.num+\":\")\n            dfsTree(node.childs[i]);\n        }\n    }\n</script>\n\n<script>\n    function drewTextInRound(x,y,r,text,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'black';\n        // 设置线条的宽度\n        context.lineWidth = 2;\n\n\n\n        // 绘制直线\n        context.beginPath();\n        context.arc(x, y, r, 0, Math.PI * 2, false);\n\n        var w=1000;\n        var fontsize=300;\n        while(w>(2*r-r) || fontsize>(2*r-r)) {\n            context.font = fontsize+'px \"微软雅黑\"';\n            context.fillStyle = \"black\";\n            context.textBaseline = \"middle\";\n            w = context.measureText(text).width;\n            fontsize--;\n        }\n        console.log(\"字体大小：\"+fontsize+\"px\")\n\n\n        //console.log(\"宽度：\"+w+\",高度：\"+h)\n        context.fillText(text, x-(w/2),y);\n\n\n        context.closePath();\n        context.stroke();\n    }\n    function drewLine(bx,by,ex,ey,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'red';\n        // 设置线条的宽度\n        context.lineWidth = 1;\n\n        // 绘制直线\n        context.beginPath();\n        context.moveTo (bx,by);\n        context.lineTo (ex,ey);       //设置末端状态\n\n        context.closePath();\n        context.stroke();\n    }\n</script>\n\n\n<script>\n\n    function rand(){\n\n        var key=1;\n        var con=1;\n        var str=key+'(';\n\n        var i=1;\n        while(con!=0){\n\n            if(i>30){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                for(var j=0;j<con;j++){\n                    str+=')';\n                }\n                break;\n            }\n            var n=Math.ceil(Math.random()*10);\n            if(n>9){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                con--;\n\n            }\n            else if (n>3){//➕数字\n                key++;\n\n                if(str[str.length-1]!='(')\n                    str+=',';\n                str+=key;\n            }\n            else{\n                if(str[str.length-1]==='(' || str[str.length-1]===')'){\n                    continue\n                }\n                str+='(';\n                con++;\n            }\n            i++;\n        }\n        $(\"#tree-str\").val(str);\n\n    }\n</script>\n\n</body>\n\n</html>","source":"tree/index.html","raw":"---\nlayout: false\n---\n\n\n<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\n\n    <meta itemprop=\"description\" name=\"description\" content=\"在线解析和生成括号法表示的树\"/>\n    <meta itemprop=\"name\" content=\"Look-tree\"/>\n    <meta id=\"image\" itemprop=\"image\" content=\"https://ftp.bmp.ovh/imgs/2021/04/c5243f3db403052f.png\"/>\n\n    <title>look-Tree</title>\n\n    <link rel=\"shortcut icon\" href=\"../img/favicon.ico\">\n    <!-- <script src=\"../js/jquery-3.4.1.js\"></script> -->\n    <script src=\"https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js\"></script>\n    <!-- <link href=\"../css/but.css\" rel=\"stylesheet\" type=\"text/css\"/> -->\n    <style>\n        #topbox{\n            box-shadow: 2px 2px 2px 2px rgba(0,0,0,0.1);\n            cursor:pointer;\n            background-color: rgba(0,0,100,0.05);\n            width: 600px;padding: 30px;\n            border-radius: 50px;\n            margin: 0 auto;\n        }\n        #topbox:hover{\n            background-color: rgba(0,100,100,0.06);\n        }\n    </style>\n</head>\n\n<body>\n\n<div style=\"text-align: center\">\n    <hr style=\"color: grey\">\n    <div id=\"topbox\" onclick=\"rand()\">\n        <h1 onclick=\"rand()\" style=\"cursor:pointer;color: black\">Click here！</h1>\n        <h5 onclick=\"rand()\" id=\"tit\" style=\"cursor:pointer;\">Designed by lhz in TUST 2021</h5><br>\n    </div>\n    <SCRIPT>\n        add(1);\n        function add(n){\n            $(\"#tit\").empty();\n            if(n%3==1){\n                $(\"#tit\").text(\"Click here to generate a random parenthesis expression！\");\n            }else if(n%3==2){\n                $(\"#tit\").text(\"Designed by lhz in TUST 2021 \");\n            }\n            else{\n                $(\"#tit\").text(\"look-tree Beta v0.2. If you find a bug,contact the webmaster. Email：1049838691@qq.com\");\n            }\n\n            setTimeout(function () {\n                add(n+1)\n            }, 10000);\n        }\n    </SCRIPT>\n    <br><input type=\"text\" id=\"tree-str\" style=\"width: 700px;height: 30px\" placeholder=\"Enter the expression for the tree here, and make sure that each node has a unique value\"/>\n    <button onclick=\"draw()\">Draw</button><br><br>\n\n    <canvas style=\"width: 1200px;height: 2000px;background-color:rgba(178,200,187,0.2);position: relative\" id=\"map\">\n\n    </canvas>\n    <p id=\"bb\" style=\"color: green\">站长统计，网站访问量：</p>\n    <!-- <script>\n        $.post({\n            url:'/getcon',\n            success:function (data){\n                $('#bb').empty();\n                $('#bb').text(\"站长统计，网站总访问量:\"+data);\n            }\n        })\n    </script> -->\n</div>\n<script>\n    var nodesXY=[]\n    var lines=[]\n    function draw(){\n        //numForEachDeep=[]\n        nodesXY=[]\n        lines=[]\n        nodeInEachDeep=[]\n        var root=treeStr();\n\n        dfsTree(root);\n\n        for(var i=0;i<nodeInEachDeep.length;i++) {\n            var s=''\n            for (var j = 0; j < nodeInEachDeep[i].length; j++) {\n                s += nodeInEachDeep[i][j].num + \" \";\n            }\n            console.log(s)\n        }\n        console.log(\"================================\")\n\n        var node=new Object();\n        node.num=nodeInEachDeep[0][0].num;\n        node.x=600;//此处先确定其中心位置\n        node.y=100;\n        node.childnum=nodeInEachDeep[0][0].childs.length\n        nodesXY.push(node)\n\n\n        var max=25;//能容纳的最大半径 ，会在后期更改\n        var kx=5;//空隙大小\n        for(var i=1;i<nodeInEachDeep.length;i++){//从第二层开始计算\n\n            var s='';\n            var binX=0;//记录当前层的开始位置\n            for(var j=0;j<nodeInEachDeep[i].length;j++){\n                s+=nodeInEachDeep[i][j].num+\" \";\n\n                var preX=0;\n                var preY=0;\n                var childnum=0;\n                for(var k=0;k<nodesXY.length;k++){\n                    if(nodeInEachDeep[i][j].pre.num===nodesXY[k].num){\n                        preX=nodesXY[k].x;\n                        preY=nodesXY[k].y;\n                    }\n                }\n                childnum=nodeInEachDeep[i][j].pre.childs.length;\n                console.log(\"preX:\"+preX)\n\n\n                var conpre=preX\n                while (preX-childnum*(max+kx/2) < binX){\n                    preX++;\n                }\n                //if(preX-childnum*(max+kx/2) < binX)\n\n                for(var k=0;k<childnum;k++){\n\n                    var node=new Object();\n                    node.num=nodeInEachDeep[i][j+k].num;\n                    node.y=preY+100;\n                    node.x=preX-childnum*(max+kx/2)+k*(max*2+kx)+max+kx/2;\n                    console.log(node.num+\"开始位置：\"+node.x)\n                    nodesXY.push(node);\n\n\n                    //记录线的位置\n                    var l=new Object();\n                    l.bx=conpre;\n                    l.by=preY+max;\n                    l.ex=node.x;\n                    l.ey=node.y-max;\n                    lines.push(l)\n\n\n                }\n                binX=nodesXY[nodesXY.length-1].x+max+kx;//更新当前层的最后一个点的位置\n                j+=childnum-1;\n\n            }\n            console.log(s)\n        }\n\n\n        //拿到画布\n        var canvas = document.getElementById('map');\n        canvas.width=1200;\n        canvas.height=2000;\n        var context = canvas.getContext(\"2d\");\n\n        for(var i=0;i<nodesXY.length;i++){\n            console.log(nodesXY[i].num)\n            drewTextInRound(nodesXY[i].x,nodesXY[i].y,max,nodesXY[i].num,context)\n        }\n        for(var i=0;i<lines.length;i++){\n            drewLine(lines[i].bx,lines[i].by,lines[i].ex,lines[i].ey,context)\n\n        }\n\n\n    }\n\n\n    //将字符串转化为树\n    function treeStr() {\n\n        //此处设定最外层没有括号！！！\n\n        var str=$(\"#tree-str\").val();\n\n        if(str[0]==='('){\n            str=str.slice(1,str.length-1)\n        }\n        console.log(str)\n        var stack = [];//栈\n        var deep=1;//记录当前节点深度\n        var root=new Object();//保存根节点\n\n        for(var i=0;i<str.length;i++){\n\n            var node=new Object();\n            if(str[i]===' '){\n                continue;\n            }\n            if(str[i]==='('){//遇到括号，把前一个元素入栈，作为父亲\n\n                //\n                var s=cutstr(str,i,1);//向后找到当前节点的内容\n                //console.log(s+\"   !!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                if(deep===1){//表示为首节点\n                    root=node;\n                    deep++;\n                    node.childs=[];//空\n                    node.pre=stack[stack.length-1];//栈顶元素为父元素\n                    stack.push(node);//入栈，表示一个root\n                    continue;\n                }\n                deep++;\n                node.childs=[];//空\n                node.pre=stack[stack.length-1];//栈顶元素为父元素\n                stack[stack.length-1].childs.push(node);\n                stack.push(node);//入栈，表示一个root\n            }\n            else if(str[i]===')'){\n                stack.pop();//表示上一个节点点所有字节点已经全部完毕，出栈\n                deep--;\n            }\n            else if(str[i]===','){//无效，跳过\n                continue;\n            }\n            else{//字符节点\n\n                //统计当前层有几个节点\n                // if(numForEachDeep.length<deep){\n                //     numForEachDeep.push(1)\n                // }\n                // else{\n                //     numForEachDeep[deep-1]++;\n                // }\n\n\n                var s=cutstr(str,i,0);//向后找到当前节点的内容\n                //console.log(s)\n                i+=s.length-1;\n                //console.log(str[i]+\"!!!!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                node.childs=[]\n                node.pre=null;\n                if(deep===1){//根节点,不是孩子，不处理\n\n                }\n                else if(str[i+1]!='('){//子节点，设置信息;且不是一个跟节点\n                    node.pre=stack[stack.length-1];\n                    stack[stack.length-1].childs.push(node);\n                    console.log(\"当前节点为：\"+node.num+\",当前节点的父亲为：\"+node.pre.num+\",父亲节点的子孩子数量为：\"+node.pre.childs.length)\n\n                }\n\n            }\n        }\n\n        return root;\n    }\n\n    //切出整个字符串\n    function cutstr(str,i,key) {\n        if(key===1) {//向前切\n            for(var j=i-1;j>=0;j--){\n                if(str[j]===',' || str[j]==='('){\n                    return str.slice(j+1,i)\n                }\n                if(j===0 ){\n                    return str.slice(j,i)\n                }\n            }\n\n        }\n        else{//向后切\n            for(var j=i;j<str.length;j++){\n                if(str[j]===',' || str[j]===')' || str[j]==='(') {\n\n                    return str.slice(i, j)\n                }\n            }\n        }\n\n    }\n\n\n    var nodeInEachDeep=[]//顺序储存每一层的节点，方便后边一层一层画\n    //计算节点参数\n    function dfsTree(node) {\n        var deep=node.deep;\n        if(nodeInEachDeep.length<deep){\n            nodeInEachDeep.push([]);\n            nodeInEachDeep[deep-1].push(node);\n        }\n        else{\n            nodeInEachDeep[deep-1].push(node);\n        }\n\n        if(node.pre!=undefined)\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+node.pre.num+\",当前节点的孩子数量为：\"+node.childs.length)\n        else\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+\"null\"+\",当前节点的孩子数量为：\"+node.childs.length)\n\n        for(var i=0;i<node.childs.length;i++){\n            console.log(\"节点\"+node.num+\":\")\n            dfsTree(node.childs[i]);\n        }\n    }\n</script>\n\n<script>\n    function drewTextInRound(x,y,r,text,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'black';\n        // 设置线条的宽度\n        context.lineWidth = 2;\n\n\n\n        // 绘制直线\n        context.beginPath();\n        context.arc(x, y, r, 0, Math.PI * 2, false);\n\n        var w=1000;\n        var fontsize=300;\n        while(w>(2*r-r) || fontsize>(2*r-r)) {\n            context.font = fontsize+'px \"微软雅黑\"';\n            context.fillStyle = \"black\";\n            context.textBaseline = \"middle\";\n            w = context.measureText(text).width;\n            fontsize--;\n        }\n        console.log(\"字体大小：\"+fontsize+\"px\")\n\n\n        //console.log(\"宽度：\"+w+\",高度：\"+h)\n        context.fillText(text, x-(w/2),y);\n\n\n        context.closePath();\n        context.stroke();\n    }\n    function drewLine(bx,by,ex,ey,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'red';\n        // 设置线条的宽度\n        context.lineWidth = 1;\n\n        // 绘制直线\n        context.beginPath();\n        context.moveTo (bx,by);\n        context.lineTo (ex,ey);       //设置末端状态\n\n        context.closePath();\n        context.stroke();\n    }\n</script>\n\n\n<script>\n\n    function rand(){\n\n        var key=1;\n        var con=1;\n        var str=key+'(';\n\n        var i=1;\n        while(con!=0){\n\n            if(i>30){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                for(var j=0;j<con;j++){\n                    str+=')';\n                }\n                break;\n            }\n            var n=Math.ceil(Math.random()*10);\n            if(n>9){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                con--;\n\n            }\n            else if (n>3){//➕数字\n                key++;\n\n                if(str[str.length-1]!='(')\n                    str+=',';\n                str+=key;\n            }\n            else{\n                if(str[str.length-1]==='(' || str[str.length-1]===')'){\n                    continue\n                }\n                str+='(';\n                con++;\n            }\n            i++;\n        }\n        $(\"#tree-str\").val(str);\n\n    }\n</script>\n\n</body>\n\n</html>","date":"2023-02-15T09:51:17.701Z","updated":"2022-11-22T11:33:38.376Z","path":"tree/index.html","title":"","comments":1,"_id":"clepqbq9s0005b9c9a0pr8xdq","content":"\n\n<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\n\n    <meta itemprop=\"description\" name=\"description\" content=\"在线解析和生成括号法表示的树\"/>\n    <meta itemprop=\"name\" content=\"Look-tree\"/>\n    <meta id=\"image\" itemprop=\"image\" content=\"https://ftp.bmp.ovh/imgs/2021/04/c5243f3db403052f.png\"/>\n\n    <title>look-Tree</title>\n\n    <link rel=\"shortcut icon\" href=\"../img/favicon.ico\">\n    <!-- <script src=\"../js/jquery-3.4.1.js\"></script> -->\n    <script src=\"https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js\"></script>\n    <!-- <link href=\"../css/but.css\" rel=\"stylesheet\" type=\"text/css\"/> -->\n    <style>\n        #topbox{\n            box-shadow: 2px 2px 2px 2px rgba(0,0,0,0.1);\n            cursor:pointer;\n            background-color: rgba(0,0,100,0.05);\n            width: 600px;padding: 30px;\n            border-radius: 50px;\n            margin: 0 auto;\n        }\n        #topbox:hover{\n            background-color: rgba(0,100,100,0.06);\n        }\n    </style>\n</head>\n\n<body>\n\n<div style=\"text-align: center\">\n    <hr style=\"color: grey\">\n    <div id=\"topbox\" onclick=\"rand()\">\n        <h1 onclick=\"rand()\" style=\"cursor:pointer;color: black\">Click here！</h1>\n        <h5 onclick=\"rand()\" id=\"tit\" style=\"cursor:pointer;\">Designed by lhz in TUST 2021</h5><br>\n    </div>\n    <SCRIPT>\n        add(1);\n        function add(n){\n            $(\"#tit\").empty();\n            if(n%3==1){\n                $(\"#tit\").text(\"Click here to generate a random parenthesis expression！\");\n            }else if(n%3==2){\n                $(\"#tit\").text(\"Designed by lhz in TUST 2021 \");\n            }\n            else{\n                $(\"#tit\").text(\"look-tree Beta v0.2. If you find a bug,contact the webmaster. Email：1049838691@qq.com\");\n            }\n\n            setTimeout(function () {\n                add(n+1)\n            }, 10000);\n        }\n    </SCRIPT>\n    <br><input type=\"text\" id=\"tree-str\" style=\"width: 700px;height: 30px\" placeholder=\"Enter the expression for the tree here, and make sure that each node has a unique value\"/>\n    <button onclick=\"draw()\">Draw</button><br><br>\n\n    <canvas style=\"width: 1200px;height: 2000px;background-color:rgba(178,200,187,0.2);position: relative\" id=\"map\">\n\n    </canvas>\n    <p id=\"bb\" style=\"color: green\">站长统计，网站访问量：</p>\n    <!-- <script>\n        $.post({\n            url:'/getcon',\n            success:function (data){\n                $('#bb').empty();\n                $('#bb').text(\"站长统计，网站总访问量:\"+data);\n            }\n        })\n    </script> -->\n</div>\n<script>\n    var nodesXY=[]\n    var lines=[]\n    function draw(){\n        //numForEachDeep=[]\n        nodesXY=[]\n        lines=[]\n        nodeInEachDeep=[]\n        var root=treeStr();\n\n        dfsTree(root);\n\n        for(var i=0;i<nodeInEachDeep.length;i++) {\n            var s=''\n            for (var j = 0; j < nodeInEachDeep[i].length; j++) {\n                s += nodeInEachDeep[i][j].num + \" \";\n            }\n            console.log(s)\n        }\n        console.log(\"================================\")\n\n        var node=new Object();\n        node.num=nodeInEachDeep[0][0].num;\n        node.x=600;//此处先确定其中心位置\n        node.y=100;\n        node.childnum=nodeInEachDeep[0][0].childs.length\n        nodesXY.push(node)\n\n\n        var max=25;//能容纳的最大半径 ，会在后期更改\n        var kx=5;//空隙大小\n        for(var i=1;i<nodeInEachDeep.length;i++){//从第二层开始计算\n\n            var s='';\n            var binX=0;//记录当前层的开始位置\n            for(var j=0;j<nodeInEachDeep[i].length;j++){\n                s+=nodeInEachDeep[i][j].num+\" \";\n\n                var preX=0;\n                var preY=0;\n                var childnum=0;\n                for(var k=0;k<nodesXY.length;k++){\n                    if(nodeInEachDeep[i][j].pre.num===nodesXY[k].num){\n                        preX=nodesXY[k].x;\n                        preY=nodesXY[k].y;\n                    }\n                }\n                childnum=nodeInEachDeep[i][j].pre.childs.length;\n                console.log(\"preX:\"+preX)\n\n\n                var conpre=preX\n                while (preX-childnum*(max+kx/2) < binX){\n                    preX++;\n                }\n                //if(preX-childnum*(max+kx/2) < binX)\n\n                for(var k=0;k<childnum;k++){\n\n                    var node=new Object();\n                    node.num=nodeInEachDeep[i][j+k].num;\n                    node.y=preY+100;\n                    node.x=preX-childnum*(max+kx/2)+k*(max*2+kx)+max+kx/2;\n                    console.log(node.num+\"开始位置：\"+node.x)\n                    nodesXY.push(node);\n\n\n                    //记录线的位置\n                    var l=new Object();\n                    l.bx=conpre;\n                    l.by=preY+max;\n                    l.ex=node.x;\n                    l.ey=node.y-max;\n                    lines.push(l)\n\n\n                }\n                binX=nodesXY[nodesXY.length-1].x+max+kx;//更新当前层的最后一个点的位置\n                j+=childnum-1;\n\n            }\n            console.log(s)\n        }\n\n\n        //拿到画布\n        var canvas = document.getElementById('map');\n        canvas.width=1200;\n        canvas.height=2000;\n        var context = canvas.getContext(\"2d\");\n\n        for(var i=0;i<nodesXY.length;i++){\n            console.log(nodesXY[i].num)\n            drewTextInRound(nodesXY[i].x,nodesXY[i].y,max,nodesXY[i].num,context)\n        }\n        for(var i=0;i<lines.length;i++){\n            drewLine(lines[i].bx,lines[i].by,lines[i].ex,lines[i].ey,context)\n\n        }\n\n\n    }\n\n\n    //将字符串转化为树\n    function treeStr() {\n\n        //此处设定最外层没有括号！！！\n\n        var str=$(\"#tree-str\").val();\n\n        if(str[0]==='('){\n            str=str.slice(1,str.length-1)\n        }\n        console.log(str)\n        var stack = [];//栈\n        var deep=1;//记录当前节点深度\n        var root=new Object();//保存根节点\n\n        for(var i=0;i<str.length;i++){\n\n            var node=new Object();\n            if(str[i]===' '){\n                continue;\n            }\n            if(str[i]==='('){//遇到括号，把前一个元素入栈，作为父亲\n\n                //\n                var s=cutstr(str,i,1);//向后找到当前节点的内容\n                //console.log(s+\"   !!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                if(deep===1){//表示为首节点\n                    root=node;\n                    deep++;\n                    node.childs=[];//空\n                    node.pre=stack[stack.length-1];//栈顶元素为父元素\n                    stack.push(node);//入栈，表示一个root\n                    continue;\n                }\n                deep++;\n                node.childs=[];//空\n                node.pre=stack[stack.length-1];//栈顶元素为父元素\n                stack[stack.length-1].childs.push(node);\n                stack.push(node);//入栈，表示一个root\n            }\n            else if(str[i]===')'){\n                stack.pop();//表示上一个节点点所有字节点已经全部完毕，出栈\n                deep--;\n            }\n            else if(str[i]===','){//无效，跳过\n                continue;\n            }\n            else{//字符节点\n\n                //统计当前层有几个节点\n                // if(numForEachDeep.length<deep){\n                //     numForEachDeep.push(1)\n                // }\n                // else{\n                //     numForEachDeep[deep-1]++;\n                // }\n\n\n                var s=cutstr(str,i,0);//向后找到当前节点的内容\n                //console.log(s)\n                i+=s.length-1;\n                //console.log(str[i]+\"!!!!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                node.childs=[]\n                node.pre=null;\n                if(deep===1){//根节点,不是孩子，不处理\n\n                }\n                else if(str[i+1]!='('){//子节点，设置信息;且不是一个跟节点\n                    node.pre=stack[stack.length-1];\n                    stack[stack.length-1].childs.push(node);\n                    console.log(\"当前节点为：\"+node.num+\",当前节点的父亲为：\"+node.pre.num+\",父亲节点的子孩子数量为：\"+node.pre.childs.length)\n\n                }\n\n            }\n        }\n\n        return root;\n    }\n\n    //切出整个字符串\n    function cutstr(str,i,key) {\n        if(key===1) {//向前切\n            for(var j=i-1;j>=0;j--){\n                if(str[j]===',' || str[j]==='('){\n                    return str.slice(j+1,i)\n                }\n                if(j===0 ){\n                    return str.slice(j,i)\n                }\n            }\n\n        }\n        else{//向后切\n            for(var j=i;j<str.length;j++){\n                if(str[j]===',' || str[j]===')' || str[j]==='(') {\n\n                    return str.slice(i, j)\n                }\n            }\n        }\n\n    }\n\n\n    var nodeInEachDeep=[]//顺序储存每一层的节点，方便后边一层一层画\n    //计算节点参数\n    function dfsTree(node) {\n        var deep=node.deep;\n        if(nodeInEachDeep.length<deep){\n            nodeInEachDeep.push([]);\n            nodeInEachDeep[deep-1].push(node);\n        }\n        else{\n            nodeInEachDeep[deep-1].push(node);\n        }\n\n        if(node.pre!=undefined)\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+node.pre.num+\",当前节点的孩子数量为：\"+node.childs.length)\n        else\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+\"null\"+\",当前节点的孩子数量为：\"+node.childs.length)\n\n        for(var i=0;i<node.childs.length;i++){\n            console.log(\"节点\"+node.num+\":\")\n            dfsTree(node.childs[i]);\n        }\n    }\n</script>\n\n<script>\n    function drewTextInRound(x,y,r,text,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'black';\n        // 设置线条的宽度\n        context.lineWidth = 2;\n\n\n\n        // 绘制直线\n        context.beginPath();\n        context.arc(x, y, r, 0, Math.PI * 2, false);\n\n        var w=1000;\n        var fontsize=300;\n        while(w>(2*r-r) || fontsize>(2*r-r)) {\n            context.font = fontsize+'px \"微软雅黑\"';\n            context.fillStyle = \"black\";\n            context.textBaseline = \"middle\";\n            w = context.measureText(text).width;\n            fontsize--;\n        }\n        console.log(\"字体大小：\"+fontsize+\"px\")\n\n\n        //console.log(\"宽度：\"+w+\",高度：\"+h)\n        context.fillText(text, x-(w/2),y);\n\n\n        context.closePath();\n        context.stroke();\n    }\n    function drewLine(bx,by,ex,ey,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'red';\n        // 设置线条的宽度\n        context.lineWidth = 1;\n\n        // 绘制直线\n        context.beginPath();\n        context.moveTo (bx,by);\n        context.lineTo (ex,ey);       //设置末端状态\n\n        context.closePath();\n        context.stroke();\n    }\n</script>\n\n\n<script>\n\n    function rand(){\n\n        var key=1;\n        var con=1;\n        var str=key+'(';\n\n        var i=1;\n        while(con!=0){\n\n            if(i>30){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                for(var j=0;j<con;j++){\n                    str+=')';\n                }\n                break;\n            }\n            var n=Math.ceil(Math.random()*10);\n            if(n>9){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                con--;\n\n            }\n            else if (n>3){//➕数字\n                key++;\n\n                if(str[str.length-1]!='(')\n                    str+=',';\n                str+=key;\n            }\n            else{\n                if(str[str.length-1]==='(' || str[str.length-1]===')'){\n                    continue\n                }\n                str+='(';\n                con++;\n            }\n            i++;\n        }\n        $(\"#tree-str\").val(str);\n\n    }\n</script>\n\n</body>\n\n</html>","site":{"data":{}},"excerpt":"","more":"\n\n<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\n\n    <meta itemprop=\"description\" name=\"description\" content=\"在线解析和生成括号法表示的树\"/>\n    <meta itemprop=\"name\" content=\"Look-tree\"/>\n    <meta id=\"image\" itemprop=\"image\" content=\"https://ftp.bmp.ovh/imgs/2021/04/c5243f3db403052f.png\"/>\n\n    <title>look-Tree</title>\n\n    <link rel=\"shortcut icon\" href=\"../img/favicon.ico\">\n    <!-- <script src=\"../js/jquery-3.4.1.js\"></script> -->\n    <script src=\"https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js\"></script>\n    <!-- <link href=\"../css/but.css\" rel=\"stylesheet\" type=\"text/css\"/> -->\n    <style>\n        #topbox{\n            box-shadow: 2px 2px 2px 2px rgba(0,0,0,0.1);\n            cursor:pointer;\n            background-color: rgba(0,0,100,0.05);\n            width: 600px;padding: 30px;\n            border-radius: 50px;\n            margin: 0 auto;\n        }\n        #topbox:hover{\n            background-color: rgba(0,100,100,0.06);\n        }\n    </style>\n</head>\n\n<body>\n\n<div style=\"text-align: center\">\n    <hr style=\"color: grey\">\n    <div id=\"topbox\" onclick=\"rand()\">\n        <h1 onclick=\"rand()\" style=\"cursor:pointer;color: black\">Click here！</h1>\n        <h5 onclick=\"rand()\" id=\"tit\" style=\"cursor:pointer;\">Designed by lhz in TUST 2021</h5><br>\n    </div>\n    <SCRIPT>\n        add(1);\n        function add(n){\n            $(\"#tit\").empty();\n            if(n%3==1){\n                $(\"#tit\").text(\"Click here to generate a random parenthesis expression！\");\n            }else if(n%3==2){\n                $(\"#tit\").text(\"Designed by lhz in TUST 2021 \");\n            }\n            else{\n                $(\"#tit\").text(\"look-tree Beta v0.2. If you find a bug,contact the webmaster. Email：1049838691@qq.com\");\n            }\n\n            setTimeout(function () {\n                add(n+1)\n            }, 10000);\n        }\n    </SCRIPT>\n    <br><input type=\"text\" id=\"tree-str\" style=\"width: 700px;height: 30px\" placeholder=\"Enter the expression for the tree here, and make sure that each node has a unique value\"/>\n    <button onclick=\"draw()\">Draw</button><br><br>\n\n    <canvas style=\"width: 1200px;height: 2000px;background-color:rgba(178,200,187,0.2);position: relative\" id=\"map\">\n\n    </canvas>\n    <p id=\"bb\" style=\"color: green\">站长统计，网站访问量：</p>\n    <!-- <script>\n        $.post({\n            url:'/getcon',\n            success:function (data){\n                $('#bb').empty();\n                $('#bb').text(\"站长统计，网站总访问量:\"+data);\n            }\n        })\n    </script> -->\n</div>\n<script>\n    var nodesXY=[]\n    var lines=[]\n    function draw(){\n        //numForEachDeep=[]\n        nodesXY=[]\n        lines=[]\n        nodeInEachDeep=[]\n        var root=treeStr();\n\n        dfsTree(root);\n\n        for(var i=0;i<nodeInEachDeep.length;i++) {\n            var s=''\n            for (var j = 0; j < nodeInEachDeep[i].length; j++) {\n                s += nodeInEachDeep[i][j].num + \" \";\n            }\n            console.log(s)\n        }\n        console.log(\"================================\")\n\n        var node=new Object();\n        node.num=nodeInEachDeep[0][0].num;\n        node.x=600;//此处先确定其中心位置\n        node.y=100;\n        node.childnum=nodeInEachDeep[0][0].childs.length\n        nodesXY.push(node)\n\n\n        var max=25;//能容纳的最大半径 ，会在后期更改\n        var kx=5;//空隙大小\n        for(var i=1;i<nodeInEachDeep.length;i++){//从第二层开始计算\n\n            var s='';\n            var binX=0;//记录当前层的开始位置\n            for(var j=0;j<nodeInEachDeep[i].length;j++){\n                s+=nodeInEachDeep[i][j].num+\" \";\n\n                var preX=0;\n                var preY=0;\n                var childnum=0;\n                for(var k=0;k<nodesXY.length;k++){\n                    if(nodeInEachDeep[i][j].pre.num===nodesXY[k].num){\n                        preX=nodesXY[k].x;\n                        preY=nodesXY[k].y;\n                    }\n                }\n                childnum=nodeInEachDeep[i][j].pre.childs.length;\n                console.log(\"preX:\"+preX)\n\n\n                var conpre=preX\n                while (preX-childnum*(max+kx/2) < binX){\n                    preX++;\n                }\n                //if(preX-childnum*(max+kx/2) < binX)\n\n                for(var k=0;k<childnum;k++){\n\n                    var node=new Object();\n                    node.num=nodeInEachDeep[i][j+k].num;\n                    node.y=preY+100;\n                    node.x=preX-childnum*(max+kx/2)+k*(max*2+kx)+max+kx/2;\n                    console.log(node.num+\"开始位置：\"+node.x)\n                    nodesXY.push(node);\n\n\n                    //记录线的位置\n                    var l=new Object();\n                    l.bx=conpre;\n                    l.by=preY+max;\n                    l.ex=node.x;\n                    l.ey=node.y-max;\n                    lines.push(l)\n\n\n                }\n                binX=nodesXY[nodesXY.length-1].x+max+kx;//更新当前层的最后一个点的位置\n                j+=childnum-1;\n\n            }\n            console.log(s)\n        }\n\n\n        //拿到画布\n        var canvas = document.getElementById('map');\n        canvas.width=1200;\n        canvas.height=2000;\n        var context = canvas.getContext(\"2d\");\n\n        for(var i=0;i<nodesXY.length;i++){\n            console.log(nodesXY[i].num)\n            drewTextInRound(nodesXY[i].x,nodesXY[i].y,max,nodesXY[i].num,context)\n        }\n        for(var i=0;i<lines.length;i++){\n            drewLine(lines[i].bx,lines[i].by,lines[i].ex,lines[i].ey,context)\n\n        }\n\n\n    }\n\n\n    //将字符串转化为树\n    function treeStr() {\n\n        //此处设定最外层没有括号！！！\n\n        var str=$(\"#tree-str\").val();\n\n        if(str[0]==='('){\n            str=str.slice(1,str.length-1)\n        }\n        console.log(str)\n        var stack = [];//栈\n        var deep=1;//记录当前节点深度\n        var root=new Object();//保存根节点\n\n        for(var i=0;i<str.length;i++){\n\n            var node=new Object();\n            if(str[i]===' '){\n                continue;\n            }\n            if(str[i]==='('){//遇到括号，把前一个元素入栈，作为父亲\n\n                //\n                var s=cutstr(str,i,1);//向后找到当前节点的内容\n                //console.log(s+\"   !!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                if(deep===1){//表示为首节点\n                    root=node;\n                    deep++;\n                    node.childs=[];//空\n                    node.pre=stack[stack.length-1];//栈顶元素为父元素\n                    stack.push(node);//入栈，表示一个root\n                    continue;\n                }\n                deep++;\n                node.childs=[];//空\n                node.pre=stack[stack.length-1];//栈顶元素为父元素\n                stack[stack.length-1].childs.push(node);\n                stack.push(node);//入栈，表示一个root\n            }\n            else if(str[i]===')'){\n                stack.pop();//表示上一个节点点所有字节点已经全部完毕，出栈\n                deep--;\n            }\n            else if(str[i]===','){//无效，跳过\n                continue;\n            }\n            else{//字符节点\n\n                //统计当前层有几个节点\n                // if(numForEachDeep.length<deep){\n                //     numForEachDeep.push(1)\n                // }\n                // else{\n                //     numForEachDeep[deep-1]++;\n                // }\n\n\n                var s=cutstr(str,i,0);//向后找到当前节点的内容\n                //console.log(s)\n                i+=s.length-1;\n                //console.log(str[i]+\"!!!!!!!!!!!!\")\n                node.num=s;\n                node.deep=deep;\n                node.childs=[]\n                node.pre=null;\n                if(deep===1){//根节点,不是孩子，不处理\n\n                }\n                else if(str[i+1]!='('){//子节点，设置信息;且不是一个跟节点\n                    node.pre=stack[stack.length-1];\n                    stack[stack.length-1].childs.push(node);\n                    console.log(\"当前节点为：\"+node.num+\",当前节点的父亲为：\"+node.pre.num+\",父亲节点的子孩子数量为：\"+node.pre.childs.length)\n\n                }\n\n            }\n        }\n\n        return root;\n    }\n\n    //切出整个字符串\n    function cutstr(str,i,key) {\n        if(key===1) {//向前切\n            for(var j=i-1;j>=0;j--){\n                if(str[j]===',' || str[j]==='('){\n                    return str.slice(j+1,i)\n                }\n                if(j===0 ){\n                    return str.slice(j,i)\n                }\n            }\n\n        }\n        else{//向后切\n            for(var j=i;j<str.length;j++){\n                if(str[j]===',' || str[j]===')' || str[j]==='(') {\n\n                    return str.slice(i, j)\n                }\n            }\n        }\n\n    }\n\n\n    var nodeInEachDeep=[]//顺序储存每一层的节点，方便后边一层一层画\n    //计算节点参数\n    function dfsTree(node) {\n        var deep=node.deep;\n        if(nodeInEachDeep.length<deep){\n            nodeInEachDeep.push([]);\n            nodeInEachDeep[deep-1].push(node);\n        }\n        else{\n            nodeInEachDeep[deep-1].push(node);\n        }\n\n        if(node.pre!=undefined)\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+node.pre.num+\",当前节点的孩子数量为：\"+node.childs.length)\n        else\n            console.log(\"当前节点为：\"+node.num+\"，当前节点的深度为：\"+node.deep+\",当前节点的父亲为：\"+\"null\"+\",当前节点的孩子数量为：\"+node.childs.length)\n\n        for(var i=0;i<node.childs.length;i++){\n            console.log(\"节点\"+node.num+\":\")\n            dfsTree(node.childs[i]);\n        }\n    }\n</script>\n\n<script>\n    function drewTextInRound(x,y,r,text,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'black';\n        // 设置线条的宽度\n        context.lineWidth = 2;\n\n\n\n        // 绘制直线\n        context.beginPath();\n        context.arc(x, y, r, 0, Math.PI * 2, false);\n\n        var w=1000;\n        var fontsize=300;\n        while(w>(2*r-r) || fontsize>(2*r-r)) {\n            context.font = fontsize+'px \"微软雅黑\"';\n            context.fillStyle = \"black\";\n            context.textBaseline = \"middle\";\n            w = context.measureText(text).width;\n            fontsize--;\n        }\n        console.log(\"字体大小：\"+fontsize+\"px\")\n\n\n        //console.log(\"宽度：\"+w+\",高度：\"+h)\n        context.fillText(text, x-(w/2),y);\n\n\n        context.closePath();\n        context.stroke();\n    }\n    function drewLine(bx,by,ex,ey,context){\n\n        // 设置线条的颜色\n        context.strokeStyle = 'red';\n        // 设置线条的宽度\n        context.lineWidth = 1;\n\n        // 绘制直线\n        context.beginPath();\n        context.moveTo (bx,by);\n        context.lineTo (ex,ey);       //设置末端状态\n\n        context.closePath();\n        context.stroke();\n    }\n</script>\n\n\n<script>\n\n    function rand(){\n\n        var key=1;\n        var con=1;\n        var str=key+'(';\n\n        var i=1;\n        while(con!=0){\n\n            if(i>30){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                for(var j=0;j<con;j++){\n                    str+=')';\n                }\n                break;\n            }\n            var n=Math.ceil(Math.random()*10);\n            if(n>9){\n                if(str[str.length-1]==='('){\n                    key++;\n                    str+=key;\n                }\n                str+=')';\n                con--;\n\n            }\n            else if (n>3){//➕数字\n                key++;\n\n                if(str[str.length-1]!='(')\n                    str+=',';\n                str+=key;\n            }\n            else{\n                if(str[str.length-1]==='(' || str[str.length-1]===')'){\n                    continue\n                }\n                str+='(';\n                con++;\n            }\n            i++;\n        }\n        $(\"#tree-str\").val(str);\n\n    }\n</script>\n\n</body>\n\n</html>"},{"layout":"page","title":"homepage","date":"2022-11-16T21:35:10.000Z","_content":"<br>\n<div align=\"center\">\n  <!-- Avatar Image (use a circular image file) -->\n  <img src=\"about-me/avatar_image.png\" alt=\"Avatar\" width=\"130\" height=\"130\" style=\"border-radius: 15px;\">\n</div>\n\n<div style=\"display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; border-radius: 8px;\">\n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-twitter.png\" alt=\"Twitter\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <!-- <a href=\"https://x.com/Hazel_1024201\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a> -->\n     <a href=\"https://x.com\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-linkedin.png\" alt=\"LinkedIn\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://www.linkedin.com/in/hzliu/\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">LinkedIn</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-github.png\" alt=\"GitHub\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://github.com/muchengl\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Github</a>\n  </div>\n</div>\n\n<div align=\"center\">\n  <!-- Self-introduction Area -->\n<p>\n    <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     Hello! I am Hanzhong Liu. Currently, I work on the Traffic Infrastructure team at LinkedIn 💻. My research interests include distributed system, LLM agents and Μεταφυσικά. \n    In my free time, I enjoy coding, spending time with cats 🐱, photography 📷, and outdoor activities like cycling and hiking 🥾.\n</p>\n\n---\n\n<p>\nMy research vision is to develop various \"platforms\" that encapsulate complex functionalities behind elegant and user-friendly interfaces, making them accessible to users worldwide. \n\nThis interest was inspired by my high school OI (Olympiad in Informatics) coach, Mr. Liu, who designed a highly intuitive online judge (OJ) system for us during my OI journey. I particularly admired this system for its clear pipeline: \"question\" → \"human brain\" → \"code\" → \"score.\" This was my first encounter with the concept of a \"platform.\" \n\nI consider search engines, big data frameworks such as Spark, cloud computing systems like AWS Lambda, and AI agents as examples of the \"platforms\" that I deeply admire.\n\nEven earlier, I enjoyed playing with LEGO bricks and Minecraft, and I believe computer systems share many similarities with LEGO|Minecraft at an abstract level—both involve building complex structures from simpler, modular components.\n<p>\n</div>\n\n<h1>Resume</h1>\n\n<h2>Education</h2>\n\n<div>\n    <strong>Texas A&M University</strong>\n    <span style=\"float: right;\">2023.09 - 2025.05</span><br>\n    Master's, Computer Science\n    <span style=\"float: right;\">Texas, USA</span><br><br>\n</div>\n\n<div>\n    <strong>Tianjin University of Science & Technology</strong>\n    <span style=\"float: right;\">2019.09 - 2023.06</span><br>\n    Bachelor's, Internet of Things Engineering<br><br>\n</div>\n\n<h2>Work Experiences</h2>\n\n<div>\n    <strong>LinkedIn</strong>\n    <span style=\"float: right;\">Sunnyvale, US</span><br>\n    Software Engineer, Systems Infrastructure\n    <span style=\"float: right;\">From 2025.07</span><br>\n    <span style=\"float: right;\"></span>\n    Software Engineer Intern – LiX Team\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br><br>\n</div>\n\n<!-- <div>\n    <strong>LinkedIn</strong> -->\n   \n<!-- </div> -->\n\n<div>\n    <strong>ByteDance</strong>\n    <span style=\"float: right;\">2023.04 - 2023.08</span><br>\n    Software Engineer Intern – Video Cloud Infrastructure\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>Amazon</strong>\n    <span style=\"float: right;\">2022.05 - 2022.09</span><br>\n    Software Development Engineer Intern – Device OS\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>HiRain Technologies</strong>\n    <span style=\"float: right;\">2021.07 - 2021.09</span><br>\n    Software Engineer Intern – AE New Energy Division\n    <span style=\"float: right;\">Tianjin, CN</span><br><br>\n</div>\n\n<h2>Research Projects</h2>\n\n<div>\n    <strong>Research on LLM Agent Systems</strong>\n    <span style=\"float: right;\">2024.08 - 2025.02</span><br>\n    - Built Workflow Retrieval & Execution Engine for LLM Agent<br>\n    - Researched programming languages for Multi-Agent programming<br><br>\n</div>\n\n<div>\n    <strong>SyntaxFlow</strong>\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br>\n    SyntaxFlow is a parallel code AST analysis framework which provides flow-style APIs such as <code>search()</code>, <code>map()</code>, <code>filter()</code>, <code>union()</code>, and <code>rewrite()</code> to generate a code process Directed Acyclic Graph (DAG).<br><br>\n</div>\n\n<div>\n    <strong>Research on Fast Startup of Serverless Service</strong>\n    <span style=\"float: right;\">2023.01 - 2023.08</span><br>\n    Introduced Postcopy into the Serverless FaaS platform based on WASM Runtime, achieving a high-speed cold startup mechanism for FaaS containers.<br><br>\n</div>\n\n<h2>Awards and Honors</h2>\n<ul>\n    <li>No Turing Award</li>\n</ul>\n\n<!-- <h2>Interests</h2>\n<ul>\n    <li>Coding 👩🏻‍💻</li>\n    <li>Cat lover 🐱</li>\n    <li>Photography 📷</li>\n    <li>Cycling & Hiking 🥾</li>\n</ul> -->\n","source":"index.md","raw":"---\nlayout: page\ntitle: homepage\ndate: 2022-11-16 13:35:10\n---\n<br>\n<div align=\"center\">\n  <!-- Avatar Image (use a circular image file) -->\n  <img src=\"about-me/avatar_image.png\" alt=\"Avatar\" width=\"130\" height=\"130\" style=\"border-radius: 15px;\">\n</div>\n\n<div style=\"display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; border-radius: 8px;\">\n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-twitter.png\" alt=\"Twitter\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <!-- <a href=\"https://x.com/Hazel_1024201\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a> -->\n     <a href=\"https://x.com\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-linkedin.png\" alt=\"LinkedIn\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://www.linkedin.com/in/hzliu/\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">LinkedIn</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-github.png\" alt=\"GitHub\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://github.com/muchengl\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Github</a>\n  </div>\n</div>\n\n<div align=\"center\">\n  <!-- Self-introduction Area -->\n<p>\n    <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     Hello! I am Hanzhong Liu. Currently, I work on the Traffic Infrastructure team at LinkedIn 💻. My research interests include distributed system, LLM agents and Μεταφυσικά. \n    In my free time, I enjoy coding, spending time with cats 🐱, photography 📷, and outdoor activities like cycling and hiking 🥾.\n</p>\n\n---\n\n<p>\nMy research vision is to develop various \"platforms\" that encapsulate complex functionalities behind elegant and user-friendly interfaces, making them accessible to users worldwide. \n\nThis interest was inspired by my high school OI (Olympiad in Informatics) coach, Mr. Liu, who designed a highly intuitive online judge (OJ) system for us during my OI journey. I particularly admired this system for its clear pipeline: \"question\" → \"human brain\" → \"code\" → \"score.\" This was my first encounter with the concept of a \"platform.\" \n\nI consider search engines, big data frameworks such as Spark, cloud computing systems like AWS Lambda, and AI agents as examples of the \"platforms\" that I deeply admire.\n\nEven earlier, I enjoyed playing with LEGO bricks and Minecraft, and I believe computer systems share many similarities with LEGO|Minecraft at an abstract level—both involve building complex structures from simpler, modular components.\n<p>\n</div>\n\n<h1>Resume</h1>\n\n<h2>Education</h2>\n\n<div>\n    <strong>Texas A&M University</strong>\n    <span style=\"float: right;\">2023.09 - 2025.05</span><br>\n    Master's, Computer Science\n    <span style=\"float: right;\">Texas, USA</span><br><br>\n</div>\n\n<div>\n    <strong>Tianjin University of Science & Technology</strong>\n    <span style=\"float: right;\">2019.09 - 2023.06</span><br>\n    Bachelor's, Internet of Things Engineering<br><br>\n</div>\n\n<h2>Work Experiences</h2>\n\n<div>\n    <strong>LinkedIn</strong>\n    <span style=\"float: right;\">Sunnyvale, US</span><br>\n    Software Engineer, Systems Infrastructure\n    <span style=\"float: right;\">From 2025.07</span><br>\n    <span style=\"float: right;\"></span>\n    Software Engineer Intern – LiX Team\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br><br>\n</div>\n\n<!-- <div>\n    <strong>LinkedIn</strong> -->\n   \n<!-- </div> -->\n\n<div>\n    <strong>ByteDance</strong>\n    <span style=\"float: right;\">2023.04 - 2023.08</span><br>\n    Software Engineer Intern – Video Cloud Infrastructure\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>Amazon</strong>\n    <span style=\"float: right;\">2022.05 - 2022.09</span><br>\n    Software Development Engineer Intern – Device OS\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>HiRain Technologies</strong>\n    <span style=\"float: right;\">2021.07 - 2021.09</span><br>\n    Software Engineer Intern – AE New Energy Division\n    <span style=\"float: right;\">Tianjin, CN</span><br><br>\n</div>\n\n<h2>Research Projects</h2>\n\n<div>\n    <strong>Research on LLM Agent Systems</strong>\n    <span style=\"float: right;\">2024.08 - 2025.02</span><br>\n    - Built Workflow Retrieval & Execution Engine for LLM Agent<br>\n    - Researched programming languages for Multi-Agent programming<br><br>\n</div>\n\n<div>\n    <strong>SyntaxFlow</strong>\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br>\n    SyntaxFlow is a parallel code AST analysis framework which provides flow-style APIs such as <code>search()</code>, <code>map()</code>, <code>filter()</code>, <code>union()</code>, and <code>rewrite()</code> to generate a code process Directed Acyclic Graph (DAG).<br><br>\n</div>\n\n<div>\n    <strong>Research on Fast Startup of Serverless Service</strong>\n    <span style=\"float: right;\">2023.01 - 2023.08</span><br>\n    Introduced Postcopy into the Serverless FaaS platform based on WASM Runtime, achieving a high-speed cold startup mechanism for FaaS containers.<br><br>\n</div>\n\n<h2>Awards and Honors</h2>\n<ul>\n    <li>No Turing Award</li>\n</ul>\n\n<!-- <h2>Interests</h2>\n<ul>\n    <li>Coding 👩🏻‍💻</li>\n    <li>Cat lover 🐱</li>\n    <li>Photography 📷</li>\n    <li>Cycling & Hiking 🥾</li>\n</ul> -->\n","updated":"2025-09-02T01:47:43.506Z","path":"index.html","_id":"cm8w3qqpt00000tok2o762vpz","comments":1,"content":"<br>\n<div align=\"center\">\n  <!-- Avatar Image (use a circular image file) -->\n  <img src=\"about-me/avatar_image.png\" alt=\"Avatar\" width=\"130\" height=\"130\" style=\"border-radius: 15px;\">\n</div>\n\n<div style=\"display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; border-radius: 8px;\">\n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-twitter.png\" alt=\"Twitter\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <!-- <a href=\"https://x.com/Hazel_1024201\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a> -->\n     <a href=\"https://x.com\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-linkedin.png\" alt=\"LinkedIn\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://www.linkedin.com/in/hzliu/\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">LinkedIn</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-github.png\" alt=\"GitHub\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://github.com/muchengl\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Github</a>\n  </div>\n</div>\n\n<div align=\"center\">\n  <!-- Self-introduction Area -->\n<p>\n    <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     Hello! I am Hanzhong Liu. Currently, I work on the Traffic Infrastructure team at LinkedIn 💻. My research interests include distributed system, LLM agents and Μεταφυσικά. \n    In my free time, I enjoy coding, spending time with cats 🐱, photography 📷, and outdoor activities like cycling and hiking 🥾.\n</p>\n\n<hr>\n<p>\nMy research vision is to develop various \"platforms\" that encapsulate complex functionalities behind elegant and user-friendly interfaces, making them accessible to users worldwide. \n\n<p>This interest was inspired by my high school OI (Olympiad in Informatics) coach, Mr. Liu, who designed a highly intuitive online judge (OJ) system for us during my OI journey. I particularly admired this system for its clear pipeline: “question” → “human brain” → “code” → “score.” This was my first encounter with the concept of a “platform.” </p>\n<p>I consider search engines, big data frameworks such as Spark, cloud computing systems like AWS Lambda, and AI agents as examples of the “platforms” that I deeply admire.</p>\n<p>Even earlier, I enjoyed playing with LEGO bricks and Minecraft, and I believe computer systems share many similarities with LEGO|Minecraft at an abstract level—both involve building complex structures from simpler, modular components.</p>\n<p>\n</div>\n\n<h1>Resume</h1>\n\n<h2>Education</h2>\n\n<div>\n    <strong>Texas A&M University</strong>\n    <span style=\"float: right;\">2023.09 - 2025.05</span><br>\n    Master's, Computer Science\n    <span style=\"float: right;\">Texas, USA</span><br><br>\n</div>\n\n<div>\n    <strong>Tianjin University of Science & Technology</strong>\n    <span style=\"float: right;\">2019.09 - 2023.06</span><br>\n    Bachelor's, Internet of Things Engineering<br><br>\n</div>\n\n<h2>Work Experiences</h2>\n\n<div>\n    <strong>LinkedIn</strong>\n    <span style=\"float: right;\">Sunnyvale, US</span><br>\n    Software Engineer, Systems Infrastructure\n    <span style=\"float: right;\">From 2025.07</span><br>\n    <span style=\"float: right;\"></span>\n    Software Engineer Intern – LiX Team\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br><br>\n</div>\n\n<!-- <div>\n    <strong>LinkedIn</strong> -->\n<!-- </div> -->\n\n<div>\n    <strong>ByteDance</strong>\n    <span style=\"float: right;\">2023.04 - 2023.08</span><br>\n    Software Engineer Intern – Video Cloud Infrastructure\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>Amazon</strong>\n    <span style=\"float: right;\">2022.05 - 2022.09</span><br>\n    Software Development Engineer Intern – Device OS\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>HiRain Technologies</strong>\n    <span style=\"float: right;\">2021.07 - 2021.09</span><br>\n    Software Engineer Intern – AE New Energy Division\n    <span style=\"float: right;\">Tianjin, CN</span><br><br>\n</div>\n\n<h2>Research Projects</h2>\n\n<div>\n    <strong>Research on LLM Agent Systems</strong>\n    <span style=\"float: right;\">2024.08 - 2025.02</span><br>\n    - Built Workflow Retrieval & Execution Engine for LLM Agent<br>\n    - Researched programming languages for Multi-Agent programming<br><br>\n</div>\n\n<div>\n    <strong>SyntaxFlow</strong>\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br>\n    SyntaxFlow is a parallel code AST analysis framework which provides flow-style APIs such as <code>search()</code>, <code>map()</code>, <code>filter()</code>, <code>union()</code>, and <code>rewrite()</code> to generate a code process Directed Acyclic Graph (DAG).<br><br>\n</div>\n\n<div>\n    <strong>Research on Fast Startup of Serverless Service</strong>\n    <span style=\"float: right;\">2023.01 - 2023.08</span><br>\n    Introduced Postcopy into the Serverless FaaS platform based on WASM Runtime, achieving a high-speed cold startup mechanism for FaaS containers.<br><br>\n</div>\n\n<h2>Awards and Honors</h2>\n<ul>\n    <li>No Turing Award</li>\n</ul>\n\n<!-- <h2>Interests</h2>\n<ul>\n    <li>Coding 👩🏻‍💻</li>\n    <li>Cat lover 🐱</li>\n    <li>Photography 📷</li>\n    <li>Cycling & Hiking 🥾</li>\n</ul> -->\n","site":{"data":{}},"excerpt":"","more":"<br>\n<div align=\"center\">\n  <!-- Avatar Image (use a circular image file) -->\n  <img src=\"about-me/avatar_image.png\" alt=\"Avatar\" width=\"130\" height=\"130\" style=\"border-radius: 15px;\">\n</div>\n\n<div style=\"display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; border-radius: 8px;\">\n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-twitter.png\" alt=\"Twitter\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <!-- <a href=\"https://x.com/Hazel_1024201\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a> -->\n     <a href=\"https://x.com\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Twitter</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-linkedin.png\" alt=\"LinkedIn\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://www.linkedin.com/in/hzliu/\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">LinkedIn</a>\n  </div>\n  \n  <div style=\"display: flex; align-items: center;\">\n    <img src=\"about-me/icons-github.png\" alt=\"GitHub\" width=\"20\" height=\"20\" style=\"vertical-align: middle;\">\n    <a href=\"https://github.com/muchengl\" style=\"margin-left: 5px; font-family: Arial, sans-serif; color: #333; text-decoration: none;\">Github</a>\n  </div>\n</div>\n\n<div align=\"center\">\n  <!-- Self-introduction Area -->\n<p>\n    <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     <!-- Hello! I am Hanzhong Liu, a failed computer science enthusiast😭. My research interests include distributed system, LLM agents and Μεταφυσικά. -->\n     Hello! I am Hanzhong Liu. Currently, I work on the Traffic Infrastructure team at LinkedIn 💻. My research interests include distributed system, LLM agents and Μεταφυσικά. \n    In my free time, I enjoy coding, spending time with cats 🐱, photography 📷, and outdoor activities like cycling and hiking 🥾.\n</p>\n\n<hr>\n<p>\nMy research vision is to develop various \"platforms\" that encapsulate complex functionalities behind elegant and user-friendly interfaces, making them accessible to users worldwide. \n\n<p>This interest was inspired by my high school OI (Olympiad in Informatics) coach, Mr. Liu, who designed a highly intuitive online judge (OJ) system for us during my OI journey. I particularly admired this system for its clear pipeline: “question” → “human brain” → “code” → “score.” This was my first encounter with the concept of a “platform.” </p>\n<p>I consider search engines, big data frameworks such as Spark, cloud computing systems like AWS Lambda, and AI agents as examples of the “platforms” that I deeply admire.</p>\n<p>Even earlier, I enjoyed playing with LEGO bricks and Minecraft, and I believe computer systems share many similarities with LEGO|Minecraft at an abstract level—both involve building complex structures from simpler, modular components.</p>\n<p>\n</div>\n\n<h1>Resume</h1>\n\n<h2>Education</h2>\n\n<div>\n    <strong>Texas A&M University</strong>\n    <span style=\"float: right;\">2023.09 - 2025.05</span><br>\n    Master's, Computer Science\n    <span style=\"float: right;\">Texas, USA</span><br><br>\n</div>\n\n<div>\n    <strong>Tianjin University of Science & Technology</strong>\n    <span style=\"float: right;\">2019.09 - 2023.06</span><br>\n    Bachelor's, Internet of Things Engineering<br><br>\n</div>\n\n<h2>Work Experiences</h2>\n\n<div>\n    <strong>LinkedIn</strong>\n    <span style=\"float: right;\">Sunnyvale, US</span><br>\n    Software Engineer, Systems Infrastructure\n    <span style=\"float: right;\">From 2025.07</span><br>\n    <span style=\"float: right;\"></span>\n    Software Engineer Intern – LiX Team\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br><br>\n</div>\n\n<!-- <div>\n    <strong>LinkedIn</strong> -->\n<!-- </div> -->\n\n<div>\n    <strong>ByteDance</strong>\n    <span style=\"float: right;\">2023.04 - 2023.08</span><br>\n    Software Engineer Intern – Video Cloud Infrastructure\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>Amazon</strong>\n    <span style=\"float: right;\">2022.05 - 2022.09</span><br>\n    Software Development Engineer Intern – Device OS\n    <span style=\"float: right;\">Beijing, CN</span><br><br>\n</div>\n\n<div>\n    <strong>HiRain Technologies</strong>\n    <span style=\"float: right;\">2021.07 - 2021.09</span><br>\n    Software Engineer Intern – AE New Energy Division\n    <span style=\"float: right;\">Tianjin, CN</span><br><br>\n</div>\n\n<h2>Research Projects</h2>\n\n<div>\n    <strong>Research on LLM Agent Systems</strong>\n    <span style=\"float: right;\">2024.08 - 2025.02</span><br>\n    - Built Workflow Retrieval & Execution Engine for LLM Agent<br>\n    - Researched programming languages for Multi-Agent programming<br><br>\n</div>\n\n<div>\n    <strong>SyntaxFlow</strong>\n    <span style=\"float: right;\">2024.05 - 2024.08</span><br>\n    SyntaxFlow is a parallel code AST analysis framework which provides flow-style APIs such as <code>search()</code>, <code>map()</code>, <code>filter()</code>, <code>union()</code>, and <code>rewrite()</code> to generate a code process Directed Acyclic Graph (DAG).<br><br>\n</div>\n\n<div>\n    <strong>Research on Fast Startup of Serverless Service</strong>\n    <span style=\"float: right;\">2023.01 - 2023.08</span><br>\n    Introduced Postcopy into the Serverless FaaS platform based on WASM Runtime, achieving a high-speed cold startup mechanism for FaaS containers.<br><br>\n</div>\n\n<h2>Awards and Honors</h2>\n<ul>\n    <li>No Turing Award</li>\n</ul>\n\n<!-- <h2>Interests</h2>\n<ul>\n    <li>Coding 👩🏻‍💻</li>\n    <li>Cat lover 🐱</li>\n    <li>Photography 📷</li>\n    <li>Cycling & Hiking 🥾</li>\n</ul> -->\n"}],"Post":[{"title":"Amazon internship Doc","date":"2022-11-19T07:40:11.000Z","_content":"\n<object data=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\" type=\"application/pdf\" width=\"700px\" height=\"800px\" >\n    <embed src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">\n        <p>This browser does not support PDFs. Please download the PDF to view it: <a href=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">Download PDF</a>.</p>\n    </embed>\n</object>\n\n\n\n\n\n\n\n\n","source":"_posts/Amazon-Doc.md","raw":"---\ntitle: Amazon internship Doc\ndate: 2022-11-19 15:40:11\ntags: intern\n---\n\n<object data=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\" type=\"application/pdf\" width=\"700px\" height=\"800px\" >\n    <embed src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">\n        <p>This browser does not support PDFs. Please download the PDF to view it: <a href=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">Download PDF</a>.</p>\n    </embed>\n</object>\n\n\n\n\n\n\n\n\n","slug":"Amazon-Doc","published":1,"updated":"2022-11-23T05:14:47.724Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9m0001b9c91cbq9zm9","content":"<object data=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\" type=\"application/pdf\" width=\"700px\" height=\"800px\" >\n    <embed src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">\n        <p>This browser does not support PDFs. Please download the PDF to view it: <a href=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">Download PDF</a>.</p>\n    </embed>\n</object>\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<object data=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\" type=\"application/pdf\" width=\"700px\" height=\"800px\" >\n    <embed src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">\n        <p>This browser does not support PDFs. Please download the PDF to view it: <a href=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/File-analysis-tool-high-level-design.pdf\">Download PDF</a>.</p>\n    </embed>\n</object>\n\n\n\n\n\n\n\n\n"},{"title":"MIT 6.s081 Lab2 System Call","date":"2023-01-10T07:48:20.000Z","_content":"\n## xv6系统用户态调用syscall过程分析\n\n- /user/usys.S 是用户态进入内核态的汇编脚本，该文件由usys.pl生成\n\n```\n.global sysinfo\nsysinfo:\n li a7, SYS_sysinfo  # 将syscall的标识写入a7寄存器\n ecall               # 使用ecall指令，使用a7寄存器，进入内核态\n ret\n```\n\n- /kernal/syscall.c，该函数获取用户态传递的syscall id，并进行调用\n\n```\nvoid syscall(void) {\n  int num;\n  struct proc *p = myproc(); //获取进入内核态的进程\n\n  num = p->trapframe->a7;    //获取需要执行的系统调用id，该id由usys.S写入了a7寄存器\n\n\n  if(num > 0 && num < NELEM(syscalls) && syscalls[num]) { # 使用syscall的函数指针调用\n  \n    // Use num to lookup the system call function for num, call it,\n    // and store its return value in p->trapframe->a0\n    p->trapframe->a0 = syscalls[num](); #将syscall返回值保存在a0寄存器，通过此方法将返回值传递给用户态\n    \n  } else {\n    printf(\"%d %s: unknown sys call %d\\n\",\n            p->pid, p->name, num);\n    p->trapframe->a0 = -1;\n  }\n}\n```\n\n- /kernal/sysproc.c，该文件是lab2中syscall的实现代码文件\n\n```\n//实现syscall,该函数需在syscall.c中声明\nuint64 sys_trace(void){\n\n\t\t// 获取system call 参数\n    int muskid;\n    argint(0,&muskid);\n\n    return trace(muskid); //do something and return\n}\n```\n\n\n\n## 添加syscall流程\n\n1. 在syscall.h中添加一个syscall id\n    ```\n    #define SYS_trace  22\n    #define SYS_sysinfo  23\n    ```\n\n2. 在syscall.c中添加syscall的函数定义\n\n    ```\n    extern uint64 sys_trace(void);\n    extern uint64 sys_sysinfo(void);\n    ```\n\n    ```\n    [SYS_trace]   sys_trace,\n    [SYS_sysinfo]   sys_sysinfo\n    ```\n\n3. 在sysproc中实现syscall函数\n    ```\n    uint64 sys_trace(void){\n        int muskid;\n    \n        // 获取system call 参数\n        argint(0,&muskid);\n    \n        return trace(muskid);\n    }\n    ```\n\n4. 在/user/usys.pl加入系统调用声明\n    ```\n    entry(\"trace\");\n    entry(\"sysinfo\");\n    ```\n\n这样以来，用户态向内核态传递syscall id(a7)，内核态根据id对相应的syscall进行调用，并将返回值储存在a0寄存器。\n\n\n\n## Trace\n\n\n\n## Sysinfo\n\n\n\n\n\n![截屏2023-01-10 02.03.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png)\n\n\n\n\n\n\n\n\n\n","source":"_posts/6-s081-Lab2-System-Call.md","raw":"---\ntitle: MIT 6.s081 Lab2 System Call\ndate: 2023-01-10 15:48:20\ntags:\n---\n\n## xv6系统用户态调用syscall过程分析\n\n- /user/usys.S 是用户态进入内核态的汇编脚本，该文件由usys.pl生成\n\n```\n.global sysinfo\nsysinfo:\n li a7, SYS_sysinfo  # 将syscall的标识写入a7寄存器\n ecall               # 使用ecall指令，使用a7寄存器，进入内核态\n ret\n```\n\n- /kernal/syscall.c，该函数获取用户态传递的syscall id，并进行调用\n\n```\nvoid syscall(void) {\n  int num;\n  struct proc *p = myproc(); //获取进入内核态的进程\n\n  num = p->trapframe->a7;    //获取需要执行的系统调用id，该id由usys.S写入了a7寄存器\n\n\n  if(num > 0 && num < NELEM(syscalls) && syscalls[num]) { # 使用syscall的函数指针调用\n  \n    // Use num to lookup the system call function for num, call it,\n    // and store its return value in p->trapframe->a0\n    p->trapframe->a0 = syscalls[num](); #将syscall返回值保存在a0寄存器，通过此方法将返回值传递给用户态\n    \n  } else {\n    printf(\"%d %s: unknown sys call %d\\n\",\n            p->pid, p->name, num);\n    p->trapframe->a0 = -1;\n  }\n}\n```\n\n- /kernal/sysproc.c，该文件是lab2中syscall的实现代码文件\n\n```\n//实现syscall,该函数需在syscall.c中声明\nuint64 sys_trace(void){\n\n\t\t// 获取system call 参数\n    int muskid;\n    argint(0,&muskid);\n\n    return trace(muskid); //do something and return\n}\n```\n\n\n\n## 添加syscall流程\n\n1. 在syscall.h中添加一个syscall id\n    ```\n    #define SYS_trace  22\n    #define SYS_sysinfo  23\n    ```\n\n2. 在syscall.c中添加syscall的函数定义\n\n    ```\n    extern uint64 sys_trace(void);\n    extern uint64 sys_sysinfo(void);\n    ```\n\n    ```\n    [SYS_trace]   sys_trace,\n    [SYS_sysinfo]   sys_sysinfo\n    ```\n\n3. 在sysproc中实现syscall函数\n    ```\n    uint64 sys_trace(void){\n        int muskid;\n    \n        // 获取system call 参数\n        argint(0,&muskid);\n    \n        return trace(muskid);\n    }\n    ```\n\n4. 在/user/usys.pl加入系统调用声明\n    ```\n    entry(\"trace\");\n    entry(\"sysinfo\");\n    ```\n\n这样以来，用户态向内核态传递syscall id(a7)，内核态根据id对相应的syscall进行调用，并将返回值储存在a0寄存器。\n\n\n\n## Trace\n\n\n\n## Sysinfo\n\n\n\n\n\n![截屏2023-01-10 02.03.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png)\n\n\n\n\n\n\n\n\n\n","slug":"6-s081-Lab2-System-Call","published":1,"updated":"2023-01-13T09:02:17.528Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9q0003b9c9082c3y8s","content":"<h2 id=\"xv6系统用户态调用syscall过程分析\"><a href=\"#xv6系统用户态调用syscall过程分析\" class=\"headerlink\" title=\"xv6系统用户态调用syscall过程分析\"></a>xv6系统用户态调用syscall过程分析</h2><ul>\n<li>/user/usys.S 是用户态进入内核态的汇编脚本，该文件由usys.pl生成</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.global sysinfo</span><br><span class=\"line\">sysinfo:</span><br><span class=\"line\"> li a7, SYS_sysinfo  # 将syscall的标识写入a7寄存器</span><br><span class=\"line\"> ecall               # 使用ecall指令，使用a7寄存器，进入内核态</span><br><span class=\"line\"> ret</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>/kernal/syscall.c，该函数获取用户态传递的syscall id，并进行调用</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void syscall(void) &#123;</span><br><span class=\"line\">  int num;</span><br><span class=\"line\">  struct proc *p = myproc(); //获取进入内核态的进程</span><br><span class=\"line\"></span><br><span class=\"line\">  num = p-&gt;trapframe-&gt;a7;    //获取需要执行的系统调用id，该id由usys.S写入了a7寄存器</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123; # 使用syscall的函数指针调用</span><br><span class=\"line\">  </span><br><span class=\"line\">    // Use num to lookup the system call function for num, call it,</span><br><span class=\"line\">    // and store its return value in p-&gt;trapframe-&gt;a0</span><br><span class=\"line\">    p-&gt;trapframe-&gt;a0 = syscalls[num](); #将syscall返回值保存在a0寄存器，通过此方法将返回值传递给用户态</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    printf(&quot;%d %s: unknown sys call %d\\n&quot;,</span><br><span class=\"line\">            p-&gt;pid, p-&gt;name, num);</span><br><span class=\"line\">    p-&gt;trapframe-&gt;a0 = -1;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>/kernal/sysproc.c，该文件是lab2中syscall的实现代码文件</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//实现syscall,该函数需在syscall.c中声明</span><br><span class=\"line\">uint64 sys_trace(void)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 获取system call 参数</span><br><span class=\"line\">    int muskid;</span><br><span class=\"line\">    argint(0,&amp;muskid);</span><br><span class=\"line\"></span><br><span class=\"line\">    return trace(muskid); //do something and return</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"添加syscall流程\"><a href=\"#添加syscall流程\" class=\"headerlink\" title=\"添加syscall流程\"></a>添加syscall流程</h2><ol>\n<li><p>在syscall.h中添加一个syscall id</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SYS_trace  22</span><br><span class=\"line\">#define SYS_sysinfo  23</span><br></pre></td></tr></table></figure></li>\n<li><p>在syscall.c中添加syscall的函数定义</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern uint64 sys_trace(void);</span><br><span class=\"line\">extern uint64 sys_sysinfo(void);</span><br></pre></td></tr></table></figure>\n\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[SYS_trace]   sys_trace,</span><br><span class=\"line\">[SYS_sysinfo]   sys_sysinfo</span><br></pre></td></tr></table></figure></li>\n<li><p>在sysproc中实现syscall函数</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uint64 sys_trace(void)&#123;</span><br><span class=\"line\">    int muskid;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 获取system call 参数</span><br><span class=\"line\">    argint(0,&amp;muskid);</span><br><span class=\"line\"></span><br><span class=\"line\">    return trace(muskid);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>在/user/usys.pl加入系统调用声明</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">entry(&quot;trace&quot;);</span><br><span class=\"line\">entry(&quot;sysinfo&quot;);</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>这样以来，用户态向内核态传递syscall id(a7)，内核态根据id对相应的syscall进行调用，并将返回值储存在a0寄存器。</p>\n<h2 id=\"Trace\"><a href=\"#Trace\" class=\"headerlink\" title=\"Trace\"></a>Trace</h2><h2 id=\"Sysinfo\"><a href=\"#Sysinfo\" class=\"headerlink\" title=\"Sysinfo\"></a>Sysinfo</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png\" alt=\"截屏2023-01-10 02.03.22\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"xv6系统用户态调用syscall过程分析\"><a href=\"#xv6系统用户态调用syscall过程分析\" class=\"headerlink\" title=\"xv6系统用户态调用syscall过程分析\"></a>xv6系统用户态调用syscall过程分析</h2><ul>\n<li>/user/usys.S 是用户态进入内核态的汇编脚本，该文件由usys.pl生成</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.global sysinfo</span><br><span class=\"line\">sysinfo:</span><br><span class=\"line\"> li a7, SYS_sysinfo  # 将syscall的标识写入a7寄存器</span><br><span class=\"line\"> ecall               # 使用ecall指令，使用a7寄存器，进入内核态</span><br><span class=\"line\"> ret</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>/kernal/syscall.c，该函数获取用户态传递的syscall id，并进行调用</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void syscall(void) &#123;</span><br><span class=\"line\">  int num;</span><br><span class=\"line\">  struct proc *p = myproc(); //获取进入内核态的进程</span><br><span class=\"line\"></span><br><span class=\"line\">  num = p-&gt;trapframe-&gt;a7;    //获取需要执行的系统调用id，该id由usys.S写入了a7寄存器</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123; # 使用syscall的函数指针调用</span><br><span class=\"line\">  </span><br><span class=\"line\">    // Use num to lookup the system call function for num, call it,</span><br><span class=\"line\">    // and store its return value in p-&gt;trapframe-&gt;a0</span><br><span class=\"line\">    p-&gt;trapframe-&gt;a0 = syscalls[num](); #将syscall返回值保存在a0寄存器，通过此方法将返回值传递给用户态</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    printf(&quot;%d %s: unknown sys call %d\\n&quot;,</span><br><span class=\"line\">            p-&gt;pid, p-&gt;name, num);</span><br><span class=\"line\">    p-&gt;trapframe-&gt;a0 = -1;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>/kernal/sysproc.c，该文件是lab2中syscall的实现代码文件</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//实现syscall,该函数需在syscall.c中声明</span><br><span class=\"line\">uint64 sys_trace(void)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 获取system call 参数</span><br><span class=\"line\">    int muskid;</span><br><span class=\"line\">    argint(0,&amp;muskid);</span><br><span class=\"line\"></span><br><span class=\"line\">    return trace(muskid); //do something and return</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"添加syscall流程\"><a href=\"#添加syscall流程\" class=\"headerlink\" title=\"添加syscall流程\"></a>添加syscall流程</h2><ol>\n<li><p>在syscall.h中添加一个syscall id</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SYS_trace  22</span><br><span class=\"line\">#define SYS_sysinfo  23</span><br></pre></td></tr></table></figure></li>\n<li><p>在syscall.c中添加syscall的函数定义</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern uint64 sys_trace(void);</span><br><span class=\"line\">extern uint64 sys_sysinfo(void);</span><br></pre></td></tr></table></figure>\n\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[SYS_trace]   sys_trace,</span><br><span class=\"line\">[SYS_sysinfo]   sys_sysinfo</span><br></pre></td></tr></table></figure></li>\n<li><p>在sysproc中实现syscall函数</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uint64 sys_trace(void)&#123;</span><br><span class=\"line\">    int muskid;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 获取system call 参数</span><br><span class=\"line\">    argint(0,&amp;muskid);</span><br><span class=\"line\"></span><br><span class=\"line\">    return trace(muskid);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>在/user/usys.pl加入系统调用声明</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">entry(&quot;trace&quot;);</span><br><span class=\"line\">entry(&quot;sysinfo&quot;);</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>这样以来，用户态向内核态传递syscall id(a7)，内核态根据id对相应的syscall进行调用，并将返回值储存在a0寄存器。</p>\n<h2 id=\"Trace\"><a href=\"#Trace\" class=\"headerlink\" title=\"Trace\"></a>Trace</h2><h2 id=\"Sysinfo\"><a href=\"#Sysinfo\" class=\"headerlink\" title=\"Sysinfo\"></a>Sysinfo</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-10%2002.03.22.png\" alt=\"截屏2023-01-10 02.03.22\"></p>\n"},{"title":"Casdoor Flutter Sdk Bug Fix","date":"2022-11-27T13:18:58.000Z","_content":"\n## 1.安卓，不能跳转回app问题\n\n安装了一个第三方浏览器，就解决问题了，因此sdk的代码本身应该是是正确的（原始浏览器不能跳转的问题暂不清楚原因，还需研究）  \n\n## 2.Flutter web端存在跨域问题\n\n![5DC1E696AFA5781CE5B8C30C59AEFA8F](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg)\n\n![D306359D80BF70C7E5350EE14321E2DF](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg)\n\n这个问题网上有很多讨论，单从Flutter的角度来说，好像没有完美解决方案。 \n\n> 这一块我不清楚我理解的对不对：\n>\n> 我研究了一下Casdoor js sdk的逻辑，使用了js sdk的项目里，我没有找到浏览器直接向Casdoor发送请求获取token的例子。 \n>\n> 1.casdoor-python-vue-sdk-example这个repo，token是通过后端的py程序获取的，应该不是浏览器直接向casdoor发请求。\n>\n> 2.casdoor-raw-js-example这个repo，是用node.js启动项目（并且启动了一个代理server，由这个server向Casdoor发送请求），也不是原生js在浏览器直接请求token。\n\n但是Flutter-web就等于是编译出来一个静态web项目，原生运行在浏览器，浏览器中的原生js直接去请求其他域名下的casdoor必然遇到跨域问题\n\n为解决这个问题，我目前想到了四种方法：\n\n- 为Casdoor的token获取接口添加CORS跨域资源分享支持\n- 用Flutter调用原生js代码，通过一些不太优美的原生js方式绕过跨域问题\n- 在Flutter内置一个代理程序（类似casdoor-raw-js-example）.但是这样没有实际意义，因为这个代理必须在Dart环境下才能启动，对于用户而言没用。\n- 调整Flutter web的逻辑，不再提供其直接获取token的功能。或告知用户，直接用Flutter web整合Casdoor会遇到跨域问题，建议结合后端使用\n\n\n\n","source":"_posts/Casdoor-Flutter-Sdk-Bug-Fix.md","raw":"---\ntitle: Casdoor Flutter Sdk Bug Fix\ndate: 2022-11-27 21:18:58\ntags: Casdoor\n---\n\n## 1.安卓，不能跳转回app问题\n\n安装了一个第三方浏览器，就解决问题了，因此sdk的代码本身应该是是正确的（原始浏览器不能跳转的问题暂不清楚原因，还需研究）  \n\n## 2.Flutter web端存在跨域问题\n\n![5DC1E696AFA5781CE5B8C30C59AEFA8F](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg)\n\n![D306359D80BF70C7E5350EE14321E2DF](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg)\n\n这个问题网上有很多讨论，单从Flutter的角度来说，好像没有完美解决方案。 \n\n> 这一块我不清楚我理解的对不对：\n>\n> 我研究了一下Casdoor js sdk的逻辑，使用了js sdk的项目里，我没有找到浏览器直接向Casdoor发送请求获取token的例子。 \n>\n> 1.casdoor-python-vue-sdk-example这个repo，token是通过后端的py程序获取的，应该不是浏览器直接向casdoor发请求。\n>\n> 2.casdoor-raw-js-example这个repo，是用node.js启动项目（并且启动了一个代理server，由这个server向Casdoor发送请求），也不是原生js在浏览器直接请求token。\n\n但是Flutter-web就等于是编译出来一个静态web项目，原生运行在浏览器，浏览器中的原生js直接去请求其他域名下的casdoor必然遇到跨域问题\n\n为解决这个问题，我目前想到了四种方法：\n\n- 为Casdoor的token获取接口添加CORS跨域资源分享支持\n- 用Flutter调用原生js代码，通过一些不太优美的原生js方式绕过跨域问题\n- 在Flutter内置一个代理程序（类似casdoor-raw-js-example）.但是这样没有实际意义，因为这个代理必须在Dart环境下才能启动，对于用户而言没用。\n- 调整Flutter web的逻辑，不再提供其直接获取token的功能。或告知用户，直接用Flutter web整合Casdoor会遇到跨域问题，建议结合后端使用\n\n\n\n","slug":"Casdoor-Flutter-Sdk-Bug-Fix","published":1,"updated":"2022-11-29T16:10:31.490Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9s0006b9c9apxaaczz","content":"<h2 id=\"1-安卓，不能跳转回app问题\"><a href=\"#1-安卓，不能跳转回app问题\" class=\"headerlink\" title=\"1.安卓，不能跳转回app问题\"></a>1.安卓，不能跳转回app问题</h2><p>安装了一个第三方浏览器，就解决问题了，因此sdk的代码本身应该是是正确的（原始浏览器不能跳转的问题暂不清楚原因，还需研究）  </p>\n<h2 id=\"2-Flutter-web端存在跨域问题\"><a href=\"#2-Flutter-web端存在跨域问题\" class=\"headerlink\" title=\"2.Flutter web端存在跨域问题\"></a>2.Flutter web端存在跨域问题</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg\" alt=\"5DC1E696AFA5781CE5B8C30C59AEFA8F\"></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg\" alt=\"D306359D80BF70C7E5350EE14321E2DF\"></p>\n<p>这个问题网上有很多讨论，单从Flutter的角度来说，好像没有完美解决方案。 </p>\n<blockquote>\n<p>这一块我不清楚我理解的对不对：</p>\n<p>我研究了一下Casdoor js sdk的逻辑，使用了js sdk的项目里，我没有找到浏览器直接向Casdoor发送请求获取token的例子。 </p>\n<p>1.casdoor-python-vue-sdk-example这个repo，token是通过后端的py程序获取的，应该不是浏览器直接向casdoor发请求。</p>\n<p>2.casdoor-raw-js-example这个repo，是用node.js启动项目（并且启动了一个代理server，由这个server向Casdoor发送请求），也不是原生js在浏览器直接请求token。</p>\n</blockquote>\n<p>但是Flutter-web就等于是编译出来一个静态web项目，原生运行在浏览器，浏览器中的原生js直接去请求其他域名下的casdoor必然遇到跨域问题</p>\n<p>为解决这个问题，我目前想到了四种方法：</p>\n<ul>\n<li>为Casdoor的token获取接口添加CORS跨域资源分享支持</li>\n<li>用Flutter调用原生js代码，通过一些不太优美的原生js方式绕过跨域问题</li>\n<li>在Flutter内置一个代理程序（类似casdoor-raw-js-example）.但是这样没有实际意义，因为这个代理必须在Dart环境下才能启动，对于用户而言没用。</li>\n<li>调整Flutter web的逻辑，不再提供其直接获取token的功能。或告知用户，直接用Flutter web整合Casdoor会遇到跨域问题，建议结合后端使用</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-安卓，不能跳转回app问题\"><a href=\"#1-安卓，不能跳转回app问题\" class=\"headerlink\" title=\"1.安卓，不能跳转回app问题\"></a>1.安卓，不能跳转回app问题</h2><p>安装了一个第三方浏览器，就解决问题了，因此sdk的代码本身应该是是正确的（原始浏览器不能跳转的问题暂不清楚原因，还需研究）  </p>\n<h2 id=\"2-Flutter-web端存在跨域问题\"><a href=\"#2-Flutter-web端存在跨域问题\" class=\"headerlink\" title=\"2.Flutter web端存在跨域问题\"></a>2.Flutter web端存在跨域问题</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5DC1E696AFA5781CE5B8C30C59AEFA8F.jpg\" alt=\"5DC1E696AFA5781CE5B8C30C59AEFA8F\"></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/D306359D80BF70C7E5350EE14321E2DF.jpg\" alt=\"D306359D80BF70C7E5350EE14321E2DF\"></p>\n<p>这个问题网上有很多讨论，单从Flutter的角度来说，好像没有完美解决方案。 </p>\n<blockquote>\n<p>这一块我不清楚我理解的对不对：</p>\n<p>我研究了一下Casdoor js sdk的逻辑，使用了js sdk的项目里，我没有找到浏览器直接向Casdoor发送请求获取token的例子。 </p>\n<p>1.casdoor-python-vue-sdk-example这个repo，token是通过后端的py程序获取的，应该不是浏览器直接向casdoor发请求。</p>\n<p>2.casdoor-raw-js-example这个repo，是用node.js启动项目（并且启动了一个代理server，由这个server向Casdoor发送请求），也不是原生js在浏览器直接请求token。</p>\n</blockquote>\n<p>但是Flutter-web就等于是编译出来一个静态web项目，原生运行在浏览器，浏览器中的原生js直接去请求其他域名下的casdoor必然遇到跨域问题</p>\n<p>为解决这个问题，我目前想到了四种方法：</p>\n<ul>\n<li>为Casdoor的token获取接口添加CORS跨域资源分享支持</li>\n<li>用Flutter调用原生js代码，通过一些不太优美的原生js方式绕过跨域问题</li>\n<li>在Flutter内置一个代理程序（类似casdoor-raw-js-example）.但是这样没有实际意义，因为这个代理必须在Dart环境下才能启动，对于用户而言没用。</li>\n<li>调整Flutter web的逻辑，不再提供其直接获取token的功能。或告知用户，直接用Flutter web整合Casdoor会遇到跨域问题，建议结合后端使用</li>\n</ul>\n"},{"title":"Casdoor Flutter Sdk Test","date":"2022-11-22T03:05:19.000Z","_content":"\n\n\n## Step 1: Clone casdoor-flutter-example from Github\n\nLink: https://github.com/casdoor/casdoor-flutter-example\n\n\n\n## Step 2: Test in Chrome(Web)\n\nEncountered a cross-domain problem. So the token could not be obtained.\n\n```dart\n// cross-domain code\n// Post: localhost -> door.casdoor.com\nfinal response = await _casdoor.requestOauthAccessToken(code);\n```\n\nError:\n\n![截屏2022-11-26 14.12.45](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png)\n\n## Step 3: Test in Android Emulator\n\nAndroid app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)\n\nGraphic：\n\n![截屏2022-11-26 14.41.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png)\n\n## Step 4: Test in IOS Emulator\n\nWorking well.\n\n![截屏2022-11-26 15.38.58](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png)\n\n\n\n\n\n\n\n\n\n","source":"_posts/Casdoor-Flutter-sdk-Test.md","raw":"---\ntitle: Casdoor Flutter Sdk Test\ndate: 2022-11-22 11:05:19\ntags: casdoor\n---\n\n\n\n## Step 1: Clone casdoor-flutter-example from Github\n\nLink: https://github.com/casdoor/casdoor-flutter-example\n\n\n\n## Step 2: Test in Chrome(Web)\n\nEncountered a cross-domain problem. So the token could not be obtained.\n\n```dart\n// cross-domain code\n// Post: localhost -> door.casdoor.com\nfinal response = await _casdoor.requestOauthAccessToken(code);\n```\n\nError:\n\n![截屏2022-11-26 14.12.45](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png)\n\n## Step 3: Test in Android Emulator\n\nAndroid app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)\n\nGraphic：\n\n![截屏2022-11-26 14.41.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png)\n\n## Step 4: Test in IOS Emulator\n\nWorking well.\n\n![截屏2022-11-26 15.38.58](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png)\n\n\n\n\n\n\n\n\n\n","slug":"Casdoor-Flutter-sdk-Test","published":1,"updated":"2022-11-29T16:11:41.757Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9t0007b9c9cyfza66l","content":"<h2 id=\"Step-1-Clone-casdoor-flutter-example-from-Github\"><a href=\"#Step-1-Clone-casdoor-flutter-example-from-Github\" class=\"headerlink\" title=\"Step 1: Clone casdoor-flutter-example from Github\"></a>Step 1: Clone casdoor-flutter-example from Github</h2><p>Link: <a href=\"https://github.com/casdoor/casdoor-flutter-example\">https://github.com/casdoor/casdoor-flutter-example</a></p>\n<h2 id=\"Step-2-Test-in-Chrome-Web\"><a href=\"#Step-2-Test-in-Chrome-Web\" class=\"headerlink\" title=\"Step 2: Test in Chrome(Web)\"></a>Step 2: Test in Chrome(Web)</h2><p>Encountered a cross-domain problem. So the token could not be obtained.</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// cross-domain code</span></span><br><span class=\"line\"><span class=\"comment\">// Post: localhost -&gt; door.casdoor.com</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> response = <span class=\"keyword\">await</span> _casdoor.requestOauthAccessToken(code);</span><br></pre></td></tr></table></figure>\n\n<p>Error:</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png\" alt=\"截屏2022-11-26 14.12.45\"></p>\n<h2 id=\"Step-3-Test-in-Android-Emulator\"><a href=\"#Step-3-Test-in-Android-Emulator\" class=\"headerlink\" title=\"Step 3: Test in Android Emulator\"></a>Step 3: Test in Android Emulator</h2><p>Android app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)</p>\n<p>Graphic：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png\" alt=\"截屏2022-11-26 14.41.25\"></p>\n<h2 id=\"Step-4-Test-in-IOS-Emulator\"><a href=\"#Step-4-Test-in-IOS-Emulator\" class=\"headerlink\" title=\"Step 4: Test in IOS Emulator\"></a>Step 4: Test in IOS Emulator</h2><p>Working well.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png\" alt=\"截屏2022-11-26 15.38.58\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Step-1-Clone-casdoor-flutter-example-from-Github\"><a href=\"#Step-1-Clone-casdoor-flutter-example-from-Github\" class=\"headerlink\" title=\"Step 1: Clone casdoor-flutter-example from Github\"></a>Step 1: Clone casdoor-flutter-example from Github</h2><p>Link: <a href=\"https://github.com/casdoor/casdoor-flutter-example\">https://github.com/casdoor/casdoor-flutter-example</a></p>\n<h2 id=\"Step-2-Test-in-Chrome-Web\"><a href=\"#Step-2-Test-in-Chrome-Web\" class=\"headerlink\" title=\"Step 2: Test in Chrome(Web)\"></a>Step 2: Test in Chrome(Web)</h2><p>Encountered a cross-domain problem. So the token could not be obtained.</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// cross-domain code</span></span><br><span class=\"line\"><span class=\"comment\">// Post: localhost -&gt; door.casdoor.com</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> response = <span class=\"keyword\">await</span> _casdoor.requestOauthAccessToken(code);</span><br></pre></td></tr></table></figure>\n\n<p>Error:</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.12.45.png\" alt=\"截屏2022-11-26 14.12.45\"></p>\n<h2 id=\"Step-3-Test-in-Android-Emulator\"><a href=\"#Step-3-Test-in-Android-Emulator\" class=\"headerlink\" title=\"Step 3: Test in Android Emulator\"></a>Step 3: Test in Android Emulator</h2><p>Android app can get a Token. But the automatic jump from browser back to App cannot be triggered. (Perhaps the emulator causes this bug)</p>\n<p>Graphic：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2014.41.25.png\" alt=\"截屏2022-11-26 14.41.25\"></p>\n<h2 id=\"Step-4-Test-in-IOS-Emulator\"><a href=\"#Step-4-Test-in-IOS-Emulator\" class=\"headerlink\" title=\"Step 4: Test in IOS Emulator\"></a>Step 4: Test in IOS Emulator</h2><p>Working well.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-26%2015.38.58.png\" alt=\"截屏2022-11-26 15.38.58\"></p>\n"},{"title":"Cross-domain security in SSO","date":"2022-12-01T11:18:10.000Z","_content":"\n由于Casdoor Flutter Sdk遇到了跨域问题，故调研Okta和Auth0的跨域问题的解决方案，方案初步整理如下：\n\n## 解决策略\n\n在单点登录系统中，Single-Page App需要从浏览器跨域访问SSO服务器。为支持这一需求，单点登录系统应支持配置“Allowed Web Origins”和“Allowed API”。SSO服务可以根据这两个配置对跨域请求进行校验。\n\n> 定义：\n> - **Single-Page App**：单页应用。为不包含后端的纯web页面\n>\n> - **Allowed Web Origins**：允许跨域访问的网络源(Web Origin)。尽管Single-Page App不包含后端，但其依然会挂在一个服务器上以支持用户访问，这个服务器的Host就是Web Origin\n>\n> -  **Allowed API**：支持跨域访问的API\n\n以下为Okta和Auth0对两种配置的支持情况：\n\n|           | Okta |       Auth0 |\n| :-----: | :---: | :----------: |\n| Allowed Web Origins | ✅ | ✅ |\n| Allowed API | ✅ |  ⭕️ |\n\n对于Js sdk，需对跨域访问的请求头进行配置：\n\n```\nreferrer : Web Origin/path\norigin : Web Origin\n```\n\n此外，需针对Token的存储模式提供安全保障，例如localstorage和设定过期策略。\n（Okta和Auth0的整个跨域支持逻辑比较复杂，暂未弄清整个流程全部细节）\n\n## Okta对跨域问题的支持\n\nOkta跨域配置教程：https://developer.okta.com/docs/guides/enable-cors/main/\n\n![截屏2022-12-01 19.50.59](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png)\n\nOkta js sdk repo：https://github.com/okta/okta-auth-js\nOkta js sdk教程：https://developer.okta.com/docs/guides/auth-js/main/\n\n## Auth0对跨域问题的支持\n\nAuth0 js sdk教程：https://auth0.com/docs/quickstart/spa/vanillajs/interactive\n\n![截屏2022-12-01 19.48.51](https://github.com/muchengl/pic_storage/blob/main/uPic/截屏2022-12-01%2019.48.51.png?raw=true)\n\nAuth0 js sdk: https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js\n\n","source":"_posts/Cross-domain-security-in-SSO.md","raw":"---\ntitle: Cross-domain security in SSO\ndate: 2022-12-01 19:18:10\ntags: Casdoor\n---\n\n由于Casdoor Flutter Sdk遇到了跨域问题，故调研Okta和Auth0的跨域问题的解决方案，方案初步整理如下：\n\n## 解决策略\n\n在单点登录系统中，Single-Page App需要从浏览器跨域访问SSO服务器。为支持这一需求，单点登录系统应支持配置“Allowed Web Origins”和“Allowed API”。SSO服务可以根据这两个配置对跨域请求进行校验。\n\n> 定义：\n> - **Single-Page App**：单页应用。为不包含后端的纯web页面\n>\n> - **Allowed Web Origins**：允许跨域访问的网络源(Web Origin)。尽管Single-Page App不包含后端，但其依然会挂在一个服务器上以支持用户访问，这个服务器的Host就是Web Origin\n>\n> -  **Allowed API**：支持跨域访问的API\n\n以下为Okta和Auth0对两种配置的支持情况：\n\n|           | Okta |       Auth0 |\n| :-----: | :---: | :----------: |\n| Allowed Web Origins | ✅ | ✅ |\n| Allowed API | ✅ |  ⭕️ |\n\n对于Js sdk，需对跨域访问的请求头进行配置：\n\n```\nreferrer : Web Origin/path\norigin : Web Origin\n```\n\n此外，需针对Token的存储模式提供安全保障，例如localstorage和设定过期策略。\n（Okta和Auth0的整个跨域支持逻辑比较复杂，暂未弄清整个流程全部细节）\n\n## Okta对跨域问题的支持\n\nOkta跨域配置教程：https://developer.okta.com/docs/guides/enable-cors/main/\n\n![截屏2022-12-01 19.50.59](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png)\n\nOkta js sdk repo：https://github.com/okta/okta-auth-js\nOkta js sdk教程：https://developer.okta.com/docs/guides/auth-js/main/\n\n## Auth0对跨域问题的支持\n\nAuth0 js sdk教程：https://auth0.com/docs/quickstart/spa/vanillajs/interactive\n\n![截屏2022-12-01 19.48.51](https://github.com/muchengl/pic_storage/blob/main/uPic/截屏2022-12-01%2019.48.51.png?raw=true)\n\nAuth0 js sdk: https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js\n\n","slug":"Cross-domain-security-in-SSO","published":1,"updated":"2022-12-01T12:17:32.070Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9u0008b9c9eslc3egr","content":"<p>由于Casdoor Flutter Sdk遇到了跨域问题，故调研Okta和Auth0的跨域问题的解决方案，方案初步整理如下：</p>\n<h2 id=\"解决策略\"><a href=\"#解决策略\" class=\"headerlink\" title=\"解决策略\"></a>解决策略</h2><p>在单点登录系统中，Single-Page App需要从浏览器跨域访问SSO服务器。为支持这一需求，单点登录系统应支持配置“Allowed Web Origins”和“Allowed API”。SSO服务可以根据这两个配置对跨域请求进行校验。</p>\n<blockquote>\n<p>定义：</p>\n<ul>\n<li><p><strong>Single-Page App</strong>：单页应用。为不包含后端的纯web页面</p>\n</li>\n<li><p><strong>Allowed Web Origins</strong>：允许跨域访问的网络源(Web Origin)。尽管Single-Page App不包含后端，但其依然会挂在一个服务器上以支持用户访问，这个服务器的Host就是Web Origin</p>\n</li>\n<li><p> <strong>Allowed API</strong>：支持跨域访问的API</p>\n</li>\n</ul>\n</blockquote>\n<p>以下为Okta和Auth0对两种配置的支持情况：</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">Okta</th>\n<th align=\"center\">Auth0</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Allowed Web Origins</td>\n<td align=\"center\">✅</td>\n<td align=\"center\">✅</td>\n</tr>\n<tr>\n<td align=\"center\">Allowed API</td>\n<td align=\"center\">✅</td>\n<td align=\"center\">⭕️</td>\n</tr>\n</tbody></table>\n<p>对于Js sdk，需对跨域访问的请求头进行配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">referrer : Web Origin/path</span><br><span class=\"line\">origin : Web Origin</span><br></pre></td></tr></table></figure>\n\n<p>此外，需针对Token的存储模式提供安全保障，例如localstorage和设定过期策略。<br>（Okta和Auth0的整个跨域支持逻辑比较复杂，暂未弄清整个流程全部细节）</p>\n<h2 id=\"Okta对跨域问题的支持\"><a href=\"#Okta对跨域问题的支持\" class=\"headerlink\" title=\"Okta对跨域问题的支持\"></a>Okta对跨域问题的支持</h2><p>Okta跨域配置教程：<a href=\"https://developer.okta.com/docs/guides/enable-cors/main/\">https://developer.okta.com/docs/guides/enable-cors/main/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png\" alt=\"截屏2022-12-01 19.50.59\"></p>\n<p>Okta js sdk repo：<a href=\"https://github.com/okta/okta-auth-js\">https://github.com/okta/okta-auth-js</a><br>Okta js sdk教程：<a href=\"https://developer.okta.com/docs/guides/auth-js/main/\">https://developer.okta.com/docs/guides/auth-js/main/</a></p>\n<h2 id=\"Auth0对跨域问题的支持\"><a href=\"#Auth0对跨域问题的支持\" class=\"headerlink\" title=\"Auth0对跨域问题的支持\"></a>Auth0对跨域问题的支持</h2><p>Auth0 js sdk教程：<a href=\"https://auth0.com/docs/quickstart/spa/vanillajs/interactive\">https://auth0.com/docs/quickstart/spa/vanillajs/interactive</a></p>\n<p><img src=\"https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.48.51.png?raw=true\" alt=\"截屏2022-12-01 19.48.51\"></p>\n<p>Auth0 js sdk: <a href=\"https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js\">https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>由于Casdoor Flutter Sdk遇到了跨域问题，故调研Okta和Auth0的跨域问题的解决方案，方案初步整理如下：</p>\n<h2 id=\"解决策略\"><a href=\"#解决策略\" class=\"headerlink\" title=\"解决策略\"></a>解决策略</h2><p>在单点登录系统中，Single-Page App需要从浏览器跨域访问SSO服务器。为支持这一需求，单点登录系统应支持配置“Allowed Web Origins”和“Allowed API”。SSO服务可以根据这两个配置对跨域请求进行校验。</p>\n<blockquote>\n<p>定义：</p>\n<ul>\n<li><p><strong>Single-Page App</strong>：单页应用。为不包含后端的纯web页面</p>\n</li>\n<li><p><strong>Allowed Web Origins</strong>：允许跨域访问的网络源(Web Origin)。尽管Single-Page App不包含后端，但其依然会挂在一个服务器上以支持用户访问，这个服务器的Host就是Web Origin</p>\n</li>\n<li><p> <strong>Allowed API</strong>：支持跨域访问的API</p>\n</li>\n</ul>\n</blockquote>\n<p>以下为Okta和Auth0对两种配置的支持情况：</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">Okta</th>\n<th align=\"center\">Auth0</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Allowed Web Origins</td>\n<td align=\"center\">✅</td>\n<td align=\"center\">✅</td>\n</tr>\n<tr>\n<td align=\"center\">Allowed API</td>\n<td align=\"center\">✅</td>\n<td align=\"center\">⭕️</td>\n</tr>\n</tbody></table>\n<p>对于Js sdk，需对跨域访问的请求头进行配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">referrer : Web Origin/path</span><br><span class=\"line\">origin : Web Origin</span><br></pre></td></tr></table></figure>\n\n<p>此外，需针对Token的存储模式提供安全保障，例如localstorage和设定过期策略。<br>（Okta和Auth0的整个跨域支持逻辑比较复杂，暂未弄清整个流程全部细节）</p>\n<h2 id=\"Okta对跨域问题的支持\"><a href=\"#Okta对跨域问题的支持\" class=\"headerlink\" title=\"Okta对跨域问题的支持\"></a>Okta对跨域问题的支持</h2><p>Okta跨域配置教程：<a href=\"https://developer.okta.com/docs/guides/enable-cors/main/\">https://developer.okta.com/docs/guides/enable-cors/main/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.50.59.png\" alt=\"截屏2022-12-01 19.50.59\"></p>\n<p>Okta js sdk repo：<a href=\"https://github.com/okta/okta-auth-js\">https://github.com/okta/okta-auth-js</a><br>Okta js sdk教程：<a href=\"https://developer.okta.com/docs/guides/auth-js/main/\">https://developer.okta.com/docs/guides/auth-js/main/</a></p>\n<h2 id=\"Auth0对跨域问题的支持\"><a href=\"#Auth0对跨域问题的支持\" class=\"headerlink\" title=\"Auth0对跨域问题的支持\"></a>Auth0对跨域问题的支持</h2><p>Auth0 js sdk教程：<a href=\"https://auth0.com/docs/quickstart/spa/vanillajs/interactive\">https://auth0.com/docs/quickstart/spa/vanillajs/interactive</a></p>\n<p><img src=\"https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2022-12-01%2019.48.51.png?raw=true\" alt=\"截屏2022-12-01 19.48.51\"></p>\n<p>Auth0 js sdk: <a href=\"https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js\">https://github.com/auth0/auth0.js/blob/master/src/web-auth/cross-origin-authentication.js</a></p>\n"},{"title":"Faasm / WASM serverless","date":"2023-02-06T03:50:33.000Z","_content":"\n论文地址：https://arxiv.org/abs/2002.09344\n\n## Faaslet/Faasm总结\n\n### 1）Faaslet\n\nFaaslet是一种software-based isolation。这是一种用于高性能无服务计算的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，*software-fault isolation*, provided by *WebAssembly*）来隔离已执行函数的内存，并允许同一地址空间的函数之间共享内存区域。\n\nFaaslet具有以下几个特性：\n\n1. [隔离](#is)：每个fasslet由一个thread进行执行，利用CGroup进行约束\n2. 为实现高效的Function间通信，1）提供本地[共享内存机制](#memy)（由WASM的特性保证内存安全，[WASM内存模型](https://zhuanlan.zhihu.com/p/386849387)）。2）同时提供由distributed key-value store (KVS，Redis)支持的全局状态共享\n3. 为了Function可以**安全**且**高效**的进行功能调用，实现了[Host interface](#inter) API（类[POSIX](https://zh.wikipedia.org/wiki/可移植操作系统接口)的子集，基于WASI），function可以调用API以使用各种系统功能（相当于在函数和os之间加了一层抽象层，实现了低水平的虚拟化）。使用message bus与父进程通信，接收函数调用、共享、调用和等待其他函数等信息\n4. 快速启动，Faasm使用存储在对象存储中的Proto-Faaslet快照优化冷启动时间 。\n\n![截屏2023-02-06 12.58.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png)\n\n### 2）Faasm\n\nFaasm是一个负责调度Faaslet的runtime。Faasm可以管理多个Faaslet。Faasm通过Faaslet的状态共享机制进行调度。\n\n如下图，ABC三个函数调用事件，Faasm instance1具有实例A，因此直接执行。Faasm instance1 缺少BC实例，为了避免冷启动，则将BC任务共享到Faasm instance2.\n\n![截屏2023-02-06 14.19.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png)\n\n此外，Faasm使用LLVM编译function，用WAVM进行执行。\n\n>编译过程：\n>(1) 用户调用Faaslet工具链将函数编译成WebAssembly二进制文件，链接到Faaslet host interface的特定语言声明;\n>(2) 生成一个由WebAssembly创建的“object file with machine code”\n>(3) Host interface与machine code链接以生成Faaslet可执行文件（Faaslet executable）\n\n\n\n## 如何基于WASM设计一个serverless平台\n\n由于WASM具有**内存安全**的特性，使用WASM实现轻量级的隔离，以取得较高的性能：\n\n1. 将用户function编译成WebAssembly，采用WASM runtime（例如WAVM）对function进行**执行**。\n2. **执行**操作由“调度器”进行（Faasm），“调度器”使用一个“执行线程”进行function执行和调度，并使用CGroup对“执行线程”进行约束。\n3. 为了实现完整的serverless平台，例如提供io调用、function间状态共享，需要加入相应的API支持（Faaalets提供了相应的API——Host interface），供用户function调用。\n\n----\n\n_细节部分_:\n\n## Faaslet概述\n\nFaaslet是一种software-based isolation。这是一种用于高性能无服务器计算的新的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，*software-fault isolation* (SFI), provided by *WebAssembly*）来隔离已执行函数的内存，同时允许同一地址空间的函数之间共享内存区域。\n\n FAASM是一个基于Faaslet的runtime，使用标准的Linux cgroups隔离其他资源，如CPU和网络。并为网络、文件系统访问和动态加载提供一个低级别的POSIX主机接口\n\n> 现在的容器/vm，启动慢，内存占用大\n\n无服务器计算可以通过一种新的isolation abstraction，以更好地支持数据密集型应用程序：\n\n(i) 在函数之间，提供强的**内存和资源隔离**，保证安全性\n(ii) 支持高效的**状态共享**。数据应该与功能共存（co-located），并直接获取，尽量减少数据运输\n(iii) 允许在多个主机上扩展状态\n(iv) 低内存消耗，允许在一台机器上有许多实例；\n(v) 快速的实例化\n(vi) 支持多种编程语言\n\n为了实现以上特性，Faaslet具有以下特性：\n\n1. **Faasles轻量级的隔离**\n    Faaslet依赖于软件故障隔离（SFI），它将函数限制在对其自身内存的访问。一个与Faaslet函数，连同其库和语言运行时的依赖，被编译成WebAssembly。FAASM运行时在一个地址空间内执行多个Faaslet，每个都有一个专用线程。为了实现资源隔离，每个线程的CPU周期使用Linux cgroups进行约束，网络访问使用“*network namespaces*”和“*traffic shaping*”进行限制。\n2. **faaslet 高效本地/全局状态访问**\n    由于faaslet共享相同的地址空间，它们可以有效地使用本地状态访问共享内存区域。这允许数据和函数的共同定位，并避免串行化的开销。faaslet使用两层状态架构，本地层提供内存共享，全局层支持跨主机分布式访问状态。\n    Faasm运行时为Faaslet提供了一个状态管理API，可以对两层的状态进行细粒度控制。\n3. **faaslet快速初始化**\n    为了减少Faaslet第一次执行时的冷启动时间，Faaslet从suspended state启动\n    suspended state：FAASM预先初始化一个Faaslet，并对其内存进行快照以获得一个原始Faaslet。proto-Faaslet用于快速创建新的Faaslet实例，可以避免初始化语言运行库的时间。理论上proto - faaslet支持跨主机恢复，并且与操作系统无关。\n    （这一块类似MITOSIS，是直接使用了从内存恢复运行状态）\n4. **Faaslet Host interface**\n    Faaslet通过POSIX-like calls与主机环境进行交互。包括网络、文件I/O、全局状态访问和库加载/链接。主机接口提供了足够的虚拟化以确保隔离，同时增加的开销可以忽略不计。\n\nFAASM runtime使用LLVM编译器工具链将应用程序转换为WebAssembly，这一方法支持用多种编程语言编写的函数。可现有的无服务器平台集成，例如Knative。\n\n## Faaslet detail design\n\n![截屏2023-02-06 12.58.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png)\n\n1. <a id=\"memy\">内存设计</a>：函数被编译为WebAssembly，被放置在它自己的私有连续内存区域中。同时Faaslet也支持共享内存区域，这允许Faaslet在WebAssembly的内存安全保证的约束下访问共享的内存状态(当需要内存共享时，Faaslet扩展WASM的字节数组，但将新页面映射到公共进程内存的指定区域（mmap）。然后可以给函数一个指向字节数组新区域的指针，但所有访问都在共享区域上执行)。\n    ![截屏2023-02-06 15.22.09](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png)\n\n    \n\n2. <a id=\"is\">隔离</a>：faaslet确保了公平的资源访问。对于CPU隔离，使用“Linux cgroups的CPU子集”。每个函数都由共享运行时进程的专用线程执行，这个线程被分配了一个cgroup。\n\n3. IO接口：Faaslet通过网络命名空间、虚拟网络接口和流量整形实现安全公平的网络访问。每个Faaslet在单独的名称空间中都有自己的网络接口，使用iptables规则进行配置。为了确保共享租户之间的公平性，每个Faaslet使用tc在其虚拟网络接口上应用流量整形，从而强制执行入口和出口流量速率限制。\n\n4. <a id=\"inter\">Faaslet host interface</a>：Faaslet host interface是一个virtualisation layer，提供了一系列API，以隔离函数于外界环境。这些接口基于WASI（这个设计有点类似gVisor，但是gVisor是模拟了整个内核）\n\n![截屏2023-02-06 13.15.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png)\n\n5. Faaslet使用message bus与父进程（Faasm）通信，接收函数调用，共享工作，调用和等待其他函数等信息。\n5. Proto Faaslet快照包括函数的堆栈，WebAssembly规范的函数表、堆栈指针和数据。Faasm使用copy-on-write memory mapping将快照还原到新的Faaslet中。Faasm提供了一个Http end point，例如s3，以供上传快照.\n\n## Faaslet状态共享\n\nFaaslet提供了两层架构的状态共享机制，这一机制可帮助实现Faasm的调度。\n\n本地层：提供对同一主机上的状态的共享内存访问;\n\n全局层：允许Faaslet在主机间同步状态。全局层使用distributed key-value store (KVS)实现，具体实现方式是redis。\n\nDDOs隐藏了两层状态架构，提供了对分布式数据的透明的访问。\n\n![截屏2023-02-06 18.31.18](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png)\n","source":"_posts/Faasm-WASM-serverless.md","raw":"---\ntitle: Faasm / WASM serverless\ndate: 2023-02-06 11:50:33\ntags:\n---\n\n论文地址：https://arxiv.org/abs/2002.09344\n\n## Faaslet/Faasm总结\n\n### 1）Faaslet\n\nFaaslet是一种software-based isolation。这是一种用于高性能无服务计算的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，*software-fault isolation*, provided by *WebAssembly*）来隔离已执行函数的内存，并允许同一地址空间的函数之间共享内存区域。\n\nFaaslet具有以下几个特性：\n\n1. [隔离](#is)：每个fasslet由一个thread进行执行，利用CGroup进行约束\n2. 为实现高效的Function间通信，1）提供本地[共享内存机制](#memy)（由WASM的特性保证内存安全，[WASM内存模型](https://zhuanlan.zhihu.com/p/386849387)）。2）同时提供由distributed key-value store (KVS，Redis)支持的全局状态共享\n3. 为了Function可以**安全**且**高效**的进行功能调用，实现了[Host interface](#inter) API（类[POSIX](https://zh.wikipedia.org/wiki/可移植操作系统接口)的子集，基于WASI），function可以调用API以使用各种系统功能（相当于在函数和os之间加了一层抽象层，实现了低水平的虚拟化）。使用message bus与父进程通信，接收函数调用、共享、调用和等待其他函数等信息\n4. 快速启动，Faasm使用存储在对象存储中的Proto-Faaslet快照优化冷启动时间 。\n\n![截屏2023-02-06 12.58.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png)\n\n### 2）Faasm\n\nFaasm是一个负责调度Faaslet的runtime。Faasm可以管理多个Faaslet。Faasm通过Faaslet的状态共享机制进行调度。\n\n如下图，ABC三个函数调用事件，Faasm instance1具有实例A，因此直接执行。Faasm instance1 缺少BC实例，为了避免冷启动，则将BC任务共享到Faasm instance2.\n\n![截屏2023-02-06 14.19.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png)\n\n此外，Faasm使用LLVM编译function，用WAVM进行执行。\n\n>编译过程：\n>(1) 用户调用Faaslet工具链将函数编译成WebAssembly二进制文件，链接到Faaslet host interface的特定语言声明;\n>(2) 生成一个由WebAssembly创建的“object file with machine code”\n>(3) Host interface与machine code链接以生成Faaslet可执行文件（Faaslet executable）\n\n\n\n## 如何基于WASM设计一个serverless平台\n\n由于WASM具有**内存安全**的特性，使用WASM实现轻量级的隔离，以取得较高的性能：\n\n1. 将用户function编译成WebAssembly，采用WASM runtime（例如WAVM）对function进行**执行**。\n2. **执行**操作由“调度器”进行（Faasm），“调度器”使用一个“执行线程”进行function执行和调度，并使用CGroup对“执行线程”进行约束。\n3. 为了实现完整的serverless平台，例如提供io调用、function间状态共享，需要加入相应的API支持（Faaalets提供了相应的API——Host interface），供用户function调用。\n\n----\n\n_细节部分_:\n\n## Faaslet概述\n\nFaaslet是一种software-based isolation。这是一种用于高性能无服务器计算的新的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，*software-fault isolation* (SFI), provided by *WebAssembly*）来隔离已执行函数的内存，同时允许同一地址空间的函数之间共享内存区域。\n\n FAASM是一个基于Faaslet的runtime，使用标准的Linux cgroups隔离其他资源，如CPU和网络。并为网络、文件系统访问和动态加载提供一个低级别的POSIX主机接口\n\n> 现在的容器/vm，启动慢，内存占用大\n\n无服务器计算可以通过一种新的isolation abstraction，以更好地支持数据密集型应用程序：\n\n(i) 在函数之间，提供强的**内存和资源隔离**，保证安全性\n(ii) 支持高效的**状态共享**。数据应该与功能共存（co-located），并直接获取，尽量减少数据运输\n(iii) 允许在多个主机上扩展状态\n(iv) 低内存消耗，允许在一台机器上有许多实例；\n(v) 快速的实例化\n(vi) 支持多种编程语言\n\n为了实现以上特性，Faaslet具有以下特性：\n\n1. **Faasles轻量级的隔离**\n    Faaslet依赖于软件故障隔离（SFI），它将函数限制在对其自身内存的访问。一个与Faaslet函数，连同其库和语言运行时的依赖，被编译成WebAssembly。FAASM运行时在一个地址空间内执行多个Faaslet，每个都有一个专用线程。为了实现资源隔离，每个线程的CPU周期使用Linux cgroups进行约束，网络访问使用“*network namespaces*”和“*traffic shaping*”进行限制。\n2. **faaslet 高效本地/全局状态访问**\n    由于faaslet共享相同的地址空间，它们可以有效地使用本地状态访问共享内存区域。这允许数据和函数的共同定位，并避免串行化的开销。faaslet使用两层状态架构，本地层提供内存共享，全局层支持跨主机分布式访问状态。\n    Faasm运行时为Faaslet提供了一个状态管理API，可以对两层的状态进行细粒度控制。\n3. **faaslet快速初始化**\n    为了减少Faaslet第一次执行时的冷启动时间，Faaslet从suspended state启动\n    suspended state：FAASM预先初始化一个Faaslet，并对其内存进行快照以获得一个原始Faaslet。proto-Faaslet用于快速创建新的Faaslet实例，可以避免初始化语言运行库的时间。理论上proto - faaslet支持跨主机恢复，并且与操作系统无关。\n    （这一块类似MITOSIS，是直接使用了从内存恢复运行状态）\n4. **Faaslet Host interface**\n    Faaslet通过POSIX-like calls与主机环境进行交互。包括网络、文件I/O、全局状态访问和库加载/链接。主机接口提供了足够的虚拟化以确保隔离，同时增加的开销可以忽略不计。\n\nFAASM runtime使用LLVM编译器工具链将应用程序转换为WebAssembly，这一方法支持用多种编程语言编写的函数。可现有的无服务器平台集成，例如Knative。\n\n## Faaslet detail design\n\n![截屏2023-02-06 12.58.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png)\n\n1. <a id=\"memy\">内存设计</a>：函数被编译为WebAssembly，被放置在它自己的私有连续内存区域中。同时Faaslet也支持共享内存区域，这允许Faaslet在WebAssembly的内存安全保证的约束下访问共享的内存状态(当需要内存共享时，Faaslet扩展WASM的字节数组，但将新页面映射到公共进程内存的指定区域（mmap）。然后可以给函数一个指向字节数组新区域的指针，但所有访问都在共享区域上执行)。\n    ![截屏2023-02-06 15.22.09](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png)\n\n    \n\n2. <a id=\"is\">隔离</a>：faaslet确保了公平的资源访问。对于CPU隔离，使用“Linux cgroups的CPU子集”。每个函数都由共享运行时进程的专用线程执行，这个线程被分配了一个cgroup。\n\n3. IO接口：Faaslet通过网络命名空间、虚拟网络接口和流量整形实现安全公平的网络访问。每个Faaslet在单独的名称空间中都有自己的网络接口，使用iptables规则进行配置。为了确保共享租户之间的公平性，每个Faaslet使用tc在其虚拟网络接口上应用流量整形，从而强制执行入口和出口流量速率限制。\n\n4. <a id=\"inter\">Faaslet host interface</a>：Faaslet host interface是一个virtualisation layer，提供了一系列API，以隔离函数于外界环境。这些接口基于WASI（这个设计有点类似gVisor，但是gVisor是模拟了整个内核）\n\n![截屏2023-02-06 13.15.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png)\n\n5. Faaslet使用message bus与父进程（Faasm）通信，接收函数调用，共享工作，调用和等待其他函数等信息。\n5. Proto Faaslet快照包括函数的堆栈，WebAssembly规范的函数表、堆栈指针和数据。Faasm使用copy-on-write memory mapping将快照还原到新的Faaslet中。Faasm提供了一个Http end point，例如s3，以供上传快照.\n\n## Faaslet状态共享\n\nFaaslet提供了两层架构的状态共享机制，这一机制可帮助实现Faasm的调度。\n\n本地层：提供对同一主机上的状态的共享内存访问;\n\n全局层：允许Faaslet在主机间同步状态。全局层使用distributed key-value store (KVS)实现，具体实现方式是redis。\n\nDDOs隐藏了两层状态架构，提供了对分布式数据的透明的访问。\n\n![截屏2023-02-06 18.31.18](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png)\n","slug":"Faasm-WASM-serverless","published":1,"updated":"2023-02-06T13:25:14.696Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9v000bb9c9b0tt5s3y","content":"<p>论文地址：<a href=\"https://arxiv.org/abs/2002.09344\">https://arxiv.org/abs/2002.09344</a></p>\n<h2 id=\"Faaslet-Faasm总结\"><a href=\"#Faaslet-Faasm总结\" class=\"headerlink\" title=\"Faaslet/Faasm总结\"></a>Faaslet/Faasm总结</h2><h3 id=\"1）Faaslet\"><a href=\"#1）Faaslet\" class=\"headerlink\" title=\"1）Faaslet\"></a>1）Faaslet</h3><p>Faaslet是一种software-based isolation。这是一种用于高性能无服务计算的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，<em>software-fault isolation</em>, provided by <em>WebAssembly</em>）来隔离已执行函数的内存，并允许同一地址空间的函数之间共享内存区域。</p>\n<p>Faaslet具有以下几个特性：</p>\n<ol>\n<li><a href=\"#is\">隔离</a>：每个fasslet由一个thread进行执行，利用CGroup进行约束</li>\n<li>为实现高效的Function间通信，1）提供本地<a href=\"#memy\">共享内存机制</a>（由WASM的特性保证内存安全，<a href=\"https://zhuanlan.zhihu.com/p/386849387\">WASM内存模型</a>）。2）同时提供由distributed key-value store (KVS，Redis)支持的全局状态共享</li>\n<li>为了Function可以<strong>安全</strong>且<strong>高效</strong>的进行功能调用，实现了<a href=\"#inter\">Host interface</a> API（类<a href=\"https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3\">POSIX</a>的子集，基于WASI），function可以调用API以使用各种系统功能（相当于在函数和os之间加了一层抽象层，实现了低水平的虚拟化）。使用message bus与父进程通信，接收函数调用、共享、调用和等待其他函数等信息</li>\n<li>快速启动，Faasm使用存储在对象存储中的Proto-Faaslet快照优化冷启动时间 。</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png\" alt=\"截屏2023-02-06 12.58.20\"></p>\n<h3 id=\"2）Faasm\"><a href=\"#2）Faasm\" class=\"headerlink\" title=\"2）Faasm\"></a>2）Faasm</h3><p>Faasm是一个负责调度Faaslet的runtime。Faasm可以管理多个Faaslet。Faasm通过Faaslet的状态共享机制进行调度。</p>\n<p>如下图，ABC三个函数调用事件，Faasm instance1具有实例A，因此直接执行。Faasm instance1 缺少BC实例，为了避免冷启动，则将BC任务共享到Faasm instance2.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png\" alt=\"截屏2023-02-06 14.19.51\"></p>\n<p>此外，Faasm使用LLVM编译function，用WAVM进行执行。</p>\n<blockquote>\n<p>编译过程：<br>(1) 用户调用Faaslet工具链将函数编译成WebAssembly二进制文件，链接到Faaslet host interface的特定语言声明;<br>(2) 生成一个由WebAssembly创建的“object file with machine code”<br>(3) Host interface与machine code链接以生成Faaslet可执行文件（Faaslet executable）</p>\n</blockquote>\n<h2 id=\"如何基于WASM设计一个serverless平台\"><a href=\"#如何基于WASM设计一个serverless平台\" class=\"headerlink\" title=\"如何基于WASM设计一个serverless平台\"></a>如何基于WASM设计一个serverless平台</h2><p>由于WASM具有<strong>内存安全</strong>的特性，使用WASM实现轻量级的隔离，以取得较高的性能：</p>\n<ol>\n<li>将用户function编译成WebAssembly，采用WASM runtime（例如WAVM）对function进行<strong>执行</strong>。</li>\n<li><strong>执行</strong>操作由“调度器”进行（Faasm），“调度器”使用一个“执行线程”进行function执行和调度，并使用CGroup对“执行线程”进行约束。</li>\n<li>为了实现完整的serverless平台，例如提供io调用、function间状态共享，需要加入相应的API支持（Faaalets提供了相应的API——Host interface），供用户function调用。</li>\n</ol>\n<hr>\n<p><em>细节部分</em>:</p>\n<h2 id=\"Faaslet概述\"><a href=\"#Faaslet概述\" class=\"headerlink\" title=\"Faaslet概述\"></a>Faaslet概述</h2><p>Faaslet是一种software-based isolation。这是一种用于高性能无服务器计算的新的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，<em>software-fault isolation</em> (SFI), provided by <em>WebAssembly</em>）来隔离已执行函数的内存，同时允许同一地址空间的函数之间共享内存区域。</p>\n<p> FAASM是一个基于Faaslet的runtime，使用标准的Linux cgroups隔离其他资源，如CPU和网络。并为网络、文件系统访问和动态加载提供一个低级别的POSIX主机接口</p>\n<blockquote>\n<p>现在的容器/vm，启动慢，内存占用大</p>\n</blockquote>\n<p>无服务器计算可以通过一种新的isolation abstraction，以更好地支持数据密集型应用程序：</p>\n<p>(i) 在函数之间，提供强的<strong>内存和资源隔离</strong>，保证安全性<br>(ii) 支持高效的<strong>状态共享</strong>。数据应该与功能共存（co-located），并直接获取，尽量减少数据运输<br>(iii) 允许在多个主机上扩展状态<br>(iv) 低内存消耗，允许在一台机器上有许多实例；<br>(v) 快速的实例化<br>(vi) 支持多种编程语言</p>\n<p>为了实现以上特性，Faaslet具有以下特性：</p>\n<ol>\n<li><strong>Faasles轻量级的隔离</strong><br> Faaslet依赖于软件故障隔离（SFI），它将函数限制在对其自身内存的访问。一个与Faaslet函数，连同其库和语言运行时的依赖，被编译成WebAssembly。FAASM运行时在一个地址空间内执行多个Faaslet，每个都有一个专用线程。为了实现资源隔离，每个线程的CPU周期使用Linux cgroups进行约束，网络访问使用“<em>network namespaces</em>”和“<em>traffic shaping</em>”进行限制。</li>\n<li><strong>faaslet 高效本地/全局状态访问</strong><br> 由于faaslet共享相同的地址空间，它们可以有效地使用本地状态访问共享内存区域。这允许数据和函数的共同定位，并避免串行化的开销。faaslet使用两层状态架构，本地层提供内存共享，全局层支持跨主机分布式访问状态。<br> Faasm运行时为Faaslet提供了一个状态管理API，可以对两层的状态进行细粒度控制。</li>\n<li><strong>faaslet快速初始化</strong><br> 为了减少Faaslet第一次执行时的冷启动时间，Faaslet从suspended state启动<br> suspended state：FAASM预先初始化一个Faaslet，并对其内存进行快照以获得一个原始Faaslet。proto-Faaslet用于快速创建新的Faaslet实例，可以避免初始化语言运行库的时间。理论上proto - faaslet支持跨主机恢复，并且与操作系统无关。<br> （这一块类似MITOSIS，是直接使用了从内存恢复运行状态）</li>\n<li><strong>Faaslet Host interface</strong><br> Faaslet通过POSIX-like calls与主机环境进行交互。包括网络、文件I/O、全局状态访问和库加载/链接。主机接口提供了足够的虚拟化以确保隔离，同时增加的开销可以忽略不计。</li>\n</ol>\n<p>FAASM runtime使用LLVM编译器工具链将应用程序转换为WebAssembly，这一方法支持用多种编程语言编写的函数。可现有的无服务器平台集成，例如Knative。</p>\n<h2 id=\"Faaslet-detail-design\"><a href=\"#Faaslet-detail-design\" class=\"headerlink\" title=\"Faaslet detail design\"></a>Faaslet detail design</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png\" alt=\"截屏2023-02-06 12.58.20\"></p>\n<ol>\n<li><p><a id=\"memy\">内存设计</a>：函数被编译为WebAssembly，被放置在它自己的私有连续内存区域中。同时Faaslet也支持共享内存区域，这允许Faaslet在WebAssembly的内存安全保证的约束下访问共享的内存状态(当需要内存共享时，Faaslet扩展WASM的字节数组，但将新页面映射到公共进程内存的指定区域（mmap）。然后可以给函数一个指向字节数组新区域的指针，但所有访问都在共享区域上执行)。<br> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png\" alt=\"截屏2023-02-06 15.22.09\"></p>\n</li>\n<li><p><a id=\"is\">隔离</a>：faaslet确保了公平的资源访问。对于CPU隔离，使用“Linux cgroups的CPU子集”。每个函数都由共享运行时进程的专用线程执行，这个线程被分配了一个cgroup。</p>\n</li>\n<li><p>IO接口：Faaslet通过网络命名空间、虚拟网络接口和流量整形实现安全公平的网络访问。每个Faaslet在单独的名称空间中都有自己的网络接口，使用iptables规则进行配置。为了确保共享租户之间的公平性，每个Faaslet使用tc在其虚拟网络接口上应用流量整形，从而强制执行入口和出口流量速率限制。</p>\n</li>\n<li><p><a id=\"inter\">Faaslet host interface</a>：Faaslet host interface是一个virtualisation layer，提供了一系列API，以隔离函数于外界环境。这些接口基于WASI（这个设计有点类似gVisor，但是gVisor是模拟了整个内核）</p>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png\" alt=\"截屏2023-02-06 13.15.25\"></p>\n<ol start=\"5\">\n<li>Faaslet使用message bus与父进程（Faasm）通信，接收函数调用，共享工作，调用和等待其他函数等信息。</li>\n<li>Proto Faaslet快照包括函数的堆栈，WebAssembly规范的函数表、堆栈指针和数据。Faasm使用copy-on-write memory mapping将快照还原到新的Faaslet中。Faasm提供了一个Http end point，例如s3，以供上传快照.</li>\n</ol>\n<h2 id=\"Faaslet状态共享\"><a href=\"#Faaslet状态共享\" class=\"headerlink\" title=\"Faaslet状态共享\"></a>Faaslet状态共享</h2><p>Faaslet提供了两层架构的状态共享机制，这一机制可帮助实现Faasm的调度。</p>\n<p>本地层：提供对同一主机上的状态的共享内存访问;</p>\n<p>全局层：允许Faaslet在主机间同步状态。全局层使用distributed key-value store (KVS)实现，具体实现方式是redis。</p>\n<p>DDOs隐藏了两层状态架构，提供了对分布式数据的透明的访问。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png\" alt=\"截屏2023-02-06 18.31.18\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>论文地址：<a href=\"https://arxiv.org/abs/2002.09344\">https://arxiv.org/abs/2002.09344</a></p>\n<h2 id=\"Faaslet-Faasm总结\"><a href=\"#Faaslet-Faasm总结\" class=\"headerlink\" title=\"Faaslet/Faasm总结\"></a>Faaslet/Faasm总结</h2><h3 id=\"1）Faaslet\"><a href=\"#1）Faaslet\" class=\"headerlink\" title=\"1）Faaslet\"></a>1）Faaslet</h3><p>Faaslet是一种software-based isolation。这是一种用于高性能无服务计算的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，<em>software-fault isolation</em>, provided by <em>WebAssembly</em>）来隔离已执行函数的内存，并允许同一地址空间的函数之间共享内存区域。</p>\n<p>Faaslet具有以下几个特性：</p>\n<ol>\n<li><a href=\"#is\">隔离</a>：每个fasslet由一个thread进行执行，利用CGroup进行约束</li>\n<li>为实现高效的Function间通信，1）提供本地<a href=\"#memy\">共享内存机制</a>（由WASM的特性保证内存安全，<a href=\"https://zhuanlan.zhihu.com/p/386849387\">WASM内存模型</a>）。2）同时提供由distributed key-value store (KVS，Redis)支持的全局状态共享</li>\n<li>为了Function可以<strong>安全</strong>且<strong>高效</strong>的进行功能调用，实现了<a href=\"#inter\">Host interface</a> API（类<a href=\"https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3\">POSIX</a>的子集，基于WASI），function可以调用API以使用各种系统功能（相当于在函数和os之间加了一层抽象层，实现了低水平的虚拟化）。使用message bus与父进程通信，接收函数调用、共享、调用和等待其他函数等信息</li>\n<li>快速启动，Faasm使用存储在对象存储中的Proto-Faaslet快照优化冷启动时间 。</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png\" alt=\"截屏2023-02-06 12.58.20\"></p>\n<h3 id=\"2）Faasm\"><a href=\"#2）Faasm\" class=\"headerlink\" title=\"2）Faasm\"></a>2）Faasm</h3><p>Faasm是一个负责调度Faaslet的runtime。Faasm可以管理多个Faaslet。Faasm通过Faaslet的状态共享机制进行调度。</p>\n<p>如下图，ABC三个函数调用事件，Faasm instance1具有实例A，因此直接执行。Faasm instance1 缺少BC实例，为了避免冷启动，则将BC任务共享到Faasm instance2.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2014.19.51.png\" alt=\"截屏2023-02-06 14.19.51\"></p>\n<p>此外，Faasm使用LLVM编译function，用WAVM进行执行。</p>\n<blockquote>\n<p>编译过程：<br>(1) 用户调用Faaslet工具链将函数编译成WebAssembly二进制文件，链接到Faaslet host interface的特定语言声明;<br>(2) 生成一个由WebAssembly创建的“object file with machine code”<br>(3) Host interface与machine code链接以生成Faaslet可执行文件（Faaslet executable）</p>\n</blockquote>\n<h2 id=\"如何基于WASM设计一个serverless平台\"><a href=\"#如何基于WASM设计一个serverless平台\" class=\"headerlink\" title=\"如何基于WASM设计一个serverless平台\"></a>如何基于WASM设计一个serverless平台</h2><p>由于WASM具有<strong>内存安全</strong>的特性，使用WASM实现轻量级的隔离，以取得较高的性能：</p>\n<ol>\n<li>将用户function编译成WebAssembly，采用WASM runtime（例如WAVM）对function进行<strong>执行</strong>。</li>\n<li><strong>执行</strong>操作由“调度器”进行（Faasm），“调度器”使用一个“执行线程”进行function执行和调度，并使用CGroup对“执行线程”进行约束。</li>\n<li>为了实现完整的serverless平台，例如提供io调用、function间状态共享，需要加入相应的API支持（Faaalets提供了相应的API——Host interface），供用户function调用。</li>\n</ol>\n<hr>\n<p><em>细节部分</em>:</p>\n<h2 id=\"Faaslet概述\"><a href=\"#Faaslet概述\" class=\"headerlink\" title=\"Faaslet概述\"></a>Faaslet概述</h2><p>Faaslet是一种software-based isolation。这是一种用于高性能无服务器计算的新的隔离抽象。Faaslet使用WebAssembly提供的软件故障隔离（SFI，<em>software-fault isolation</em> (SFI), provided by <em>WebAssembly</em>）来隔离已执行函数的内存，同时允许同一地址空间的函数之间共享内存区域。</p>\n<p> FAASM是一个基于Faaslet的runtime，使用标准的Linux cgroups隔离其他资源，如CPU和网络。并为网络、文件系统访问和动态加载提供一个低级别的POSIX主机接口</p>\n<blockquote>\n<p>现在的容器/vm，启动慢，内存占用大</p>\n</blockquote>\n<p>无服务器计算可以通过一种新的isolation abstraction，以更好地支持数据密集型应用程序：</p>\n<p>(i) 在函数之间，提供强的<strong>内存和资源隔离</strong>，保证安全性<br>(ii) 支持高效的<strong>状态共享</strong>。数据应该与功能共存（co-located），并直接获取，尽量减少数据运输<br>(iii) 允许在多个主机上扩展状态<br>(iv) 低内存消耗，允许在一台机器上有许多实例；<br>(v) 快速的实例化<br>(vi) 支持多种编程语言</p>\n<p>为了实现以上特性，Faaslet具有以下特性：</p>\n<ol>\n<li><strong>Faasles轻量级的隔离</strong><br> Faaslet依赖于软件故障隔离（SFI），它将函数限制在对其自身内存的访问。一个与Faaslet函数，连同其库和语言运行时的依赖，被编译成WebAssembly。FAASM运行时在一个地址空间内执行多个Faaslet，每个都有一个专用线程。为了实现资源隔离，每个线程的CPU周期使用Linux cgroups进行约束，网络访问使用“<em>network namespaces</em>”和“<em>traffic shaping</em>”进行限制。</li>\n<li><strong>faaslet 高效本地/全局状态访问</strong><br> 由于faaslet共享相同的地址空间，它们可以有效地使用本地状态访问共享内存区域。这允许数据和函数的共同定位，并避免串行化的开销。faaslet使用两层状态架构，本地层提供内存共享，全局层支持跨主机分布式访问状态。<br> Faasm运行时为Faaslet提供了一个状态管理API，可以对两层的状态进行细粒度控制。</li>\n<li><strong>faaslet快速初始化</strong><br> 为了减少Faaslet第一次执行时的冷启动时间，Faaslet从suspended state启动<br> suspended state：FAASM预先初始化一个Faaslet，并对其内存进行快照以获得一个原始Faaslet。proto-Faaslet用于快速创建新的Faaslet实例，可以避免初始化语言运行库的时间。理论上proto - faaslet支持跨主机恢复，并且与操作系统无关。<br> （这一块类似MITOSIS，是直接使用了从内存恢复运行状态）</li>\n<li><strong>Faaslet Host interface</strong><br> Faaslet通过POSIX-like calls与主机环境进行交互。包括网络、文件I/O、全局状态访问和库加载/链接。主机接口提供了足够的虚拟化以确保隔离，同时增加的开销可以忽略不计。</li>\n</ol>\n<p>FAASM runtime使用LLVM编译器工具链将应用程序转换为WebAssembly，这一方法支持用多种编程语言编写的函数。可现有的无服务器平台集成，例如Knative。</p>\n<h2 id=\"Faaslet-detail-design\"><a href=\"#Faaslet-detail-design\" class=\"headerlink\" title=\"Faaslet detail design\"></a>Faaslet detail design</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2012.58.20.png\" alt=\"截屏2023-02-06 12.58.20\"></p>\n<ol>\n<li><p><a id=\"memy\">内存设计</a>：函数被编译为WebAssembly，被放置在它自己的私有连续内存区域中。同时Faaslet也支持共享内存区域，这允许Faaslet在WebAssembly的内存安全保证的约束下访问共享的内存状态(当需要内存共享时，Faaslet扩展WASM的字节数组，但将新页面映射到公共进程内存的指定区域（mmap）。然后可以给函数一个指向字节数组新区域的指针，但所有访问都在共享区域上执行)。<br> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2015.22.09.png\" alt=\"截屏2023-02-06 15.22.09\"></p>\n</li>\n<li><p><a id=\"is\">隔离</a>：faaslet确保了公平的资源访问。对于CPU隔离，使用“Linux cgroups的CPU子集”。每个函数都由共享运行时进程的专用线程执行，这个线程被分配了一个cgroup。</p>\n</li>\n<li><p>IO接口：Faaslet通过网络命名空间、虚拟网络接口和流量整形实现安全公平的网络访问。每个Faaslet在单独的名称空间中都有自己的网络接口，使用iptables规则进行配置。为了确保共享租户之间的公平性，每个Faaslet使用tc在其虚拟网络接口上应用流量整形，从而强制执行入口和出口流量速率限制。</p>\n</li>\n<li><p><a id=\"inter\">Faaslet host interface</a>：Faaslet host interface是一个virtualisation layer，提供了一系列API，以隔离函数于外界环境。这些接口基于WASI（这个设计有点类似gVisor，但是gVisor是模拟了整个内核）</p>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2013.15.25.png\" alt=\"截屏2023-02-06 13.15.25\"></p>\n<ol start=\"5\">\n<li>Faaslet使用message bus与父进程（Faasm）通信，接收函数调用，共享工作，调用和等待其他函数等信息。</li>\n<li>Proto Faaslet快照包括函数的堆栈，WebAssembly规范的函数表、堆栈指针和数据。Faasm使用copy-on-write memory mapping将快照还原到新的Faaslet中。Faasm提供了一个Http end point，例如s3，以供上传快照.</li>\n</ol>\n<h2 id=\"Faaslet状态共享\"><a href=\"#Faaslet状态共享\" class=\"headerlink\" title=\"Faaslet状态共享\"></a>Faaslet状态共享</h2><p>Faaslet提供了两层架构的状态共享机制，这一机制可帮助实现Faasm的调度。</p>\n<p>本地层：提供对同一主机上的状态的共享内存访问;</p>\n<p>全局层：允许Faaslet在主机间同步状态。全局层使用distributed key-value store (KVS)实现，具体实现方式是redis。</p>\n<p>DDOs隐藏了两层状态架构，提供了对分布式数据的透明的访问。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-06%2018.31.18.png\" alt=\"截屏2023-02-06 18.31.18\"></p>\n"},{"title":"Log framework High level design","date":"2022-12-06T12:57:07.000Z","_content":"\n为了提升go语言的熟练程度，使用go语言编写一个easy log framework. This is the high level design for this framework.\n\n## Requirement Analysis\n\n### 1. Log levels\n\n​\tERROR > WARN > INFO > DEBUG > TRACE\n\n### 2. Basic requirement\n\n用户需要在每个需要使用日志的类中声明一个EasyLog对象。利用工厂模式声明，工厂方法可选一下几种参数：\n\n- \n","source":"_posts/Log-fremawork-High-level-design.md","raw":"---\ntitle: Log framework High level design\ndate: 2022-12-06 20:57:07\ntags: Go\n---\n\n为了提升go语言的熟练程度，使用go语言编写一个easy log framework. This is the high level design for this framework.\n\n## Requirement Analysis\n\n### 1. Log levels\n\n​\tERROR > WARN > INFO > DEBUG > TRACE\n\n### 2. Basic requirement\n\n用户需要在每个需要使用日志的类中声明一个EasyLog对象。利用工厂模式声明，工厂方法可选一下几种参数：\n\n- \n","slug":"Log-fremawork-High-level-design","published":1,"updated":"2022-12-06T13:28:10.822Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9w000cb9c90bnzd51z","content":"<p>为了提升go语言的熟练程度，使用go语言编写一个easy log framework. This is the high level design for this framework.</p>\n<h2 id=\"Requirement-Analysis\"><a href=\"#Requirement-Analysis\" class=\"headerlink\" title=\"Requirement Analysis\"></a>Requirement Analysis</h2><h3 id=\"1-Log-levels\"><a href=\"#1-Log-levels\" class=\"headerlink\" title=\"1. Log levels\"></a>1. Log levels</h3><p>​    ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE</p>\n<h3 id=\"2-Basic-requirement\"><a href=\"#2-Basic-requirement\" class=\"headerlink\" title=\"2. Basic requirement\"></a>2. Basic requirement</h3><p>用户需要在每个需要使用日志的类中声明一个EasyLog对象。利用工厂模式声明，工厂方法可选一下几种参数：</p>\n<ul>\n<li></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>为了提升go语言的熟练程度，使用go语言编写一个easy log framework. This is the high level design for this framework.</p>\n<h2 id=\"Requirement-Analysis\"><a href=\"#Requirement-Analysis\" class=\"headerlink\" title=\"Requirement Analysis\"></a>Requirement Analysis</h2><h3 id=\"1-Log-levels\"><a href=\"#1-Log-levels\" class=\"headerlink\" title=\"1. Log levels\"></a>1. Log levels</h3><p>​    ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE</p>\n<h3 id=\"2-Basic-requirement\"><a href=\"#2-Basic-requirement\" class=\"headerlink\" title=\"2. Basic requirement\"></a>2. Basic requirement</h3><p>用户需要在每个需要使用日志的类中声明一个EasyLog对象。利用工厂模式声明，工厂方法可选一下几种参数：</p>\n<ul>\n<li></li>\n</ul>\n"},{"title":"MIT 6.s081 Lab4 Trap","date":"2023-01-13T10:43:35.000Z","_content":"\n## RISC-V assembly\n\n```\nint g(int x) {\n  return x+3;\n}\n\nint f(int x) {\n  return g(x);\n}\n\nvoid main(void) {\n  printf(\"%d %d\\n\", f(8)+1, 13);\n  exit(0);\n}\n```\n\n```\n0000000000000000 <g>:\n#include \"kernel/param.h\"\n#include \"kernel/types.h\"\n#include \"kernel/stat.h\"\n#include \"user/user.h\"\n\nint g(int x) {\n   0:\t1141                \taddi\tsp,sp,-16\n   2:\te422                \tsd\ts0,8(sp)\n   4:\t0800                \taddi\ts0,sp,16\n  return x+3;\n}\n   6:\t250d                \taddiw\ta0,a0,3\n   8:\t6422                \tld\ts0,8(sp)\n   a:\t0141                \taddi\tsp,sp,16\n   c:\t8082                \tret\n\n000000000000000e <f>:\n\nint f(int x) {\n   e:\t1141                \taddi\tsp,sp,-16\n  10:\te422                \tsd\ts0,8(sp)\n  12:\t0800                \taddi\ts0,sp,16\n  return g(x);\n}\n  14:\t250d                \taddiw\ta0,a0,3\n  16:\t6422                \tld\ts0,8(sp)\n  18:\t0141                \taddi\tsp,sp,16\n  1a:\t8082                \tret\n\n000000000000001c <main>:\n\nvoid main(void) {\n  1c:\t1141                \taddi\tsp,sp,-16\n  1e:\te406                \tsd\tra,8(sp)\n  20:\te022                \tsd\ts0,0(sp)\n  22:\t0800                \taddi\ts0,sp,16\n  printf(\"%d %d\\n\", f(8)+1, 13);\n  24:\t4635                \tli\ta2,13\n  26:\t45b1                \tli\ta1,12\n  28:\t00000517          \tauipc\ta0,0x0\n  2c:\t7a850513          \taddi\ta0,a0,1960 # 7d0 <malloc+0xe8>\n  30:\t00000097          \tauipc\tra,0x0\n  34:\t600080e7          \tjalr\t1536(ra) # 630 <printf>\n  exit(0);\n  38:\t4501                \tli\ta0,0\n  3a:\t00000097          \tauipc\tra,0x0\n  3e:\t28e080e7          \tjalr\t654(ra) # 2c8 <exit>\n\n0000000000000042 <_main>:\n//\n// wrapper so that it's OK if main() does not call exit().\n//\nvoid\n_main()\n{\n  42:\t1141                \taddi\tsp,sp,-16\n  44:\te406                \tsd\tra,8(sp)\n  46:\te022                \tsd\ts0,0(sp)\n  48:\t0800                \taddi\ts0,sp,16\n  extern int main();\n  main();\n  4a:\t00000097          \tauipc\tra,0x0\n  4e:\tfd2080e7          \tjalr\t-46(ra) # 1c <main>\n  exit(0);\n  52:\t4501                \tli\ta0,0\n  54:\t00000097          \tauipc\tra,0x0\n  58:\t274080e7          \tjalr\t628(ra) # 2c8 <exit>\n\n000000000000005c <strcpy>:\n}\n```\n\n## RISC-V trap machinery\n\n- stvec ：内核在这里写入它的trap处理程序的地址;RISC-V跳转到stvec中的地址来处理trap。\n- sepc：当一个trap发生时，RISC-V将程序计数器保存在这里(因为pc会被stvec中的值覆盖)。sret (return from trap)指令将sepc复制到pc上。内核可以编写sepc来控制sret的位置。\n- scause：RISC-V在这里放了一个数字来描述trap的原因。\n- sscratch： trap处理程序代码使用sscratch来避免在 保存用户寄存器之前覆盖用户寄存器。\n- sstatus：sstatus中的SIE位控制是否启用设备中断。如果内核清除了SIE, RISC-V将延迟设备中断，直到内核设置了SIE。SPP位表示trap来自用户模式还是管理模式，并控制sret返回哪种模式。\n\nRISC-V中断发生过程：\n\n1. 如果设备中断，且sstatus SIE位为清零，则无需执行以下操作\n2. 通过清除sstatus中的SIE位来禁用中断。\n3. Copy the pc to sepc.\n4. 将当前模式(user或supervisor)保存在sstatus的SPP位中。\n5. 设置原因以反映陷阱的原因。\n6. Set the mode to supervisor\n7. Copy stvec to the pc.\n8. 在新的pc位置开始执行\n\n## User Trap\n\n用户中断当用户调用了ecall指令时发生（或发生了非法操作或硬件中断）。\n\n用户发生中断：\nstep1: uservec\nstep2: usertrap\n\n当中断返回：\nstep1: usertrapret\nstep2: userret\n\n### 1. 发生中断\n\nTRAMPOLINE page在程序初始化时放置，位于user虚拟地址的顶部，同时TRAMPOLINE在内核页表也被映射。且没有 PTE_U标志。因此trap handler在切换到内核page后可以继续执行。\n\n![截屏2023-01-13 23.20.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png)\n\n为了保存用户状态，uservec会将用户寄存器状态保存在TRAPFRAME（一个结构体）。TRAPFRAME 在 TRAMPOLINE之下。\n\n```\nstruct trapframe {\n  /*   0 */ uint64 kernel_satp;   // kernel page table\n  /*   8 */ uint64 kernel_sp;     // top of process's kernel stack\n  /*  16 */ uint64 kernel_trap;   // usertrap()\n  /*  24 */ uint64 epc;           // saved user program counter\n  /*  32 */ uint64 kernel_hartid; // saved kernel tp\n  /*  40 */ uint64 ra;\n  /*  48 */ uint64 sp;\n  /*  56 */ uint64 gp;\n  /*  64 */ uint64 tp;\n  /*  72 */ uint64 t0;\n  /*  80 */ uint64 t1;\n  ......\n};\n```\n\nTRAPFRAME中保存了内核page的信息和cpu信息，uservec从这里获取信息。然后执行usertrap。\n\n usertrap的工作是确定trap的原因, 运行trap并返回。usertrap首先会保存sepc（用户程序计数器）。如果该trap是一个系统调用，则usertrap调用sycall来处理它;如果设备中断，devintr;否则它是一个异常，内核会终止发生故障的进程。\n\n系统调用路径在保存的用户程序计数器上增加了4，因为RISC-V在系统调用的情况下，用户代码需要在后续指令处恢复执行（不能反复执行sys call）。在退出过程中，usertrap检查进程是否已经被杀死或应该产生CPU(如果这个trap是一个定时器中断)。\n\n### 2. 中断返回\n\n返回第一步是运行usertrapret。然后执行userret。这俩恢复了一些寄存器状态，返回用户空间。\n\n## initcode.S（如何调用sys call）\n\ninitcode.S将exec的参数放在寄存器a0和a1中，并将系统调用号放在a7中。系统调用号匹配syscalls数组中的条目，syscalls数组是一个函数指针(kernel/syscall.c:107)。调用指令被捕获到内核中，并导致uservec、usertrap和sycall执行。\n\n```\n la a0, init\n la a1, argv\n li a7, SYS_exec\n ecall\n```\n\nSyscall (kernel/ Syscall .c:132) 从trapframe中保存的a7中获取系统调用号，并使用它索引到系统调用中。对于第一个系统调用，a7包含SYS_exec (ker- nel/ sycall .h:8)，导致调用系统调用实现函数SYS_exec。\n\n当sys_exec返回时，系统调用将返回值记录在p->trapframe->a0中。这将导致对exec()的原始用户空间调用返回该值，因为RISC-V上的Ccall约定将返回值放在a0中。\n\n系统调用通常返回负数表示错误，返回零或正数表示成功。如果系统调用号无效，系统调用将打印错误并返回−1。\n\n## \n\n![截屏2023-01-15 00.09.58](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png)\n\n\n\n\n\n","source":"_posts/MIT-6-s081-Lab4.md","raw":"---\ntitle: MIT 6.s081 Lab4 Trap\ndate: 2023-01-13 18:43:35\ntags:\n---\n\n## RISC-V assembly\n\n```\nint g(int x) {\n  return x+3;\n}\n\nint f(int x) {\n  return g(x);\n}\n\nvoid main(void) {\n  printf(\"%d %d\\n\", f(8)+1, 13);\n  exit(0);\n}\n```\n\n```\n0000000000000000 <g>:\n#include \"kernel/param.h\"\n#include \"kernel/types.h\"\n#include \"kernel/stat.h\"\n#include \"user/user.h\"\n\nint g(int x) {\n   0:\t1141                \taddi\tsp,sp,-16\n   2:\te422                \tsd\ts0,8(sp)\n   4:\t0800                \taddi\ts0,sp,16\n  return x+3;\n}\n   6:\t250d                \taddiw\ta0,a0,3\n   8:\t6422                \tld\ts0,8(sp)\n   a:\t0141                \taddi\tsp,sp,16\n   c:\t8082                \tret\n\n000000000000000e <f>:\n\nint f(int x) {\n   e:\t1141                \taddi\tsp,sp,-16\n  10:\te422                \tsd\ts0,8(sp)\n  12:\t0800                \taddi\ts0,sp,16\n  return g(x);\n}\n  14:\t250d                \taddiw\ta0,a0,3\n  16:\t6422                \tld\ts0,8(sp)\n  18:\t0141                \taddi\tsp,sp,16\n  1a:\t8082                \tret\n\n000000000000001c <main>:\n\nvoid main(void) {\n  1c:\t1141                \taddi\tsp,sp,-16\n  1e:\te406                \tsd\tra,8(sp)\n  20:\te022                \tsd\ts0,0(sp)\n  22:\t0800                \taddi\ts0,sp,16\n  printf(\"%d %d\\n\", f(8)+1, 13);\n  24:\t4635                \tli\ta2,13\n  26:\t45b1                \tli\ta1,12\n  28:\t00000517          \tauipc\ta0,0x0\n  2c:\t7a850513          \taddi\ta0,a0,1960 # 7d0 <malloc+0xe8>\n  30:\t00000097          \tauipc\tra,0x0\n  34:\t600080e7          \tjalr\t1536(ra) # 630 <printf>\n  exit(0);\n  38:\t4501                \tli\ta0,0\n  3a:\t00000097          \tauipc\tra,0x0\n  3e:\t28e080e7          \tjalr\t654(ra) # 2c8 <exit>\n\n0000000000000042 <_main>:\n//\n// wrapper so that it's OK if main() does not call exit().\n//\nvoid\n_main()\n{\n  42:\t1141                \taddi\tsp,sp,-16\n  44:\te406                \tsd\tra,8(sp)\n  46:\te022                \tsd\ts0,0(sp)\n  48:\t0800                \taddi\ts0,sp,16\n  extern int main();\n  main();\n  4a:\t00000097          \tauipc\tra,0x0\n  4e:\tfd2080e7          \tjalr\t-46(ra) # 1c <main>\n  exit(0);\n  52:\t4501                \tli\ta0,0\n  54:\t00000097          \tauipc\tra,0x0\n  58:\t274080e7          \tjalr\t628(ra) # 2c8 <exit>\n\n000000000000005c <strcpy>:\n}\n```\n\n## RISC-V trap machinery\n\n- stvec ：内核在这里写入它的trap处理程序的地址;RISC-V跳转到stvec中的地址来处理trap。\n- sepc：当一个trap发生时，RISC-V将程序计数器保存在这里(因为pc会被stvec中的值覆盖)。sret (return from trap)指令将sepc复制到pc上。内核可以编写sepc来控制sret的位置。\n- scause：RISC-V在这里放了一个数字来描述trap的原因。\n- sscratch： trap处理程序代码使用sscratch来避免在 保存用户寄存器之前覆盖用户寄存器。\n- sstatus：sstatus中的SIE位控制是否启用设备中断。如果内核清除了SIE, RISC-V将延迟设备中断，直到内核设置了SIE。SPP位表示trap来自用户模式还是管理模式，并控制sret返回哪种模式。\n\nRISC-V中断发生过程：\n\n1. 如果设备中断，且sstatus SIE位为清零，则无需执行以下操作\n2. 通过清除sstatus中的SIE位来禁用中断。\n3. Copy the pc to sepc.\n4. 将当前模式(user或supervisor)保存在sstatus的SPP位中。\n5. 设置原因以反映陷阱的原因。\n6. Set the mode to supervisor\n7. Copy stvec to the pc.\n8. 在新的pc位置开始执行\n\n## User Trap\n\n用户中断当用户调用了ecall指令时发生（或发生了非法操作或硬件中断）。\n\n用户发生中断：\nstep1: uservec\nstep2: usertrap\n\n当中断返回：\nstep1: usertrapret\nstep2: userret\n\n### 1. 发生中断\n\nTRAMPOLINE page在程序初始化时放置，位于user虚拟地址的顶部，同时TRAMPOLINE在内核页表也被映射。且没有 PTE_U标志。因此trap handler在切换到内核page后可以继续执行。\n\n![截屏2023-01-13 23.20.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png)\n\n为了保存用户状态，uservec会将用户寄存器状态保存在TRAPFRAME（一个结构体）。TRAPFRAME 在 TRAMPOLINE之下。\n\n```\nstruct trapframe {\n  /*   0 */ uint64 kernel_satp;   // kernel page table\n  /*   8 */ uint64 kernel_sp;     // top of process's kernel stack\n  /*  16 */ uint64 kernel_trap;   // usertrap()\n  /*  24 */ uint64 epc;           // saved user program counter\n  /*  32 */ uint64 kernel_hartid; // saved kernel tp\n  /*  40 */ uint64 ra;\n  /*  48 */ uint64 sp;\n  /*  56 */ uint64 gp;\n  /*  64 */ uint64 tp;\n  /*  72 */ uint64 t0;\n  /*  80 */ uint64 t1;\n  ......\n};\n```\n\nTRAPFRAME中保存了内核page的信息和cpu信息，uservec从这里获取信息。然后执行usertrap。\n\n usertrap的工作是确定trap的原因, 运行trap并返回。usertrap首先会保存sepc（用户程序计数器）。如果该trap是一个系统调用，则usertrap调用sycall来处理它;如果设备中断，devintr;否则它是一个异常，内核会终止发生故障的进程。\n\n系统调用路径在保存的用户程序计数器上增加了4，因为RISC-V在系统调用的情况下，用户代码需要在后续指令处恢复执行（不能反复执行sys call）。在退出过程中，usertrap检查进程是否已经被杀死或应该产生CPU(如果这个trap是一个定时器中断)。\n\n### 2. 中断返回\n\n返回第一步是运行usertrapret。然后执行userret。这俩恢复了一些寄存器状态，返回用户空间。\n\n## initcode.S（如何调用sys call）\n\ninitcode.S将exec的参数放在寄存器a0和a1中，并将系统调用号放在a7中。系统调用号匹配syscalls数组中的条目，syscalls数组是一个函数指针(kernel/syscall.c:107)。调用指令被捕获到内核中，并导致uservec、usertrap和sycall执行。\n\n```\n la a0, init\n la a1, argv\n li a7, SYS_exec\n ecall\n```\n\nSyscall (kernel/ Syscall .c:132) 从trapframe中保存的a7中获取系统调用号，并使用它索引到系统调用中。对于第一个系统调用，a7包含SYS_exec (ker- nel/ sycall .h:8)，导致调用系统调用实现函数SYS_exec。\n\n当sys_exec返回时，系统调用将返回值记录在p->trapframe->a0中。这将导致对exec()的原始用户空间调用返回该值，因为RISC-V上的Ccall约定将返回值放在a0中。\n\n系统调用通常返回负数表示错误，返回零或正数表示成功。如果系统调用号无效，系统调用将打印错误并返回−1。\n\n## \n\n![截屏2023-01-15 00.09.58](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png)\n\n\n\n\n\n","slug":"MIT-6-s081-Lab4","published":1,"updated":"2023-01-14T16:10:29.896Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9w000eb9c9b8vl21y8","content":"<h2 id=\"RISC-V-assembly\"><a href=\"#RISC-V-assembly\" class=\"headerlink\" title=\"RISC-V assembly\"></a>RISC-V assembly</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int g(int x) &#123;</span><br><span class=\"line\">  return x+3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int f(int x) &#123;</span><br><span class=\"line\">  return g(x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void main(void) &#123;</span><br><span class=\"line\">  printf(&quot;%d %d\\n&quot;, f(8)+1, 13);</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000000000 &lt;g&gt;:</span><br><span class=\"line\">#include &quot;kernel/param.h&quot;</span><br><span class=\"line\">#include &quot;kernel/types.h&quot;</span><br><span class=\"line\">#include &quot;kernel/stat.h&quot;</span><br><span class=\"line\">#include &quot;user/user.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int g(int x) &#123;</span><br><span class=\"line\">   0:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">   2:\te422                \tsd\ts0,8(sp)</span><br><span class=\"line\">   4:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  return x+3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   6:\t250d                \taddiw\ta0,a0,3</span><br><span class=\"line\">   8:\t6422                \tld\ts0,8(sp)</span><br><span class=\"line\">   a:\t0141                \taddi\tsp,sp,16</span><br><span class=\"line\">   c:\t8082                \tret</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000000e &lt;f&gt;:</span><br><span class=\"line\"></span><br><span class=\"line\">int f(int x) &#123;</span><br><span class=\"line\">   e:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  10:\te422                \tsd\ts0,8(sp)</span><br><span class=\"line\">  12:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  return g(x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  14:\t250d                \taddiw\ta0,a0,3</span><br><span class=\"line\">  16:\t6422                \tld\ts0,8(sp)</span><br><span class=\"line\">  18:\t0141                \taddi\tsp,sp,16</span><br><span class=\"line\">  1a:\t8082                \tret</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000001c &lt;main&gt;:</span><br><span class=\"line\"></span><br><span class=\"line\">void main(void) &#123;</span><br><span class=\"line\">  1c:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  1e:\te406                \tsd\tra,8(sp)</span><br><span class=\"line\">  20:\te022                \tsd\ts0,0(sp)</span><br><span class=\"line\">  22:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  printf(&quot;%d %d\\n&quot;, f(8)+1, 13);</span><br><span class=\"line\">  24:\t4635                \tli\ta2,13</span><br><span class=\"line\">  26:\t45b1                \tli\ta1,12</span><br><span class=\"line\">  28:\t00000517          \tauipc\ta0,0x0</span><br><span class=\"line\">  2c:\t7a850513          \taddi\ta0,a0,1960 # 7d0 &lt;malloc+0xe8&gt;</span><br><span class=\"line\">  30:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  34:\t600080e7          \tjalr\t1536(ra) # 630 &lt;printf&gt;</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">  38:\t4501                \tli\ta0,0</span><br><span class=\"line\">  3a:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  3e:\t28e080e7          \tjalr\t654(ra) # 2c8 &lt;exit&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000042 &lt;_main&gt;:</span><br><span class=\"line\">//</span><br><span class=\"line\">// wrapper so that it&#x27;s OK if main() does not call exit().</span><br><span class=\"line\">//</span><br><span class=\"line\">void</span><br><span class=\"line\">_main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  42:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  44:\te406                \tsd\tra,8(sp)</span><br><span class=\"line\">  46:\te022                \tsd\ts0,0(sp)</span><br><span class=\"line\">  48:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  extern int main();</span><br><span class=\"line\">  main();</span><br><span class=\"line\">  4a:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  4e:\tfd2080e7          \tjalr\t-46(ra) # 1c &lt;main&gt;</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">  52:\t4501                \tli\ta0,0</span><br><span class=\"line\">  54:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  58:\t274080e7          \tjalr\t628(ra) # 2c8 &lt;exit&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000005c &lt;strcpy&gt;:</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"RISC-V-trap-machinery\"><a href=\"#RISC-V-trap-machinery\" class=\"headerlink\" title=\"RISC-V trap machinery\"></a>RISC-V trap machinery</h2><ul>\n<li>stvec ：内核在这里写入它的trap处理程序的地址;RISC-V跳转到stvec中的地址来处理trap。</li>\n<li>sepc：当一个trap发生时，RISC-V将程序计数器保存在这里(因为pc会被stvec中的值覆盖)。sret (return from trap)指令将sepc复制到pc上。内核可以编写sepc来控制sret的位置。</li>\n<li>scause：RISC-V在这里放了一个数字来描述trap的原因。</li>\n<li>sscratch： trap处理程序代码使用sscratch来避免在 保存用户寄存器之前覆盖用户寄存器。</li>\n<li>sstatus：sstatus中的SIE位控制是否启用设备中断。如果内核清除了SIE, RISC-V将延迟设备中断，直到内核设置了SIE。SPP位表示trap来自用户模式还是管理模式，并控制sret返回哪种模式。</li>\n</ul>\n<p>RISC-V中断发生过程：</p>\n<ol>\n<li>如果设备中断，且sstatus SIE位为清零，则无需执行以下操作</li>\n<li>通过清除sstatus中的SIE位来禁用中断。</li>\n<li>Copy the pc to sepc.</li>\n<li>将当前模式(user或supervisor)保存在sstatus的SPP位中。</li>\n<li>设置原因以反映陷阱的原因。</li>\n<li>Set the mode to supervisor</li>\n<li>Copy stvec to the pc.</li>\n<li>在新的pc位置开始执行</li>\n</ol>\n<h2 id=\"User-Trap\"><a href=\"#User-Trap\" class=\"headerlink\" title=\"User Trap\"></a>User Trap</h2><p>用户中断当用户调用了ecall指令时发生（或发生了非法操作或硬件中断）。</p>\n<p>用户发生中断：<br>step1: uservec<br>step2: usertrap</p>\n<p>当中断返回：<br>step1: usertrapret<br>step2: userret</p>\n<h3 id=\"1-发生中断\"><a href=\"#1-发生中断\" class=\"headerlink\" title=\"1. 发生中断\"></a>1. 发生中断</h3><p>TRAMPOLINE page在程序初始化时放置，位于user虚拟地址的顶部，同时TRAMPOLINE在内核页表也被映射。且没有 PTE_U标志。因此trap handler在切换到内核page后可以继续执行。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png\" alt=\"截屏2023-01-13 23.20.51\"></p>\n<p>为了保存用户状态，uservec会将用户寄存器状态保存在TRAPFRAME（一个结构体）。TRAPFRAME 在 TRAMPOLINE之下。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct trapframe &#123;</span><br><span class=\"line\">  /*   0 */ uint64 kernel_satp;   // kernel page table</span><br><span class=\"line\">  /*   8 */ uint64 kernel_sp;     // top of process&#x27;s kernel stack</span><br><span class=\"line\">  /*  16 */ uint64 kernel_trap;   // usertrap()</span><br><span class=\"line\">  /*  24 */ uint64 epc;           // saved user program counter</span><br><span class=\"line\">  /*  32 */ uint64 kernel_hartid; // saved kernel tp</span><br><span class=\"line\">  /*  40 */ uint64 ra;</span><br><span class=\"line\">  /*  48 */ uint64 sp;</span><br><span class=\"line\">  /*  56 */ uint64 gp;</span><br><span class=\"line\">  /*  64 */ uint64 tp;</span><br><span class=\"line\">  /*  72 */ uint64 t0;</span><br><span class=\"line\">  /*  80 */ uint64 t1;</span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>TRAPFRAME中保存了内核page的信息和cpu信息，uservec从这里获取信息。然后执行usertrap。</p>\n<p> usertrap的工作是确定trap的原因, 运行trap并返回。usertrap首先会保存sepc（用户程序计数器）。如果该trap是一个系统调用，则usertrap调用sycall来处理它;如果设备中断，devintr;否则它是一个异常，内核会终止发生故障的进程。</p>\n<p>系统调用路径在保存的用户程序计数器上增加了4，因为RISC-V在系统调用的情况下，用户代码需要在后续指令处恢复执行（不能反复执行sys call）。在退出过程中，usertrap检查进程是否已经被杀死或应该产生CPU(如果这个trap是一个定时器中断)。</p>\n<h3 id=\"2-中断返回\"><a href=\"#2-中断返回\" class=\"headerlink\" title=\"2. 中断返回\"></a>2. 中断返回</h3><p>返回第一步是运行usertrapret。然后执行userret。这俩恢复了一些寄存器状态，返回用户空间。</p>\n<h2 id=\"initcode-S（如何调用sys-call）\"><a href=\"#initcode-S（如何调用sys-call）\" class=\"headerlink\" title=\"initcode.S（如何调用sys call）\"></a>initcode.S（如何调用sys call）</h2><p>initcode.S将exec的参数放在寄存器a0和a1中，并将系统调用号放在a7中。系统调用号匹配syscalls数组中的条目，syscalls数组是一个函数指针(kernel/syscall.c:107)。调用指令被捕获到内核中，并导致uservec、usertrap和sycall执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">la a0, init</span><br><span class=\"line\">la a1, argv</span><br><span class=\"line\">li a7, SYS_exec</span><br><span class=\"line\">ecall</span><br></pre></td></tr></table></figure>\n\n<p>Syscall (kernel/ Syscall .c:132) 从trapframe中保存的a7中获取系统调用号，并使用它索引到系统调用中。对于第一个系统调用，a7包含SYS_exec (ker- nel/ sycall .h:8)，导致调用系统调用实现函数SYS_exec。</p>\n<p>当sys_exec返回时，系统调用将返回值记录在p-&gt;trapframe-&gt;a0中。这将导致对exec()的原始用户空间调用返回该值，因为RISC-V上的Ccall约定将返回值放在a0中。</p>\n<p>系统调用通常返回负数表示错误，返回零或正数表示成功。如果系统调用号无效，系统调用将打印错误并返回−1。</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png\" alt=\"截屏2023-01-15 00.09.58\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"RISC-V-assembly\"><a href=\"#RISC-V-assembly\" class=\"headerlink\" title=\"RISC-V assembly\"></a>RISC-V assembly</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int g(int x) &#123;</span><br><span class=\"line\">  return x+3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int f(int x) &#123;</span><br><span class=\"line\">  return g(x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void main(void) &#123;</span><br><span class=\"line\">  printf(&quot;%d %d\\n&quot;, f(8)+1, 13);</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000000000 &lt;g&gt;:</span><br><span class=\"line\">#include &quot;kernel/param.h&quot;</span><br><span class=\"line\">#include &quot;kernel/types.h&quot;</span><br><span class=\"line\">#include &quot;kernel/stat.h&quot;</span><br><span class=\"line\">#include &quot;user/user.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int g(int x) &#123;</span><br><span class=\"line\">   0:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">   2:\te422                \tsd\ts0,8(sp)</span><br><span class=\"line\">   4:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  return x+3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   6:\t250d                \taddiw\ta0,a0,3</span><br><span class=\"line\">   8:\t6422                \tld\ts0,8(sp)</span><br><span class=\"line\">   a:\t0141                \taddi\tsp,sp,16</span><br><span class=\"line\">   c:\t8082                \tret</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000000e &lt;f&gt;:</span><br><span class=\"line\"></span><br><span class=\"line\">int f(int x) &#123;</span><br><span class=\"line\">   e:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  10:\te422                \tsd\ts0,8(sp)</span><br><span class=\"line\">  12:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  return g(x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  14:\t250d                \taddiw\ta0,a0,3</span><br><span class=\"line\">  16:\t6422                \tld\ts0,8(sp)</span><br><span class=\"line\">  18:\t0141                \taddi\tsp,sp,16</span><br><span class=\"line\">  1a:\t8082                \tret</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000001c &lt;main&gt;:</span><br><span class=\"line\"></span><br><span class=\"line\">void main(void) &#123;</span><br><span class=\"line\">  1c:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  1e:\te406                \tsd\tra,8(sp)</span><br><span class=\"line\">  20:\te022                \tsd\ts0,0(sp)</span><br><span class=\"line\">  22:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  printf(&quot;%d %d\\n&quot;, f(8)+1, 13);</span><br><span class=\"line\">  24:\t4635                \tli\ta2,13</span><br><span class=\"line\">  26:\t45b1                \tli\ta1,12</span><br><span class=\"line\">  28:\t00000517          \tauipc\ta0,0x0</span><br><span class=\"line\">  2c:\t7a850513          \taddi\ta0,a0,1960 # 7d0 &lt;malloc+0xe8&gt;</span><br><span class=\"line\">  30:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  34:\t600080e7          \tjalr\t1536(ra) # 630 &lt;printf&gt;</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">  38:\t4501                \tli\ta0,0</span><br><span class=\"line\">  3a:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  3e:\t28e080e7          \tjalr\t654(ra) # 2c8 &lt;exit&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000042 &lt;_main&gt;:</span><br><span class=\"line\">//</span><br><span class=\"line\">// wrapper so that it&#x27;s OK if main() does not call exit().</span><br><span class=\"line\">//</span><br><span class=\"line\">void</span><br><span class=\"line\">_main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  42:\t1141                \taddi\tsp,sp,-16</span><br><span class=\"line\">  44:\te406                \tsd\tra,8(sp)</span><br><span class=\"line\">  46:\te022                \tsd\ts0,0(sp)</span><br><span class=\"line\">  48:\t0800                \taddi\ts0,sp,16</span><br><span class=\"line\">  extern int main();</span><br><span class=\"line\">  main();</span><br><span class=\"line\">  4a:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  4e:\tfd2080e7          \tjalr\t-46(ra) # 1c &lt;main&gt;</span><br><span class=\"line\">  exit(0);</span><br><span class=\"line\">  52:\t4501                \tli\ta0,0</span><br><span class=\"line\">  54:\t00000097          \tauipc\tra,0x0</span><br><span class=\"line\">  58:\t274080e7          \tjalr\t628(ra) # 2c8 &lt;exit&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">000000000000005c &lt;strcpy&gt;:</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"RISC-V-trap-machinery\"><a href=\"#RISC-V-trap-machinery\" class=\"headerlink\" title=\"RISC-V trap machinery\"></a>RISC-V trap machinery</h2><ul>\n<li>stvec ：内核在这里写入它的trap处理程序的地址;RISC-V跳转到stvec中的地址来处理trap。</li>\n<li>sepc：当一个trap发生时，RISC-V将程序计数器保存在这里(因为pc会被stvec中的值覆盖)。sret (return from trap)指令将sepc复制到pc上。内核可以编写sepc来控制sret的位置。</li>\n<li>scause：RISC-V在这里放了一个数字来描述trap的原因。</li>\n<li>sscratch： trap处理程序代码使用sscratch来避免在 保存用户寄存器之前覆盖用户寄存器。</li>\n<li>sstatus：sstatus中的SIE位控制是否启用设备中断。如果内核清除了SIE, RISC-V将延迟设备中断，直到内核设置了SIE。SPP位表示trap来自用户模式还是管理模式，并控制sret返回哪种模式。</li>\n</ul>\n<p>RISC-V中断发生过程：</p>\n<ol>\n<li>如果设备中断，且sstatus SIE位为清零，则无需执行以下操作</li>\n<li>通过清除sstatus中的SIE位来禁用中断。</li>\n<li>Copy the pc to sepc.</li>\n<li>将当前模式(user或supervisor)保存在sstatus的SPP位中。</li>\n<li>设置原因以反映陷阱的原因。</li>\n<li>Set the mode to supervisor</li>\n<li>Copy stvec to the pc.</li>\n<li>在新的pc位置开始执行</li>\n</ol>\n<h2 id=\"User-Trap\"><a href=\"#User-Trap\" class=\"headerlink\" title=\"User Trap\"></a>User Trap</h2><p>用户中断当用户调用了ecall指令时发生（或发生了非法操作或硬件中断）。</p>\n<p>用户发生中断：<br>step1: uservec<br>step2: usertrap</p>\n<p>当中断返回：<br>step1: usertrapret<br>step2: userret</p>\n<h3 id=\"1-发生中断\"><a href=\"#1-发生中断\" class=\"headerlink\" title=\"1. 发生中断\"></a>1. 发生中断</h3><p>TRAMPOLINE page在程序初始化时放置，位于user虚拟地址的顶部，同时TRAMPOLINE在内核页表也被映射。且没有 PTE_U标志。因此trap handler在切换到内核page后可以继续执行。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2023.20.51.png\" alt=\"截屏2023-01-13 23.20.51\"></p>\n<p>为了保存用户状态，uservec会将用户寄存器状态保存在TRAPFRAME（一个结构体）。TRAPFRAME 在 TRAMPOLINE之下。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct trapframe &#123;</span><br><span class=\"line\">  /*   0 */ uint64 kernel_satp;   // kernel page table</span><br><span class=\"line\">  /*   8 */ uint64 kernel_sp;     // top of process&#x27;s kernel stack</span><br><span class=\"line\">  /*  16 */ uint64 kernel_trap;   // usertrap()</span><br><span class=\"line\">  /*  24 */ uint64 epc;           // saved user program counter</span><br><span class=\"line\">  /*  32 */ uint64 kernel_hartid; // saved kernel tp</span><br><span class=\"line\">  /*  40 */ uint64 ra;</span><br><span class=\"line\">  /*  48 */ uint64 sp;</span><br><span class=\"line\">  /*  56 */ uint64 gp;</span><br><span class=\"line\">  /*  64 */ uint64 tp;</span><br><span class=\"line\">  /*  72 */ uint64 t0;</span><br><span class=\"line\">  /*  80 */ uint64 t1;</span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>TRAPFRAME中保存了内核page的信息和cpu信息，uservec从这里获取信息。然后执行usertrap。</p>\n<p> usertrap的工作是确定trap的原因, 运行trap并返回。usertrap首先会保存sepc（用户程序计数器）。如果该trap是一个系统调用，则usertrap调用sycall来处理它;如果设备中断，devintr;否则它是一个异常，内核会终止发生故障的进程。</p>\n<p>系统调用路径在保存的用户程序计数器上增加了4，因为RISC-V在系统调用的情况下，用户代码需要在后续指令处恢复执行（不能反复执行sys call）。在退出过程中，usertrap检查进程是否已经被杀死或应该产生CPU(如果这个trap是一个定时器中断)。</p>\n<h3 id=\"2-中断返回\"><a href=\"#2-中断返回\" class=\"headerlink\" title=\"2. 中断返回\"></a>2. 中断返回</h3><p>返回第一步是运行usertrapret。然后执行userret。这俩恢复了一些寄存器状态，返回用户空间。</p>\n<h2 id=\"initcode-S（如何调用sys-call）\"><a href=\"#initcode-S（如何调用sys-call）\" class=\"headerlink\" title=\"initcode.S（如何调用sys call）\"></a>initcode.S（如何调用sys call）</h2><p>initcode.S将exec的参数放在寄存器a0和a1中，并将系统调用号放在a7中。系统调用号匹配syscalls数组中的条目，syscalls数组是一个函数指针(kernel/syscall.c:107)。调用指令被捕获到内核中，并导致uservec、usertrap和sycall执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">la a0, init</span><br><span class=\"line\">la a1, argv</span><br><span class=\"line\">li a7, SYS_exec</span><br><span class=\"line\">ecall</span><br></pre></td></tr></table></figure>\n\n<p>Syscall (kernel/ Syscall .c:132) 从trapframe中保存的a7中获取系统调用号，并使用它索引到系统调用中。对于第一个系统调用，a7包含SYS_exec (ker- nel/ sycall .h:8)，导致调用系统调用实现函数SYS_exec。</p>\n<p>当sys_exec返回时，系统调用将返回值记录在p-&gt;trapframe-&gt;a0中。这将导致对exec()的原始用户空间调用返回该值，因为RISC-V上的Ccall约定将返回值放在a0中。</p>\n<p>系统调用通常返回负数表示错误，返回零或正数表示成功。如果系统调用号无效，系统调用将打印错误并返回−1。</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-15%2000.09.58.png\" alt=\"截屏2023-01-15 00.09.58\"></p>\n"},{"title":"MIT 6.s081 Lab5 COW","date":"2023-01-16T02:23:35.000Z","_content":"\n## Code\n\nCOW标志位，/rich.h。储存在保留位里\n\n```\n#define COW_FLAG (1L << 8)\n```\n\n复制内存的代码，在fork中有被调用\n\n```\nint\nuvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)\n{\n    pte_t *pte;\n    uint64 pa, i;\n    int flags;\n\n    for(i = 0; i < sz; i += PGSIZE){\n        if((pte = walk(old, i, 0)) == 0)\n            panic(\"uvmcopy: pte should exist\");\n        if((*pte & PTE_V) == 0)\n            panic(\"uvmcopy: page not present\");\n\n        // 旧进程的物理内存\n        pa = PTE2PA(*pte);\n\n        // COW\n        *pte = (*pte & ~PTE_W) | COW_FLAG;\n        flags = PTE_FLAGS(*pte);\n\n        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0){\n            goto err;\n        }\n        con[getrefindex((uint64*)pa)]++;\n\n    }\n    return 0;\n\nerr:\nuvmunmap(new, 0, i / PGSIZE, 1);\nreturn -1;\n}\n```\n\n处理内存非法访问（页）中断的代码\n\n```\nelse if(r_scause() == 15){\n//      printf(\"page\\n\");\n        struct proc *p = myproc();\n\n        /* 【xv6对页的操控粒度为Page】\n         * 需要将当前虚拟地址所对应的page进行拷贝\n         * 由于虚拟地址可能指向页的中间\n         * 因此需要向下对其到页的边界\n         * 从而将这一页全部都进行拷贝（COW）\n         */\n        uint64 va=PGROUNDDOWN(r_stval()); // 虚拟地址\n\n        pte_t *pte; // pte\n        pte = walk(p->pagetable, va, 0);\n\n        if(*pte & COW_FLAG){ //是cow页面\n            uint64 pa=PTE2PA(*pte); // 物理地址\n\n            char *mem;\n            //分配一页新内存\n            if((mem = kalloc()) == 0)\n                panic(\"uvmtrap: pte alloc exist\");\n\n            // 拷贝旧数据的值到新page\n            memmove(mem, (char*)pa, PGSIZE);\n\n            int flags = PTE_FLAGS(*pte);\n\n            flags =flags | PTE_W;\n            flags &= ~COW_FLAG;\n//            *pte &=~PTE_V;\n            // 进行内存映射\n            mappages(p->pagetable, va, PGSIZE, (uint64)mem, flags);\n\n\n            kfree((void*)pa);\n\n        }\n\n```\n\n释放内存代码（引用计数）：\n\n```\n// derf.h\nextern int con[];\nextern int getrefindex(void*);\n```\n\n```\nvoid\nkfree(void *pa)\n{\n  struct run *r;\n\n  if(((uint64)pa % PGSIZE) != 0 || (char*)pa < end || (uint64)pa >= PHYSTOP) {\n      panic(\"kfree\");\n  }\n\n  con[getrefindex(pa)]--;\n  //printf(\"%d\",con[(uint64)pa/PGSIZE]);\n  if(con[getrefindex(pa)]>0){\n      return;\n  }\n\n  // Fill with junk to catch dangling refs.\n  memset(pa, 1, PGSIZE);\n\n  r = (struct run*)pa;\n\n  acquire(&kmem.lock);\n  r->next = kmem.freelist;\n  kmem.freelist = r;\n  release(&kmem.lock);\n}\n```\n\n![截屏2023-01-16 10.31.45](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png)\n","source":"_posts/MIT-6-s081-Lab5-COW.md","raw":"---\ntitle: MIT 6.s081 Lab5 COW\ndate: 2023-01-16 10:23:35\ntags:\n---\n\n## Code\n\nCOW标志位，/rich.h。储存在保留位里\n\n```\n#define COW_FLAG (1L << 8)\n```\n\n复制内存的代码，在fork中有被调用\n\n```\nint\nuvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)\n{\n    pte_t *pte;\n    uint64 pa, i;\n    int flags;\n\n    for(i = 0; i < sz; i += PGSIZE){\n        if((pte = walk(old, i, 0)) == 0)\n            panic(\"uvmcopy: pte should exist\");\n        if((*pte & PTE_V) == 0)\n            panic(\"uvmcopy: page not present\");\n\n        // 旧进程的物理内存\n        pa = PTE2PA(*pte);\n\n        // COW\n        *pte = (*pte & ~PTE_W) | COW_FLAG;\n        flags = PTE_FLAGS(*pte);\n\n        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0){\n            goto err;\n        }\n        con[getrefindex((uint64*)pa)]++;\n\n    }\n    return 0;\n\nerr:\nuvmunmap(new, 0, i / PGSIZE, 1);\nreturn -1;\n}\n```\n\n处理内存非法访问（页）中断的代码\n\n```\nelse if(r_scause() == 15){\n//      printf(\"page\\n\");\n        struct proc *p = myproc();\n\n        /* 【xv6对页的操控粒度为Page】\n         * 需要将当前虚拟地址所对应的page进行拷贝\n         * 由于虚拟地址可能指向页的中间\n         * 因此需要向下对其到页的边界\n         * 从而将这一页全部都进行拷贝（COW）\n         */\n        uint64 va=PGROUNDDOWN(r_stval()); // 虚拟地址\n\n        pte_t *pte; // pte\n        pte = walk(p->pagetable, va, 0);\n\n        if(*pte & COW_FLAG){ //是cow页面\n            uint64 pa=PTE2PA(*pte); // 物理地址\n\n            char *mem;\n            //分配一页新内存\n            if((mem = kalloc()) == 0)\n                panic(\"uvmtrap: pte alloc exist\");\n\n            // 拷贝旧数据的值到新page\n            memmove(mem, (char*)pa, PGSIZE);\n\n            int flags = PTE_FLAGS(*pte);\n\n            flags =flags | PTE_W;\n            flags &= ~COW_FLAG;\n//            *pte &=~PTE_V;\n            // 进行内存映射\n            mappages(p->pagetable, va, PGSIZE, (uint64)mem, flags);\n\n\n            kfree((void*)pa);\n\n        }\n\n```\n\n释放内存代码（引用计数）：\n\n```\n// derf.h\nextern int con[];\nextern int getrefindex(void*);\n```\n\n```\nvoid\nkfree(void *pa)\n{\n  struct run *r;\n\n  if(((uint64)pa % PGSIZE) != 0 || (char*)pa < end || (uint64)pa >= PHYSTOP) {\n      panic(\"kfree\");\n  }\n\n  con[getrefindex(pa)]--;\n  //printf(\"%d\",con[(uint64)pa/PGSIZE]);\n  if(con[getrefindex(pa)]>0){\n      return;\n  }\n\n  // Fill with junk to catch dangling refs.\n  memset(pa, 1, PGSIZE);\n\n  r = (struct run*)pa;\n\n  acquire(&kmem.lock);\n  r->next = kmem.freelist;\n  kmem.freelist = r;\n  release(&kmem.lock);\n}\n```\n\n![截屏2023-01-16 10.31.45](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png)\n","slug":"MIT-6-s081-Lab5-COW","published":1,"updated":"2023-01-16T02:31:51.797Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9x000gb9c9hsjp4p4a","content":"<h2 id=\"Code\"><a href=\"#Code\" class=\"headerlink\" title=\"Code\"></a>Code</h2><p>COW标志位，/rich.h。储存在保留位里</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define COW_FLAG (1L &lt;&lt; 8)</span><br></pre></td></tr></table></figure>\n\n<p>复制内存的代码，在fork中有被调用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int</span><br><span class=\"line\">uvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    pte_t *pte;</span><br><span class=\"line\">    uint64 pa, i;</span><br><span class=\"line\">    int flags;</span><br><span class=\"line\"></span><br><span class=\"line\">    for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class=\"line\">        if((pte = walk(old, i, 0)) == 0)</span><br><span class=\"line\">            panic(&quot;uvmcopy: pte should exist&quot;);</span><br><span class=\"line\">        if((*pte &amp; PTE_V) == 0)</span><br><span class=\"line\">            panic(&quot;uvmcopy: page not present&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 旧进程的物理内存</span><br><span class=\"line\">        pa = PTE2PA(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">        // COW</span><br><span class=\"line\">        *pte = (*pte &amp; ~PTE_W) | COW_FLAG;</span><br><span class=\"line\">        flags = PTE_FLAGS(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)&#123;</span><br><span class=\"line\">            goto err;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        con[getrefindex((uint64*)pa)]++;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\"></span><br><span class=\"line\">err:</span><br><span class=\"line\">uvmunmap(new, 0, i / PGSIZE, 1);</span><br><span class=\"line\">return -1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>处理内存非法访问（页）中断的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">else if(r_scause() == 15)&#123;</span><br><span class=\"line\">//      printf(&quot;page\\n&quot;);</span><br><span class=\"line\">        struct proc *p = myproc();</span><br><span class=\"line\"></span><br><span class=\"line\">        /* 【xv6对页的操控粒度为Page】</span><br><span class=\"line\">         * 需要将当前虚拟地址所对应的page进行拷贝</span><br><span class=\"line\">         * 由于虚拟地址可能指向页的中间</span><br><span class=\"line\">         * 因此需要向下对其到页的边界</span><br><span class=\"line\">         * 从而将这一页全部都进行拷贝（COW）</span><br><span class=\"line\">         */</span><br><span class=\"line\">        uint64 va=PGROUNDDOWN(r_stval()); // 虚拟地址</span><br><span class=\"line\"></span><br><span class=\"line\">        pte_t *pte; // pte</span><br><span class=\"line\">        pte = walk(p-&gt;pagetable, va, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">        if(*pte &amp; COW_FLAG)&#123; //是cow页面</span><br><span class=\"line\">            uint64 pa=PTE2PA(*pte); // 物理地址</span><br><span class=\"line\"></span><br><span class=\"line\">            char *mem;</span><br><span class=\"line\">            //分配一页新内存</span><br><span class=\"line\">            if((mem = kalloc()) == 0)</span><br><span class=\"line\">                panic(&quot;uvmtrap: pte alloc exist&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">            // 拷贝旧数据的值到新page</span><br><span class=\"line\">            memmove(mem, (char*)pa, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">            int flags = PTE_FLAGS(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">            flags =flags | PTE_W;</span><br><span class=\"line\">            flags &amp;= ~COW_FLAG;</span><br><span class=\"line\">//            *pte &amp;=~PTE_V;</span><br><span class=\"line\">            // 进行内存映射</span><br><span class=\"line\">            mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, flags);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            kfree((void*)pa);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>释放内存代码（引用计数）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// derf.h</span><br><span class=\"line\">extern int con[];</span><br><span class=\"line\">extern int getrefindex(void*);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void</span><br><span class=\"line\">kfree(void *pa)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  struct run *r;</span><br><span class=\"line\"></span><br><span class=\"line\">  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP) &#123;</span><br><span class=\"line\">      panic(&quot;kfree&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  con[getrefindex(pa)]--;</span><br><span class=\"line\">  //printf(&quot;%d&quot;,con[(uint64)pa/PGSIZE]);</span><br><span class=\"line\">  if(con[getrefindex(pa)]&gt;0)&#123;</span><br><span class=\"line\">      return;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // Fill with junk to catch dangling refs.</span><br><span class=\"line\">  memset(pa, 1, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">  r = (struct run*)pa;</span><br><span class=\"line\"></span><br><span class=\"line\">  acquire(&amp;kmem.lock);</span><br><span class=\"line\">  r-&gt;next = kmem.freelist;</span><br><span class=\"line\">  kmem.freelist = r;</span><br><span class=\"line\">  release(&amp;kmem.lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png\" alt=\"截屏2023-01-16 10.31.45\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Code\"><a href=\"#Code\" class=\"headerlink\" title=\"Code\"></a>Code</h2><p>COW标志位，/rich.h。储存在保留位里</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define COW_FLAG (1L &lt;&lt; 8)</span><br></pre></td></tr></table></figure>\n\n<p>复制内存的代码，在fork中有被调用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int</span><br><span class=\"line\">uvmcopy_u(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    pte_t *pte;</span><br><span class=\"line\">    uint64 pa, i;</span><br><span class=\"line\">    int flags;</span><br><span class=\"line\"></span><br><span class=\"line\">    for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class=\"line\">        if((pte = walk(old, i, 0)) == 0)</span><br><span class=\"line\">            panic(&quot;uvmcopy: pte should exist&quot;);</span><br><span class=\"line\">        if((*pte &amp; PTE_V) == 0)</span><br><span class=\"line\">            panic(&quot;uvmcopy: page not present&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 旧进程的物理内存</span><br><span class=\"line\">        pa = PTE2PA(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">        // COW</span><br><span class=\"line\">        *pte = (*pte &amp; ~PTE_W) | COW_FLAG;</span><br><span class=\"line\">        flags = PTE_FLAGS(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">        if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)&#123;</span><br><span class=\"line\">            goto err;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        con[getrefindex((uint64*)pa)]++;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\"></span><br><span class=\"line\">err:</span><br><span class=\"line\">uvmunmap(new, 0, i / PGSIZE, 1);</span><br><span class=\"line\">return -1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>处理内存非法访问（页）中断的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">else if(r_scause() == 15)&#123;</span><br><span class=\"line\">//      printf(&quot;page\\n&quot;);</span><br><span class=\"line\">        struct proc *p = myproc();</span><br><span class=\"line\"></span><br><span class=\"line\">        /* 【xv6对页的操控粒度为Page】</span><br><span class=\"line\">         * 需要将当前虚拟地址所对应的page进行拷贝</span><br><span class=\"line\">         * 由于虚拟地址可能指向页的中间</span><br><span class=\"line\">         * 因此需要向下对其到页的边界</span><br><span class=\"line\">         * 从而将这一页全部都进行拷贝（COW）</span><br><span class=\"line\">         */</span><br><span class=\"line\">        uint64 va=PGROUNDDOWN(r_stval()); // 虚拟地址</span><br><span class=\"line\"></span><br><span class=\"line\">        pte_t *pte; // pte</span><br><span class=\"line\">        pte = walk(p-&gt;pagetable, va, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">        if(*pte &amp; COW_FLAG)&#123; //是cow页面</span><br><span class=\"line\">            uint64 pa=PTE2PA(*pte); // 物理地址</span><br><span class=\"line\"></span><br><span class=\"line\">            char *mem;</span><br><span class=\"line\">            //分配一页新内存</span><br><span class=\"line\">            if((mem = kalloc()) == 0)</span><br><span class=\"line\">                panic(&quot;uvmtrap: pte alloc exist&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">            // 拷贝旧数据的值到新page</span><br><span class=\"line\">            memmove(mem, (char*)pa, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">            int flags = PTE_FLAGS(*pte);</span><br><span class=\"line\"></span><br><span class=\"line\">            flags =flags | PTE_W;</span><br><span class=\"line\">            flags &amp;= ~COW_FLAG;</span><br><span class=\"line\">//            *pte &amp;=~PTE_V;</span><br><span class=\"line\">            // 进行内存映射</span><br><span class=\"line\">            mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, flags);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            kfree((void*)pa);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>释放内存代码（引用计数）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// derf.h</span><br><span class=\"line\">extern int con[];</span><br><span class=\"line\">extern int getrefindex(void*);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void</span><br><span class=\"line\">kfree(void *pa)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  struct run *r;</span><br><span class=\"line\"></span><br><span class=\"line\">  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa &gt;= PHYSTOP) &#123;</span><br><span class=\"line\">      panic(&quot;kfree&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  con[getrefindex(pa)]--;</span><br><span class=\"line\">  //printf(&quot;%d&quot;,con[(uint64)pa/PGSIZE]);</span><br><span class=\"line\">  if(con[getrefindex(pa)]&gt;0)&#123;</span><br><span class=\"line\">      return;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // Fill with junk to catch dangling refs.</span><br><span class=\"line\">  memset(pa, 1, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">  r = (struct run*)pa;</span><br><span class=\"line\"></span><br><span class=\"line\">  acquire(&amp;kmem.lock);</span><br><span class=\"line\">  r-&gt;next = kmem.freelist;</span><br><span class=\"line\">  kmem.freelist = r;</span><br><span class=\"line\">  release(&amp;kmem.lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2010.31.45.png\" alt=\"截屏2023-01-16 10.31.45\"></p>\n"},{"title":"MITOSIS note","date":"2023-01-14T05:40:31.000Z","_content":"\n[MITOSIS Repo](https://github.com/ProjectMitosisOS)\n\n## Remote Fork(C/R)\n\n现有容器只能通过C/R的方法进行远程Fork。这种方法需要父进程首先需要*checkpoints* its states，并将state储存到文件里。在通过remote file copy或distributed file system将文件复制到子进程。子进程根据文件信息对夫进程进行恢复。由于C/R需要复制全部内存信息，因此很慢。例如需要对1G内存进行拷贝，C/R甚至比冷启动还要慢2.7倍。\n\n## MITOSIS\n\nMITOSIS【maɪˈtoʊsɪs】通过RDMA模拟本地Fork来实现高效的远程分叉（具有类似COW机制）。\n\n![截屏2023-01-16 11.36.26](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png)\n\n首先，我们将父对象的Metadata(例如页表)复制到一个压缩描述符来派生子对象。Note:不将父进程的内存页复制到描述符中。然后通过RDMA将描述符复制到子进程以恢复父进程的Metadata。子进程的“远程内存访问”会触发页面错误，内核将读区读取远程页面。避免了传输整个容器状态。同时，MITOSIS直接使用单边RDMA Read来读取远程物理内存，绕过所有软件开销。\n\n### MITOSIS和C/R fork的比较\n\n![截屏2023-01-14 13.40.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png)\n\n**MITOSIS由以下四个模块组成：**\n\nThe *fork orchestrator* rehearsals the remote fork execution；准备fork和进行fork，使用rpc进行校验\n\nThe *network daemon* manages a scalable RDMA connection pool；单侧RDMA，维护RDMA连接pool\n\nExtend OS’s *virtual memory subsystems* to utilize the remote memory with RDMA ；远程内存访问\n\n*Fallback daemon* provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMA；恢复机制，回退到RPC\n\n## 1）准备fork和进行fork\n\n### 1.fork_prepare\n\n准备fork，使用一个结构体保存：\n\n- CPU寄存器状态（用于恢复运行状态）\n- cGroup和Namespace（用于进行容器化）\n- 页表和虚拟内存区（用于远程内存访问）\n- 打开文件信息（重新打开文件，使用CRIU）\n\n保存这些信息，结构体很小，大概是KB级别\n\n### 2.fork_resume\n\nfork_resume从父进程获取descriptor，并恢复执行状态。\n\n使用oneside RDMA获取descriptor。首先子进程通过RPC向父进程发一个authentication RPC，若认证通过，则父进程会返回descriptor’s stored address和payload。之后子进程就可以使用oneside RDMA获取descriptor。\n\n获取到descriptor后，恢复容器状态。(1)设置cgroups和命名空间以匹配父操作系统的设置 (2)切换:用父进程的CPU寄存器、页表和I/O描述符替换调用方的CPU寄存器。此外引入SOCK以完成快速容器恢复。\n\n## 2）单侧RDMA\n\nRDMA：有三种QP类型\n\nRDMA连接消耗较大，速度较慢。因此使用无连接的oneside RDMA。因此改进RDMA连接（DCT-dynamic connected transport），DCT保留了RC的功能，并进一步提供了一种无连接的方式:单个DCQP可以与不同的节点通信。\n\n目标节点只需要创建一个DC，该DC由节点的RDMA地址和12B DC key标识。在知道key后，子节点可以在没有连接的情况下向相应的目标发送单侧RDMA请求，硬件会承载数据处理连接，速度极快(1μs以内).\n\n基于DCT，网络守护进程管理一个小型内核空间DCQP池，用于处理来自子进程的RDMA请求。通常，每个cpu一个DCQP就足以充分利用RDMA。但是，仅使用DCT是不够的，因为孩子需要提前知道DCT key才能与父母通信。因此，MITOSIS实现了一个内核空间\"fast RPC\"来引导DCT。fast是一个基于ud的RPC，支持无连接。使用RPC，我们在RPC请求中装载与父对象关联的DCT键，以查询父对象的描述符。为了节省CPU资源，我们只部署了两个内核线程来处理rpc.\n\n## 3）Virtual memory management\n\n为了提高resume效率，直接将子节点映射页面的页表项(PTE)设置为父节点的物理地址(PA)。使用一个PTE中的remote bit来进行区分（remote bit位于PTE未被利用的高位）。在resume过程中，系统会设置remote bit并清除present bit，当子进程访问里该PTE，就会进入缺页中断，从而出发RDMA远程读取。\n\n![截屏2023-01-16 13.18.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png)\n\n如果错误页没有映射到父页，例如堆栈增长，我们就像处理普通的页错误一样在本地处理它。\n否则，检查故障虚拟地址VA (virtual address)是否映射了远端PA。使用单边RDMA将远程page读到本地页。大多数子页面都可以通过RDMA恢复。在错过映射的情况下，则使用RPC映射。\n\nRPC：每个节点有一个回退守护进程，该守护进程生成内核线程来处理子节点的页请求（包含父节点标识符和请求的虚拟地址）。回退逻辑: 在检查请求的有效性之后，守护进程线程将代表父进程加载页面。如果加载成功，我们将把结果发回给子进程。\n\n**Access control and isolation**\n\n我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。\n\n直接暴露父节点的物理内存可以提高远程fork的速度。然而，我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。由于我们以cpu旁路的方式通过单边RDMA公开内存，因此只能利用RNIC进行控制。\n\nMITOSIS用一种基于连接的内存访问控制方法。将不同的RDMA连接分配到父虚拟内存区域(VMA)的不同部分，例如，每个VMA一个连接。如果映射的物理页不再属于父页，我们将破坏与该页的VMA相关的连接。因此，child对页面的访问将被RNIC拒绝。所有连接都在内核中进行管理，以防止恶意用户访问错误的远程容器内存。\n\n为了实现基于连接的访问控制，每个连接在创建和存储时都必须高效。幸运的是，DCQP很好地满足了这些要求。在子端，每个连接(DC key)只消耗12B ，不同的DC连接可以共享相同的DCQP。parent-side DC target consumes 144B。\n\n![截屏2023-01-16 13.34.56](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png)\n\n图片表示了基于dct的访问控制。在准备分叉时，MITOSIS从目标池中选择一个DC目标分配给每个parent VMA。pool在启动时初始化，并在后台定期填充。这些目标的DC key被装载在父进程的描述符中，以便子进程在恢复过程中可以将它们记录在VMA中。在读取父节点的page时，子节点将使用与页面VMA对应的key来发出RDMA请求。使用此方案，如果parent想要拒绝对该页的访问，它可以销毁相应的DC目标。\n\n\n\n## Pre-fetching and caching\n\n此处似乎有一定优化空间？可以采用计数法提升cache命中率。\n\n\n\n","source":"_posts/MITOSIS-learning.md","raw":"---\ntitle: MITOSIS note\ndate: 2023-01-14 13:40:31\ntags:\n---\n\n[MITOSIS Repo](https://github.com/ProjectMitosisOS)\n\n## Remote Fork(C/R)\n\n现有容器只能通过C/R的方法进行远程Fork。这种方法需要父进程首先需要*checkpoints* its states，并将state储存到文件里。在通过remote file copy或distributed file system将文件复制到子进程。子进程根据文件信息对夫进程进行恢复。由于C/R需要复制全部内存信息，因此很慢。例如需要对1G内存进行拷贝，C/R甚至比冷启动还要慢2.7倍。\n\n## MITOSIS\n\nMITOSIS【maɪˈtoʊsɪs】通过RDMA模拟本地Fork来实现高效的远程分叉（具有类似COW机制）。\n\n![截屏2023-01-16 11.36.26](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png)\n\n首先，我们将父对象的Metadata(例如页表)复制到一个压缩描述符来派生子对象。Note:不将父进程的内存页复制到描述符中。然后通过RDMA将描述符复制到子进程以恢复父进程的Metadata。子进程的“远程内存访问”会触发页面错误，内核将读区读取远程页面。避免了传输整个容器状态。同时，MITOSIS直接使用单边RDMA Read来读取远程物理内存，绕过所有软件开销。\n\n### MITOSIS和C/R fork的比较\n\n![截屏2023-01-14 13.40.51](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png)\n\n**MITOSIS由以下四个模块组成：**\n\nThe *fork orchestrator* rehearsals the remote fork execution；准备fork和进行fork，使用rpc进行校验\n\nThe *network daemon* manages a scalable RDMA connection pool；单侧RDMA，维护RDMA连接pool\n\nExtend OS’s *virtual memory subsystems* to utilize the remote memory with RDMA ；远程内存访问\n\n*Fallback daemon* provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMA；恢复机制，回退到RPC\n\n## 1）准备fork和进行fork\n\n### 1.fork_prepare\n\n准备fork，使用一个结构体保存：\n\n- CPU寄存器状态（用于恢复运行状态）\n- cGroup和Namespace（用于进行容器化）\n- 页表和虚拟内存区（用于远程内存访问）\n- 打开文件信息（重新打开文件，使用CRIU）\n\n保存这些信息，结构体很小，大概是KB级别\n\n### 2.fork_resume\n\nfork_resume从父进程获取descriptor，并恢复执行状态。\n\n使用oneside RDMA获取descriptor。首先子进程通过RPC向父进程发一个authentication RPC，若认证通过，则父进程会返回descriptor’s stored address和payload。之后子进程就可以使用oneside RDMA获取descriptor。\n\n获取到descriptor后，恢复容器状态。(1)设置cgroups和命名空间以匹配父操作系统的设置 (2)切换:用父进程的CPU寄存器、页表和I/O描述符替换调用方的CPU寄存器。此外引入SOCK以完成快速容器恢复。\n\n## 2）单侧RDMA\n\nRDMA：有三种QP类型\n\nRDMA连接消耗较大，速度较慢。因此使用无连接的oneside RDMA。因此改进RDMA连接（DCT-dynamic connected transport），DCT保留了RC的功能，并进一步提供了一种无连接的方式:单个DCQP可以与不同的节点通信。\n\n目标节点只需要创建一个DC，该DC由节点的RDMA地址和12B DC key标识。在知道key后，子节点可以在没有连接的情况下向相应的目标发送单侧RDMA请求，硬件会承载数据处理连接，速度极快(1μs以内).\n\n基于DCT，网络守护进程管理一个小型内核空间DCQP池，用于处理来自子进程的RDMA请求。通常，每个cpu一个DCQP就足以充分利用RDMA。但是，仅使用DCT是不够的，因为孩子需要提前知道DCT key才能与父母通信。因此，MITOSIS实现了一个内核空间\"fast RPC\"来引导DCT。fast是一个基于ud的RPC，支持无连接。使用RPC，我们在RPC请求中装载与父对象关联的DCT键，以查询父对象的描述符。为了节省CPU资源，我们只部署了两个内核线程来处理rpc.\n\n## 3）Virtual memory management\n\n为了提高resume效率，直接将子节点映射页面的页表项(PTE)设置为父节点的物理地址(PA)。使用一个PTE中的remote bit来进行区分（remote bit位于PTE未被利用的高位）。在resume过程中，系统会设置remote bit并清除present bit，当子进程访问里该PTE，就会进入缺页中断，从而出发RDMA远程读取。\n\n![截屏2023-01-16 13.18.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png)\n\n如果错误页没有映射到父页，例如堆栈增长，我们就像处理普通的页错误一样在本地处理它。\n否则，检查故障虚拟地址VA (virtual address)是否映射了远端PA。使用单边RDMA将远程page读到本地页。大多数子页面都可以通过RDMA恢复。在错过映射的情况下，则使用RPC映射。\n\nRPC：每个节点有一个回退守护进程，该守护进程生成内核线程来处理子节点的页请求（包含父节点标识符和请求的虚拟地址）。回退逻辑: 在检查请求的有效性之后，守护进程线程将代表父进程加载页面。如果加载成功，我们将把结果发回给子进程。\n\n**Access control and isolation**\n\n我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。\n\n直接暴露父节点的物理内存可以提高远程fork的速度。然而，我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。由于我们以cpu旁路的方式通过单边RDMA公开内存，因此只能利用RNIC进行控制。\n\nMITOSIS用一种基于连接的内存访问控制方法。将不同的RDMA连接分配到父虚拟内存区域(VMA)的不同部分，例如，每个VMA一个连接。如果映射的物理页不再属于父页，我们将破坏与该页的VMA相关的连接。因此，child对页面的访问将被RNIC拒绝。所有连接都在内核中进行管理，以防止恶意用户访问错误的远程容器内存。\n\n为了实现基于连接的访问控制，每个连接在创建和存储时都必须高效。幸运的是，DCQP很好地满足了这些要求。在子端，每个连接(DC key)只消耗12B ，不同的DC连接可以共享相同的DCQP。parent-side DC target consumes 144B。\n\n![截屏2023-01-16 13.34.56](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png)\n\n图片表示了基于dct的访问控制。在准备分叉时，MITOSIS从目标池中选择一个DC目标分配给每个parent VMA。pool在启动时初始化，并在后台定期填充。这些目标的DC key被装载在父进程的描述符中，以便子进程在恢复过程中可以将它们记录在VMA中。在读取父节点的page时，子节点将使用与页面VMA对应的key来发出RDMA请求。使用此方案，如果parent想要拒绝对该页的访问，它可以销毁相应的DC目标。\n\n\n\n## Pre-fetching and caching\n\n此处似乎有一定优化空间？可以采用计数法提升cache命中率。\n\n\n\n","slug":"MITOSIS-learning","published":1,"updated":"2023-01-30T11:15:24.052Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbq9z000ib9c92eyfdwjy","content":"<p><a href=\"https://github.com/ProjectMitosisOS\">MITOSIS Repo</a></p>\n<h2 id=\"Remote-Fork-C-R\"><a href=\"#Remote-Fork-C-R\" class=\"headerlink\" title=\"Remote Fork(C/R)\"></a>Remote Fork(C/R)</h2><p>现有容器只能通过C/R的方法进行远程Fork。这种方法需要父进程首先需要<em>checkpoints</em> its states，并将state储存到文件里。在通过remote file copy或distributed file system将文件复制到子进程。子进程根据文件信息对夫进程进行恢复。由于C/R需要复制全部内存信息，因此很慢。例如需要对1G内存进行拷贝，C/R甚至比冷启动还要慢2.7倍。</p>\n<h2 id=\"MITOSIS\"><a href=\"#MITOSIS\" class=\"headerlink\" title=\"MITOSIS\"></a>MITOSIS</h2><p>MITOSIS【maɪˈtoʊsɪs】通过RDMA模拟本地Fork来实现高效的远程分叉（具有类似COW机制）。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png\" alt=\"截屏2023-01-16 11.36.26\"></p>\n<p>首先，我们将父对象的Metadata(例如页表)复制到一个压缩描述符来派生子对象。Note:不将父进程的内存页复制到描述符中。然后通过RDMA将描述符复制到子进程以恢复父进程的Metadata。子进程的“远程内存访问”会触发页面错误，内核将读区读取远程页面。避免了传输整个容器状态。同时，MITOSIS直接使用单边RDMA Read来读取远程物理内存，绕过所有软件开销。</p>\n<h3 id=\"MITOSIS和C-R-fork的比较\"><a href=\"#MITOSIS和C-R-fork的比较\" class=\"headerlink\" title=\"MITOSIS和C/R fork的比较\"></a>MITOSIS和C/R fork的比较</h3><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png\" alt=\"截屏2023-01-14 13.40.51\"></p>\n<p><strong>MITOSIS由以下四个模块组成：</strong></p>\n<p>The <em>fork orchestrator</em> rehearsals the remote fork execution；准备fork和进行fork，使用rpc进行校验</p>\n<p>The <em>network daemon</em> manages a scalable RDMA connection pool；单侧RDMA，维护RDMA连接pool</p>\n<p>Extend OS’s <em>virtual memory subsystems</em> to utilize the remote memory with RDMA ；远程内存访问</p>\n<p><em>Fallback daemon</em> provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMA；恢复机制，回退到RPC</p>\n<h2 id=\"1）准备fork和进行fork\"><a href=\"#1）准备fork和进行fork\" class=\"headerlink\" title=\"1）准备fork和进行fork\"></a>1）准备fork和进行fork</h2><h3 id=\"1-fork-prepare\"><a href=\"#1-fork-prepare\" class=\"headerlink\" title=\"1.fork_prepare\"></a>1.fork_prepare</h3><p>准备fork，使用一个结构体保存：</p>\n<ul>\n<li>CPU寄存器状态（用于恢复运行状态）</li>\n<li>cGroup和Namespace（用于进行容器化）</li>\n<li>页表和虚拟内存区（用于远程内存访问）</li>\n<li>打开文件信息（重新打开文件，使用CRIU）</li>\n</ul>\n<p>保存这些信息，结构体很小，大概是KB级别</p>\n<h3 id=\"2-fork-resume\"><a href=\"#2-fork-resume\" class=\"headerlink\" title=\"2.fork_resume\"></a>2.fork_resume</h3><p>fork_resume从父进程获取descriptor，并恢复执行状态。</p>\n<p>使用oneside RDMA获取descriptor。首先子进程通过RPC向父进程发一个authentication RPC，若认证通过，则父进程会返回descriptor’s stored address和payload。之后子进程就可以使用oneside RDMA获取descriptor。</p>\n<p>获取到descriptor后，恢复容器状态。(1)设置cgroups和命名空间以匹配父操作系统的设置 (2)切换:用父进程的CPU寄存器、页表和I/O描述符替换调用方的CPU寄存器。此外引入SOCK以完成快速容器恢复。</p>\n<h2 id=\"2）单侧RDMA\"><a href=\"#2）单侧RDMA\" class=\"headerlink\" title=\"2）单侧RDMA\"></a>2）单侧RDMA</h2><p>RDMA：有三种QP类型</p>\n<p>RDMA连接消耗较大，速度较慢。因此使用无连接的oneside RDMA。因此改进RDMA连接（DCT-dynamic connected transport），DCT保留了RC的功能，并进一步提供了一种无连接的方式:单个DCQP可以与不同的节点通信。</p>\n<p>目标节点只需要创建一个DC，该DC由节点的RDMA地址和12B DC key标识。在知道key后，子节点可以在没有连接的情况下向相应的目标发送单侧RDMA请求，硬件会承载数据处理连接，速度极快(1μs以内).</p>\n<p>基于DCT，网络守护进程管理一个小型内核空间DCQP池，用于处理来自子进程的RDMA请求。通常，每个cpu一个DCQP就足以充分利用RDMA。但是，仅使用DCT是不够的，因为孩子需要提前知道DCT key才能与父母通信。因此，MITOSIS实现了一个内核空间”fast RPC”来引导DCT。fast是一个基于ud的RPC，支持无连接。使用RPC，我们在RPC请求中装载与父对象关联的DCT键，以查询父对象的描述符。为了节省CPU资源，我们只部署了两个内核线程来处理rpc.</p>\n<h2 id=\"3）Virtual-memory-management\"><a href=\"#3）Virtual-memory-management\" class=\"headerlink\" title=\"3）Virtual memory management\"></a>3）Virtual memory management</h2><p>为了提高resume效率，直接将子节点映射页面的页表项(PTE)设置为父节点的物理地址(PA)。使用一个PTE中的remote bit来进行区分（remote bit位于PTE未被利用的高位）。在resume过程中，系统会设置remote bit并清除present bit，当子进程访问里该PTE，就会进入缺页中断，从而出发RDMA远程读取。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png\" alt=\"截屏2023-01-16 13.18.22\"></p>\n<p>如果错误页没有映射到父页，例如堆栈增长，我们就像处理普通的页错误一样在本地处理它。<br>否则，检查故障虚拟地址VA (virtual address)是否映射了远端PA。使用单边RDMA将远程page读到本地页。大多数子页面都可以通过RDMA恢复。在错过映射的情况下，则使用RPC映射。</p>\n<p>RPC：每个节点有一个回退守护进程，该守护进程生成内核线程来处理子节点的页请求（包含父节点标识符和请求的虚拟地址）。回退逻辑: 在检查请求的有效性之后，守护进程线程将代表父进程加载页面。如果加载成功，我们将把结果发回给子进程。</p>\n<p><strong>Access control and isolation</strong></p>\n<p>我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。</p>\n<p>直接暴露父节点的物理内存可以提高远程fork的速度。然而，我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。由于我们以cpu旁路的方式通过单边RDMA公开内存，因此只能利用RNIC进行控制。</p>\n<p>MITOSIS用一种基于连接的内存访问控制方法。将不同的RDMA连接分配到父虚拟内存区域(VMA)的不同部分，例如，每个VMA一个连接。如果映射的物理页不再属于父页，我们将破坏与该页的VMA相关的连接。因此，child对页面的访问将被RNIC拒绝。所有连接都在内核中进行管理，以防止恶意用户访问错误的远程容器内存。</p>\n<p>为了实现基于连接的访问控制，每个连接在创建和存储时都必须高效。幸运的是，DCQP很好地满足了这些要求。在子端，每个连接(DC key)只消耗12B ，不同的DC连接可以共享相同的DCQP。parent-side DC target consumes 144B。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png\" alt=\"截屏2023-01-16 13.34.56\"></p>\n<p>图片表示了基于dct的访问控制。在准备分叉时，MITOSIS从目标池中选择一个DC目标分配给每个parent VMA。pool在启动时初始化，并在后台定期填充。这些目标的DC key被装载在父进程的描述符中，以便子进程在恢复过程中可以将它们记录在VMA中。在读取父节点的page时，子节点将使用与页面VMA对应的key来发出RDMA请求。使用此方案，如果parent想要拒绝对该页的访问，它可以销毁相应的DC目标。</p>\n<h2 id=\"Pre-fetching-and-caching\"><a href=\"#Pre-fetching-and-caching\" class=\"headerlink\" title=\"Pre-fetching and caching\"></a>Pre-fetching and caching</h2><p>此处似乎有一定优化空间？可以采用计数法提升cache命中率。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://github.com/ProjectMitosisOS\">MITOSIS Repo</a></p>\n<h2 id=\"Remote-Fork-C-R\"><a href=\"#Remote-Fork-C-R\" class=\"headerlink\" title=\"Remote Fork(C/R)\"></a>Remote Fork(C/R)</h2><p>现有容器只能通过C/R的方法进行远程Fork。这种方法需要父进程首先需要<em>checkpoints</em> its states，并将state储存到文件里。在通过remote file copy或distributed file system将文件复制到子进程。子进程根据文件信息对夫进程进行恢复。由于C/R需要复制全部内存信息，因此很慢。例如需要对1G内存进行拷贝，C/R甚至比冷启动还要慢2.7倍。</p>\n<h2 id=\"MITOSIS\"><a href=\"#MITOSIS\" class=\"headerlink\" title=\"MITOSIS\"></a>MITOSIS</h2><p>MITOSIS【maɪˈtoʊsɪs】通过RDMA模拟本地Fork来实现高效的远程分叉（具有类似COW机制）。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2011.36.26.png\" alt=\"截屏2023-01-16 11.36.26\"></p>\n<p>首先，我们将父对象的Metadata(例如页表)复制到一个压缩描述符来派生子对象。Note:不将父进程的内存页复制到描述符中。然后通过RDMA将描述符复制到子进程以恢复父进程的Metadata。子进程的“远程内存访问”会触发页面错误，内核将读区读取远程页面。避免了传输整个容器状态。同时，MITOSIS直接使用单边RDMA Read来读取远程物理内存，绕过所有软件开销。</p>\n<h3 id=\"MITOSIS和C-R-fork的比较\"><a href=\"#MITOSIS和C-R-fork的比较\" class=\"headerlink\" title=\"MITOSIS和C/R fork的比较\"></a>MITOSIS和C/R fork的比较</h3><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-14%2013.40.51.png\" alt=\"截屏2023-01-14 13.40.51\"></p>\n<p><strong>MITOSIS由以下四个模块组成：</strong></p>\n<p>The <em>fork orchestrator</em> rehearsals the remote fork execution；准备fork和进行fork，使用rpc进行校验</p>\n<p>The <em>network daemon</em> manages a scalable RDMA connection pool；单侧RDMA，维护RDMA连接pool</p>\n<p>Extend OS’s <em>virtual memory subsystems</em> to utilize the remote memory with RDMA ；远程内存访问</p>\n<p><em>Fallback daemon</em> provides RPC handlers to restore rare remote memory accesses that cannot utilize RDMA；恢复机制，回退到RPC</p>\n<h2 id=\"1）准备fork和进行fork\"><a href=\"#1）准备fork和进行fork\" class=\"headerlink\" title=\"1）准备fork和进行fork\"></a>1）准备fork和进行fork</h2><h3 id=\"1-fork-prepare\"><a href=\"#1-fork-prepare\" class=\"headerlink\" title=\"1.fork_prepare\"></a>1.fork_prepare</h3><p>准备fork，使用一个结构体保存：</p>\n<ul>\n<li>CPU寄存器状态（用于恢复运行状态）</li>\n<li>cGroup和Namespace（用于进行容器化）</li>\n<li>页表和虚拟内存区（用于远程内存访问）</li>\n<li>打开文件信息（重新打开文件，使用CRIU）</li>\n</ul>\n<p>保存这些信息，结构体很小，大概是KB级别</p>\n<h3 id=\"2-fork-resume\"><a href=\"#2-fork-resume\" class=\"headerlink\" title=\"2.fork_resume\"></a>2.fork_resume</h3><p>fork_resume从父进程获取descriptor，并恢复执行状态。</p>\n<p>使用oneside RDMA获取descriptor。首先子进程通过RPC向父进程发一个authentication RPC，若认证通过，则父进程会返回descriptor’s stored address和payload。之后子进程就可以使用oneside RDMA获取descriptor。</p>\n<p>获取到descriptor后，恢复容器状态。(1)设置cgroups和命名空间以匹配父操作系统的设置 (2)切换:用父进程的CPU寄存器、页表和I/O描述符替换调用方的CPU寄存器。此外引入SOCK以完成快速容器恢复。</p>\n<h2 id=\"2）单侧RDMA\"><a href=\"#2）单侧RDMA\" class=\"headerlink\" title=\"2）单侧RDMA\"></a>2）单侧RDMA</h2><p>RDMA：有三种QP类型</p>\n<p>RDMA连接消耗较大，速度较慢。因此使用无连接的oneside RDMA。因此改进RDMA连接（DCT-dynamic connected transport），DCT保留了RC的功能，并进一步提供了一种无连接的方式:单个DCQP可以与不同的节点通信。</p>\n<p>目标节点只需要创建一个DC，该DC由节点的RDMA地址和12B DC key标识。在知道key后，子节点可以在没有连接的情况下向相应的目标发送单侧RDMA请求，硬件会承载数据处理连接，速度极快(1μs以内).</p>\n<p>基于DCT，网络守护进程管理一个小型内核空间DCQP池，用于处理来自子进程的RDMA请求。通常，每个cpu一个DCQP就足以充分利用RDMA。但是，仅使用DCT是不够的，因为孩子需要提前知道DCT key才能与父母通信。因此，MITOSIS实现了一个内核空间”fast RPC”来引导DCT。fast是一个基于ud的RPC，支持无连接。使用RPC，我们在RPC请求中装载与父对象关联的DCT键，以查询父对象的描述符。为了节省CPU资源，我们只部署了两个内核线程来处理rpc.</p>\n<h2 id=\"3）Virtual-memory-management\"><a href=\"#3）Virtual-memory-management\" class=\"headerlink\" title=\"3）Virtual memory management\"></a>3）Virtual memory management</h2><p>为了提高resume效率，直接将子节点映射页面的页表项(PTE)设置为父节点的物理地址(PA)。使用一个PTE中的remote bit来进行区分（remote bit位于PTE未被利用的高位）。在resume过程中，系统会设置remote bit并清除present bit，当子进程访问里该PTE，就会进入缺页中断，从而出发RDMA远程读取。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.18.22.png\" alt=\"截屏2023-01-16 13.18.22\"></p>\n<p>如果错误页没有映射到父页，例如堆栈增长，我们就像处理普通的页错误一样在本地处理它。<br>否则，检查故障虚拟地址VA (virtual address)是否映射了远端PA。使用单边RDMA将远程page读到本地页。大多数子页面都可以通过RDMA恢复。在错过映射的情况下，则使用RPC映射。</p>\n<p>RPC：每个节点有一个回退守护进程，该守护进程生成内核线程来处理子节点的页请求（包含父节点标识符和请求的虚拟地址）。回退逻辑: 在检查请求的有效性之后，守护进程线程将代表父进程加载页面。如果加载成功，我们将把结果发回给子进程。</p>\n<p><strong>Access control and isolation</strong></p>\n<p>我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。</p>\n<p>直接暴露父节点的物理内存可以提高远程fork的速度。然而，我们需要拒绝对不再属于父节点的映射页的访问，并正确隔离对不同容器的访问。由于我们以cpu旁路的方式通过单边RDMA公开内存，因此只能利用RNIC进行控制。</p>\n<p>MITOSIS用一种基于连接的内存访问控制方法。将不同的RDMA连接分配到父虚拟内存区域(VMA)的不同部分，例如，每个VMA一个连接。如果映射的物理页不再属于父页，我们将破坏与该页的VMA相关的连接。因此，child对页面的访问将被RNIC拒绝。所有连接都在内核中进行管理，以防止恶意用户访问错误的远程容器内存。</p>\n<p>为了实现基于连接的访问控制，每个连接在创建和存储时都必须高效。幸运的是，DCQP很好地满足了这些要求。在子端，每个连接(DC key)只消耗12B ，不同的DC连接可以共享相同的DCQP。parent-side DC target consumes 144B。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-16%2013.34.56.png\" alt=\"截屏2023-01-16 13.34.56\"></p>\n<p>图片表示了基于dct的访问控制。在准备分叉时，MITOSIS从目标池中选择一个DC目标分配给每个parent VMA。pool在启动时初始化，并在后台定期填充。这些目标的DC key被装载在父进程的描述符中，以便子进程在恢复过程中可以将它们记录在VMA中。在读取父节点的page时，子节点将使用与页面VMA对应的key来发出RDMA请求。使用此方案，如果parent想要拒绝对该页的访问，它可以销毁相应的DC目标。</p>\n<h2 id=\"Pre-fetching-and-caching\"><a href=\"#Pre-fetching-and-caching\" class=\"headerlink\" title=\"Pre-fetching and caching\"></a>Pre-fetching and caching</h2><p>此处似乎有一定优化空间？可以采用计数法提升cache命中率。</p>\n"},{"title":"MIT 6.s081 Lab3 Page Table","date":"2023-01-11T04:42:53.000Z","_content":"\n## 页表结构推导\n\nRICS-V架构，2^39bit内存可用，2^37Byte。每页是4096Byte，2^12 Byte\n\n逻辑上，页表需要2^27个pte，以映射全部物理地址(pte是页表中对以应一个物理内存地址的信息存储单元)。\n\n每个pte包含64bit（44bit PNN，一些Flag）。以下为pte结构：\n\n![截屏2023-01-11 13.57.28](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png)\n\n但是，2^27个pte需要内存：2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MB。若存储全部进程的pte则需要占用大量内存。因此使用三级页表结构：\n\n一个页表页，包含512个pte。512^3=(2^9)^3，因此理论上可以使用三级页表表示全部的物理地址。当一块虚拟地址没有被使用，则相应的页表不会被初始化，则不需要使用内存。\n\n![截屏2023-01-11 13.30.54](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png)\n\n根据虚拟地址，获取相应pte (若该虚拟地址未被初始化，则进行相应的页表初始化)：\n\n```\n// pagetable 根页表\n// va 虚拟地址\n// alloc是否初始化\npte_t* walk(pagetable_t pagetable, uint64 va, int alloc){\n  if(va >= MAXVA)\n    panic(\"walk\");\n\n\t// 三级页表\n  for(int level = 2; level > 0; level--) {\n    pte_t *pte = &pagetable[PX(level, va)];\n    if(*pte & PTE_V) { //已经分配\n      pagetable = (pagetable_t)PTE2PA(*pte); //跳转到下一级页表\n    } else { // 为分配此级页表\n      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //分配一页，并跳转到下一级页表\n        return 0;\n      memset(pagetable, 0, PGSIZE); //初始化页\n      *pte = PA2PTE(pagetable) | PTE_V; \n    }\n  }\n  return &pagetable[PX(0, va)];\n}\n```\n\n## 内核地址空间\n\n\n\n## 进程地址空间\n\n\n\n## Lab结果\n\n![截屏2023-01-13 15.03.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png)\n\n","source":"_posts/MIT6-s081-Lab3-Page-Table.md","raw":"---\ntitle: MIT 6.s081 Lab3 Page Table\ndate: 2023-01-11 12:42:53\ntags:\n---\n\n## 页表结构推导\n\nRICS-V架构，2^39bit内存可用，2^37Byte。每页是4096Byte，2^12 Byte\n\n逻辑上，页表需要2^27个pte，以映射全部物理地址(pte是页表中对以应一个物理内存地址的信息存储单元)。\n\n每个pte包含64bit（44bit PNN，一些Flag）。以下为pte结构：\n\n![截屏2023-01-11 13.57.28](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png)\n\n但是，2^27个pte需要内存：2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MB。若存储全部进程的pte则需要占用大量内存。因此使用三级页表结构：\n\n一个页表页，包含512个pte。512^3=(2^9)^3，因此理论上可以使用三级页表表示全部的物理地址。当一块虚拟地址没有被使用，则相应的页表不会被初始化，则不需要使用内存。\n\n![截屏2023-01-11 13.30.54](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png)\n\n根据虚拟地址，获取相应pte (若该虚拟地址未被初始化，则进行相应的页表初始化)：\n\n```\n// pagetable 根页表\n// va 虚拟地址\n// alloc是否初始化\npte_t* walk(pagetable_t pagetable, uint64 va, int alloc){\n  if(va >= MAXVA)\n    panic(\"walk\");\n\n\t// 三级页表\n  for(int level = 2; level > 0; level--) {\n    pte_t *pte = &pagetable[PX(level, va)];\n    if(*pte & PTE_V) { //已经分配\n      pagetable = (pagetable_t)PTE2PA(*pte); //跳转到下一级页表\n    } else { // 为分配此级页表\n      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //分配一页，并跳转到下一级页表\n        return 0;\n      memset(pagetable, 0, PGSIZE); //初始化页\n      *pte = PA2PTE(pagetable) | PTE_V; \n    }\n  }\n  return &pagetable[PX(0, va)];\n}\n```\n\n## 内核地址空间\n\n\n\n## 进程地址空间\n\n\n\n## Lab结果\n\n![截屏2023-01-13 15.03.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png)\n\n","slug":"MIT6-s081-Lab3-Page-Table","published":1,"updated":"2023-01-13T09:02:08.612Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa0000kb9c9d64k8w72","content":"<h2 id=\"页表结构推导\"><a href=\"#页表结构推导\" class=\"headerlink\" title=\"页表结构推导\"></a>页表结构推导</h2><p>RICS-V架构，2^39bit内存可用，2^37Byte。每页是4096Byte，2^12 Byte</p>\n<p>逻辑上，页表需要2^27个pte，以映射全部物理地址(pte是页表中对以应一个物理内存地址的信息存储单元)。</p>\n<p>每个pte包含64bit（44bit PNN，一些Flag）。以下为pte结构：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png\" alt=\"截屏2023-01-11 13.57.28\"></p>\n<p>但是，2^27个pte需要内存：2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MB。若存储全部进程的pte则需要占用大量内存。因此使用三级页表结构：</p>\n<p>一个页表页，包含512个pte。512^3=(2^9)^3，因此理论上可以使用三级页表表示全部的物理地址。当一块虚拟地址没有被使用，则相应的页表不会被初始化，则不需要使用内存。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png\" alt=\"截屏2023-01-11 13.30.54\"></p>\n<p>根据虚拟地址，获取相应pte (若该虚拟地址未被初始化，则进行相应的页表初始化)：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// pagetable 根页表</span><br><span class=\"line\">// va 虚拟地址</span><br><span class=\"line\">// alloc是否初始化</span><br><span class=\"line\">pte_t* walk(pagetable_t pagetable, uint64 va, int alloc)&#123;</span><br><span class=\"line\">  if(va &gt;= MAXVA)</span><br><span class=\"line\">    panic(&quot;walk&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 三级页表</span><br><span class=\"line\">  for(int level = 2; level &gt; 0; level--) &#123;</span><br><span class=\"line\">    pte_t *pte = &amp;pagetable[PX(level, va)];</span><br><span class=\"line\">    if(*pte &amp; PTE_V) &#123; //已经分配</span><br><span class=\"line\">      pagetable = (pagetable_t)PTE2PA(*pte); //跳转到下一级页表</span><br><span class=\"line\">    &#125; else &#123; // 为分配此级页表</span><br><span class=\"line\">      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //分配一页，并跳转到下一级页表</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">      memset(pagetable, 0, PGSIZE); //初始化页</span><br><span class=\"line\">      *pte = PA2PTE(pagetable) | PTE_V; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return &amp;pagetable[PX(0, va)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"内核地址空间\"><a href=\"#内核地址空间\" class=\"headerlink\" title=\"内核地址空间\"></a>内核地址空间</h2><h2 id=\"进程地址空间\"><a href=\"#进程地址空间\" class=\"headerlink\" title=\"进程地址空间\"></a>进程地址空间</h2><h2 id=\"Lab结果\"><a href=\"#Lab结果\" class=\"headerlink\" title=\"Lab结果\"></a>Lab结果</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png\" alt=\"截屏2023-01-13 15.03.29\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"页表结构推导\"><a href=\"#页表结构推导\" class=\"headerlink\" title=\"页表结构推导\"></a>页表结构推导</h2><p>RICS-V架构，2^39bit内存可用，2^37Byte。每页是4096Byte，2^12 Byte</p>\n<p>逻辑上，页表需要2^27个pte，以映射全部物理地址(pte是页表中对以应一个物理内存地址的信息存储单元)。</p>\n<p>每个pte包含64bit（44bit PNN，一些Flag）。以下为pte结构：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.57.28.png\" alt=\"截屏2023-01-11 13.57.28\"></p>\n<p>但是，2^27个pte需要内存：2^27 * 2^6 bit = 2^29 bit = 2^27byte = 2^10 * 2^10 * 2^9 byte = 512MB。若存储全部进程的pte则需要占用大量内存。因此使用三级页表结构：</p>\n<p>一个页表页，包含512个pte。512^3=(2^9)^3，因此理论上可以使用三级页表表示全部的物理地址。当一块虚拟地址没有被使用，则相应的页表不会被初始化，则不需要使用内存。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-11%2013.30.54.png\" alt=\"截屏2023-01-11 13.30.54\"></p>\n<p>根据虚拟地址，获取相应pte (若该虚拟地址未被初始化，则进行相应的页表初始化)：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// pagetable 根页表</span><br><span class=\"line\">// va 虚拟地址</span><br><span class=\"line\">// alloc是否初始化</span><br><span class=\"line\">pte_t* walk(pagetable_t pagetable, uint64 va, int alloc)&#123;</span><br><span class=\"line\">  if(va &gt;= MAXVA)</span><br><span class=\"line\">    panic(&quot;walk&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 三级页表</span><br><span class=\"line\">  for(int level = 2; level &gt; 0; level--) &#123;</span><br><span class=\"line\">    pte_t *pte = &amp;pagetable[PX(level, va)];</span><br><span class=\"line\">    if(*pte &amp; PTE_V) &#123; //已经分配</span><br><span class=\"line\">      pagetable = (pagetable_t)PTE2PA(*pte); //跳转到下一级页表</span><br><span class=\"line\">    &#125; else &#123; // 为分配此级页表</span><br><span class=\"line\">      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) //分配一页，并跳转到下一级页表</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">      memset(pagetable, 0, PGSIZE); //初始化页</span><br><span class=\"line\">      *pte = PA2PTE(pagetable) | PTE_V; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return &amp;pagetable[PX(0, va)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"内核地址空间\"><a href=\"#内核地址空间\" class=\"headerlink\" title=\"内核地址空间\"></a>内核地址空间</h2><h2 id=\"进程地址空间\"><a href=\"#进程地址空间\" class=\"headerlink\" title=\"进程地址空间\"></a>进程地址空间</h2><h2 id=\"Lab结果\"><a href=\"#Lab结果\" class=\"headerlink\" title=\"Lab结果\"></a>Lab结果</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-01-13%2015.03.29.png\" alt=\"截屏2023-01-13 15.03.29\"></p>\n"},{"title":"Serverless服务快速启动方案","date":"2023-02-07T03:37:23.000Z","_content":"\nVersion：2023-3-5\n\n## 1. 问题综述\n\n现尝试使用WASM、eBPF等技术优化Serverless服务。这一优化可以针对：实例启动速度、实例与外界交互能力、实例调度等方面。\n\n逻辑上来说，一个Serverless实例的运行，必然经过以下几个步骤：\n\t1.获取待运行负载（负载可以是:WebAssembly、java字节码、go字节码等，是待运行的核心逻辑）\n\t2.实例加载负载，进行启动\n\t3.实例接受待处理数据，进行运算，并返回结果\n\t4.运行结束，实例销毁\n\n**针对步骤1**，获取负载的常规方式是从对象存储服务下载负载，这一方法显然较慢。**AWS Lambda**对此提出了\"预置并发\"，这一服务可以在用户的虚拟子网中维持一个活跃的Lambda实例，从而避免冷启动。 **MITOSIS**某种意义上可以说是对\"预置并发\"进行了极致的优化，即使用RDMA从一个活跃的实例——Seed进行远程克隆，并使用COW渐进式的获取内存数据。**Faasm**针对此问题，则引入了一个KV数据库，存储各个server上实例的运行情况，从而实现了在已存在目标实例的server上处理任务，尽可能避免冷启动。这一优化是一种调度策略上的优化。\n\n概括来说，步骤一的优化有三个方面：\n\t1.将实例负载存放比较“近”的地方，如保留一个活跃实例\n\t2.使用尽可能快速的方式获取负载，如RDMA\n\t3.避免冷启动，进行调度优化\n\n**针对步骤2**，可以尝试优化启动速度本身，常见方式有优化编译产物、减小内存配置等，目前我们尝试采用的优化策略是使用WASM。（Faasm针对此步骤，使用了直接通过WASM runtime镜像启动的方法，优化了WASM容器启动的速度）\n\n**针对步骤3**，原生WASM需使用WASI与系统交互，这一方法可能性能较差/适用范围较小。因此尝试采用WASM-eBPF工具，将部分运算下沉到eBPF虚拟机进行，从而获得serverless服务与外界更好的交互能力。\n\n注：粗略估计，实际使用中Serverless服务绝大多数的对外交互都是网络交互，主要是读写数据。\n\n**针对步骤4**，暂无优化措施\n\n## 2. 加速Serverless启动的方案（运行状态恢复的三种路线）\n\n由于原生MITOSIS对RDMA硬件有硬性要求，且需要修改内核，通用性相对较低。因此尝试利用WASM+eBPF+XDP等，实现一种更友好的Serverless快速启动策略，以下将这一策略称为MITOSIS-eBPF。（此处的mitosis取英文本身意思：有丝分裂，这是由于下列方案思路依然与原生mitosis类似，是从一个活跃实例快速分裂出大量子实例）\n\n目前实现MITOSIS-eBPF有三种思路： \n\n### 1）在内核恢复进程\n\n在内核恢复进程状态，这一思路与原生MITOSIS一致，需实现以下几点：\n\n1. 对“被Fork进程”进行Metadata快照，并将此快照传递给“子进程”\n2. 子进程需根据pte探知该Page是否在本地，若不在本地，则需要进行远程页获取\n3. MITOSIS-eBPF需要能够读取指定进程的数据，从而通过rpc/XQUIC等方式传递给子进程\n\n其中步骤二，原生MITOSIS的实现方式是利用pte中未被使用的高位作为标记，从而判断该page是否在本地。这一操作涉及内核修改，似乎无法通过eBPF实现，因此“在内核恢复进程”这一方案无法避免修改内核。\n\n此外，XDP本身不具有完整的协议栈，无法保证数据传输的可靠。基于AF_XDP的成熟数据传输工具XQUIC，实现的是一个纯用户态的协议栈，因此似乎不适合对内核的Page进行传输。\n\n### 2）在用户态WASM虚拟机中恢复进程（无COW）\n\n以Faasm为例，Faasm会将容器快照保存在AWS S3中，收到相应请求时进行下载，并根据快照进行运行状态恢复。为了解决S3读取速度较慢的问题，可以在Faasm中添加一个类似MITOSIS的特性：即任意两个Faasm实例之间，可以进行容器状态拷贝。具体细节如下：\n\n1. 当一个Faasm容器收到了“拷贝请求”后，对自身的容器状态进行快照。之后使用基于xdp (XQUIC)的数据传输方式将快照发送至发起“拷贝请求”的实例\n2. Faasm被拷贝后，将快照缓存在内存中，下次被拷贝就不需要再次生成快照。同时之后其他Faasm实例都通过该fassm进行快照获取(可能需要在kv数据库中加入记录)。\n\n在加速冷启动方面，Faasm本身有使用kv数据库寻找已存在目标负载的实例的机制。这一机制存在一个问题，若某一请求大量存在，则将会有大量wasm实例在同一server上启动。此时，“远程状态恢复”就可以帮助实现快速跨机器启动实例，或可以提升faasm的性能。\n\n![截屏2023-03-01 20.41.43](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-01%2020.41.43.png)\n\n这一方案仅仅针对Faasm或其他serverless平台进行拓展，无法形成通用解决方案，属于一个工程性问题。\n\n### 3）在用户态WASM虚拟机中恢复进程（有COW）\n\n**进一步研究**：https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/\n\n针对Faasm这一Serverless平台，Faasm中的Function实际运行在WASM虚拟机中。因此按照以下步骤进行远程Fork：\n\n1. 子进程的WASM虚拟机初始化\n2. 利用XQUIC，从“被Fork进程”获取“元数据”，在WASM虚拟机中进行状态恢复\n3. 若子进程的WASM虚拟机遇到“缺页”，则利用XQUIC从进行远程页获取\n\n这一方案的优势：\n\n1. Faasm使用了Photo Faaslet快照+COW进行冷启动加速，因此“在WASM虚拟机中运用COW恢复进程状态”的可行性已知\n2. 和MITOSIS思路完全一致，但全部在用户态完成，避免修改内核\n\n这一方案的缺点：\n\n1. 这一方案需要改WASM runtime的源代码，不是通用解决方案。\n\n2. 由于用户态COW过程跨越了较多层，若Function涉及较多的远程页获取，可能会导致程序运行较慢，甚至有可能慢于原生Faasm的冷启动。\n\n    \n\n\n\n## 3. 在WASM虚拟机中COW恢复进程的可行性论证\n\n### 1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\n\nFaasm用了WARM里的AOT接口进行快照生成：\n\n```c\naot_comp_context_t aot_create_comp_context(aot_comp_data_t comp_data, aot_comp_option_t option);\n```\n\nWAMR源代码分析：\n\n***WAMR runtime(WAMR)的内存结构是分页的，且页是在内存上连续的片段，有明确的起始地址和Page size（数组），因此也许可以比较方便的进行远程页拷贝，需要改AOT的代码。***\n\n```c\n/**\n * Compiler context\n */\ntypedef struct AOTCompContext {\n    AOTCompData *comp_data;      // 内存数据，是分页的\n\n   \t// Many llvm config data\n\t\t...\n     \n    /* Function contexts */\n    AOTFuncContext **func_ctxes; // 函数context\n    uint32 func_ctx_count;       // 程序计数器\n    char **custom_sections_wp;\n    uint32 custom_sections_count;\n\n    /* 3rd-party toolchains */\n    /* External llc compiler, if specified, wamrc will emit the llvm-ir file and\n     * invoke the llc compiler to generate object file.\n     * This can be used when we want to benefit from the optimization of other\n     * LLVM based toolchains */\n    const char *external_llc_compiler;\n    const char *llc_compiler_flags;\n    /* External asm compiler, if specified, wamrc will emit the text-based\n     * assembly file (.s) and invoke the llc compiler to generate object file.\n     * This will be useful when the upstream LLVM doesn't support to emit object\n     * file for some architecture (such as arc) */\n    const char *external_asm_compiler;\n    const char *asm_compiler_flags;\n} AOTCompContext;\n```\n\n\n\n```c\ntypedef struct AOTCompData {\n    /* Import memories */\n    uint32 import_memory_count;\n    AOTImportMemory *import_memories;\n\n    /* Memories */\n    uint32 memory_count;\n    AOTMemory *memories;\n  \n  \t/*\n  \ttypedef struct AOTMemory {\n    \tuint32 memory_flags;\n    \tuint32 num_bytes_per_page;\n    \tuint32 mem_init_page_count;\n    \tuint32 mem_max_page_count;\n\t\t} AOTMemory;\n\t\t\n  \t*/\n\n    /* Memory init data info */\n    uint32 mem_init_data_count;\n    AOTMemInitData **mem_init_data_list;\n\n    /* Import tables */\n    uint32 import_table_count;\n    AOTImportTable *import_tables;\n\n    /* Tables */\n    uint32 table_count;\n    AOTTable *tables;\n\n    /* Table init data info */\n    uint32 table_init_data_count;\n    AOTTableInitData **table_init_data_list;\n\n    /* Import globals */\n    uint32 import_global_count;\n    AOTImportGlobal *import_globals;\n\n    /* Globals */\n    uint32 global_count;\n    AOTGlobal *globals;\n\n    /* Function types */\n    uint32 func_type_count;\n    AOTFuncType **func_types;\n\n    /* Import functions */\n    uint32 import_func_count;\n    AOTImportFunc *import_funcs;\n\n    /* Functions */\n    uint32 func_count;\n    AOTFunc **funcs;\n\n    /* Custom name sections */\n    const uint8 *name_section_buf;\n    const uint8 *name_section_buf_end;\n    uint8 *aot_name_section_buf;\n    uint32 aot_name_section_size;\n\n    uint32 global_data_size;\n\n    uint32 start_func_index;\n    uint32 malloc_func_index;\n    uint32 free_func_index;\n    uint32 retain_func_index;\n\n    uint32 aux_data_end_global_index;\n    uint32 aux_data_end;\n    uint32 aux_heap_base_global_index;\n    uint32 aux_heap_base;\n    uint32 aux_stack_top_global_index;\n    uint32 aux_stack_bottom;\n    uint32 aux_stack_size;\n\n    WASMModule *wasm_module;\n#if WASM_ENABLE_DEBUG_AOT != 0\n    dwar_extractor_handle_t extractor;\n#endif\n} AOTCompData;\n```\n\n\n\n### 2.ebpf高速网络通信方案\nXQUIC\n\n\n\n\n\n\n\n","source":"_posts/MITOSIS-by-WASM-ebpf-in-Faasm.md","raw":"---\n\ntitle: Serverless服务快速启动方案\ndate: 2023-02-07 11:37:23\ntags:\n---\n\nVersion：2023-3-5\n\n## 1. 问题综述\n\n现尝试使用WASM、eBPF等技术优化Serverless服务。这一优化可以针对：实例启动速度、实例与外界交互能力、实例调度等方面。\n\n逻辑上来说，一个Serverless实例的运行，必然经过以下几个步骤：\n\t1.获取待运行负载（负载可以是:WebAssembly、java字节码、go字节码等，是待运行的核心逻辑）\n\t2.实例加载负载，进行启动\n\t3.实例接受待处理数据，进行运算，并返回结果\n\t4.运行结束，实例销毁\n\n**针对步骤1**，获取负载的常规方式是从对象存储服务下载负载，这一方法显然较慢。**AWS Lambda**对此提出了\"预置并发\"，这一服务可以在用户的虚拟子网中维持一个活跃的Lambda实例，从而避免冷启动。 **MITOSIS**某种意义上可以说是对\"预置并发\"进行了极致的优化，即使用RDMA从一个活跃的实例——Seed进行远程克隆，并使用COW渐进式的获取内存数据。**Faasm**针对此问题，则引入了一个KV数据库，存储各个server上实例的运行情况，从而实现了在已存在目标实例的server上处理任务，尽可能避免冷启动。这一优化是一种调度策略上的优化。\n\n概括来说，步骤一的优化有三个方面：\n\t1.将实例负载存放比较“近”的地方，如保留一个活跃实例\n\t2.使用尽可能快速的方式获取负载，如RDMA\n\t3.避免冷启动，进行调度优化\n\n**针对步骤2**，可以尝试优化启动速度本身，常见方式有优化编译产物、减小内存配置等，目前我们尝试采用的优化策略是使用WASM。（Faasm针对此步骤，使用了直接通过WASM runtime镜像启动的方法，优化了WASM容器启动的速度）\n\n**针对步骤3**，原生WASM需使用WASI与系统交互，这一方法可能性能较差/适用范围较小。因此尝试采用WASM-eBPF工具，将部分运算下沉到eBPF虚拟机进行，从而获得serverless服务与外界更好的交互能力。\n\n注：粗略估计，实际使用中Serverless服务绝大多数的对外交互都是网络交互，主要是读写数据。\n\n**针对步骤4**，暂无优化措施\n\n## 2. 加速Serverless启动的方案（运行状态恢复的三种路线）\n\n由于原生MITOSIS对RDMA硬件有硬性要求，且需要修改内核，通用性相对较低。因此尝试利用WASM+eBPF+XDP等，实现一种更友好的Serverless快速启动策略，以下将这一策略称为MITOSIS-eBPF。（此处的mitosis取英文本身意思：有丝分裂，这是由于下列方案思路依然与原生mitosis类似，是从一个活跃实例快速分裂出大量子实例）\n\n目前实现MITOSIS-eBPF有三种思路： \n\n### 1）在内核恢复进程\n\n在内核恢复进程状态，这一思路与原生MITOSIS一致，需实现以下几点：\n\n1. 对“被Fork进程”进行Metadata快照，并将此快照传递给“子进程”\n2. 子进程需根据pte探知该Page是否在本地，若不在本地，则需要进行远程页获取\n3. MITOSIS-eBPF需要能够读取指定进程的数据，从而通过rpc/XQUIC等方式传递给子进程\n\n其中步骤二，原生MITOSIS的实现方式是利用pte中未被使用的高位作为标记，从而判断该page是否在本地。这一操作涉及内核修改，似乎无法通过eBPF实现，因此“在内核恢复进程”这一方案无法避免修改内核。\n\n此外，XDP本身不具有完整的协议栈，无法保证数据传输的可靠。基于AF_XDP的成熟数据传输工具XQUIC，实现的是一个纯用户态的协议栈，因此似乎不适合对内核的Page进行传输。\n\n### 2）在用户态WASM虚拟机中恢复进程（无COW）\n\n以Faasm为例，Faasm会将容器快照保存在AWS S3中，收到相应请求时进行下载，并根据快照进行运行状态恢复。为了解决S3读取速度较慢的问题，可以在Faasm中添加一个类似MITOSIS的特性：即任意两个Faasm实例之间，可以进行容器状态拷贝。具体细节如下：\n\n1. 当一个Faasm容器收到了“拷贝请求”后，对自身的容器状态进行快照。之后使用基于xdp (XQUIC)的数据传输方式将快照发送至发起“拷贝请求”的实例\n2. Faasm被拷贝后，将快照缓存在内存中，下次被拷贝就不需要再次生成快照。同时之后其他Faasm实例都通过该fassm进行快照获取(可能需要在kv数据库中加入记录)。\n\n在加速冷启动方面，Faasm本身有使用kv数据库寻找已存在目标负载的实例的机制。这一机制存在一个问题，若某一请求大量存在，则将会有大量wasm实例在同一server上启动。此时，“远程状态恢复”就可以帮助实现快速跨机器启动实例，或可以提升faasm的性能。\n\n![截屏2023-03-01 20.41.43](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-01%2020.41.43.png)\n\n这一方案仅仅针对Faasm或其他serverless平台进行拓展，无法形成通用解决方案，属于一个工程性问题。\n\n### 3）在用户态WASM虚拟机中恢复进程（有COW）\n\n**进一步研究**：https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/\n\n针对Faasm这一Serverless平台，Faasm中的Function实际运行在WASM虚拟机中。因此按照以下步骤进行远程Fork：\n\n1. 子进程的WASM虚拟机初始化\n2. 利用XQUIC，从“被Fork进程”获取“元数据”，在WASM虚拟机中进行状态恢复\n3. 若子进程的WASM虚拟机遇到“缺页”，则利用XQUIC从进行远程页获取\n\n这一方案的优势：\n\n1. Faasm使用了Photo Faaslet快照+COW进行冷启动加速，因此“在WASM虚拟机中运用COW恢复进程状态”的可行性已知\n2. 和MITOSIS思路完全一致，但全部在用户态完成，避免修改内核\n\n这一方案的缺点：\n\n1. 这一方案需要改WASM runtime的源代码，不是通用解决方案。\n\n2. 由于用户态COW过程跨越了较多层，若Function涉及较多的远程页获取，可能会导致程序运行较慢，甚至有可能慢于原生Faasm的冷启动。\n\n    \n\n\n\n## 3. 在WASM虚拟机中COW恢复进程的可行性论证\n\n### 1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\n\nFaasm用了WARM里的AOT接口进行快照生成：\n\n```c\naot_comp_context_t aot_create_comp_context(aot_comp_data_t comp_data, aot_comp_option_t option);\n```\n\nWAMR源代码分析：\n\n***WAMR runtime(WAMR)的内存结构是分页的，且页是在内存上连续的片段，有明确的起始地址和Page size（数组），因此也许可以比较方便的进行远程页拷贝，需要改AOT的代码。***\n\n```c\n/**\n * Compiler context\n */\ntypedef struct AOTCompContext {\n    AOTCompData *comp_data;      // 内存数据，是分页的\n\n   \t// Many llvm config data\n\t\t...\n     \n    /* Function contexts */\n    AOTFuncContext **func_ctxes; // 函数context\n    uint32 func_ctx_count;       // 程序计数器\n    char **custom_sections_wp;\n    uint32 custom_sections_count;\n\n    /* 3rd-party toolchains */\n    /* External llc compiler, if specified, wamrc will emit the llvm-ir file and\n     * invoke the llc compiler to generate object file.\n     * This can be used when we want to benefit from the optimization of other\n     * LLVM based toolchains */\n    const char *external_llc_compiler;\n    const char *llc_compiler_flags;\n    /* External asm compiler, if specified, wamrc will emit the text-based\n     * assembly file (.s) and invoke the llc compiler to generate object file.\n     * This will be useful when the upstream LLVM doesn't support to emit object\n     * file for some architecture (such as arc) */\n    const char *external_asm_compiler;\n    const char *asm_compiler_flags;\n} AOTCompContext;\n```\n\n\n\n```c\ntypedef struct AOTCompData {\n    /* Import memories */\n    uint32 import_memory_count;\n    AOTImportMemory *import_memories;\n\n    /* Memories */\n    uint32 memory_count;\n    AOTMemory *memories;\n  \n  \t/*\n  \ttypedef struct AOTMemory {\n    \tuint32 memory_flags;\n    \tuint32 num_bytes_per_page;\n    \tuint32 mem_init_page_count;\n    \tuint32 mem_max_page_count;\n\t\t} AOTMemory;\n\t\t\n  \t*/\n\n    /* Memory init data info */\n    uint32 mem_init_data_count;\n    AOTMemInitData **mem_init_data_list;\n\n    /* Import tables */\n    uint32 import_table_count;\n    AOTImportTable *import_tables;\n\n    /* Tables */\n    uint32 table_count;\n    AOTTable *tables;\n\n    /* Table init data info */\n    uint32 table_init_data_count;\n    AOTTableInitData **table_init_data_list;\n\n    /* Import globals */\n    uint32 import_global_count;\n    AOTImportGlobal *import_globals;\n\n    /* Globals */\n    uint32 global_count;\n    AOTGlobal *globals;\n\n    /* Function types */\n    uint32 func_type_count;\n    AOTFuncType **func_types;\n\n    /* Import functions */\n    uint32 import_func_count;\n    AOTImportFunc *import_funcs;\n\n    /* Functions */\n    uint32 func_count;\n    AOTFunc **funcs;\n\n    /* Custom name sections */\n    const uint8 *name_section_buf;\n    const uint8 *name_section_buf_end;\n    uint8 *aot_name_section_buf;\n    uint32 aot_name_section_size;\n\n    uint32 global_data_size;\n\n    uint32 start_func_index;\n    uint32 malloc_func_index;\n    uint32 free_func_index;\n    uint32 retain_func_index;\n\n    uint32 aux_data_end_global_index;\n    uint32 aux_data_end;\n    uint32 aux_heap_base_global_index;\n    uint32 aux_heap_base;\n    uint32 aux_stack_top_global_index;\n    uint32 aux_stack_bottom;\n    uint32 aux_stack_size;\n\n    WASMModule *wasm_module;\n#if WASM_ENABLE_DEBUG_AOT != 0\n    dwar_extractor_handle_t extractor;\n#endif\n} AOTCompData;\n```\n\n\n\n### 2.ebpf高速网络通信方案\nXQUIC\n\n\n\n\n\n\n\n","slug":"MITOSIS-by-WASM-ebpf-in-Faasm","published":1,"updated":"2023-03-10T14:44:46.987Z","_id":"clepqbqa0000mb9c90m74gd0x","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Version：2023-3-5</p>\n<h2 id=\"1-问题综述\"><a href=\"#1-问题综述\" class=\"headerlink\" title=\"1. 问题综述\"></a>1. 问题综述</h2><p>现尝试使用WASM、eBPF等技术优化Serverless服务。这一优化可以针对：实例启动速度、实例与外界交互能力、实例调度等方面。</p>\n<p>逻辑上来说，一个Serverless实例的运行，必然经过以下几个步骤：<br>    1.获取待运行负载（负载可以是:WebAssembly、java字节码、go字节码等，是待运行的核心逻辑）<br>    2.实例加载负载，进行启动<br>    3.实例接受待处理数据，进行运算，并返回结果<br>    4.运行结束，实例销毁</p>\n<p><strong>针对步骤1</strong>，获取负载的常规方式是从对象存储服务下载负载，这一方法显然较慢。<strong>AWS Lambda</strong>对此提出了”预置并发”，这一服务可以在用户的虚拟子网中维持一个活跃的Lambda实例，从而避免冷启动。 <strong>MITOSIS</strong>某种意义上可以说是对”预置并发”进行了极致的优化，即使用RDMA从一个活跃的实例——Seed进行远程克隆，并使用COW渐进式的获取内存数据。<strong>Faasm</strong>针对此问题，则引入了一个KV数据库，存储各个server上实例的运行情况，从而实现了在已存在目标实例的server上处理任务，尽可能避免冷启动。这一优化是一种调度策略上的优化。</p>\n<p>概括来说，步骤一的优化有三个方面：<br>    1.将实例负载存放比较“近”的地方，如保留一个活跃实例<br>    2.使用尽可能快速的方式获取负载，如RDMA<br>    3.避免冷启动，进行调度优化</p>\n<p><strong>针对步骤2</strong>，可以尝试优化启动速度本身，常见方式有优化编译产物、减小内存配置等，目前我们尝试采用的优化策略是使用WASM。（Faasm针对此步骤，使用了直接通过WASM runtime镜像启动的方法，优化了WASM容器启动的速度）</p>\n<p><strong>针对步骤3</strong>，原生WASM需使用WASI与系统交互，这一方法可能性能较差/适用范围较小。因此尝试采用WASM-eBPF工具，将部分运算下沉到eBPF虚拟机进行，从而获得serverless服务与外界更好的交互能力。</p>\n<p>注：粗略估计，实际使用中Serverless服务绝大多数的对外交互都是网络交互，主要是读写数据。</p>\n<p><strong>针对步骤4</strong>，暂无优化措施</p>\n<h2 id=\"2-加速Serverless启动的方案（运行状态恢复的三种路线）\"><a href=\"#2-加速Serverless启动的方案（运行状态恢复的三种路线）\" class=\"headerlink\" title=\"2. 加速Serverless启动的方案（运行状态恢复的三种路线）\"></a>2. 加速Serverless启动的方案（运行状态恢复的三种路线）</h2><p>由于原生MITOSIS对RDMA硬件有硬性要求，且需要修改内核，通用性相对较低。因此尝试利用WASM+eBPF+XDP等，实现一种更友好的Serverless快速启动策略，以下将这一策略称为MITOSIS-eBPF。（此处的mitosis取英文本身意思：有丝分裂，这是由于下列方案思路依然与原生mitosis类似，是从一个活跃实例快速分裂出大量子实例）</p>\n<p>目前实现MITOSIS-eBPF有三种思路： </p>\n<h3 id=\"1）在内核恢复进程\"><a href=\"#1）在内核恢复进程\" class=\"headerlink\" title=\"1）在内核恢复进程\"></a>1）在内核恢复进程</h3><p>在内核恢复进程状态，这一思路与原生MITOSIS一致，需实现以下几点：</p>\n<ol>\n<li>对“被Fork进程”进行Metadata快照，并将此快照传递给“子进程”</li>\n<li>子进程需根据pte探知该Page是否在本地，若不在本地，则需要进行远程页获取</li>\n<li>MITOSIS-eBPF需要能够读取指定进程的数据，从而通过rpc/XQUIC等方式传递给子进程</li>\n</ol>\n<p>其中步骤二，原生MITOSIS的实现方式是利用pte中未被使用的高位作为标记，从而判断该page是否在本地。这一操作涉及内核修改，似乎无法通过eBPF实现，因此“在内核恢复进程”这一方案无法避免修改内核。</p>\n<p>此外，XDP本身不具有完整的协议栈，无法保证数据传输的可靠。基于AF_XDP的成熟数据传输工具XQUIC，实现的是一个纯用户态的协议栈，因此似乎不适合对内核的Page进行传输。</p>\n<h3 id=\"2）在用户态WASM虚拟机中恢复进程（无COW）\"><a href=\"#2）在用户态WASM虚拟机中恢复进程（无COW）\" class=\"headerlink\" title=\"2）在用户态WASM虚拟机中恢复进程（无COW）\"></a>2）在用户态WASM虚拟机中恢复进程（无COW）</h3><p>以Faasm为例，Faasm会将容器快照保存在AWS S3中，收到相应请求时进行下载，并根据快照进行运行状态恢复。为了解决S3读取速度较慢的问题，可以在Faasm中添加一个类似MITOSIS的特性：即任意两个Faasm实例之间，可以进行容器状态拷贝。具体细节如下：</p>\n<ol>\n<li>当一个Faasm容器收到了“拷贝请求”后，对自身的容器状态进行快照。之后使用基于xdp (XQUIC)的数据传输方式将快照发送至发起“拷贝请求”的实例</li>\n<li>Faasm被拷贝后，将快照缓存在内存中，下次被拷贝就不需要再次生成快照。同时之后其他Faasm实例都通过该fassm进行快照获取(可能需要在kv数据库中加入记录)。</li>\n</ol>\n<p>在加速冷启动方面，Faasm本身有使用kv数据库寻找已存在目标负载的实例的机制。这一机制存在一个问题，若某一请求大量存在，则将会有大量wasm实例在同一server上启动。此时，“远程状态恢复”就可以帮助实现快速跨机器启动实例，或可以提升faasm的性能。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-01%2020.41.43.png\" alt=\"截屏2023-03-01 20.41.43\"></p>\n<p>这一方案仅仅针对Faasm或其他serverless平台进行拓展，无法形成通用解决方案，属于一个工程性问题。</p>\n<h3 id=\"3）在用户态WASM虚拟机中恢复进程（有COW）\"><a href=\"#3）在用户态WASM虚拟机中恢复进程（有COW）\" class=\"headerlink\" title=\"3）在用户态WASM虚拟机中恢复进程（有COW）\"></a>3）在用户态WASM虚拟机中恢复进程（有COW）</h3><p><strong>进一步研究</strong>：<a href=\"https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/\">https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/</a></p>\n<p>针对Faasm这一Serverless平台，Faasm中的Function实际运行在WASM虚拟机中。因此按照以下步骤进行远程Fork：</p>\n<ol>\n<li>子进程的WASM虚拟机初始化</li>\n<li>利用XQUIC，从“被Fork进程”获取“元数据”，在WASM虚拟机中进行状态恢复</li>\n<li>若子进程的WASM虚拟机遇到“缺页”，则利用XQUIC从进行远程页获取</li>\n</ol>\n<p>这一方案的优势：</p>\n<ol>\n<li>Faasm使用了Photo Faaslet快照+COW进行冷启动加速，因此“在WASM虚拟机中运用COW恢复进程状态”的可行性已知</li>\n<li>和MITOSIS思路完全一致，但全部在用户态完成，避免修改内核</li>\n</ol>\n<p>这一方案的缺点：</p>\n<ol>\n<li><p>这一方案需要改WASM runtime的源代码，不是通用解决方案。</p>\n</li>\n<li><p>由于用户态COW过程跨越了较多层，若Function涉及较多的远程页获取，可能会导致程序运行较慢，甚至有可能慢于原生Faasm的冷启动。</p>\n</li>\n</ol>\n<h2 id=\"3-在WASM虚拟机中COW恢复进程的可行性论证\"><a href=\"#3-在WASM虚拟机中COW恢复进程的可行性论证\" class=\"headerlink\" title=\"3. 在WASM虚拟机中COW恢复进程的可行性论证\"></a>3. 在WASM虚拟机中COW恢复进程的可行性论证</h2><h3 id=\"1-Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\"><a href=\"#1-Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\" class=\"headerlink\" title=\"1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\"></a>1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态</h3><p>Faasm用了WARM里的AOT接口进行快照生成：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">aot_comp_context_t</span> <span class=\"title function_\">aot_create_comp_context</span><span class=\"params\">(<span class=\"type\">aot_comp_data_t</span> comp_data, <span class=\"type\">aot_comp_option_t</span> option)</span>;</span><br></pre></td></tr></table></figure>\n\n<p>WAMR源代码分析：</p>\n<p><em><strong>WAMR runtime(WAMR)的内存结构是分页的，且页是在内存上连续的片段，有明确的起始地址和Page size（数组），因此也许可以比较方便的进行远程页拷贝，需要改AOT的代码。</strong></em></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Compiler context</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">AOTCompContext</span> &#123;</span></span><br><span class=\"line\">    AOTCompData *comp_data;      <span class=\"comment\">// 内存数据，是分页的</span></span><br><span class=\"line\"></span><br><span class=\"line\">   \t<span class=\"comment\">// Many llvm config data</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">/* Function contexts */</span></span><br><span class=\"line\">    AOTFuncContext **func_ctxes; <span class=\"comment\">// 函数context</span></span><br><span class=\"line\">    uint32 func_ctx_count;       <span class=\"comment\">// 程序计数器</span></span><br><span class=\"line\">    <span class=\"type\">char</span> **custom_sections_wp;</span><br><span class=\"line\">    uint32 custom_sections_count;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* 3rd-party toolchains */</span></span><br><span class=\"line\">    <span class=\"comment\">/* External llc compiler, if specified, wamrc will emit the llvm-ir file and</span></span><br><span class=\"line\"><span class=\"comment\">     * invoke the llc compiler to generate object file.</span></span><br><span class=\"line\"><span class=\"comment\">     * This can be used when we want to benefit from the optimization of other</span></span><br><span class=\"line\"><span class=\"comment\">     * LLVM based toolchains */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *external_llc_compiler;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *llc_compiler_flags;</span><br><span class=\"line\">    <span class=\"comment\">/* External asm compiler, if specified, wamrc will emit the text-based</span></span><br><span class=\"line\"><span class=\"comment\">     * assembly file (.s) and invoke the llc compiler to generate object file.</span></span><br><span class=\"line\"><span class=\"comment\">     * This will be useful when the upstream LLVM doesn&#x27;t support to emit object</span></span><br><span class=\"line\"><span class=\"comment\">     * file for some architecture (such as arc) */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *external_asm_compiler;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *asm_compiler_flags;</span><br><span class=\"line\">&#125; AOTCompContext;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">AOTCompData</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/* Import memories */</span></span><br><span class=\"line\">    uint32 import_memory_count;</span><br><span class=\"line\">    AOTImportMemory *import_memories;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Memories */</span></span><br><span class=\"line\">    uint32 memory_count;</span><br><span class=\"line\">    AOTMemory *memories;</span><br><span class=\"line\">  </span><br><span class=\"line\">  \t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">  \ttypedef struct AOTMemory &#123;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 memory_flags;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 num_bytes_per_page;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 mem_init_page_count;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 mem_max_page_count;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#125; AOTMemory;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t</span></span><br><span class=\"line\"><span class=\"comment\">  \t*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Memory init data info */</span></span><br><span class=\"line\">    uint32 mem_init_data_count;</span><br><span class=\"line\">    AOTMemInitData **mem_init_data_list;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import tables */</span></span><br><span class=\"line\">    uint32 import_table_count;</span><br><span class=\"line\">    AOTImportTable *import_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Tables */</span></span><br><span class=\"line\">    uint32 table_count;</span><br><span class=\"line\">    AOTTable *tables;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Table init data info */</span></span><br><span class=\"line\">    uint32 table_init_data_count;</span><br><span class=\"line\">    AOTTableInitData **table_init_data_list;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import globals */</span></span><br><span class=\"line\">    uint32 import_global_count;</span><br><span class=\"line\">    AOTImportGlobal *import_globals;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Globals */</span></span><br><span class=\"line\">    uint32 global_count;</span><br><span class=\"line\">    AOTGlobal *globals;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Function types */</span></span><br><span class=\"line\">    uint32 func_type_count;</span><br><span class=\"line\">    AOTFuncType **func_types;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import functions */</span></span><br><span class=\"line\">    uint32 import_func_count;</span><br><span class=\"line\">    AOTImportFunc *import_funcs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Functions */</span></span><br><span class=\"line\">    uint32 func_count;</span><br><span class=\"line\">    AOTFunc **funcs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Custom name sections */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> uint8 *name_section_buf;</span><br><span class=\"line\">    <span class=\"type\">const</span> uint8 *name_section_buf_end;</span><br><span class=\"line\">    uint8 *aot_name_section_buf;</span><br><span class=\"line\">    uint32 aot_name_section_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 global_data_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 start_func_index;</span><br><span class=\"line\">    uint32 malloc_func_index;</span><br><span class=\"line\">    uint32 free_func_index;</span><br><span class=\"line\">    uint32 retain_func_index;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 aux_data_end_global_index;</span><br><span class=\"line\">    uint32 aux_data_end;</span><br><span class=\"line\">    uint32 aux_heap_base_global_index;</span><br><span class=\"line\">    uint32 aux_heap_base;</span><br><span class=\"line\">    uint32 aux_stack_top_global_index;</span><br><span class=\"line\">    uint32 aux_stack_bottom;</span><br><span class=\"line\">    uint32 aux_stack_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    WASMModule *wasm_module;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> WASM_ENABLE_DEBUG_AOT != 0</span></span><br><span class=\"line\">    <span class=\"type\">dwar_extractor_handle_t</span> extractor;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125; AOTCompData;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"2-ebpf高速网络通信方案\"><a href=\"#2-ebpf高速网络通信方案\" class=\"headerlink\" title=\"2.ebpf高速网络通信方案\"></a>2.ebpf高速网络通信方案</h3><p>XQUIC</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Version：2023-3-5</p>\n<h2 id=\"1-问题综述\"><a href=\"#1-问题综述\" class=\"headerlink\" title=\"1. 问题综述\"></a>1. 问题综述</h2><p>现尝试使用WASM、eBPF等技术优化Serverless服务。这一优化可以针对：实例启动速度、实例与外界交互能力、实例调度等方面。</p>\n<p>逻辑上来说，一个Serverless实例的运行，必然经过以下几个步骤：<br>    1.获取待运行负载（负载可以是:WebAssembly、java字节码、go字节码等，是待运行的核心逻辑）<br>    2.实例加载负载，进行启动<br>    3.实例接受待处理数据，进行运算，并返回结果<br>    4.运行结束，实例销毁</p>\n<p><strong>针对步骤1</strong>，获取负载的常规方式是从对象存储服务下载负载，这一方法显然较慢。<strong>AWS Lambda</strong>对此提出了”预置并发”，这一服务可以在用户的虚拟子网中维持一个活跃的Lambda实例，从而避免冷启动。 <strong>MITOSIS</strong>某种意义上可以说是对”预置并发”进行了极致的优化，即使用RDMA从一个活跃的实例——Seed进行远程克隆，并使用COW渐进式的获取内存数据。<strong>Faasm</strong>针对此问题，则引入了一个KV数据库，存储各个server上实例的运行情况，从而实现了在已存在目标实例的server上处理任务，尽可能避免冷启动。这一优化是一种调度策略上的优化。</p>\n<p>概括来说，步骤一的优化有三个方面：<br>    1.将实例负载存放比较“近”的地方，如保留一个活跃实例<br>    2.使用尽可能快速的方式获取负载，如RDMA<br>    3.避免冷启动，进行调度优化</p>\n<p><strong>针对步骤2</strong>，可以尝试优化启动速度本身，常见方式有优化编译产物、减小内存配置等，目前我们尝试采用的优化策略是使用WASM。（Faasm针对此步骤，使用了直接通过WASM runtime镜像启动的方法，优化了WASM容器启动的速度）</p>\n<p><strong>针对步骤3</strong>，原生WASM需使用WASI与系统交互，这一方法可能性能较差/适用范围较小。因此尝试采用WASM-eBPF工具，将部分运算下沉到eBPF虚拟机进行，从而获得serverless服务与外界更好的交互能力。</p>\n<p>注：粗略估计，实际使用中Serverless服务绝大多数的对外交互都是网络交互，主要是读写数据。</p>\n<p><strong>针对步骤4</strong>，暂无优化措施</p>\n<h2 id=\"2-加速Serverless启动的方案（运行状态恢复的三种路线）\"><a href=\"#2-加速Serverless启动的方案（运行状态恢复的三种路线）\" class=\"headerlink\" title=\"2. 加速Serverless启动的方案（运行状态恢复的三种路线）\"></a>2. 加速Serverless启动的方案（运行状态恢复的三种路线）</h2><p>由于原生MITOSIS对RDMA硬件有硬性要求，且需要修改内核，通用性相对较低。因此尝试利用WASM+eBPF+XDP等，实现一种更友好的Serverless快速启动策略，以下将这一策略称为MITOSIS-eBPF。（此处的mitosis取英文本身意思：有丝分裂，这是由于下列方案思路依然与原生mitosis类似，是从一个活跃实例快速分裂出大量子实例）</p>\n<p>目前实现MITOSIS-eBPF有三种思路： </p>\n<h3 id=\"1）在内核恢复进程\"><a href=\"#1）在内核恢复进程\" class=\"headerlink\" title=\"1）在内核恢复进程\"></a>1）在内核恢复进程</h3><p>在内核恢复进程状态，这一思路与原生MITOSIS一致，需实现以下几点：</p>\n<ol>\n<li>对“被Fork进程”进行Metadata快照，并将此快照传递给“子进程”</li>\n<li>子进程需根据pte探知该Page是否在本地，若不在本地，则需要进行远程页获取</li>\n<li>MITOSIS-eBPF需要能够读取指定进程的数据，从而通过rpc/XQUIC等方式传递给子进程</li>\n</ol>\n<p>其中步骤二，原生MITOSIS的实现方式是利用pte中未被使用的高位作为标记，从而判断该page是否在本地。这一操作涉及内核修改，似乎无法通过eBPF实现，因此“在内核恢复进程”这一方案无法避免修改内核。</p>\n<p>此外，XDP本身不具有完整的协议栈，无法保证数据传输的可靠。基于AF_XDP的成熟数据传输工具XQUIC，实现的是一个纯用户态的协议栈，因此似乎不适合对内核的Page进行传输。</p>\n<h3 id=\"2）在用户态WASM虚拟机中恢复进程（无COW）\"><a href=\"#2）在用户态WASM虚拟机中恢复进程（无COW）\" class=\"headerlink\" title=\"2）在用户态WASM虚拟机中恢复进程（无COW）\"></a>2）在用户态WASM虚拟机中恢复进程（无COW）</h3><p>以Faasm为例，Faasm会将容器快照保存在AWS S3中，收到相应请求时进行下载，并根据快照进行运行状态恢复。为了解决S3读取速度较慢的问题，可以在Faasm中添加一个类似MITOSIS的特性：即任意两个Faasm实例之间，可以进行容器状态拷贝。具体细节如下：</p>\n<ol>\n<li>当一个Faasm容器收到了“拷贝请求”后，对自身的容器状态进行快照。之后使用基于xdp (XQUIC)的数据传输方式将快照发送至发起“拷贝请求”的实例</li>\n<li>Faasm被拷贝后，将快照缓存在内存中，下次被拷贝就不需要再次生成快照。同时之后其他Faasm实例都通过该fassm进行快照获取(可能需要在kv数据库中加入记录)。</li>\n</ol>\n<p>在加速冷启动方面，Faasm本身有使用kv数据库寻找已存在目标负载的实例的机制。这一机制存在一个问题，若某一请求大量存在，则将会有大量wasm实例在同一server上启动。此时，“远程状态恢复”就可以帮助实现快速跨机器启动实例，或可以提升faasm的性能。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-01%2020.41.43.png\" alt=\"截屏2023-03-01 20.41.43\"></p>\n<p>这一方案仅仅针对Faasm或其他serverless平台进行拓展，无法形成通用解决方案，属于一个工程性问题。</p>\n<h3 id=\"3）在用户态WASM虚拟机中恢复进程（有COW）\"><a href=\"#3）在用户态WASM虚拟机中恢复进程（有COW）\" class=\"headerlink\" title=\"3）在用户态WASM虚拟机中恢复进程（有COW）\"></a>3）在用户态WASM虚拟机中恢复进程（有COW）</h3><p><strong>进一步研究</strong>：<a href=\"https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/\">https://muchengl.github.io/2023/03/09/User-space-page-fault-handling/</a></p>\n<p>针对Faasm这一Serverless平台，Faasm中的Function实际运行在WASM虚拟机中。因此按照以下步骤进行远程Fork：</p>\n<ol>\n<li>子进程的WASM虚拟机初始化</li>\n<li>利用XQUIC，从“被Fork进程”获取“元数据”，在WASM虚拟机中进行状态恢复</li>\n<li>若子进程的WASM虚拟机遇到“缺页”，则利用XQUIC从进行远程页获取</li>\n</ol>\n<p>这一方案的优势：</p>\n<ol>\n<li>Faasm使用了Photo Faaslet快照+COW进行冷启动加速，因此“在WASM虚拟机中运用COW恢复进程状态”的可行性已知</li>\n<li>和MITOSIS思路完全一致，但全部在用户态完成，避免修改内核</li>\n</ol>\n<p>这一方案的缺点：</p>\n<ol>\n<li><p>这一方案需要改WASM runtime的源代码，不是通用解决方案。</p>\n</li>\n<li><p>由于用户态COW过程跨越了较多层，若Function涉及较多的远程页获取，可能会导致程序运行较慢，甚至有可能慢于原生Faasm的冷启动。</p>\n</li>\n</ol>\n<h2 id=\"3-在WASM虚拟机中COW恢复进程的可行性论证\"><a href=\"#3-在WASM虚拟机中COW恢复进程的可行性论证\" class=\"headerlink\" title=\"3. 在WASM虚拟机中COW恢复进程的可行性论证\"></a>3. 在WASM虚拟机中COW恢复进程的可行性论证</h2><h3 id=\"1-Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\"><a href=\"#1-Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\" class=\"headerlink\" title=\"1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态\"></a>1.Faasm怎么实现cow的，以及如何进行快照，并在WAVM里恢复运行状态</h3><p>Faasm用了WARM里的AOT接口进行快照生成：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">aot_comp_context_t</span> <span class=\"title function_\">aot_create_comp_context</span><span class=\"params\">(<span class=\"type\">aot_comp_data_t</span> comp_data, <span class=\"type\">aot_comp_option_t</span> option)</span>;</span><br></pre></td></tr></table></figure>\n\n<p>WAMR源代码分析：</p>\n<p><em><strong>WAMR runtime(WAMR)的内存结构是分页的，且页是在内存上连续的片段，有明确的起始地址和Page size（数组），因此也许可以比较方便的进行远程页拷贝，需要改AOT的代码。</strong></em></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Compiler context</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">AOTCompContext</span> &#123;</span></span><br><span class=\"line\">    AOTCompData *comp_data;      <span class=\"comment\">// 内存数据，是分页的</span></span><br><span class=\"line\"></span><br><span class=\"line\">   \t<span class=\"comment\">// Many llvm config data</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">/* Function contexts */</span></span><br><span class=\"line\">    AOTFuncContext **func_ctxes; <span class=\"comment\">// 函数context</span></span><br><span class=\"line\">    uint32 func_ctx_count;       <span class=\"comment\">// 程序计数器</span></span><br><span class=\"line\">    <span class=\"type\">char</span> **custom_sections_wp;</span><br><span class=\"line\">    uint32 custom_sections_count;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* 3rd-party toolchains */</span></span><br><span class=\"line\">    <span class=\"comment\">/* External llc compiler, if specified, wamrc will emit the llvm-ir file and</span></span><br><span class=\"line\"><span class=\"comment\">     * invoke the llc compiler to generate object file.</span></span><br><span class=\"line\"><span class=\"comment\">     * This can be used when we want to benefit from the optimization of other</span></span><br><span class=\"line\"><span class=\"comment\">     * LLVM based toolchains */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *external_llc_compiler;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *llc_compiler_flags;</span><br><span class=\"line\">    <span class=\"comment\">/* External asm compiler, if specified, wamrc will emit the text-based</span></span><br><span class=\"line\"><span class=\"comment\">     * assembly file (.s) and invoke the llc compiler to generate object file.</span></span><br><span class=\"line\"><span class=\"comment\">     * This will be useful when the upstream LLVM doesn&#x27;t support to emit object</span></span><br><span class=\"line\"><span class=\"comment\">     * file for some architecture (such as arc) */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *external_asm_compiler;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *asm_compiler_flags;</span><br><span class=\"line\">&#125; AOTCompContext;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">AOTCompData</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/* Import memories */</span></span><br><span class=\"line\">    uint32 import_memory_count;</span><br><span class=\"line\">    AOTImportMemory *import_memories;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Memories */</span></span><br><span class=\"line\">    uint32 memory_count;</span><br><span class=\"line\">    AOTMemory *memories;</span><br><span class=\"line\">  </span><br><span class=\"line\">  \t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">  \ttypedef struct AOTMemory &#123;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 memory_flags;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 num_bytes_per_page;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 mem_init_page_count;</span></span><br><span class=\"line\"><span class=\"comment\">    \tuint32 mem_max_page_count;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#125; AOTMemory;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t</span></span><br><span class=\"line\"><span class=\"comment\">  \t*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Memory init data info */</span></span><br><span class=\"line\">    uint32 mem_init_data_count;</span><br><span class=\"line\">    AOTMemInitData **mem_init_data_list;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import tables */</span></span><br><span class=\"line\">    uint32 import_table_count;</span><br><span class=\"line\">    AOTImportTable *import_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Tables */</span></span><br><span class=\"line\">    uint32 table_count;</span><br><span class=\"line\">    AOTTable *tables;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Table init data info */</span></span><br><span class=\"line\">    uint32 table_init_data_count;</span><br><span class=\"line\">    AOTTableInitData **table_init_data_list;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import globals */</span></span><br><span class=\"line\">    uint32 import_global_count;</span><br><span class=\"line\">    AOTImportGlobal *import_globals;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Globals */</span></span><br><span class=\"line\">    uint32 global_count;</span><br><span class=\"line\">    AOTGlobal *globals;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Function types */</span></span><br><span class=\"line\">    uint32 func_type_count;</span><br><span class=\"line\">    AOTFuncType **func_types;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Import functions */</span></span><br><span class=\"line\">    uint32 import_func_count;</span><br><span class=\"line\">    AOTImportFunc *import_funcs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Functions */</span></span><br><span class=\"line\">    uint32 func_count;</span><br><span class=\"line\">    AOTFunc **funcs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Custom name sections */</span></span><br><span class=\"line\">    <span class=\"type\">const</span> uint8 *name_section_buf;</span><br><span class=\"line\">    <span class=\"type\">const</span> uint8 *name_section_buf_end;</span><br><span class=\"line\">    uint8 *aot_name_section_buf;</span><br><span class=\"line\">    uint32 aot_name_section_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 global_data_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 start_func_index;</span><br><span class=\"line\">    uint32 malloc_func_index;</span><br><span class=\"line\">    uint32 free_func_index;</span><br><span class=\"line\">    uint32 retain_func_index;</span><br><span class=\"line\"></span><br><span class=\"line\">    uint32 aux_data_end_global_index;</span><br><span class=\"line\">    uint32 aux_data_end;</span><br><span class=\"line\">    uint32 aux_heap_base_global_index;</span><br><span class=\"line\">    uint32 aux_heap_base;</span><br><span class=\"line\">    uint32 aux_stack_top_global_index;</span><br><span class=\"line\">    uint32 aux_stack_bottom;</span><br><span class=\"line\">    uint32 aux_stack_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    WASMModule *wasm_module;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> WASM_ENABLE_DEBUG_AOT != 0</span></span><br><span class=\"line\">    <span class=\"type\">dwar_extractor_handle_t</span> extractor;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125; AOTCompData;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"2-ebpf高速网络通信方案\"><a href=\"#2-ebpf高速网络通信方案\" class=\"headerlink\" title=\"2.ebpf高速网络通信方案\"></a>2.ebpf高速网络通信方案</h3><p>XQUIC</p>\n"},{"title":"MITOSIS test","date":"2023-02-02T12:41:24.000Z","_content":"\n服务器无root权限，需修改Kernel，因此用KVM，把device映射到KVM里。\n\n## 服务器物理配置\n\n![截屏2023-02-02 20.44.46](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png)\n\n```\n$ ifconfig\nenp65s0f0np0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20<link>\n        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)\n        RX packets 429758  bytes 103736820 (103.7 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 804262  bytes 138138879 (138.1 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nenp66s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20<link>\n        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)\n        RX packets 431116  bytes 104497752 (104.4 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 811031  bytes 138523138 (138.5 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nenp66s0d1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20<link>\n        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)\n        RX packets 434024  bytes 104743872 (104.7 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 791748  bytes 136537921 (136.5 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n```\n\n\n\n## KVM安装ubuntu18.04\n\n教程：https://www.jianshu.com/p/d0e4ed80b8a1\n\n下载ubuntu镜像：http://mirrors.zju.edu.cn/ubuntu-releases/16.04/\n\n### 安装ubuntu：\n\n```sh\nvirt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args='console=ttyS0'\n```\n\n出现权限不足报错，执行：chmod 755 ~，后重新执行命令安装\n\n### ssh 登录虚拟机：\n\n```sh\n$ virsh list #获取目标虚拟机名\n$ virsh domifaddr [id | name] #获取虚拟机信息\n Name       MAC address          Protocol     Address\n-------------------------------------------------------------------------------\n vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24\n \n$ ssh username@192.168.122.116\n```\n\n\n\n### 无法进入命令行问题修复\n\n安装完毕后直接使用以下指令无法登录：\n\n```sh\n~$ virsh console ubuntu18\nConnected to domain 'ubuntu18'\nEscape character is ^] (Ctrl + ]) #卡在这里\n```\n\n在安装虚拟机时，应选择安装openSSH服务，从而可以使用ssh登录虚拟机。\n\nhttps://blog.csdn.net/weixin_28730403/article/details/111975038\nhttps://blog.csdn.net/qq_36885515/article/details/112367143\n\n\n\n## RDMA网卡设备穿透到KVM\n\nhttps://blog.csdn.net/zhongbeida_xue/article/details/103602105\n\n1. lspci | grep Ethernet，获取host主机上的网卡列表\n\n    ```sh\n    $ lspci | grep Ethernet\n    41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]\n    ```\n\n2. vim pci-01.xml ，建立直连设备定义文件\n\n    ```xml\n    <hostdev mode='subsystem' type='pci' managed='yes'>\n            <source>\n                    <address domain='0x0000' bus='0x41' slot='0x00' function='0x0'/>\n            </source>\n    </hostdev>\n    ```\n\n3. virsh attach-device [kvm-name] [config.xml]，进行设备直连\n    在虚拟机内执行lspci，可以发现出现了，因此RDMA直连接已生效\n\n    ```sh\n    07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    ```\n\n    \n\n## 安装MITOSIS core\n\n1.安装rust\n\n```sh\n$ curl https://sh.rustup.rs -sSf | sh\n\n$ rustup install nightly-2022-02-04  # 安装mitosis所需的工具链\n$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu\n\n$ apt-get install clang-9\n```\n\n\n\n\n\n\n\n\n\n","source":"_posts/MITOSIS-test.md","raw":"---\ntitle: MITOSIS test\ndate: 2023-02-02 20:41:24\ntags:\n---\n\n服务器无root权限，需修改Kernel，因此用KVM，把device映射到KVM里。\n\n## 服务器物理配置\n\n![截屏2023-02-02 20.44.46](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png)\n\n```\n$ ifconfig\nenp65s0f0np0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20<link>\n        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)\n        RX packets 429758  bytes 103736820 (103.7 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 804262  bytes 138138879 (138.1 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nenp66s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20<link>\n        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)\n        RX packets 431116  bytes 104497752 (104.4 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 811031  bytes 138523138 (138.5 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nenp66s0d1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255\n        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20<link>\n        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)\n        RX packets 434024  bytes 104743872 (104.7 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 791748  bytes 136537921 (136.5 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n```\n\n\n\n## KVM安装ubuntu18.04\n\n教程：https://www.jianshu.com/p/d0e4ed80b8a1\n\n下载ubuntu镜像：http://mirrors.zju.edu.cn/ubuntu-releases/16.04/\n\n### 安装ubuntu：\n\n```sh\nvirt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args='console=ttyS0'\n```\n\n出现权限不足报错，执行：chmod 755 ~，后重新执行命令安装\n\n### ssh 登录虚拟机：\n\n```sh\n$ virsh list #获取目标虚拟机名\n$ virsh domifaddr [id | name] #获取虚拟机信息\n Name       MAC address          Protocol     Address\n-------------------------------------------------------------------------------\n vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24\n \n$ ssh username@192.168.122.116\n```\n\n\n\n### 无法进入命令行问题修复\n\n安装完毕后直接使用以下指令无法登录：\n\n```sh\n~$ virsh console ubuntu18\nConnected to domain 'ubuntu18'\nEscape character is ^] (Ctrl + ]) #卡在这里\n```\n\n在安装虚拟机时，应选择安装openSSH服务，从而可以使用ssh登录虚拟机。\n\nhttps://blog.csdn.net/weixin_28730403/article/details/111975038\nhttps://blog.csdn.net/qq_36885515/article/details/112367143\n\n\n\n## RDMA网卡设备穿透到KVM\n\nhttps://blog.csdn.net/zhongbeida_xue/article/details/103602105\n\n1. lspci | grep Ethernet，获取host主机上的网卡列表\n\n    ```sh\n    $ lspci | grep Ethernet\n    41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]\n    ```\n\n2. vim pci-01.xml ，建立直连设备定义文件\n\n    ```xml\n    <hostdev mode='subsystem' type='pci' managed='yes'>\n            <source>\n                    <address domain='0x0000' bus='0x41' slot='0x00' function='0x0'/>\n            </source>\n    </hostdev>\n    ```\n\n3. virsh attach-device [kvm-name] [config.xml]，进行设备直连\n    在虚拟机内执行lspci，可以发现出现了，因此RDMA直连接已生效\n\n    ```sh\n    07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)\n    ```\n\n    \n\n## 安装MITOSIS core\n\n1.安装rust\n\n```sh\n$ curl https://sh.rustup.rs -sSf | sh\n\n$ rustup install nightly-2022-02-04  # 安装mitosis所需的工具链\n$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu\n\n$ apt-get install clang-9\n```\n\n\n\n\n\n\n\n\n\n","slug":"MITOSIS-test","published":1,"updated":"2023-02-05T03:35:21.677Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa1000ob9c9dc8x2gmg","content":"<p>服务器无root权限，需修改Kernel，因此用KVM，把device映射到KVM里。</p>\n<h2 id=\"服务器物理配置\"><a href=\"#服务器物理配置\" class=\"headerlink\" title=\"服务器物理配置\"></a>服务器物理配置</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png\" alt=\"截屏2023-02-02 20.44.46\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ifconfig</span><br><span class=\"line\">enp65s0f0np0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 429758  bytes 103736820 (103.7 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 804262  bytes 138138879 (138.1 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class=\"line\"></span><br><span class=\"line\">enp66s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 431116  bytes 104497752 (104.4 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 811031  bytes 138523138 (138.5 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class=\"line\"></span><br><span class=\"line\">enp66s0d1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 434024  bytes 104743872 (104.7 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 791748  bytes 136537921 (136.5 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"KVM安装ubuntu18-04\"><a href=\"#KVM安装ubuntu18-04\" class=\"headerlink\" title=\"KVM安装ubuntu18.04\"></a>KVM安装ubuntu18.04</h2><p>教程：<a href=\"https://www.jianshu.com/p/d0e4ed80b8a1\">https://www.jianshu.com/p/d0e4ed80b8a1</a></p>\n<p>下载ubuntu镜像：<a href=\"http://mirrors.zju.edu.cn/ubuntu-releases/16.04/\">http://mirrors.zju.edu.cn/ubuntu-releases/16.04/</a></p>\n<h3 id=\"安装ubuntu：\"><a href=\"#安装ubuntu：\" class=\"headerlink\" title=\"安装ubuntu：\"></a>安装ubuntu：</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args=<span class=\"string\">&#x27;console=ttyS0&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>出现权限不足报错，执行：chmod 755 ~，后重新执行命令安装</p>\n<h3 id=\"ssh-登录虚拟机：\"><a href=\"#ssh-登录虚拟机：\" class=\"headerlink\" title=\"ssh 登录虚拟机：\"></a>ssh 登录虚拟机：</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ virsh list <span class=\"comment\">#获取目标虚拟机名</span></span><br><span class=\"line\">$ virsh domifaddr [<span class=\"built_in\">id</span> | name] <span class=\"comment\">#获取虚拟机信息</span></span><br><span class=\"line\"> Name       MAC address          Protocol     Address</span><br><span class=\"line\">-------------------------------------------------------------------------------</span><br><span class=\"line\"> vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24</span><br><span class=\"line\"> </span><br><span class=\"line\">$ ssh username@192.168.122.116</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"无法进入命令行问题修复\"><a href=\"#无法进入命令行问题修复\" class=\"headerlink\" title=\"无法进入命令行问题修复\"></a>无法进入命令行问题修复</h3><p>安装完毕后直接使用以下指令无法登录：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ virsh console ubuntu18</span><br><span class=\"line\">Connected to domain <span class=\"string\">&#x27;ubuntu18&#x27;</span></span><br><span class=\"line\">Escape character is ^] (Ctrl + ]) <span class=\"comment\">#卡在这里</span></span><br></pre></td></tr></table></figure>\n\n<p>在安装虚拟机时，应选择安装openSSH服务，从而可以使用ssh登录虚拟机。</p>\n<p><a href=\"https://blog.csdn.net/weixin_28730403/article/details/111975038\">https://blog.csdn.net/weixin_28730403/article/details/111975038</a><br><a href=\"https://blog.csdn.net/qq_36885515/article/details/112367143\">https://blog.csdn.net/qq_36885515/article/details/112367143</a></p>\n<h2 id=\"RDMA网卡设备穿透到KVM\"><a href=\"#RDMA网卡设备穿透到KVM\" class=\"headerlink\" title=\"RDMA网卡设备穿透到KVM\"></a>RDMA网卡设备穿透到KVM</h2><p><a href=\"https://blog.csdn.net/zhongbeida_xue/article/details/103602105\">https://blog.csdn.net/zhongbeida_xue/article/details/103602105</a></p>\n<ol>\n<li><p>lspci | grep Ethernet，获取host主机上的网卡列表</p>\n <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ lspci | grep Ethernet</span><br><span class=\"line\">41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class=\"line\">41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class=\"line\">42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]</span><br></pre></td></tr></table></figure></li>\n<li><p>vim pci-01.xml ，建立直连设备定义文件</p>\n <figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">hostdev</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;subsystem&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x41&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hostdev</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>virsh attach-device [kvm-name] [config.xml]，进行设备直连<br> 在虚拟机内执行lspci，可以发现出现了，因此RDMA直连接已生效</p>\n <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<h2 id=\"安装MITOSIS-core\"><a href=\"#安装MITOSIS-core\" class=\"headerlink\" title=\"安装MITOSIS core\"></a>安装MITOSIS core</h2><p>1.安装rust</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl https://sh.rustup.rs -sSf | sh</span><br><span class=\"line\"></span><br><span class=\"line\">$ rustup install nightly-2022-02-04  <span class=\"comment\"># 安装mitosis所需的工具链</span></span><br><span class=\"line\">$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu</span><br><span class=\"line\"></span><br><span class=\"line\">$ apt-get install clang-9</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<p>服务器无root权限，需修改Kernel，因此用KVM，把device映射到KVM里。</p>\n<h2 id=\"服务器物理配置\"><a href=\"#服务器物理配置\" class=\"headerlink\" title=\"服务器物理配置\"></a>服务器物理配置</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-02%2020.44.46.png\" alt=\"截屏2023-02-02 20.44.46\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ifconfig</span><br><span class=\"line\">enp65s0f0np0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.2  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::e8a7:6d0b:c437:47a2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether 64:b3:79:00:01:5a  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 429758  bytes 103736820 (103.7 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 804262  bytes 138138879 (138.1 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class=\"line\"></span><br><span class=\"line\">enp66s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.4  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::2dde:7d4f:df48:59ca  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether e4:1d:2d:97:92:34  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 431116  bytes 104497752 (104.4 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 811031  bytes 138523138 (138.5 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class=\"line\"></span><br><span class=\"line\">enp66s0d1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class=\"line\">        inet 192.168.9.14  netmask 255.255.255.0  broadcast 192.168.9.255</span><br><span class=\"line\">        inet6 fe80::c238:ad53:dfc8:2d14  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class=\"line\">        ether e4:1d:2d:97:92:35  txqueuelen 1000  (Ethernet)</span><br><span class=\"line\">        RX packets 434024  bytes 104743872 (104.7 MB)</span><br><span class=\"line\">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class=\"line\">        TX packets 791748  bytes 136537921 (136.5 MB)</span><br><span class=\"line\">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"KVM安装ubuntu18-04\"><a href=\"#KVM安装ubuntu18-04\" class=\"headerlink\" title=\"KVM安装ubuntu18.04\"></a>KVM安装ubuntu18.04</h2><p>教程：<a href=\"https://www.jianshu.com/p/d0e4ed80b8a1\">https://www.jianshu.com/p/d0e4ed80b8a1</a></p>\n<p>下载ubuntu镜像：<a href=\"http://mirrors.zju.edu.cn/ubuntu-releases/16.04/\">http://mirrors.zju.edu.cn/ubuntu-releases/16.04/</a></p>\n<h3 id=\"安装ubuntu：\"><a href=\"#安装ubuntu：\" class=\"headerlink\" title=\"安装ubuntu：\"></a>安装ubuntu：</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virt-install --virt-type kvm  --name=ubuntu16-x86 --memory=2048,maxmemory=2048 --vcpus=2,maxvcpus=2 --os-type=linux --os-variant=ubuntu16.04 --network network=default --location=/home/hanzhong/ubuntu-16.04.7-server-amd64.iso --disk path=~/kvm/ubuntu16-x86.img,size=10 --graphics=none --check path_in_use=off --check all=off --extra-args=<span class=\"string\">&#x27;console=ttyS0&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>出现权限不足报错，执行：chmod 755 ~，后重新执行命令安装</p>\n<h3 id=\"ssh-登录虚拟机：\"><a href=\"#ssh-登录虚拟机：\" class=\"headerlink\" title=\"ssh 登录虚拟机：\"></a>ssh 登录虚拟机：</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ virsh list <span class=\"comment\">#获取目标虚拟机名</span></span><br><span class=\"line\">$ virsh domifaddr [<span class=\"built_in\">id</span> | name] <span class=\"comment\">#获取虚拟机信息</span></span><br><span class=\"line\"> Name       MAC address          Protocol     Address</span><br><span class=\"line\">-------------------------------------------------------------------------------</span><br><span class=\"line\"> vnet20     xx:xx:xx:xx:xx:xx    ipv4         192.168.122.116/24</span><br><span class=\"line\"> </span><br><span class=\"line\">$ ssh username@192.168.122.116</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"无法进入命令行问题修复\"><a href=\"#无法进入命令行问题修复\" class=\"headerlink\" title=\"无法进入命令行问题修复\"></a>无法进入命令行问题修复</h3><p>安装完毕后直接使用以下指令无法登录：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ virsh console ubuntu18</span><br><span class=\"line\">Connected to domain <span class=\"string\">&#x27;ubuntu18&#x27;</span></span><br><span class=\"line\">Escape character is ^] (Ctrl + ]) <span class=\"comment\">#卡在这里</span></span><br></pre></td></tr></table></figure>\n\n<p>在安装虚拟机时，应选择安装openSSH服务，从而可以使用ssh登录虚拟机。</p>\n<p><a href=\"https://blog.csdn.net/weixin_28730403/article/details/111975038\">https://blog.csdn.net/weixin_28730403/article/details/111975038</a><br><a href=\"https://blog.csdn.net/qq_36885515/article/details/112367143\">https://blog.csdn.net/qq_36885515/article/details/112367143</a></p>\n<h2 id=\"RDMA网卡设备穿透到KVM\"><a href=\"#RDMA网卡设备穿透到KVM\" class=\"headerlink\" title=\"RDMA网卡设备穿透到KVM\"></a>RDMA网卡设备穿透到KVM</h2><p><a href=\"https://blog.csdn.net/zhongbeida_xue/article/details/103602105\">https://blog.csdn.net/zhongbeida_xue/article/details/103602105</a></p>\n<ol>\n<li><p>lspci | grep Ethernet，获取host主机上的网卡列表</p>\n <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ lspci | grep Ethernet</span><br><span class=\"line\">41:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class=\"line\">41:00.1 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br><span class=\"line\">42:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]</span><br></pre></td></tr></table></figure></li>\n<li><p>vim pci-01.xml ，建立直连设备定义文件</p>\n <figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">hostdev</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;subsystem&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x41&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hostdev</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li><p>virsh attach-device [kvm-name] [config.xml]，进行设备直连<br> 在虚拟机内执行lspci，可以发现出现了，因此RDMA直连接已生效</p>\n <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">07:00.0 Ethernet controller: Broadcom Inc. and subsidiaries BCM57414 NetXtreme-E 10Gb/25Gb RDMA Ethernet Controller (rev 01)</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<h2 id=\"安装MITOSIS-core\"><a href=\"#安装MITOSIS-core\" class=\"headerlink\" title=\"安装MITOSIS core\"></a>安装MITOSIS core</h2><p>1.安装rust</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl https://sh.rustup.rs -sSf | sh</span><br><span class=\"line\"></span><br><span class=\"line\">$ rustup install nightly-2022-02-04  <span class=\"comment\"># 安装mitosis所需的工具链</span></span><br><span class=\"line\">$ rustup default nightly-2022-02-04-x86_64-unknown-linux-gnu</span><br><span class=\"line\"></span><br><span class=\"line\">$ apt-get install clang-9</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n"},{"title":"OS Learning 01","date":"2022-11-13T13:21:26.000Z","_content":"\n# C basic knowledge\n\n```c\nspin()\n```\n\n等一秒钟返回\n\n```c\nassert( 表达式 );\n```\n\n若表达式值为0，则终止程序\n\n```c\nmalloc(num);\nint *p=malloc(num);\n```\n\n动态分配内存函数，分配长度为num字节的内存块，需要使用free释放。\n\np是一个指针变量，表示内存中的一个地址。*p表示这个地址内存中存的值。\n\n\n\n\n\n","source":"_posts/OS Learning 01.md","raw":"---\ntitle: OS Learning 01\ndate: 2022-11-13 21:21:26\ntags: Operation Systems Three Easy Pieces\n\n---\n\n# C basic knowledge\n\n```c\nspin()\n```\n\n等一秒钟返回\n\n```c\nassert( 表达式 );\n```\n\n若表达式值为0，则终止程序\n\n```c\nmalloc(num);\nint *p=malloc(num);\n```\n\n动态分配内存函数，分配长度为num字节的内存块，需要使用free释放。\n\np是一个指针变量，表示内存中的一个地址。*p表示这个地址内存中存的值。\n\n\n\n\n\n","slug":"OS Learning 01","published":1,"updated":"2022-11-14T08:55:03.436Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa2000pb9c940cc2o9z","content":"<h1 id=\"C-basic-knowledge\"><a href=\"#C-basic-knowledge\" class=\"headerlink\" title=\"C basic knowledge\"></a>C basic knowledge</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spin()</span><br></pre></td></tr></table></figure>\n\n<p>等一秒钟返回</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert( 表达式 );</span><br></pre></td></tr></table></figure>\n\n<p>若表达式值为0，则终止程序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">malloc</span>(num);</span><br><span class=\"line\"><span class=\"type\">int</span> *p=<span class=\"built_in\">malloc</span>(num);</span><br></pre></td></tr></table></figure>\n\n<p>动态分配内存函数，分配长度为num字节的内存块，需要使用free释放。</p>\n<p>p是一个指针变量，表示内存中的一个地址。*p表示这个地址内存中存的值。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"C-basic-knowledge\"><a href=\"#C-basic-knowledge\" class=\"headerlink\" title=\"C basic knowledge\"></a>C basic knowledge</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spin()</span><br></pre></td></tr></table></figure>\n\n<p>等一秒钟返回</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert( 表达式 );</span><br></pre></td></tr></table></figure>\n\n<p>若表达式值为0，则终止程序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">malloc</span>(num);</span><br><span class=\"line\"><span class=\"type\">int</span> *p=<span class=\"built_in\">malloc</span>(num);</span><br></pre></td></tr></table></figure>\n\n<p>动态分配内存函数，分配长度为num字节的内存块，需要使用free释放。</p>\n<p>p是一个指针变量，表示内存中的一个地址。*p表示这个地址内存中存的值。</p>\n"},{"title":"RDMA-soft config","date":"2023-01-17T11:40:10.000Z","_content":"\n[modprobe](https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020) rdma_rxe\n\nrxe_cfg start\n\nifconfig\n\nrxe_cfg add ens33\n\n\n\n我在运行于VMware中的ubuntu环境搭建了Soft-RoCE软件模拟环境，并成功测试了两台虚拟机器间的通信，但是MITOSIS似乎需要“A machine with Mellanox RDMA-capable IB NIC ”，RoCE和IB两种RDMA技术有一定区别，因此可能导致无法成功。\n\n在MITOSIS的readme中有这么一句“In principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. ”，意思应该是不支持RoCE？但是，我目前没有找到软件模拟IB的方式\n\n\n\nIB（InfiniBand）：基于 InfiniBand 架构的 RDMA 技术，由 IBTA（InfiniBand Trade Association）提出。搭建基于 IB 技术的 RDMA 网络需要专用的 IB 网卡和 IB 交换机。\n\niWARP（Internet Wide Area RDMA Protocal）：基于 TCP/IP 协议的 RDMA 技术，由 IETF 标 准定义。iWARP 支持在标准以太网基础设施上使用 RDMA 技术，但服务器需要使用支持iWARP 的网卡。\n\nRoCE（RDMA over Converged Ethernet）：基于以太网的 RDMA 技术，也是由 IBTA 提出。RoCE支持在标准以太网基础设施上使用RDMA技术，但是需要交换机支持无损以太网传输，需要服务器使用 RoCE 网卡。\n","source":"_posts/RDMA-soft-config.md","raw":"---\ntitle: RDMA-soft config\ndate: 2023-01-17 19:40:10\ntags:\n---\n\n[modprobe](https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020) rdma_rxe\n\nrxe_cfg start\n\nifconfig\n\nrxe_cfg add ens33\n\n\n\n我在运行于VMware中的ubuntu环境搭建了Soft-RoCE软件模拟环境，并成功测试了两台虚拟机器间的通信，但是MITOSIS似乎需要“A machine with Mellanox RDMA-capable IB NIC ”，RoCE和IB两种RDMA技术有一定区别，因此可能导致无法成功。\n\n在MITOSIS的readme中有这么一句“In principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. ”，意思应该是不支持RoCE？但是，我目前没有找到软件模拟IB的方式\n\n\n\nIB（InfiniBand）：基于 InfiniBand 架构的 RDMA 技术，由 IBTA（InfiniBand Trade Association）提出。搭建基于 IB 技术的 RDMA 网络需要专用的 IB 网卡和 IB 交换机。\n\niWARP（Internet Wide Area RDMA Protocal）：基于 TCP/IP 协议的 RDMA 技术，由 IETF 标 准定义。iWARP 支持在标准以太网基础设施上使用 RDMA 技术，但服务器需要使用支持iWARP 的网卡。\n\nRoCE（RDMA over Converged Ethernet）：基于以太网的 RDMA 技术，也是由 IBTA 提出。RoCE支持在标准以太网基础设施上使用RDMA技术，但是需要交换机支持无损以太网传输，需要服务器使用 RoCE 网卡。\n","slug":"RDMA-soft-config","published":1,"updated":"2023-01-30T12:59:12.475Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa2000rb9c9btzoei0e","content":"<p><a href=\"https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020\">modprobe</a> rdma_rxe</p>\n<p>rxe_cfg start</p>\n<p>ifconfig</p>\n<p>rxe_cfg add ens33</p>\n<p>我在运行于VMware中的ubuntu环境搭建了Soft-RoCE软件模拟环境，并成功测试了两台虚拟机器间的通信，但是MITOSIS似乎需要“A machine with Mellanox RDMA-capable IB NIC ”，RoCE和IB两种RDMA技术有一定区别，因此可能导致无法成功。</p>\n<p>在MITOSIS的readme中有这么一句“In principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. ”，意思应该是不支持RoCE？但是，我目前没有找到软件模拟IB的方式</p>\n<p>IB（InfiniBand）：基于 InfiniBand 架构的 RDMA 技术，由 IBTA（InfiniBand Trade Association）提出。搭建基于 IB 技术的 RDMA 网络需要专用的 IB 网卡和 IB 交换机。</p>\n<p>iWARP（Internet Wide Area RDMA Protocal）：基于 TCP/IP 协议的 RDMA 技术，由 IETF 标 准定义。iWARP 支持在标准以太网基础设施上使用 RDMA 技术，但服务器需要使用支持iWARP 的网卡。</p>\n<p>RoCE（RDMA over Converged Ethernet）：基于以太网的 RDMA 技术，也是由 IBTA 提出。RoCE支持在标准以太网基础设施上使用RDMA技术，但是需要交换机支持无损以太网传输，需要服务器使用 RoCE 网卡。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://so.csdn.net/so/search?q=modprobe&spm=1001.2101.3001.7020\">modprobe</a> rdma_rxe</p>\n<p>rxe_cfg start</p>\n<p>ifconfig</p>\n<p>rxe_cfg add ens33</p>\n<p>我在运行于VMware中的ubuntu环境搭建了Soft-RoCE软件模拟环境，并成功测试了两台虚拟机器间的通信，但是MITOSIS似乎需要“A machine with Mellanox RDMA-capable IB NIC ”，RoCE和IB两种RDMA技术有一定区别，因此可能导致无法成功。</p>\n<p>在MITOSIS的readme中有这么一句“In principle there is no difficult in supporting RoCE, but we have lack such NIC for testing. ”，意思应该是不支持RoCE？但是，我目前没有找到软件模拟IB的方式</p>\n<p>IB（InfiniBand）：基于 InfiniBand 架构的 RDMA 技术，由 IBTA（InfiniBand Trade Association）提出。搭建基于 IB 技术的 RDMA 网络需要专用的 IB 网卡和 IB 交换机。</p>\n<p>iWARP（Internet Wide Area RDMA Protocal）：基于 TCP/IP 协议的 RDMA 技术，由 IETF 标 准定义。iWARP 支持在标准以太网基础设施上使用 RDMA 技术，但服务器需要使用支持iWARP 的网卡。</p>\n<p>RoCE（RDMA over Converged Ethernet）：基于以太网的 RDMA 技术，也是由 IBTA 提出。RoCE支持在标准以太网基础设施上使用RDMA技术，但是需要交换机支持无损以太网传输，需要服务器使用 RoCE 网卡。</p>\n"},{"title":"Study Notes about Virtualization 01","date":"2022-11-29T11:11:01.000Z","_content":"\n## Docker runtime environment\n\n![img_3faaf387af747fdecd5530e05bfceeb0](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg)\n\nDocker初始发展高度封闭，后期转向开放路线。此时Docker的运行依赖为Runc。Runc是一个实现了OCI（[Open Container Initiative](https://www.opencontainers.org/)）协议的组件。因此可以通过支持OCI协议，实现对Runc的替换，从而实现自己的Docker运行时依赖。\n\nUserful Link：\nBlog：https://xuanwo.io/2019/08/06/oci-intro/\nOCI Repo：https://github.com/opencontainers/runtime-spec\n\n## gVisor\n\n[gVisor](https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html）)是一个谷歌的开源项目。实现了OCI协议，因此可以作为Docker的runtime。Docker存在安全问题，程序有可能逃逸出Container，从而威胁操作系统本身运行。因此需要一款更加安全的Runtime application。gVisor就是这样的一款app。\n\ngVisor是一个sandbox，实现了一个“应用内核”——Sentry。原理是劫持了应用程序的全部sys call，利用Ptrace(or KVM)。Sentry劫持到sys call后，使用go语言模拟出了sys call的功能，从而实现了一个虚拟内核。隔离了程序和Host Kernel。\n\n同时gVisor有一个Gofer模块，用于处理应用程序的IO。\n\n![665372-20210108180022427-177964885](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png)\n\n## Learning Plan\n\n- Step1: 学完go\n- Step2: 看[Runc](https://github.com/opencontainers/runc)的代码，研究OCI怎么实现的\n- Step3: 看[gVisor](https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html)的代码，研究实现细节\n- Step4: 实现一个自己的Docker runtime，这个Runtime应该具有以下特点：\n    - 使用go实现\n    - 简单轻量，但具有完备的功能，可以完美的作为一个OJ系统的Sandbox\n    - 利用Ptrace实现\n    - 支持使用json自定义sys call的调用规则（Allow List），以及进行内存时间限制，~~并实现一套简易的对外交互接口([CRI](https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto))~~\n    - 支持OCI，可以作为Docker的runtime，支持K8S分发部署user code，从而可以作为OJ系统的评测集群Worker，\n    - 严格保证高代码质量，保证高可读性，可维护性\n\n\n\n​\t\n","source":"_posts/Study-Notes-about-Virtualization-01.md","raw":"---\ntitle: Study Notes about Virtualization 01\ndate: 2022-11-29 19:11:01\ntags: Virtualization\n---\n\n## Docker runtime environment\n\n![img_3faaf387af747fdecd5530e05bfceeb0](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg)\n\nDocker初始发展高度封闭，后期转向开放路线。此时Docker的运行依赖为Runc。Runc是一个实现了OCI（[Open Container Initiative](https://www.opencontainers.org/)）协议的组件。因此可以通过支持OCI协议，实现对Runc的替换，从而实现自己的Docker运行时依赖。\n\nUserful Link：\nBlog：https://xuanwo.io/2019/08/06/oci-intro/\nOCI Repo：https://github.com/opencontainers/runtime-spec\n\n## gVisor\n\n[gVisor](https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html）)是一个谷歌的开源项目。实现了OCI协议，因此可以作为Docker的runtime。Docker存在安全问题，程序有可能逃逸出Container，从而威胁操作系统本身运行。因此需要一款更加安全的Runtime application。gVisor就是这样的一款app。\n\ngVisor是一个sandbox，实现了一个“应用内核”——Sentry。原理是劫持了应用程序的全部sys call，利用Ptrace(or KVM)。Sentry劫持到sys call后，使用go语言模拟出了sys call的功能，从而实现了一个虚拟内核。隔离了程序和Host Kernel。\n\n同时gVisor有一个Gofer模块，用于处理应用程序的IO。\n\n![665372-20210108180022427-177964885](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png)\n\n## Learning Plan\n\n- Step1: 学完go\n- Step2: 看[Runc](https://github.com/opencontainers/runc)的代码，研究OCI怎么实现的\n- Step3: 看[gVisor](https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html)的代码，研究实现细节\n- Step4: 实现一个自己的Docker runtime，这个Runtime应该具有以下特点：\n    - 使用go实现\n    - 简单轻量，但具有完备的功能，可以完美的作为一个OJ系统的Sandbox\n    - 利用Ptrace实现\n    - 支持使用json自定义sys call的调用规则（Allow List），以及进行内存时间限制，~~并实现一套简易的对外交互接口([CRI](https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto))~~\n    - 支持OCI，可以作为Docker的runtime，支持K8S分发部署user code，从而可以作为OJ系统的评测集群Worker，\n    - 严格保证高代码质量，保证高可读性，可维护性\n\n\n\n​\t\n","slug":"Study-Notes-about-Virtualization-01","published":1,"updated":"2022-11-30T05:26:08.474Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa3000tb9c92mu315g5","content":"<h2 id=\"Docker-runtime-environment\"><a href=\"#Docker-runtime-environment\" class=\"headerlink\" title=\"Docker runtime environment\"></a>Docker runtime environment</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg\" alt=\"img_3faaf387af747fdecd5530e05bfceeb0\"></p>\n<p>Docker初始发展高度封闭，后期转向开放路线。此时Docker的运行依赖为Runc。Runc是一个实现了OCI（<a href=\"https://www.opencontainers.org/\">Open Container Initiative</a>）协议的组件。因此可以通过支持OCI协议，实现对Runc的替换，从而实现自己的Docker运行时依赖。</p>\n<p>Userful Link：<br>Blog：<a href=\"https://xuanwo.io/2019/08/06/oci-intro/\">https://xuanwo.io/2019/08/06/oci-intro/</a><br>OCI Repo：<a href=\"https://github.com/opencontainers/runtime-spec\">https://github.com/opencontainers/runtime-spec</a></p>\n<h2 id=\"gVisor\"><a href=\"#gVisor\" class=\"headerlink\" title=\"gVisor\"></a>gVisor</h2><p><a href=\"https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html%EF%BC%89\">gVisor</a>是一个谷歌的开源项目。实现了OCI协议，因此可以作为Docker的runtime。Docker存在安全问题，程序有可能逃逸出Container，从而威胁操作系统本身运行。因此需要一款更加安全的Runtime application。gVisor就是这样的一款app。</p>\n<p>gVisor是一个sandbox，实现了一个“应用内核”——Sentry。原理是劫持了应用程序的全部sys call，利用Ptrace(or KVM)。Sentry劫持到sys call后，使用go语言模拟出了sys call的功能，从而实现了一个虚拟内核。隔离了程序和Host Kernel。</p>\n<p>同时gVisor有一个Gofer模块，用于处理应用程序的IO。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png\" alt=\"665372-20210108180022427-177964885\"></p>\n<h2 id=\"Learning-Plan\"><a href=\"#Learning-Plan\" class=\"headerlink\" title=\"Learning Plan\"></a>Learning Plan</h2><ul>\n<li>Step1: 学完go</li>\n<li>Step2: 看<a href=\"https://github.com/opencontainers/runc\">Runc</a>的代码，研究OCI怎么实现的</li>\n<li>Step3: 看<a href=\"https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html\">gVisor</a>的代码，研究实现细节</li>\n<li>Step4: 实现一个自己的Docker runtime，这个Runtime应该具有以下特点：<ul>\n<li>使用go实现</li>\n<li>简单轻量，但具有完备的功能，可以完美的作为一个OJ系统的Sandbox</li>\n<li>利用Ptrace实现</li>\n<li>支持使用json自定义sys call的调用规则（Allow List），以及进行内存时间限制，<del>并实现一套简易的对外交互接口(<a href=\"https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto\">CRI</a>)</del></li>\n<li>支持OCI，可以作为Docker的runtime，支持K8S分发部署user code，从而可以作为OJ系统的评测集群Worker，</li>\n<li>严格保证高代码质量，保证高可读性，可维护性</li>\n</ul>\n</li>\n</ul>\n<p>​    </p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Docker-runtime-environment\"><a href=\"#Docker-runtime-environment\" class=\"headerlink\" title=\"Docker runtime environment\"></a>Docker runtime environment</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/img_3faaf387af747fdecd5530e05bfceeb0.jpg\" alt=\"img_3faaf387af747fdecd5530e05bfceeb0\"></p>\n<p>Docker初始发展高度封闭，后期转向开放路线。此时Docker的运行依赖为Runc。Runc是一个实现了OCI（<a href=\"https://www.opencontainers.org/\">Open Container Initiative</a>）协议的组件。因此可以通过支持OCI协议，实现对Runc的替换，从而实现自己的Docker运行时依赖。</p>\n<p>Userful Link：<br>Blog：<a href=\"https://xuanwo.io/2019/08/06/oci-intro/\">https://xuanwo.io/2019/08/06/oci-intro/</a><br>OCI Repo：<a href=\"https://github.com/opencontainers/runtime-spec\">https://github.com/opencontainers/runtime-spec</a></p>\n<h2 id=\"gVisor\"><a href=\"#gVisor\" class=\"headerlink\" title=\"gVisor\"></a>gVisor</h2><p><a href=\"https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html%EF%BC%89\">gVisor</a>是一个谷歌的开源项目。实现了OCI协议，因此可以作为Docker的runtime。Docker存在安全问题，程序有可能逃逸出Container，从而威胁操作系统本身运行。因此需要一款更加安全的Runtime application。gVisor就是这样的一款app。</p>\n<p>gVisor是一个sandbox，实现了一个“应用内核”——Sentry。原理是劫持了应用程序的全部sys call，利用Ptrace(or KVM)。Sentry劫持到sys call后，使用go语言模拟出了sys call的功能，从而实现了一个虚拟内核。隔离了程序和Host Kernel。</p>\n<p>同时gVisor有一个Gofer模块，用于处理应用程序的IO。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/665372-20210108180022427-177964885.png\" alt=\"665372-20210108180022427-177964885\"></p>\n<h2 id=\"Learning-Plan\"><a href=\"#Learning-Plan\" class=\"headerlink\" title=\"Learning Plan\"></a>Learning Plan</h2><ul>\n<li>Step1: 学完go</li>\n<li>Step2: 看<a href=\"https://github.com/opencontainers/runc\">Runc</a>的代码，研究OCI怎么实现的</li>\n<li>Step3: 看<a href=\"https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/virtual/gvisor/gvisor_quickstart.html\">gVisor</a>的代码，研究实现细节</li>\n<li>Step4: 实现一个自己的Docker runtime，这个Runtime应该具有以下特点：<ul>\n<li>使用go实现</li>\n<li>简单轻量，但具有完备的功能，可以完美的作为一个OJ系统的Sandbox</li>\n<li>利用Ptrace实现</li>\n<li>支持使用json自定义sys call的调用规则（Allow List），以及进行内存时间限制，<del>并实现一套简易的对外交互接口(<a href=\"https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto\">CRI</a>)</del></li>\n<li>支持OCI，可以作为Docker的runtime，支持K8S分发部署user code，从而可以作为OJ系统的评测集群Worker，</li>\n<li>严格保证高代码质量，保证高可读性，可维护性</li>\n</ul>\n</li>\n</ul>\n<p>​    </p>\n"},{"title":"Tree Generator (随机生成一颗树)","date":"2022-11-23T06:04:18.000Z","_content":"\nThis is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.\n\nLink: https://muchengl.github.io/tree/\n\n![截屏2022-11-23 14.06.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png)\n\n","source":"_posts/Tree.md","raw":"---\ntitle: Tree Generator (随机生成一颗树)\ndate: 2022-11-23 14:04:18\ntags:\n---\n\nThis is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.\n\nLink: https://muchengl.github.io/tree/\n\n![截屏2022-11-23 14.06.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png)\n\n","slug":"Tree","published":1,"updated":"2022-11-23T06:07:32.486Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa4000ub9c90itfcdl2","content":"<p>This is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.</p>\n<p>Link: <a href=\"https://muchengl.github.io/tree/\">https://muchengl.github.io/tree/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png\" alt=\"截屏2022-11-23 14.06.22\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>This is a very interesting program which can generate parenthesis expressions of a tree at random and draw it.</p>\n<p>Link: <a href=\"https://muchengl.github.io/tree/\">https://muchengl.github.io/tree/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2022-11-23%2014.06.22.png\" alt=\"截屏2022-11-23 14.06.22\"></p>\n"},{"title":"eBPF(XDP & sockopts)加速数据传输问题","date":"2023-02-27T09:50:33.000Z","_content":"\nBest choice is XQUIC！XQUIC Yes！\n\n## 1）XDP网络加速方案\n\n经研究，基于xdp进行serverless服务启动加速这一问题，可以分为两个子问题：\n\n \t1. 如何在WASM runtime中远程恢复运行状态\n \t2. 如何使用XDP进行高效的数据传输？(是否已经有类似的解决方案？)\n\n我认为两个问题中，问题2优先级更高。因为事实上这一问题可以拓展为：通过 xdp + sockopts 实现通用的网络加速方案。\n\n目前网络上暂没有找到类似的解决方案（具体参考第二节），如果我们可以完成这种方案，则该方案不仅可以用于serverless加速，还可以应用于很多很多场景，将具有很好的前景。\n\n初步构想：由于xdp本身并不具备完整的协议栈，也不能保证数据包的完整性。该设施使用ebpf-xdp技术替换某种网络协议的底层，从而实现一种高速网络通信方案\n\n![截屏2023-02-27 19.33.35](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2019.33.35.png)\n\n## 2）eBPF在网络加速中的实例\n\nAF_XDP技术较新，且AF_XDP的设计主要是针对数据包进行处理，目前可以找到一些AF_XDP在网关等应用的使用实例。这是由于xdp的性质，1）截获网络数据包，2）并重定向包到用户态进行处理，3）最后将数据包传输出去。这一特性非常适合应用于网关应用。\n\n此外XDP在黑名单处理和抵御DDos攻击等方面已有较多实践。\n\n但目前暂时没有找到使用AF_XDP进行数据传输的实践。\n\n以下是一些关于eBPF进行网络加速的应用实例：\n\n### AF_XDP在B站CDN节点QUIC网关的应用和落地\n\n原文地址：https://www.bilibili.com/read/cv20778694\n\n类似的东西：https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html\n\n基于AF_XDP的QUIC网关，XDP程序对数据帧进行过滤，把发给quic-server的HTTP/3请求所对应的数据帧重定向到quic-server维护的xsk中。 \n\n基于AF_XDP的QUIC网关与原生网关对比：\n\n![截屏2023-02-27 17.52.21](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2017.52.21.png)\n\n基于AF_XDP的QUIC网关执行逻辑：\n\n![截屏2023-02-27 20.01.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2020.01.25.png)\n\n\n\n### 2）lstio\n\n介绍：https://istio.io/v1.15/blog/2022/merbridge/\n\nlstio使用了sockopts进行了同机器下的网络通信加速。\n\n原生网络传输路径：\n\n![5](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5.png)\n\n使用sockopts进行跨机器加速：\n\n![6](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/6.png)\n\n使用sockopts进行同机器加速：\n\n![截屏2023-02-27 18.52.48](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2018.52.48.png)\n\n","source":"_posts/XDP数据传输问题综述.md","raw":"---\ntitle: eBPF(XDP & sockopts)加速数据传输问题\ndate: 2023-02-27 17:50:33\ntags:\n---\n\nBest choice is XQUIC！XQUIC Yes！\n\n## 1）XDP网络加速方案\n\n经研究，基于xdp进行serverless服务启动加速这一问题，可以分为两个子问题：\n\n \t1. 如何在WASM runtime中远程恢复运行状态\n \t2. 如何使用XDP进行高效的数据传输？(是否已经有类似的解决方案？)\n\n我认为两个问题中，问题2优先级更高。因为事实上这一问题可以拓展为：通过 xdp + sockopts 实现通用的网络加速方案。\n\n目前网络上暂没有找到类似的解决方案（具体参考第二节），如果我们可以完成这种方案，则该方案不仅可以用于serverless加速，还可以应用于很多很多场景，将具有很好的前景。\n\n初步构想：由于xdp本身并不具备完整的协议栈，也不能保证数据包的完整性。该设施使用ebpf-xdp技术替换某种网络协议的底层，从而实现一种高速网络通信方案\n\n![截屏2023-02-27 19.33.35](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2019.33.35.png)\n\n## 2）eBPF在网络加速中的实例\n\nAF_XDP技术较新，且AF_XDP的设计主要是针对数据包进行处理，目前可以找到一些AF_XDP在网关等应用的使用实例。这是由于xdp的性质，1）截获网络数据包，2）并重定向包到用户态进行处理，3）最后将数据包传输出去。这一特性非常适合应用于网关应用。\n\n此外XDP在黑名单处理和抵御DDos攻击等方面已有较多实践。\n\n但目前暂时没有找到使用AF_XDP进行数据传输的实践。\n\n以下是一些关于eBPF进行网络加速的应用实例：\n\n### AF_XDP在B站CDN节点QUIC网关的应用和落地\n\n原文地址：https://www.bilibili.com/read/cv20778694\n\n类似的东西：https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html\n\n基于AF_XDP的QUIC网关，XDP程序对数据帧进行过滤，把发给quic-server的HTTP/3请求所对应的数据帧重定向到quic-server维护的xsk中。 \n\n基于AF_XDP的QUIC网关与原生网关对比：\n\n![截屏2023-02-27 17.52.21](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2017.52.21.png)\n\n基于AF_XDP的QUIC网关执行逻辑：\n\n![截屏2023-02-27 20.01.25](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2020.01.25.png)\n\n\n\n### 2）lstio\n\n介绍：https://istio.io/v1.15/blog/2022/merbridge/\n\nlstio使用了sockopts进行了同机器下的网络通信加速。\n\n原生网络传输路径：\n\n![5](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5.png)\n\n使用sockopts进行跨机器加速：\n\n![6](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/6.png)\n\n使用sockopts进行同机器加速：\n\n![截屏2023-02-27 18.52.48](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2018.52.48.png)\n\n","slug":"XDP数据传输问题综述","published":1,"updated":"2023-03-01T12:31:06.181Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa4000vb9c976tad1at","content":"<p>Best choice is XQUIC！XQUIC Yes！</p>\n<h2 id=\"1）XDP网络加速方案\"><a href=\"#1）XDP网络加速方案\" class=\"headerlink\" title=\"1）XDP网络加速方案\"></a>1）XDP网络加速方案</h2><p>经研究，基于xdp进行serverless服务启动加速这一问题，可以分为两个子问题：</p>\n<pre><code> 1. 如何在WASM runtime中远程恢复运行状态\n 2. 如何使用XDP进行高效的数据传输？(是否已经有类似的解决方案？)\n</code></pre>\n<p>我认为两个问题中，问题2优先级更高。因为事实上这一问题可以拓展为：通过 xdp + sockopts 实现通用的网络加速方案。</p>\n<p>目前网络上暂没有找到类似的解决方案（具体参考第二节），如果我们可以完成这种方案，则该方案不仅可以用于serverless加速，还可以应用于很多很多场景，将具有很好的前景。</p>\n<p>初步构想：由于xdp本身并不具备完整的协议栈，也不能保证数据包的完整性。该设施使用ebpf-xdp技术替换某种网络协议的底层，从而实现一种高速网络通信方案</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2019.33.35.png\" alt=\"截屏2023-02-27 19.33.35\"></p>\n<h2 id=\"2）eBPF在网络加速中的实例\"><a href=\"#2）eBPF在网络加速中的实例\" class=\"headerlink\" title=\"2）eBPF在网络加速中的实例\"></a>2）eBPF在网络加速中的实例</h2><p>AF_XDP技术较新，且AF_XDP的设计主要是针对数据包进行处理，目前可以找到一些AF_XDP在网关等应用的使用实例。这是由于xdp的性质，1）截获网络数据包，2）并重定向包到用户态进行处理，3）最后将数据包传输出去。这一特性非常适合应用于网关应用。</p>\n<p>此外XDP在黑名单处理和抵御DDos攻击等方面已有较多实践。</p>\n<p>但目前暂时没有找到使用AF_XDP进行数据传输的实践。</p>\n<p>以下是一些关于eBPF进行网络加速的应用实例：</p>\n<h3 id=\"AF-XDP在B站CDN节点QUIC网关的应用和落地\"><a href=\"#AF-XDP在B站CDN节点QUIC网关的应用和落地\" class=\"headerlink\" title=\"AF_XDP在B站CDN节点QUIC网关的应用和落地\"></a>AF_XDP在B站CDN节点QUIC网关的应用和落地</h3><p>原文地址：<a href=\"https://www.bilibili.com/read/cv20778694\">https://www.bilibili.com/read/cv20778694</a></p>\n<p>类似的东西：<a href=\"https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html\">https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html</a></p>\n<p>基于AF_XDP的QUIC网关，XDP程序对数据帧进行过滤，把发给quic-server的HTTP/3请求所对应的数据帧重定向到quic-server维护的xsk中。 </p>\n<p>基于AF_XDP的QUIC网关与原生网关对比：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2017.52.21.png\" alt=\"截屏2023-02-27 17.52.21\"></p>\n<p>基于AF_XDP的QUIC网关执行逻辑：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2020.01.25.png\" alt=\"截屏2023-02-27 20.01.25\"></p>\n<h3 id=\"2）lstio\"><a href=\"#2）lstio\" class=\"headerlink\" title=\"2）lstio\"></a>2）lstio</h3><p>介绍：<a href=\"https://istio.io/v1.15/blog/2022/merbridge/\">https://istio.io/v1.15/blog/2022/merbridge/</a></p>\n<p>lstio使用了sockopts进行了同机器下的网络通信加速。</p>\n<p>原生网络传输路径：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5.png\" alt=\"5\"></p>\n<p>使用sockopts进行跨机器加速：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/6.png\" alt=\"6\"></p>\n<p>使用sockopts进行同机器加速：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2018.52.48.png\" alt=\"截屏2023-02-27 18.52.48\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Best choice is XQUIC！XQUIC Yes！</p>\n<h2 id=\"1）XDP网络加速方案\"><a href=\"#1）XDP网络加速方案\" class=\"headerlink\" title=\"1）XDP网络加速方案\"></a>1）XDP网络加速方案</h2><p>经研究，基于xdp进行serverless服务启动加速这一问题，可以分为两个子问题：</p>\n<pre><code> 1. 如何在WASM runtime中远程恢复运行状态\n 2. 如何使用XDP进行高效的数据传输？(是否已经有类似的解决方案？)\n</code></pre>\n<p>我认为两个问题中，问题2优先级更高。因为事实上这一问题可以拓展为：通过 xdp + sockopts 实现通用的网络加速方案。</p>\n<p>目前网络上暂没有找到类似的解决方案（具体参考第二节），如果我们可以完成这种方案，则该方案不仅可以用于serverless加速，还可以应用于很多很多场景，将具有很好的前景。</p>\n<p>初步构想：由于xdp本身并不具备完整的协议栈，也不能保证数据包的完整性。该设施使用ebpf-xdp技术替换某种网络协议的底层，从而实现一种高速网络通信方案</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2019.33.35.png\" alt=\"截屏2023-02-27 19.33.35\"></p>\n<h2 id=\"2）eBPF在网络加速中的实例\"><a href=\"#2）eBPF在网络加速中的实例\" class=\"headerlink\" title=\"2）eBPF在网络加速中的实例\"></a>2）eBPF在网络加速中的实例</h2><p>AF_XDP技术较新，且AF_XDP的设计主要是针对数据包进行处理，目前可以找到一些AF_XDP在网关等应用的使用实例。这是由于xdp的性质，1）截获网络数据包，2）并重定向包到用户态进行处理，3）最后将数据包传输出去。这一特性非常适合应用于网关应用。</p>\n<p>此外XDP在黑名单处理和抵御DDos攻击等方面已有较多实践。</p>\n<p>但目前暂时没有找到使用AF_XDP进行数据传输的实践。</p>\n<p>以下是一些关于eBPF进行网络加速的应用实例：</p>\n<h3 id=\"AF-XDP在B站CDN节点QUIC网关的应用和落地\"><a href=\"#AF-XDP在B站CDN节点QUIC网关的应用和落地\" class=\"headerlink\" title=\"AF_XDP在B站CDN节点QUIC网关的应用和落地\"></a>AF_XDP在B站CDN节点QUIC网关的应用和落地</h3><p>原文地址：<a href=\"https://www.bilibili.com/read/cv20778694\">https://www.bilibili.com/read/cv20778694</a></p>\n<p>类似的东西：<a href=\"https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html\">https://knot-resolver.readthedocs.io/en/stable/daemon-bindings-net_xdpsrv.html</a></p>\n<p>基于AF_XDP的QUIC网关，XDP程序对数据帧进行过滤，把发给quic-server的HTTP/3请求所对应的数据帧重定向到quic-server维护的xsk中。 </p>\n<p>基于AF_XDP的QUIC网关与原生网关对比：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2017.52.21.png\" alt=\"截屏2023-02-27 17.52.21\"></p>\n<p>基于AF_XDP的QUIC网关执行逻辑：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2020.01.25.png\" alt=\"截屏2023-02-27 20.01.25\"></p>\n<h3 id=\"2）lstio\"><a href=\"#2）lstio\" class=\"headerlink\" title=\"2）lstio\"></a>2）lstio</h3><p>介绍：<a href=\"https://istio.io/v1.15/blog/2022/merbridge/\">https://istio.io/v1.15/blog/2022/merbridge/</a></p>\n<p>lstio使用了sockopts进行了同机器下的网络通信加速。</p>\n<p>原生网络传输路径：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/5.png\" alt=\"5\"></p>\n<p>使用sockopts进行跨机器加速：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/6.png\" alt=\"6\"></p>\n<p>使用sockopts进行同机器加速：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-27%2018.52.48.png\" alt=\"截屏2023-02-27 18.52.48\"></p>\n"},{"title":"eBPF AF_XDP学习","date":"2023-02-22T05:00:14.000Z","_content":"\n官方教程地址（19年版本，有些旧，包依赖关系已经发生了变化）：https://github.com/xdp-project/xdp-tutorial\n\n**What is AF_XDP?**\n\nAF_XDP是一个为高性能数据包处理而优化的解决方案\n\n使用XDP程序中的XDP_REDIRECT动作，该程序可以使用bpf_redirect_map()函数将入帧重定向到其他支持XDP的netdev。AF_XDP socket使XDP程序能够将帧重定向到用户空间应用程序中的内存缓冲区，从而在用户态对数据包进行各种处理\n\n## 1）XDP程序Easy Example\n\n下列程序可以用于在遭受DDos攻击时使用，作用是丢弃所有网络数据包(不要随意在实际网卡跑这个程序，当此程序加载成功的瞬间，ssh链接就会失效，然后就只能重启服务器了)：\n\nXDP内核程序，会被编译为.o文件\n\n```c\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n\nSEC(\"xdp\")\nint  xdp_prog_simple(struct xdp_md *ctx)\n{\n\treturn XDP_DROP;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\n```\n\n加载XDP bpf模块的核心程序：\n\n```c\nint xdp_link_attach(int ifindex, __u32 xdp_flags, int prog_fd)\n{\n\t/* Next assignment this will move into ../common/ */\n\tint err;\n\n\t/* libbpf provide the XDP net_device link-level hook attach helper */\n  /*\n   * 通过helper进行加载\n   * ifindex 网卡设备编号\n   * prog_fd bpf模块的fd\n   */\n\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);\n\tif (err == -EEXIST && !(xdp_flags & XDP_FLAGS_UPDATE_IF_NOEXIST)) {\n\t\t/* Force mode didn't work, probably because a program of the\n\t\t * opposite type is loaded. Let's unload that and try loading\n\t\t * again.\n\t\t * 使用SKB_MODE进行加载\n\t\t */\n\t\t__u32 old_flags = xdp_flags;\n\n\t\txdp_flags &= ~XDP_FLAGS_MODES;\n\t\txdp_flags |= (old_flags & XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;\n\t\terr = bpf_set_link_xdp_fd(ifindex, -1, xdp_flags);\n\t\tif (!err)\n\t\t\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);\n\t}\n\n\tif (err < 0) {\n\t\t// 无法记载，do something\n\t}\n\n\treturn EXIT_OK;\n}\n```\n\n在libbpf中，可以直接使用libbpf提供的加载工具函数进行加载。\n\n## 2）XDP内核程序参数\n\n### XDP输出参数：\n\n```c\nenum xdp_action {\n\tXDP_ABORTED = 0, // Drop packet while raising an exception\n\tXDP_DROP, //丢弃\n\tXDP_PASS, //放行\n\tXDP_TX,   //从同一网课返回该数据包\n\tXDP_REDIRECT, //重定向，AF_XDP可以将数据包重定向到用户态，进行处理\n};\n```\n\n### XDP输入参数：\n\n**data**和**data_end**字段分别是数据包开始和结束的指针，它们是用来获取和解析传来的数据，第三个值是**data_meta**指针，初始阶段它是一个空闲的内存地址，供XDP程序与其他层交换数据包元数据时使用。最后两个字段分别是接收数据包的接口和对应的RX队列的索引。当访问这两个值时，BPF代码会在内核内部重写，以访问实际持有这些值的内核结构**struct xdp_rxq_info**。\n\n```c\nstruct xdp_md {\n\t__u32 data;\n\t__u32 data_end;\n\t__u32 data_meta;\n\t// Below access go through struct xdp_rxq_info\n\t__u32 ingress_ifindex; // rxq->dev->ifindex\n\t__u32 rx_queue_index;  // rxq->queue_index\n};\n```\n\n## 3）Libbpf中使用AF_XDP\n\n由于现在libbpf已经停止了对AF_xdp socket(xsk)的直接支持，为了方便，直接在libpbf项目中手动引入XDP-TOOL，以获取xdp全部功能\nhttps://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96\nXDP tools: https://github.com/xdp-project/xdp-tools\n\n步骤如下：\n\n1. 将xdp-tools包加入libbpf项目目录\n\n2. 修改makefile，对xdp-tools进行编译链接\n    ```makefile\n    #加入编译xdp-tool的部分\n    XDPTOOL_SRC := $(abspath ../../xdp-tools) #待编译文件\n    LIBXDP_SOURCES := $(wildcard $(XDPTOOL_SRC)/lib/libxdp/libxdp*.[ch]) $($(XDPTOOL_SRC)/lib/libxdp/xsk.c)\n    XDPTOOL := $(abspath $(OUTPUT)/libxdp.a)\n    \n    $(XDPTOOL): $(LIBXDP_SOURCES)\n    \t$(call msg,LIB,$@)\n    \t$(Q)$(MAKE) -C $(XDPTOOL_SRC) BUILD_STATIC_ONLY=1\t\\\n    \t\tOBJDIR=$(dir $@)/xdptool DESTDIR=$(dir $@)\t\t      \\\n    \t\tINCLUDEDIR= LIBDIR= UAPIDIR=\t\t\t      \\\n    \t\tlibxdp_install\n    \t\t\n    # 最后生成可执行文件时，链接xdp-tool\n    $(APPS): %: $(OUTPUT)/%.o $(XDPTOOL) $(LIBBPF_OBJ)| $(OUTPUT)  \n    \t$(call msg,BINARY,$@)\n    \t$(Q)$(CC) $(CFLAGS) $^ $(ALL_LDFLAGS) -lpthread -lelf -lz -o $@\n    ```\n\n3. 在用户态bpf程序中引入 \\#include <xdp/xsk.h>，后续即可使用AF_XDP的功能\n\n4. 利用Libbpf中的帮助函数attach xdp程序：\n    ```c\n    // 获取全部网卡信息的工具函数\n    // 参考此博客 https://blog.csdn.net/Rong_Toa/article/details/109118585\n    int ret = get_ifinfo(ifdisplay, NULL);\n    \n    // Attack bpf sec to all IF devs\n    for(int i=0;i<ret;i++){\n    \tbpf_program__attach_xdp (skel->progs.xdp_prog, i);\n    \tif (err) {\n    \t\tfprintf(stderr, \"Failed to attach BPF skeleton\\n\");\n    \t\tgoto cleanup;\n    \t}\n    }\n    ```\n\n经过测试，可以在pipe中看到XDP包的信息\n\n## 4）利用AF XDP将数据包redirect到用户态\n\n### 参考资料：\nhttps://www.kernel.org/doc/html/next/networking/af_xdp.html\nhttps://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/\n\n### AF_XDP用户态与内核交换数据包原理：\n\nAF_XDP在在用户和内核之间，声明了一块公共的内存区域：UMEM。xdp内核程序会将xdp数据包存储在UMEM里，\n同时有四种ring：FILL, COMPLETION, RX , TX。内核将指向UMEM中数据包的指针放入RX queue里。供用户空间消费。同时用户态可以通过写入TX queue，将数据包传回内核处理。内核处理该数据包之后，将TX描述符放入completion queue里，表示处理完成。最后用户空间可以在Fill queue或TX队列里回收描述符。\n\n![image7-6](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png)\n\n一张很有启发意义的图：\n\n![unnamed1](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png)\n\n## 5）AF_XDP代码详解\n\n1. 分配和初始化UMEM\n\n    ```c\n    struct xsk_umem_info {\n    \tstruct xsk_ring_prod fq;\n    \tstruct xsk_ring_cons cq;\n    \tstruct xsk_umem *umem;\n    \tvoid *buffer;\n    };\n    \n    struct xsk_umem_info *umem;\n    void *packet_buffer;\n    uint64_t packet_buffer_size = NUM_FRAMES * FRAME_SIZE;\n    // 进行内存对齐\n    posix_memalign(&packet_buffer,\n    \t\t\t   getpagesize(), /* PAGE_SIZE aligned */\n    \t\t\t   packet_buffer_size)\n    // 初始化UMEM\n    umem = configure_xsk_umem(packet_buffer, packet_buffer_size);\n    \n    // configure_xsk_umem 函数定义\n    static struct xsk_umem_info *configure_xsk_umem(void *buffer, uint64_t size)\n    {\n    \tstruct xsk_umem_info *umem;\n    \tint ret;\n    \t// 声明一块内存空间\n    \tumem = calloc(1, sizeof(*umem));\n    \tif (!umem)\n    \t\treturn NULL;\n    \t// 进行umeme创建\n    \tret = xsk_umem__create(&umem->umem, buffer, size, &umem->fq, &umem->cq,\n    \t\t\t       NULL);\n    \tif (ret) {\n    \t\terrno = -ret;\n    \t\treturn NULL;\n    \t}\n    \t//\n    \tumem->buffer = buffer;\n    \treturn umem;\n    }\n    ```\n\n2. 开启AF_XDP socket (xsk)\n\n    ```c\n    struct xsk_socket_info *xsk_socket;\n    xsk_socket = xsk_configure_socket(umem);\n    \n    // 该函数写死了部分参数，实际使用应通过变量传入这些参数\n    static struct xsk_socket_info *xsk_configure_socket(struct xsk_umem_info *umem)\n    {\n    \tstruct xsk_socket_config xsk_cfg;\n    \tstruct xsk_socket_info *xsk_info;\n    \tuint32_t idx;\n    \tuint32_t prog_id = 0;\n    \tint i;\n    \tint ret;\n    \n    \txsk_info = calloc(1, sizeof(*xsk_info));\n    \tif (!xsk_info)\n    \t\treturn NULL;\n    \n    \txsk_info->umem = umem;\n    \txsk_cfg.rx_size = XSK_RING_CONS__DEFAULT_NUM_DESCS;\n    \txsk_cfg.tx_size = XSK_RING_PROD__DEFAULT_NUM_DESCS;\n    \txsk_cfg.libbpf_flags = 0;\n    \txsk_cfg.xdp_flags = 0; //***\n    \txsk_cfg.bind_flags = 0; //***\n    \t/*!\n    \t* int xsk_socket__create(\n    \t*\t\t\t\t  struct xsk_socket **xsk,\n    \t*\t\t\t\t  const char *ifname, \n    \t*   \t\t\t  __u32 queue_id,\n    \t*\t\t\t\t  struct xsk_umem *umem,\n    \t*\t\t\t\t  struct xsk_ring_cons *rx,\n    \t*\t\t\t\t  struct xsk_ring_prod *tx,\n    \t*\t\t\t\t  const struct xsk_socket_config *config);\n    \t*/\n    \t// 指定将Af_XDP附加在veth-adv03网卡上\n    \tret = xsk_socket__create(&xsk_info->xsk, \"veth-adv03\",\n    \t\t\t\t 0, umem->umem, &xsk_info->rx,\n    \t\t\t\t &xsk_info->tx, &xsk_cfg);\n    \t\n    \tif (ret)\n    \t\tgoto error_exit;\n    \t\n      // 判断是否创建成功\n    \t// ifindex ,prog_id, xdp_flags\n    \tret = bpf_get_link_xdp_id(0, &prog_id, 0);\n    \tif (ret)\n    \t\tgoto error_exit;\n    \n    \t/* Initialize umem frame allocation */\n    \t// 初始化UMEM\n    \tfor (i = 0; i < NUM_FRAMES; i++)\n    \t\txsk_info->umem_frame_addr[i] = i * FRAME_SIZE;\n    \n    \txsk_info->umem_frame_free = NUM_FRAMES;\n    \t\n    \t/* Stuff the receive path with buffers, we assume we have enough */\n      // 初始化RX队列\n    \tret = xsk_ring_prod__reserve(&xsk_info->umem->fq,\n    \t\t\t\t     XSK_RING_PROD__DEFAULT_NUM_DESCS,\n    \t\t\t\t     &idx);\n    \t\t\t\t\t \n    \n    \tif (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)\n    \t\tgoto error_exit;\n    \n    \tfor (i = 0; i < XSK_RING_PROD__DEFAULT_NUM_DESCS; i ++)\n    \t\t*xsk_ring_prod__fill_addr(&xsk_info->umem->fq, idx++) =\n    \t\t\txsk_alloc_umem_frame(xsk_info);\n    \n    \txsk_ring_prod__submit(&xsk_info->umem->fq,\n    \t\t\t      XSK_RING_PROD__DEFAULT_NUM_DESCS);\n    \n    \treturn xsk_info;\n    \n    error_exit:\n    \terrno = -ret;\n    \treturn NULL;\n    }\n    \n    ```\n\n3. 定数输出xdp数据包数据\n\n    ```c\n    pthread_t stats_poll_thread;\n    int ret = pthread_create(&stats_poll_thread, NULL, stats_poll,xsk_socket);\n    \n    static bool global_exit;\n    static void *stats_poll(void *arg)\n    {\n    \tunsigned int interval = 2;\n    \tstruct xsk_socket_info *xsk = arg;\n    \tstatic struct stats_record previous_stats = { 0 };\n    \n    \tprevious_stats.timestamp = gettime();\n    \n    \t/* Trick to pretty printf with thousands separators use %' */\n    \tsetlocale(LC_NUMERIC, \"en_US\");\n    \n    \twhile (!global_exit) {\n    \t\tsleep(interval);\n    \t\txsk->stats.timestamp = gettime();\n    \t\tstats_print(&xsk->stats, &previous_stats);\n    \t\tprevious_stats = xsk->stats;\n    \t}\n    \treturn NULL;\n    }\n    \n    ```\n\n4. 从RX队列中poll数据，并进行处理（此章节未完成）\n\n    ```c\n    rx_and_process(xsk_socket);\n    \n    static void rx_and_process(struct xsk_socket_info *xsk_socket)\n    {\n    \tstruct pollfd fds[2];\n    \tint ret, nfds = 1;\n    \n    \tmemset(fds, 0, sizeof(fds));\n    \tfds[0].fd = xsk_socket__fd(xsk_socket->xsk);\n    \tfds[0].events = POLLIN;\n    \n    \twhile(!global_exit) {\n    \t\tif (\"skb-mode\") {\n    \t\t\tret = poll(fds, nfds, -1);\n    \t\t\tif (ret <= 0 || ret > 1)\n    \t\t\t\tcontinue;\n    \t\t}\n    \t\thandle_receive_packets(xsk_socket); //用户态处理xdp数据包核心函数\n    \t}\n    }\n    \n    static void handle_receive_packets(struct xsk_socket_info *xsk)\n    {\n    \tunsigned int rcvd, stock_frames, i;\n    \tuint32_t idx_rx = 0, idx_fq = 0;\n    \tint ret;\n    \n    \trcvd = xsk_ring_cons__peek(&xsk->rx, RX_BATCH_SIZE, &idx_rx);\n    \tif (!rcvd)\n    \t\treturn;\n    \n    \t/* Stuff the ring with as much frames as possible */\n    \tstock_frames = xsk_prod_nb_free(&xsk->umem->fq,\n    \t\t\t\t\txsk_umem_free_frames(xsk));\n    \n    \tif (stock_frames > 0) {\n    \n    \t\tret = xsk_ring_prod__reserve(&xsk->umem->fq, stock_frames,\n    \t\t\t\t\t     &idx_fq);\n    \n    \t\t/* This should not happen, but just in case */\n    \t\twhile (ret != stock_frames)\n    \t\t\tret = xsk_ring_prod__reserve(&xsk->umem->fq, rcvd,\n    \t\t\t\t\t\t     &idx_fq);\n    \n    \t\tfor (i = 0; i < stock_frames; i++)\n    \t\t\t*xsk_ring_prod__fill_addr(&xsk->umem->fq, idx_fq++) =\n    \t\t\t\txsk_alloc_umem_frame(xsk);\n    \n    \t\txsk_ring_prod__submit(&xsk->umem->fq, stock_frames);\n    \t}\n    \n    \t/* Process received packets */\n    \tfor (i = 0; i < rcvd; i++) {\n    \t\tuint64_t addr = xsk_ring_cons__rx_desc(&xsk->rx, idx_rx)->addr;\n    \t\tuint32_t len = xsk_ring_cons__rx_desc(&xsk->rx, idx_rx++)->len;\n    \n    \t\tif (!process_packet(xsk, addr, len))\n    \t\t\txsk_free_umem_frame(xsk, addr);\n    \n    \t\txsk->stats.rx_bytes += len;\n    \t}\n    \n    \txsk_ring_cons__release(&xsk->rx, rcvd);\n    \txsk->stats.rx_packets += rcvd;\n    \n    \t/* Do we need to wake up the kernel for transmission */\n    \tcomplete_tx(xsk);\n    }\n    \n    // 处理数据包核心逻辑部分\n    static bool process_packet(struct xsk_socket_info *xsk,\n    \t\t\t   uint64_t addr, uint32_t len)\n    {\n    \tuint8_t *pkt = xsk_umem__get_data(xsk->umem->buffer, addr);\n    \n            /* Lesson#3: Write an IPv6 ICMP ECHO parser to send responses\n    \t *\n    \t * Some assumptions to make it easier:\n    \t * - No VLAN handling\n    \t * - Only if nexthdr is ICMP\n    \t * - Just return all data with MAC/IP swapped, and type set to\n    \t *   ICMPV6_ECHO_REPLY\n    \t * - Recalculate the icmp checksum */\n    \n    \tif (false) {\n    \t\tint ret;\n    \t\tuint32_t tx_idx = 0;\n    \t\tuint8_t tmp_mac[ETH_ALEN];\n    \t\tstruct in6_addr tmp_ip;\n    \t\tstruct ethhdr *eth = (struct ethhdr *) pkt;\n    \t\tstruct ipv6hdr *ipv6 = (struct ipv6hdr *) (eth + 1);\n    \t\tstruct icmp6hdr *icmp = (struct icmp6hdr *) (ipv6 + 1);\n    \n    \t\tif (ntohs(eth->h_proto) != ETH_P_IPV6 ||\n    \t\t    len < (sizeof(*eth) + sizeof(*ipv6) + sizeof(*icmp)) ||\n    \t\t    ipv6->nexthdr != IPPROTO_ICMPV6 ||\n    \t\t    icmp->icmp6_type != ICMPV6_ECHO_REQUEST)\n    \t\t\treturn false;\n    \n    \t\tmemcpy(tmp_mac, eth->h_dest, ETH_ALEN);\n    \t\tmemcpy(eth->h_dest, eth->h_source, ETH_ALEN);\n    \t\tmemcpy(eth->h_source, tmp_mac, ETH_ALEN);\n    \n    \t\tmemcpy(&tmp_ip, &ipv6->saddr, sizeof(tmp_ip));\n    \t\tmemcpy(&ipv6->saddr, &ipv6->daddr, sizeof(tmp_ip));\n    \t\tmemcpy(&ipv6->daddr, &tmp_ip, sizeof(tmp_ip));\n    \n    \t\ticmp->icmp6_type = ICMPV6_ECHO_REPLY;\n    \n    \t\tcsum_replace2(&icmp->icmp6_cksum,\n    \t\t\t      htons(ICMPV6_ECHO_REQUEST << 8),\n    \t\t\t      htons(ICMPV6_ECHO_REPLY << 8));\n    \n    \t\t/* Here we sent the packet out of the receive port. Note that\n    \t\t * we allocate one entry and schedule it. Your design would be\n    \t\t * faster if you do batch processing/transmission */\n    \n    \t\tret = xsk_ring_prod__reserve(&xsk->tx, 1, &tx_idx);\n    \t\tif (ret != 1) {\n    \t\t\t/* No more transmit slots, drop the packet */\n    \t\t\treturn false;\n    \t\t}\n    \n    \t\txsk_ring_prod__tx_desc(&xsk->tx, tx_idx)->addr = addr;\n    \t\txsk_ring_prod__tx_desc(&xsk->tx, tx_idx)->len = len;\n    \t\txsk_ring_prod__submit(&xsk->tx, 1);\n    \t\txsk->outstanding_tx++;\n    \n    \t\txsk->stats.tx_bytes += len;\n    \t\txsk->stats.tx_packets++;\n    \t\treturn true;\n    \t}\n    \n    \treturn false;\n    }\n    \n    ```\n\n\n\n完整代码：\n\n在用户态输出xdp包数据，运行结果：\n\n![截屏2023-02-25 21.36.18](https://github.com/muchengl/pic_storage/blob/main/uPic/截屏2023-02-25%2021.36.18.png?raw=true)\n","source":"_posts/eBPF-XDP.md","raw":"---\ntitle: eBPF AF_XDP学习\ndate: 2023-02-22 13:00:14\ntags:\n---\n\n官方教程地址（19年版本，有些旧，包依赖关系已经发生了变化）：https://github.com/xdp-project/xdp-tutorial\n\n**What is AF_XDP?**\n\nAF_XDP是一个为高性能数据包处理而优化的解决方案\n\n使用XDP程序中的XDP_REDIRECT动作，该程序可以使用bpf_redirect_map()函数将入帧重定向到其他支持XDP的netdev。AF_XDP socket使XDP程序能够将帧重定向到用户空间应用程序中的内存缓冲区，从而在用户态对数据包进行各种处理\n\n## 1）XDP程序Easy Example\n\n下列程序可以用于在遭受DDos攻击时使用，作用是丢弃所有网络数据包(不要随意在实际网卡跑这个程序，当此程序加载成功的瞬间，ssh链接就会失效，然后就只能重启服务器了)：\n\nXDP内核程序，会被编译为.o文件\n\n```c\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n\nSEC(\"xdp\")\nint  xdp_prog_simple(struct xdp_md *ctx)\n{\n\treturn XDP_DROP;\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\n\n```\n\n加载XDP bpf模块的核心程序：\n\n```c\nint xdp_link_attach(int ifindex, __u32 xdp_flags, int prog_fd)\n{\n\t/* Next assignment this will move into ../common/ */\n\tint err;\n\n\t/* libbpf provide the XDP net_device link-level hook attach helper */\n  /*\n   * 通过helper进行加载\n   * ifindex 网卡设备编号\n   * prog_fd bpf模块的fd\n   */\n\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);\n\tif (err == -EEXIST && !(xdp_flags & XDP_FLAGS_UPDATE_IF_NOEXIST)) {\n\t\t/* Force mode didn't work, probably because a program of the\n\t\t * opposite type is loaded. Let's unload that and try loading\n\t\t * again.\n\t\t * 使用SKB_MODE进行加载\n\t\t */\n\t\t__u32 old_flags = xdp_flags;\n\n\t\txdp_flags &= ~XDP_FLAGS_MODES;\n\t\txdp_flags |= (old_flags & XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;\n\t\terr = bpf_set_link_xdp_fd(ifindex, -1, xdp_flags);\n\t\tif (!err)\n\t\t\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);\n\t}\n\n\tif (err < 0) {\n\t\t// 无法记载，do something\n\t}\n\n\treturn EXIT_OK;\n}\n```\n\n在libbpf中，可以直接使用libbpf提供的加载工具函数进行加载。\n\n## 2）XDP内核程序参数\n\n### XDP输出参数：\n\n```c\nenum xdp_action {\n\tXDP_ABORTED = 0, // Drop packet while raising an exception\n\tXDP_DROP, //丢弃\n\tXDP_PASS, //放行\n\tXDP_TX,   //从同一网课返回该数据包\n\tXDP_REDIRECT, //重定向，AF_XDP可以将数据包重定向到用户态，进行处理\n};\n```\n\n### XDP输入参数：\n\n**data**和**data_end**字段分别是数据包开始和结束的指针，它们是用来获取和解析传来的数据，第三个值是**data_meta**指针，初始阶段它是一个空闲的内存地址，供XDP程序与其他层交换数据包元数据时使用。最后两个字段分别是接收数据包的接口和对应的RX队列的索引。当访问这两个值时，BPF代码会在内核内部重写，以访问实际持有这些值的内核结构**struct xdp_rxq_info**。\n\n```c\nstruct xdp_md {\n\t__u32 data;\n\t__u32 data_end;\n\t__u32 data_meta;\n\t// Below access go through struct xdp_rxq_info\n\t__u32 ingress_ifindex; // rxq->dev->ifindex\n\t__u32 rx_queue_index;  // rxq->queue_index\n};\n```\n\n## 3）Libbpf中使用AF_XDP\n\n由于现在libbpf已经停止了对AF_xdp socket(xsk)的直接支持，为了方便，直接在libpbf项目中手动引入XDP-TOOL，以获取xdp全部功能\nhttps://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96\nXDP tools: https://github.com/xdp-project/xdp-tools\n\n步骤如下：\n\n1. 将xdp-tools包加入libbpf项目目录\n\n2. 修改makefile，对xdp-tools进行编译链接\n    ```makefile\n    #加入编译xdp-tool的部分\n    XDPTOOL_SRC := $(abspath ../../xdp-tools) #待编译文件\n    LIBXDP_SOURCES := $(wildcard $(XDPTOOL_SRC)/lib/libxdp/libxdp*.[ch]) $($(XDPTOOL_SRC)/lib/libxdp/xsk.c)\n    XDPTOOL := $(abspath $(OUTPUT)/libxdp.a)\n    \n    $(XDPTOOL): $(LIBXDP_SOURCES)\n    \t$(call msg,LIB,$@)\n    \t$(Q)$(MAKE) -C $(XDPTOOL_SRC) BUILD_STATIC_ONLY=1\t\\\n    \t\tOBJDIR=$(dir $@)/xdptool DESTDIR=$(dir $@)\t\t      \\\n    \t\tINCLUDEDIR= LIBDIR= UAPIDIR=\t\t\t      \\\n    \t\tlibxdp_install\n    \t\t\n    # 最后生成可执行文件时，链接xdp-tool\n    $(APPS): %: $(OUTPUT)/%.o $(XDPTOOL) $(LIBBPF_OBJ)| $(OUTPUT)  \n    \t$(call msg,BINARY,$@)\n    \t$(Q)$(CC) $(CFLAGS) $^ $(ALL_LDFLAGS) -lpthread -lelf -lz -o $@\n    ```\n\n3. 在用户态bpf程序中引入 \\#include <xdp/xsk.h>，后续即可使用AF_XDP的功能\n\n4. 利用Libbpf中的帮助函数attach xdp程序：\n    ```c\n    // 获取全部网卡信息的工具函数\n    // 参考此博客 https://blog.csdn.net/Rong_Toa/article/details/109118585\n    int ret = get_ifinfo(ifdisplay, NULL);\n    \n    // Attack bpf sec to all IF devs\n    for(int i=0;i<ret;i++){\n    \tbpf_program__attach_xdp (skel->progs.xdp_prog, i);\n    \tif (err) {\n    \t\tfprintf(stderr, \"Failed to attach BPF skeleton\\n\");\n    \t\tgoto cleanup;\n    \t}\n    }\n    ```\n\n经过测试，可以在pipe中看到XDP包的信息\n\n## 4）利用AF XDP将数据包redirect到用户态\n\n### 参考资料：\nhttps://www.kernel.org/doc/html/next/networking/af_xdp.html\nhttps://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/\n\n### AF_XDP用户态与内核交换数据包原理：\n\nAF_XDP在在用户和内核之间，声明了一块公共的内存区域：UMEM。xdp内核程序会将xdp数据包存储在UMEM里，\n同时有四种ring：FILL, COMPLETION, RX , TX。内核将指向UMEM中数据包的指针放入RX queue里。供用户空间消费。同时用户态可以通过写入TX queue，将数据包传回内核处理。内核处理该数据包之后，将TX描述符放入completion queue里，表示处理完成。最后用户空间可以在Fill queue或TX队列里回收描述符。\n\n![image7-6](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png)\n\n一张很有启发意义的图：\n\n![unnamed1](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png)\n\n## 5）AF_XDP代码详解\n\n1. 分配和初始化UMEM\n\n    ```c\n    struct xsk_umem_info {\n    \tstruct xsk_ring_prod fq;\n    \tstruct xsk_ring_cons cq;\n    \tstruct xsk_umem *umem;\n    \tvoid *buffer;\n    };\n    \n    struct xsk_umem_info *umem;\n    void *packet_buffer;\n    uint64_t packet_buffer_size = NUM_FRAMES * FRAME_SIZE;\n    // 进行内存对齐\n    posix_memalign(&packet_buffer,\n    \t\t\t   getpagesize(), /* PAGE_SIZE aligned */\n    \t\t\t   packet_buffer_size)\n    // 初始化UMEM\n    umem = configure_xsk_umem(packet_buffer, packet_buffer_size);\n    \n    // configure_xsk_umem 函数定义\n    static struct xsk_umem_info *configure_xsk_umem(void *buffer, uint64_t size)\n    {\n    \tstruct xsk_umem_info *umem;\n    \tint ret;\n    \t// 声明一块内存空间\n    \tumem = calloc(1, sizeof(*umem));\n    \tif (!umem)\n    \t\treturn NULL;\n    \t// 进行umeme创建\n    \tret = xsk_umem__create(&umem->umem, buffer, size, &umem->fq, &umem->cq,\n    \t\t\t       NULL);\n    \tif (ret) {\n    \t\terrno = -ret;\n    \t\treturn NULL;\n    \t}\n    \t//\n    \tumem->buffer = buffer;\n    \treturn umem;\n    }\n    ```\n\n2. 开启AF_XDP socket (xsk)\n\n    ```c\n    struct xsk_socket_info *xsk_socket;\n    xsk_socket = xsk_configure_socket(umem);\n    \n    // 该函数写死了部分参数，实际使用应通过变量传入这些参数\n    static struct xsk_socket_info *xsk_configure_socket(struct xsk_umem_info *umem)\n    {\n    \tstruct xsk_socket_config xsk_cfg;\n    \tstruct xsk_socket_info *xsk_info;\n    \tuint32_t idx;\n    \tuint32_t prog_id = 0;\n    \tint i;\n    \tint ret;\n    \n    \txsk_info = calloc(1, sizeof(*xsk_info));\n    \tif (!xsk_info)\n    \t\treturn NULL;\n    \n    \txsk_info->umem = umem;\n    \txsk_cfg.rx_size = XSK_RING_CONS__DEFAULT_NUM_DESCS;\n    \txsk_cfg.tx_size = XSK_RING_PROD__DEFAULT_NUM_DESCS;\n    \txsk_cfg.libbpf_flags = 0;\n    \txsk_cfg.xdp_flags = 0; //***\n    \txsk_cfg.bind_flags = 0; //***\n    \t/*!\n    \t* int xsk_socket__create(\n    \t*\t\t\t\t  struct xsk_socket **xsk,\n    \t*\t\t\t\t  const char *ifname, \n    \t*   \t\t\t  __u32 queue_id,\n    \t*\t\t\t\t  struct xsk_umem *umem,\n    \t*\t\t\t\t  struct xsk_ring_cons *rx,\n    \t*\t\t\t\t  struct xsk_ring_prod *tx,\n    \t*\t\t\t\t  const struct xsk_socket_config *config);\n    \t*/\n    \t// 指定将Af_XDP附加在veth-adv03网卡上\n    \tret = xsk_socket__create(&xsk_info->xsk, \"veth-adv03\",\n    \t\t\t\t 0, umem->umem, &xsk_info->rx,\n    \t\t\t\t &xsk_info->tx, &xsk_cfg);\n    \t\n    \tif (ret)\n    \t\tgoto error_exit;\n    \t\n      // 判断是否创建成功\n    \t// ifindex ,prog_id, xdp_flags\n    \tret = bpf_get_link_xdp_id(0, &prog_id, 0);\n    \tif (ret)\n    \t\tgoto error_exit;\n    \n    \t/* Initialize umem frame allocation */\n    \t// 初始化UMEM\n    \tfor (i = 0; i < NUM_FRAMES; i++)\n    \t\txsk_info->umem_frame_addr[i] = i * FRAME_SIZE;\n    \n    \txsk_info->umem_frame_free = NUM_FRAMES;\n    \t\n    \t/* Stuff the receive path with buffers, we assume we have enough */\n      // 初始化RX队列\n    \tret = xsk_ring_prod__reserve(&xsk_info->umem->fq,\n    \t\t\t\t     XSK_RING_PROD__DEFAULT_NUM_DESCS,\n    \t\t\t\t     &idx);\n    \t\t\t\t\t \n    \n    \tif (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)\n    \t\tgoto error_exit;\n    \n    \tfor (i = 0; i < XSK_RING_PROD__DEFAULT_NUM_DESCS; i ++)\n    \t\t*xsk_ring_prod__fill_addr(&xsk_info->umem->fq, idx++) =\n    \t\t\txsk_alloc_umem_frame(xsk_info);\n    \n    \txsk_ring_prod__submit(&xsk_info->umem->fq,\n    \t\t\t      XSK_RING_PROD__DEFAULT_NUM_DESCS);\n    \n    \treturn xsk_info;\n    \n    error_exit:\n    \terrno = -ret;\n    \treturn NULL;\n    }\n    \n    ```\n\n3. 定数输出xdp数据包数据\n\n    ```c\n    pthread_t stats_poll_thread;\n    int ret = pthread_create(&stats_poll_thread, NULL, stats_poll,xsk_socket);\n    \n    static bool global_exit;\n    static void *stats_poll(void *arg)\n    {\n    \tunsigned int interval = 2;\n    \tstruct xsk_socket_info *xsk = arg;\n    \tstatic struct stats_record previous_stats = { 0 };\n    \n    \tprevious_stats.timestamp = gettime();\n    \n    \t/* Trick to pretty printf with thousands separators use %' */\n    \tsetlocale(LC_NUMERIC, \"en_US\");\n    \n    \twhile (!global_exit) {\n    \t\tsleep(interval);\n    \t\txsk->stats.timestamp = gettime();\n    \t\tstats_print(&xsk->stats, &previous_stats);\n    \t\tprevious_stats = xsk->stats;\n    \t}\n    \treturn NULL;\n    }\n    \n    ```\n\n4. 从RX队列中poll数据，并进行处理（此章节未完成）\n\n    ```c\n    rx_and_process(xsk_socket);\n    \n    static void rx_and_process(struct xsk_socket_info *xsk_socket)\n    {\n    \tstruct pollfd fds[2];\n    \tint ret, nfds = 1;\n    \n    \tmemset(fds, 0, sizeof(fds));\n    \tfds[0].fd = xsk_socket__fd(xsk_socket->xsk);\n    \tfds[0].events = POLLIN;\n    \n    \twhile(!global_exit) {\n    \t\tif (\"skb-mode\") {\n    \t\t\tret = poll(fds, nfds, -1);\n    \t\t\tif (ret <= 0 || ret > 1)\n    \t\t\t\tcontinue;\n    \t\t}\n    \t\thandle_receive_packets(xsk_socket); //用户态处理xdp数据包核心函数\n    \t}\n    }\n    \n    static void handle_receive_packets(struct xsk_socket_info *xsk)\n    {\n    \tunsigned int rcvd, stock_frames, i;\n    \tuint32_t idx_rx = 0, idx_fq = 0;\n    \tint ret;\n    \n    \trcvd = xsk_ring_cons__peek(&xsk->rx, RX_BATCH_SIZE, &idx_rx);\n    \tif (!rcvd)\n    \t\treturn;\n    \n    \t/* Stuff the ring with as much frames as possible */\n    \tstock_frames = xsk_prod_nb_free(&xsk->umem->fq,\n    \t\t\t\t\txsk_umem_free_frames(xsk));\n    \n    \tif (stock_frames > 0) {\n    \n    \t\tret = xsk_ring_prod__reserve(&xsk->umem->fq, stock_frames,\n    \t\t\t\t\t     &idx_fq);\n    \n    \t\t/* This should not happen, but just in case */\n    \t\twhile (ret != stock_frames)\n    \t\t\tret = xsk_ring_prod__reserve(&xsk->umem->fq, rcvd,\n    \t\t\t\t\t\t     &idx_fq);\n    \n    \t\tfor (i = 0; i < stock_frames; i++)\n    \t\t\t*xsk_ring_prod__fill_addr(&xsk->umem->fq, idx_fq++) =\n    \t\t\t\txsk_alloc_umem_frame(xsk);\n    \n    \t\txsk_ring_prod__submit(&xsk->umem->fq, stock_frames);\n    \t}\n    \n    \t/* Process received packets */\n    \tfor (i = 0; i < rcvd; i++) {\n    \t\tuint64_t addr = xsk_ring_cons__rx_desc(&xsk->rx, idx_rx)->addr;\n    \t\tuint32_t len = xsk_ring_cons__rx_desc(&xsk->rx, idx_rx++)->len;\n    \n    \t\tif (!process_packet(xsk, addr, len))\n    \t\t\txsk_free_umem_frame(xsk, addr);\n    \n    \t\txsk->stats.rx_bytes += len;\n    \t}\n    \n    \txsk_ring_cons__release(&xsk->rx, rcvd);\n    \txsk->stats.rx_packets += rcvd;\n    \n    \t/* Do we need to wake up the kernel for transmission */\n    \tcomplete_tx(xsk);\n    }\n    \n    // 处理数据包核心逻辑部分\n    static bool process_packet(struct xsk_socket_info *xsk,\n    \t\t\t   uint64_t addr, uint32_t len)\n    {\n    \tuint8_t *pkt = xsk_umem__get_data(xsk->umem->buffer, addr);\n    \n            /* Lesson#3: Write an IPv6 ICMP ECHO parser to send responses\n    \t *\n    \t * Some assumptions to make it easier:\n    \t * - No VLAN handling\n    \t * - Only if nexthdr is ICMP\n    \t * - Just return all data with MAC/IP swapped, and type set to\n    \t *   ICMPV6_ECHO_REPLY\n    \t * - Recalculate the icmp checksum */\n    \n    \tif (false) {\n    \t\tint ret;\n    \t\tuint32_t tx_idx = 0;\n    \t\tuint8_t tmp_mac[ETH_ALEN];\n    \t\tstruct in6_addr tmp_ip;\n    \t\tstruct ethhdr *eth = (struct ethhdr *) pkt;\n    \t\tstruct ipv6hdr *ipv6 = (struct ipv6hdr *) (eth + 1);\n    \t\tstruct icmp6hdr *icmp = (struct icmp6hdr *) (ipv6 + 1);\n    \n    \t\tif (ntohs(eth->h_proto) != ETH_P_IPV6 ||\n    \t\t    len < (sizeof(*eth) + sizeof(*ipv6) + sizeof(*icmp)) ||\n    \t\t    ipv6->nexthdr != IPPROTO_ICMPV6 ||\n    \t\t    icmp->icmp6_type != ICMPV6_ECHO_REQUEST)\n    \t\t\treturn false;\n    \n    \t\tmemcpy(tmp_mac, eth->h_dest, ETH_ALEN);\n    \t\tmemcpy(eth->h_dest, eth->h_source, ETH_ALEN);\n    \t\tmemcpy(eth->h_source, tmp_mac, ETH_ALEN);\n    \n    \t\tmemcpy(&tmp_ip, &ipv6->saddr, sizeof(tmp_ip));\n    \t\tmemcpy(&ipv6->saddr, &ipv6->daddr, sizeof(tmp_ip));\n    \t\tmemcpy(&ipv6->daddr, &tmp_ip, sizeof(tmp_ip));\n    \n    \t\ticmp->icmp6_type = ICMPV6_ECHO_REPLY;\n    \n    \t\tcsum_replace2(&icmp->icmp6_cksum,\n    \t\t\t      htons(ICMPV6_ECHO_REQUEST << 8),\n    \t\t\t      htons(ICMPV6_ECHO_REPLY << 8));\n    \n    \t\t/* Here we sent the packet out of the receive port. Note that\n    \t\t * we allocate one entry and schedule it. Your design would be\n    \t\t * faster if you do batch processing/transmission */\n    \n    \t\tret = xsk_ring_prod__reserve(&xsk->tx, 1, &tx_idx);\n    \t\tif (ret != 1) {\n    \t\t\t/* No more transmit slots, drop the packet */\n    \t\t\treturn false;\n    \t\t}\n    \n    \t\txsk_ring_prod__tx_desc(&xsk->tx, tx_idx)->addr = addr;\n    \t\txsk_ring_prod__tx_desc(&xsk->tx, tx_idx)->len = len;\n    \t\txsk_ring_prod__submit(&xsk->tx, 1);\n    \t\txsk->outstanding_tx++;\n    \n    \t\txsk->stats.tx_bytes += len;\n    \t\txsk->stats.tx_packets++;\n    \t\treturn true;\n    \t}\n    \n    \treturn false;\n    }\n    \n    ```\n\n\n\n完整代码：\n\n在用户态输出xdp包数据，运行结果：\n\n![截屏2023-02-25 21.36.18](https://github.com/muchengl/pic_storage/blob/main/uPic/截屏2023-02-25%2021.36.18.png?raw=true)\n","slug":"eBPF-XDP","published":1,"updated":"2023-02-27T07:47:00.256Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa5000yb9c9hrpb9omf","content":"<p>官方教程地址（19年版本，有些旧，包依赖关系已经发生了变化）：<a href=\"https://github.com/xdp-project/xdp-tutorial\">https://github.com/xdp-project/xdp-tutorial</a></p>\n<p><strong>What is AF_XDP?</strong></p>\n<p>AF_XDP是一个为高性能数据包处理而优化的解决方案</p>\n<p>使用XDP程序中的XDP_REDIRECT动作，该程序可以使用bpf_redirect_map()函数将入帧重定向到其他支持XDP的netdev。AF_XDP socket使XDP程序能够将帧重定向到用户空间应用程序中的内存缓冲区，从而在用户态对数据包进行各种处理</p>\n<h2 id=\"1）XDP程序Easy-Example\"><a href=\"#1）XDP程序Easy-Example\" class=\"headerlink\" title=\"1）XDP程序Easy Example\"></a>1）XDP程序Easy Example</h2><p>下列程序可以用于在遭受DDos攻击时使用，作用是丢弃所有网络数据包(不要随意在实际网卡跑这个程序，当此程序加载成功的瞬间，ssh链接就会失效，然后就只能重启服务器了)：</p>\n<p>XDP内核程序，会被编译为.o文件</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/bpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">SEC(<span class=\"string\">&quot;xdp&quot;</span>)</span><br><span class=\"line\"><span class=\"type\">int</span>  <span class=\"title function_\">xdp_prog_simple</span><span class=\"params\">(<span class=\"keyword\">struct</span> xdp_md *ctx)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> XDP_DROP;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> _license[] SEC(<span class=\"string\">&quot;license&quot;</span>) = <span class=\"string\">&quot;GPL&quot;</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>加载XDP bpf模块的核心程序：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">xdp_link_attach</span><span class=\"params\">(<span class=\"type\">int</span> ifindex, __u32 xdp_flags, <span class=\"type\">int</span> prog_fd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">/* Next assignment this will move into ../common/ */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> err;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* libbpf provide the XDP net_device link-level hook attach helper */</span></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * 通过helper进行加载</span></span><br><span class=\"line\"><span class=\"comment\">   * ifindex 网卡设备编号</span></span><br><span class=\"line\"><span class=\"comment\">   * prog_fd bpf模块的fd</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err == -EEXIST &amp;&amp; !(xdp_flags &amp; XDP_FLAGS_UPDATE_IF_NOEXIST)) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Force mode didn&#x27;t work, probably because a program of the</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * opposite type is loaded. Let&#x27;s unload that and try loading</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * again.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * 使用SKB_MODE进行加载</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t__u32 old_flags = xdp_flags;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txdp_flags &amp;= ~XDP_FLAGS_MODES;</span><br><span class=\"line\">\t\txdp_flags |= (old_flags &amp; XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;</span><br><span class=\"line\">\t\terr = bpf_set_link_xdp_fd(ifindex, <span class=\"number\">-1</span>, xdp_flags);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!err)</span><br><span class=\"line\">\t\t\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 无法记载，do something</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> EXIT_OK;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在libbpf中，可以直接使用libbpf提供的加载工具函数进行加载。</p>\n<h2 id=\"2）XDP内核程序参数\"><a href=\"#2）XDP内核程序参数\" class=\"headerlink\" title=\"2）XDP内核程序参数\"></a>2）XDP内核程序参数</h2><h3 id=\"XDP输出参数：\"><a href=\"#XDP输出参数：\" class=\"headerlink\" title=\"XDP输出参数：\"></a>XDP输出参数：</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">xdp_action</span> &#123;</span></span><br><span class=\"line\">\tXDP_ABORTED = <span class=\"number\">0</span>, <span class=\"comment\">// Drop packet while raising an exception</span></span><br><span class=\"line\">\tXDP_DROP, <span class=\"comment\">//丢弃</span></span><br><span class=\"line\">\tXDP_PASS, <span class=\"comment\">//放行</span></span><br><span class=\"line\">\tXDP_TX,   <span class=\"comment\">//从同一网课返回该数据包</span></span><br><span class=\"line\">\tXDP_REDIRECT, <span class=\"comment\">//重定向，AF_XDP可以将数据包重定向到用户态，进行处理</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"XDP输入参数：\"><a href=\"#XDP输入参数：\" class=\"headerlink\" title=\"XDP输入参数：\"></a>XDP输入参数：</h3><p><strong>data</strong>和<strong>data_end</strong>字段分别是数据包开始和结束的指针，它们是用来获取和解析传来的数据，第三个值是<strong>data_meta</strong>指针，初始阶段它是一个空闲的内存地址，供XDP程序与其他层交换数据包元数据时使用。最后两个字段分别是接收数据包的接口和对应的RX队列的索引。当访问这两个值时，BPF代码会在内核内部重写，以访问实际持有这些值的内核结构<strong>struct xdp_rxq_info</strong>。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xdp_md</span> &#123;</span></span><br><span class=\"line\">\t__u32 data;</span><br><span class=\"line\">\t__u32 data_end;</span><br><span class=\"line\">\t__u32 data_meta;</span><br><span class=\"line\">\t<span class=\"comment\">// Below access go through struct xdp_rxq_info</span></span><br><span class=\"line\">\t__u32 ingress_ifindex; <span class=\"comment\">// rxq-&gt;dev-&gt;ifindex</span></span><br><span class=\"line\">\t__u32 rx_queue_index;  <span class=\"comment\">// rxq-&gt;queue_index</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3）Libbpf中使用AF-XDP\"><a href=\"#3）Libbpf中使用AF-XDP\" class=\"headerlink\" title=\"3）Libbpf中使用AF_XDP\"></a>3）Libbpf中使用AF_XDP</h2><p>由于现在libbpf已经停止了对AF_xdp socket(xsk)的直接支持，为了方便，直接在libpbf项目中手动引入XDP-TOOL，以获取xdp全部功能<br><a href=\"https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96\">https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96</a><br>XDP tools: <a href=\"https://github.com/xdp-project/xdp-tools\">https://github.com/xdp-project/xdp-tools</a></p>\n<p>步骤如下：</p>\n<ol>\n<li><p>将xdp-tools包加入libbpf项目目录</p>\n</li>\n<li><p>修改makefile，对xdp-tools进行编译链接</p>\n <figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#加入编译xdp-tool的部分</span></span><br><span class=\"line\">XDPTOOL_SRC := <span class=\"variable\">$(<span class=\"built_in\">abspath</span> ../../xdp-tools)</span> <span class=\"comment\">#待编译文件</span></span><br><span class=\"line\">LIBXDP_SOURCES := <span class=\"variable\">$(<span class=\"built_in\">wildcard</span> <span class=\"variable\">$(XDPTOOL_SRC)</span>/lib/libxdp/libxdp*.[ch])</span> $(<span class=\"variable\">$(XDPTOOL_SRC)</span>/lib/libxdp/xsk.c)</span><br><span class=\"line\">XDPTOOL := <span class=\"variable\">$(<span class=\"built_in\">abspath</span> <span class=\"variable\">$(OUTPUT)</span>/libxdp.a)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$(XDPTOOL)</span>: <span class=\"variable\">$(LIBXDP_SOURCES)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(<span class=\"built_in\">call</span> msg,LIB,<span class=\"variable\">$@</span>)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(Q)</span><span class=\"variable\">$(MAKE)</span> -C <span class=\"variable\">$(XDPTOOL_SRC)</span> BUILD_STATIC_ONLY=1\t\\</span><br><span class=\"line\">\t\tOBJDIR=<span class=\"variable\">$(<span class=\"built_in\">dir</span> <span class=\"variable\">$@</span>)</span>/xdptool DESTDIR=<span class=\"variable\">$(<span class=\"built_in\">dir</span> <span class=\"variable\">$@</span>)</span>\t\t      \\</span><br><span class=\"line\">\t\tINCLUDEDIR= LIBDIR= UAPIDIR=\t\t\t      \\</span><br><span class=\"line\">\t\tlibxdp_install</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"comment\"># 最后生成可执行文件时，链接xdp-tool</span></span><br><span class=\"line\"><span class=\"variable\">$(APPS)</span>: %: <span class=\"variable\">$(OUTPUT)</span>/%.o <span class=\"variable\">$(XDPTOOL)</span> <span class=\"variable\">$(LIBBPF_OBJ)</span>| <span class=\"variable\">$(OUTPUT)</span>  </span><br><span class=\"line\">\t<span class=\"variable\">$(<span class=\"built_in\">call</span> msg,BINARY,<span class=\"variable\">$@</span>)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(Q)</span><span class=\"variable\">$(CC)</span> <span class=\"variable\">$(CFLAGS)</span> <span class=\"variable\">$^</span> <span class=\"variable\">$(ALL_LDFLAGS)</span> -lpthread -lelf -lz -o <span class=\"variable\">$@</span></span><br></pre></td></tr></table></figure></li>\n<li><p>在用户态bpf程序中引入 #include &lt;xdp/xsk.h&gt;，后续即可使用AF_XDP的功能</p>\n</li>\n<li><p>利用Libbpf中的帮助函数attach xdp程序：</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取全部网卡信息的工具函数</span></span><br><span class=\"line\"><span class=\"comment\">// 参考此博客 https://blog.csdn.net/Rong_Toa/article/details/109118585</span></span><br><span class=\"line\"><span class=\"type\">int</span> ret = get_ifinfo(ifdisplay, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Attack bpf sec to all IF devs</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;ret;i++)&#123;</span><br><span class=\"line\">\tbpf_program__attach_xdp (skel-&gt;progs.xdp_prog, i);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to attach BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>经过测试，可以在pipe中看到XDP包的信息</p>\n<h2 id=\"4）利用AF-XDP将数据包redirect到用户态\"><a href=\"#4）利用AF-XDP将数据包redirect到用户态\" class=\"headerlink\" title=\"4）利用AF XDP将数据包redirect到用户态\"></a>4）利用AF XDP将数据包redirect到用户态</h2><h3 id=\"参考资料：\"><a href=\"#参考资料：\" class=\"headerlink\" title=\"参考资料：\"></a>参考资料：</h3><p><a href=\"https://www.kernel.org/doc/html/next/networking/af_xdp.html\">https://www.kernel.org/doc/html/next/networking/af_xdp.html</a><br><a href=\"https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/\">https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/</a></p>\n<h3 id=\"AF-XDP用户态与内核交换数据包原理：\"><a href=\"#AF-XDP用户态与内核交换数据包原理：\" class=\"headerlink\" title=\"AF_XDP用户态与内核交换数据包原理：\"></a>AF_XDP用户态与内核交换数据包原理：</h3><p>AF_XDP在在用户和内核之间，声明了一块公共的内存区域：UMEM。xdp内核程序会将xdp数据包存储在UMEM里，<br>同时有四种ring：FILL, COMPLETION, RX , TX。内核将指向UMEM中数据包的指针放入RX queue里。供用户空间消费。同时用户态可以通过写入TX queue，将数据包传回内核处理。内核处理该数据包之后，将TX描述符放入completion queue里，表示处理完成。最后用户空间可以在Fill queue或TX队列里回收描述符。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png\" alt=\"image7-6\"></p>\n<p>一张很有启发意义的图：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png\" alt=\"unnamed1\"></p>\n<h2 id=\"5）AF-XDP代码详解\"><a href=\"#5）AF-XDP代码详解\" class=\"headerlink\" title=\"5）AF_XDP代码详解\"></a>5）AF_XDP代码详解</h2><ol>\n<li><p>分配和初始化UMEM</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_ring_prod</span> <span class=\"title\">fq</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_ring_cons</span> <span class=\"title\">cq</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> *buffer;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\"><span class=\"type\">void</span> *packet_buffer;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> packet_buffer_size = NUM_FRAMES * FRAME_SIZE;</span><br><span class=\"line\"><span class=\"comment\">// 进行内存对齐</span></span><br><span class=\"line\">posix_memalign(&amp;packet_buffer,</span><br><span class=\"line\">\t\t\t   getpagesize(), <span class=\"comment\">/* PAGE_SIZE aligned */</span></span><br><span class=\"line\">\t\t\t   packet_buffer_size)</span><br><span class=\"line\"><span class=\"comment\">// 初始化UMEM</span></span><br><span class=\"line\">umem = configure_xsk_umem(packet_buffer, packet_buffer_size);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// configure_xsk_umem 函数定义</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> xsk_umem_info *<span class=\"title function_\">configure_xsk_umem</span><span class=\"params\">(<span class=\"type\">void</span> *buffer, <span class=\"type\">uint64_t</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\">\t<span class=\"comment\">// 声明一块内存空间</span></span><br><span class=\"line\">\tumem = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(*umem));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!umem)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// 进行umeme创建</span></span><br><span class=\"line\">\tret = xsk_umem__create(&amp;umem-&gt;umem, buffer, size, &amp;umem-&gt;fq, &amp;umem-&gt;cq,</span><br><span class=\"line\">\t\t\t       <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret) &#123;</span><br><span class=\"line\">\t\terrno = -ret;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\tumem-&gt;buffer = buffer;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> umem;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>开启AF_XDP socket (xsk)</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk_socket</span>;</span></span><br><span class=\"line\">xsk_socket = xsk_configure_socket(umem);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 该函数写死了部分参数，实际使用应通过变量传入这些参数</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> xsk_socket_info *<span class=\"title function_\">xsk_configure_socket</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_umem_info *umem)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_config</span> <span class=\"title\">xsk_cfg</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk_info</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> idx;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> prog_id = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(*xsk_info));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!xsk_info)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info-&gt;umem = umem;</span><br><span class=\"line\">\txsk_cfg.rx_size = XSK_RING_CONS__DEFAULT_NUM_DESCS;</span><br><span class=\"line\">\txsk_cfg.tx_size = XSK_RING_PROD__DEFAULT_NUM_DESCS;</span><br><span class=\"line\">\txsk_cfg.libbpf_flags = <span class=\"number\">0</span>;</span><br><span class=\"line\">\txsk_cfg.xdp_flags = <span class=\"number\">0</span>; <span class=\"comment\">//***</span></span><br><span class=\"line\">\txsk_cfg.bind_flags = <span class=\"number\">0</span>; <span class=\"comment\">//***</span></span><br><span class=\"line\">\t<span class=\"comment\">/*!</span></span><br><span class=\"line\"><span class=\"comment\">\t* int xsk_socket__create(</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_socket **xsk,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  const char *ifname, </span></span><br><span class=\"line\"><span class=\"comment\">\t*   \t\t\t  __u32 queue_id,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_umem *umem,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_ring_cons *rx,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_ring_prod *tx,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  const struct xsk_socket_config *config);</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"comment\">// 指定将Af_XDP附加在veth-adv03网卡上</span></span><br><span class=\"line\">\tret = xsk_socket__create(&amp;xsk_info-&gt;xsk, <span class=\"string\">&quot;veth-adv03&quot;</span>,</span><br><span class=\"line\">\t\t\t\t <span class=\"number\">0</span>, umem-&gt;umem, &amp;xsk_info-&gt;rx,</span><br><span class=\"line\">\t\t\t\t &amp;xsk_info-&gt;tx, &amp;xsk_cfg);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\">\t</span><br><span class=\"line\">  <span class=\"comment\">// 判断是否创建成功</span></span><br><span class=\"line\">\t<span class=\"comment\">// ifindex ,prog_id, xdp_flags</span></span><br><span class=\"line\">\tret = bpf_get_link_xdp_id(<span class=\"number\">0</span>, &amp;prog_id, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Initialize umem frame allocation */</span></span><br><span class=\"line\">\t<span class=\"comment\">// 初始化UMEM</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NUM_FRAMES; i++)</span><br><span class=\"line\">\t\txsk_info-&gt;umem_frame_addr[i] = i * FRAME_SIZE;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info-&gt;umem_frame_free = NUM_FRAMES;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">/* Stuff the receive path with buffers, we assume we have enough */</span></span><br><span class=\"line\">  <span class=\"comment\">// 初始化RX队列</span></span><br><span class=\"line\">\tret = xsk_ring_prod__reserve(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t\t     XSK_RING_PROD__DEFAULT_NUM_DESCS,</span><br><span class=\"line\">\t\t\t\t     &amp;idx);</span><br><span class=\"line\">\t\t\t\t\t </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; XSK_RING_PROD__DEFAULT_NUM_DESCS; i ++)</span><br><span class=\"line\">\t\t*xsk_ring_prod__fill_addr(&amp;xsk_info-&gt;umem-&gt;fq, idx++) =</span><br><span class=\"line\">\t\t\txsk_alloc_umem_frame(xsk_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_ring_prod__submit(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t      XSK_RING_PROD__DEFAULT_NUM_DESCS);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> xsk_info;</span><br><span class=\"line\"></span><br><span class=\"line\">error_exit:</span><br><span class=\"line\">\terrno = -ret;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>定数输出xdp数据包数据</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">pthread_t</span> stats_poll_thread;</span><br><span class=\"line\"><span class=\"type\">int</span> ret = pthread_create(&amp;stats_poll_thread, <span class=\"literal\">NULL</span>, stats_poll,xsk_socket);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">bool</span> global_exit;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">stats_poll</span><span class=\"params\">(<span class=\"type\">void</span> *arg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> interval = <span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk</span> =</span> arg;</span><br><span class=\"line\">\t<span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stats_record</span> <span class=\"title\">previous_stats</span> =</span> &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprevious_stats.timestamp = gettime();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Trick to pretty printf with thousands separators use %&#x27; */</span></span><br><span class=\"line\">\tsetlocale(LC_NUMERIC, <span class=\"string\">&quot;en_US&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (!global_exit) &#123;</span><br><span class=\"line\">\t\tsleep(interval);</span><br><span class=\"line\">\t\txsk-&gt;stats.timestamp = gettime();</span><br><span class=\"line\">\t\tstats_print(&amp;xsk-&gt;stats, &amp;previous_stats);</span><br><span class=\"line\">\t\tprevious_stats = xsk-&gt;stats;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>从RX队列中poll数据，并进行处理（此章节未完成）</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rx_and_process(xsk_socket);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">rx_and_process</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk_socket)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> <span class=\"title\">fds</span>[2];</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> ret, nfds = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(fds, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(fds));</span><br><span class=\"line\">\tfds[<span class=\"number\">0</span>].fd = xsk_socket__fd(xsk_socket-&gt;xsk);</span><br><span class=\"line\">\tfds[<span class=\"number\">0</span>].events = POLLIN;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(!global_exit) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"string\">&quot;skb-mode&quot;</span>) &#123;</span><br><span class=\"line\">\t\t\tret = poll(fds, nfds, <span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (ret &lt;= <span class=\"number\">0</span> || ret &gt; <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\thandle_receive_packets(xsk_socket); <span class=\"comment\">//用户态处理xdp数据包核心函数</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">handle_receive_packets</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> rcvd, stock_frames, i;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> idx_rx = <span class=\"number\">0</span>, idx_fq = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\trcvd = xsk_ring_cons__peek(&amp;xsk-&gt;rx, RX_BATCH_SIZE, &amp;idx_rx);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!rcvd)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Stuff the ring with as much frames as possible */</span></span><br><span class=\"line\">\tstock_frames = xsk_prod_nb_free(&amp;xsk-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t\t\txsk_umem_free_frames(xsk));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (stock_frames &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, stock_frames,</span><br><span class=\"line\">\t\t\t\t\t     &amp;idx_fq);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* This should not happen, but just in case */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> (ret != stock_frames)</span><br><span class=\"line\">\t\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, rcvd,</span><br><span class=\"line\">\t\t\t\t\t\t     &amp;idx_fq);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stock_frames; i++)</span><br><span class=\"line\">\t\t\t*xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) =</span><br><span class=\"line\">\t\t\t\txsk_alloc_umem_frame(xsk);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq, stock_frames);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Process received packets */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; rcvd; i++) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> addr = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx)-&gt;addr;</span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> len = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++)-&gt;len;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!process_packet(xsk, addr, len))</span><br><span class=\"line\">\t\t\txsk_free_umem_frame(xsk, addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk-&gt;stats.rx_bytes += len;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_ring_cons__release(&amp;xsk-&gt;rx, rcvd);</span><br><span class=\"line\">\txsk-&gt;stats.rx_packets += rcvd;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Do we need to wake up the kernel for transmission */</span></span><br><span class=\"line\">\tcomplete_tx(xsk);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 处理数据包核心逻辑部分</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">bool</span> <span class=\"title function_\">process_packet</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t   <span class=\"type\">uint64_t</span> addr, <span class=\"type\">uint32_t</span> len)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *pkt = xsk_umem__get_data(xsk-&gt;umem-&gt;buffer, addr);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Lesson#3: Write an IPv6 ICMP ECHO parser to send responses</span></span><br><span class=\"line\"><span class=\"comment\">\t *</span></span><br><span class=\"line\"><span class=\"comment\">\t * Some assumptions to make it easier:</span></span><br><span class=\"line\"><span class=\"comment\">\t * - No VLAN handling</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Only if nexthdr is ICMP</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Just return all data with MAC/IP swapped, and type set to</span></span><br><span class=\"line\"><span class=\"comment\">\t *   ICMPV6_ECHO_REPLY</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Recalculate the icmp checksum */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> tx_idx = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> tmp_mac[ETH_ALEN];</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">in6_addr</span> <span class=\"title\">tmp_ip</span>;</span></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">ethhdr</span> *<span class=\"title\">eth</span> =</span> (<span class=\"keyword\">struct</span> ethhdr *) pkt;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">ipv6hdr</span> *<span class=\"title\">ipv6</span> =</span> (<span class=\"keyword\">struct</span> ipv6hdr *) (eth + <span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">icmp6hdr</span> *<span class=\"title\">icmp</span> =</span> (<span class=\"keyword\">struct</span> icmp6hdr *) (ipv6 + <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ntohs(eth-&gt;h_proto) != ETH_P_IPV6 ||</span><br><span class=\"line\">\t\t    len &lt; (<span class=\"keyword\">sizeof</span>(*eth) + <span class=\"keyword\">sizeof</span>(*ipv6) + <span class=\"keyword\">sizeof</span>(*icmp)) ||</span><br><span class=\"line\">\t\t    ipv6-&gt;nexthdr != IPPROTO_ICMPV6 ||</span><br><span class=\"line\">\t\t    icmp-&gt;icmp6_type != ICMPV6_ECHO_REQUEST)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(tmp_mac, eth-&gt;h_dest, ETH_ALEN);</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(eth-&gt;h_dest, eth-&gt;h_source, ETH_ALEN);</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(eth-&gt;h_source, tmp_mac, ETH_ALEN);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;tmp_ip, &amp;ipv6-&gt;saddr, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;ipv6-&gt;saddr, &amp;ipv6-&gt;daddr, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;ipv6-&gt;daddr, &amp;tmp_ip, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ticmp-&gt;icmp6_type = ICMPV6_ECHO_REPLY;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcsum_replace2(&amp;icmp-&gt;icmp6_cksum,</span><br><span class=\"line\">\t\t\t      htons(ICMPV6_ECHO_REQUEST &lt;&lt; <span class=\"number\">8</span>),</span><br><span class=\"line\">\t\t\t      htons(ICMPV6_ECHO_REPLY &lt;&lt; <span class=\"number\">8</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* Here we sent the packet out of the receive port. Note that</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * we allocate one entry and schedule it. Your design would be</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * faster if you do batch processing/transmission */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;tx, <span class=\"number\">1</span>, &amp;tx_idx);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ret != <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* No more transmit slots, drop the packet */</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;addr = addr;</span><br><span class=\"line\">\t\txsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;len = len;</span><br><span class=\"line\">\t\txsk_ring_prod__submit(&amp;xsk-&gt;tx, <span class=\"number\">1</span>);</span><br><span class=\"line\">\t\txsk-&gt;outstanding_tx++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk-&gt;stats.tx_bytes += len;</span><br><span class=\"line\">\t\txsk-&gt;stats.tx_packets++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>完整代码：</p>\n<p>在用户态输出xdp包数据，运行结果：</p>\n<p><img src=\"https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2023-02-25%2021.36.18.png?raw=true\" alt=\"截屏2023-02-25 21.36.18\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>官方教程地址（19年版本，有些旧，包依赖关系已经发生了变化）：<a href=\"https://github.com/xdp-project/xdp-tutorial\">https://github.com/xdp-project/xdp-tutorial</a></p>\n<p><strong>What is AF_XDP?</strong></p>\n<p>AF_XDP是一个为高性能数据包处理而优化的解决方案</p>\n<p>使用XDP程序中的XDP_REDIRECT动作，该程序可以使用bpf_redirect_map()函数将入帧重定向到其他支持XDP的netdev。AF_XDP socket使XDP程序能够将帧重定向到用户空间应用程序中的内存缓冲区，从而在用户态对数据包进行各种处理</p>\n<h2 id=\"1）XDP程序Easy-Example\"><a href=\"#1）XDP程序Easy-Example\" class=\"headerlink\" title=\"1）XDP程序Easy Example\"></a>1）XDP程序Easy Example</h2><p>下列程序可以用于在遭受DDos攻击时使用，作用是丢弃所有网络数据包(不要随意在实际网卡跑这个程序，当此程序加载成功的瞬间，ssh链接就会失效，然后就只能重启服务器了)：</p>\n<p>XDP内核程序，会被编译为.o文件</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/bpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">SEC(<span class=\"string\">&quot;xdp&quot;</span>)</span><br><span class=\"line\"><span class=\"type\">int</span>  <span class=\"title function_\">xdp_prog_simple</span><span class=\"params\">(<span class=\"keyword\">struct</span> xdp_md *ctx)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> XDP_DROP;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> _license[] SEC(<span class=\"string\">&quot;license&quot;</span>) = <span class=\"string\">&quot;GPL&quot;</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>加载XDP bpf模块的核心程序：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">xdp_link_attach</span><span class=\"params\">(<span class=\"type\">int</span> ifindex, __u32 xdp_flags, <span class=\"type\">int</span> prog_fd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">/* Next assignment this will move into ../common/ */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> err;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* libbpf provide the XDP net_device link-level hook attach helper */</span></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * 通过helper进行加载</span></span><br><span class=\"line\"><span class=\"comment\">   * ifindex 网卡设备编号</span></span><br><span class=\"line\"><span class=\"comment\">   * prog_fd bpf模块的fd</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, xdp_flags);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err == -EEXIST &amp;&amp; !(xdp_flags &amp; XDP_FLAGS_UPDATE_IF_NOEXIST)) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Force mode didn&#x27;t work, probably because a program of the</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * opposite type is loaded. Let&#x27;s unload that and try loading</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * again.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * 使用SKB_MODE进行加载</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t__u32 old_flags = xdp_flags;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txdp_flags &amp;= ~XDP_FLAGS_MODES;</span><br><span class=\"line\">\t\txdp_flags |= (old_flags &amp; XDP_FLAGS_SKB_MODE) ? XDP_FLAGS_DRV_MODE : XDP_FLAGS_SKB_MODE;</span><br><span class=\"line\">\t\terr = bpf_set_link_xdp_fd(ifindex, <span class=\"number\">-1</span>, xdp_flags);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!err)</span><br><span class=\"line\">\t\t\terr = bpf_set_link_xdp_fd(ifindex, prog_fd, old_flags);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 无法记载，do something</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> EXIT_OK;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在libbpf中，可以直接使用libbpf提供的加载工具函数进行加载。</p>\n<h2 id=\"2）XDP内核程序参数\"><a href=\"#2）XDP内核程序参数\" class=\"headerlink\" title=\"2）XDP内核程序参数\"></a>2）XDP内核程序参数</h2><h3 id=\"XDP输出参数：\"><a href=\"#XDP输出参数：\" class=\"headerlink\" title=\"XDP输出参数：\"></a>XDP输出参数：</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">xdp_action</span> &#123;</span></span><br><span class=\"line\">\tXDP_ABORTED = <span class=\"number\">0</span>, <span class=\"comment\">// Drop packet while raising an exception</span></span><br><span class=\"line\">\tXDP_DROP, <span class=\"comment\">//丢弃</span></span><br><span class=\"line\">\tXDP_PASS, <span class=\"comment\">//放行</span></span><br><span class=\"line\">\tXDP_TX,   <span class=\"comment\">//从同一网课返回该数据包</span></span><br><span class=\"line\">\tXDP_REDIRECT, <span class=\"comment\">//重定向，AF_XDP可以将数据包重定向到用户态，进行处理</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"XDP输入参数：\"><a href=\"#XDP输入参数：\" class=\"headerlink\" title=\"XDP输入参数：\"></a>XDP输入参数：</h3><p><strong>data</strong>和<strong>data_end</strong>字段分别是数据包开始和结束的指针，它们是用来获取和解析传来的数据，第三个值是<strong>data_meta</strong>指针，初始阶段它是一个空闲的内存地址，供XDP程序与其他层交换数据包元数据时使用。最后两个字段分别是接收数据包的接口和对应的RX队列的索引。当访问这两个值时，BPF代码会在内核内部重写，以访问实际持有这些值的内核结构<strong>struct xdp_rxq_info</strong>。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xdp_md</span> &#123;</span></span><br><span class=\"line\">\t__u32 data;</span><br><span class=\"line\">\t__u32 data_end;</span><br><span class=\"line\">\t__u32 data_meta;</span><br><span class=\"line\">\t<span class=\"comment\">// Below access go through struct xdp_rxq_info</span></span><br><span class=\"line\">\t__u32 ingress_ifindex; <span class=\"comment\">// rxq-&gt;dev-&gt;ifindex</span></span><br><span class=\"line\">\t__u32 rx_queue_index;  <span class=\"comment\">// rxq-&gt;queue_index</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3）Libbpf中使用AF-XDP\"><a href=\"#3）Libbpf中使用AF-XDP\" class=\"headerlink\" title=\"3）Libbpf中使用AF_XDP\"></a>3）Libbpf中使用AF_XDP</h2><p>由于现在libbpf已经停止了对AF_xdp socket(xsk)的直接支持，为了方便，直接在libpbf项目中手动引入XDP-TOOL，以获取xdp全部功能<br><a href=\"https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96\">https://github.com/libbpf/libbpf/commit/277846bc6c15b603c8fdfbd757700443c95a4a96</a><br>XDP tools: <a href=\"https://github.com/xdp-project/xdp-tools\">https://github.com/xdp-project/xdp-tools</a></p>\n<p>步骤如下：</p>\n<ol>\n<li><p>将xdp-tools包加入libbpf项目目录</p>\n</li>\n<li><p>修改makefile，对xdp-tools进行编译链接</p>\n <figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#加入编译xdp-tool的部分</span></span><br><span class=\"line\">XDPTOOL_SRC := <span class=\"variable\">$(<span class=\"built_in\">abspath</span> ../../xdp-tools)</span> <span class=\"comment\">#待编译文件</span></span><br><span class=\"line\">LIBXDP_SOURCES := <span class=\"variable\">$(<span class=\"built_in\">wildcard</span> <span class=\"variable\">$(XDPTOOL_SRC)</span>/lib/libxdp/libxdp*.[ch])</span> $(<span class=\"variable\">$(XDPTOOL_SRC)</span>/lib/libxdp/xsk.c)</span><br><span class=\"line\">XDPTOOL := <span class=\"variable\">$(<span class=\"built_in\">abspath</span> <span class=\"variable\">$(OUTPUT)</span>/libxdp.a)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$(XDPTOOL)</span>: <span class=\"variable\">$(LIBXDP_SOURCES)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(<span class=\"built_in\">call</span> msg,LIB,<span class=\"variable\">$@</span>)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(Q)</span><span class=\"variable\">$(MAKE)</span> -C <span class=\"variable\">$(XDPTOOL_SRC)</span> BUILD_STATIC_ONLY=1\t\\</span><br><span class=\"line\">\t\tOBJDIR=<span class=\"variable\">$(<span class=\"built_in\">dir</span> <span class=\"variable\">$@</span>)</span>/xdptool DESTDIR=<span class=\"variable\">$(<span class=\"built_in\">dir</span> <span class=\"variable\">$@</span>)</span>\t\t      \\</span><br><span class=\"line\">\t\tINCLUDEDIR= LIBDIR= UAPIDIR=\t\t\t      \\</span><br><span class=\"line\">\t\tlibxdp_install</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"comment\"># 最后生成可执行文件时，链接xdp-tool</span></span><br><span class=\"line\"><span class=\"variable\">$(APPS)</span>: %: <span class=\"variable\">$(OUTPUT)</span>/%.o <span class=\"variable\">$(XDPTOOL)</span> <span class=\"variable\">$(LIBBPF_OBJ)</span>| <span class=\"variable\">$(OUTPUT)</span>  </span><br><span class=\"line\">\t<span class=\"variable\">$(<span class=\"built_in\">call</span> msg,BINARY,<span class=\"variable\">$@</span>)</span></span><br><span class=\"line\">\t<span class=\"variable\">$(Q)</span><span class=\"variable\">$(CC)</span> <span class=\"variable\">$(CFLAGS)</span> <span class=\"variable\">$^</span> <span class=\"variable\">$(ALL_LDFLAGS)</span> -lpthread -lelf -lz -o <span class=\"variable\">$@</span></span><br></pre></td></tr></table></figure></li>\n<li><p>在用户态bpf程序中引入 #include &lt;xdp/xsk.h&gt;，后续即可使用AF_XDP的功能</p>\n</li>\n<li><p>利用Libbpf中的帮助函数attach xdp程序：</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取全部网卡信息的工具函数</span></span><br><span class=\"line\"><span class=\"comment\">// 参考此博客 https://blog.csdn.net/Rong_Toa/article/details/109118585</span></span><br><span class=\"line\"><span class=\"type\">int</span> ret = get_ifinfo(ifdisplay, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Attack bpf sec to all IF devs</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;ret;i++)&#123;</span><br><span class=\"line\">\tbpf_program__attach_xdp (skel-&gt;progs.xdp_prog, i);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to attach BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>经过测试，可以在pipe中看到XDP包的信息</p>\n<h2 id=\"4）利用AF-XDP将数据包redirect到用户态\"><a href=\"#4）利用AF-XDP将数据包redirect到用户态\" class=\"headerlink\" title=\"4）利用AF XDP将数据包redirect到用户态\"></a>4）利用AF XDP将数据包redirect到用户态</h2><h3 id=\"参考资料：\"><a href=\"#参考资料：\" class=\"headerlink\" title=\"参考资料：\"></a>参考资料：</h3><p><a href=\"https://www.kernel.org/doc/html/next/networking/af_xdp.html\">https://www.kernel.org/doc/html/next/networking/af_xdp.html</a><br><a href=\"https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/\">https://blog.cloudflare.com/a-story-about-af-xdp-network-namespaces-and-a-cookie/</a></p>\n<h3 id=\"AF-XDP用户态与内核交换数据包原理：\"><a href=\"#AF-XDP用户态与内核交换数据包原理：\" class=\"headerlink\" title=\"AF_XDP用户态与内核交换数据包原理：\"></a>AF_XDP用户态与内核交换数据包原理：</h3><p>AF_XDP在在用户和内核之间，声明了一块公共的内存区域：UMEM。xdp内核程序会将xdp数据包存储在UMEM里，<br>同时有四种ring：FILL, COMPLETION, RX , TX。内核将指向UMEM中数据包的指针放入RX queue里。供用户空间消费。同时用户态可以通过写入TX queue，将数据包传回内核处理。内核处理该数据包之后，将TX描述符放入completion queue里，表示处理完成。最后用户空间可以在Fill queue或TX队列里回收描述符。</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/image7-6.png\" alt=\"image7-6\"></p>\n<p>一张很有启发意义的图：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/unnamed1.png\" alt=\"unnamed1\"></p>\n<h2 id=\"5）AF-XDP代码详解\"><a href=\"#5）AF-XDP代码详解\" class=\"headerlink\" title=\"5）AF_XDP代码详解\"></a>5）AF_XDP代码详解</h2><ol>\n<li><p>分配和初始化UMEM</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_ring_prod</span> <span class=\"title\">fq</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_ring_cons</span> <span class=\"title\">cq</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> *buffer;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\"><span class=\"type\">void</span> *packet_buffer;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> packet_buffer_size = NUM_FRAMES * FRAME_SIZE;</span><br><span class=\"line\"><span class=\"comment\">// 进行内存对齐</span></span><br><span class=\"line\">posix_memalign(&amp;packet_buffer,</span><br><span class=\"line\">\t\t\t   getpagesize(), <span class=\"comment\">/* PAGE_SIZE aligned */</span></span><br><span class=\"line\">\t\t\t   packet_buffer_size)</span><br><span class=\"line\"><span class=\"comment\">// 初始化UMEM</span></span><br><span class=\"line\">umem = configure_xsk_umem(packet_buffer, packet_buffer_size);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// configure_xsk_umem 函数定义</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> xsk_umem_info *<span class=\"title function_\">configure_xsk_umem</span><span class=\"params\">(<span class=\"type\">void</span> *buffer, <span class=\"type\">uint64_t</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_umem_info</span> *<span class=\"title\">umem</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\">\t<span class=\"comment\">// 声明一块内存空间</span></span><br><span class=\"line\">\tumem = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(*umem));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!umem)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// 进行umeme创建</span></span><br><span class=\"line\">\tret = xsk_umem__create(&amp;umem-&gt;umem, buffer, size, &amp;umem-&gt;fq, &amp;umem-&gt;cq,</span><br><span class=\"line\">\t\t\t       <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret) &#123;</span><br><span class=\"line\">\t\terrno = -ret;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\tumem-&gt;buffer = buffer;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> umem;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li><p>开启AF_XDP socket (xsk)</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk_socket</span>;</span></span><br><span class=\"line\">xsk_socket = xsk_configure_socket(umem);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 该函数写死了部分参数，实际使用应通过变量传入这些参数</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> xsk_socket_info *<span class=\"title function_\">xsk_configure_socket</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_umem_info *umem)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_config</span> <span class=\"title\">xsk_cfg</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk_info</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> idx;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> prog_id = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(*xsk_info));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!xsk_info)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info-&gt;umem = umem;</span><br><span class=\"line\">\txsk_cfg.rx_size = XSK_RING_CONS__DEFAULT_NUM_DESCS;</span><br><span class=\"line\">\txsk_cfg.tx_size = XSK_RING_PROD__DEFAULT_NUM_DESCS;</span><br><span class=\"line\">\txsk_cfg.libbpf_flags = <span class=\"number\">0</span>;</span><br><span class=\"line\">\txsk_cfg.xdp_flags = <span class=\"number\">0</span>; <span class=\"comment\">//***</span></span><br><span class=\"line\">\txsk_cfg.bind_flags = <span class=\"number\">0</span>; <span class=\"comment\">//***</span></span><br><span class=\"line\">\t<span class=\"comment\">/*!</span></span><br><span class=\"line\"><span class=\"comment\">\t* int xsk_socket__create(</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_socket **xsk,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  const char *ifname, </span></span><br><span class=\"line\"><span class=\"comment\">\t*   \t\t\t  __u32 queue_id,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_umem *umem,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_ring_cons *rx,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  struct xsk_ring_prod *tx,</span></span><br><span class=\"line\"><span class=\"comment\">\t*\t\t\t\t  const struct xsk_socket_config *config);</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"comment\">// 指定将Af_XDP附加在veth-adv03网卡上</span></span><br><span class=\"line\">\tret = xsk_socket__create(&amp;xsk_info-&gt;xsk, <span class=\"string\">&quot;veth-adv03&quot;</span>,</span><br><span class=\"line\">\t\t\t\t <span class=\"number\">0</span>, umem-&gt;umem, &amp;xsk_info-&gt;rx,</span><br><span class=\"line\">\t\t\t\t &amp;xsk_info-&gt;tx, &amp;xsk_cfg);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\">\t</span><br><span class=\"line\">  <span class=\"comment\">// 判断是否创建成功</span></span><br><span class=\"line\">\t<span class=\"comment\">// ifindex ,prog_id, xdp_flags</span></span><br><span class=\"line\">\tret = bpf_get_link_xdp_id(<span class=\"number\">0</span>, &amp;prog_id, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Initialize umem frame allocation */</span></span><br><span class=\"line\">\t<span class=\"comment\">// 初始化UMEM</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NUM_FRAMES; i++)</span><br><span class=\"line\">\t\txsk_info-&gt;umem_frame_addr[i] = i * FRAME_SIZE;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_info-&gt;umem_frame_free = NUM_FRAMES;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">/* Stuff the receive path with buffers, we assume we have enough */</span></span><br><span class=\"line\">  <span class=\"comment\">// 初始化RX队列</span></span><br><span class=\"line\">\tret = xsk_ring_prod__reserve(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t\t     XSK_RING_PROD__DEFAULT_NUM_DESCS,</span><br><span class=\"line\">\t\t\t\t     &amp;idx);</span><br><span class=\"line\">\t\t\t\t\t </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> error_exit;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; XSK_RING_PROD__DEFAULT_NUM_DESCS; i ++)</span><br><span class=\"line\">\t\t*xsk_ring_prod__fill_addr(&amp;xsk_info-&gt;umem-&gt;fq, idx++) =</span><br><span class=\"line\">\t\t\txsk_alloc_umem_frame(xsk_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_ring_prod__submit(&amp;xsk_info-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t      XSK_RING_PROD__DEFAULT_NUM_DESCS);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> xsk_info;</span><br><span class=\"line\"></span><br><span class=\"line\">error_exit:</span><br><span class=\"line\">\terrno = -ret;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>定数输出xdp数据包数据</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">pthread_t</span> stats_poll_thread;</span><br><span class=\"line\"><span class=\"type\">int</span> ret = pthread_create(&amp;stats_poll_thread, <span class=\"literal\">NULL</span>, stats_poll,xsk_socket);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">bool</span> global_exit;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">stats_poll</span><span class=\"params\">(<span class=\"type\">void</span> *arg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> interval = <span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xsk_socket_info</span> *<span class=\"title\">xsk</span> =</span> arg;</span><br><span class=\"line\">\t<span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stats_record</span> <span class=\"title\">previous_stats</span> =</span> &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprevious_stats.timestamp = gettime();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Trick to pretty printf with thousands separators use %&#x27; */</span></span><br><span class=\"line\">\tsetlocale(LC_NUMERIC, <span class=\"string\">&quot;en_US&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (!global_exit) &#123;</span><br><span class=\"line\">\t\tsleep(interval);</span><br><span class=\"line\">\t\txsk-&gt;stats.timestamp = gettime();</span><br><span class=\"line\">\t\tstats_print(&amp;xsk-&gt;stats, &amp;previous_stats);</span><br><span class=\"line\">\t\tprevious_stats = xsk-&gt;stats;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>从RX队列中poll数据，并进行处理（此章节未完成）</p>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rx_and_process(xsk_socket);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">rx_and_process</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk_socket)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> <span class=\"title\">fds</span>[2];</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> ret, nfds = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(fds, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(fds));</span><br><span class=\"line\">\tfds[<span class=\"number\">0</span>].fd = xsk_socket__fd(xsk_socket-&gt;xsk);</span><br><span class=\"line\">\tfds[<span class=\"number\">0</span>].events = POLLIN;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(!global_exit) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"string\">&quot;skb-mode&quot;</span>) &#123;</span><br><span class=\"line\">\t\t\tret = poll(fds, nfds, <span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (ret &lt;= <span class=\"number\">0</span> || ret &gt; <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\thandle_receive_packets(xsk_socket); <span class=\"comment\">//用户态处理xdp数据包核心函数</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">handle_receive_packets</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> rcvd, stock_frames, i;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> idx_rx = <span class=\"number\">0</span>, idx_fq = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\trcvd = xsk_ring_cons__peek(&amp;xsk-&gt;rx, RX_BATCH_SIZE, &amp;idx_rx);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!rcvd)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Stuff the ring with as much frames as possible */</span></span><br><span class=\"line\">\tstock_frames = xsk_prod_nb_free(&amp;xsk-&gt;umem-&gt;fq,</span><br><span class=\"line\">\t\t\t\t\txsk_umem_free_frames(xsk));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (stock_frames &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, stock_frames,</span><br><span class=\"line\">\t\t\t\t\t     &amp;idx_fq);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* This should not happen, but just in case */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> (ret != stock_frames)</span><br><span class=\"line\">\t\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, rcvd,</span><br><span class=\"line\">\t\t\t\t\t\t     &amp;idx_fq);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; stock_frames; i++)</span><br><span class=\"line\">\t\t\t*xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) =</span><br><span class=\"line\">\t\t\t\txsk_alloc_umem_frame(xsk);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq, stock_frames);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Process received packets */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; rcvd; i++) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> addr = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx)-&gt;addr;</span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> len = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++)-&gt;len;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!process_packet(xsk, addr, len))</span><br><span class=\"line\">\t\t\txsk_free_umem_frame(xsk, addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk-&gt;stats.rx_bytes += len;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\txsk_ring_cons__release(&amp;xsk-&gt;rx, rcvd);</span><br><span class=\"line\">\txsk-&gt;stats.rx_packets += rcvd;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Do we need to wake up the kernel for transmission */</span></span><br><span class=\"line\">\tcomplete_tx(xsk);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 处理数据包核心逻辑部分</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">bool</span> <span class=\"title function_\">process_packet</span><span class=\"params\">(<span class=\"keyword\">struct</span> xsk_socket_info *xsk,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t   <span class=\"type\">uint64_t</span> addr, <span class=\"type\">uint32_t</span> len)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *pkt = xsk_umem__get_data(xsk-&gt;umem-&gt;buffer, addr);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Lesson#3: Write an IPv6 ICMP ECHO parser to send responses</span></span><br><span class=\"line\"><span class=\"comment\">\t *</span></span><br><span class=\"line\"><span class=\"comment\">\t * Some assumptions to make it easier:</span></span><br><span class=\"line\"><span class=\"comment\">\t * - No VLAN handling</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Only if nexthdr is ICMP</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Just return all data with MAC/IP swapped, and type set to</span></span><br><span class=\"line\"><span class=\"comment\">\t *   ICMPV6_ECHO_REPLY</span></span><br><span class=\"line\"><span class=\"comment\">\t * - Recalculate the icmp checksum */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> tx_idx = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> tmp_mac[ETH_ALEN];</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">in6_addr</span> <span class=\"title\">tmp_ip</span>;</span></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">ethhdr</span> *<span class=\"title\">eth</span> =</span> (<span class=\"keyword\">struct</span> ethhdr *) pkt;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">ipv6hdr</span> *<span class=\"title\">ipv6</span> =</span> (<span class=\"keyword\">struct</span> ipv6hdr *) (eth + <span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">icmp6hdr</span> *<span class=\"title\">icmp</span> =</span> (<span class=\"keyword\">struct</span> icmp6hdr *) (ipv6 + <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ntohs(eth-&gt;h_proto) != ETH_P_IPV6 ||</span><br><span class=\"line\">\t\t    len &lt; (<span class=\"keyword\">sizeof</span>(*eth) + <span class=\"keyword\">sizeof</span>(*ipv6) + <span class=\"keyword\">sizeof</span>(*icmp)) ||</span><br><span class=\"line\">\t\t    ipv6-&gt;nexthdr != IPPROTO_ICMPV6 ||</span><br><span class=\"line\">\t\t    icmp-&gt;icmp6_type != ICMPV6_ECHO_REQUEST)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(tmp_mac, eth-&gt;h_dest, ETH_ALEN);</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(eth-&gt;h_dest, eth-&gt;h_source, ETH_ALEN);</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(eth-&gt;h_source, tmp_mac, ETH_ALEN);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;tmp_ip, &amp;ipv6-&gt;saddr, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;ipv6-&gt;saddr, &amp;ipv6-&gt;daddr, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;ipv6-&gt;daddr, &amp;tmp_ip, <span class=\"keyword\">sizeof</span>(tmp_ip));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ticmp-&gt;icmp6_type = ICMPV6_ECHO_REPLY;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcsum_replace2(&amp;icmp-&gt;icmp6_cksum,</span><br><span class=\"line\">\t\t\t      htons(ICMPV6_ECHO_REQUEST &lt;&lt; <span class=\"number\">8</span>),</span><br><span class=\"line\">\t\t\t      htons(ICMPV6_ECHO_REPLY &lt;&lt; <span class=\"number\">8</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* Here we sent the packet out of the receive port. Note that</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * we allocate one entry and schedule it. Your design would be</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * faster if you do batch processing/transmission */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\tret = xsk_ring_prod__reserve(&amp;xsk-&gt;tx, <span class=\"number\">1</span>, &amp;tx_idx);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ret != <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* No more transmit slots, drop the packet */</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;addr = addr;</span><br><span class=\"line\">\t\txsk_ring_prod__tx_desc(&amp;xsk-&gt;tx, tx_idx)-&gt;len = len;</span><br><span class=\"line\">\t\txsk_ring_prod__submit(&amp;xsk-&gt;tx, <span class=\"number\">1</span>);</span><br><span class=\"line\">\t\txsk-&gt;outstanding_tx++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\txsk-&gt;stats.tx_bytes += len;</span><br><span class=\"line\">\t\txsk-&gt;stats.tx_packets++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>完整代码：</p>\n<p>在用户态输出xdp包数据，运行结果：</p>\n<p><img src=\"https://github.com/muchengl/pic_storage/blob/main/uPic/%E6%88%AA%E5%B1%8F2023-02-25%2021.36.18.png?raw=true\" alt=\"截屏2023-02-25 21.36.18\"></p>\n"},{"title":"eBPF学习-01","date":"2023-01-19T06:08:05.000Z","_content":"\n## Prepare\n\n安装eBPF教程（For ubuntu 18.04）：\nhttps://blog.csdn.net/qq_33344148/article/details/123255679\n\n在这里可以找到各个内核版本bcc的release，可以进行手工下载：\nhttps://github.com/iovisor/bcc/releases/\n\neBPF BCC：\nhttps://github.com/iovisor/bcc\n\nPy BCC开发教程：\n官方：https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md\n中文：https://blog.cyru1s.com/posts/ebpf-bcc.html\n\n## Example-01\n\n该代码对clone sys call进行追踪。\n\n```python\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n# define BPF program\nprog = \"\"\"\nint hello(void *ctx) {\n    bpf_trace_printk(\"Hello, World!\\\\n\");\n    return 0;\n}\n\"\"\"\n\n# load BPF program\nb = BPF(text=prog)\n# 添加探测点，追踪clone，可以添加多个探测点\nb.attach_kprobe(event=b.get_syscall_fnname(\"clone\"), fn_name=\"hello\")\n\n# header，表头\nprint(\"%-18s %-16s %-6s %s\" % (\"TIME(s)\", \"COMM\", \"PID\", \"MESSAGE\"))\n\n# format output\nwhile 1:\n    try:\n      \t# 从trace_pipe返回多个参数\n        (task, pid, cpu, flags, ts, msg) = b.trace_fields()\n    except ValueError:\n        continue\n    except KeyboardInterrupt:\n        exit()\n    printb(b\"%-18.9f %-16s %-6d %s\" % (ts, task, pid, msg))\n```\n\n## Example-02\n\n该代码用于连续执行sync指令时进行打印\n\n```py\nfrom __future__ import print_function\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n# load BPF program\nb = BPF(text=\"\"\"\n#include <uapi/linux/ptrace.h>\n\n// 创建一个名为 last 的 BPF hash 映射\nBPF_HASH(last);\n\nint do_trace(struct pt_regs *ctx) {\n    u64 ts, *tsp, delta, key = 0;\n\n    // attempt to read stored timestamp\n    // 读取存储的上一次时间戳\n    tsp = last.lookup(&key);\n    if (tsp != NULL) {\n        // 计算过了多久\n        delta = bpf_ktime_get_ns() - *tsp;\n        // 小于1秒\n        if (delta < 1000000000) {\n            // output if time is less than 1 second\n            bpf_trace_printk(\"%d\\\\n\", delta / 1000000);\n        }\n        last.delete(&key);\n    }\n\n    // update stored timestamp\n    // 更新时间戳\n    ts = bpf_ktime_get_ns();\n    last.update(&key, &ts);\n    return 0;\n}\n\"\"\")\n\nb.attach_kprobe(event=b.get_syscall_fnname(\"sync\"), fn_name=\"do_trace\")\nprint(\"Tracing for quick sync's... Ctrl-C to end\")\n\n# format output\nstart = 0\nwhile 1:\n    try:\n        # 从trace pipe中读取数据，只有有数据时才会读取，否则阻塞\n        (task, pid, cpu, flags, ts, ms) = b.trace_fields()\n        if start == 0:\n            start = ts\n        ts = ts - start\n        printb(b\"At time %.2f s: multiple syncs detected, last %s ms ago\" % (ts, ms))\n    except KeyboardInterrupt:\n        exit()\n\n```\n\n","source":"_posts/eBPF学习-01.md","raw":"---\ntitle: eBPF学习-01\ndate: 2023-01-19 14:08:05\ntags:\n---\n\n## Prepare\n\n安装eBPF教程（For ubuntu 18.04）：\nhttps://blog.csdn.net/qq_33344148/article/details/123255679\n\n在这里可以找到各个内核版本bcc的release，可以进行手工下载：\nhttps://github.com/iovisor/bcc/releases/\n\neBPF BCC：\nhttps://github.com/iovisor/bcc\n\nPy BCC开发教程：\n官方：https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md\n中文：https://blog.cyru1s.com/posts/ebpf-bcc.html\n\n## Example-01\n\n该代码对clone sys call进行追踪。\n\n```python\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n# define BPF program\nprog = \"\"\"\nint hello(void *ctx) {\n    bpf_trace_printk(\"Hello, World!\\\\n\");\n    return 0;\n}\n\"\"\"\n\n# load BPF program\nb = BPF(text=prog)\n# 添加探测点，追踪clone，可以添加多个探测点\nb.attach_kprobe(event=b.get_syscall_fnname(\"clone\"), fn_name=\"hello\")\n\n# header，表头\nprint(\"%-18s %-16s %-6s %s\" % (\"TIME(s)\", \"COMM\", \"PID\", \"MESSAGE\"))\n\n# format output\nwhile 1:\n    try:\n      \t# 从trace_pipe返回多个参数\n        (task, pid, cpu, flags, ts, msg) = b.trace_fields()\n    except ValueError:\n        continue\n    except KeyboardInterrupt:\n        exit()\n    printb(b\"%-18.9f %-16s %-6d %s\" % (ts, task, pid, msg))\n```\n\n## Example-02\n\n该代码用于连续执行sync指令时进行打印\n\n```py\nfrom __future__ import print_function\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n# load BPF program\nb = BPF(text=\"\"\"\n#include <uapi/linux/ptrace.h>\n\n// 创建一个名为 last 的 BPF hash 映射\nBPF_HASH(last);\n\nint do_trace(struct pt_regs *ctx) {\n    u64 ts, *tsp, delta, key = 0;\n\n    // attempt to read stored timestamp\n    // 读取存储的上一次时间戳\n    tsp = last.lookup(&key);\n    if (tsp != NULL) {\n        // 计算过了多久\n        delta = bpf_ktime_get_ns() - *tsp;\n        // 小于1秒\n        if (delta < 1000000000) {\n            // output if time is less than 1 second\n            bpf_trace_printk(\"%d\\\\n\", delta / 1000000);\n        }\n        last.delete(&key);\n    }\n\n    // update stored timestamp\n    // 更新时间戳\n    ts = bpf_ktime_get_ns();\n    last.update(&key, &ts);\n    return 0;\n}\n\"\"\")\n\nb.attach_kprobe(event=b.get_syscall_fnname(\"sync\"), fn_name=\"do_trace\")\nprint(\"Tracing for quick sync's... Ctrl-C to end\")\n\n# format output\nstart = 0\nwhile 1:\n    try:\n        # 从trace pipe中读取数据，只有有数据时才会读取，否则阻塞\n        (task, pid, cpu, flags, ts, ms) = b.trace_fields()\n        if start == 0:\n            start = ts\n        ts = ts - start\n        printb(b\"At time %.2f s: multiple syncs detected, last %s ms ago\" % (ts, ms))\n    except KeyboardInterrupt:\n        exit()\n\n```\n\n","slug":"eBPF学习-01","published":1,"updated":"2023-01-30T07:14:37.226Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa5000zb9c90f92am1y","content":"<h2 id=\"Prepare\"><a href=\"#Prepare\" class=\"headerlink\" title=\"Prepare\"></a>Prepare</h2><p>安装eBPF教程（For ubuntu 18.04）：<br><a href=\"https://blog.csdn.net/qq_33344148/article/details/123255679\">https://blog.csdn.net/qq_33344148/article/details/123255679</a></p>\n<p>在这里可以找到各个内核版本bcc的release，可以进行手工下载：<br><a href=\"https://github.com/iovisor/bcc/releases/\">https://github.com/iovisor/bcc/releases/</a></p>\n<p>eBPF BCC：<br><a href=\"https://github.com/iovisor/bcc\">https://github.com/iovisor/bcc</a></p>\n<p>Py BCC开发教程：<br>官方：<a href=\"https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md\">https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md</a><br>中文：<a href=\"https://blog.cyru1s.com/posts/ebpf-bcc.html\">https://blog.cyru1s.com/posts/ebpf-bcc.html</a></p>\n<h2 id=\"Example-01\"><a href=\"#Example-01\" class=\"headerlink\" title=\"Example-01\"></a>Example-01</h2><p>该代码对clone sys call进行追踪。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> bcc <span class=\"keyword\">import</span> BPF</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc.utils <span class=\"keyword\">import</span> printb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># define BPF program</span></span><br><span class=\"line\">prog = <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">int hello(void *ctx) &#123;</span></span><br><span class=\"line\"><span class=\"string\">    bpf_trace_printk(&quot;Hello, World!\\\\n&quot;);</span></span><br><span class=\"line\"><span class=\"string\">    return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># load BPF program</span></span><br><span class=\"line\">b = BPF(text=prog)</span><br><span class=\"line\"><span class=\"comment\"># 添加探测点，追踪clone，可以添加多个探测点</span></span><br><span class=\"line\">b.attach_kprobe(event=b.get_syscall_fnname(<span class=\"string\">&quot;clone&quot;</span>), fn_name=<span class=\"string\">&quot;hello&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># header，表头</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;%-18s %-16s %-6s %s&quot;</span> % (<span class=\"string\">&quot;TIME(s)&quot;</span>, <span class=\"string\">&quot;COMM&quot;</span>, <span class=\"string\">&quot;PID&quot;</span>, <span class=\"string\">&quot;MESSAGE&quot;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># format output</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">      \t<span class=\"comment\"># 从trace_pipe返回多个参数</span></span><br><span class=\"line\">        (task, pid, cpu, flags, ts, msg) = b.trace_fields()</span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        exit()</span><br><span class=\"line\">    printb(<span class=\"string\">b&quot;%-18.9f %-16s %-6d %s&quot;</span> % (ts, task, pid, msg))</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Example-02\"><a href=\"#Example-02\" class=\"headerlink\" title=\"Example-02\"></a>Example-02</h2><p>该代码用于连续执行sync指令时进行打印</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> print_function</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc <span class=\"keyword\">import</span> BPF</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc.utils <span class=\"keyword\">import</span> printb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># load BPF program</span></span><br><span class=\"line\">b = BPF(text=<span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">// 创建一个名为 last 的 BPF hash 映射</span></span><br><span class=\"line\"><span class=\"string\">BPF_HASH(last);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">int do_trace(struct pt_regs *ctx) &#123;</span></span><br><span class=\"line\"><span class=\"string\">    u64 ts, *tsp, delta, key = 0;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    // attempt to read stored timestamp</span></span><br><span class=\"line\"><span class=\"string\">    // 读取存储的上一次时间戳</span></span><br><span class=\"line\"><span class=\"string\">    tsp = last.lookup(&amp;key);</span></span><br><span class=\"line\"><span class=\"string\">    if (tsp != NULL) &#123;</span></span><br><span class=\"line\"><span class=\"string\">        // 计算过了多久</span></span><br><span class=\"line\"><span class=\"string\">        delta = bpf_ktime_get_ns() - *tsp;</span></span><br><span class=\"line\"><span class=\"string\">        // 小于1秒</span></span><br><span class=\"line\"><span class=\"string\">        if (delta &lt; 1000000000) &#123;</span></span><br><span class=\"line\"><span class=\"string\">            // output if time is less than 1 second</span></span><br><span class=\"line\"><span class=\"string\">            bpf_trace_printk(&quot;%d\\\\n&quot;, delta / 1000000);</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">        last.delete(&amp;key);</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    // update stored timestamp</span></span><br><span class=\"line\"><span class=\"string\">    // 更新时间戳</span></span><br><span class=\"line\"><span class=\"string\">    ts = bpf_ktime_get_ns();</span></span><br><span class=\"line\"><span class=\"string\">    last.update(&amp;key, &amp;ts);</span></span><br><span class=\"line\"><span class=\"string\">    return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">b.attach_kprobe(event=b.get_syscall_fnname(<span class=\"string\">&quot;sync&quot;</span>), fn_name=<span class=\"string\">&quot;do_trace&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;Tracing for quick sync&#x27;s... Ctrl-C to end&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># format output</span></span><br><span class=\"line\">start = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"comment\"># 从trace pipe中读取数据，只有有数据时才会读取，否则阻塞</span></span><br><span class=\"line\">        (task, pid, cpu, flags, ts, ms) = b.trace_fields()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> start == <span class=\"number\">0</span>:</span><br><span class=\"line\">            start = ts</span><br><span class=\"line\">        ts = ts - start</span><br><span class=\"line\">        printb(<span class=\"string\">b&quot;At time %.2f s: multiple syncs detected, last %s ms ago&quot;</span> % (ts, ms))</span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        exit()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Prepare\"><a href=\"#Prepare\" class=\"headerlink\" title=\"Prepare\"></a>Prepare</h2><p>安装eBPF教程（For ubuntu 18.04）：<br><a href=\"https://blog.csdn.net/qq_33344148/article/details/123255679\">https://blog.csdn.net/qq_33344148/article/details/123255679</a></p>\n<p>在这里可以找到各个内核版本bcc的release，可以进行手工下载：<br><a href=\"https://github.com/iovisor/bcc/releases/\">https://github.com/iovisor/bcc/releases/</a></p>\n<p>eBPF BCC：<br><a href=\"https://github.com/iovisor/bcc\">https://github.com/iovisor/bcc</a></p>\n<p>Py BCC开发教程：<br>官方：<a href=\"https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md\">https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md</a><br>中文：<a href=\"https://blog.cyru1s.com/posts/ebpf-bcc.html\">https://blog.cyru1s.com/posts/ebpf-bcc.html</a></p>\n<h2 id=\"Example-01\"><a href=\"#Example-01\" class=\"headerlink\" title=\"Example-01\"></a>Example-01</h2><p>该代码对clone sys call进行追踪。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> bcc <span class=\"keyword\">import</span> BPF</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc.utils <span class=\"keyword\">import</span> printb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># define BPF program</span></span><br><span class=\"line\">prog = <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">int hello(void *ctx) &#123;</span></span><br><span class=\"line\"><span class=\"string\">    bpf_trace_printk(&quot;Hello, World!\\\\n&quot;);</span></span><br><span class=\"line\"><span class=\"string\">    return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># load BPF program</span></span><br><span class=\"line\">b = BPF(text=prog)</span><br><span class=\"line\"><span class=\"comment\"># 添加探测点，追踪clone，可以添加多个探测点</span></span><br><span class=\"line\">b.attach_kprobe(event=b.get_syscall_fnname(<span class=\"string\">&quot;clone&quot;</span>), fn_name=<span class=\"string\">&quot;hello&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># header，表头</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;%-18s %-16s %-6s %s&quot;</span> % (<span class=\"string\">&quot;TIME(s)&quot;</span>, <span class=\"string\">&quot;COMM&quot;</span>, <span class=\"string\">&quot;PID&quot;</span>, <span class=\"string\">&quot;MESSAGE&quot;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># format output</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">      \t<span class=\"comment\"># 从trace_pipe返回多个参数</span></span><br><span class=\"line\">        (task, pid, cpu, flags, ts, msg) = b.trace_fields()</span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        exit()</span><br><span class=\"line\">    printb(<span class=\"string\">b&quot;%-18.9f %-16s %-6d %s&quot;</span> % (ts, task, pid, msg))</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Example-02\"><a href=\"#Example-02\" class=\"headerlink\" title=\"Example-02\"></a>Example-02</h2><p>该代码用于连续执行sync指令时进行打印</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> print_function</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc <span class=\"keyword\">import</span> BPF</span><br><span class=\"line\"><span class=\"keyword\">from</span> bcc.utils <span class=\"keyword\">import</span> printb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># load BPF program</span></span><br><span class=\"line\">b = BPF(text=<span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">// 创建一个名为 last 的 BPF hash 映射</span></span><br><span class=\"line\"><span class=\"string\">BPF_HASH(last);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">int do_trace(struct pt_regs *ctx) &#123;</span></span><br><span class=\"line\"><span class=\"string\">    u64 ts, *tsp, delta, key = 0;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    // attempt to read stored timestamp</span></span><br><span class=\"line\"><span class=\"string\">    // 读取存储的上一次时间戳</span></span><br><span class=\"line\"><span class=\"string\">    tsp = last.lookup(&amp;key);</span></span><br><span class=\"line\"><span class=\"string\">    if (tsp != NULL) &#123;</span></span><br><span class=\"line\"><span class=\"string\">        // 计算过了多久</span></span><br><span class=\"line\"><span class=\"string\">        delta = bpf_ktime_get_ns() - *tsp;</span></span><br><span class=\"line\"><span class=\"string\">        // 小于1秒</span></span><br><span class=\"line\"><span class=\"string\">        if (delta &lt; 1000000000) &#123;</span></span><br><span class=\"line\"><span class=\"string\">            // output if time is less than 1 second</span></span><br><span class=\"line\"><span class=\"string\">            bpf_trace_printk(&quot;%d\\\\n&quot;, delta / 1000000);</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">        last.delete(&amp;key);</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    // update stored timestamp</span></span><br><span class=\"line\"><span class=\"string\">    // 更新时间戳</span></span><br><span class=\"line\"><span class=\"string\">    ts = bpf_ktime_get_ns();</span></span><br><span class=\"line\"><span class=\"string\">    last.update(&amp;key, &amp;ts);</span></span><br><span class=\"line\"><span class=\"string\">    return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">b.attach_kprobe(event=b.get_syscall_fnname(<span class=\"string\">&quot;sync&quot;</span>), fn_name=<span class=\"string\">&quot;do_trace&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;Tracing for quick sync&#x27;s... Ctrl-C to end&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># format output</span></span><br><span class=\"line\">start = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"comment\"># 从trace pipe中读取数据，只有有数据时才会读取，否则阻塞</span></span><br><span class=\"line\">        (task, pid, cpu, flags, ts, ms) = b.trace_fields()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> start == <span class=\"number\">0</span>:</span><br><span class=\"line\">            start = ts</span><br><span class=\"line\">        ts = ts - start</span><br><span class=\"line\">        printb(<span class=\"string\">b&quot;At time %.2f s: multiple syncs detected, last %s ms ago&quot;</span> % (ts, ms))</span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        exit()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n"},{"title":"lc1237  Find Positive Integer Solution for a Given Equation","date":"2023-02-18T06:13:59.000Z","_content":"\n## Question\n\nGiven a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.\n\nWhile the exact formula is hidden, the function is monotonically increasing, i.e.:\n\nf(x, y) < f(x + 1, y)\nf(x, y) < f(x, y + 1)\nThe function interface is defined like this:\n\n```\ninterface CustomFunction {\npublic:\n  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.\n  int f(int x, int y);\n};\n```\n\n\nWe will judge your solution as follows:\n\nThe judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.\nThe judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.\nThe judge will call your findSolution and compare your results with the answer key.\nIf your results match the answer key, your solution will be Accepted.\n\n```\nExample 1:\nInput: function_id = 1, z = 5\nOutput: [[1,4],[2,3],[3,2],[4,1]]\nExplanation: The hidden formula for function_id = 1 is f(x, y) = x + y.\nThe following positive integer values of x and y make f(x, y) equal to 5:\nx=1, y=4 -> f(1, 4) = 1 + 4 = 5.\nx=2, y=3 -> f(2, 3) = 2 + 3 = 5.\nx=3, y=2 -> f(3, 2) = 3 + 2 = 5.\nx=4, y=1 -> f(4, 1) = 4 + 1 = 5.\n\nExample 2:\nInput: function_id = 2, z = 5\nOutput: [[1,5],[5,1]]\nExplanation: The hidden formula for function_id = 2 is f(x, y) = x * y.\nThe following positive integer values of x and y make f(x, y) equal to 5:\nx=1, y=5 -> f(1, 5) = 1 * 5 = 5.\nx=5, y=1 -> f(5, 1) = 5 * 1 = 5.\n```\n\n\n\n## Solution 01\n\nSo, can i call the funtion f like this?\ncustomfunction.f(x,y);\n\nOk, the z ranges from 1 to 100. And x and y range from 1 to 1000.\nSo. That's not a huge amount of data.\n\nThe easy idea it to try each xy pairs. I need try a million time to get all pairs. \n\nConsidering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.\n\n```java\nclass Solution {\n    public List<List<Integer>> findSolution(CustomFunction customfunction, int z) {\n        // customfunction.f(x,y);\n        // z ranges from 1 to 100\n        // 1 <= x, y <= 1000\n\n        // the easy idea is try each x and y to get all pairs.\n        // I only need to try a million times to get all answer\n        // Let's consider that f is an increasing function. so i can do it by multiplying\n\n        // for each x, Use the dichotomy to find y\n        List<List<Integer>> ans=new ArrayList<>();\n\n        for(int x=1;x<1000;x++){ // trying all possible x\n            int l=1,r=1000;\n            while(l<=r){ // for each x, using dichotomy to find the target y.\n                int mid=(l+r)/2;\n                if(customfunction.f(x,mid)==z){\n                    List<Integer> item=new ArrayList<>();\n                    item.add(x);\n                    item.add(mid);\n                    ans.add(item);\n                    break;\n                }\n                else if(customfunction.f(x,mid)>z) r=mid-1;\n                else l=mid+1;\n            }\n\n        }\n        return ans;\n    }\n}\n```\n\n## solution 02\n\n// x=500 y=100;  f's return value is  z.\n// And than, x goes up to 501.\n// x=501 y!=100-1000\n// Beacuse function f is increasing. So y can't be a bigger number than 100.\n// Based on this idea, i can reduce the time complexity to O(x+y)\n\n```java\nclass Solution {\n     public List<List<Integer>> findSolution(CustomFunction customfunction, int z) {\n        List<List<Integer>> res = new ArrayList<List<Integer>>();\n        int y=1000; // I'm defining y here as the maximum 1000\n        for (int x = 1; x <= 1000 && y >= 1; x++) { // trying each x, and keep y bigger than 1\n            while (y >= 1 && customfunction.f(x, y) > z) {  // Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)>z\n                y--;\n            }\n          // At this time, judge whether f(x,y) equals z;\n          // if it's true,add this pair the ans list.\n            if (y >= 1 && customfunction.f(x, y) == z) {\n                List<Integer> pair = new ArrayList<Integer>();\n                pair.add(x);\n                pair.add(y);\n                res.add(pair);\n            }\n        }\n        return res;\n    }\n\n}\n```\n\n\n\n\n\n\n","source":"_posts/lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation.md","raw":"---\ntitle: lc1237  Find Positive Integer Solution for a Given Equation\ndate: 2023-02-18 14:13:59\ntags:\n---\n\n## Question\n\nGiven a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.\n\nWhile the exact formula is hidden, the function is monotonically increasing, i.e.:\n\nf(x, y) < f(x + 1, y)\nf(x, y) < f(x, y + 1)\nThe function interface is defined like this:\n\n```\ninterface CustomFunction {\npublic:\n  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.\n  int f(int x, int y);\n};\n```\n\n\nWe will judge your solution as follows:\n\nThe judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.\nThe judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.\nThe judge will call your findSolution and compare your results with the answer key.\nIf your results match the answer key, your solution will be Accepted.\n\n```\nExample 1:\nInput: function_id = 1, z = 5\nOutput: [[1,4],[2,3],[3,2],[4,1]]\nExplanation: The hidden formula for function_id = 1 is f(x, y) = x + y.\nThe following positive integer values of x and y make f(x, y) equal to 5:\nx=1, y=4 -> f(1, 4) = 1 + 4 = 5.\nx=2, y=3 -> f(2, 3) = 2 + 3 = 5.\nx=3, y=2 -> f(3, 2) = 3 + 2 = 5.\nx=4, y=1 -> f(4, 1) = 4 + 1 = 5.\n\nExample 2:\nInput: function_id = 2, z = 5\nOutput: [[1,5],[5,1]]\nExplanation: The hidden formula for function_id = 2 is f(x, y) = x * y.\nThe following positive integer values of x and y make f(x, y) equal to 5:\nx=1, y=5 -> f(1, 5) = 1 * 5 = 5.\nx=5, y=1 -> f(5, 1) = 5 * 1 = 5.\n```\n\n\n\n## Solution 01\n\nSo, can i call the funtion f like this?\ncustomfunction.f(x,y);\n\nOk, the z ranges from 1 to 100. And x and y range from 1 to 1000.\nSo. That's not a huge amount of data.\n\nThe easy idea it to try each xy pairs. I need try a million time to get all pairs. \n\nConsidering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.\n\n```java\nclass Solution {\n    public List<List<Integer>> findSolution(CustomFunction customfunction, int z) {\n        // customfunction.f(x,y);\n        // z ranges from 1 to 100\n        // 1 <= x, y <= 1000\n\n        // the easy idea is try each x and y to get all pairs.\n        // I only need to try a million times to get all answer\n        // Let's consider that f is an increasing function. so i can do it by multiplying\n\n        // for each x, Use the dichotomy to find y\n        List<List<Integer>> ans=new ArrayList<>();\n\n        for(int x=1;x<1000;x++){ // trying all possible x\n            int l=1,r=1000;\n            while(l<=r){ // for each x, using dichotomy to find the target y.\n                int mid=(l+r)/2;\n                if(customfunction.f(x,mid)==z){\n                    List<Integer> item=new ArrayList<>();\n                    item.add(x);\n                    item.add(mid);\n                    ans.add(item);\n                    break;\n                }\n                else if(customfunction.f(x,mid)>z) r=mid-1;\n                else l=mid+1;\n            }\n\n        }\n        return ans;\n    }\n}\n```\n\n## solution 02\n\n// x=500 y=100;  f's return value is  z.\n// And than, x goes up to 501.\n// x=501 y!=100-1000\n// Beacuse function f is increasing. So y can't be a bigger number than 100.\n// Based on this idea, i can reduce the time complexity to O(x+y)\n\n```java\nclass Solution {\n     public List<List<Integer>> findSolution(CustomFunction customfunction, int z) {\n        List<List<Integer>> res = new ArrayList<List<Integer>>();\n        int y=1000; // I'm defining y here as the maximum 1000\n        for (int x = 1; x <= 1000 && y >= 1; x++) { // trying each x, and keep y bigger than 1\n            while (y >= 1 && customfunction.f(x, y) > z) {  // Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)>z\n                y--;\n            }\n          // At this time, judge whether f(x,y) equals z;\n          // if it's true,add this pair the ans list.\n            if (y >= 1 && customfunction.f(x, y) == z) {\n                List<Integer> pair = new ArrayList<Integer>();\n                pair.add(x);\n                pair.add(y);\n                res.add(pair);\n            }\n        }\n        return res;\n    }\n\n}\n```\n\n\n\n\n\n\n","slug":"lc1237-Find-Positive-Integer-Solution-for-a-Given-Equation","published":1,"updated":"2023-02-18T07:06:57.660Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa60010b9c9gbq43zjb","content":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>Given a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.</p>\n<p>While the exact formula is hidden, the function is monotonically increasing, i.e.:</p>\n<p>f(x, y) &lt; f(x + 1, y)<br>f(x, y) &lt; f(x, y + 1)<br>The function interface is defined like this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">interface CustomFunction &#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.</span><br><span class=\"line\">  int f(int x, int y);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n\n<p>We will judge your solution as follows:</p>\n<p>The judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.<br>The judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.<br>The judge will call your findSolution and compare your results with the answer key.<br>If your results match the answer key, your solution will be Accepted.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: function_id = 1, z = 5</span><br><span class=\"line\">Output: [[1,4],[2,3],[3,2],[4,1]]</span><br><span class=\"line\">Explanation: The hidden formula for function_id = 1 is f(x, y) = x + y.</span><br><span class=\"line\">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class=\"line\">x=1, y=4 -&gt; f(1, 4) = 1 + 4 = 5.</span><br><span class=\"line\">x=2, y=3 -&gt; f(2, 3) = 2 + 3 = 5.</span><br><span class=\"line\">x=3, y=2 -&gt; f(3, 2) = 3 + 2 = 5.</span><br><span class=\"line\">x=4, y=1 -&gt; f(4, 1) = 4 + 1 = 5.</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: function_id = 2, z = 5</span><br><span class=\"line\">Output: [[1,5],[5,1]]</span><br><span class=\"line\">Explanation: The hidden formula for function_id = 2 is f(x, y) = x * y.</span><br><span class=\"line\">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class=\"line\">x=1, y=5 -&gt; f(1, 5) = 1 * 5 = 5.</span><br><span class=\"line\">x=5, y=1 -&gt; f(5, 1) = 5 * 1 = 5.</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution-01\"><a href=\"#Solution-01\" class=\"headerlink\" title=\"Solution 01\"></a>Solution 01</h2><p>So, can i call the funtion f like this?<br>customfunction.f(x,y);</p>\n<p>Ok, the z ranges from 1 to 100. And x and y range from 1 to 1000.<br>So. That’s not a huge amount of data.</p>\n<p>The easy idea it to try each xy pairs. I need try a million time to get all pairs. </p>\n<p>Considering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">findSolution</span><span class=\"params\">(CustomFunction customfunction, <span class=\"type\">int</span> z)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// customfunction.f(x,y);</span></span><br><span class=\"line\">        <span class=\"comment\">// z ranges from 1 to 100</span></span><br><span class=\"line\">        <span class=\"comment\">// 1 &lt;= x, y &lt;= 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// the easy idea is try each x and y to get all pairs.</span></span><br><span class=\"line\">        <span class=\"comment\">// I only need to try a million times to get all answer</span></span><br><span class=\"line\">        <span class=\"comment\">// Let&#x27;s consider that f is an increasing function. so i can do it by multiplying</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// for each x, Use the dichotomy to find y</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; ans=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">1</span>;x&lt;<span class=\"number\">1000</span>;x++)&#123; <span class=\"comment\">// trying all possible x</span></span><br><span class=\"line\">            <span class=\"type\">int</span> l=<span class=\"number\">1</span>,r=<span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"keyword\">while</span>(l&lt;=r)&#123; <span class=\"comment\">// for each x, using dichotomy to find the target y.</span></span><br><span class=\"line\">                <span class=\"type\">int</span> mid=(l+r)/<span class=\"number\">2</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(customfunction.f(x,mid)==z)&#123;</span><br><span class=\"line\">                    List&lt;Integer&gt; item=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">                    item.add(x);</span><br><span class=\"line\">                    item.add(mid);</span><br><span class=\"line\">                    ans.add(item);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(customfunction.f(x,mid)&gt;z) r=mid-<span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> l=mid+<span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"solution-02\"><a href=\"#solution-02\" class=\"headerlink\" title=\"solution 02\"></a>solution 02</h2><p>// x=500 y=100;  f’s return value is  z.<br>// And than, x goes up to 501.<br>// x=501 y!=100-1000<br>// Beacuse function f is increasing. So y can’t be a bigger number than 100.<br>// Based on this idea, i can reduce the time complexity to O(x+y)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">     <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">findSolution</span><span class=\"params\">(CustomFunction customfunction, <span class=\"type\">int</span> z)</span> &#123;</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\">        <span class=\"type\">int</span> y=<span class=\"number\">1000</span>; <span class=\"comment\">// I&#x27;m defining y here as the maximum 1000</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">x</span> <span class=\"operator\">=</span> <span class=\"number\">1</span>; x &lt;= <span class=\"number\">1000</span> &amp;&amp; y &gt;= <span class=\"number\">1</span>; x++) &#123; <span class=\"comment\">// trying each x, and keep y bigger than 1</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (y &gt;= <span class=\"number\">1</span> &amp;&amp; customfunction.f(x, y) &gt; z) &#123;  <span class=\"comment\">// Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)&gt;z</span></span><br><span class=\"line\">                y--;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          <span class=\"comment\">// At this time, judge whether f(x,y) equals z;</span></span><br><span class=\"line\">          <span class=\"comment\">// if it&#x27;s true,add this pair the ans list.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (y &gt;= <span class=\"number\">1</span> &amp;&amp; customfunction.f(x, y) == z) &#123;</span><br><span class=\"line\">                List&lt;Integer&gt; pair = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">                pair.add(x);</span><br><span class=\"line\">                pair.add(y);</span><br><span class=\"line\">                res.add(pair);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>Given a callable function f(x, y) with a hidden formula and a value z, reverse engineer the formula and return all positive integer pairs x and y where f(x,y) == z. You may return the pairs in any order.</p>\n<p>While the exact formula is hidden, the function is monotonically increasing, i.e.:</p>\n<p>f(x, y) &lt; f(x + 1, y)<br>f(x, y) &lt; f(x, y + 1)<br>The function interface is defined like this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">interface CustomFunction &#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">  // Returns some positive integer f(x, y) for two positive integers x and y based on a formula.</span><br><span class=\"line\">  int f(int x, int y);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n\n<p>We will judge your solution as follows:</p>\n<p>The judge has a list of 9 hidden implementations of CustomFunction, along with a way to generate an answer key of all valid pairs for a specific z.<br>The judge will receive two inputs: a function_id (to determine which implementation to test your code with), and the target z.<br>The judge will call your findSolution and compare your results with the answer key.<br>If your results match the answer key, your solution will be Accepted.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: function_id = 1, z = 5</span><br><span class=\"line\">Output: [[1,4],[2,3],[3,2],[4,1]]</span><br><span class=\"line\">Explanation: The hidden formula for function_id = 1 is f(x, y) = x + y.</span><br><span class=\"line\">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class=\"line\">x=1, y=4 -&gt; f(1, 4) = 1 + 4 = 5.</span><br><span class=\"line\">x=2, y=3 -&gt; f(2, 3) = 2 + 3 = 5.</span><br><span class=\"line\">x=3, y=2 -&gt; f(3, 2) = 3 + 2 = 5.</span><br><span class=\"line\">x=4, y=1 -&gt; f(4, 1) = 4 + 1 = 5.</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: function_id = 2, z = 5</span><br><span class=\"line\">Output: [[1,5],[5,1]]</span><br><span class=\"line\">Explanation: The hidden formula for function_id = 2 is f(x, y) = x * y.</span><br><span class=\"line\">The following positive integer values of x and y make f(x, y) equal to 5:</span><br><span class=\"line\">x=1, y=5 -&gt; f(1, 5) = 1 * 5 = 5.</span><br><span class=\"line\">x=5, y=1 -&gt; f(5, 1) = 5 * 1 = 5.</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution-01\"><a href=\"#Solution-01\" class=\"headerlink\" title=\"Solution 01\"></a>Solution 01</h2><p>So, can i call the funtion f like this?<br>customfunction.f(x,y);</p>\n<p>Ok, the z ranges from 1 to 100. And x and y range from 1 to 1000.<br>So. That’s not a huge amount of data.</p>\n<p>The easy idea it to try each xy pairs. I need try a million time to get all pairs. </p>\n<p>Considering that  f is a incresing function for both x and y. I think i can use the dichotomy to find pairs. The time complexity of this solution is O(x log(y)); x times log y.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">findSolution</span><span class=\"params\">(CustomFunction customfunction, <span class=\"type\">int</span> z)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// customfunction.f(x,y);</span></span><br><span class=\"line\">        <span class=\"comment\">// z ranges from 1 to 100</span></span><br><span class=\"line\">        <span class=\"comment\">// 1 &lt;= x, y &lt;= 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// the easy idea is try each x and y to get all pairs.</span></span><br><span class=\"line\">        <span class=\"comment\">// I only need to try a million times to get all answer</span></span><br><span class=\"line\">        <span class=\"comment\">// Let&#x27;s consider that f is an increasing function. so i can do it by multiplying</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// for each x, Use the dichotomy to find y</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; ans=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">1</span>;x&lt;<span class=\"number\">1000</span>;x++)&#123; <span class=\"comment\">// trying all possible x</span></span><br><span class=\"line\">            <span class=\"type\">int</span> l=<span class=\"number\">1</span>,r=<span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"keyword\">while</span>(l&lt;=r)&#123; <span class=\"comment\">// for each x, using dichotomy to find the target y.</span></span><br><span class=\"line\">                <span class=\"type\">int</span> mid=(l+r)/<span class=\"number\">2</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(customfunction.f(x,mid)==z)&#123;</span><br><span class=\"line\">                    List&lt;Integer&gt; item=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">                    item.add(x);</span><br><span class=\"line\">                    item.add(mid);</span><br><span class=\"line\">                    ans.add(item);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(customfunction.f(x,mid)&gt;z) r=mid-<span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> l=mid+<span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"solution-02\"><a href=\"#solution-02\" class=\"headerlink\" title=\"solution 02\"></a>solution 02</h2><p>// x=500 y=100;  f’s return value is  z.<br>// And than, x goes up to 501.<br>// x=501 y!=100-1000<br>// Beacuse function f is increasing. So y can’t be a bigger number than 100.<br>// Based on this idea, i can reduce the time complexity to O(x+y)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">     <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">findSolution</span><span class=\"params\">(CustomFunction customfunction, <span class=\"type\">int</span> z)</span> &#123;</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\">        <span class=\"type\">int</span> y=<span class=\"number\">1000</span>; <span class=\"comment\">// I&#x27;m defining y here as the maximum 1000</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">x</span> <span class=\"operator\">=</span> <span class=\"number\">1</span>; x &lt;= <span class=\"number\">1000</span> &amp;&amp; y &gt;= <span class=\"number\">1</span>; x++) &#123; <span class=\"comment\">// trying each x, and keep y bigger than 1</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (y &gt;= <span class=\"number\">1</span> &amp;&amp; customfunction.f(x, y) &gt; z) &#123;  <span class=\"comment\">// Keep decreasing y to find the pair. In order to avoid pair nonexistence, y keeps decreasing to 1. I use the Judgment condition f(x,y)&gt;z</span></span><br><span class=\"line\">                y--;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          <span class=\"comment\">// At this time, judge whether f(x,y) equals z;</span></span><br><span class=\"line\">          <span class=\"comment\">// if it&#x27;s true,add this pair the ans list.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (y &gt;= <span class=\"number\">1</span> &amp;&amp; customfunction.f(x, y) == z) &#123;</span><br><span class=\"line\">                List&lt;Integer&gt; pair = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">                pair.add(x);</span><br><span class=\"line\">                pair.add(y);</span><br><span class=\"line\">                res.add(pair);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n"},{"title":"lc 1234 - Sliding window","date":"2023-02-13T07:05:27.000Z","_content":"\n## Puzzle\n\nYou are given a string s of length n containing only four kinds of characters: 'Q', 'W', 'E', and 'R'.\n\nA string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.\n\nReturn the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.\n\n```\nInput: s = \"QWER\"\nOutput: 0\nExplanation: s is already balanced.\n\nInput: s = \"QQWE\"\nOutput: 1\nExplanation: We need to replace a 'Q' to 'R', so that \"RQWE\" (or \"QRWE\") is balanced.\n\nInput: s = \"QQQW\"\nOutput: 2\nExplanation: We can replace the first \"QQ\" to \"ER\". \n```\n\n## My Answer\n\n### Idea1 (fault)\n\n// For each string, I can replace the entire string to solve the problem\n// But that doesn't satisfy the problem that i need to find the minimum Length of the subString\n// Assume the following：\n// xxxx 【sub string】 xxxx\n// For the strings on both sides, the balance has been reached\n\n// so i only need to  rplace the 【sub string】, the section.\n// it no need for me to know how to replace it ,or which kinds of characters in the 【sub string】\n// So now the question becomes, how do you find a【sub string】which can keep two sides strings balanced. \n\n```\n// dp[i][j] = true / false\n// dp[0][n-1] =true\n// dp[i][j]= true (  dp[i-2][j+2]==true && s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )\n// dp[i][j]= false \n```\n\nHowever, the time complexity of this answer is o(n^2). And this state transition equation doesn't work.\n\n## Idea2\n\nActually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to string's length/4. So , what i need to do is keep the num of each character in both side of the sub string less than string's length divided by 4.  As long as it's less than a quarter, I can complete the missing part in the sub string.\n\n```java\n   public boolean check(int[] con,int qtr){\n        if(con['Q'-'A']<=qtr && con['W'-'A']<=qtr && con['E'-'A']<=qtr && con['R'-'A']<=qtr) return true;\n        return false;\n    }\n```\n\nTo find the minimum sub string, i can maintain a array to storage each character's number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun window's size.\n\n````java\n public int balancedString(String s) {\n\n        int[] con=new int[26]; // QWER\n        for(int i=0;i<s.length();i++){\n            con[s.charAt(i)-'A']++;\n        }\n        int ans=s.length();\n        int qtr=s.length()/4;\n\n        int r=0,l=0;\n\n        //if(check(con,qtr)) return 0;\n\n        for(r=0;r<s.length();r++){\n            con[s.charAt(r)-'A']--;\n\n            while(l<s.length() && check(con,qtr)){\n            \n                ans=Math.min(ans,r-l+1);\n                //System.out.println(r+\" \"+l);\n                l++;\n                con[s.charAt(l-1)-'A']++;\n            }\n            \n        }\n        \n        return ans;\n}\n````\n\n\n\n\n\n","source":"_posts/lc-1234-Sliding-window.md","raw":"---\ntitle: lc 1234 - Sliding window\ndate: 2023-02-13 15:05:27\ntags:\n---\n\n## Puzzle\n\nYou are given a string s of length n containing only four kinds of characters: 'Q', 'W', 'E', and 'R'.\n\nA string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.\n\nReturn the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.\n\n```\nInput: s = \"QWER\"\nOutput: 0\nExplanation: s is already balanced.\n\nInput: s = \"QQWE\"\nOutput: 1\nExplanation: We need to replace a 'Q' to 'R', so that \"RQWE\" (or \"QRWE\") is balanced.\n\nInput: s = \"QQQW\"\nOutput: 2\nExplanation: We can replace the first \"QQ\" to \"ER\". \n```\n\n## My Answer\n\n### Idea1 (fault)\n\n// For each string, I can replace the entire string to solve the problem\n// But that doesn't satisfy the problem that i need to find the minimum Length of the subString\n// Assume the following：\n// xxxx 【sub string】 xxxx\n// For the strings on both sides, the balance has been reached\n\n// so i only need to  rplace the 【sub string】, the section.\n// it no need for me to know how to replace it ,or which kinds of characters in the 【sub string】\n// So now the question becomes, how do you find a【sub string】which can keep two sides strings balanced. \n\n```\n// dp[i][j] = true / false\n// dp[0][n-1] =true\n// dp[i][j]= true (  dp[i-2][j+2]==true && s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )\n// dp[i][j]= false \n```\n\nHowever, the time complexity of this answer is o(n^2). And this state transition equation doesn't work.\n\n## Idea2\n\nActually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to string's length/4. So , what i need to do is keep the num of each character in both side of the sub string less than string's length divided by 4.  As long as it's less than a quarter, I can complete the missing part in the sub string.\n\n```java\n   public boolean check(int[] con,int qtr){\n        if(con['Q'-'A']<=qtr && con['W'-'A']<=qtr && con['E'-'A']<=qtr && con['R'-'A']<=qtr) return true;\n        return false;\n    }\n```\n\nTo find the minimum sub string, i can maintain a array to storage each character's number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun window's size.\n\n````java\n public int balancedString(String s) {\n\n        int[] con=new int[26]; // QWER\n        for(int i=0;i<s.length();i++){\n            con[s.charAt(i)-'A']++;\n        }\n        int ans=s.length();\n        int qtr=s.length()/4;\n\n        int r=0,l=0;\n\n        //if(check(con,qtr)) return 0;\n\n        for(r=0;r<s.length();r++){\n            con[s.charAt(r)-'A']--;\n\n            while(l<s.length() && check(con,qtr)){\n            \n                ans=Math.min(ans,r-l+1);\n                //System.out.println(r+\" \"+l);\n                l++;\n                con[s.charAt(l-1)-'A']++;\n            }\n            \n        }\n        \n        return ans;\n}\n````\n\n\n\n\n\n","slug":"lc-1234-Sliding-window","published":1,"updated":"2023-02-13T07:30:01.704Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa60012b9c96snmajwj","content":"<h2 id=\"Puzzle\"><a href=\"#Puzzle\" class=\"headerlink\" title=\"Puzzle\"></a>Puzzle</h2><p>You are given a string s of length n containing only four kinds of characters: ‘Q’, ‘W’, ‘E’, and ‘R’.</p>\n<p>A string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.</p>\n<p>Return the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: s = &quot;QWER&quot;</span><br><span class=\"line\">Output: 0</span><br><span class=\"line\">Explanation: s is already balanced.</span><br><span class=\"line\"></span><br><span class=\"line\">Input: s = &quot;QQWE&quot;</span><br><span class=\"line\">Output: 1</span><br><span class=\"line\">Explanation: We need to replace a &#x27;Q&#x27; to &#x27;R&#x27;, so that &quot;RQWE&quot; (or &quot;QRWE&quot;) is balanced.</span><br><span class=\"line\"></span><br><span class=\"line\">Input: s = &quot;QQQW&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: We can replace the first &quot;QQ&quot; to &quot;ER&quot;. </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"My-Answer\"><a href=\"#My-Answer\" class=\"headerlink\" title=\"My Answer\"></a>My Answer</h2><h3 id=\"Idea1-fault\"><a href=\"#Idea1-fault\" class=\"headerlink\" title=\"Idea1 (fault)\"></a>Idea1 (fault)</h3><p>// For each string, I can replace the entire string to solve the problem<br>// But that doesn’t satisfy the problem that i need to find the minimum Length of the subString<br>// Assume the following：<br>// xxxx 【sub string】 xxxx<br>// For the strings on both sides, the balance has been reached</p>\n<p>// so i only need to  rplace the 【sub string】, the section.<br>// it no need for me to know how to replace it ,or which kinds of characters in the 【sub string】<br>// So now the question becomes, how do you find a【sub string】which can keep two sides strings balanced. </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// dp[i][j] = true / false</span><br><span class=\"line\">// dp[0][n-1] =true</span><br><span class=\"line\">// dp[i][j]= true (  dp[i-2][j+2]==true &amp;&amp; s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )</span><br><span class=\"line\">// dp[i][j]= false </span><br></pre></td></tr></table></figure>\n\n<p>However, the time complexity of this answer is o(n^2). And this state transition equation doesn’t work.</p>\n<h2 id=\"Idea2\"><a href=\"#Idea2\" class=\"headerlink\" title=\"Idea2\"></a>Idea2</h2><p>Actually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to string’s length/4. So , what i need to do is keep the num of each character in both side of the sub string less than string’s length divided by 4.  As long as it’s less than a quarter, I can complete the missing part in the sub string.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">int</span>[] con,<span class=\"type\">int</span> qtr)</span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span>(con[<span class=\"string\">&#x27;Q&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;W&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;E&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;R&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>To find the minimum sub string, i can maintain a array to storage each character’s number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun window’s size.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">balancedString</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] con=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[<span class=\"number\">26</span>]; <span class=\"comment\">// QWER</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            con[s.charAt(i)-<span class=\"string\">&#x27;A&#x27;</span>]++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> ans=s.length();</span><br><span class=\"line\">        <span class=\"type\">int</span> qtr=s.length()/<span class=\"number\">4</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> r=<span class=\"number\">0</span>,l=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//if(check(con,qtr)) return 0;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(r=<span class=\"number\">0</span>;r&lt;s.length();r++)&#123;</span><br><span class=\"line\">            con[s.charAt(r)-<span class=\"string\">&#x27;A&#x27;</span>]--;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(l&lt;s.length() &amp;&amp; check(con,qtr))&#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">                ans=Math.min(ans,r-l+<span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"comment\">//System.out.println(r+&quot; &quot;+l);</span></span><br><span class=\"line\">                l++;</span><br><span class=\"line\">                con[s.charAt(l-<span class=\"number\">1</span>)-<span class=\"string\">&#x27;A&#x27;</span>]++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Puzzle\"><a href=\"#Puzzle\" class=\"headerlink\" title=\"Puzzle\"></a>Puzzle</h2><p>You are given a string s of length n containing only four kinds of characters: ‘Q’, ‘W’, ‘E’, and ‘R’.</p>\n<p>A string is said to be balanced if each of its characters appears n / 4 times where n is the length of the string.</p>\n<p>Return the minimum length of the substring that can be replaced with any other string of the same length to make s balanced. If s is already balanced, return 0.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: s = &quot;QWER&quot;</span><br><span class=\"line\">Output: 0</span><br><span class=\"line\">Explanation: s is already balanced.</span><br><span class=\"line\"></span><br><span class=\"line\">Input: s = &quot;QQWE&quot;</span><br><span class=\"line\">Output: 1</span><br><span class=\"line\">Explanation: We need to replace a &#x27;Q&#x27; to &#x27;R&#x27;, so that &quot;RQWE&quot; (or &quot;QRWE&quot;) is balanced.</span><br><span class=\"line\"></span><br><span class=\"line\">Input: s = &quot;QQQW&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: We can replace the first &quot;QQ&quot; to &quot;ER&quot;. </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"My-Answer\"><a href=\"#My-Answer\" class=\"headerlink\" title=\"My Answer\"></a>My Answer</h2><h3 id=\"Idea1-fault\"><a href=\"#Idea1-fault\" class=\"headerlink\" title=\"Idea1 (fault)\"></a>Idea1 (fault)</h3><p>// For each string, I can replace the entire string to solve the problem<br>// But that doesn’t satisfy the problem that i need to find the minimum Length of the subString<br>// Assume the following：<br>// xxxx 【sub string】 xxxx<br>// For the strings on both sides, the balance has been reached</p>\n<p>// so i only need to  rplace the 【sub string】, the section.<br>// it no need for me to know how to replace it ,or which kinds of characters in the 【sub string】<br>// So now the question becomes, how do you find a【sub string】which can keep two sides strings balanced. </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// dp[i][j] = true / false</span><br><span class=\"line\">// dp[0][n-1] =true</span><br><span class=\"line\">// dp[i][j]= true (  dp[i-2][j+2]==true &amp;&amp; s[i-1]+s[i-2]+s[j+1]+s[j+2]==Q+W+E+R )</span><br><span class=\"line\">// dp[i][j]= false </span><br></pre></td></tr></table></figure>\n\n<p>However, the time complexity of this answer is o(n^2). And this state transition equation doesn’t work.</p>\n<h2 id=\"Idea2\"><a href=\"#Idea2\" class=\"headerlink\" title=\"Idea2\"></a>Idea2</h2><p>Actually, it is no need to keep both side of sub string to be balanced. To keep the string balanced, the numer of each character in the string should equal to string’s length/4. So , what i need to do is keep the num of each character in both side of the sub string less than string’s length divided by 4.  As long as it’s less than a quarter, I can complete the missing part in the sub string.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">int</span>[] con,<span class=\"type\">int</span> qtr)</span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span>(con[<span class=\"string\">&#x27;Q&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;W&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;E&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr &amp;&amp; con[<span class=\"string\">&#x27;R&#x27;</span>-<span class=\"string\">&#x27;A&#x27;</span>]&lt;=qtr) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>To find the minimum sub string, i can maintain a array to storage each character’s number. Usering to points to r,l to form a sliding window. The point r keep growing until the check return true. And than, point l begins to grow until the check return false. When l is growing, constantly update the size of the sliding window. The answer of this question is minimun window’s size.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">balancedString</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] con=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[<span class=\"number\">26</span>]; <span class=\"comment\">// QWER</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            con[s.charAt(i)-<span class=\"string\">&#x27;A&#x27;</span>]++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> ans=s.length();</span><br><span class=\"line\">        <span class=\"type\">int</span> qtr=s.length()/<span class=\"number\">4</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> r=<span class=\"number\">0</span>,l=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//if(check(con,qtr)) return 0;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(r=<span class=\"number\">0</span>;r&lt;s.length();r++)&#123;</span><br><span class=\"line\">            con[s.charAt(r)-<span class=\"string\">&#x27;A&#x27;</span>]--;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(l&lt;s.length() &amp;&amp; check(con,qtr))&#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">                ans=Math.min(ans,r-l+<span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"comment\">//System.out.println(r+&quot; &quot;+l);</span></span><br><span class=\"line\">                l++;</span><br><span class=\"line\">                con[s.charAt(l-<span class=\"number\">1</span>)-<span class=\"string\">&#x27;A&#x27;</span>]++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n"},{"title":"lc1139 Largest 1-Bordered Square","date":"2023-02-17T09:35:42.000Z","_content":"\nGiven a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesn't exist in the grid.\n\n ```\n Example 1:\n Input: grid = [[1,1,1],[1,0,1],[1,1,1]]\n Output: 9\n \n Example 2:\n Input: grid = [[1,1,0,0]]\n Output: 1\n ```\n\n\n\nThe easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ：\n\n1. storage the number of consecutive ones in the direction of vertical and horizontal for each points.\n\n2. Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.\n\n    ```\n    i use a array con[i][j][0] and con[i][j][1].\n    \n    con[i][j][0] 1 -\n    con[i][j][1] 1 |\n    \n    *---*\n    |   |\n    |   |\n    |   |\n    *---P\n    try 3\n    if con[i-2][j][0]>=3 && con[i][j-2][1]>=3 \n    \tthe square can be formed；\n    \tUpdate the area of the largest rectangle；\n    ```\n\n    \n\n\n\n```\nclass Solution {\n    public int largest1BorderedSquare(int[][] grid) {\n\n        // con[i][j][0] number of 1 in the direction of y\n        // The number of consecutive ones in the vertical direction\n        // con[i][j][1] number of 1 in the direction of x\n        // The number of consecutive ones in the horizontal direction\n\n        int m=grid.length,n=grid[0].length;\n\n        int[][][] con=new int[m][n][2];\n\n        for(int i=0;i<m;i++){\n            for(int j=0;j<n;j++){\n                if(grid[i][j]==1){\n                    if(i>0) con[i][j][1]=con[i-1][j][1]+1;\n                    else con[i][j][1]=1;\n                    if(j>0) con[i][j][0]=con[i][j-1][0]+1;\n                    else con[i][j][0]=1;\n                }\n            }\n        }\n\n        //System.out.println(con[2][2][0]+\" \"+con[2][2][1]);\n        //System.out.println(con[2][0][0]+\" \"+con[2][0][1]);\n        //System.out.println(con[0][2][0]+\" \"+con[0][2][1]);\n\n        int ans=0;\n        for(int i=0;i<m;i++){\n            for(int j=0;j<n;j++){\n                // I need to go through the length of the edge from the largest to the smallest\n                for(int k=Math.min(con[i][j][0],con[i][j][1]);k>0;k--){\n                    \n                    // *---k\n                    // ｜   |\n                    // ｜.  |\n                    // ｜.  |\n                    // k---p\n                    if(con[i-k+1][j][0]>=k && con[i][j-k+1][1]>=k){\n                        ans=Math.max(ans,k*k);\n                        //System.out.println(i+\" \"+j+\" \"+k+\" \"+);\n                        break;\n                    }\n                }\n            }\n        }\n\n        return ans;\n\n\n\n    }\n}\n\n```\n\n","source":"_posts/lc1139-Largest-1-Bordered-Square.md","raw":"---\ntitle: lc1139 Largest 1-Bordered Square\ndate: 2023-02-17 17:35:42\ntags:\n---\n\nGiven a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesn't exist in the grid.\n\n ```\n Example 1:\n Input: grid = [[1,1,1],[1,0,1],[1,1,1]]\n Output: 9\n \n Example 2:\n Input: grid = [[1,1,0,0]]\n Output: 1\n ```\n\n\n\nThe easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ：\n\n1. storage the number of consecutive ones in the direction of vertical and horizontal for each points.\n\n2. Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.\n\n    ```\n    i use a array con[i][j][0] and con[i][j][1].\n    \n    con[i][j][0] 1 -\n    con[i][j][1] 1 |\n    \n    *---*\n    |   |\n    |   |\n    |   |\n    *---P\n    try 3\n    if con[i-2][j][0]>=3 && con[i][j-2][1]>=3 \n    \tthe square can be formed；\n    \tUpdate the area of the largest rectangle；\n    ```\n\n    \n\n\n\n```\nclass Solution {\n    public int largest1BorderedSquare(int[][] grid) {\n\n        // con[i][j][0] number of 1 in the direction of y\n        // The number of consecutive ones in the vertical direction\n        // con[i][j][1] number of 1 in the direction of x\n        // The number of consecutive ones in the horizontal direction\n\n        int m=grid.length,n=grid[0].length;\n\n        int[][][] con=new int[m][n][2];\n\n        for(int i=0;i<m;i++){\n            for(int j=0;j<n;j++){\n                if(grid[i][j]==1){\n                    if(i>0) con[i][j][1]=con[i-1][j][1]+1;\n                    else con[i][j][1]=1;\n                    if(j>0) con[i][j][0]=con[i][j-1][0]+1;\n                    else con[i][j][0]=1;\n                }\n            }\n        }\n\n        //System.out.println(con[2][2][0]+\" \"+con[2][2][1]);\n        //System.out.println(con[2][0][0]+\" \"+con[2][0][1]);\n        //System.out.println(con[0][2][0]+\" \"+con[0][2][1]);\n\n        int ans=0;\n        for(int i=0;i<m;i++){\n            for(int j=0;j<n;j++){\n                // I need to go through the length of the edge from the largest to the smallest\n                for(int k=Math.min(con[i][j][0],con[i][j][1]);k>0;k--){\n                    \n                    // *---k\n                    // ｜   |\n                    // ｜.  |\n                    // ｜.  |\n                    // k---p\n                    if(con[i-k+1][j][0]>=k && con[i][j-k+1][1]>=k){\n                        ans=Math.max(ans,k*k);\n                        //System.out.println(i+\" \"+j+\" \"+k+\" \"+);\n                        break;\n                    }\n                }\n            }\n        }\n\n        return ans;\n\n\n\n    }\n}\n\n```\n\n","slug":"lc1139-Largest-1-Bordered-Square","published":1,"updated":"2023-02-17T09:52:34.119Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa70013b9c9dds221vy","content":"<p>Given a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesn’t exist in the grid.</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: grid = [[1,1,1],[1,0,1],[1,1,1]]</span><br><span class=\"line\">Output: 9</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: grid = [[1,1,0,0]]</span><br><span class=\"line\">Output: 1</span><br></pre></td></tr></table></figure>\n\n\n\n<p>The easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ：</p>\n<ol>\n<li><p>storage the number of consecutive ones in the direction of vertical and horizontal for each points.</p>\n</li>\n<li><p>Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">i use a array con[i][j][0] and con[i][j][1].</span><br><span class=\"line\"></span><br><span class=\"line\">con[i][j][0] 1 -</span><br><span class=\"line\">con[i][j][1] 1 |</span><br><span class=\"line\"></span><br><span class=\"line\">*---*</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   |</span><br><span class=\"line\">*---P</span><br><span class=\"line\">try 3</span><br><span class=\"line\">if con[i-2][j][0]&gt;=3 &amp;&amp; con[i][j-2][1]&gt;=3 </span><br><span class=\"line\">\tthe square can be formed；</span><br><span class=\"line\">\tUpdate the area of the largest rectangle；</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Solution &#123;</span><br><span class=\"line\">    public int largest1BorderedSquare(int[][] grid) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        // con[i][j][0] number of 1 in the direction of y</span><br><span class=\"line\">        // The number of consecutive ones in the vertical direction</span><br><span class=\"line\">        // con[i][j][1] number of 1 in the direction of x</span><br><span class=\"line\">        // The number of consecutive ones in the horizontal direction</span><br><span class=\"line\"></span><br><span class=\"line\">        int m=grid.length,n=grid[0].length;</span><br><span class=\"line\"></span><br><span class=\"line\">        int[][][] con=new int[m][n][2];</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class=\"line\">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class=\"line\">                if(grid[i][j]==1)&#123;</span><br><span class=\"line\">                    if(i&gt;0) con[i][j][1]=con[i-1][j][1]+1;</span><br><span class=\"line\">                    else con[i][j][1]=1;</span><br><span class=\"line\">                    if(j&gt;0) con[i][j][0]=con[i][j-1][0]+1;</span><br><span class=\"line\">                    else con[i][j][0]=1;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        //System.out.println(con[2][2][0]+&quot; &quot;+con[2][2][1]);</span><br><span class=\"line\">        //System.out.println(con[2][0][0]+&quot; &quot;+con[2][0][1]);</span><br><span class=\"line\">        //System.out.println(con[0][2][0]+&quot; &quot;+con[0][2][1]);</span><br><span class=\"line\"></span><br><span class=\"line\">        int ans=0;</span><br><span class=\"line\">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class=\"line\">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class=\"line\">                // I need to go through the length of the edge from the largest to the smallest</span><br><span class=\"line\">                for(int k=Math.min(con[i][j][0],con[i][j][1]);k&gt;0;k--)&#123;</span><br><span class=\"line\">                    </span><br><span class=\"line\">                    // *---k</span><br><span class=\"line\">                    // ｜   |</span><br><span class=\"line\">                    // ｜.  |</span><br><span class=\"line\">                    // ｜.  |</span><br><span class=\"line\">                    // k---p</span><br><span class=\"line\">                    if(con[i-k+1][j][0]&gt;=k &amp;&amp; con[i][j-k+1][1]&gt;=k)&#123;</span><br><span class=\"line\">                        ans=Math.max(ans,k*k);</span><br><span class=\"line\">                        //System.out.println(i+&quot; &quot;+j+&quot; &quot;+k+&quot; &quot;+);</span><br><span class=\"line\">                        break;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return ans;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<p>Given a 2D grid of 0s and 1s, return the number of elements in the largest square subgrid that has all 1s on its border, or 0 if such a subgrid doesn’t exist in the grid.</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: grid = [[1,1,1],[1,0,1],[1,1,1]]</span><br><span class=\"line\">Output: 9</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: grid = [[1,1,0,0]]</span><br><span class=\"line\">Output: 1</span><br></pre></td></tr></table></figure>\n\n\n\n<p>The easy idea is search from each point, and try each possible length of edge. But this idea need count the number of ones over and over again. So i think i can ：</p>\n<ol>\n<li><p>storage the number of consecutive ones in the direction of vertical and horizontal for each points.</p>\n</li>\n<li><p>Than i need to search from each point. At this time, I can judge whether a square can be formed by storaged date.</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">i use a array con[i][j][0] and con[i][j][1].</span><br><span class=\"line\"></span><br><span class=\"line\">con[i][j][0] 1 -</span><br><span class=\"line\">con[i][j][1] 1 |</span><br><span class=\"line\"></span><br><span class=\"line\">*---*</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   |</span><br><span class=\"line\">*---P</span><br><span class=\"line\">try 3</span><br><span class=\"line\">if con[i-2][j][0]&gt;=3 &amp;&amp; con[i][j-2][1]&gt;=3 </span><br><span class=\"line\">\tthe square can be formed；</span><br><span class=\"line\">\tUpdate the area of the largest rectangle；</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Solution &#123;</span><br><span class=\"line\">    public int largest1BorderedSquare(int[][] grid) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        // con[i][j][0] number of 1 in the direction of y</span><br><span class=\"line\">        // The number of consecutive ones in the vertical direction</span><br><span class=\"line\">        // con[i][j][1] number of 1 in the direction of x</span><br><span class=\"line\">        // The number of consecutive ones in the horizontal direction</span><br><span class=\"line\"></span><br><span class=\"line\">        int m=grid.length,n=grid[0].length;</span><br><span class=\"line\"></span><br><span class=\"line\">        int[][][] con=new int[m][n][2];</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class=\"line\">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class=\"line\">                if(grid[i][j]==1)&#123;</span><br><span class=\"line\">                    if(i&gt;0) con[i][j][1]=con[i-1][j][1]+1;</span><br><span class=\"line\">                    else con[i][j][1]=1;</span><br><span class=\"line\">                    if(j&gt;0) con[i][j][0]=con[i][j-1][0]+1;</span><br><span class=\"line\">                    else con[i][j][0]=1;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        //System.out.println(con[2][2][0]+&quot; &quot;+con[2][2][1]);</span><br><span class=\"line\">        //System.out.println(con[2][0][0]+&quot; &quot;+con[2][0][1]);</span><br><span class=\"line\">        //System.out.println(con[0][2][0]+&quot; &quot;+con[0][2][1]);</span><br><span class=\"line\"></span><br><span class=\"line\">        int ans=0;</span><br><span class=\"line\">        for(int i=0;i&lt;m;i++)&#123;</span><br><span class=\"line\">            for(int j=0;j&lt;n;j++)&#123;</span><br><span class=\"line\">                // I need to go through the length of the edge from the largest to the smallest</span><br><span class=\"line\">                for(int k=Math.min(con[i][j][0],con[i][j][1]);k&gt;0;k--)&#123;</span><br><span class=\"line\">                    </span><br><span class=\"line\">                    // *---k</span><br><span class=\"line\">                    // ｜   |</span><br><span class=\"line\">                    // ｜.  |</span><br><span class=\"line\">                    // ｜.  |</span><br><span class=\"line\">                    // k---p</span><br><span class=\"line\">                    if(con[i-k+1][j][0]&gt;=k &amp;&amp; con[i][j-k+1][1]&gt;=k)&#123;</span><br><span class=\"line\">                        ans=Math.max(ans,k*k);</span><br><span class=\"line\">                        //System.out.println(i+&quot; &quot;+j+&quot; &quot;+k+&quot; &quot;+);</span><br><span class=\"line\">                        break;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return ans;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n"},{"title":"lc1792 Maximum Average Pass Ratio","date":"2023-02-19T06:45:42.000Z","_content":"\n## Question\n\nThere is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.\n\nYou are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.\n\nThe pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.\n\nReturn the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.\n\n```\nExample 1:\nInput: classes = [[1,2],[3,5],[2,2]], extraStudents = 2\nOutput: 0.78333\nExplanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.\n\nExample 2:\nInput: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4\nOutput: 0.53485\n\n```\n\n\n\n## Solution\n\n\n\n```\nclass Solution {\n    public double maxAverageRatio(int[][] classes, int extraStudents) {\n\n        // So this is a two-dimensional array\n        PriorityQueue<int[]> queue = new PriorityQueue<int[]>(\n         (a, b) -> {\n            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);\n            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);\n            if (val1 == val2) {\n                return 0;\n            }\n            return val1 < val2 ? 1 : -1;\n        }\n        );\n\n        for(int i=0;i<classes.length;i++){\n            queue.add(classes[i]);\n        }\n\n        // while(!queue.isEmpty()){\n        //     int[] item=queue.poll();\n        //     System.out.println(item[0]+\" \"+item[1]);\n        // }\n\n        for(int i=0;i<extraStudents;i++){\n            int[] item=queue.poll();\n            item[0]++;\n            item[1]++;\n            queue.add(item);\n        }\n\n        double ans=0;\n        while(!queue.isEmpty()){\n            int[] item=queue.poll();\n            ans+=((double)item[0])/((double)item[1]);\n        }\n\n        \n        return ans/classes.length;\n\n    }\n}\n\n// dp[i][j] The max pass ratio for first i class,first j extra student\n// dp[i][j]=MAX{ dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)}\n// Time complexity：O(l * extraStudents^2)\n// This algorithm seems too complicated\n\n\n// So Use a greedy idea.\n// I define a priority queue\n// And the queue storage the classes and sort them by pass ratio from small to big.\n\n// I keep pulling classes from the head of the queue\n// Adding a extra student to this class and push this class back to queue.\n\n// When all extra student were used, the average pass retio has been maximized\n// the time complexity is o(log(l)*extraStudentNum)\n\n\n\n```\n\n\n\n","source":"_posts/lc1792-Maximum-Average-Pass-Ratio.md","raw":"---\ntitle: lc1792 Maximum Average Pass Ratio\ndate: 2023-02-19 14:45:42\ntags:\n---\n\n## Question\n\nThere is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.\n\nYou are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.\n\nThe pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.\n\nReturn the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.\n\n```\nExample 1:\nInput: classes = [[1,2],[3,5],[2,2]], extraStudents = 2\nOutput: 0.78333\nExplanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.\n\nExample 2:\nInput: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4\nOutput: 0.53485\n\n```\n\n\n\n## Solution\n\n\n\n```\nclass Solution {\n    public double maxAverageRatio(int[][] classes, int extraStudents) {\n\n        // So this is a two-dimensional array\n        PriorityQueue<int[]> queue = new PriorityQueue<int[]>(\n         (a, b) -> {\n            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);\n            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);\n            if (val1 == val2) {\n                return 0;\n            }\n            return val1 < val2 ? 1 : -1;\n        }\n        );\n\n        for(int i=0;i<classes.length;i++){\n            queue.add(classes[i]);\n        }\n\n        // while(!queue.isEmpty()){\n        //     int[] item=queue.poll();\n        //     System.out.println(item[0]+\" \"+item[1]);\n        // }\n\n        for(int i=0;i<extraStudents;i++){\n            int[] item=queue.poll();\n            item[0]++;\n            item[1]++;\n            queue.add(item);\n        }\n\n        double ans=0;\n        while(!queue.isEmpty()){\n            int[] item=queue.poll();\n            ans+=((double)item[0])/((double)item[1]);\n        }\n\n        \n        return ans/classes.length;\n\n    }\n}\n\n// dp[i][j] The max pass ratio for first i class,first j extra student\n// dp[i][j]=MAX{ dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)}\n// Time complexity：O(l * extraStudents^2)\n// This algorithm seems too complicated\n\n\n// So Use a greedy idea.\n// I define a priority queue\n// And the queue storage the classes and sort them by pass ratio from small to big.\n\n// I keep pulling classes from the head of the queue\n// Adding a extra student to this class and push this class back to queue.\n\n// When all extra student were used, the average pass retio has been maximized\n// the time complexity is o(log(l)*extraStudentNum)\n\n\n\n```\n\n\n\n","slug":"lc1792-Maximum-Average-Pass-Ratio","published":1,"updated":"2023-02-19T06:47:38.044Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa70014b9c9c74b88g6","content":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>There is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.</p>\n<p>You are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.</p>\n<p>The pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.</p>\n<p>Return the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: classes = [[1,2],[3,5],[2,2]], extraStudents = 2</span><br><span class=\"line\">Output: 0.78333</span><br><span class=\"line\">Explanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4</span><br><span class=\"line\">Output: 0.53485</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Solution &#123;</span><br><span class=\"line\">    public double maxAverageRatio(int[][] classes, int extraStudents) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        // So this is a two-dimensional array</span><br><span class=\"line\">        PriorityQueue&lt;int[]&gt; queue = new PriorityQueue&lt;int[]&gt;(</span><br><span class=\"line\">         (a, b) -&gt; &#123;</span><br><span class=\"line\">            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);</span><br><span class=\"line\">            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);</span><br><span class=\"line\">            if (val1 == val2) &#123;</span><br><span class=\"line\">                return 0;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return val1 &lt; val2 ? 1 : -1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;classes.length;i++)&#123;</span><br><span class=\"line\">            queue.add(classes[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        // while(!queue.isEmpty())&#123;</span><br><span class=\"line\">        //     int[] item=queue.poll();</span><br><span class=\"line\">        //     System.out.println(item[0]+&quot; &quot;+item[1]);</span><br><span class=\"line\">        // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;extraStudents;i++)&#123;</span><br><span class=\"line\">            int[] item=queue.poll();</span><br><span class=\"line\">            item[0]++;</span><br><span class=\"line\">            item[1]++;</span><br><span class=\"line\">            queue.add(item);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        double ans=0;</span><br><span class=\"line\">        while(!queue.isEmpty())&#123;</span><br><span class=\"line\">            int[] item=queue.poll();</span><br><span class=\"line\">            ans+=((double)item[0])/((double)item[1]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">        return ans/classes.length;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// dp[i][j] The max pass ratio for first i class,first j extra student</span><br><span class=\"line\">// dp[i][j]=MAX&#123; dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)&#125;</span><br><span class=\"line\">// Time complexity：O(l * extraStudents^2)</span><br><span class=\"line\">// This algorithm seems too complicated</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// So Use a greedy idea.</span><br><span class=\"line\">// I define a priority queue</span><br><span class=\"line\">// And the queue storage the classes and sort them by pass ratio from small to big.</span><br><span class=\"line\"></span><br><span class=\"line\">// I keep pulling classes from the head of the queue</span><br><span class=\"line\">// Adding a extra student to this class and push this class back to queue.</span><br><span class=\"line\"></span><br><span class=\"line\">// When all extra student were used, the average pass retio has been maximized</span><br><span class=\"line\">// the time complexity is o(log(l)*extraStudentNum)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>There is a school that has classes of students and each class will be having a final exam. You are given a 2D integer array classes, where classes[i] = [passi, totali]. You know beforehand that in the ith class, there are totali total students, but only passi number of students will pass the exam.</p>\n<p>You are also given an integer extraStudents. There are another extraStudents brilliant students that are guaranteed to pass the exam of any class they are assigned to. You want to assign each of the extraStudents students to a class in a way that maximizes the average pass ratio across all the classes.</p>\n<p>The pass ratio of a class is equal to the number of students of the class that will pass the exam divided by the total number of students of the class. The average pass ratio is the sum of pass ratios of all the classes divided by the number of the classes.</p>\n<p>Return the maximum possible average pass ratio after assigning the extraStudents students. Answers within 10-5 of the actual answer will be accepted.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: classes = [[1,2],[3,5],[2,2]], extraStudents = 2</span><br><span class=\"line\">Output: 0.78333</span><br><span class=\"line\">Explanation: You can assign the two extra students to the first class. The average pass ratio will be equal to (3/4 + 3/5 + 2/2) / 3 = 0.78333.</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: classes = [[2,4],[3,9],[4,5],[2,10]], extraStudents = 4</span><br><span class=\"line\">Output: 0.53485</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Solution &#123;</span><br><span class=\"line\">    public double maxAverageRatio(int[][] classes, int extraStudents) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        // So this is a two-dimensional array</span><br><span class=\"line\">        PriorityQueue&lt;int[]&gt; queue = new PriorityQueue&lt;int[]&gt;(</span><br><span class=\"line\">         (a, b) -&gt; &#123;</span><br><span class=\"line\">            long val1 = (long) (b[1] + 1) * b[1] * (a[1] - a[0]);</span><br><span class=\"line\">            long val2 = (long) (a[1] + 1) * a[1] * (b[1] - b[0]);</span><br><span class=\"line\">            if (val1 == val2) &#123;</span><br><span class=\"line\">                return 0;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return val1 &lt; val2 ? 1 : -1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;classes.length;i++)&#123;</span><br><span class=\"line\">            queue.add(classes[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        // while(!queue.isEmpty())&#123;</span><br><span class=\"line\">        //     int[] item=queue.poll();</span><br><span class=\"line\">        //     System.out.println(item[0]+&quot; &quot;+item[1]);</span><br><span class=\"line\">        // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int i=0;i&lt;extraStudents;i++)&#123;</span><br><span class=\"line\">            int[] item=queue.poll();</span><br><span class=\"line\">            item[0]++;</span><br><span class=\"line\">            item[1]++;</span><br><span class=\"line\">            queue.add(item);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        double ans=0;</span><br><span class=\"line\">        while(!queue.isEmpty())&#123;</span><br><span class=\"line\">            int[] item=queue.poll();</span><br><span class=\"line\">            ans+=((double)item[0])/((double)item[1]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">        return ans/classes.length;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// dp[i][j] The max pass ratio for first i class,first j extra student</span><br><span class=\"line\">// dp[i][j]=MAX&#123; dp[i-1][j-k]*(i-1)+(classes[i][0]+k)/(classes[i][1]+k)&#125;</span><br><span class=\"line\">// Time complexity：O(l * extraStudents^2)</span><br><span class=\"line\">// This algorithm seems too complicated</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// So Use a greedy idea.</span><br><span class=\"line\">// I define a priority queue</span><br><span class=\"line\">// And the queue storage the classes and sort them by pass ratio from small to big.</span><br><span class=\"line\"></span><br><span class=\"line\">// I keep pulling classes from the head of the queue</span><br><span class=\"line\">// Adding a extra student to this class and push this class back to queue.</span><br><span class=\"line\"></span><br><span class=\"line\">// When all extra student were used, the average pass retio has been maximized</span><br><span class=\"line\">// the time complexity is o(log(l)*extraStudentNum)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n"},{"title":"libbpf spinglock & map","date":"2023-02-10T06:21:40.000Z","_content":"\n## minimal\n\n1. bpf程序，这一代码会被加载进bpf虚拟机，由事件触发执行。\n\n````c\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n\nchar LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\";\n\nint my_pid = 0;\n\n//定义 ELF section\nSEC(\"tp/syscalls/sys_enter_write\")\nint handle_tp(void *ctx)\n{\n  // globle变量，读取pid\n\tint pid = bpf_get_current_pid_tgid() >> 32;\n\n\tif (pid != my_pid)\n\t\treturn 0;\n\n  // 向pipe发送字符串\n\tbpf_printk(\"BPF triggered from PID %d.\\n\", pid);\n\n\treturn 0;\n}\n````\n\n2. 用户空间代码\n\n```c\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/resource.h>\n#include <bpf/libbpf.h>\n#include \"minimal.skel.h\"\n\nstatic int libbpf_print_fn(enum libbpf_print_level level, const char *format, va_list args)\n{\n\treturn vfprintf(stderr, format, args);\n}\n\nint main(int argc, char **argv)\n{\n\tstruct minimal_bpf *skel;\n\tint err;\n\n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\t/* Set up libbpf errors and debug info callback */\n\tlibbpf_set_print(libbpf_print_fn);\n\n\t/* Open BPF application */\n\tskel = minimal_bpf__open();\n\tif (!skel) {\n\t\tfprintf(stderr, \"Failed to open BPF skeleton\\n\");\n\t\treturn 1;\n\t}\n\n\t/* ensure BPF program only handles write() syscalls from our process */\n\tskel->bss->my_pid = getpid();\n\n\t/* Load & verify BPF programs */\n\terr = minimal_bpf__load(skel);\n\tif (err) {\n\t\tfprintf(stderr, \"Failed to load and verify BPF skeleton\\n\");\n\t\tgoto cleanup;\n\t}\n\n\t/* Attach tracepoint handler */\n\terr = minimal_bpf__attach(skel);\n\tif (err) {\n\t\tfprintf(stderr, \"Failed to attach BPF skeleton\\n\");\n\t\tgoto cleanup;\n\t}\n\n\tprintf(\"Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` \"\n\t       \"to see output of the BPF programs.\\n\");\n\n\tfor (;;) {\n\t\t/* 触发bpf程序，用于测试 */\n\t\tfprintf(stderr, \".\");\n\t\tsleep(1);\n\t}\n\ncleanup:\n\tminimal_bpf__destroy(skel);\n\treturn -err;\n}\n\n```\n\n## bpf Spinlocks\n\nhttps://libbpf.readthedocs.io/en/latest/program_types.html\n\nhttps://libbpf.readthedocs.io/en/latest/program_types.html\n\nspinglock目前无法用于tracking和sccket filter相关ELF\n\n![截屏2023-02-10 18.15.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png)\n\nhttps://www.edony.ink/deepinsight-of-ebpf-map/\n\n","source":"_posts/libbpf-01.md","raw":"---\ntitle: libbpf spinglock & map\ndate: 2023-02-10 14:21:40\ntags:\n---\n\n## minimal\n\n1. bpf程序，这一代码会被加载进bpf虚拟机，由事件触发执行。\n\n````c\n#include <linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n\nchar LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\";\n\nint my_pid = 0;\n\n//定义 ELF section\nSEC(\"tp/syscalls/sys_enter_write\")\nint handle_tp(void *ctx)\n{\n  // globle变量，读取pid\n\tint pid = bpf_get_current_pid_tgid() >> 32;\n\n\tif (pid != my_pid)\n\t\treturn 0;\n\n  // 向pipe发送字符串\n\tbpf_printk(\"BPF triggered from PID %d.\\n\", pid);\n\n\treturn 0;\n}\n````\n\n2. 用户空间代码\n\n```c\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/resource.h>\n#include <bpf/libbpf.h>\n#include \"minimal.skel.h\"\n\nstatic int libbpf_print_fn(enum libbpf_print_level level, const char *format, va_list args)\n{\n\treturn vfprintf(stderr, format, args);\n}\n\nint main(int argc, char **argv)\n{\n\tstruct minimal_bpf *skel;\n\tint err;\n\n\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);\n\t/* Set up libbpf errors and debug info callback */\n\tlibbpf_set_print(libbpf_print_fn);\n\n\t/* Open BPF application */\n\tskel = minimal_bpf__open();\n\tif (!skel) {\n\t\tfprintf(stderr, \"Failed to open BPF skeleton\\n\");\n\t\treturn 1;\n\t}\n\n\t/* ensure BPF program only handles write() syscalls from our process */\n\tskel->bss->my_pid = getpid();\n\n\t/* Load & verify BPF programs */\n\terr = minimal_bpf__load(skel);\n\tif (err) {\n\t\tfprintf(stderr, \"Failed to load and verify BPF skeleton\\n\");\n\t\tgoto cleanup;\n\t}\n\n\t/* Attach tracepoint handler */\n\terr = minimal_bpf__attach(skel);\n\tif (err) {\n\t\tfprintf(stderr, \"Failed to attach BPF skeleton\\n\");\n\t\tgoto cleanup;\n\t}\n\n\tprintf(\"Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` \"\n\t       \"to see output of the BPF programs.\\n\");\n\n\tfor (;;) {\n\t\t/* 触发bpf程序，用于测试 */\n\t\tfprintf(stderr, \".\");\n\t\tsleep(1);\n\t}\n\ncleanup:\n\tminimal_bpf__destroy(skel);\n\treturn -err;\n}\n\n```\n\n## bpf Spinlocks\n\nhttps://libbpf.readthedocs.io/en/latest/program_types.html\n\nhttps://libbpf.readthedocs.io/en/latest/program_types.html\n\nspinglock目前无法用于tracking和sccket filter相关ELF\n\n![截屏2023-02-10 18.15.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png)\n\nhttps://www.edony.ink/deepinsight-of-ebpf-map/\n\n","slug":"libbpf-01","published":1,"updated":"2023-02-13T12:43:09.806Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa80015b9c9bviv9zwl","content":"<h2 id=\"minimal\"><a href=\"#minimal\" class=\"headerlink\" title=\"minimal\"></a>minimal</h2><ol>\n<li>bpf程序，这一代码会被加载进bpf虚拟机，由事件触发执行。</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/bpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> LICENSE[] SEC(<span class=\"string\">&quot;license&quot;</span>) = <span class=\"string\">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> my_pid = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//定义 ELF section</span></span><br><span class=\"line\">SEC(<span class=\"string\">&quot;tp/syscalls/sys_enter_write&quot;</span>)</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">handle_tp</span><span class=\"params\">(<span class=\"type\">void</span> *ctx)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// globle变量，读取pid</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> pid = bpf_get_current_pid_tgid() &gt;&gt; <span class=\"number\">32</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pid != my_pid)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 向pipe发送字符串</span></span><br><span class=\"line\">\tbpf_printk(<span class=\"string\">&quot;BPF triggered from PID %d.\\n&quot;</span>, pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>用户空间代码</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/resource.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;minimal.skel.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">libbpf_print_fn</span><span class=\"params\">(<span class=\"keyword\">enum</span> libbpf_print_level level, <span class=\"type\">const</span> <span class=\"type\">char</span> *format, va_list args)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">vfprintf</span>(<span class=\"built_in\">stderr</span>, format, args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">minimal_bpf</span> *<span class=\"title\">skel</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> err;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);</span><br><span class=\"line\">\t<span class=\"comment\">/* Set up libbpf errors and debug info callback */</span></span><br><span class=\"line\">\tlibbpf_set_print(libbpf_print_fn);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Open BPF application */</span></span><br><span class=\"line\">\tskel = minimal_bpf__open();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!skel) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to open BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* ensure BPF program only handles write() syscalls from our process */</span></span><br><span class=\"line\">\tskel-&gt;bss-&gt;my_pid = getpid();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Load &amp; verify BPF programs */</span></span><br><span class=\"line\">\terr = minimal_bpf__load(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to load and verify BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Attach tracepoint handler */</span></span><br><span class=\"line\">\terr = minimal_bpf__attach(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to attach BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &quot;</span></span><br><span class=\"line\">\t       <span class=\"string\">&quot;to see output of the BPF programs.\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">/* 触发bpf程序，用于测试 */</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\">\t\tsleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">cleanup:</span><br><span class=\"line\">\tminimal_bpf__destroy(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> -err;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"bpf-Spinlocks\"><a href=\"#bpf-Spinlocks\" class=\"headerlink\" title=\"bpf Spinlocks\"></a>bpf Spinlocks</h2><p><a href=\"https://libbpf.readthedocs.io/en/latest/program_types.html\">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p>\n<p><a href=\"https://libbpf.readthedocs.io/en/latest/program_types.html\">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p>\n<p>spinglock目前无法用于tracking和sccket filter相关ELF</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png\" alt=\"截屏2023-02-10 18.15.29\"></p>\n<p><a href=\"https://www.edony.ink/deepinsight-of-ebpf-map/\">https://www.edony.ink/deepinsight-of-ebpf-map/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"minimal\"><a href=\"#minimal\" class=\"headerlink\" title=\"minimal\"></a>minimal</h2><ol>\n<li>bpf程序，这一代码会被加载进bpf虚拟机，由事件触发执行。</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/bpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> LICENSE[] SEC(<span class=\"string\">&quot;license&quot;</span>) = <span class=\"string\">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> my_pid = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//定义 ELF section</span></span><br><span class=\"line\">SEC(<span class=\"string\">&quot;tp/syscalls/sys_enter_write&quot;</span>)</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">handle_tp</span><span class=\"params\">(<span class=\"type\">void</span> *ctx)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// globle变量，读取pid</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> pid = bpf_get_current_pid_tgid() &gt;&gt; <span class=\"number\">32</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pid != my_pid)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 向pipe发送字符串</span></span><br><span class=\"line\">\tbpf_printk(<span class=\"string\">&quot;BPF triggered from PID %d.\\n&quot;</span>, pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>用户空间代码</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/resource.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;minimal.skel.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">libbpf_print_fn</span><span class=\"params\">(<span class=\"keyword\">enum</span> libbpf_print_level level, <span class=\"type\">const</span> <span class=\"type\">char</span> *format, va_list args)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">vfprintf</span>(<span class=\"built_in\">stderr</span>, format, args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">minimal_bpf</span> *<span class=\"title\">skel</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> err;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlibbpf_set_strict_mode(LIBBPF_STRICT_ALL);</span><br><span class=\"line\">\t<span class=\"comment\">/* Set up libbpf errors and debug info callback */</span></span><br><span class=\"line\">\tlibbpf_set_print(libbpf_print_fn);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Open BPF application */</span></span><br><span class=\"line\">\tskel = minimal_bpf__open();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!skel) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to open BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* ensure BPF program only handles write() syscalls from our process */</span></span><br><span class=\"line\">\tskel-&gt;bss-&gt;my_pid = getpid();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Load &amp; verify BPF programs */</span></span><br><span class=\"line\">\terr = minimal_bpf__load(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to load and verify BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* Attach tracepoint handler */</span></span><br><span class=\"line\">\terr = minimal_bpf__attach(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Failed to attach BPF skeleton\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> cleanup;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &quot;</span></span><br><span class=\"line\">\t       <span class=\"string\">&quot;to see output of the BPF programs.\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">/* 触发bpf程序，用于测试 */</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\">\t\tsleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">cleanup:</span><br><span class=\"line\">\tminimal_bpf__destroy(skel);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> -err;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"bpf-Spinlocks\"><a href=\"#bpf-Spinlocks\" class=\"headerlink\" title=\"bpf Spinlocks\"></a>bpf Spinlocks</h2><p><a href=\"https://libbpf.readthedocs.io/en/latest/program_types.html\">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p>\n<p><a href=\"https://libbpf.readthedocs.io/en/latest/program_types.html\">https://libbpf.readthedocs.io/en/latest/program_types.html</a></p>\n<p>spinglock目前无法用于tracking和sccket filter相关ELF</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-02-10%2018.15.29.png\" alt=\"截屏2023-02-10 18.15.29\"></p>\n<p><a href=\"https://www.edony.ink/deepinsight-of-ebpf-map/\">https://www.edony.ink/deepinsight-of-ebpf-map/</a></p>\n"},{"title":"first-blog Test","date":"2022-11-13T08:10:26.000Z","_content":"\n![1](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg)\n\n# Spring学习笔记（1）\n\n### 1.依赖注入，控制反转的理解\n\n### 2.Spring程序结构\n\n- 实体类（pojo）\n```java\npackage com.liu.pojo;\npublic class Hello {\n    private String str;\n    public void setStr(String str) {\n        this.str = str;\n    }\n    public String getStr() {\n        return str;\n    }\n    public String toString() {\n        return \"Hello{\" +\n                \"str='\" + str + '\\'' +\n                '}';\n    }\n}\n```\n- 配置文件\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n\n    <bean id=\"user\" class=\"com.liu.pojo.Hello\">\n        <property name=\"str\" value=\"123\"/>\n    </bean>\n</beans>\n```\n- 测试类\n```java\npublic class Test {\n    public static void main(String[] args) {\n        //获取Spring的上下文对象\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"beans.xml\");\n\n        Hello hello=(Hello)context.getBean(\"hello\");\n        System.out.println(hello.toString());\n    }\n}\n```\n### 3.set注入方法（di）\n- 实体类\n```java\npublic class Students {\n    private String name;\n    private Address address;\n    private String[] book;\n    private List<String> hobby;\n    private Map<String,String> card;\n    private Set<String> game;\n    private Properties info;\n    private String wife;\n\n}\n```\n```java\npublic class Address {\n    private String address;\n}\n```\n- 配置文件\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n    <bean id=\"address\" class=\"com.liu.pojo.Address\"/>\n    <bean id=\"student\" class=\"com.liu.pojo.Students\">\n<!--        普通值注入-->\n        <property name=\"name\" value=\"刘瀚中\"/>\n<!--        bean注入，使用ref-->\n        <property name=\"address\" ref=\"address\"/>\n<!--              数组注入-->\n        <property name=\"book\">\n            <array>\n                <value>傲慢与偏见</value>\n                <value>呼啸山庄</value>\n                <value>瓦尔登湖</value>\n            </array>\n        </property>\n<!--              列表注入-->\n        <property name=\"hobby\">\n            <list>\n                <value>傲慢与偏见</value>\n                <value>呼啸山庄</value>\n                <value>瓦尔登湖</value>\n            </list>\n        </property>\n<!--              map注入-->\n        <property name=\"card\">\n            <map>\n                <entry key=\"饭卡\" value=\"123456\"/>\n                <entry key=\"工资卡\" value=\"123456\"/>\n            </map>\n        </property>\n<!--              集合注入-->\n        <property name=\"game\">\n            <set>\n               <value type=\"java.lang.String\">吃鸡</value>\n                <value type=\"java.lang.String\">lol</value>\n            </set>\n        </property>\n<!--        properties注入-->\n        <property name=\"info\">\n            <props>\n                <prop key=\"administrator\">administrator@example.org</prop>\n                <prop key=\"support\">support@example.org</prop>\n                <prop key=\"development\">development@example.org</prop>\n            </props>\n        </property>\n<!--        null注入-->\n        <property name=\"wife\">\n            <null></null>\n        </property>\n\n    </bean>\n</beans>\n```\n### 4.自动装配（autowiring）\n自动装配首先会根据name寻找对象，\n```java\npublic class People {\n    @Value(\"1\")\n    private int age;\n    @Autowired\n    private Cat cat;\n    @Autowired\n    @Qualifier(value = \"dog1\")//若dog对象不唯一，需设置类名\n    private Dog dog;\n    private String name;\n}\n```\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        https://www.springframework.org/schema/context/spring-context.xsd\">\n    <context:annotation-config/>\n    <bean id=\"cat\" class=\"com.liu.pojo.Cat\"/>\n    <bean id=\"dog1\" class=\"com.liu.pojo.Dog\"/>\n    <bean id=\"dog2\" class=\"com.liu.pojo.Dog\"/>\n    <bean id=\"people\" class=\"com.liu.pojo.People\" autowire=\"byName\"/>\n</beans>\n```\n### 5.注解编程\n- 配置文件（xml）与注解并存\n  - dao层：@Repository\n  - pojo层：@Component\n  - service：@Service\n  - Controller层：@Controller\n```java\n@Component //等价于<bean id=\"user\" class=\"com.liu.pojo.User\"/>\n@Scope(\"singleton\")//单例，prototype原型模式\npublic class User {\n    @Value(\"lhz\")\n    private String name;\n}\n```\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        https://www.springframework.org/schema/context/spring-context.xsd\">\n\n    <context:annotation-config/>\n    <context:component-scan base-package=\"com.liu\"/>\n<!--    扫描包下的注解-->\n\n</beans>\n```\n\n### 6.代理模式\n\n### 7.面向切面编程(aop)\n面向切面编程，是在不改变原有代码的基础上，增强代码的功能。Spring-aop有三种实现方式。\n- 方法一：Spring原生API接口实现\n```xml\n<bean id=\"userService\" class=\"com.liu.service.UserServiceImpl\"/>\n<bean id=\"afterLog\" class=\"com.liu.log.AfterLog\"/>\n<bean id=\"beforeLog\" class=\"com.liu.log.BeforeLog\"/>\n<!--方式1:原生Spring的API接口-->\n<aop:config>\n    <aop:pointcut id=\"pointcut\" expression=\"execution(* com.liu.service.UserServiceImpl.*(..))\"/>\n    <aop:advisor advice-ref=\"afterLog\" pointcut-ref=\"pointcut\"/>\n    <aop:advisor advice-ref=\"beforeLog\" pointcut-ref=\"pointcut\"/>\n</aop:config>\n```\n在一个包下建立以下两个类，分别作为执行前和执行后\n```java\npublic class BeforeLog implements MethodBeforeAdvice {\n    public void before(Method method, Object[] objects, Object target) throws Throwable {\n        System.out.println(target.getClass().getName()+\"的\"+method.getName()+\"被执行了\");\n    }\n}\n\n```\n```java\npublic class AfterLog implements AfterReturningAdvice {\n    public void afterReturning(Object o, Method method, Object[] objects, Object o1) throws Throwable {\n        System.out.println(\"执行了\"+method.getName()+\"方法，返回结果为：\"+o);\n    }\n}\n```\n- 方法二：使用自定义类\n定义一个DiyPointCut类，在里面写after和before方法\n```xml\n    <!--方式2：自定义类-->\n    <bean id=\"diy\" class=\"com.liu.diy.DiyPointCut\"/>\n    <aop:config>\n        <!--自定义切面-->\n        <aop:aspect ref=\"diy\">\n            <!--切点-->\n            <aop:pointcut id=\"pointcut\" expression=\"execution(* com.liu.service.UserServiceImpl.*(..))\"/>\n            <!--通知-->\n            <aop:before method=\"before\" pointcut-ref=\"pointcut\"/>\n            <aop:after method=\"after\" pointcut-ref=\"pointcut\"/>\n        </aop:aspect>\n    </aop:config>\n```\n```java\npublic class DiyPointCut {\n    public void after(){\n        System.out.println(\"=========方法执行后========\");\n    }\n    public void before(){\n        System.out.println(\"=========方法执行前========\");\n    }\n}\n```\n- 方法三：使用注解\n需在xml文件中开启注解\n```xml\n<!--方式3-->\n    <aop:aspectj-autoproxy/><!--开启注解-->\n    <bean id=\"annotationPointCut\" class=\"com.liu.diy.AnnotationPointCut\"/>\n```\n```java\n@Aspect//标记为切面\npublic class AnnotationPointCut {\n    @Before(\"execution(* com.liu.service.UserServiceImpl.*(..))\")\n    public void before(){\n        System.out.println(\"===方法执行前===\");\n    }\n    @After(\"execution(* com.liu.service.UserServiceImpl.*(..))\")\n    public void after(){\n        System.out.println(\"===方法执行后===\");\n    }\n}\n```\n### 8.Spring和MyBatis整合\n需使用maven导入相应的jar包\n```xml\n<dependencies>\n\n        <dependency>\n            <groupId>mysql</groupId>\n            <artifactId>mysql-connector-java</artifactId>\n            <version>8.0.18</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.mybatis</groupId>\n            <artifactId>mybatis</artifactId>\n            <version>3.5.3</version>\n\n        </dependency>\n        <!--测试-->\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <version>4.12</version>\n        </dependency>\n        <!--注解-->\n        <dependency>\n            <groupId>org.projectlombok</groupId>\n            <artifactId>lombok</artifactId>\n            <version>1.18.10</version>\n        </dependency>\n<!--        spring依赖-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-webmvc</artifactId>\n            <version>5.2.3.RELEASE</version>\n        </dependency>\n        <!--        Spring操控数据库-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-jdbc</artifactId>\n            <version>5.2.3.RELEASE</version>\n        </dependency>\n<!--        aop织入包-->\n        <dependency>\n            <groupId>org.aspectj</groupId>\n            <artifactId>aspectjweaver</artifactId>\n            <version>1.9.5</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.mybatis</groupId>\n            <artifactId>mybatis-spring</artifactId>\n            <version>2.0.3</version>\n        </dependency>\n\n    </dependencies>\n```\nSpring-Mybatis使用Spring将Mybatis的配置整合，可以选择在原来的MyBatis-config文件中配置一些简单的Mapper注册和引用别名，在Spring-dao.xml文件中写各种配置，最后在applicationContext.xml文件中注册各个类。与Mybatis不同，Spring-Mybatis只能获得SqlSessionFactoryBean和SqlSessionTemplate。Spring-Mybatis有两种实现方式。\n- 第一种方式\n\n首先需要建立实体类，并建立接口和对应的xml文件，然后开始配置xml文件\nMyBatis-config.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE configuration\n        PUBLIC \"-//mybatis.org//DTD Config 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-config.dtd\">\n<configuration>\n<!--    引用别名-->\n    <typeAliases>\n        <package name=\"com.liu.pojo\"/>\n    </typeAliases>\n    <mappers>\n        <mapper resource=\"com/liu/dao/StudentsMapper.xml\"/>\n    </mappers>\n</configuration>\n```\nSpring-dao.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n<!--    datasource数据源-->\n    <bean id=\"dataSource\" class=\"org.springframework.jdbc.datasource.DriverManagerDataSource\">\n        <property name=\"driverClassName\" value=\"com.mysql.cj.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/mybatis?useSSl=true&amp;useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n    </bean>\n\n<!--    sqlSessionFactory-->\n    <bean id=\"sqlSessionFactory\" class=\"org.mybatis.spring.SqlSessionFactoryBean\">\n        <property name=\"dataSource\" ref=\"dataSource\"/>\n<!--        绑定MyBatis配置文件-->\n        <property name=\"configLocation\" value=\"classpath:mybatis-config.xml\"/>\n        <!-- 注册接口 -->\n        <property name=\"mapperLocations\" value=\"classpath:com/liu/dao/StudentsMapper.xml\"/>\n    </bean>\n\n    <bean id=\"sqlSession\" class=\"org.mybatis.spring.SqlSessionTemplate\">\n        <constructor-arg index=\"0\" ref=\"sqlSessionFactory\"/>\n    </bean>\n</beans>\n\n```\napplicationContext.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n\n    <import resource=\"spring-dao.xml\"/>\n    <bean id=\"studentsMapper\" class=\"com.liu.dao.StudentsMapperImpl\">\n        <property name=\"sqlSession\" ref=\"sqlSession\"/>\n    </bean>\n</beans>\n```\n\n在完成xml配置之后，一般可以建立一个接口的实现类，并在这个类获取sqlSession,在application文件中注册这个类，并将sqlSession通过set注入这个类\n\n```java\npublic class StudentsMapperImpl implements StudentsMapper {\n    private SqlSessionTemplate sqlSession;\n\n    public void setSqlSession(SqlSessionTemplate sqlSession) {\n        this.sqlSession = sqlSession;\n    }\n\n    public List<Students> getStudents() {\n        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);\n        return studentsMapper.getStudents();\n    }\n\n}\n```\n\n最后就可以进行测试\n\n```java\npublic void Test2(){\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"applicationContext.xml\");//Spring配置文件\n        StudentsMapper studentsMapper=context.getBean(\"studentsMapper1\",StudentsMapper.class);//接口，获取实现类\n        List<Students> list=studentsMapper.getStudents();\n        for (Students students : list) {\n            System.out.println(students);\n        }\n    }\n```\n\n- 方法二\n向接口的实现类注入sqlSeeeionFectory，该实现类需继承SqlSessionDaoSupport\n\n```java\npublic class StudentsMapperImpl2 extends SqlSessionDaoSupport implements StudentsMapper {\n\n    public List<Students> getStudents() {\n        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);//此处使用getSqlSession()\n        return studentsMapper.getStudents();\n    }\n}\n```\n注入sqlSessionFactory\n```java\n<bean id=\"studentsMapper2\" class=\"com.liu.dao.StudentsMapperImpl2\">\n        <property name=\"sqlSessionFactory\" ref=\"sqlSessionFactory\"/>\n    </bean>\n\n```\n","source":"_posts/my-first-blog.md","raw":"---\ntitle: first-blog Test\ndate: 2022-11-13 16:10:26\ntags:\n---\n\n![1](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg)\n\n# Spring学习笔记（1）\n\n### 1.依赖注入，控制反转的理解\n\n### 2.Spring程序结构\n\n- 实体类（pojo）\n```java\npackage com.liu.pojo;\npublic class Hello {\n    private String str;\n    public void setStr(String str) {\n        this.str = str;\n    }\n    public String getStr() {\n        return str;\n    }\n    public String toString() {\n        return \"Hello{\" +\n                \"str='\" + str + '\\'' +\n                '}';\n    }\n}\n```\n- 配置文件\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n\n    <bean id=\"user\" class=\"com.liu.pojo.Hello\">\n        <property name=\"str\" value=\"123\"/>\n    </bean>\n</beans>\n```\n- 测试类\n```java\npublic class Test {\n    public static void main(String[] args) {\n        //获取Spring的上下文对象\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"beans.xml\");\n\n        Hello hello=(Hello)context.getBean(\"hello\");\n        System.out.println(hello.toString());\n    }\n}\n```\n### 3.set注入方法（di）\n- 实体类\n```java\npublic class Students {\n    private String name;\n    private Address address;\n    private String[] book;\n    private List<String> hobby;\n    private Map<String,String> card;\n    private Set<String> game;\n    private Properties info;\n    private String wife;\n\n}\n```\n```java\npublic class Address {\n    private String address;\n}\n```\n- 配置文件\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n    <bean id=\"address\" class=\"com.liu.pojo.Address\"/>\n    <bean id=\"student\" class=\"com.liu.pojo.Students\">\n<!--        普通值注入-->\n        <property name=\"name\" value=\"刘瀚中\"/>\n<!--        bean注入，使用ref-->\n        <property name=\"address\" ref=\"address\"/>\n<!--              数组注入-->\n        <property name=\"book\">\n            <array>\n                <value>傲慢与偏见</value>\n                <value>呼啸山庄</value>\n                <value>瓦尔登湖</value>\n            </array>\n        </property>\n<!--              列表注入-->\n        <property name=\"hobby\">\n            <list>\n                <value>傲慢与偏见</value>\n                <value>呼啸山庄</value>\n                <value>瓦尔登湖</value>\n            </list>\n        </property>\n<!--              map注入-->\n        <property name=\"card\">\n            <map>\n                <entry key=\"饭卡\" value=\"123456\"/>\n                <entry key=\"工资卡\" value=\"123456\"/>\n            </map>\n        </property>\n<!--              集合注入-->\n        <property name=\"game\">\n            <set>\n               <value type=\"java.lang.String\">吃鸡</value>\n                <value type=\"java.lang.String\">lol</value>\n            </set>\n        </property>\n<!--        properties注入-->\n        <property name=\"info\">\n            <props>\n                <prop key=\"administrator\">administrator@example.org</prop>\n                <prop key=\"support\">support@example.org</prop>\n                <prop key=\"development\">development@example.org</prop>\n            </props>\n        </property>\n<!--        null注入-->\n        <property name=\"wife\">\n            <null></null>\n        </property>\n\n    </bean>\n</beans>\n```\n### 4.自动装配（autowiring）\n自动装配首先会根据name寻找对象，\n```java\npublic class People {\n    @Value(\"1\")\n    private int age;\n    @Autowired\n    private Cat cat;\n    @Autowired\n    @Qualifier(value = \"dog1\")//若dog对象不唯一，需设置类名\n    private Dog dog;\n    private String name;\n}\n```\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        https://www.springframework.org/schema/context/spring-context.xsd\">\n    <context:annotation-config/>\n    <bean id=\"cat\" class=\"com.liu.pojo.Cat\"/>\n    <bean id=\"dog1\" class=\"com.liu.pojo.Dog\"/>\n    <bean id=\"dog2\" class=\"com.liu.pojo.Dog\"/>\n    <bean id=\"people\" class=\"com.liu.pojo.People\" autowire=\"byName\"/>\n</beans>\n```\n### 5.注解编程\n- 配置文件（xml）与注解并存\n  - dao层：@Repository\n  - pojo层：@Component\n  - service：@Service\n  - Controller层：@Controller\n```java\n@Component //等价于<bean id=\"user\" class=\"com.liu.pojo.User\"/>\n@Scope(\"singleton\")//单例，prototype原型模式\npublic class User {\n    @Value(\"lhz\")\n    private String name;\n}\n```\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        https://www.springframework.org/schema/context/spring-context.xsd\">\n\n    <context:annotation-config/>\n    <context:component-scan base-package=\"com.liu\"/>\n<!--    扫描包下的注解-->\n\n</beans>\n```\n\n### 6.代理模式\n\n### 7.面向切面编程(aop)\n面向切面编程，是在不改变原有代码的基础上，增强代码的功能。Spring-aop有三种实现方式。\n- 方法一：Spring原生API接口实现\n```xml\n<bean id=\"userService\" class=\"com.liu.service.UserServiceImpl\"/>\n<bean id=\"afterLog\" class=\"com.liu.log.AfterLog\"/>\n<bean id=\"beforeLog\" class=\"com.liu.log.BeforeLog\"/>\n<!--方式1:原生Spring的API接口-->\n<aop:config>\n    <aop:pointcut id=\"pointcut\" expression=\"execution(* com.liu.service.UserServiceImpl.*(..))\"/>\n    <aop:advisor advice-ref=\"afterLog\" pointcut-ref=\"pointcut\"/>\n    <aop:advisor advice-ref=\"beforeLog\" pointcut-ref=\"pointcut\"/>\n</aop:config>\n```\n在一个包下建立以下两个类，分别作为执行前和执行后\n```java\npublic class BeforeLog implements MethodBeforeAdvice {\n    public void before(Method method, Object[] objects, Object target) throws Throwable {\n        System.out.println(target.getClass().getName()+\"的\"+method.getName()+\"被执行了\");\n    }\n}\n\n```\n```java\npublic class AfterLog implements AfterReturningAdvice {\n    public void afterReturning(Object o, Method method, Object[] objects, Object o1) throws Throwable {\n        System.out.println(\"执行了\"+method.getName()+\"方法，返回结果为：\"+o);\n    }\n}\n```\n- 方法二：使用自定义类\n定义一个DiyPointCut类，在里面写after和before方法\n```xml\n    <!--方式2：自定义类-->\n    <bean id=\"diy\" class=\"com.liu.diy.DiyPointCut\"/>\n    <aop:config>\n        <!--自定义切面-->\n        <aop:aspect ref=\"diy\">\n            <!--切点-->\n            <aop:pointcut id=\"pointcut\" expression=\"execution(* com.liu.service.UserServiceImpl.*(..))\"/>\n            <!--通知-->\n            <aop:before method=\"before\" pointcut-ref=\"pointcut\"/>\n            <aop:after method=\"after\" pointcut-ref=\"pointcut\"/>\n        </aop:aspect>\n    </aop:config>\n```\n```java\npublic class DiyPointCut {\n    public void after(){\n        System.out.println(\"=========方法执行后========\");\n    }\n    public void before(){\n        System.out.println(\"=========方法执行前========\");\n    }\n}\n```\n- 方法三：使用注解\n需在xml文件中开启注解\n```xml\n<!--方式3-->\n    <aop:aspectj-autoproxy/><!--开启注解-->\n    <bean id=\"annotationPointCut\" class=\"com.liu.diy.AnnotationPointCut\"/>\n```\n```java\n@Aspect//标记为切面\npublic class AnnotationPointCut {\n    @Before(\"execution(* com.liu.service.UserServiceImpl.*(..))\")\n    public void before(){\n        System.out.println(\"===方法执行前===\");\n    }\n    @After(\"execution(* com.liu.service.UserServiceImpl.*(..))\")\n    public void after(){\n        System.out.println(\"===方法执行后===\");\n    }\n}\n```\n### 8.Spring和MyBatis整合\n需使用maven导入相应的jar包\n```xml\n<dependencies>\n\n        <dependency>\n            <groupId>mysql</groupId>\n            <artifactId>mysql-connector-java</artifactId>\n            <version>8.0.18</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.mybatis</groupId>\n            <artifactId>mybatis</artifactId>\n            <version>3.5.3</version>\n\n        </dependency>\n        <!--测试-->\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <version>4.12</version>\n        </dependency>\n        <!--注解-->\n        <dependency>\n            <groupId>org.projectlombok</groupId>\n            <artifactId>lombok</artifactId>\n            <version>1.18.10</version>\n        </dependency>\n<!--        spring依赖-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-webmvc</artifactId>\n            <version>5.2.3.RELEASE</version>\n        </dependency>\n        <!--        Spring操控数据库-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-jdbc</artifactId>\n            <version>5.2.3.RELEASE</version>\n        </dependency>\n<!--        aop织入包-->\n        <dependency>\n            <groupId>org.aspectj</groupId>\n            <artifactId>aspectjweaver</artifactId>\n            <version>1.9.5</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.mybatis</groupId>\n            <artifactId>mybatis-spring</artifactId>\n            <version>2.0.3</version>\n        </dependency>\n\n    </dependencies>\n```\nSpring-Mybatis使用Spring将Mybatis的配置整合，可以选择在原来的MyBatis-config文件中配置一些简单的Mapper注册和引用别名，在Spring-dao.xml文件中写各种配置，最后在applicationContext.xml文件中注册各个类。与Mybatis不同，Spring-Mybatis只能获得SqlSessionFactoryBean和SqlSessionTemplate。Spring-Mybatis有两种实现方式。\n- 第一种方式\n\n首先需要建立实体类，并建立接口和对应的xml文件，然后开始配置xml文件\nMyBatis-config.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE configuration\n        PUBLIC \"-//mybatis.org//DTD Config 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-config.dtd\">\n<configuration>\n<!--    引用别名-->\n    <typeAliases>\n        <package name=\"com.liu.pojo\"/>\n    </typeAliases>\n    <mappers>\n        <mapper resource=\"com/liu/dao/StudentsMapper.xml\"/>\n    </mappers>\n</configuration>\n```\nSpring-dao.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n<!--    datasource数据源-->\n    <bean id=\"dataSource\" class=\"org.springframework.jdbc.datasource.DriverManagerDataSource\">\n        <property name=\"driverClassName\" value=\"com.mysql.cj.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/mybatis?useSSl=true&amp;useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n    </bean>\n\n<!--    sqlSessionFactory-->\n    <bean id=\"sqlSessionFactory\" class=\"org.mybatis.spring.SqlSessionFactoryBean\">\n        <property name=\"dataSource\" ref=\"dataSource\"/>\n<!--        绑定MyBatis配置文件-->\n        <property name=\"configLocation\" value=\"classpath:mybatis-config.xml\"/>\n        <!-- 注册接口 -->\n        <property name=\"mapperLocations\" value=\"classpath:com/liu/dao/StudentsMapper.xml\"/>\n    </bean>\n\n    <bean id=\"sqlSession\" class=\"org.mybatis.spring.SqlSessionTemplate\">\n        <constructor-arg index=\"0\" ref=\"sqlSessionFactory\"/>\n    </bean>\n</beans>\n\n```\napplicationContext.xml\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        https://www.springframework.org/schema/beans/spring-beans.xsd\">\n\n    <import resource=\"spring-dao.xml\"/>\n    <bean id=\"studentsMapper\" class=\"com.liu.dao.StudentsMapperImpl\">\n        <property name=\"sqlSession\" ref=\"sqlSession\"/>\n    </bean>\n</beans>\n```\n\n在完成xml配置之后，一般可以建立一个接口的实现类，并在这个类获取sqlSession,在application文件中注册这个类，并将sqlSession通过set注入这个类\n\n```java\npublic class StudentsMapperImpl implements StudentsMapper {\n    private SqlSessionTemplate sqlSession;\n\n    public void setSqlSession(SqlSessionTemplate sqlSession) {\n        this.sqlSession = sqlSession;\n    }\n\n    public List<Students> getStudents() {\n        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);\n        return studentsMapper.getStudents();\n    }\n\n}\n```\n\n最后就可以进行测试\n\n```java\npublic void Test2(){\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"applicationContext.xml\");//Spring配置文件\n        StudentsMapper studentsMapper=context.getBean(\"studentsMapper1\",StudentsMapper.class);//接口，获取实现类\n        List<Students> list=studentsMapper.getStudents();\n        for (Students students : list) {\n            System.out.println(students);\n        }\n    }\n```\n\n- 方法二\n向接口的实现类注入sqlSeeeionFectory，该实现类需继承SqlSessionDaoSupport\n\n```java\npublic class StudentsMapperImpl2 extends SqlSessionDaoSupport implements StudentsMapper {\n\n    public List<Students> getStudents() {\n        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);//此处使用getSqlSession()\n        return studentsMapper.getStudents();\n    }\n}\n```\n注入sqlSessionFactory\n```java\n<bean id=\"studentsMapper2\" class=\"com.liu.dao.StudentsMapperImpl2\">\n        <property name=\"sqlSessionFactory\" ref=\"sqlSessionFactory\"/>\n    </bean>\n\n```\n","slug":"my-first-blog","published":1,"updated":"2022-11-26T06:58:06.395Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clepqbqa80016b9c9hwww8tpt","content":"<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg\" alt=\"1\"></p>\n<h1 id=\"Spring学习笔记（1）\"><a href=\"#Spring学习笔记（1）\" class=\"headerlink\" title=\"Spring学习笔记（1）\"></a>Spring学习笔记（1）</h1><h3 id=\"1-依赖注入，控制反转的理解\"><a href=\"#1-依赖注入，控制反转的理解\" class=\"headerlink\" title=\"1.依赖注入，控制反转的理解\"></a>1.依赖注入，控制反转的理解</h3><h3 id=\"2-Spring程序结构\"><a href=\"#2-Spring程序结构\" class=\"headerlink\" title=\"2.Spring程序结构\"></a>2.Spring程序结构</h3><ul>\n<li>实体类（pojo）<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.liu.pojo;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Hello</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String str;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setStr</span><span class=\"params\">(String str)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.str = str;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getStr</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> str;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Hello&#123;&quot;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;str=&#x27;&quot;</span> + str + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>配置文件<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;user&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Hello&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;str&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li>测试类<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取Spring的上下文对象</span></span><br><span class=\"line\">        <span class=\"type\">ApplicationContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(<span class=\"string\">&quot;beans.xml&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Hello hello=(Hello)context.getBean(<span class=\"string\">&quot;hello&quot;</span>);</span><br><span class=\"line\">        System.out.println(hello.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-set注入方法（di）\"><a href=\"#3-set注入方法（di）\" class=\"headerlink\" title=\"3.set注入方法（di）\"></a>3.set注入方法（di）</h3></li>\n<li>实体类<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Students</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Address address;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String[] book;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; hobby;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,String&gt; card;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; game;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Properties info;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String wife;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Address</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String address;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>配置文件<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;address&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Address&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;student&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Students&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        普通值注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;刘瀚中&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        bean注入，使用ref--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;address&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;address&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              数组注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;book&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>傲慢与偏见<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>呼啸山庄<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>瓦尔登湖<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              列表注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;hobby&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>傲慢与偏见<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>呼啸山庄<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>瓦尔登湖<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              map注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;card&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;饭卡&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;工资卡&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              集合注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;game&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">value</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>&gt;</span>吃鸡<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>&gt;</span>lol<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        properties注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;administrator&quot;</span>&gt;</span>administrator@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;support&quot;</span>&gt;</span>support@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span>development@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        null注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;wife&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">null</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">null</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"4-自动装配（autowiring）\"><a href=\"#4-自动装配（autowiring）\" class=\"headerlink\" title=\"4.自动装配（autowiring）\"></a>4.自动装配（autowiring）</h3>自动装配首先会根据name寻找对象，<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">People</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;1&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> age;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Cat cat;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"meta\">@Qualifier(value = &quot;dog1&quot;)</span><span class=\"comment\">//若dog对象不唯一，需设置类名</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Dog dog;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"line\">&lt;beans xmlns=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class=\"line\">       xmlns:xsi=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class=\"line\">       xmlns:context=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class=\"line\">       xsi:schemaLocation=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span><br><span class=\"line\"><span class=\"string\">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class=\"line\"><span class=\"string\">        http://www.springframework.org/schema/context</span></span><br><span class=\"line\"><span class=\"string\">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class=\"line\">    &lt;context:annotation-config/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;cat&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Cat&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;dog1&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;dog2&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;people&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.People&quot;</span> autowire=<span class=\"string\">&quot;byName&quot;</span>/&gt;</span><br><span class=\"line\">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"5-注解编程\"><a href=\"#5-注解编程\" class=\"headerlink\" title=\"5.注解编程\"></a>5.注解编程</h3></li>\n<li>配置文件（xml）与注解并存<ul>\n<li>dao层：@Repository</li>\n<li>pojo层：@Component</li>\n<li>service：@Service</li>\n<li>Controller层：@Controller<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span> <span class=\"comment\">//等价于&lt;bean id=&quot;user&quot; class=&quot;com.liu.pojo.User&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"meta\">@Scope(&quot;singleton&quot;)</span><span class=\"comment\">//单例，prototype原型模式</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">User</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;lhz&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:annotation-config</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.liu&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    扫描包下的注解--&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"6-代理模式\"><a href=\"#6-代理模式\" class=\"headerlink\" title=\"6.代理模式\"></a>6.代理模式</h3><h3 id=\"7-面向切面编程-aop\"><a href=\"#7-面向切面编程-aop\" class=\"headerlink\" title=\"7.面向切面编程(aop)\"></a>7.面向切面编程(aop)</h3><p>面向切面编程，是在不改变原有代码的基础上，增强代码的功能。Spring-aop有三种实现方式。</p>\n<ul>\n<li>方法一：Spring原生API接口实现<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;userService&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.service.UserServiceImpl&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;afterLog&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.log.AfterLog&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;beforeLog&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.log.BeforeLog&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--方式1:原生Spring的API接口--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointcut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;afterLog&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;beforeLog&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n在一个包下建立以下两个类，分别作为执行前和执行后<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BeforeLog</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">MethodBeforeAdvice</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">(Method method, Object[] objects, Object target)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        System.out.println(target.getClass().getName()+<span class=\"string\">&quot;的&quot;</span>+method.getName()+<span class=\"string\">&quot;被执行了&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AfterLog</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AfterReturningAdvice</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">afterReturning</span><span class=\"params\">(Object o, Method method, Object[] objects, Object o1)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;执行了&quot;</span>+method.getName()+<span class=\"string\">&quot;方法，返回结果为：&quot;</span>+o);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>方法二：使用自定义类<br>定义一个DiyPointCut类，在里面写after和before方法<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--方式2：自定义类--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;diy&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.diy.DiyPointCut&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--自定义切面--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:aspect</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;diy&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--切点--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointcut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--通知--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:before</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;before&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:after</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;after&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">aop:aspect</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DiyPointCut</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">after</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========方法执行后========&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========方法执行前========&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>方法三：使用注解<br>需在xml文件中开启注解<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--方式3--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:aspectj-autoproxy</span>/&gt;</span><span class=\"comment\">&lt;!--开启注解--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;annotationPointCut&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.diy.AnnotationPointCut&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Aspect</span><span class=\"comment\">//标记为切面</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AnnotationPointCut</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Before(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;===方法执行前===&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@After(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">after</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;===方法执行后===&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"8-Spring和MyBatis整合\"><a href=\"#8-Spring和MyBatis整合\" class=\"headerlink\" title=\"8.Spring和MyBatis整合\"></a>8.Spring和MyBatis整合</h3>需使用maven导入相应的jar包<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>8.0.18<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.5.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--测试--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.12<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--注解--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.18.10<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        spring依赖--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-webmvc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.2.3.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        Spring操控数据库--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.2.3.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        aop织入包--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.aspectj<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aspectjweaver<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.9.5<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis-spring<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.0.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\nSpring-Mybatis使用Spring将Mybatis的配置整合，可以选择在原来的MyBatis-config文件中配置一些简单的Mapper注册和引用别名，在Spring-dao.xml文件中写各种配置，最后在applicationContext.xml文件中注册各个类。与Mybatis不同，Spring-Mybatis只能获得SqlSessionFactoryBean和SqlSessionTemplate。Spring-Mybatis有两种实现方式。</li>\n<li>第一种方式</li>\n</ul>\n<p>首先需要建立实体类，并建立接口和对应的xml文件，然后开始配置xml文件<br>MyBatis-config.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">configuration</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"string\">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    引用别名--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.liu.pojo&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>Spring-dao.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    datasource数据源--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/mybatis?useSSl=true<span class=\"symbol\">&amp;amp;</span>useUnicode=true<span class=\"symbol\">&amp;amp;</span>characterEncoding=utf-8&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;root&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    sqlSessionFactory--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        绑定MyBatis配置文件--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;configLocation&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 注册接口 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;mapperLocations&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;classpath:com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSession&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>applicationContext.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">import</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;spring-dao.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;studentsMapper&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.dao.StudentsMapperImpl&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;sqlSession&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>在完成xml配置之后，一般可以建立一个接口的实现类，并在这个类获取sqlSession,在application文件中注册这个类，并将sqlSession通过set注入这个类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StudentsMapperImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">StudentsMapper</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> SqlSessionTemplate sqlSession;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setSqlSession</span><span class=\"params\">(SqlSessionTemplate sqlSession)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.sqlSession = sqlSession;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;Students&gt; <span class=\"title function_\">getStudents</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> studentsMapper.getStudents();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后就可以进行测试</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">Test2</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">ApplicationContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(<span class=\"string\">&quot;applicationContext.xml&quot;</span>);<span class=\"comment\">//Spring配置文件</span></span><br><span class=\"line\">        StudentsMapper studentsMapper=context.getBean(<span class=\"string\">&quot;studentsMapper1&quot;</span>,StudentsMapper.class);<span class=\"comment\">//接口，获取实现类</span></span><br><span class=\"line\">        List&lt;Students&gt; list=studentsMapper.getStudents();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Students students : list) &#123;</span><br><span class=\"line\">            System.out.println(students);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>方法二<br>向接口的实现类注入sqlSeeeionFectory，该实现类需继承SqlSessionDaoSupport</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StudentsMapperImpl2</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SqlSessionDaoSupport</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">StudentsMapper</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;Students&gt; <span class=\"title function_\">getStudents</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);<span class=\"comment\">//此处使用getSqlSession()</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> studentsMapper.getStudents();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注入sqlSessionFactory</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;bean id=<span class=\"string\">&quot;studentsMapper2&quot;</span> class=<span class=\"string\">&quot;com.liu.dao.StudentsMapperImpl2&quot;</span>&gt;</span><br><span class=\"line\">        &lt;property name=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> ref=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;/bean&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/1.jpeg\" alt=\"1\"></p>\n<h1 id=\"Spring学习笔记（1）\"><a href=\"#Spring学习笔记（1）\" class=\"headerlink\" title=\"Spring学习笔记（1）\"></a>Spring学习笔记（1）</h1><h3 id=\"1-依赖注入，控制反转的理解\"><a href=\"#1-依赖注入，控制反转的理解\" class=\"headerlink\" title=\"1.依赖注入，控制反转的理解\"></a>1.依赖注入，控制反转的理解</h3><h3 id=\"2-Spring程序结构\"><a href=\"#2-Spring程序结构\" class=\"headerlink\" title=\"2.Spring程序结构\"></a>2.Spring程序结构</h3><ul>\n<li>实体类（pojo）<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.liu.pojo;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Hello</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String str;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setStr</span><span class=\"params\">(String str)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.str = str;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getStr</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> str;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Hello&#123;&quot;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;str=&#x27;&quot;</span> + str + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>配置文件<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;user&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Hello&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;str&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n<li>测试类<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Test</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取Spring的上下文对象</span></span><br><span class=\"line\">        <span class=\"type\">ApplicationContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(<span class=\"string\">&quot;beans.xml&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Hello hello=(Hello)context.getBean(<span class=\"string\">&quot;hello&quot;</span>);</span><br><span class=\"line\">        System.out.println(hello.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-set注入方法（di）\"><a href=\"#3-set注入方法（di）\" class=\"headerlink\" title=\"3.set注入方法（di）\"></a>3.set注入方法（di）</h3></li>\n<li>实体类<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Students</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Address address;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String[] book;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; hobby;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,String&gt; card;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; game;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Properties info;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String wife;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Address</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String address;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>配置文件<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;address&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Address&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;student&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.pojo.Students&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        普通值注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;刘瀚中&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        bean注入，使用ref--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;address&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;address&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              数组注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;book&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>傲慢与偏见<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>呼啸山庄<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>瓦尔登湖<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              列表注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;hobby&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>傲慢与偏见<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>呼啸山庄<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>瓦尔登湖<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              map注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;card&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;饭卡&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;工资卡&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--              集合注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;game&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">value</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>&gt;</span>吃鸡<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">value</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>&gt;</span>lol<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        properties注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;administrator&quot;</span>&gt;</span>administrator@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;support&quot;</span>&gt;</span>support@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span>development@example.org<span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        null注入--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;wife&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">null</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">null</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"4-自动装配（autowiring）\"><a href=\"#4-自动装配（autowiring）\" class=\"headerlink\" title=\"4.自动装配（autowiring）\"></a>4.自动装配（autowiring）</h3>自动装配首先会根据name寻找对象，<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">People</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;1&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> age;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Cat cat;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"meta\">@Qualifier(value = &quot;dog1&quot;)</span><span class=\"comment\">//若dog对象不唯一，需设置类名</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Dog dog;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"line\">&lt;beans xmlns=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class=\"line\">       xmlns:xsi=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class=\"line\">       xmlns:context=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class=\"line\">       xsi:schemaLocation=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span><br><span class=\"line\"><span class=\"string\">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class=\"line\"><span class=\"string\">        http://www.springframework.org/schema/context</span></span><br><span class=\"line\"><span class=\"string\">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class=\"line\">    &lt;context:annotation-config/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;cat&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Cat&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;dog1&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;dog2&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.Dog&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;bean id=<span class=\"string\">&quot;people&quot;</span> class=<span class=\"string\">&quot;com.liu.pojo.People&quot;</span> autowire=<span class=\"string\">&quot;byName&quot;</span>/&gt;</span><br><span class=\"line\">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"5-注解编程\"><a href=\"#5-注解编程\" class=\"headerlink\" title=\"5.注解编程\"></a>5.注解编程</h3></li>\n<li>配置文件（xml）与注解并存<ul>\n<li>dao层：@Repository</li>\n<li>pojo层：@Component</li>\n<li>service：@Service</li>\n<li>Controller层：@Controller<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span> <span class=\"comment\">//等价于&lt;bean id=&quot;user&quot; class=&quot;com.liu.pojo.User&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"meta\">@Scope(&quot;singleton&quot;)</span><span class=\"comment\">//单例，prototype原型模式</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">User</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;lhz&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:annotation-config</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.liu&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    扫描包下的注解--&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"6-代理模式\"><a href=\"#6-代理模式\" class=\"headerlink\" title=\"6.代理模式\"></a>6.代理模式</h3><h3 id=\"7-面向切面编程-aop\"><a href=\"#7-面向切面编程-aop\" class=\"headerlink\" title=\"7.面向切面编程(aop)\"></a>7.面向切面编程(aop)</h3><p>面向切面编程，是在不改变原有代码的基础上，增强代码的功能。Spring-aop有三种实现方式。</p>\n<ul>\n<li>方法一：Spring原生API接口实现<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;userService&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.service.UserServiceImpl&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;afterLog&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.log.AfterLog&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;beforeLog&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.log.BeforeLog&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--方式1:原生Spring的API接口--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointcut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;afterLog&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;beforeLog&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n在一个包下建立以下两个类，分别作为执行前和执行后<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BeforeLog</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">MethodBeforeAdvice</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">(Method method, Object[] objects, Object target)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        System.out.println(target.getClass().getName()+<span class=\"string\">&quot;的&quot;</span>+method.getName()+<span class=\"string\">&quot;被执行了&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AfterLog</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">AfterReturningAdvice</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">afterReturning</span><span class=\"params\">(Object o, Method method, Object[] objects, Object o1)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;执行了&quot;</span>+method.getName()+<span class=\"string\">&quot;方法，返回结果为：&quot;</span>+o);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>方法二：使用自定义类<br>定义一个DiyPointCut类，在里面写after和before方法<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--方式2：自定义类--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;diy&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.diy.DiyPointCut&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--自定义切面--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:aspect</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;diy&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--切点--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointcut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--通知--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:before</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;before&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:after</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;after&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">aop:aspect</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DiyPointCut</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">after</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========方法执行后========&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========方法执行前========&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>方法三：使用注解<br>需在xml文件中开启注解<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--方式3--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:aspectj-autoproxy</span>/&gt;</span><span class=\"comment\">&lt;!--开启注解--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;annotationPointCut&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.diy.AnnotationPointCut&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Aspect</span><span class=\"comment\">//标记为切面</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AnnotationPointCut</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Before(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">before</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;===方法执行前===&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@After(&quot;execution(* com.liu.service.UserServiceImpl.*(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">after</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;===方法执行后===&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"8-Spring和MyBatis整合\"><a href=\"#8-Spring和MyBatis整合\" class=\"headerlink\" title=\"8.Spring和MyBatis整合\"></a>8.Spring和MyBatis整合</h3>需使用maven导入相应的jar包<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>8.0.18<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.5.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--测试--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.12<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--注解--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.18.10<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        spring依赖--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-webmvc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.2.3.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--        Spring操控数据库--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.2.3.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        aop织入包--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.aspectj<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aspectjweaver<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.9.5<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis-spring<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.0.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\nSpring-Mybatis使用Spring将Mybatis的配置整合，可以选择在原来的MyBatis-config文件中配置一些简单的Mapper注册和引用别名，在Spring-dao.xml文件中写各种配置，最后在applicationContext.xml文件中注册各个类。与Mybatis不同，Spring-Mybatis只能获得SqlSessionFactoryBean和SqlSessionTemplate。Spring-Mybatis有两种实现方式。</li>\n<li>第一种方式</li>\n</ul>\n<p>首先需要建立实体类，并建立接口和对应的xml文件，然后开始配置xml文件<br>MyBatis-config.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">configuration</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"string\">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    引用别名--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.liu.pojo&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>Spring-dao.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    datasource数据源--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/mybatis?useSSl=true<span class=\"symbol\">&amp;amp;</span>useUnicode=true<span class=\"symbol\">&amp;amp;</span>characterEncoding=utf-8&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;root&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!--    sqlSessionFactory--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        绑定MyBatis配置文件--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;configLocation&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 注册接口 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;mapperLocations&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;classpath:com/liu/dao/StudentsMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSession&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>applicationContext.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">import</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;spring-dao.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;studentsMapper&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.liu.dao.StudentsMapperImpl&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;sqlSession&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>在完成xml配置之后，一般可以建立一个接口的实现类，并在这个类获取sqlSession,在application文件中注册这个类，并将sqlSession通过set注入这个类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StudentsMapperImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">StudentsMapper</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> SqlSessionTemplate sqlSession;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setSqlSession</span><span class=\"params\">(SqlSessionTemplate sqlSession)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.sqlSession = sqlSession;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;Students&gt; <span class=\"title function_\">getStudents</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        StudentsMapper studentsMapper=sqlSession.getMapper(StudentsMapper.class);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> studentsMapper.getStudents();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后就可以进行测试</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">Test2</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">ApplicationContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(<span class=\"string\">&quot;applicationContext.xml&quot;</span>);<span class=\"comment\">//Spring配置文件</span></span><br><span class=\"line\">        StudentsMapper studentsMapper=context.getBean(<span class=\"string\">&quot;studentsMapper1&quot;</span>,StudentsMapper.class);<span class=\"comment\">//接口，获取实现类</span></span><br><span class=\"line\">        List&lt;Students&gt; list=studentsMapper.getStudents();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Students students : list) &#123;</span><br><span class=\"line\">            System.out.println(students);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>方法二<br>向接口的实现类注入sqlSeeeionFectory，该实现类需继承SqlSessionDaoSupport</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">StudentsMapperImpl2</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SqlSessionDaoSupport</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">StudentsMapper</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;Students&gt; <span class=\"title function_\">getStudents</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        StudentsMapper studentsMapper=getSqlSession().getMapper(StudentsMapper.class);<span class=\"comment\">//此处使用getSqlSession()</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> studentsMapper.getStudents();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注入sqlSessionFactory</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;bean id=<span class=\"string\">&quot;studentsMapper2&quot;</span> class=<span class=\"string\">&quot;com.liu.dao.StudentsMapperImpl2&quot;</span>&gt;</span><br><span class=\"line\">        &lt;property name=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> ref=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;/bean&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n"},{"title":"lc1653. Minimum Deletions to Make String Balanced","date":"2023-03-06T02:24:13.000Z","_content":"\n## Question\n\nYou are given a string s consisting only of characters 'a' and 'b'.\n\nYou can delete any number of characters in s to make s balanced. s is balanced if there is no pair of indices (i,j) such that i < j and s[i] = 'b' and s[j]= 'a'.\n\nReturn the minimum number of deletions needed to make s balanced.\n\n```\nExample 1:\nInput: s = \"aababbab\"\nOutput: 2\nExplanation: You can either:\nDelete the characters at 0-indexed positions 2 and 6 (\"aababbab\" -> \"aaabbb\"), or\nDelete the characters at 0-indexed positions 3 and 6 (\"aababbab\" -> \"aabbbb\").\n\nExample 2:\nInput: s = \"bbaaaaabb\"\nOutput: 2\nExplanation: The only solution is to delete the first two characters.\n\n```\n\n- `1 <= s.length <= 105`\n- `s[i]` is `'a'` or `'b'`.\n\n## My solution\n\nVery unfortunate, my solution is not the best solution.\n\n```java\nclass Solution {\n    public int minimumDeletions(String s) {\n        // The first way is to delete b before a\n        // The second option is to delete a after b\n        // In some conditions, I need to combine the two ways.\n        \n        // aababbab\n        // aaabbb\n        // aabbbb\n\n        // dp[i][1] end with a\n        // dp[i][2] end with b\n\n        // dp[i][1] = dp[i-1][1]                    (s[i]==a)\n        // dp[i][1] = dp[i-1][1]+1                  (s[i]==b)\n        // dp[i][2] = Min(dp[i-1][1],dp[i-1][2]+1)  (s[i]==a) \n        // dp[i][2] = Min(dp[i-1][1],dp[i-1][2])    (s[i]==b)\n\n        // ans = Min(dp[i][1],dp[i][2])\n      \n        int dp[][]=new int[s.length()+1][3];\n        for(int i=0;i<s.length();i++){\n            char c=s.charAt(i);\n            i++; //This avoids judging boundaries\n            if(c=='a'){\n                dp[i][1] = dp[i-1][1];\n                dp[i][2] = Math.min(dp[i-1][1],dp[i-1][2]+1);\n            }\n            else{\n                dp[i][1] = dp[i-1][1]+1;\n                dp[i][2] = Math.min(dp[i-1][1],dp[i-1][2]);\n            }\n\n            i--;\n\n        }\n        return Math.min(dp[s.length()][1],dp[s.length()][2]);\n\n\n    }\n}\n```\n\n\n\n## Best solution\n\n```java\nclass Solution {\n    public int minimumDeletions(String s) {\n        \n        // Delete all b to the left of this point\n        // Delete all a to the right of this point\n\n        // I just need to know the number of a to the left of any point.\n        // And i need to know the number of a and b in the whole string.\n       \n\n        int num_a=0,num_b=0;\n        for(int i=0;i<s.length();i++){\n            char c=s.charAt(i);\n            if(c=='a') num_a++;\n            \n        }\n        int con_a=0;\n        int ans=num_a;\n        for(int i=0;i<s.length();i++){\n             char c=s.charAt(i);\n            if(c=='a') num_a--;\n            else num_b++;\n\n            ans=Math.min(ans,num_a+num_b);\n\n        }\n\n        return ans;\n\n\n    }\n}\n```\n\n\n\n","source":"_posts/lc1653-Minimum-Deletions-to-Make-String-Balanced.md","raw":"---\ntitle: lc1653. Minimum Deletions to Make String Balanced\ndate: 2023-03-06 10:24:13\ntags:\n---\n\n## Question\n\nYou are given a string s consisting only of characters 'a' and 'b'.\n\nYou can delete any number of characters in s to make s balanced. s is balanced if there is no pair of indices (i,j) such that i < j and s[i] = 'b' and s[j]= 'a'.\n\nReturn the minimum number of deletions needed to make s balanced.\n\n```\nExample 1:\nInput: s = \"aababbab\"\nOutput: 2\nExplanation: You can either:\nDelete the characters at 0-indexed positions 2 and 6 (\"aababbab\" -> \"aaabbb\"), or\nDelete the characters at 0-indexed positions 3 and 6 (\"aababbab\" -> \"aabbbb\").\n\nExample 2:\nInput: s = \"bbaaaaabb\"\nOutput: 2\nExplanation: The only solution is to delete the first two characters.\n\n```\n\n- `1 <= s.length <= 105`\n- `s[i]` is `'a'` or `'b'`.\n\n## My solution\n\nVery unfortunate, my solution is not the best solution.\n\n```java\nclass Solution {\n    public int minimumDeletions(String s) {\n        // The first way is to delete b before a\n        // The second option is to delete a after b\n        // In some conditions, I need to combine the two ways.\n        \n        // aababbab\n        // aaabbb\n        // aabbbb\n\n        // dp[i][1] end with a\n        // dp[i][2] end with b\n\n        // dp[i][1] = dp[i-1][1]                    (s[i]==a)\n        // dp[i][1] = dp[i-1][1]+1                  (s[i]==b)\n        // dp[i][2] = Min(dp[i-1][1],dp[i-1][2]+1)  (s[i]==a) \n        // dp[i][2] = Min(dp[i-1][1],dp[i-1][2])    (s[i]==b)\n\n        // ans = Min(dp[i][1],dp[i][2])\n      \n        int dp[][]=new int[s.length()+1][3];\n        for(int i=0;i<s.length();i++){\n            char c=s.charAt(i);\n            i++; //This avoids judging boundaries\n            if(c=='a'){\n                dp[i][1] = dp[i-1][1];\n                dp[i][2] = Math.min(dp[i-1][1],dp[i-1][2]+1);\n            }\n            else{\n                dp[i][1] = dp[i-1][1]+1;\n                dp[i][2] = Math.min(dp[i-1][1],dp[i-1][2]);\n            }\n\n            i--;\n\n        }\n        return Math.min(dp[s.length()][1],dp[s.length()][2]);\n\n\n    }\n}\n```\n\n\n\n## Best solution\n\n```java\nclass Solution {\n    public int minimumDeletions(String s) {\n        \n        // Delete all b to the left of this point\n        // Delete all a to the right of this point\n\n        // I just need to know the number of a to the left of any point.\n        // And i need to know the number of a and b in the whole string.\n       \n\n        int num_a=0,num_b=0;\n        for(int i=0;i<s.length();i++){\n            char c=s.charAt(i);\n            if(c=='a') num_a++;\n            \n        }\n        int con_a=0;\n        int ans=num_a;\n        for(int i=0;i<s.length();i++){\n             char c=s.charAt(i);\n            if(c=='a') num_a--;\n            else num_b++;\n\n            ans=Math.min(ans,num_a+num_b);\n\n        }\n\n        return ans;\n\n\n    }\n}\n```\n\n\n\n","slug":"lc1653-Minimum-Deletions-to-Make-String-Balanced","published":1,"updated":"2023-03-06T02:53:14.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clewa511j00002lc9hcny7h34","content":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>You are given a string s consisting only of characters ‘a’ and ‘b’.</p>\n<p>You can delete any number of characters in s to make s balanced. s is balanced if there is no pair of indices (i,j) such that i &lt; j and s[i] = ‘b’ and s[j]= ‘a’.</p>\n<p>Return the minimum number of deletions needed to make s balanced.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: s = &quot;aababbab&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: You can either:</span><br><span class=\"line\">Delete the characters at 0-indexed positions 2 and 6 (&quot;aababbab&quot; -&gt; &quot;aaabbb&quot;), or</span><br><span class=\"line\">Delete the characters at 0-indexed positions 3 and 6 (&quot;aababbab&quot; -&gt; &quot;aabbbb&quot;).</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: s = &quot;bbaaaaabb&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: The only solution is to delete the first two characters.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>1 &lt;= s.length &lt;= 105</code></li>\n<li><code>s[i]</code> is <code>&#39;a&#39;</code> or <code>&#39;b&#39;</code>.</li>\n</ul>\n<h2 id=\"My-solution\"><a href=\"#My-solution\" class=\"headerlink\" title=\"My solution\"></a>My solution</h2><p>Very unfortunate, my solution is not the best solution.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">minimumDeletions</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// The first way is to delete b before a</span></span><br><span class=\"line\">        <span class=\"comment\">// The second option is to delete a after b</span></span><br><span class=\"line\">        <span class=\"comment\">// In some conditions, I need to combine the two ways.</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// aababbab</span></span><br><span class=\"line\">        <span class=\"comment\">// aaabbb</span></span><br><span class=\"line\">        <span class=\"comment\">// aabbbb</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] end with a</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] end with b</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] = dp[i-1][1]                    (s[i]==a)</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] = dp[i-1][1]+1                  (s[i]==b)</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2]+1)  (s[i]==a) </span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2])    (s[i]==b)</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ans = Min(dp[i][1],dp[i][2])</span></span><br><span class=\"line\">      </span><br><span class=\"line\">        <span class=\"type\">int</span> dp[][]=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[s.length()+<span class=\"number\">1</span>][<span class=\"number\">3</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            i++; <span class=\"comment\">//This avoids judging boundaries</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>)&#123;</span><br><span class=\"line\">                dp[i][<span class=\"number\">1</span>] = dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>];</span><br><span class=\"line\">                dp[i][<span class=\"number\">2</span>] = Math.min(dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>],dp[i-<span class=\"number\">1</span>][<span class=\"number\">2</span>]+<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                dp[i][<span class=\"number\">1</span>] = dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>]+<span class=\"number\">1</span>;</span><br><span class=\"line\">                dp[i][<span class=\"number\">2</span>] = Math.min(dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>],dp[i-<span class=\"number\">1</span>][<span class=\"number\">2</span>]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            i--;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Math.min(dp[s.length()][<span class=\"number\">1</span>],dp[s.length()][<span class=\"number\">2</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Best-solution\"><a href=\"#Best-solution\" class=\"headerlink\" title=\"Best solution\"></a>Best solution</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">minimumDeletions</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// Delete all b to the left of this point</span></span><br><span class=\"line\">        <span class=\"comment\">// Delete all a to the right of this point</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// I just need to know the number of a to the left of any point.</span></span><br><span class=\"line\">        <span class=\"comment\">// And i need to know the number of a and b in the whole string.</span></span><br><span class=\"line\">       </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> num_a=<span class=\"number\">0</span>,num_b=<span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>) num_a++;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> con_a=<span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> ans=num_a;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">             <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>) num_a--;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> num_b++;</span><br><span class=\"line\"></span><br><span class=\"line\">            ans=Math.min(ans,num_a+num_b);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>You are given a string s consisting only of characters ‘a’ and ‘b’.</p>\n<p>You can delete any number of characters in s to make s balanced. s is balanced if there is no pair of indices (i,j) such that i &lt; j and s[i] = ‘b’ and s[j]= ‘a’.</p>\n<p>Return the minimum number of deletions needed to make s balanced.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Example 1:</span><br><span class=\"line\">Input: s = &quot;aababbab&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: You can either:</span><br><span class=\"line\">Delete the characters at 0-indexed positions 2 and 6 (&quot;aababbab&quot; -&gt; &quot;aaabbb&quot;), or</span><br><span class=\"line\">Delete the characters at 0-indexed positions 3 and 6 (&quot;aababbab&quot; -&gt; &quot;aabbbb&quot;).</span><br><span class=\"line\"></span><br><span class=\"line\">Example 2:</span><br><span class=\"line\">Input: s = &quot;bbaaaaabb&quot;</span><br><span class=\"line\">Output: 2</span><br><span class=\"line\">Explanation: The only solution is to delete the first two characters.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>1 &lt;= s.length &lt;= 105</code></li>\n<li><code>s[i]</code> is <code>&#39;a&#39;</code> or <code>&#39;b&#39;</code>.</li>\n</ul>\n<h2 id=\"My-solution\"><a href=\"#My-solution\" class=\"headerlink\" title=\"My solution\"></a>My solution</h2><p>Very unfortunate, my solution is not the best solution.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">minimumDeletions</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// The first way is to delete b before a</span></span><br><span class=\"line\">        <span class=\"comment\">// The second option is to delete a after b</span></span><br><span class=\"line\">        <span class=\"comment\">// In some conditions, I need to combine the two ways.</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// aababbab</span></span><br><span class=\"line\">        <span class=\"comment\">// aaabbb</span></span><br><span class=\"line\">        <span class=\"comment\">// aabbbb</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] end with a</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] end with b</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] = dp[i-1][1]                    (s[i]==a)</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][1] = dp[i-1][1]+1                  (s[i]==b)</span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2]+1)  (s[i]==a) </span></span><br><span class=\"line\">        <span class=\"comment\">// dp[i][2] = Min(dp[i-1][1],dp[i-1][2])    (s[i]==b)</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ans = Min(dp[i][1],dp[i][2])</span></span><br><span class=\"line\">      </span><br><span class=\"line\">        <span class=\"type\">int</span> dp[][]=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[s.length()+<span class=\"number\">1</span>][<span class=\"number\">3</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            i++; <span class=\"comment\">//This avoids judging boundaries</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>)&#123;</span><br><span class=\"line\">                dp[i][<span class=\"number\">1</span>] = dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>];</span><br><span class=\"line\">                dp[i][<span class=\"number\">2</span>] = Math.min(dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>],dp[i-<span class=\"number\">1</span>][<span class=\"number\">2</span>]+<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                dp[i][<span class=\"number\">1</span>] = dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>]+<span class=\"number\">1</span>;</span><br><span class=\"line\">                dp[i][<span class=\"number\">2</span>] = Math.min(dp[i-<span class=\"number\">1</span>][<span class=\"number\">1</span>],dp[i-<span class=\"number\">1</span>][<span class=\"number\">2</span>]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            i--;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Math.min(dp[s.length()][<span class=\"number\">1</span>],dp[s.length()][<span class=\"number\">2</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Best-solution\"><a href=\"#Best-solution\" class=\"headerlink\" title=\"Best solution\"></a>Best solution</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">minimumDeletions</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// Delete all b to the left of this point</span></span><br><span class=\"line\">        <span class=\"comment\">// Delete all a to the right of this point</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// I just need to know the number of a to the left of any point.</span></span><br><span class=\"line\">        <span class=\"comment\">// And i need to know the number of a and b in the whole string.</span></span><br><span class=\"line\">       </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> num_a=<span class=\"number\">0</span>,num_b=<span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">            <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>) num_a++;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">int</span> con_a=<span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> ans=num_a;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;s.length();i++)&#123;</span><br><span class=\"line\">             <span class=\"type\">char</span> c=s.charAt(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;a&#x27;</span>) num_a--;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> num_b++;</span><br><span class=\"line\"></span><br><span class=\"line\">            ans=Math.min(ans,num_a+num_b);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n"},{"title":"ChatRepo handbook","date":"2023-03-07T12:01:27.000Z","_content":"\n# chatrepo\nChat with your github repo with ChatGPT in Github Actions\n\n```\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-08%2016.20.01.png\" width = 800 /> </div>\n```\n\n## 概述\n\nChatRepo，基于ChatGPT，使用Github app + Probot + Vercel构建。\n\n\n### 1）平台整体运行逻辑\n\n1. 配置好git app\n2. 用户提交issue\n3. 仓库触发app运行\n4. app向指定的webhook点，发用户的isseu相关参数\n5. vercel serverless平台启动服务，开始计算\n6. 最后把生成的答案写回issue\n\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.05.png\" width = 800 /> </div>\n\n\n### 2）开发者测逻辑\n\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.14.png\" width = 700 /> </div>\n\n\n对于开发者，为了搭建ChatRepo平台，需要完成以下几步：\n\n1. 申请一个Git App，git app只有公开和私有两种选项。由于chatrepo含有chatGPT token，因此不能公开，只能私有申请一个（此处webhook随便填一个）。\nhttps://github.com/settings/apps/new\n\n2. 创建ChatRepo仓库，里面放ChatRepo代码（这个我们已经有了）\n\n3. 在vercel平台，从github导入ChatRepo仓库，后续该平台会自动构建\n    https://vercel.com/new\n\n4. 此时，ChatRepo没有任何隐私数据（Git App的密钥和chatGPT token），因此需要在vercel平台的环境变量里加入：\n\n![截屏2023-03-07 20.24.53](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.24.53.png)\n\n![截屏2023-03-07 20.25.13](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.25.13.png)\n5. 重启vercel平台上的服务，载入环境变量\n\n6. 在Git App配置页面修改App的权限：\nhttps://github.com/settings/apps/[your app name]/permissions\n\n```\n        把这几项设置为可读写：\n        Commit statuses\n        Contents\n        Discussions\n        Issues\n```\n\n在事件处，勾选以下事件：\n\n![截屏2023-03-07 20.28.55](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.28.55.png)\n\n7. 此时Vercel平台会分配一个Domin，将app的webhook设置为：\n        domin+/api/github/webhooks\n\n![截屏2023-03-07 20.36.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.36.20.png)\n应该是类似这样的一个链接：https://chatbot-rosy.vercel.app/api/github/webhooks\n\n8. 安装Git App，选择需要ChatRepo的仓库\nhttps://github.com/settings/apps/[your app name]/installations\n\n9. 在仓库新建一个issue，进行测试。如果一切无误，则可以看到CharRepo上线自动回答\n```\n        格式：\n        /Bot xxxxx\n        和chat gpa普通聊天\n        /chatrepo xxxxx\n        询问charrepo仓库相关问题\n```\n\n## 3) 开发者模式\n\n开发过程中，不需要每次都进行部署，可以搭建一个本地开发环境：\n\n参考：https://probot.github.io/docs/development/#running-the-app-locally\n\n1.环境初始化\n\n```\nnpm install\nnpm start\n```\n\n2.根据提示，访问localhost:3000\n\n3.根据指示创建一个新的Git App\n\n4.此时，prebot会创建一个.env文件，在文件中添加：\n\n```\nGPT_KEY= [your chatGPT token]\n```\n不要将此文件上传到git\n\n5.参考第二章，设置app权限，并选择一个repo安装该app\n\n\n\n\n\n","source":"_posts/ChatRepo-handbook.md","raw":"---\ntitle: ChatRepo handbook\ndate: 2023-03-07 20:01:27\ntags:\n---\n\n# chatrepo\nChat with your github repo with ChatGPT in Github Actions\n\n```\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-08%2016.20.01.png\" width = 800 /> </div>\n```\n\n## 概述\n\nChatRepo，基于ChatGPT，使用Github app + Probot + Vercel构建。\n\n\n### 1）平台整体运行逻辑\n\n1. 配置好git app\n2. 用户提交issue\n3. 仓库触发app运行\n4. app向指定的webhook点，发用户的isseu相关参数\n5. vercel serverless平台启动服务，开始计算\n6. 最后把生成的答案写回issue\n\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.05.png\" width = 800 /> </div>\n\n\n### 2）开发者测逻辑\n\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.14.png\" width = 700 /> </div>\n\n\n对于开发者，为了搭建ChatRepo平台，需要完成以下几步：\n\n1. 申请一个Git App，git app只有公开和私有两种选项。由于chatrepo含有chatGPT token，因此不能公开，只能私有申请一个（此处webhook随便填一个）。\nhttps://github.com/settings/apps/new\n\n2. 创建ChatRepo仓库，里面放ChatRepo代码（这个我们已经有了）\n\n3. 在vercel平台，从github导入ChatRepo仓库，后续该平台会自动构建\n    https://vercel.com/new\n\n4. 此时，ChatRepo没有任何隐私数据（Git App的密钥和chatGPT token），因此需要在vercel平台的环境变量里加入：\n\n![截屏2023-03-07 20.24.53](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.24.53.png)\n\n![截屏2023-03-07 20.25.13](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.25.13.png)\n5. 重启vercel平台上的服务，载入环境变量\n\n6. 在Git App配置页面修改App的权限：\nhttps://github.com/settings/apps/[your app name]/permissions\n\n```\n        把这几项设置为可读写：\n        Commit statuses\n        Contents\n        Discussions\n        Issues\n```\n\n在事件处，勾选以下事件：\n\n![截屏2023-03-07 20.28.55](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.28.55.png)\n\n7. 此时Vercel平台会分配一个Domin，将app的webhook设置为：\n        domin+/api/github/webhooks\n\n![截屏2023-03-07 20.36.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.36.20.png)\n应该是类似这样的一个链接：https://chatbot-rosy.vercel.app/api/github/webhooks\n\n8. 安装Git App，选择需要ChatRepo的仓库\nhttps://github.com/settings/apps/[your app name]/installations\n\n9. 在仓库新建一个issue，进行测试。如果一切无误，则可以看到CharRepo上线自动回答\n```\n        格式：\n        /Bot xxxxx\n        和chat gpa普通聊天\n        /chatrepo xxxxx\n        询问charrepo仓库相关问题\n```\n\n## 3) 开发者模式\n\n开发过程中，不需要每次都进行部署，可以搭建一个本地开发环境：\n\n参考：https://probot.github.io/docs/development/#running-the-app-locally\n\n1.环境初始化\n\n```\nnpm install\nnpm start\n```\n\n2.根据提示，访问localhost:3000\n\n3.根据指示创建一个新的Git App\n\n4.此时，prebot会创建一个.env文件，在文件中添加：\n\n```\nGPT_KEY= [your chatGPT token]\n```\n不要将此文件上传到git\n\n5.参考第二章，设置app权限，并选择一个repo安装该app\n\n\n\n\n\n","slug":"ChatRepo-handbook","published":1,"updated":"2023-03-08T08:28:20.461Z","_id":"cley8jmav0000326f8lehd0c8","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"chatrepo\"><a href=\"#chatrepo\" class=\"headerlink\" title=\"chatrepo\"></a>chatrepo</h1><p>Chat with your github repo with ChatGPT in Github Actions</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-08%2016.20.01.png&quot; width = 800 /&gt; &lt;/div&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>ChatRepo，基于ChatGPT，使用Github app + Probot + Vercel构建。</p>\n<h3 id=\"1）平台整体运行逻辑\"><a href=\"#1）平台整体运行逻辑\" class=\"headerlink\" title=\"1）平台整体运行逻辑\"></a>1）平台整体运行逻辑</h3><ol>\n<li>配置好git app</li>\n<li>用户提交issue</li>\n<li>仓库触发app运行</li>\n<li>app向指定的webhook点，发用户的isseu相关参数</li>\n<li>vercel serverless平台启动服务，开始计算</li>\n<li>最后把生成的答案写回issue</li>\n</ol>\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.05.png\" width = 800 /> </div>\n\n\n<h3 id=\"2）开发者测逻辑\"><a href=\"#2）开发者测逻辑\" class=\"headerlink\" title=\"2）开发者测逻辑\"></a>2）开发者测逻辑</h3><div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.14.png\" width = 700 /> </div>\n\n\n<p>对于开发者，为了搭建ChatRepo平台，需要完成以下几步：</p>\n<ol>\n<li><p>申请一个Git App，git app只有公开和私有两种选项。由于chatrepo含有chatGPT token，因此不能公开，只能私有申请一个（此处webhook随便填一个）。<br><a href=\"https://github.com/settings/apps/new\">https://github.com/settings/apps/new</a></p>\n</li>\n<li><p>创建ChatRepo仓库，里面放ChatRepo代码（这个我们已经有了）</p>\n</li>\n<li><p>在vercel平台，从github导入ChatRepo仓库，后续该平台会自动构建<br> <a href=\"https://vercel.com/new\">https://vercel.com/new</a></p>\n</li>\n<li><p>此时，ChatRepo没有任何隐私数据（Git App的密钥和chatGPT token），因此需要在vercel平台的环境变量里加入：</p>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.24.53.png\" alt=\"截屏2023-03-07 20.24.53\"></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.25.13.png\" alt=\"截屏2023-03-07 20.25.13\"><br>5. 重启vercel平台上的服务，载入环境变量</p>\n<ol start=\"6\">\n<li>在Git App配置页面修改App的权限：<br><a href=\"https://github.com/settings/apps/[your\">https://github.com/settings/apps/[your</a> app name]/permissions</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">把这几项设置为可读写：</span><br><span class=\"line\">Commit statuses</span><br><span class=\"line\">Contents</span><br><span class=\"line\">Discussions</span><br><span class=\"line\">Issues</span><br></pre></td></tr></table></figure>\n\n<p>在事件处，勾选以下事件：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.28.55.png\" alt=\"截屏2023-03-07 20.28.55\"></p>\n<ol start=\"7\">\n<li>此时Vercel平台会分配一个Domin，将app的webhook设置为：<pre><code> domin+/api/github/webhooks\n</code></pre>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.36.20.png\" alt=\"截屏2023-03-07 20.36.20\"><br>应该是类似这样的一个链接：<a href=\"https://chatbot-rosy.vercel.app/api/github/webhooks\">https://chatbot-rosy.vercel.app/api/github/webhooks</a></p>\n<ol start=\"8\">\n<li><p>安装Git App，选择需要ChatRepo的仓库<br><a href=\"https://github.com/settings/apps/[your\">https://github.com/settings/apps/[your</a> app name]/installations</p>\n</li>\n<li><p>在仓库新建一个issue，进行测试。如果一切无误，则可以看到CharRepo上线自动回答</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">格式：</span><br><span class=\"line\">/Bot xxxxx</span><br><span class=\"line\">和chat gpa普通聊天</span><br><span class=\"line\">/chatrepo xxxxx</span><br><span class=\"line\">询问charrepo仓库相关问题</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"3-开发者模式\"><a href=\"#3-开发者模式\" class=\"headerlink\" title=\"3) 开发者模式\"></a>3) 开发者模式</h2><p>开发过程中，不需要每次都进行部署，可以搭建一个本地开发环境：</p>\n<p>参考：<a href=\"https://probot.github.io/docs/development/#running-the-app-locally\">https://probot.github.io/docs/development/#running-the-app-locally</a></p>\n<p>1.环境初始化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br><span class=\"line\">npm start</span><br></pre></td></tr></table></figure>\n\n<p>2.根据提示，访问localhost:3000</p>\n<p>3.根据指示创建一个新的Git App</p>\n<p>4.此时，prebot会创建一个.env文件，在文件中添加：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GPT_KEY= [your chatGPT token]</span><br></pre></td></tr></table></figure>\n<p>不要将此文件上传到git</p>\n<p>5.参考第二章，设置app权限，并选择一个repo安装该app</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"chatrepo\"><a href=\"#chatrepo\" class=\"headerlink\" title=\"chatrepo\"></a>chatrepo</h1><p>Chat with your github repo with ChatGPT in Github Actions</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-08%2016.20.01.png&quot; width = 800 /&gt; &lt;/div&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>ChatRepo，基于ChatGPT，使用Github app + Probot + Vercel构建。</p>\n<h3 id=\"1）平台整体运行逻辑\"><a href=\"#1）平台整体运行逻辑\" class=\"headerlink\" title=\"1）平台整体运行逻辑\"></a>1）平台整体运行逻辑</h3><ol>\n<li>配置好git app</li>\n<li>用户提交issue</li>\n<li>仓库触发app运行</li>\n<li>app向指定的webhook点，发用户的isseu相关参数</li>\n<li>vercel serverless平台启动服务，开始计算</li>\n<li>最后把生成的答案写回issue</li>\n</ol>\n<div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.05.png\" width = 800 /> </div>\n\n\n<h3 id=\"2）开发者测逻辑\"><a href=\"#2）开发者测逻辑\" class=\"headerlink\" title=\"2）开发者测逻辑\"></a>2）开发者测逻辑</h3><div align=\"center\"> <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2023.02.14.png\" width = 700 /> </div>\n\n\n<p>对于开发者，为了搭建ChatRepo平台，需要完成以下几步：</p>\n<ol>\n<li><p>申请一个Git App，git app只有公开和私有两种选项。由于chatrepo含有chatGPT token，因此不能公开，只能私有申请一个（此处webhook随便填一个）。<br><a href=\"https://github.com/settings/apps/new\">https://github.com/settings/apps/new</a></p>\n</li>\n<li><p>创建ChatRepo仓库，里面放ChatRepo代码（这个我们已经有了）</p>\n</li>\n<li><p>在vercel平台，从github导入ChatRepo仓库，后续该平台会自动构建<br> <a href=\"https://vercel.com/new\">https://vercel.com/new</a></p>\n</li>\n<li><p>此时，ChatRepo没有任何隐私数据（Git App的密钥和chatGPT token），因此需要在vercel平台的环境变量里加入：</p>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.24.53.png\" alt=\"截屏2023-03-07 20.24.53\"></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.25.13.png\" alt=\"截屏2023-03-07 20.25.13\"><br>5. 重启vercel平台上的服务，载入环境变量</p>\n<ol start=\"6\">\n<li>在Git App配置页面修改App的权限：<br><a href=\"https://github.com/settings/apps/[your\">https://github.com/settings/apps/[your</a> app name]/permissions</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">把这几项设置为可读写：</span><br><span class=\"line\">Commit statuses</span><br><span class=\"line\">Contents</span><br><span class=\"line\">Discussions</span><br><span class=\"line\">Issues</span><br></pre></td></tr></table></figure>\n\n<p>在事件处，勾选以下事件：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.28.55.png\" alt=\"截屏2023-03-07 20.28.55\"></p>\n<ol start=\"7\">\n<li>此时Vercel平台会分配一个Domin，将app的webhook设置为：<pre><code> domin+/api/github/webhooks\n</code></pre>\n</li>\n</ol>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-07%2020.36.20.png\" alt=\"截屏2023-03-07 20.36.20\"><br>应该是类似这样的一个链接：<a href=\"https://chatbot-rosy.vercel.app/api/github/webhooks\">https://chatbot-rosy.vercel.app/api/github/webhooks</a></p>\n<ol start=\"8\">\n<li><p>安装Git App，选择需要ChatRepo的仓库<br><a href=\"https://github.com/settings/apps/[your\">https://github.com/settings/apps/[your</a> app name]/installations</p>\n</li>\n<li><p>在仓库新建一个issue，进行测试。如果一切无误，则可以看到CharRepo上线自动回答</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">格式：</span><br><span class=\"line\">/Bot xxxxx</span><br><span class=\"line\">和chat gpa普通聊天</span><br><span class=\"line\">/chatrepo xxxxx</span><br><span class=\"line\">询问charrepo仓库相关问题</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"3-开发者模式\"><a href=\"#3-开发者模式\" class=\"headerlink\" title=\"3) 开发者模式\"></a>3) 开发者模式</h2><p>开发过程中，不需要每次都进行部署，可以搭建一个本地开发环境：</p>\n<p>参考：<a href=\"https://probot.github.io/docs/development/#running-the-app-locally\">https://probot.github.io/docs/development/#running-the-app-locally</a></p>\n<p>1.环境初始化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br><span class=\"line\">npm start</span><br></pre></td></tr></table></figure>\n\n<p>2.根据提示，访问localhost:3000</p>\n<p>3.根据指示创建一个新的Git App</p>\n<p>4.此时，prebot会创建一个.env文件，在文件中添加：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GPT_KEY= [your chatGPT token]</span><br></pre></td></tr></table></figure>\n<p>不要将此文件上传到git</p>\n<p>5.参考第二章，设置app权限，并选择一个repo安装该app</p>\n"},{"title":"Postcopy & user-fault & WASM","date":"2023-03-09T03:28:15.000Z","_content":"\n## Migration of WebAssembly runtime by Postcopy\n\nUser space page fault在Live migration of virtual machines已经有大量运用（KVM，OpenStack，CRIU Lazy migration），这一思路被称为Postcopy。目前尚未发现这一技术应用于WASM runtime的状态迁移。结合Mitosis的先例，或许Postcopy技术可以良好的与WASM runtime结合，从而实现可以快速大量启动实例的Serverless平台。\n\n（目前只找到了一篇21年的论文，其中提到了他们计划结合Postcopy+wasm做边缘计算。但是他们目前还没有发表相关后续进展，不知道是因为他们没有继续深入，还是遇到了障碍）\n\n## 设计方案\n\n![截屏2023-03-10 10.34.24](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-10%2010.34.24.png)\n\nSteps：\n\n1. Running node启动，从Memory node获取除内存外的全部数据\n2. Running node初始化虚拟机内存（不进行映射），将这些内存标记为userfault\n3. Running node运行，若access到了未被分配的page，则触发page fault\n4. 内核识别到该页为userfault page，将发生错误的地址发送给用户态的handle\n5. handle使用XQUIC获取Memory node中相应的page，初始化该page\n6. WASM runtime被唤醒，继续运行\n\n结合Postcopy+WASM技术，应该可以实现优于原生Faasm，优于CRIU，但慢于MITOSIS的一种启动策略。同时这一策略会比MITOSIS有更好的通用性。\n\n此外，Postcopy+WASM比起Mitosis和CRIU这类“容器迁移”工具有一个优势，这两种技术在迁移容器的过程中，都不可避免带有一些“死重”，即容器本身运行时相关的上下文。而Postcopy+WASM只需动态迁移和程序负载本身相关的Page，因此或许可以在一定条件下取得一定优势。\n\nFollow Up：\n\n1.由于WASM虚拟机内，各种模块大小已知，或许可以根据这个做一些规划算法\n\n2.将部分工作放入eBPF虚拟机，从而实现加速\n\n## 模拟测试\n\n代码仓库：https://github.com/muchengl/userfault-test.git\n\n编写代码进行模拟测试，本代码分为Server端和Client端。Server端对应Memory Node，Client端对应Running Node。\n\n**Server端**使用malloc申请内存，并进行初始化。**Client端**使用mmap初始化内存，将fd参数设置为-1，从而获得大量未被映射的内存。并将这些内存标记为UFFD_EVENT_PAGEFAULT，即内核应将该内存的Page fault交给用户处理。Client端开启一个fault触发线程，不断按顺序access page，触发page fault。client端监听描述符uffd，获取内核传来的user fault信息，并通过udp协议，从server端获取相应的page，进行内存初始化。\n\n在两台Ali Cloud云服务器之间进行测试，Ununtu 20.04系统，1G内存，2核CPU，在同一虚拟子网内使用UDP进行数据传输，每组测量进行10次，取CPU运行时间的平均值。可以发现，远程拷贝总时间与页数呈正比。在拷贝内存为100M时（25000页），较优情况下需要约0.97秒的时间。\n\n| 字段名称 | 含义 |\n| :----:| :---: |\n| Fault process time | Fault触发线程的总运行时间，也就是负载代码的实际运行时间 |\n|     Init time      |                      Client端初始化时间                      |\n|      IO time       |    等待内核通过fd传输User Fault相关信息的时间（poll轮询）    |\n|    Network time    |                       UDP协议通信时间                        |\n|    Server time     |            Server端获取page，并通过UDP发送的时间             |\n|    Handle time     | 获取到远程页后，初始化内存，并对远程页中的数据进行拷贝的时间 |\n|     Total time     | Total time=Network + Server + Handle + IO + Init<br />用于证明Network、Server、Handle、IO、Init可代表整个运行流程 |\n\n经计算：Fault process time ≈ Total time\n\n![截屏2023-03-13 14.03.01](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2014.03.01.png)\n\n数据分析和总结：\n\n- Network占用了约7%的时间，真实环境下由于不会使用UDP，这一时间占比可能会更大。\n\n- IO time占比较大，为53%，这一时间在本地虚拟机测试中显著降低，因此或与CPU性能有较大关系。\n\n    (本测试中，使用的是阿里云的玩具级服务器，cpu主频和内存读写速度可能被限制了)\n\n- 数据读取和拷贝部分（Server、Handle），占用了40%左右的时间。对比MITOSIS，misosis使用rdma避免了在server端的内存拷贝，因此会慢于misosis。\n\n- 本测试中，测试负载为“按顺序访问内存”，这一测试与真实环境有较大区别，因此不能代表将Postcopy实际引入wasm后的实际性能。\n\n![截屏2023-03-13 11.30.41](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2011.30.41.png)\n\n附数据：\n\n![截屏2023-03-13 12.37.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2012.37.29.png)\n\n\n\n## 资料收集\n\nUser space page fault handling相关早期文章：\nhttps://lwn.net/Articles/550555/\nhttps://lwn.net/Articles/615086/\n\n### Postcopy原始论文：\nhttps://kartikgopalan.github.io/publications/hines09postcopy.pdf\n\n\n\n### CRIU Lazy migration:\n\nhttps://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers\nhttps://criu.org/Lazy_migration\nhttps://lisas.de/~adrian/pdf/lazy-process-migration.pdf\n\n\n\n### Postcopy在kvm的应用：\nhttps://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja\n\n![截屏2023-03-09 22.10.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2022.10.22.png)\n\n\n\nRedHat在KVM迁移中的实践ppt：\nhttp://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf\nhttps://wiki.qemu.org/Features/PostCopyLiveMigration\n\n![截屏2023-03-09 17.42.42](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2017.42.42.png)\n\n1. 线程1访问了一个未被映射的page，发生userfault\n    get_user_pages_locked()\n    get_user_pages_unlocked() \n    这两个函数可以避免内核处理fault，而是交给用户线程处理\n2. 线程2收到内核的通知——userfault在某个地址被触发了\n3. 线程2将此page从“memory node”传输过来（这和mitosis的“seed”很类似）\n4. 线程2将发生错误的page进行映射 \n    remap_anon_pages()\n5. 线程2告知内核，内核唤醒线程1\n6. 线程1尝试访问fault page，并继续执行下去\n\n### Ubuntu对userfaultfd的支持\n\nhttps://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html\n\n![img](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/flow.png)\n\n","source":"_posts/User-space-page-fault-handling.md","raw":"---\ntitle: Postcopy & user-fault & WASM\ndate: 2023-03-09 11:28:15\ntags:\n---\n\n## Migration of WebAssembly runtime by Postcopy\n\nUser space page fault在Live migration of virtual machines已经有大量运用（KVM，OpenStack，CRIU Lazy migration），这一思路被称为Postcopy。目前尚未发现这一技术应用于WASM runtime的状态迁移。结合Mitosis的先例，或许Postcopy技术可以良好的与WASM runtime结合，从而实现可以快速大量启动实例的Serverless平台。\n\n（目前只找到了一篇21年的论文，其中提到了他们计划结合Postcopy+wasm做边缘计算。但是他们目前还没有发表相关后续进展，不知道是因为他们没有继续深入，还是遇到了障碍）\n\n## 设计方案\n\n![截屏2023-03-10 10.34.24](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-10%2010.34.24.png)\n\nSteps：\n\n1. Running node启动，从Memory node获取除内存外的全部数据\n2. Running node初始化虚拟机内存（不进行映射），将这些内存标记为userfault\n3. Running node运行，若access到了未被分配的page，则触发page fault\n4. 内核识别到该页为userfault page，将发生错误的地址发送给用户态的handle\n5. handle使用XQUIC获取Memory node中相应的page，初始化该page\n6. WASM runtime被唤醒，继续运行\n\n结合Postcopy+WASM技术，应该可以实现优于原生Faasm，优于CRIU，但慢于MITOSIS的一种启动策略。同时这一策略会比MITOSIS有更好的通用性。\n\n此外，Postcopy+WASM比起Mitosis和CRIU这类“容器迁移”工具有一个优势，这两种技术在迁移容器的过程中，都不可避免带有一些“死重”，即容器本身运行时相关的上下文。而Postcopy+WASM只需动态迁移和程序负载本身相关的Page，因此或许可以在一定条件下取得一定优势。\n\nFollow Up：\n\n1.由于WASM虚拟机内，各种模块大小已知，或许可以根据这个做一些规划算法\n\n2.将部分工作放入eBPF虚拟机，从而实现加速\n\n## 模拟测试\n\n代码仓库：https://github.com/muchengl/userfault-test.git\n\n编写代码进行模拟测试，本代码分为Server端和Client端。Server端对应Memory Node，Client端对应Running Node。\n\n**Server端**使用malloc申请内存，并进行初始化。**Client端**使用mmap初始化内存，将fd参数设置为-1，从而获得大量未被映射的内存。并将这些内存标记为UFFD_EVENT_PAGEFAULT，即内核应将该内存的Page fault交给用户处理。Client端开启一个fault触发线程，不断按顺序access page，触发page fault。client端监听描述符uffd，获取内核传来的user fault信息，并通过udp协议，从server端获取相应的page，进行内存初始化。\n\n在两台Ali Cloud云服务器之间进行测试，Ununtu 20.04系统，1G内存，2核CPU，在同一虚拟子网内使用UDP进行数据传输，每组测量进行10次，取CPU运行时间的平均值。可以发现，远程拷贝总时间与页数呈正比。在拷贝内存为100M时（25000页），较优情况下需要约0.97秒的时间。\n\n| 字段名称 | 含义 |\n| :----:| :---: |\n| Fault process time | Fault触发线程的总运行时间，也就是负载代码的实际运行时间 |\n|     Init time      |                      Client端初始化时间                      |\n|      IO time       |    等待内核通过fd传输User Fault相关信息的时间（poll轮询）    |\n|    Network time    |                       UDP协议通信时间                        |\n|    Server time     |            Server端获取page，并通过UDP发送的时间             |\n|    Handle time     | 获取到远程页后，初始化内存，并对远程页中的数据进行拷贝的时间 |\n|     Total time     | Total time=Network + Server + Handle + IO + Init<br />用于证明Network、Server、Handle、IO、Init可代表整个运行流程 |\n\n经计算：Fault process time ≈ Total time\n\n![截屏2023-03-13 14.03.01](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2014.03.01.png)\n\n数据分析和总结：\n\n- Network占用了约7%的时间，真实环境下由于不会使用UDP，这一时间占比可能会更大。\n\n- IO time占比较大，为53%，这一时间在本地虚拟机测试中显著降低，因此或与CPU性能有较大关系。\n\n    (本测试中，使用的是阿里云的玩具级服务器，cpu主频和内存读写速度可能被限制了)\n\n- 数据读取和拷贝部分（Server、Handle），占用了40%左右的时间。对比MITOSIS，misosis使用rdma避免了在server端的内存拷贝，因此会慢于misosis。\n\n- 本测试中，测试负载为“按顺序访问内存”，这一测试与真实环境有较大区别，因此不能代表将Postcopy实际引入wasm后的实际性能。\n\n![截屏2023-03-13 11.30.41](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2011.30.41.png)\n\n附数据：\n\n![截屏2023-03-13 12.37.29](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2012.37.29.png)\n\n\n\n## 资料收集\n\nUser space page fault handling相关早期文章：\nhttps://lwn.net/Articles/550555/\nhttps://lwn.net/Articles/615086/\n\n### Postcopy原始论文：\nhttps://kartikgopalan.github.io/publications/hines09postcopy.pdf\n\n\n\n### CRIU Lazy migration:\n\nhttps://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers\nhttps://criu.org/Lazy_migration\nhttps://lisas.de/~adrian/pdf/lazy-process-migration.pdf\n\n\n\n### Postcopy在kvm的应用：\nhttps://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja\n\n![截屏2023-03-09 22.10.22](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2022.10.22.png)\n\n\n\nRedHat在KVM迁移中的实践ppt：\nhttp://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf\nhttps://wiki.qemu.org/Features/PostCopyLiveMigration\n\n![截屏2023-03-09 17.42.42](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2017.42.42.png)\n\n1. 线程1访问了一个未被映射的page，发生userfault\n    get_user_pages_locked()\n    get_user_pages_unlocked() \n    这两个函数可以避免内核处理fault，而是交给用户线程处理\n2. 线程2收到内核的通知——userfault在某个地址被触发了\n3. 线程2将此page从“memory node”传输过来（这和mitosis的“seed”很类似）\n4. 线程2将发生错误的page进行映射 \n    remap_anon_pages()\n5. 线程2告知内核，内核唤醒线程1\n6. 线程1尝试访问fault page，并继续执行下去\n\n### Ubuntu对userfaultfd的支持\n\nhttps://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html\n\n![img](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/flow.png)\n\n","slug":"User-space-page-fault-handling","published":1,"updated":"2023-03-19T09:07:53.577Z","_id":"clf0ziv4d00000t6fec24gm7l","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"Migration-of-WebAssembly-runtime-by-Postcopy\"><a href=\"#Migration-of-WebAssembly-runtime-by-Postcopy\" class=\"headerlink\" title=\"Migration of WebAssembly runtime by Postcopy\"></a>Migration of WebAssembly runtime by Postcopy</h2><p>User space page fault在Live migration of virtual machines已经有大量运用（KVM，OpenStack，CRIU Lazy migration），这一思路被称为Postcopy。目前尚未发现这一技术应用于WASM runtime的状态迁移。结合Mitosis的先例，或许Postcopy技术可以良好的与WASM runtime结合，从而实现可以快速大量启动实例的Serverless平台。</p>\n<p>（目前只找到了一篇21年的论文，其中提到了他们计划结合Postcopy+wasm做边缘计算。但是他们目前还没有发表相关后续进展，不知道是因为他们没有继续深入，还是遇到了障碍）</p>\n<h2 id=\"设计方案\"><a href=\"#设计方案\" class=\"headerlink\" title=\"设计方案\"></a>设计方案</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-10%2010.34.24.png\" alt=\"截屏2023-03-10 10.34.24\"></p>\n<p>Steps：</p>\n<ol>\n<li>Running node启动，从Memory node获取除内存外的全部数据</li>\n<li>Running node初始化虚拟机内存（不进行映射），将这些内存标记为userfault</li>\n<li>Running node运行，若access到了未被分配的page，则触发page fault</li>\n<li>内核识别到该页为userfault page，将发生错误的地址发送给用户态的handle</li>\n<li>handle使用XQUIC获取Memory node中相应的page，初始化该page</li>\n<li>WASM runtime被唤醒，继续运行</li>\n</ol>\n<p>结合Postcopy+WASM技术，应该可以实现优于原生Faasm，优于CRIU，但慢于MITOSIS的一种启动策略。同时这一策略会比MITOSIS有更好的通用性。</p>\n<p>此外，Postcopy+WASM比起Mitosis和CRIU这类“容器迁移”工具有一个优势，这两种技术在迁移容器的过程中，都不可避免带有一些“死重”，即容器本身运行时相关的上下文。而Postcopy+WASM只需动态迁移和程序负载本身相关的Page，因此或许可以在一定条件下取得一定优势。</p>\n<p>Follow Up：</p>\n<p>1.由于WASM虚拟机内，各种模块大小已知，或许可以根据这个做一些规划算法</p>\n<p>2.将部分工作放入eBPF虚拟机，从而实现加速</p>\n<h2 id=\"模拟测试\"><a href=\"#模拟测试\" class=\"headerlink\" title=\"模拟测试\"></a>模拟测试</h2><p>代码仓库：<a href=\"https://github.com/muchengl/userfault-test.git\">https://github.com/muchengl/userfault-test.git</a></p>\n<p>编写代码进行模拟测试，本代码分为Server端和Client端。Server端对应Memory Node，Client端对应Running Node。</p>\n<p><strong>Server端</strong>使用malloc申请内存，并进行初始化。<strong>Client端</strong>使用mmap初始化内存，将fd参数设置为-1，从而获得大量未被映射的内存。并将这些内存标记为UFFD_EVENT_PAGEFAULT，即内核应将该内存的Page fault交给用户处理。Client端开启一个fault触发线程，不断按顺序access page，触发page fault。client端监听描述符uffd，获取内核传来的user fault信息，并通过udp协议，从server端获取相应的page，进行内存初始化。</p>\n<p>在两台Ali Cloud云服务器之间进行测试，Ununtu 20.04系统，1G内存，2核CPU，在同一虚拟子网内使用UDP进行数据传输，每组测量进行10次，取CPU运行时间的平均值。可以发现，远程拷贝总时间与页数呈正比。在拷贝内存为100M时（25000页），较优情况下需要约0.97秒的时间。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">字段名称</th>\n<th align=\"center\">含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Fault process time</td>\n<td align=\"center\">Fault触发线程的总运行时间，也就是负载代码的实际运行时间</td>\n</tr>\n<tr>\n<td align=\"center\">Init time</td>\n<td align=\"center\">Client端初始化时间</td>\n</tr>\n<tr>\n<td align=\"center\">IO time</td>\n<td align=\"center\">等待内核通过fd传输User Fault相关信息的时间（poll轮询）</td>\n</tr>\n<tr>\n<td align=\"center\">Network time</td>\n<td align=\"center\">UDP协议通信时间</td>\n</tr>\n<tr>\n<td align=\"center\">Server time</td>\n<td align=\"center\">Server端获取page，并通过UDP发送的时间</td>\n</tr>\n<tr>\n<td align=\"center\">Handle time</td>\n<td align=\"center\">获取到远程页后，初始化内存，并对远程页中的数据进行拷贝的时间</td>\n</tr>\n<tr>\n<td align=\"center\">Total time</td>\n<td align=\"center\">Total time=Network + Server + Handle + IO + Init<br />用于证明Network、Server、Handle、IO、Init可代表整个运行流程</td>\n</tr>\n</tbody></table>\n<p>经计算：Fault process time ≈ Total time</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2014.03.01.png\" alt=\"截屏2023-03-13 14.03.01\"></p>\n<p>数据分析和总结：</p>\n<ul>\n<li><p>Network占用了约7%的时间，真实环境下由于不会使用UDP，这一时间占比可能会更大。</p>\n</li>\n<li><p>IO time占比较大，为53%，这一时间在本地虚拟机测试中显著降低，因此或与CPU性能有较大关系。</p>\n<p>  (本测试中，使用的是阿里云的玩具级服务器，cpu主频和内存读写速度可能被限制了)</p>\n</li>\n<li><p>数据读取和拷贝部分（Server、Handle），占用了40%左右的时间。对比MITOSIS，misosis使用rdma避免了在server端的内存拷贝，因此会慢于misosis。</p>\n</li>\n<li><p>本测试中，测试负载为“按顺序访问内存”，这一测试与真实环境有较大区别，因此不能代表将Postcopy实际引入wasm后的实际性能。</p>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2011.30.41.png\" alt=\"截屏2023-03-13 11.30.41\"></p>\n<p>附数据：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2012.37.29.png\" alt=\"截屏2023-03-13 12.37.29\"></p>\n<h2 id=\"资料收集\"><a href=\"#资料收集\" class=\"headerlink\" title=\"资料收集\"></a>资料收集</h2><p>User space page fault handling相关早期文章：<br><a href=\"https://lwn.net/Articles/550555/\">https://lwn.net/Articles/550555/</a><br><a href=\"https://lwn.net/Articles/615086/\">https://lwn.net/Articles/615086/</a></p>\n<h3 id=\"Postcopy原始论文：\"><a href=\"#Postcopy原始论文：\" class=\"headerlink\" title=\"Postcopy原始论文：\"></a>Postcopy原始论文：</h3><p><a href=\"https://kartikgopalan.github.io/publications/hines09postcopy.pdf\">https://kartikgopalan.github.io/publications/hines09postcopy.pdf</a></p>\n<h3 id=\"CRIU-Lazy-migration\"><a href=\"#CRIU-Lazy-migration\" class=\"headerlink\" title=\"CRIU Lazy migration:\"></a>CRIU Lazy migration:</h3><p><a href=\"https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers\">https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers</a><br><a href=\"https://criu.org/Lazy_migration\">https://criu.org/Lazy_migration</a><br><a href=\"https://lisas.de/~adrian/pdf/lazy-process-migration.pdf\">https://lisas.de/~adrian/pdf/lazy-process-migration.pdf</a></p>\n<h3 id=\"Postcopy在kvm的应用：\"><a href=\"#Postcopy在kvm的应用：\" class=\"headerlink\" title=\"Postcopy在kvm的应用：\"></a>Postcopy在kvm的应用：</h3><p><a href=\"https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja\">https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2022.10.22.png\" alt=\"截屏2023-03-09 22.10.22\"></p>\n<p>RedHat在KVM迁移中的实践ppt：<br><a href=\"http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf\">http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf</a><br><a href=\"https://wiki.qemu.org/Features/PostCopyLiveMigration\">https://wiki.qemu.org/Features/PostCopyLiveMigration</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2017.42.42.png\" alt=\"截屏2023-03-09 17.42.42\"></p>\n<ol>\n<li>线程1访问了一个未被映射的page，发生userfault<br> get_user_pages_locked()<br> get_user_pages_unlocked()<br> 这两个函数可以避免内核处理fault，而是交给用户线程处理</li>\n<li>线程2收到内核的通知——userfault在某个地址被触发了</li>\n<li>线程2将此page从“memory node”传输过来（这和mitosis的“seed”很类似）</li>\n<li>线程2将发生错误的page进行映射<br> remap_anon_pages()</li>\n<li>线程2告知内核，内核唤醒线程1</li>\n<li>线程1尝试访问fault page，并继续执行下去</li>\n</ol>\n<h3 id=\"Ubuntu对userfaultfd的支持\"><a href=\"#Ubuntu对userfaultfd的支持\" class=\"headerlink\" title=\"Ubuntu对userfaultfd的支持\"></a>Ubuntu对userfaultfd的支持</h3><p><a href=\"https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html\">https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/flow.png\" alt=\"img\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Migration-of-WebAssembly-runtime-by-Postcopy\"><a href=\"#Migration-of-WebAssembly-runtime-by-Postcopy\" class=\"headerlink\" title=\"Migration of WebAssembly runtime by Postcopy\"></a>Migration of WebAssembly runtime by Postcopy</h2><p>User space page fault在Live migration of virtual machines已经有大量运用（KVM，OpenStack，CRIU Lazy migration），这一思路被称为Postcopy。目前尚未发现这一技术应用于WASM runtime的状态迁移。结合Mitosis的先例，或许Postcopy技术可以良好的与WASM runtime结合，从而实现可以快速大量启动实例的Serverless平台。</p>\n<p>（目前只找到了一篇21年的论文，其中提到了他们计划结合Postcopy+wasm做边缘计算。但是他们目前还没有发表相关后续进展，不知道是因为他们没有继续深入，还是遇到了障碍）</p>\n<h2 id=\"设计方案\"><a href=\"#设计方案\" class=\"headerlink\" title=\"设计方案\"></a>设计方案</h2><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-10%2010.34.24.png\" alt=\"截屏2023-03-10 10.34.24\"></p>\n<p>Steps：</p>\n<ol>\n<li>Running node启动，从Memory node获取除内存外的全部数据</li>\n<li>Running node初始化虚拟机内存（不进行映射），将这些内存标记为userfault</li>\n<li>Running node运行，若access到了未被分配的page，则触发page fault</li>\n<li>内核识别到该页为userfault page，将发生错误的地址发送给用户态的handle</li>\n<li>handle使用XQUIC获取Memory node中相应的page，初始化该page</li>\n<li>WASM runtime被唤醒，继续运行</li>\n</ol>\n<p>结合Postcopy+WASM技术，应该可以实现优于原生Faasm，优于CRIU，但慢于MITOSIS的一种启动策略。同时这一策略会比MITOSIS有更好的通用性。</p>\n<p>此外，Postcopy+WASM比起Mitosis和CRIU这类“容器迁移”工具有一个优势，这两种技术在迁移容器的过程中，都不可避免带有一些“死重”，即容器本身运行时相关的上下文。而Postcopy+WASM只需动态迁移和程序负载本身相关的Page，因此或许可以在一定条件下取得一定优势。</p>\n<p>Follow Up：</p>\n<p>1.由于WASM虚拟机内，各种模块大小已知，或许可以根据这个做一些规划算法</p>\n<p>2.将部分工作放入eBPF虚拟机，从而实现加速</p>\n<h2 id=\"模拟测试\"><a href=\"#模拟测试\" class=\"headerlink\" title=\"模拟测试\"></a>模拟测试</h2><p>代码仓库：<a href=\"https://github.com/muchengl/userfault-test.git\">https://github.com/muchengl/userfault-test.git</a></p>\n<p>编写代码进行模拟测试，本代码分为Server端和Client端。Server端对应Memory Node，Client端对应Running Node。</p>\n<p><strong>Server端</strong>使用malloc申请内存，并进行初始化。<strong>Client端</strong>使用mmap初始化内存，将fd参数设置为-1，从而获得大量未被映射的内存。并将这些内存标记为UFFD_EVENT_PAGEFAULT，即内核应将该内存的Page fault交给用户处理。Client端开启一个fault触发线程，不断按顺序access page，触发page fault。client端监听描述符uffd，获取内核传来的user fault信息，并通过udp协议，从server端获取相应的page，进行内存初始化。</p>\n<p>在两台Ali Cloud云服务器之间进行测试，Ununtu 20.04系统，1G内存，2核CPU，在同一虚拟子网内使用UDP进行数据传输，每组测量进行10次，取CPU运行时间的平均值。可以发现，远程拷贝总时间与页数呈正比。在拷贝内存为100M时（25000页），较优情况下需要约0.97秒的时间。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">字段名称</th>\n<th align=\"center\">含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Fault process time</td>\n<td align=\"center\">Fault触发线程的总运行时间，也就是负载代码的实际运行时间</td>\n</tr>\n<tr>\n<td align=\"center\">Init time</td>\n<td align=\"center\">Client端初始化时间</td>\n</tr>\n<tr>\n<td align=\"center\">IO time</td>\n<td align=\"center\">等待内核通过fd传输User Fault相关信息的时间（poll轮询）</td>\n</tr>\n<tr>\n<td align=\"center\">Network time</td>\n<td align=\"center\">UDP协议通信时间</td>\n</tr>\n<tr>\n<td align=\"center\">Server time</td>\n<td align=\"center\">Server端获取page，并通过UDP发送的时间</td>\n</tr>\n<tr>\n<td align=\"center\">Handle time</td>\n<td align=\"center\">获取到远程页后，初始化内存，并对远程页中的数据进行拷贝的时间</td>\n</tr>\n<tr>\n<td align=\"center\">Total time</td>\n<td align=\"center\">Total time=Network + Server + Handle + IO + Init<br />用于证明Network、Server、Handle、IO、Init可代表整个运行流程</td>\n</tr>\n</tbody></table>\n<p>经计算：Fault process time ≈ Total time</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2014.03.01.png\" alt=\"截屏2023-03-13 14.03.01\"></p>\n<p>数据分析和总结：</p>\n<ul>\n<li><p>Network占用了约7%的时间，真实环境下由于不会使用UDP，这一时间占比可能会更大。</p>\n</li>\n<li><p>IO time占比较大，为53%，这一时间在本地虚拟机测试中显著降低，因此或与CPU性能有较大关系。</p>\n<p>  (本测试中，使用的是阿里云的玩具级服务器，cpu主频和内存读写速度可能被限制了)</p>\n</li>\n<li><p>数据读取和拷贝部分（Server、Handle），占用了40%左右的时间。对比MITOSIS，misosis使用rdma避免了在server端的内存拷贝，因此会慢于misosis。</p>\n</li>\n<li><p>本测试中，测试负载为“按顺序访问内存”，这一测试与真实环境有较大区别，因此不能代表将Postcopy实际引入wasm后的实际性能。</p>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2011.30.41.png\" alt=\"截屏2023-03-13 11.30.41\"></p>\n<p>附数据：</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-13%2012.37.29.png\" alt=\"截屏2023-03-13 12.37.29\"></p>\n<h2 id=\"资料收集\"><a href=\"#资料收集\" class=\"headerlink\" title=\"资料收集\"></a>资料收集</h2><p>User space page fault handling相关早期文章：<br><a href=\"https://lwn.net/Articles/550555/\">https://lwn.net/Articles/550555/</a><br><a href=\"https://lwn.net/Articles/615086/\">https://lwn.net/Articles/615086/</a></p>\n<h3 id=\"Postcopy原始论文：\"><a href=\"#Postcopy原始论文：\" class=\"headerlink\" title=\"Postcopy原始论文：\"></a>Postcopy原始论文：</h3><p><a href=\"https://kartikgopalan.github.io/publications/hines09postcopy.pdf\">https://kartikgopalan.github.io/publications/hines09postcopy.pdf</a></p>\n<h3 id=\"CRIU-Lazy-migration\"><a href=\"#CRIU-Lazy-migration\" class=\"headerlink\" title=\"CRIU Lazy migration:\"></a>CRIU Lazy migration:</h3><p><a href=\"https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers\">https://www.researchgate.net/publication/328214412_Efficient_Live_Migration_of_Linux_Containers</a><br><a href=\"https://criu.org/Lazy_migration\">https://criu.org/Lazy_migration</a><br><a href=\"https://lisas.de/~adrian/pdf/lazy-process-migration.pdf\">https://lisas.de/~adrian/pdf/lazy-process-migration.pdf</a></p>\n<h3 id=\"Postcopy在kvm的应用：\"><a href=\"#Postcopy在kvm的应用：\" class=\"headerlink\" title=\"Postcopy在kvm的应用：\"></a>Postcopy在kvm的应用：</h3><p><a href=\"https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja\">https://www.jstage.jst.go.jp/article/imt/7/2/7_614/_pdf/-char/ja</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2022.10.22.png\" alt=\"截屏2023-03-09 22.10.22\"></p>\n<p>RedHat在KVM迁移中的实践ppt：<br><a href=\"http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf\">http://events17.linuxfoundation.org/sites/events/files/slides/kvmforum2014.pdf</a><br><a href=\"https://wiki.qemu.org/Features/PostCopyLiveMigration\">https://wiki.qemu.org/Features/PostCopyLiveMigration</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-09%2017.42.42.png\" alt=\"截屏2023-03-09 17.42.42\"></p>\n<ol>\n<li>线程1访问了一个未被映射的page，发生userfault<br> get_user_pages_locked()<br> get_user_pages_unlocked()<br> 这两个函数可以避免内核处理fault，而是交给用户线程处理</li>\n<li>线程2收到内核的通知——userfault在某个地址被触发了</li>\n<li>线程2将此page从“memory node”传输过来（这和mitosis的“seed”很类似）</li>\n<li>线程2将发生错误的page进行映射<br> remap_anon_pages()</li>\n<li>线程2告知内核，内核唤醒线程1</li>\n<li>线程1尝试访问fault page，并继续执行下去</li>\n</ol>\n<h3 id=\"Ubuntu对userfaultfd的支持\"><a href=\"#Ubuntu对userfaultfd的支持\" class=\"headerlink\" title=\"Ubuntu对userfaultfd的支持\"></a>Ubuntu对userfaultfd的支持</h3><p><a href=\"https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html\">https://manpages.ubuntu.com/manpages/bionic/man2/userfaultfd.2.html</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/flow.png\" alt=\"img\"></p>\n"},{"title":"Best Time to Buy and Sell Stock","date":"2023-03-16T02:42:47.000Z","_content":"\n## Question 1\n\nYou are given an integer array prices where prices[i] is the price of a given stock on the i^th day.\n\nOn each day, you may decide to buy and/or sell the stock. You can only hold at most one share of the stock at any time. However, you can buy it then immediately sell it on the same day.\n\nFind and return the maximum profit you can achieve.\n\n```\nInput: prices = [7,1,5,3,6,4]\nOutput: 7\nExplanation: Buy on day 2 (price = 1) and sell on day 3 (price = 5), profit = 5-1 = 4.\nThen buy on day 4 (price = 3) and sell on day 5 (price = 6), profit = 6-3 = 3.\nTotal profit is 4 + 3 = 7.\n```\n\n### Solution 01\n\ndp(i,0) mains that the max profit i can get when i have no stock in day_i;\ndp(i,1) mains that the max profit i can grt when i have a stock in day_i;\n\nSo,i can get this equation：\n```\ndp[i][0]=max{dp[i−1][0],dp[i−1][1]+prices[i]}\ndp[i][1]=max{dp[i−1][1],dp[i−1][0]−prices[i]}\n```\n\nThe time complexity of the solution is o(n).\n\n### Solution 02\n\nFor this example: [1,2,3]. It is obvious that i need to buy stock on day_1 and sell it on day_3. However i can do this:\n```\nday 1: buy\nday 2: sell and buy; profit: 1\nday 3: sell; profit: 1\nTotal profit:2\n```\n\nThe profit of this choice is the same as only buying and selling for one time. So i can get the ans by calculating all increasing subsequence.\n```\nans=SUM{ prices[i]-prices[i-1] } (prices[i] > prices[i-1])\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/Best-Time-to-Buy-and-Sell-Stock.md","raw":"---\ntitle: Best Time to Buy and Sell Stock\ndate: 2023-03-16 10:42:47\ntags:\n---\n\n## Question 1\n\nYou are given an integer array prices where prices[i] is the price of a given stock on the i^th day.\n\nOn each day, you may decide to buy and/or sell the stock. You can only hold at most one share of the stock at any time. However, you can buy it then immediately sell it on the same day.\n\nFind and return the maximum profit you can achieve.\n\n```\nInput: prices = [7,1,5,3,6,4]\nOutput: 7\nExplanation: Buy on day 2 (price = 1) and sell on day 3 (price = 5), profit = 5-1 = 4.\nThen buy on day 4 (price = 3) and sell on day 5 (price = 6), profit = 6-3 = 3.\nTotal profit is 4 + 3 = 7.\n```\n\n### Solution 01\n\ndp(i,0) mains that the max profit i can get when i have no stock in day_i;\ndp(i,1) mains that the max profit i can grt when i have a stock in day_i;\n\nSo,i can get this equation：\n```\ndp[i][0]=max{dp[i−1][0],dp[i−1][1]+prices[i]}\ndp[i][1]=max{dp[i−1][1],dp[i−1][0]−prices[i]}\n```\n\nThe time complexity of the solution is o(n).\n\n### Solution 02\n\nFor this example: [1,2,3]. It is obvious that i need to buy stock on day_1 and sell it on day_3. However i can do this:\n```\nday 1: buy\nday 2: sell and buy; profit: 1\nday 3: sell; profit: 1\nTotal profit:2\n```\n\nThe profit of this choice is the same as only buying and selling for one time. So i can get the ans by calculating all increasing subsequence.\n```\nans=SUM{ prices[i]-prices[i-1] } (prices[i] > prices[i-1])\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"Best-Time-to-Buy-and-Sell-Stock","published":1,"updated":"2023-03-16T02:55:39.714Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clff58d700000en6f2ao26zcr","content":"<h2 id=\"Question-1\"><a href=\"#Question-1\" class=\"headerlink\" title=\"Question 1\"></a>Question 1</h2><p>You are given an integer array prices where prices[i] is the price of a given stock on the i^th day.</p>\n<p>On each day, you may decide to buy and/or sell the stock. You can only hold at most one share of the stock at any time. However, you can buy it then immediately sell it on the same day.</p>\n<p>Find and return the maximum profit you can achieve.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: prices = [7,1,5,3,6,4]</span><br><span class=\"line\">Output: 7</span><br><span class=\"line\">Explanation: Buy on day 2 (price = 1) and sell on day 3 (price = 5), profit = 5-1 = 4.</span><br><span class=\"line\">Then buy on day 4 (price = 3) and sell on day 5 (price = 6), profit = 6-3 = 3.</span><br><span class=\"line\">Total profit is 4 + 3 = 7.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Solution-01\"><a href=\"#Solution-01\" class=\"headerlink\" title=\"Solution 01\"></a>Solution 01</h3><p>dp(i,0) mains that the max profit i can get when i have no stock in day_i;<br>dp(i,1) mains that the max profit i can grt when i have a stock in day_i;</p>\n<p>So,i can get this equation：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dp[i][0]=max&#123;dp[i−1][0],dp[i−1][1]+prices[i]&#125;</span><br><span class=\"line\">dp[i][1]=max&#123;dp[i−1][1],dp[i−1][0]−prices[i]&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The time complexity of the solution is o(n).</p>\n<h3 id=\"Solution-02\"><a href=\"#Solution-02\" class=\"headerlink\" title=\"Solution 02\"></a>Solution 02</h3><p>For this example: [1,2,3]. It is obvious that i need to buy stock on day_1 and sell it on day_3. However i can do this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">day 1: buy</span><br><span class=\"line\">day 2: sell and buy; profit: 1</span><br><span class=\"line\">day 3: sell; profit: 1</span><br><span class=\"line\">Total profit:2</span><br></pre></td></tr></table></figure>\n\n<p>The profit of this choice is the same as only buying and selling for one time. So i can get the ans by calculating all increasing subsequence.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ans=SUM&#123; prices[i]-prices[i-1] &#125; (prices[i] &gt; prices[i-1])</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question-1\"><a href=\"#Question-1\" class=\"headerlink\" title=\"Question 1\"></a>Question 1</h2><p>You are given an integer array prices where prices[i] is the price of a given stock on the i^th day.</p>\n<p>On each day, you may decide to buy and/or sell the stock. You can only hold at most one share of the stock at any time. However, you can buy it then immediately sell it on the same day.</p>\n<p>Find and return the maximum profit you can achieve.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: prices = [7,1,5,3,6,4]</span><br><span class=\"line\">Output: 7</span><br><span class=\"line\">Explanation: Buy on day 2 (price = 1) and sell on day 3 (price = 5), profit = 5-1 = 4.</span><br><span class=\"line\">Then buy on day 4 (price = 3) and sell on day 5 (price = 6), profit = 6-3 = 3.</span><br><span class=\"line\">Total profit is 4 + 3 = 7.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Solution-01\"><a href=\"#Solution-01\" class=\"headerlink\" title=\"Solution 01\"></a>Solution 01</h3><p>dp(i,0) mains that the max profit i can get when i have no stock in day_i;<br>dp(i,1) mains that the max profit i can grt when i have a stock in day_i;</p>\n<p>So,i can get this equation：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dp[i][0]=max&#123;dp[i−1][0],dp[i−1][1]+prices[i]&#125;</span><br><span class=\"line\">dp[i][1]=max&#123;dp[i−1][1],dp[i−1][0]−prices[i]&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The time complexity of the solution is o(n).</p>\n<h3 id=\"Solution-02\"><a href=\"#Solution-02\" class=\"headerlink\" title=\"Solution 02\"></a>Solution 02</h3><p>For this example: [1,2,3]. It is obvious that i need to buy stock on day_1 and sell it on day_3. However i can do this:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">day 1: buy</span><br><span class=\"line\">day 2: sell and buy; profit: 1</span><br><span class=\"line\">day 3: sell; profit: 1</span><br><span class=\"line\">Total profit:2</span><br></pre></td></tr></table></figure>\n\n<p>The profit of this choice is the same as only buying and selling for one time. So i can get the ans by calculating all increasing subsequence.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ans=SUM&#123; prices[i]-prices[i-1] &#125; (prices[i] &gt; prices[i-1])</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"WASMEdge Runtime Structure","date":"2023-03-16T03:31:14.000Z","_content":"\nQuestion：\n\n拷贝数据粒度问题：\n\n**Min：**Page （Mitosis）\n\nMixture：针对Function每次拷贝完整instance。针对memory等，则按页拷贝。\n\nInstance：每次拷贝一个instance，例如一个FunctionInstance\n\nModule ：每次拷贝一个module\n\n**Max:** .wasm / .so （Faasm）\n\n---\n\n\n\n\n\n**Plan：**先用Tcp做测试，做好模块化，方便后面改quic。先做No COW\n\n**Running Node：**\n\n1.在TableInstance、FunctionInstance等.cpp文件，增加反序列化初始化函数（原始只有一个从Mod数据初始化的函数）。\n\n```c++\ninstantiate(Module &Mod) //原始初始化函数\ninstantiate(String obj)  //反序列化初始化\n  \ninstantiate_userfault()  //userfalut伪初始化\ninstantiate_userfault(String obj, fault_ref)  //userfault handle\n\n```\n\n2.在module.cpp，增加一个instantiate函数的重载，进行remote初始化runtime。此instantiate函数，调用第1条中的反序列化初始化函数进行初始化\n\n**Memory Node：**\n\n3.设计一个“镜像类”，用于\"镜像\"和\"储存\"序列化后的runtime数据。并设计一个network方法，用于监听网络请求，根据请求发送相应的runtime数据\n\n\n\n```c++\nstd::vector<FunctionInstance *> FuncInsts; // 不需要postcopy,直接拷贝FuncSec即可\nstd::vector<TableInstance *> TabInsts;     // 不需要postcopy,直接拷贝TabSec即可\nstd::vector<MemoryInstance *> MemInsts;    // 需要PostCopy\nstd::vector<GlobalInstance *> GlobInsts;   // 直接拷贝 GlobSec\nstd::vector<ElementInstance *> ElemInsts;  // 直接拷贝 ElemSec\nstd::vector<DataInstance *> DataInsts;     // 需要PostCopy\n```\n\n\n\n### No COW\n\n一次性拷贝：Store，Conf。之后直接执行\n\n### COW\n\n只拷贝Conf，拷贝Store的大小。然后进行userfault初始化。之后执行，遇到fault，则利用handle线程处理\n\n## WASMEdge分析\n\n1.wasm相关数据存储在Store中\n\n2.一个wasm程序由多个modules组成\n\n**启动流程：**\n\n```c++\n//待运行文件待路径\nconst auto InputPath = std::filesystem::absolute(SoName.value());\n\n/*******************/ \n// 根据Config，初始化VM\n// 需要包含全部cli参数\n\nVM::VM VM(Conf);\n\t-> unsafeInitVM(); \n\t\t-> unsafeLoadBuiltInHosts();     加载 BuiltInModInsts\n\t\t\t unsafeRegisterBuiltInHosts(); 登记 ExecutorEngine.registerModule\n\t\t\t \t-> instantiate(StoreMgr, Mod, Name)\n/*******************/ \n      \n/*******************/    \n// 初始化module，包含TableSec、FunctionSec\t等\t\t\n// 根据module，初始化stack\n      \nVM.loadWasm(InputPath.u8string());\n\t-> LoaderEngine.parseModule(Path)\n\t\t-> FMgr.setPath(FilePath)\n\t\t-> module.loadModule()                  //读取文件，初始化module \n    \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//初始化 VM.Mod\n\t\t\nVM.validate();\n\t-> ValidatorEngine.validate(*Mod.get())   //验证module\n                                            //即上一步获得的 VM.Mod\n\t\nVM.instantiate();\n\t-> ExecutorEngine.instantiateModule(StoreRef, *Mod.get())\n\t\t\t-> instantiate(StoreMgr, Mod)         //初始化StackManager + 初始化module中的参数（参考文档）\n\t\t\t-> 初始化 ActiveModInst                //后续使用ActiveModInst进行函数调用\n    \n/********************/\n\n\n//初始化系统环境,WASI\nWasiMod->getEnv().init(\n      Dir.value(),\n      InputPath.filename()\n      Args.value(), Env.value());\n\n//初始化输入参数\nstd::vector<ValVariant> FuncArgs;\n\n//执行\nVM.asyncExecute(FuncName, FuncArgs, FuncArgTypes);\n\t-> ExecutorEngine.invoke(*FuncInst, Params, ParamTypes)\n\t\t-> runFunction(StackMgr, FuncInst, Params) \n\t\t\tFuncInst是一个指针，指向Stack中的函数位置\n\n//End：输出执行结果\n```\n\n## Remote Migration steps\n\n### Step1: VM init\n\n这一步，需要从远端拷贝Conf。然后返序列化Conf进行初始化。\n\n```c++\nVM(const Configure &Conf):\n  Conf(Conf)                                            // 给本地变量Conf赋值\n  Stage(VMStage::Inited),                               // 默认Init参数，不用改\n  LoaderEngine(Conf, &Executor::Executor::Intrinsics),  // 把Conf赋值给LoaderEngine    Loader\n  ValidatorEngine(Conf),                                // 把Conf赋值给ValidatorEngine Validator\n  ExecutorEngine(Conf, &Stat),                          // 把Conf赋值给ExecutorEngine  Executor\n  Store(std::make_unique<Runtime::StoreManager>()),     // 把Store赋值为新实例化的StoreManager\n  StoreRef(*Store.get())                                // 把StoreRef赋值为Store的指针\n{\n\t\tunsafeLoadBuiltInHosts();                           // 加载Wasi？\n    unsafeRegisterBuiltInHosts();                       // 在ExecutorEngine存储，StoreRef和WASI对象\n}\n```\n\n### Stpe2: Module & Stack init\n\n将以下三步：VM.loadWasm() -> VM.validate() -> VM.instantiate()\n\n由本地读取文件从而实例化module，改为云端获取。需要拷贝很多个细小的变量，一个都不能漏掉\n\n```c++\n \t// 实例化 VM.Mod \n  // 1.Postcopy VM.Mod\n  // 2.修改Stage Stage = VMStage::Loaded\n \tVM.loadWasm(InputPath.u8string());\n\n  // 验证VM.Mod\n  // 1.修改Stage\n\tVM.validate();\n\n  //  Stage = VMStage::Instantiated;\n  //  实例化 ActiveModInst\n  // 1.Postcopy StoreRef            (StoreMgr.registerModule)   初始化 StoreRef中的参数，\n  //                                                            NamedMod，一个map，储存了所有Module\n  // 2.Postcopy StackMgr            (StackManager StackMgr)     完整的进行反序列化（可能不用拷贝实际上）\n  // 3.Postcopy ActiveModInst       (ActiveModInst)             完整的进行反序列化\n  //                                                            (这个参数实际上Store中已经包含，因此可能不需要拷贝)\n\tVM.instantiate();\n```\n\nNo COW：需要从远端拷贝module，直接反序列化\n\nCOW：先假初始化，遇到了page fault再从远端拷贝\n\n**参考：**\n\nmodule本地加载实现：**lib/loader/ast/module.cpp**\n\nmodule定义： **include/ast/module.h**\n\nStoreMgr、moduleInstance初始化：**lib/executor/instantiate/module.cpp**    \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlib/executor/instantiate/data.cpp\n\n\n\n### moduleInstance实例化\n\n```c++\n// 定义\nstd::unique_ptr<Runtime::Instance::ModuleInstance> ModInst;\n\nModInst = std::make_unique<Runtime::Instance::ModuleInstance>(Name.value());\n\n// 初始化 FuncType\nModInst->addFuncType(FuncType);\n\n//初始化ImportSec\nAST::ImportSection &ImportSec = Mod.getImportSection();\ninstantiate(StoreMgr, *ModInst, ImportSec)\n  \n  \n//初始化FuncSec，CodeSec\nconst AST::FunctionSection &FuncSec = Mod.getFunctionSection();\nconst AST::CodeSection &CodeSec = Mod.getCodeSection();\ninstantiate(*ModInst, FuncSec, CodeSec);\n\n//初始化 TabSec\nAST::TableSection &TabSec = Mod.getTableSection();\ninstantiate(*ModInst, TabSec);\n\n//初始化 MemSec\nconst AST::MemorySection &MemSec = Mod.getMemorySection();\ninstantiate(*ModInst, MemSec);\n  \n// 初始化 GlobSec\n\n//初始化ExportSec\nconst AST::ExportSection &ExportSec = Mod.getExportSection();\ninstantiate(*ModInst, ExportSec);\n\n//初始化ElemSec\ninstantiate(StackMgr, *ModInst, ElemSec)\n  \n//初始化   DataSec\ninstantiate(StackMgr, *ModInst, DataSec)\n  \n```\n\n\n\n---\n\n\n\n\n\nhttps://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md\n\n![截屏2023-03-16 11.32.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-16%2011.32.20.png)\n\n\n\n\n\nhttps://juejin.cn/post/6844904062148689933\n","source":"_posts/WASM-Runtime-Structure.md","raw":"---\ntitle: WASMEdge Runtime Structure\ndate: 2023-03-16 11:31:14\ntags:\n---\n\nQuestion：\n\n拷贝数据粒度问题：\n\n**Min：**Page （Mitosis）\n\nMixture：针对Function每次拷贝完整instance。针对memory等，则按页拷贝。\n\nInstance：每次拷贝一个instance，例如一个FunctionInstance\n\nModule ：每次拷贝一个module\n\n**Max:** .wasm / .so （Faasm）\n\n---\n\n\n\n\n\n**Plan：**先用Tcp做测试，做好模块化，方便后面改quic。先做No COW\n\n**Running Node：**\n\n1.在TableInstance、FunctionInstance等.cpp文件，增加反序列化初始化函数（原始只有一个从Mod数据初始化的函数）。\n\n```c++\ninstantiate(Module &Mod) //原始初始化函数\ninstantiate(String obj)  //反序列化初始化\n  \ninstantiate_userfault()  //userfalut伪初始化\ninstantiate_userfault(String obj, fault_ref)  //userfault handle\n\n```\n\n2.在module.cpp，增加一个instantiate函数的重载，进行remote初始化runtime。此instantiate函数，调用第1条中的反序列化初始化函数进行初始化\n\n**Memory Node：**\n\n3.设计一个“镜像类”，用于\"镜像\"和\"储存\"序列化后的runtime数据。并设计一个network方法，用于监听网络请求，根据请求发送相应的runtime数据\n\n\n\n```c++\nstd::vector<FunctionInstance *> FuncInsts; // 不需要postcopy,直接拷贝FuncSec即可\nstd::vector<TableInstance *> TabInsts;     // 不需要postcopy,直接拷贝TabSec即可\nstd::vector<MemoryInstance *> MemInsts;    // 需要PostCopy\nstd::vector<GlobalInstance *> GlobInsts;   // 直接拷贝 GlobSec\nstd::vector<ElementInstance *> ElemInsts;  // 直接拷贝 ElemSec\nstd::vector<DataInstance *> DataInsts;     // 需要PostCopy\n```\n\n\n\n### No COW\n\n一次性拷贝：Store，Conf。之后直接执行\n\n### COW\n\n只拷贝Conf，拷贝Store的大小。然后进行userfault初始化。之后执行，遇到fault，则利用handle线程处理\n\n## WASMEdge分析\n\n1.wasm相关数据存储在Store中\n\n2.一个wasm程序由多个modules组成\n\n**启动流程：**\n\n```c++\n//待运行文件待路径\nconst auto InputPath = std::filesystem::absolute(SoName.value());\n\n/*******************/ \n// 根据Config，初始化VM\n// 需要包含全部cli参数\n\nVM::VM VM(Conf);\n\t-> unsafeInitVM(); \n\t\t-> unsafeLoadBuiltInHosts();     加载 BuiltInModInsts\n\t\t\t unsafeRegisterBuiltInHosts(); 登记 ExecutorEngine.registerModule\n\t\t\t \t-> instantiate(StoreMgr, Mod, Name)\n/*******************/ \n      \n/*******************/    \n// 初始化module，包含TableSec、FunctionSec\t等\t\t\n// 根据module，初始化stack\n      \nVM.loadWasm(InputPath.u8string());\n\t-> LoaderEngine.parseModule(Path)\n\t\t-> FMgr.setPath(FilePath)\n\t\t-> module.loadModule()                  //读取文件，初始化module \n    \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//初始化 VM.Mod\n\t\t\nVM.validate();\n\t-> ValidatorEngine.validate(*Mod.get())   //验证module\n                                            //即上一步获得的 VM.Mod\n\t\nVM.instantiate();\n\t-> ExecutorEngine.instantiateModule(StoreRef, *Mod.get())\n\t\t\t-> instantiate(StoreMgr, Mod)         //初始化StackManager + 初始化module中的参数（参考文档）\n\t\t\t-> 初始化 ActiveModInst                //后续使用ActiveModInst进行函数调用\n    \n/********************/\n\n\n//初始化系统环境,WASI\nWasiMod->getEnv().init(\n      Dir.value(),\n      InputPath.filename()\n      Args.value(), Env.value());\n\n//初始化输入参数\nstd::vector<ValVariant> FuncArgs;\n\n//执行\nVM.asyncExecute(FuncName, FuncArgs, FuncArgTypes);\n\t-> ExecutorEngine.invoke(*FuncInst, Params, ParamTypes)\n\t\t-> runFunction(StackMgr, FuncInst, Params) \n\t\t\tFuncInst是一个指针，指向Stack中的函数位置\n\n//End：输出执行结果\n```\n\n## Remote Migration steps\n\n### Step1: VM init\n\n这一步，需要从远端拷贝Conf。然后返序列化Conf进行初始化。\n\n```c++\nVM(const Configure &Conf):\n  Conf(Conf)                                            // 给本地变量Conf赋值\n  Stage(VMStage::Inited),                               // 默认Init参数，不用改\n  LoaderEngine(Conf, &Executor::Executor::Intrinsics),  // 把Conf赋值给LoaderEngine    Loader\n  ValidatorEngine(Conf),                                // 把Conf赋值给ValidatorEngine Validator\n  ExecutorEngine(Conf, &Stat),                          // 把Conf赋值给ExecutorEngine  Executor\n  Store(std::make_unique<Runtime::StoreManager>()),     // 把Store赋值为新实例化的StoreManager\n  StoreRef(*Store.get())                                // 把StoreRef赋值为Store的指针\n{\n\t\tunsafeLoadBuiltInHosts();                           // 加载Wasi？\n    unsafeRegisterBuiltInHosts();                       // 在ExecutorEngine存储，StoreRef和WASI对象\n}\n```\n\n### Stpe2: Module & Stack init\n\n将以下三步：VM.loadWasm() -> VM.validate() -> VM.instantiate()\n\n由本地读取文件从而实例化module，改为云端获取。需要拷贝很多个细小的变量，一个都不能漏掉\n\n```c++\n \t// 实例化 VM.Mod \n  // 1.Postcopy VM.Mod\n  // 2.修改Stage Stage = VMStage::Loaded\n \tVM.loadWasm(InputPath.u8string());\n\n  // 验证VM.Mod\n  // 1.修改Stage\n\tVM.validate();\n\n  //  Stage = VMStage::Instantiated;\n  //  实例化 ActiveModInst\n  // 1.Postcopy StoreRef            (StoreMgr.registerModule)   初始化 StoreRef中的参数，\n  //                                                            NamedMod，一个map，储存了所有Module\n  // 2.Postcopy StackMgr            (StackManager StackMgr)     完整的进行反序列化（可能不用拷贝实际上）\n  // 3.Postcopy ActiveModInst       (ActiveModInst)             完整的进行反序列化\n  //                                                            (这个参数实际上Store中已经包含，因此可能不需要拷贝)\n\tVM.instantiate();\n```\n\nNo COW：需要从远端拷贝module，直接反序列化\n\nCOW：先假初始化，遇到了page fault再从远端拷贝\n\n**参考：**\n\nmodule本地加载实现：**lib/loader/ast/module.cpp**\n\nmodule定义： **include/ast/module.h**\n\nStoreMgr、moduleInstance初始化：**lib/executor/instantiate/module.cpp**    \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlib/executor/instantiate/data.cpp\n\n\n\n### moduleInstance实例化\n\n```c++\n// 定义\nstd::unique_ptr<Runtime::Instance::ModuleInstance> ModInst;\n\nModInst = std::make_unique<Runtime::Instance::ModuleInstance>(Name.value());\n\n// 初始化 FuncType\nModInst->addFuncType(FuncType);\n\n//初始化ImportSec\nAST::ImportSection &ImportSec = Mod.getImportSection();\ninstantiate(StoreMgr, *ModInst, ImportSec)\n  \n  \n//初始化FuncSec，CodeSec\nconst AST::FunctionSection &FuncSec = Mod.getFunctionSection();\nconst AST::CodeSection &CodeSec = Mod.getCodeSection();\ninstantiate(*ModInst, FuncSec, CodeSec);\n\n//初始化 TabSec\nAST::TableSection &TabSec = Mod.getTableSection();\ninstantiate(*ModInst, TabSec);\n\n//初始化 MemSec\nconst AST::MemorySection &MemSec = Mod.getMemorySection();\ninstantiate(*ModInst, MemSec);\n  \n// 初始化 GlobSec\n\n//初始化ExportSec\nconst AST::ExportSection &ExportSec = Mod.getExportSection();\ninstantiate(*ModInst, ExportSec);\n\n//初始化ElemSec\ninstantiate(StackMgr, *ModInst, ElemSec)\n  \n//初始化   DataSec\ninstantiate(StackMgr, *ModInst, DataSec)\n  \n```\n\n\n\n---\n\n\n\n\n\nhttps://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md\n\n![截屏2023-03-16 11.32.20](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-16%2011.32.20.png)\n\n\n\n\n\nhttps://juejin.cn/post/6844904062148689933\n","slug":"WASM-Runtime-Structure","published":1,"updated":"2023-03-25T07:14:51.135Z","_id":"clff58d770001en6fb92uas4c","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Question：</p>\n<p>拷贝数据粒度问题：</p>\n<p><strong>Min：</strong>Page （Mitosis）</p>\n<p>Mixture：针对Function每次拷贝完整instance。针对memory等，则按页拷贝。</p>\n<p>Instance：每次拷贝一个instance，例如一个FunctionInstance</p>\n<p>Module ：每次拷贝一个module</p>\n<p><strong>Max:</strong> .wasm / .so （Faasm）</p>\n<hr>\n<p><strong>Plan：</strong>先用Tcp做测试，做好模块化，方便后面改quic。先做No COW</p>\n<p><strong>Running Node：</strong></p>\n<p>1.在TableInstance、FunctionInstance等.cpp文件，增加反序列化初始化函数（原始只有一个从Mod数据初始化的函数）。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">instantiate</span>(Module &amp;Mod) <span class=\"comment\">//原始初始化函数</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(String obj)  <span class=\"comment\">//反序列化初始化</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"built_in\">instantiate_userfault</span>()  <span class=\"comment\">//userfalut伪初始化</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate_userfault</span>(String obj, fault_ref)  <span class=\"comment\">//userfault handle</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>2.在module.cpp，增加一个instantiate函数的重载，进行remote初始化runtime。此instantiate函数，调用第1条中的反序列化初始化函数进行初始化</p>\n<p><strong>Memory Node：</strong></p>\n<p>3.设计一个“镜像类”，用于”镜像”和”储存”序列化后的runtime数据。并设计一个network方法，用于监听网络请求，根据请求发送相应的runtime数据</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">std::vector&lt;FunctionInstance *&gt; FuncInsts; <span class=\"comment\">// 不需要postcopy,直接拷贝FuncSec即可</span></span><br><span class=\"line\">std::vector&lt;TableInstance *&gt; TabInsts;     <span class=\"comment\">// 不需要postcopy,直接拷贝TabSec即可</span></span><br><span class=\"line\">std::vector&lt;MemoryInstance *&gt; MemInsts;    <span class=\"comment\">// 需要PostCopy</span></span><br><span class=\"line\">std::vector&lt;GlobalInstance *&gt; GlobInsts;   <span class=\"comment\">// 直接拷贝 GlobSec</span></span><br><span class=\"line\">std::vector&lt;ElementInstance *&gt; ElemInsts;  <span class=\"comment\">// 直接拷贝 ElemSec</span></span><br><span class=\"line\">std::vector&lt;DataInstance *&gt; DataInsts;     <span class=\"comment\">// 需要PostCopy</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"No-COW\"><a href=\"#No-COW\" class=\"headerlink\" title=\"No COW\"></a>No COW</h3><p>一次性拷贝：Store，Conf。之后直接执行</p>\n<h3 id=\"COW\"><a href=\"#COW\" class=\"headerlink\" title=\"COW\"></a>COW</h3><p>只拷贝Conf，拷贝Store的大小。然后进行userfault初始化。之后执行，遇到fault，则利用handle线程处理</p>\n<h2 id=\"WASMEdge分析\"><a href=\"#WASMEdge分析\" class=\"headerlink\" title=\"WASMEdge分析\"></a>WASMEdge分析</h2><p>1.wasm相关数据存储在Store中</p>\n<p>2.一个wasm程序由多个modules组成</p>\n<p><strong>启动流程：</strong></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//待运行文件待路径</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"keyword\">auto</span> InputPath = std::filesystem::<span class=\"built_in\">absolute</span>(SoName.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*******************/</span> </span><br><span class=\"line\"><span class=\"comment\">// 根据Config，初始化VM</span></span><br><span class=\"line\"><span class=\"comment\">// 需要包含全部cli参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">VM::VM <span class=\"title\">VM</span><span class=\"params\">(Conf)</span></span>;</span><br><span class=\"line\">\t-&gt; <span class=\"built_in\">unsafeInitVM</span>(); </span><br><span class=\"line\">\t\t-&gt; <span class=\"built_in\">unsafeLoadBuiltInHosts</span>();     加载 <span class=\"function\">BuiltInModInsts</span></span><br><span class=\"line\"><span class=\"function\">\t\t\t <span class=\"title\">unsafeRegisterBuiltInHosts</span><span class=\"params\">()</span></span>; 登记 ExecutorEngine.registerModule</span><br><span class=\"line\">\t\t\t \t-&gt; <span class=\"built_in\">instantiate</span>(StoreMgr, Mod, Name)</span><br><span class=\"line\"><span class=\"comment\">/*******************/</span> </span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\">/*******************/</span>    </span><br><span class=\"line\"><span class=\"comment\">// 初始化module，包含TableSec、FunctionSec\t等\t\t</span></span><br><span class=\"line\"><span class=\"comment\">// 根据module，初始化stack</span></span><br><span class=\"line\">      </span><br><span class=\"line\">VM.<span class=\"built_in\">loadWasm</span>(InputPath.<span class=\"built_in\">u8string</span>());</span><br><span class=\"line\">\t-&gt; LoaderEngine.<span class=\"built_in\">parseModule</span>(Path)</span><br><span class=\"line\">\t\t-&gt; FMgr.<span class=\"built_in\">setPath</span>(FilePath)</span><br><span class=\"line\">\t\t-&gt; <span class=\"keyword\">module</span>.<span class=\"built_in\">loadModule</span>()                  <span class=\"comment\">//读取文件，初始化module </span></span><br><span class=\"line\">    \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">//初始化 VM.Mod</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">VM.<span class=\"built_in\">validate</span>();</span><br><span class=\"line\">\t-&gt; ValidatorEngine.<span class=\"built_in\">validate</span>(*Mod.<span class=\"built_in\">get</span>())   <span class=\"comment\">//验证module</span></span><br><span class=\"line\">                                            <span class=\"comment\">//即上一步获得的 VM.Mod</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">VM.<span class=\"built_in\">instantiate</span>();</span><br><span class=\"line\">\t-&gt; ExecutorEngine.<span class=\"built_in\">instantiateModule</span>(StoreRef, *Mod.<span class=\"built_in\">get</span>())</span><br><span class=\"line\">\t\t\t-&gt; <span class=\"built_in\">instantiate</span>(StoreMgr, Mod)         <span class=\"comment\">//初始化StackManager + 初始化module中的参数（参考文档）</span></span><br><span class=\"line\">\t\t\t-&gt; 初始化 ActiveModInst                <span class=\"comment\">//后续使用ActiveModInst进行函数调用</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">/********************/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化系统环境,WASI</span></span><br><span class=\"line\">WasiMod-&gt;<span class=\"built_in\">getEnv</span>().<span class=\"built_in\">init</span>(</span><br><span class=\"line\">      Dir.<span class=\"built_in\">value</span>(),</span><br><span class=\"line\">      InputPath.<span class=\"built_in\">filename</span>()</span><br><span class=\"line\">      Args.<span class=\"built_in\">value</span>(), Env.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化输入参数</span></span><br><span class=\"line\">std::vector&lt;ValVariant&gt; FuncArgs;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//执行</span></span><br><span class=\"line\">VM.<span class=\"built_in\">asyncExecute</span>(FuncName, FuncArgs, FuncArgTypes);</span><br><span class=\"line\">\t-&gt; ExecutorEngine.<span class=\"built_in\">invoke</span>(*FuncInst, Params, ParamTypes)</span><br><span class=\"line\">\t\t-&gt; <span class=\"built_in\">runFunction</span>(StackMgr, FuncInst, Params) </span><br><span class=\"line\">\t\t\tFuncInst是一个指针，指向Stack中的函数位置</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//End：输出执行结果</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Remote-Migration-steps\"><a href=\"#Remote-Migration-steps\" class=\"headerlink\" title=\"Remote Migration steps\"></a>Remote Migration steps</h2><h3 id=\"Step1-VM-init\"><a href=\"#Step1-VM-init\" class=\"headerlink\" title=\"Step1: VM init\"></a>Step1: VM init</h3><p>这一步，需要从远端拷贝Conf。然后返序列化Conf进行初始化。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">VM</span>(<span class=\"type\">const</span> Configure &amp;Conf):</span><br><span class=\"line\">  <span class=\"built_in\">Conf</span>(Conf)                                            <span class=\"comment\">// 给本地变量Conf赋值</span></span><br><span class=\"line\">  <span class=\"built_in\">Stage</span>(VMStage::Inited),                               <span class=\"comment\">// 默认Init参数，不用改</span></span><br><span class=\"line\">  <span class=\"built_in\">LoaderEngine</span>(Conf, &amp;Executor::Executor::Intrinsics),  <span class=\"comment\">// 把Conf赋值给LoaderEngine    Loader</span></span><br><span class=\"line\">  <span class=\"built_in\">ValidatorEngine</span>(Conf),                                <span class=\"comment\">// 把Conf赋值给ValidatorEngine Validator</span></span><br><span class=\"line\">  <span class=\"built_in\">ExecutorEngine</span>(Conf, &amp;Stat),                          <span class=\"comment\">// 把Conf赋值给ExecutorEngine  Executor</span></span><br><span class=\"line\">  <span class=\"built_in\">Store</span>(std::<span class=\"built_in\">make_unique</span>&lt;Runtime::StoreManager&gt;()),     <span class=\"comment\">// 把Store赋值为新实例化的StoreManager</span></span><br><span class=\"line\">  <span class=\"built_in\">StoreRef</span>(*Store.<span class=\"built_in\">get</span>())                                <span class=\"comment\">// 把StoreRef赋值为Store的指针</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">unsafeLoadBuiltInHosts</span>();                           <span class=\"comment\">// 加载Wasi？</span></span><br><span class=\"line\">    <span class=\"built_in\">unsafeRegisterBuiltInHosts</span>();                       <span class=\"comment\">// 在ExecutorEngine存储，StoreRef和WASI对象</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Stpe2-Module-amp-Stack-init\"><a href=\"#Stpe2-Module-amp-Stack-init\" class=\"headerlink\" title=\"Stpe2: Module &amp; Stack init\"></a>Stpe2: Module &amp; Stack init</h3><p>将以下三步：VM.loadWasm() -&gt; VM.validate() -&gt; VM.instantiate()</p>\n<p>由本地读取文件从而实例化module，改为云端获取。需要拷贝很多个细小的变量，一个都不能漏掉</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t<span class=\"comment\">// 实例化 VM.Mod </span></span><br><span class=\"line\"> <span class=\"comment\">// 1.Postcopy VM.Mod</span></span><br><span class=\"line\"> <span class=\"comment\">// 2.修改Stage Stage = VMStage::Loaded</span></span><br><span class=\"line\">\tVM.<span class=\"built_in\">loadWasm</span>(InputPath.<span class=\"built_in\">u8string</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">// 验证VM.Mod</span></span><br><span class=\"line\"> <span class=\"comment\">// 1.修改Stage</span></span><br><span class=\"line\">VM.<span class=\"built_in\">validate</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//  Stage = VMStage::Instantiated;</span></span><br><span class=\"line\"> <span class=\"comment\">//  实例化 ActiveModInst</span></span><br><span class=\"line\"> <span class=\"comment\">// 1.Postcopy StoreRef            (StoreMgr.registerModule)   初始化 StoreRef中的参数，</span></span><br><span class=\"line\"> <span class=\"comment\">//                                                            NamedMod，一个map，储存了所有Module</span></span><br><span class=\"line\"> <span class=\"comment\">// 2.Postcopy StackMgr            (StackManager StackMgr)     完整的进行反序列化（可能不用拷贝实际上）</span></span><br><span class=\"line\"> <span class=\"comment\">// 3.Postcopy ActiveModInst       (ActiveModInst)             完整的进行反序列化</span></span><br><span class=\"line\"> <span class=\"comment\">//                                                            (这个参数实际上Store中已经包含，因此可能不需要拷贝)</span></span><br><span class=\"line\">VM.<span class=\"built_in\">instantiate</span>();</span><br></pre></td></tr></table></figure>\n\n<p>No COW：需要从远端拷贝module，直接反序列化</p>\n<p>COW：先假初始化，遇到了page fault再从远端拷贝</p>\n<p><strong>参考：</strong></p>\n<p>module本地加载实现：<strong>lib/loader/ast/module.cpp</strong></p>\n<p>module定义： <strong>include/ast/module.h</strong></p>\n<p>StoreMgr、moduleInstance初始化：<strong>lib/executor/instantiate/module.cpp</strong><br>                                                            lib/executor/instantiate/data.cpp</p>\n<h3 id=\"moduleInstance实例化\"><a href=\"#moduleInstance实例化\" class=\"headerlink\" title=\"moduleInstance实例化\"></a>moduleInstance实例化</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 定义</span></span><br><span class=\"line\">std::unique_ptr&lt;Runtime::Instance::ModuleInstance&gt; ModInst;</span><br><span class=\"line\"></span><br><span class=\"line\">ModInst = std::<span class=\"built_in\">make_unique</span>&lt;Runtime::Instance::ModuleInstance&gt;(Name.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 初始化 FuncType</span></span><br><span class=\"line\">ModInst-&gt;<span class=\"built_in\">addFuncType</span>(FuncType);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ImportSec</span></span><br><span class=\"line\">AST::ImportSection &amp;ImportSec = Mod.<span class=\"built_in\">getImportSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StoreMgr, *ModInst, ImportSec)</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">//初始化FuncSec，CodeSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::FunctionSection &amp;FuncSec = Mod.<span class=\"built_in\">getFunctionSection</span>();</span><br><span class=\"line\"><span class=\"type\">const</span> AST::CodeSection &amp;CodeSec = Mod.<span class=\"built_in\">getCodeSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, FuncSec, CodeSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化 TabSec</span></span><br><span class=\"line\">AST::TableSection &amp;TabSec = Mod.<span class=\"built_in\">getTableSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, TabSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化 MemSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::MemorySection &amp;MemSec = Mod.<span class=\"built_in\">getMemorySection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, MemSec);</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">// 初始化 GlobSec</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ExportSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::ExportSection &amp;ExportSec = Mod.<span class=\"built_in\">getExportSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, ExportSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ElemSec</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StackMgr, *ModInst, ElemSec)</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">//初始化   DataSec</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StackMgr, *ModInst, DataSec)</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n\n\n\n<hr>\n<p><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md\">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-16%2011.32.20.png\" alt=\"截屏2023-03-16 11.32.20\"></p>\n<p><a href=\"https://juejin.cn/post/6844904062148689933\">https://juejin.cn/post/6844904062148689933</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Question：</p>\n<p>拷贝数据粒度问题：</p>\n<p><strong>Min：</strong>Page （Mitosis）</p>\n<p>Mixture：针对Function每次拷贝完整instance。针对memory等，则按页拷贝。</p>\n<p>Instance：每次拷贝一个instance，例如一个FunctionInstance</p>\n<p>Module ：每次拷贝一个module</p>\n<p><strong>Max:</strong> .wasm / .so （Faasm）</p>\n<hr>\n<p><strong>Plan：</strong>先用Tcp做测试，做好模块化，方便后面改quic。先做No COW</p>\n<p><strong>Running Node：</strong></p>\n<p>1.在TableInstance、FunctionInstance等.cpp文件，增加反序列化初始化函数（原始只有一个从Mod数据初始化的函数）。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">instantiate</span>(Module &amp;Mod) <span class=\"comment\">//原始初始化函数</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(String obj)  <span class=\"comment\">//反序列化初始化</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"built_in\">instantiate_userfault</span>()  <span class=\"comment\">//userfalut伪初始化</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate_userfault</span>(String obj, fault_ref)  <span class=\"comment\">//userfault handle</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>2.在module.cpp，增加一个instantiate函数的重载，进行remote初始化runtime。此instantiate函数，调用第1条中的反序列化初始化函数进行初始化</p>\n<p><strong>Memory Node：</strong></p>\n<p>3.设计一个“镜像类”，用于”镜像”和”储存”序列化后的runtime数据。并设计一个network方法，用于监听网络请求，根据请求发送相应的runtime数据</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">std::vector&lt;FunctionInstance *&gt; FuncInsts; <span class=\"comment\">// 不需要postcopy,直接拷贝FuncSec即可</span></span><br><span class=\"line\">std::vector&lt;TableInstance *&gt; TabInsts;     <span class=\"comment\">// 不需要postcopy,直接拷贝TabSec即可</span></span><br><span class=\"line\">std::vector&lt;MemoryInstance *&gt; MemInsts;    <span class=\"comment\">// 需要PostCopy</span></span><br><span class=\"line\">std::vector&lt;GlobalInstance *&gt; GlobInsts;   <span class=\"comment\">// 直接拷贝 GlobSec</span></span><br><span class=\"line\">std::vector&lt;ElementInstance *&gt; ElemInsts;  <span class=\"comment\">// 直接拷贝 ElemSec</span></span><br><span class=\"line\">std::vector&lt;DataInstance *&gt; DataInsts;     <span class=\"comment\">// 需要PostCopy</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"No-COW\"><a href=\"#No-COW\" class=\"headerlink\" title=\"No COW\"></a>No COW</h3><p>一次性拷贝：Store，Conf。之后直接执行</p>\n<h3 id=\"COW\"><a href=\"#COW\" class=\"headerlink\" title=\"COW\"></a>COW</h3><p>只拷贝Conf，拷贝Store的大小。然后进行userfault初始化。之后执行，遇到fault，则利用handle线程处理</p>\n<h2 id=\"WASMEdge分析\"><a href=\"#WASMEdge分析\" class=\"headerlink\" title=\"WASMEdge分析\"></a>WASMEdge分析</h2><p>1.wasm相关数据存储在Store中</p>\n<p>2.一个wasm程序由多个modules组成</p>\n<p><strong>启动流程：</strong></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//待运行文件待路径</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"keyword\">auto</span> InputPath = std::filesystem::<span class=\"built_in\">absolute</span>(SoName.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*******************/</span> </span><br><span class=\"line\"><span class=\"comment\">// 根据Config，初始化VM</span></span><br><span class=\"line\"><span class=\"comment\">// 需要包含全部cli参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">VM::VM <span class=\"title\">VM</span><span class=\"params\">(Conf)</span></span>;</span><br><span class=\"line\">\t-&gt; <span class=\"built_in\">unsafeInitVM</span>(); </span><br><span class=\"line\">\t\t-&gt; <span class=\"built_in\">unsafeLoadBuiltInHosts</span>();     加载 <span class=\"function\">BuiltInModInsts</span></span><br><span class=\"line\"><span class=\"function\">\t\t\t <span class=\"title\">unsafeRegisterBuiltInHosts</span><span class=\"params\">()</span></span>; 登记 ExecutorEngine.registerModule</span><br><span class=\"line\">\t\t\t \t-&gt; <span class=\"built_in\">instantiate</span>(StoreMgr, Mod, Name)</span><br><span class=\"line\"><span class=\"comment\">/*******************/</span> </span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\">/*******************/</span>    </span><br><span class=\"line\"><span class=\"comment\">// 初始化module，包含TableSec、FunctionSec\t等\t\t</span></span><br><span class=\"line\"><span class=\"comment\">// 根据module，初始化stack</span></span><br><span class=\"line\">      </span><br><span class=\"line\">VM.<span class=\"built_in\">loadWasm</span>(InputPath.<span class=\"built_in\">u8string</span>());</span><br><span class=\"line\">\t-&gt; LoaderEngine.<span class=\"built_in\">parseModule</span>(Path)</span><br><span class=\"line\">\t\t-&gt; FMgr.<span class=\"built_in\">setPath</span>(FilePath)</span><br><span class=\"line\">\t\t-&gt; <span class=\"keyword\">module</span>.<span class=\"built_in\">loadModule</span>()                  <span class=\"comment\">//读取文件，初始化module </span></span><br><span class=\"line\">    \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">//初始化 VM.Mod</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">VM.<span class=\"built_in\">validate</span>();</span><br><span class=\"line\">\t-&gt; ValidatorEngine.<span class=\"built_in\">validate</span>(*Mod.<span class=\"built_in\">get</span>())   <span class=\"comment\">//验证module</span></span><br><span class=\"line\">                                            <span class=\"comment\">//即上一步获得的 VM.Mod</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">VM.<span class=\"built_in\">instantiate</span>();</span><br><span class=\"line\">\t-&gt; ExecutorEngine.<span class=\"built_in\">instantiateModule</span>(StoreRef, *Mod.<span class=\"built_in\">get</span>())</span><br><span class=\"line\">\t\t\t-&gt; <span class=\"built_in\">instantiate</span>(StoreMgr, Mod)         <span class=\"comment\">//初始化StackManager + 初始化module中的参数（参考文档）</span></span><br><span class=\"line\">\t\t\t-&gt; 初始化 ActiveModInst                <span class=\"comment\">//后续使用ActiveModInst进行函数调用</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">/********************/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化系统环境,WASI</span></span><br><span class=\"line\">WasiMod-&gt;<span class=\"built_in\">getEnv</span>().<span class=\"built_in\">init</span>(</span><br><span class=\"line\">      Dir.<span class=\"built_in\">value</span>(),</span><br><span class=\"line\">      InputPath.<span class=\"built_in\">filename</span>()</span><br><span class=\"line\">      Args.<span class=\"built_in\">value</span>(), Env.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化输入参数</span></span><br><span class=\"line\">std::vector&lt;ValVariant&gt; FuncArgs;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//执行</span></span><br><span class=\"line\">VM.<span class=\"built_in\">asyncExecute</span>(FuncName, FuncArgs, FuncArgTypes);</span><br><span class=\"line\">\t-&gt; ExecutorEngine.<span class=\"built_in\">invoke</span>(*FuncInst, Params, ParamTypes)</span><br><span class=\"line\">\t\t-&gt; <span class=\"built_in\">runFunction</span>(StackMgr, FuncInst, Params) </span><br><span class=\"line\">\t\t\tFuncInst是一个指针，指向Stack中的函数位置</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//End：输出执行结果</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Remote-Migration-steps\"><a href=\"#Remote-Migration-steps\" class=\"headerlink\" title=\"Remote Migration steps\"></a>Remote Migration steps</h2><h3 id=\"Step1-VM-init\"><a href=\"#Step1-VM-init\" class=\"headerlink\" title=\"Step1: VM init\"></a>Step1: VM init</h3><p>这一步，需要从远端拷贝Conf。然后返序列化Conf进行初始化。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">VM</span>(<span class=\"type\">const</span> Configure &amp;Conf):</span><br><span class=\"line\">  <span class=\"built_in\">Conf</span>(Conf)                                            <span class=\"comment\">// 给本地变量Conf赋值</span></span><br><span class=\"line\">  <span class=\"built_in\">Stage</span>(VMStage::Inited),                               <span class=\"comment\">// 默认Init参数，不用改</span></span><br><span class=\"line\">  <span class=\"built_in\">LoaderEngine</span>(Conf, &amp;Executor::Executor::Intrinsics),  <span class=\"comment\">// 把Conf赋值给LoaderEngine    Loader</span></span><br><span class=\"line\">  <span class=\"built_in\">ValidatorEngine</span>(Conf),                                <span class=\"comment\">// 把Conf赋值给ValidatorEngine Validator</span></span><br><span class=\"line\">  <span class=\"built_in\">ExecutorEngine</span>(Conf, &amp;Stat),                          <span class=\"comment\">// 把Conf赋值给ExecutorEngine  Executor</span></span><br><span class=\"line\">  <span class=\"built_in\">Store</span>(std::<span class=\"built_in\">make_unique</span>&lt;Runtime::StoreManager&gt;()),     <span class=\"comment\">// 把Store赋值为新实例化的StoreManager</span></span><br><span class=\"line\">  <span class=\"built_in\">StoreRef</span>(*Store.<span class=\"built_in\">get</span>())                                <span class=\"comment\">// 把StoreRef赋值为Store的指针</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">unsafeLoadBuiltInHosts</span>();                           <span class=\"comment\">// 加载Wasi？</span></span><br><span class=\"line\">    <span class=\"built_in\">unsafeRegisterBuiltInHosts</span>();                       <span class=\"comment\">// 在ExecutorEngine存储，StoreRef和WASI对象</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Stpe2-Module-amp-Stack-init\"><a href=\"#Stpe2-Module-amp-Stack-init\" class=\"headerlink\" title=\"Stpe2: Module &amp; Stack init\"></a>Stpe2: Module &amp; Stack init</h3><p>将以下三步：VM.loadWasm() -&gt; VM.validate() -&gt; VM.instantiate()</p>\n<p>由本地读取文件从而实例化module，改为云端获取。需要拷贝很多个细小的变量，一个都不能漏掉</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t<span class=\"comment\">// 实例化 VM.Mod </span></span><br><span class=\"line\"> <span class=\"comment\">// 1.Postcopy VM.Mod</span></span><br><span class=\"line\"> <span class=\"comment\">// 2.修改Stage Stage = VMStage::Loaded</span></span><br><span class=\"line\">\tVM.<span class=\"built_in\">loadWasm</span>(InputPath.<span class=\"built_in\">u8string</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">// 验证VM.Mod</span></span><br><span class=\"line\"> <span class=\"comment\">// 1.修改Stage</span></span><br><span class=\"line\">VM.<span class=\"built_in\">validate</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//  Stage = VMStage::Instantiated;</span></span><br><span class=\"line\"> <span class=\"comment\">//  实例化 ActiveModInst</span></span><br><span class=\"line\"> <span class=\"comment\">// 1.Postcopy StoreRef            (StoreMgr.registerModule)   初始化 StoreRef中的参数，</span></span><br><span class=\"line\"> <span class=\"comment\">//                                                            NamedMod，一个map，储存了所有Module</span></span><br><span class=\"line\"> <span class=\"comment\">// 2.Postcopy StackMgr            (StackManager StackMgr)     完整的进行反序列化（可能不用拷贝实际上）</span></span><br><span class=\"line\"> <span class=\"comment\">// 3.Postcopy ActiveModInst       (ActiveModInst)             完整的进行反序列化</span></span><br><span class=\"line\"> <span class=\"comment\">//                                                            (这个参数实际上Store中已经包含，因此可能不需要拷贝)</span></span><br><span class=\"line\">VM.<span class=\"built_in\">instantiate</span>();</span><br></pre></td></tr></table></figure>\n\n<p>No COW：需要从远端拷贝module，直接反序列化</p>\n<p>COW：先假初始化，遇到了page fault再从远端拷贝</p>\n<p><strong>参考：</strong></p>\n<p>module本地加载实现：<strong>lib/loader/ast/module.cpp</strong></p>\n<p>module定义： <strong>include/ast/module.h</strong></p>\n<p>StoreMgr、moduleInstance初始化：<strong>lib/executor/instantiate/module.cpp</strong><br>                                                            lib/executor/instantiate/data.cpp</p>\n<h3 id=\"moduleInstance实例化\"><a href=\"#moduleInstance实例化\" class=\"headerlink\" title=\"moduleInstance实例化\"></a>moduleInstance实例化</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 定义</span></span><br><span class=\"line\">std::unique_ptr&lt;Runtime::Instance::ModuleInstance&gt; ModInst;</span><br><span class=\"line\"></span><br><span class=\"line\">ModInst = std::<span class=\"built_in\">make_unique</span>&lt;Runtime::Instance::ModuleInstance&gt;(Name.<span class=\"built_in\">value</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 初始化 FuncType</span></span><br><span class=\"line\">ModInst-&gt;<span class=\"built_in\">addFuncType</span>(FuncType);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ImportSec</span></span><br><span class=\"line\">AST::ImportSection &amp;ImportSec = Mod.<span class=\"built_in\">getImportSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StoreMgr, *ModInst, ImportSec)</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">//初始化FuncSec，CodeSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::FunctionSection &amp;FuncSec = Mod.<span class=\"built_in\">getFunctionSection</span>();</span><br><span class=\"line\"><span class=\"type\">const</span> AST::CodeSection &amp;CodeSec = Mod.<span class=\"built_in\">getCodeSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, FuncSec, CodeSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化 TabSec</span></span><br><span class=\"line\">AST::TableSection &amp;TabSec = Mod.<span class=\"built_in\">getTableSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, TabSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化 MemSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::MemorySection &amp;MemSec = Mod.<span class=\"built_in\">getMemorySection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, MemSec);</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">// 初始化 GlobSec</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ExportSec</span></span><br><span class=\"line\"><span class=\"type\">const</span> AST::ExportSection &amp;ExportSec = Mod.<span class=\"built_in\">getExportSection</span>();</span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(*ModInst, ExportSec);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化ElemSec</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StackMgr, *ModInst, ElemSec)</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">//初始化   DataSec</span></span><br><span class=\"line\"><span class=\"built_in\">instantiate</span>(StackMgr, *ModInst, DataSec)</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n\n\n\n<hr>\n<p><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md\">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md</a></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-03-16%2011.32.20.png\" alt=\"截屏2023-03-16 11.32.20\"></p>\n<p><a href=\"https://juejin.cn/post/6844904062148689933\">https://juejin.cn/post/6844904062148689933</a></p>\n"},{"title":"test","date":"2023-08-08T15:20:15.000Z","_content":"\n\n\n![a](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/a.png)\n","source":"_posts/test-1.md","raw":"---\ntitle: test\ndate: 2023-08-08 23:20:15\ntags:\n---\n\n\n\n![a](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/a.png)\n","slug":"test-1","published":1,"updated":"2023-08-08T15:20:41.826Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cll2g7vy30000fookguguhy80","content":"<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/a.png\" alt=\"a\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/a.png\" alt=\"a\"></p>\n"},{"title":"823. Binary Trees With Factors","date":"2023-08-28T19:09:46.000Z","_content":"\n## Question\n\nGiven an array of unique integers, `arr`, where each integer `arr[i]` is strictly greater than `1`.\n\nWe make a binary tree using these integers, and each number may be used for any number of times. Each non-leaf node's value should be equal to the product of the values of its children.\n\nReturn *the number of binary trees we can make*. The answer may be too large so return the answer **modulo** `1^9 + 7`.\n\n\n\n**Example 1:**\n\n```\nInput: arr = [2,4]\nOutput: 3\nExplanation: We can make these trees: [2], [4], [4, 2, 2]\n```\n\n**Example 2:**\n\n```\nInput: arr = [2,4,5,10]\nOutput: 7\nExplanation: We can make these trees: [2], [4], [5], [10], [4, 2, 2], [10, 2, 5], [10, 5, 2].\n```\n\n## Solution\n\nIn this question, it's easy to find that for each number n, it is a child question which has no connect with what the parent of this number is. So, we can use the memorized dfs to solve this problem.\n\nIn addition, for number n, i assume that this number can be devided into arr[i]*arr[j]; So dfs(n) = dfs(arr[i]) * dis(arr[j]). This is because for each legal child tree with arr[i] as the root, it can be combine with each legal child tree with arr[j] as the root. So, i can sort the arr, and find out all arr[i] and arr[j] pairs. \n\nThere is a important point, when multiply two ints together and storage it into a long. These to Int number may over the limit. So, to get the right ans, i need to transfer in to long firstly. And that make the multiply.\n\nMy solution is as below: \n\n```java\nclass Solution {\n    int mod = (int) 1e9 + 7;\n    Map<Integer,Integer> con=new HashMap<>();\n\n    public int numFactoredBinaryTrees(int[] arr) {\n      \n      Arrays.sort(arr);\n\n      Set<Integer> arrSet = new HashSet<>();\n      for(int i=0;i<arr.length;i++){\n        arrSet.add(arr[i]);\n      }\n\n      int ans=0;\n      for(int i=0;i<arr.length;i++){\n        ans+=dfs(arr[i],arr,arrSet);\n        ans %= mod;\n      }\n      return ans;\n\n    }\n    public int dfs(int nowNum,int[] arr,Set<Integer> arrSet){\n      if(con.containsKey(nowNum)) return con.get(nowNum);\n      \n      long res=1;\n      for(int i=0;i<arr.length;i++){\n        if(arr[i]>=nowNum) break;\n\n        int r=nowNum/arr[i];\n        if(nowNum==arr[i]*r && arrSet.contains(r)){\n          //System.out.println(nowNum+\"->\"+r+\" \"+arr[i]); \n          res+=((1l)*dfs(r,arr,arrSet)) * ((1l)*dfs(arr[i],arr,arrSet));\n          res %= mod;\n        }\n      }\n\n      res %= mod;\n      con.put(nowNum,(int)res);\n      //if(res != (int)res) System.out.println(\"error\");\n      return (int)res;\n    }\n}\n\n// s1: sort\n/*\n4 2 2\n  4\n /  \\\n2    2\n\n\n\n*/\n```\n\n\n\n","source":"_posts/823-Binary-Trees-With-Factors.md","raw":"---\ntitle: 823. Binary Trees With Factors\ndate: 2023-08-28 14:09:46\ntags:\n---\n\n## Question\n\nGiven an array of unique integers, `arr`, where each integer `arr[i]` is strictly greater than `1`.\n\nWe make a binary tree using these integers, and each number may be used for any number of times. Each non-leaf node's value should be equal to the product of the values of its children.\n\nReturn *the number of binary trees we can make*. The answer may be too large so return the answer **modulo** `1^9 + 7`.\n\n\n\n**Example 1:**\n\n```\nInput: arr = [2,4]\nOutput: 3\nExplanation: We can make these trees: [2], [4], [4, 2, 2]\n```\n\n**Example 2:**\n\n```\nInput: arr = [2,4,5,10]\nOutput: 7\nExplanation: We can make these trees: [2], [4], [5], [10], [4, 2, 2], [10, 2, 5], [10, 5, 2].\n```\n\n## Solution\n\nIn this question, it's easy to find that for each number n, it is a child question which has no connect with what the parent of this number is. So, we can use the memorized dfs to solve this problem.\n\nIn addition, for number n, i assume that this number can be devided into arr[i]*arr[j]; So dfs(n) = dfs(arr[i]) * dis(arr[j]). This is because for each legal child tree with arr[i] as the root, it can be combine with each legal child tree with arr[j] as the root. So, i can sort the arr, and find out all arr[i] and arr[j] pairs. \n\nThere is a important point, when multiply two ints together and storage it into a long. These to Int number may over the limit. So, to get the right ans, i need to transfer in to long firstly. And that make the multiply.\n\nMy solution is as below: \n\n```java\nclass Solution {\n    int mod = (int) 1e9 + 7;\n    Map<Integer,Integer> con=new HashMap<>();\n\n    public int numFactoredBinaryTrees(int[] arr) {\n      \n      Arrays.sort(arr);\n\n      Set<Integer> arrSet = new HashSet<>();\n      for(int i=0;i<arr.length;i++){\n        arrSet.add(arr[i]);\n      }\n\n      int ans=0;\n      for(int i=0;i<arr.length;i++){\n        ans+=dfs(arr[i],arr,arrSet);\n        ans %= mod;\n      }\n      return ans;\n\n    }\n    public int dfs(int nowNum,int[] arr,Set<Integer> arrSet){\n      if(con.containsKey(nowNum)) return con.get(nowNum);\n      \n      long res=1;\n      for(int i=0;i<arr.length;i++){\n        if(arr[i]>=nowNum) break;\n\n        int r=nowNum/arr[i];\n        if(nowNum==arr[i]*r && arrSet.contains(r)){\n          //System.out.println(nowNum+\"->\"+r+\" \"+arr[i]); \n          res+=((1l)*dfs(r,arr,arrSet)) * ((1l)*dfs(arr[i],arr,arrSet));\n          res %= mod;\n        }\n      }\n\n      res %= mod;\n      con.put(nowNum,(int)res);\n      //if(res != (int)res) System.out.println(\"error\");\n      return (int)res;\n    }\n}\n\n// s1: sort\n/*\n4 2 2\n  4\n /  \\\n2    2\n\n\n\n*/\n```\n\n\n\n","slug":"823-Binary-Trees-With-Factors","published":1,"updated":"2023-08-28T19:21:25.078Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cllv9mffk0000w0g0eizj8bmj","content":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>Given an array of unique integers, <code>arr</code>, where each integer <code>arr[i]</code> is strictly greater than <code>1</code>.</p>\n<p>We make a binary tree using these integers, and each number may be used for any number of times. Each non-leaf node’s value should be equal to the product of the values of its children.</p>\n<p>Return <em>the number of binary trees we can make</em>. The answer may be too large so return the answer <strong>modulo</strong> <code>1^9 + 7</code>.</p>\n<p><strong>Example 1:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: arr = [2,4]</span><br><span class=\"line\">Output: 3</span><br><span class=\"line\">Explanation: We can make these trees: [2], [4], [4, 2, 2]</span><br></pre></td></tr></table></figure>\n\n<p><strong>Example 2:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: arr = [2,4,5,10]</span><br><span class=\"line\">Output: 7</span><br><span class=\"line\">Explanation: We can make these trees: [2], [4], [5], [10], [4, 2, 2], [10, 2, 5], [10, 5, 2].</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>In this question, it’s easy to find that for each number n, it is a child question which has no connect with what the parent of this number is. So, we can use the memorized dfs to solve this problem.</p>\n<p>In addition, for number n, i assume that this number can be devided into arr[i]*arr[j]; So dfs(n) = dfs(arr[i]) * dis(arr[j]). This is because for each legal child tree with arr[i] as the root, it can be combine with each legal child tree with arr[j] as the root. So, i can sort the arr, and find out all arr[i] and arr[j] pairs. </p>\n<p>There is a important point, when multiply two ints together and storage it into a long. These to Int number may over the limit. So, to get the right ans, i need to transfer in to long firstly. And that make the multiply.</p>\n<p>My solution is as below: </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mod</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) <span class=\"number\">1e9</span> + <span class=\"number\">7</span>;</span><br><span class=\"line\">    Map&lt;Integer,Integer&gt; con=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">numFactoredBinaryTrees</span><span class=\"params\">(<span class=\"type\">int</span>[] arr)</span> &#123;</span><br><span class=\"line\">      </span><br><span class=\"line\">      Arrays.sort(arr);</span><br><span class=\"line\"></span><br><span class=\"line\">      Set&lt;Integer&gt; arrSet = <span class=\"keyword\">new</span> <span class=\"title class_\">HashSet</span>&lt;&gt;();</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        arrSet.add(arr[i]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">int</span> ans=<span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        ans+=dfs(arr[i],arr,arrSet);</span><br><span class=\"line\">        ans %= mod;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">dfs</span><span class=\"params\">(<span class=\"type\">int</span> nowNum,<span class=\"type\">int</span>[] arr,Set&lt;Integer&gt; arrSet)</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(con.containsKey(nowNum)) <span class=\"keyword\">return</span> con.get(nowNum);</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"type\">long</span> res=<span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(arr[i]&gt;=nowNum) <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> r=nowNum/arr[i];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(nowNum==arr[i]*r &amp;&amp; arrSet.contains(r))&#123;</span><br><span class=\"line\">          <span class=\"comment\">//System.out.println(nowNum+&quot;-&gt;&quot;+r+&quot; &quot;+arr[i]); </span></span><br><span class=\"line\">          res+=((<span class=\"number\">1l</span>)*dfs(r,arr,arrSet)) * ((<span class=\"number\">1l</span>)*dfs(arr[i],arr,arrSet));</span><br><span class=\"line\">          res %= mod;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      res %= mod;</span><br><span class=\"line\">      con.put(nowNum,(<span class=\"type\">int</span>)res);</span><br><span class=\"line\">      <span class=\"comment\">//if(res != (int)res) System.out.println(&quot;error&quot;);</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// s1: sort</span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">4 2 2</span></span><br><span class=\"line\"><span class=\"comment\">  4</span></span><br><span class=\"line\"><span class=\"comment\"> /  \\</span></span><br><span class=\"line\"><span class=\"comment\">2    2</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>Given an array of unique integers, <code>arr</code>, where each integer <code>arr[i]</code> is strictly greater than <code>1</code>.</p>\n<p>We make a binary tree using these integers, and each number may be used for any number of times. Each non-leaf node’s value should be equal to the product of the values of its children.</p>\n<p>Return <em>the number of binary trees we can make</em>. The answer may be too large so return the answer <strong>modulo</strong> <code>1^9 + 7</code>.</p>\n<p><strong>Example 1:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: arr = [2,4]</span><br><span class=\"line\">Output: 3</span><br><span class=\"line\">Explanation: We can make these trees: [2], [4], [4, 2, 2]</span><br></pre></td></tr></table></figure>\n\n<p><strong>Example 2:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: arr = [2,4,5,10]</span><br><span class=\"line\">Output: 7</span><br><span class=\"line\">Explanation: We can make these trees: [2], [4], [5], [10], [4, 2, 2], [10, 2, 5], [10, 5, 2].</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>In this question, it’s easy to find that for each number n, it is a child question which has no connect with what the parent of this number is. So, we can use the memorized dfs to solve this problem.</p>\n<p>In addition, for number n, i assume that this number can be devided into arr[i]*arr[j]; So dfs(n) = dfs(arr[i]) * dis(arr[j]). This is because for each legal child tree with arr[i] as the root, it can be combine with each legal child tree with arr[j] as the root. So, i can sort the arr, and find out all arr[i] and arr[j] pairs. </p>\n<p>There is a important point, when multiply two ints together and storage it into a long. These to Int number may over the limit. So, to get the right ans, i need to transfer in to long firstly. And that make the multiply.</p>\n<p>My solution is as below: </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mod</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) <span class=\"number\">1e9</span> + <span class=\"number\">7</span>;</span><br><span class=\"line\">    Map&lt;Integer,Integer&gt; con=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">numFactoredBinaryTrees</span><span class=\"params\">(<span class=\"type\">int</span>[] arr)</span> &#123;</span><br><span class=\"line\">      </span><br><span class=\"line\">      Arrays.sort(arr);</span><br><span class=\"line\"></span><br><span class=\"line\">      Set&lt;Integer&gt; arrSet = <span class=\"keyword\">new</span> <span class=\"title class_\">HashSet</span>&lt;&gt;();</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        arrSet.add(arr[i]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">int</span> ans=<span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        ans+=dfs(arr[i],arr,arrSet);</span><br><span class=\"line\">        ans %= mod;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> ans;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">dfs</span><span class=\"params\">(<span class=\"type\">int</span> nowNum,<span class=\"type\">int</span>[] arr,Set&lt;Integer&gt; arrSet)</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(con.containsKey(nowNum)) <span class=\"keyword\">return</span> con.get(nowNum);</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"type\">long</span> res=<span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(arr[i]&gt;=nowNum) <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> r=nowNum/arr[i];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(nowNum==arr[i]*r &amp;&amp; arrSet.contains(r))&#123;</span><br><span class=\"line\">          <span class=\"comment\">//System.out.println(nowNum+&quot;-&gt;&quot;+r+&quot; &quot;+arr[i]); </span></span><br><span class=\"line\">          res+=((<span class=\"number\">1l</span>)*dfs(r,arr,arrSet)) * ((<span class=\"number\">1l</span>)*dfs(arr[i],arr,arrSet));</span><br><span class=\"line\">          res %= mod;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      res %= mod;</span><br><span class=\"line\">      con.put(nowNum,(<span class=\"type\">int</span>)res);</span><br><span class=\"line\">      <span class=\"comment\">//if(res != (int)res) System.out.println(&quot;error&quot;);</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// s1: sort</span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">4 2 2</span></span><br><span class=\"line\"><span class=\"comment\">  4</span></span><br><span class=\"line\"><span class=\"comment\"> /  \\</span></span><br><span class=\"line\"><span class=\"comment\">2    2</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n\n\n"},{"title":"MapRedece lab","date":"2023-08-27T14:39:55.000Z","_content":"\n## Why Map Reduce\n\nWhen we need to figure out how many word in a great amount of web pages, the easist way is load file one by one and count up the words in them. The way may very slow and we can't get the answer  in a resonable time. So, one better solution is load all files into memory, and then count the word in them in one time. But this approach may need a very big memory. Normal computer will not have such a high config in most of time. To balance the conflict of \"one by one\" and \"load in on time\", MapReduce algorithm was posted by Jeff Dean when he worked in google.\n\nThe whole process of MapReduce is in the graph below:\n\n1. Split files into some small part\n2. Send these splits to workers, and workers will make the map process\n3. Map: count up the number of each word in split\n   1. like this: Word1 number1 Word2 number2 Word1 number3\n\n![](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-08-27 09.42.55.png)\n","source":"_posts/MapRedece.md","raw":"---\ntitle: MapRedece lab\ndate: 2023-08-27 09:39:55\ntags:\n---\n\n## Why Map Reduce\n\nWhen we need to figure out how many word in a great amount of web pages, the easist way is load file one by one and count up the words in them. The way may very slow and we can't get the answer  in a resonable time. So, one better solution is load all files into memory, and then count the word in them in one time. But this approach may need a very big memory. Normal computer will not have such a high config in most of time. To balance the conflict of \"one by one\" and \"load in on time\", MapReduce algorithm was posted by Jeff Dean when he worked in google.\n\nThe whole process of MapReduce is in the graph below:\n\n1. Split files into some small part\n2. Send these splits to workers, and workers will make the map process\n3. Map: count up the number of each word in split\n   1. like this: Word1 number1 Word2 number2 Word1 number3\n\n![](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-08-27 09.42.55.png)\n","slug":"MapRedece","published":1,"updated":"2023-09-01T18:58:52.410Z","_id":"cllv9mffm0001w0g06jyl87wt","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"Why-Map-Reduce\"><a href=\"#Why-Map-Reduce\" class=\"headerlink\" title=\"Why Map Reduce\"></a>Why Map Reduce</h2><p>When we need to figure out how many word in a great amount of web pages, the easist way is load file one by one and count up the words in them. The way may very slow and we can’t get the answer  in a resonable time. So, one better solution is load all files into memory, and then count the word in them in one time. But this approach may need a very big memory. Normal computer will not have such a high config in most of time. To balance the conflict of “one by one” and “load in on time”, MapReduce algorithm was posted by Jeff Dean when he worked in google.</p>\n<p>The whole process of MapReduce is in the graph below:</p>\n<ol>\n<li>Split files into some small part</li>\n<li>Send these splits to workers, and workers will make the map process</li>\n<li>Map: count up the number of each word in split<ol>\n<li>like this: Word1 number1 Word2 number2 Word1 number3</li>\n</ol>\n</li>\n</ol>\n<p>![](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-08-27 09.42.55.png)</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Why-Map-Reduce\"><a href=\"#Why-Map-Reduce\" class=\"headerlink\" title=\"Why Map Reduce\"></a>Why Map Reduce</h2><p>When we need to figure out how many word in a great amount of web pages, the easist way is load file one by one and count up the words in them. The way may very slow and we can’t get the answer  in a resonable time. So, one better solution is load all files into memory, and then count the word in them in one time. But this approach may need a very big memory. Normal computer will not have such a high config in most of time. To balance the conflict of “one by one” and “load in on time”, MapReduce algorithm was posted by Jeff Dean when he worked in google.</p>\n<p>The whole process of MapReduce is in the graph below:</p>\n<ol>\n<li>Split files into some small part</li>\n<li>Send these splits to workers, and workers will make the map process</li>\n<li>Map: count up the number of each word in split<ol>\n<li>like this: Word1 number1 Word2 number2 Word1 number3</li>\n</ol>\n</li>\n</ol>\n<p>![](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-08-27 09.42.55.png)</p>\n"},{"title":"853. Car Fleet","date":"2023-09-01T18:46:11.000Z","_content":"\n## Question\n\nThere are `n` cars going to the same destination along a one-lane road. The destination is `target` miles away.\n\nYou are given two integer array `position` and `speed`, both of length `n`, where `position[i]` is the position of the `ith` car and `speed[i]` is the speed of the `ith` car (in miles per hour).\n\nA car can never pass another car ahead of it, but it can catch up to it and drive bumper to bumper **at the same speed**. The faster car will **slow down** to match the slower car's speed. The distance between these two cars is ignored (i.e., they are assumed to have the same position).\n\nA **car fleet** is some non-empty set of cars driving at the same position and same speed. Note that a single car is also a car fleet.\n\nIf a car catches up to a car fleet right at the destination point, it will still be considered as one car fleet.\n\nReturn *the **number of car fleets** that will arrive at the destination*.\n\n**Example 1:**\n\n```\nInput: target = 12, position = [10,8,0,5,3], speed = [2,4,1,1,3]\nOutput: 3\nExplanation:\nThe cars starting at 10 (speed 2) and 8 (speed 4) become a fleet, meeting each other at 12.\nThe car starting at 0 does not catch up to any other car, so it is a fleet by itself.\nThe cars starting at 5 (speed 1) and 3 (speed 3) become a fleet, meeting each other at 6. The fleet moves at speed 1 until it reaches target.\nNote that no other cars meet these fleets before the destination, so the answer is 3.\n```\n\n\n\n## Solution\n\nFirstly, this problem give me some positions. These position a unsorted. So it is obvious that the first step should be sort these cars by position.\n\n```java\n\t\t\t\tint[][] cars=new int[position.length][2];\n        for(int i=0;i<position.length;i++){\n            cars[i][0]=position[i];\n            cars[i][1]=speed[i];\n        }\n\n        Arrays.sort(cars,(a,b)->(a[0]-b[0]));\n```\n\nAnd then, after the sort, we can fint that when there are two cars(first are is in i, second is in j, i<j). There are two situations:\n\n1. First car need n time unit to array target and second car need m time unit to array target. If n<=m, these two cars will always become a car fleet.\n2. First car need n time unit to array target and second car need m time unit to array target. If n>m, these two cars will not become a car fleet.\n\nSo, we can use a stack to record car fleets. If a new car's array time is small than peek in stack, we merge this car into peek fleet. On the contrary, the car can make up a new fleet. I just push this car into stack;\n\n```java\nclass Solution {\n    public int carFleet(int target, int[] position, int[] speed) {\n       \n        int[][] cars=new int[position.length][2];\n        for(int i=0;i<position.length;i++){\n            cars[i][0]=position[i];\n            cars[i][1]=speed[i];\n        }\n\n        Arrays.sort(cars,(a,b)->(a[0]-b[0]));\n\n        List<int[]> stack=new LinkedList<>();\n\n        for(int i=0;i<cars.length;i++){\n            if(stack.size()==0){\n                stack.add(cars[i]);\n                continue;\n            }\n            double time=((target-cars[i][0])*1.0) / (cars[i][1]*1.0);\n            // stack.get(stack.size()-1)[1]\n            while(stack.size()!=0 && ((target-stack.get(stack.size()-1)[0])*1.0) / (stack.get(stack.size()-1)[1]*1.0) <= time){\n                stack.remove(stack.size()-1);\n            }\n            stack.add(cars[i]);\n        }\n\n        return stack.size();\n    }\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/853-Car-Fleet.md","raw":"---\ntitle: 853. Car Fleet\ndate: 2023-09-01 13:46:11\ntags:\n---\n\n## Question\n\nThere are `n` cars going to the same destination along a one-lane road. The destination is `target` miles away.\n\nYou are given two integer array `position` and `speed`, both of length `n`, where `position[i]` is the position of the `ith` car and `speed[i]` is the speed of the `ith` car (in miles per hour).\n\nA car can never pass another car ahead of it, but it can catch up to it and drive bumper to bumper **at the same speed**. The faster car will **slow down** to match the slower car's speed. The distance between these two cars is ignored (i.e., they are assumed to have the same position).\n\nA **car fleet** is some non-empty set of cars driving at the same position and same speed. Note that a single car is also a car fleet.\n\nIf a car catches up to a car fleet right at the destination point, it will still be considered as one car fleet.\n\nReturn *the **number of car fleets** that will arrive at the destination*.\n\n**Example 1:**\n\n```\nInput: target = 12, position = [10,8,0,5,3], speed = [2,4,1,1,3]\nOutput: 3\nExplanation:\nThe cars starting at 10 (speed 2) and 8 (speed 4) become a fleet, meeting each other at 12.\nThe car starting at 0 does not catch up to any other car, so it is a fleet by itself.\nThe cars starting at 5 (speed 1) and 3 (speed 3) become a fleet, meeting each other at 6. The fleet moves at speed 1 until it reaches target.\nNote that no other cars meet these fleets before the destination, so the answer is 3.\n```\n\n\n\n## Solution\n\nFirstly, this problem give me some positions. These position a unsorted. So it is obvious that the first step should be sort these cars by position.\n\n```java\n\t\t\t\tint[][] cars=new int[position.length][2];\n        for(int i=0;i<position.length;i++){\n            cars[i][0]=position[i];\n            cars[i][1]=speed[i];\n        }\n\n        Arrays.sort(cars,(a,b)->(a[0]-b[0]));\n```\n\nAnd then, after the sort, we can fint that when there are two cars(first are is in i, second is in j, i<j). There are two situations:\n\n1. First car need n time unit to array target and second car need m time unit to array target. If n<=m, these two cars will always become a car fleet.\n2. First car need n time unit to array target and second car need m time unit to array target. If n>m, these two cars will not become a car fleet.\n\nSo, we can use a stack to record car fleets. If a new car's array time is small than peek in stack, we merge this car into peek fleet. On the contrary, the car can make up a new fleet. I just push this car into stack;\n\n```java\nclass Solution {\n    public int carFleet(int target, int[] position, int[] speed) {\n       \n        int[][] cars=new int[position.length][2];\n        for(int i=0;i<position.length;i++){\n            cars[i][0]=position[i];\n            cars[i][1]=speed[i];\n        }\n\n        Arrays.sort(cars,(a,b)->(a[0]-b[0]));\n\n        List<int[]> stack=new LinkedList<>();\n\n        for(int i=0;i<cars.length;i++){\n            if(stack.size()==0){\n                stack.add(cars[i]);\n                continue;\n            }\n            double time=((target-cars[i][0])*1.0) / (cars[i][1]*1.0);\n            // stack.get(stack.size()-1)[1]\n            while(stack.size()!=0 && ((target-stack.get(stack.size()-1)[0])*1.0) / (stack.get(stack.size()-1)[1]*1.0) <= time){\n                stack.remove(stack.size()-1);\n            }\n            stack.add(cars[i]);\n        }\n\n        return stack.size();\n    }\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"853-Car-Fleet","published":1,"updated":"2023-09-01T18:55:42.902Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clm0yhd4z0000zzex0z8i8zan","content":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>There are <code>n</code> cars going to the same destination along a one-lane road. The destination is <code>target</code> miles away.</p>\n<p>You are given two integer array <code>position</code> and <code>speed</code>, both of length <code>n</code>, where <code>position[i]</code> is the position of the <code>ith</code> car and <code>speed[i]</code> is the speed of the <code>ith</code> car (in miles per hour).</p>\n<p>A car can never pass another car ahead of it, but it can catch up to it and drive bumper to bumper <strong>at the same speed</strong>. The faster car will <strong>slow down</strong> to match the slower car’s speed. The distance between these two cars is ignored (i.e., they are assumed to have the same position).</p>\n<p>A <strong>car fleet</strong> is some non-empty set of cars driving at the same position and same speed. Note that a single car is also a car fleet.</p>\n<p>If a car catches up to a car fleet right at the destination point, it will still be considered as one car fleet.</p>\n<p>Return <em>the <strong>number of car fleets</strong> that will arrive at the destination</em>.</p>\n<p><strong>Example 1:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: target = 12, position = [10,8,0,5,3], speed = [2,4,1,1,3]</span><br><span class=\"line\">Output: 3</span><br><span class=\"line\">Explanation:</span><br><span class=\"line\">The cars starting at 10 (speed 2) and 8 (speed 4) become a fleet, meeting each other at 12.</span><br><span class=\"line\">The car starting at 0 does not catch up to any other car, so it is a fleet by itself.</span><br><span class=\"line\">The cars starting at 5 (speed 1) and 3 (speed 3) become a fleet, meeting each other at 6. The fleet moves at speed 1 until it reaches target.</span><br><span class=\"line\">Note that no other cars meet these fleets before the destination, so the answer is 3.</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>Firstly, this problem give me some positions. These position a unsorted. So it is obvious that the first step should be sort these cars by position.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span>[][] cars=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[position.length][<span class=\"number\">2</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;position.length;i++)&#123;</span><br><span class=\"line\">        cars[i][<span class=\"number\">0</span>]=position[i];</span><br><span class=\"line\">        cars[i][<span class=\"number\">1</span>]=speed[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Arrays.sort(cars,(a,b)-&gt;(a[<span class=\"number\">0</span>]-b[<span class=\"number\">0</span>]));</span><br></pre></td></tr></table></figure>\n\n<p>And then, after the sort, we can fint that when there are two cars(first are is in i, second is in j, i&lt;j). There are two situations:</p>\n<ol>\n<li>First car need n time unit to array target and second car need m time unit to array target. If n&lt;=m, these two cars will always become a car fleet.</li>\n<li>First car need n time unit to array target and second car need m time unit to array target. If n&gt;m, these two cars will not become a car fleet.</li>\n</ol>\n<p>So, we can use a stack to record car fleets. If a new car’s array time is small than peek in stack, we merge this car into peek fleet. On the contrary, the car can make up a new fleet. I just push this car into stack;</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">carFleet</span><span class=\"params\">(<span class=\"type\">int</span> target, <span class=\"type\">int</span>[] position, <span class=\"type\">int</span>[] speed)</span> &#123;</span><br><span class=\"line\">       </span><br><span class=\"line\">        <span class=\"type\">int</span>[][] cars=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[position.length][<span class=\"number\">2</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;position.length;i++)&#123;</span><br><span class=\"line\">            cars[i][<span class=\"number\">0</span>]=position[i];</span><br><span class=\"line\">            cars[i][<span class=\"number\">1</span>]=speed[i];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Arrays.sort(cars,(a,b)-&gt;(a[<span class=\"number\">0</span>]-b[<span class=\"number\">0</span>]));</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;<span class=\"type\">int</span>[]&gt; stack=<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;cars.length;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(stack.size()==<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">                stack.add(cars[i]);</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">double</span> time=((target-cars[i][<span class=\"number\">0</span>])*<span class=\"number\">1.0</span>) / (cars[i][<span class=\"number\">1</span>]*<span class=\"number\">1.0</span>);</span><br><span class=\"line\">            <span class=\"comment\">// stack.get(stack.size()-1)[1]</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(stack.size()!=<span class=\"number\">0</span> &amp;&amp; ((target-stack.get(stack.size()-<span class=\"number\">1</span>)[<span class=\"number\">0</span>])*<span class=\"number\">1.0</span>) / (stack.get(stack.size()-<span class=\"number\">1</span>)[<span class=\"number\">1</span>]*<span class=\"number\">1.0</span>) &lt;= time)&#123;</span><br><span class=\"line\">                stack.remove(stack.size()-<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            stack.add(cars[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> stack.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h2><p>There are <code>n</code> cars going to the same destination along a one-lane road. The destination is <code>target</code> miles away.</p>\n<p>You are given two integer array <code>position</code> and <code>speed</code>, both of length <code>n</code>, where <code>position[i]</code> is the position of the <code>ith</code> car and <code>speed[i]</code> is the speed of the <code>ith</code> car (in miles per hour).</p>\n<p>A car can never pass another car ahead of it, but it can catch up to it and drive bumper to bumper <strong>at the same speed</strong>. The faster car will <strong>slow down</strong> to match the slower car’s speed. The distance between these two cars is ignored (i.e., they are assumed to have the same position).</p>\n<p>A <strong>car fleet</strong> is some non-empty set of cars driving at the same position and same speed. Note that a single car is also a car fleet.</p>\n<p>If a car catches up to a car fleet right at the destination point, it will still be considered as one car fleet.</p>\n<p>Return <em>the <strong>number of car fleets</strong> that will arrive at the destination</em>.</p>\n<p><strong>Example 1:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input: target = 12, position = [10,8,0,5,3], speed = [2,4,1,1,3]</span><br><span class=\"line\">Output: 3</span><br><span class=\"line\">Explanation:</span><br><span class=\"line\">The cars starting at 10 (speed 2) and 8 (speed 4) become a fleet, meeting each other at 12.</span><br><span class=\"line\">The car starting at 0 does not catch up to any other car, so it is a fleet by itself.</span><br><span class=\"line\">The cars starting at 5 (speed 1) and 3 (speed 3) become a fleet, meeting each other at 6. The fleet moves at speed 1 until it reaches target.</span><br><span class=\"line\">Note that no other cars meet these fleets before the destination, so the answer is 3.</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>Firstly, this problem give me some positions. These position a unsorted. So it is obvious that the first step should be sort these cars by position.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span>[][] cars=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[position.length][<span class=\"number\">2</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;position.length;i++)&#123;</span><br><span class=\"line\">        cars[i][<span class=\"number\">0</span>]=position[i];</span><br><span class=\"line\">        cars[i][<span class=\"number\">1</span>]=speed[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Arrays.sort(cars,(a,b)-&gt;(a[<span class=\"number\">0</span>]-b[<span class=\"number\">0</span>]));</span><br></pre></td></tr></table></figure>\n\n<p>And then, after the sort, we can fint that when there are two cars(first are is in i, second is in j, i&lt;j). There are two situations:</p>\n<ol>\n<li>First car need n time unit to array target and second car need m time unit to array target. If n&lt;=m, these two cars will always become a car fleet.</li>\n<li>First car need n time unit to array target and second car need m time unit to array target. If n&gt;m, these two cars will not become a car fleet.</li>\n</ol>\n<p>So, we can use a stack to record car fleets. If a new car’s array time is small than peek in stack, we merge this car into peek fleet. On the contrary, the car can make up a new fleet. I just push this car into stack;</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">carFleet</span><span class=\"params\">(<span class=\"type\">int</span> target, <span class=\"type\">int</span>[] position, <span class=\"type\">int</span>[] speed)</span> &#123;</span><br><span class=\"line\">       </span><br><span class=\"line\">        <span class=\"type\">int</span>[][] cars=<span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[position.length][<span class=\"number\">2</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;position.length;i++)&#123;</span><br><span class=\"line\">            cars[i][<span class=\"number\">0</span>]=position[i];</span><br><span class=\"line\">            cars[i][<span class=\"number\">1</span>]=speed[i];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Arrays.sort(cars,(a,b)-&gt;(a[<span class=\"number\">0</span>]-b[<span class=\"number\">0</span>]));</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;<span class=\"type\">int</span>[]&gt; stack=<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;cars.length;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(stack.size()==<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">                stack.add(cars[i]);</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">double</span> time=((target-cars[i][<span class=\"number\">0</span>])*<span class=\"number\">1.0</span>) / (cars[i][<span class=\"number\">1</span>]*<span class=\"number\">1.0</span>);</span><br><span class=\"line\">            <span class=\"comment\">// stack.get(stack.size()-1)[1]</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(stack.size()!=<span class=\"number\">0</span> &amp;&amp; ((target-stack.get(stack.size()-<span class=\"number\">1</span>)[<span class=\"number\">0</span>])*<span class=\"number\">1.0</span>) / (stack.get(stack.size()-<span class=\"number\">1</span>)[<span class=\"number\">1</span>]*<span class=\"number\">1.0</span>) &lt;= time)&#123;</span><br><span class=\"line\">                stack.remove(stack.size()-<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            stack.add(cars[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> stack.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"Color-FaaS","date":"2023-09-25T17:49:46.000Z","_content":"\n# Color FaaS Design Doc\n\nDesigned By Hanzhong Liu, Xi Shi\n\nVideo: https://www.youtube.com/watch?v=QDuIaaMpTBo\n\n## High Level Design\n\n### Requirements\n\nI plan to design a FaaS platform called Color FaaS. Color FaaS will has the ability to process many kinds of task like AWS Lambda. The platform will include user registration, function creation and management, billing and payment.\n\n**User case 1**: Development\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | A User want to deploy a application in cloud environment     |\n| Path  | 1. User must develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file, and the function file is successfully created <br />3. User test this function from web browser.<br />4. System calls the function and returns the result |\n\n**User case 2**: Pay the bill\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Pay the bill                                                 |\n| Path  | 1. User login into the platftom<br />2. System verifies that user information is correct<br />3. User enter the account info page<br />4. System return the web page to user<br />5. User click \"bill\" button<br />6. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />7. User click \"Pay\" button<br />8. System redirects to the payment page<br />9. User enter all information in the payment form and submit<br />10. System deducts the fee and completes the payment |\n\n**User case 3**: Manage function\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Trace  the running status of a Func                          |\n| Path  | 1. User login into the platform<br />2. System verifies that user information is correct<br />3. User enter Task manage page<br />4. System return the manage page<br />5. User use search to find the target Func<br />6. System search from the database and return it to user<br />7. User look at the running status of the function |\n\n### Architectural design\n\nThe system is divided into three layers: the website, the gateway, and the cluster. The website is primarily responsible for user interaction and needs to connect to the database to store user information. The gateway layer is a simplified implementation that can be replaced with gateways like AWS ELB (Elastic Load Balancer). The cluster is the core of the entire Color FaaS platform. Here, I have designed a decentralized resource scheduler and use Docker for handling user tasks.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/2023-09-2716.58.19.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\nIn Website layer, we use Java Serverlet to develop a Web application.We also use Mysql to store user's information. Website will provide user with functions include: add/delete a Func, pay for the bill, trace Func status.\n\nFor GateWay, all request will be send to gateway, and gateway will write infomation about the task into DB. In the end, gateway will sent task to Core cluster.\n\nCore cluster may contains many servers, so it can process many tasks in the same time. A **worker** program will run in In these servers. When a task is sent to a worker, it will stand up a Docker container and run this task in that container. Because, image of a container is very big, so worker will use LRU to cache some containers.\n\n\n\n## Website Detail Design\n\n### UI Design / Prototype\n\n#### - Login page\n\n![login](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/login.png)\n\n#### - Register page\n\n![register](/Users/lhz/Desktop/SW/register.png)\n\n#### - Func manage page\n\nFrom this page, user can Add, delete, or modify a function.\n\n![register](/Users/lhz/Desktop/SW/func.png)\n\n#### - Task manage page\n\nThis page shows all the user's functions running.\n\n![截屏2023-10-01 11.43.41](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-10-01 11.43.41.png)\n\n#### - Account info page\n\nThis page shows the bill and account balance, and the user can pay the bill or top up the money.\n\n![register](/Users/lhz/Desktop/SW/account.png)\n\n### Database Design\n\n####  - User Info Table:\n\n| Item          | Type        | Explanation |\n| ------------- | ----------- | ----------- |\n| User_ID       | Bigint      |             |\n| User_Email    | varchar(50) |             |\n| User_Name     | Varchar(20) |             |\n| User_Password | varchar(20) |             |\n| User_Balance  | Bigint      |             |\n\n#### - Bill Table\n\n| Item         | Type     | Explanation                                                  |\n| ------------ | -------- | ------------------------------------------------------------ |\n| Bill_ID      | Bigint   |                                                              |\n| User_ID      | Bigint   | Index                                                        |\n| Bill_Date    | Datetime |                                                              |\n| Bill_Balance | Bigint   |                                                              |\n| Bill_Detail  | Text     | A JSON inclueds all unpaid function running records' ID {1,2,3} |\n| Status       | int      | 0 unsay, 1 paid                                              |\n\n#### - Function Table\n\n| Item             | Type         | Explanation                        |\n| ---------------- | ------------ | ---------------------------------- |\n| Func_ID          | Bigint       |                                    |\n| User_ID          | Bigint       |                                    |\n| Func_Args        | JSON         | {\"num1\":int,\"num2\",int}            |\n| Func_Path        | varchar(200) | path of func's code in OSS like S3 |\n| Func_Explanation | varchar(500) |                                    |\n| Func_Output      | Int          | 0=sync / 1=async                   |\n| Func_Resource    | JSON         | {\"CPU\":4,\"MEM\":1024m,\"DISK\":1024m} |\n\n#### - Func Running Record\n\n| tem            | Type     | Explanation                   |\n| -------------- | -------- | ----------------------------- |\n| Running_ID     | Bigint   |                               |\n| Func_ID        | Bigint   |                               |\n| Running_Time   | Bigint   | Example: 100ms                |\n| Status         | Int      | 0: fail, 1 success, 2 pending |\n| Input          | Text     | A input json                  |\n| Running_Date   | Datetime |                               |\n| Payment_Status | Int      | 0 unsay, 1 paid               |\n\n#### - Billing Unit\n\n| Item          | Type   | Explanation       |\n| ------------- | ------ | ----------------- |\n| ID            | Bitint |                   |\n| Resource_Type | Int    | CPU / MEM /  DISK |\n| Price         | float  | Example: 0.01$/ms |\n\n#### - Account Info History\n\n| Item        | Type        | Explanation       |\n| ----------- | ----------- | ----------------- |\n| ID          | Bitint      |                   |\n| Date        | Datetime    | CPU / MEM /  DISK |\n| Type        | Int         |                   |\n| Account_num | varchar(20) |                   |\n| Bill_ID     | Int         |                   |\n| Money       | Bigint      |                   |\n| User_ID     | Bigint      |                   |\n\n#### - ER\n\n![](/Users/lhz/Desktop/SW/ER.jpg)\n\n#### - SQL Code\n\n```sql\ncreate table Account_Info_History\n(\n    ID          bigint auto_increment\n        primary key,\n    Date        varchar(30) null,\n    Type        int         null comment '1:money in, pay for a bill',\n    Account_Num varchar(20) null comment 'for type 1',\n    Bill_ID     bigint      null comment 'for type 2',\n    Money       bigint      null comment 'for type 1, it is a positive num.',\n    User_ID     bigint      null\n);\n\ncreate table Bill\n(\n    Bill_ID      bigint auto_increment\n        primary key,\n    User_ID      bigint   null,\n    Bill_Date    datetime null,\n    Bill_Balance double   null,\n    Bill_Detail  text     null,\n    Status       int      null comment '\"0 unpay, 1paid\"'\n);\n\ncreate index User_ID\n    on Bill (User_ID);\n\ncreate table Billing_Units\n(\n    ID            bigint auto_increment\n        primary key,\n    Resource_Type varchar(10) null,\n    Price         double      null comment 'Example: 0.01$/ms'\n);\n\ncreate table Func_Running_Record\n(\n    Running_ID     bigint auto_increment\n        primary key,\n    Func_ID        bigint   null,\n    Running_Time   int      null comment '100ms',\n    Status         int      null comment '0: fail, 1 success, 2 pending',\n    Input          text     null,\n    Running_Date   datetime null,\n    Payment_Status int      null comment '\"0 unpay, 1 paid\"'\n);\n\ncreate table Functions\n(\n    Func_ID            bigint auto_increment\n        primary key,\n    User_ID            bigint       null,\n    Func_Args          text         null,\n    Func_Path          varchar(300) null,\n    Func_Explanation   varchar(500) null,\n    Func_Output        int          null comment '0=sync / 1=async',\n    Func_Resource_CPU  int          null,\n    Func_Resource_Mem  int          null,\n    Func_Resource_Disk int          null,\n    Func_Name          varchar(50)  null\n);\n\ncreate index User_ID\n    on Functions (User_ID);\n\ncreate table User_Info\n(\n    User_ID       bigint auto_increment\n        primary key,\n    User_Email    varchar(50) null,\n    User_Password varchar(50) null,\n    User_Balance  bigint      null\n);\n\n\n```\n\n\n\n## Core Cluster Detail Design\n\n**In development! **\n\nIn core cluster, there are many servers. All servers will be managed by zookeeper. All nodes can perform the scheduling function. Zookeeper will elect a leader for scheduling.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.10.24.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nThe worker nodes will regularly report resource usage to the master node, and the master node will use the progress of DRF algorithm based on resource usage information\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.11.11.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\nThe following figure shows the module division of the whole scheduling system(For master):\n\n\n\n<img src=\"/Users/lhz/Desktop/SW/f.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n","source":"_posts/Color-FaaS.md","raw":"---\ntitle: Color-FaaS\ndate: 2023-09-25 12:49:46\ntags:\n---\n\n# Color FaaS Design Doc\n\nDesigned By Hanzhong Liu, Xi Shi\n\nVideo: https://www.youtube.com/watch?v=QDuIaaMpTBo\n\n## High Level Design\n\n### Requirements\n\nI plan to design a FaaS platform called Color FaaS. Color FaaS will has the ability to process many kinds of task like AWS Lambda. The platform will include user registration, function creation and management, billing and payment.\n\n**User case 1**: Development\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | A User want to deploy a application in cloud environment     |\n| Path  | 1. User must develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file, and the function file is successfully created <br />3. User test this function from web browser.<br />4. System calls the function and returns the result |\n\n**User case 2**: Pay the bill\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Pay the bill                                                 |\n| Path  | 1. User login into the platftom<br />2. System verifies that user information is correct<br />3. User enter the account info page<br />4. System return the web page to user<br />5. User click \"bill\" button<br />6. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />7. User click \"Pay\" button<br />8. System redirects to the payment page<br />9. User enter all information in the payment form and submit<br />10. System deducts the fee and completes the payment |\n\n**User case 3**: Manage function\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Trace  the running status of a Func                          |\n| Path  | 1. User login into the platform<br />2. System verifies that user information is correct<br />3. User enter Task manage page<br />4. System return the manage page<br />5. User use search to find the target Func<br />6. System search from the database and return it to user<br />7. User look at the running status of the function |\n\n### Architectural design\n\nThe system is divided into three layers: the website, the gateway, and the cluster. The website is primarily responsible for user interaction and needs to connect to the database to store user information. The gateway layer is a simplified implementation that can be replaced with gateways like AWS ELB (Elastic Load Balancer). The cluster is the core of the entire Color FaaS platform. Here, I have designed a decentralized resource scheduler and use Docker for handling user tasks.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/2023-09-2716.58.19.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\nIn Website layer, we use Java Serverlet to develop a Web application.We also use Mysql to store user's information. Website will provide user with functions include: add/delete a Func, pay for the bill, trace Func status.\n\nFor GateWay, all request will be send to gateway, and gateway will write infomation about the task into DB. In the end, gateway will sent task to Core cluster.\n\nCore cluster may contains many servers, so it can process many tasks in the same time. A **worker** program will run in In these servers. When a task is sent to a worker, it will stand up a Docker container and run this task in that container. Because, image of a container is very big, so worker will use LRU to cache some containers.\n\n\n\n## Website Detail Design\n\n### UI Design / Prototype\n\n#### - Login page\n\n![login](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/login.png)\n\n#### - Register page\n\n![register](/Users/lhz/Desktop/SW/register.png)\n\n#### - Func manage page\n\nFrom this page, user can Add, delete, or modify a function.\n\n![register](/Users/lhz/Desktop/SW/func.png)\n\n#### - Task manage page\n\nThis page shows all the user's functions running.\n\n![截屏2023-10-01 11.43.41](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-10-01 11.43.41.png)\n\n#### - Account info page\n\nThis page shows the bill and account balance, and the user can pay the bill or top up the money.\n\n![register](/Users/lhz/Desktop/SW/account.png)\n\n### Database Design\n\n####  - User Info Table:\n\n| Item          | Type        | Explanation |\n| ------------- | ----------- | ----------- |\n| User_ID       | Bigint      |             |\n| User_Email    | varchar(50) |             |\n| User_Name     | Varchar(20) |             |\n| User_Password | varchar(20) |             |\n| User_Balance  | Bigint      |             |\n\n#### - Bill Table\n\n| Item         | Type     | Explanation                                                  |\n| ------------ | -------- | ------------------------------------------------------------ |\n| Bill_ID      | Bigint   |                                                              |\n| User_ID      | Bigint   | Index                                                        |\n| Bill_Date    | Datetime |                                                              |\n| Bill_Balance | Bigint   |                                                              |\n| Bill_Detail  | Text     | A JSON inclueds all unpaid function running records' ID {1,2,3} |\n| Status       | int      | 0 unsay, 1 paid                                              |\n\n#### - Function Table\n\n| Item             | Type         | Explanation                        |\n| ---------------- | ------------ | ---------------------------------- |\n| Func_ID          | Bigint       |                                    |\n| User_ID          | Bigint       |                                    |\n| Func_Args        | JSON         | {\"num1\":int,\"num2\",int}            |\n| Func_Path        | varchar(200) | path of func's code in OSS like S3 |\n| Func_Explanation | varchar(500) |                                    |\n| Func_Output      | Int          | 0=sync / 1=async                   |\n| Func_Resource    | JSON         | {\"CPU\":4,\"MEM\":1024m,\"DISK\":1024m} |\n\n#### - Func Running Record\n\n| tem            | Type     | Explanation                   |\n| -------------- | -------- | ----------------------------- |\n| Running_ID     | Bigint   |                               |\n| Func_ID        | Bigint   |                               |\n| Running_Time   | Bigint   | Example: 100ms                |\n| Status         | Int      | 0: fail, 1 success, 2 pending |\n| Input          | Text     | A input json                  |\n| Running_Date   | Datetime |                               |\n| Payment_Status | Int      | 0 unsay, 1 paid               |\n\n#### - Billing Unit\n\n| Item          | Type   | Explanation       |\n| ------------- | ------ | ----------------- |\n| ID            | Bitint |                   |\n| Resource_Type | Int    | CPU / MEM /  DISK |\n| Price         | float  | Example: 0.01$/ms |\n\n#### - Account Info History\n\n| Item        | Type        | Explanation       |\n| ----------- | ----------- | ----------------- |\n| ID          | Bitint      |                   |\n| Date        | Datetime    | CPU / MEM /  DISK |\n| Type        | Int         |                   |\n| Account_num | varchar(20) |                   |\n| Bill_ID     | Int         |                   |\n| Money       | Bigint      |                   |\n| User_ID     | Bigint      |                   |\n\n#### - ER\n\n![](/Users/lhz/Desktop/SW/ER.jpg)\n\n#### - SQL Code\n\n```sql\ncreate table Account_Info_History\n(\n    ID          bigint auto_increment\n        primary key,\n    Date        varchar(30) null,\n    Type        int         null comment '1:money in, pay for a bill',\n    Account_Num varchar(20) null comment 'for type 1',\n    Bill_ID     bigint      null comment 'for type 2',\n    Money       bigint      null comment 'for type 1, it is a positive num.',\n    User_ID     bigint      null\n);\n\ncreate table Bill\n(\n    Bill_ID      bigint auto_increment\n        primary key,\n    User_ID      bigint   null,\n    Bill_Date    datetime null,\n    Bill_Balance double   null,\n    Bill_Detail  text     null,\n    Status       int      null comment '\"0 unpay, 1paid\"'\n);\n\ncreate index User_ID\n    on Bill (User_ID);\n\ncreate table Billing_Units\n(\n    ID            bigint auto_increment\n        primary key,\n    Resource_Type varchar(10) null,\n    Price         double      null comment 'Example: 0.01$/ms'\n);\n\ncreate table Func_Running_Record\n(\n    Running_ID     bigint auto_increment\n        primary key,\n    Func_ID        bigint   null,\n    Running_Time   int      null comment '100ms',\n    Status         int      null comment '0: fail, 1 success, 2 pending',\n    Input          text     null,\n    Running_Date   datetime null,\n    Payment_Status int      null comment '\"0 unpay, 1 paid\"'\n);\n\ncreate table Functions\n(\n    Func_ID            bigint auto_increment\n        primary key,\n    User_ID            bigint       null,\n    Func_Args          text         null,\n    Func_Path          varchar(300) null,\n    Func_Explanation   varchar(500) null,\n    Func_Output        int          null comment '0=sync / 1=async',\n    Func_Resource_CPU  int          null,\n    Func_Resource_Mem  int          null,\n    Func_Resource_Disk int          null,\n    Func_Name          varchar(50)  null\n);\n\ncreate index User_ID\n    on Functions (User_ID);\n\ncreate table User_Info\n(\n    User_ID       bigint auto_increment\n        primary key,\n    User_Email    varchar(50) null,\n    User_Password varchar(50) null,\n    User_Balance  bigint      null\n);\n\n\n```\n\n\n\n## Core Cluster Detail Design\n\n**In development! **\n\nIn core cluster, there are many servers. All servers will be managed by zookeeper. All nodes can perform the scheduling function. Zookeeper will elect a leader for scheduling.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.10.24.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nThe worker nodes will regularly report resource usage to the master node, and the master node will use the progress of DRF algorithm based on resource usage information\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.11.11.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\nThe following figure shows the module division of the whole scheduling system(For master):\n\n\n\n<img src=\"/Users/lhz/Desktop/SW/f.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n","slug":"Color-FaaS","published":1,"updated":"2023-10-02T02:12:33.696Z","_id":"clmzgww620000i3exgbhz8bm8","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Color-FaaS-Design-Doc\"><a href=\"#Color-FaaS-Design-Doc\" class=\"headerlink\" title=\"Color FaaS Design Doc\"></a>Color FaaS Design Doc</h1><p>Designed By Hanzhong Liu, Xi Shi</p>\n<p>Video: <a href=\"https://www.youtube.com/watch?v=QDuIaaMpTBo\">https://www.youtube.com/watch?v=QDuIaaMpTBo</a></p>\n<h2 id=\"High-Level-Design\"><a href=\"#High-Level-Design\" class=\"headerlink\" title=\"High Level Design\"></a>High Level Design</h2><h3 id=\"Requirements\"><a href=\"#Requirements\" class=\"headerlink\" title=\"Requirements\"></a>Requirements</h3><p>I plan to design a FaaS platform called Color FaaS. Color FaaS will has the ability to process many kinds of task like AWS Lambda. The platform will include user registration, function creation and management, billing and payment.</p>\n<p><strong>User case 1</strong>: Development</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>A User want to deploy a application in cloud environment</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User must develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file, and the function file is successfully created <br />3. User test this function from web browser.<br />4. System calls the function and returns the result</td>\n</tr>\n</tbody></table>\n<p><strong>User case 2</strong>: Pay the bill</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Pay the bill</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User login into the platftom<br />2. System verifies that user information is correct<br />3. User enter the account info page<br />4. System return the web page to user<br />5. User click “bill” button<br />6. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />7. User click “Pay” button<br />8. System redirects to the payment page<br />9. User enter all information in the payment form and submit<br />10. System deducts the fee and completes the payment</td>\n</tr>\n</tbody></table>\n<p><strong>User case 3</strong>: Manage function</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Trace  the running status of a Func</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User login into the platform<br />2. System verifies that user information is correct<br />3. User enter Task manage page<br />4. System return the manage page<br />5. User use search to find the target Func<br />6. System search from the database and return it to user<br />7. User look at the running status of the function</td>\n</tr>\n</tbody></table>\n<h3 id=\"Architectural-design\"><a href=\"#Architectural-design\" class=\"headerlink\" title=\"Architectural design\"></a>Architectural design</h3><p>The system is divided into three layers: the website, the gateway, and the cluster. The website is primarily responsible for user interaction and needs to connect to the database to store user information. The gateway layer is a simplified implementation that can be replaced with gateways like AWS ELB (Elastic Load Balancer). The cluster is the core of the entire Color FaaS platform. Here, I have designed a decentralized resource scheduler and use Docker for handling user tasks.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/2023-09-2716.58.19.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<p>In Website layer, we use Java Serverlet to develop a Web application.We also use Mysql to store user’s information. Website will provide user with functions include: add/delete a Func, pay for the bill, trace Func status.</p>\n<p>For GateWay, all request will be send to gateway, and gateway will write infomation about the task into DB. In the end, gateway will sent task to Core cluster.</p>\n<p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>worker</strong> program will run in In these servers. When a task is sent to a worker, it will stand up a Docker container and run this task in that container. Because, image of a container is very big, so worker will use LRU to cache some containers.</p>\n<h2 id=\"Website-Detail-Design\"><a href=\"#Website-Detail-Design\" class=\"headerlink\" title=\"Website Detail Design\"></a>Website Detail Design</h2><h3 id=\"UI-Design-Prototype\"><a href=\"#UI-Design-Prototype\" class=\"headerlink\" title=\"UI Design / Prototype\"></a>UI Design / Prototype</h3><h4 id=\"Login-page\"><a href=\"#Login-page\" class=\"headerlink\" title=\"- Login page\"></a>- Login page</h4><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/login.png\" alt=\"login\"></p>\n<h4 id=\"Register-page\"><a href=\"#Register-page\" class=\"headerlink\" title=\"- Register page\"></a>- Register page</h4><p><img src=\"/Users/lhz/Desktop/SW/register.png\" alt=\"register\"></p>\n<h4 id=\"Func-manage-page\"><a href=\"#Func-manage-page\" class=\"headerlink\" title=\"- Func manage page\"></a>- Func manage page</h4><p>From this page, user can Add, delete, or modify a function.</p>\n<p><img src=\"/Users/lhz/Desktop/SW/func.png\" alt=\"register\"></p>\n<h4 id=\"Task-manage-page\"><a href=\"#Task-manage-page\" class=\"headerlink\" title=\"- Task manage page\"></a>- Task manage page</h4><p>This page shows all the user’s functions running.</p>\n<p>![截屏2023-10-01 11.43.41](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-10-01 11.43.41.png)</p>\n<h4 id=\"Account-info-page\"><a href=\"#Account-info-page\" class=\"headerlink\" title=\"- Account info page\"></a>- Account info page</h4><p>This page shows the bill and account balance, and the user can pay the bill or top up the money.</p>\n<p><img src=\"/Users/lhz/Desktop/SW/account.png\" alt=\"register\"></p>\n<h3 id=\"Database-Design\"><a href=\"#Database-Design\" class=\"headerlink\" title=\"Database Design\"></a>Database Design</h3><h4 id=\"User-Info-Table\"><a href=\"#User-Info-Table\" class=\"headerlink\" title=\"- User Info Table:\"></a>- User Info Table:</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Email</td>\n<td>varchar(50)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Name</td>\n<td>Varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Password</td>\n<td>varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"Bill-Table\"><a href=\"#Bill-Table\" class=\"headerlink\" title=\"- Bill Table\"></a>- Bill Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Bill_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td>Index</td>\n</tr>\n<tr>\n<td>Bill_Date</td>\n<td>Datetime</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Detail</td>\n<td>Text</td>\n<td>A JSON inclueds all unpaid function running records’ ID {1,2,3}</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>int</td>\n<td>0 unsay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Function-Table\"><a href=\"#Function-Table\" class=\"headerlink\" title=\"- Function Table\"></a>- Function Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Func_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Args</td>\n<td>JSON</td>\n<td>{“num1”:int,”num2”,int}</td>\n</tr>\n<tr>\n<td>Func_Path</td>\n<td>varchar(200)</td>\n<td>path of func’s code in OSS like S3</td>\n</tr>\n<tr>\n<td>Func_Explanation</td>\n<td>varchar(500)</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Output</td>\n<td>Int</td>\n<td>0=sync / 1=async</td>\n</tr>\n<tr>\n<td>Func_Resource</td>\n<td>JSON</td>\n<td>{“CPU”:4,”MEM”:1024m,”DISK”:1024m}</td>\n</tr>\n</tbody></table>\n<h4 id=\"Func-Running-Record\"><a href=\"#Func-Running-Record\" class=\"headerlink\" title=\"- Func Running Record\"></a>- Func Running Record</h4><table>\n<thead>\n<tr>\n<th>tem</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Running_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Running_Time</td>\n<td>Bigint</td>\n<td>Example: 100ms</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>Int</td>\n<td>0: fail, 1 success, 2 pending</td>\n</tr>\n<tr>\n<td>Input</td>\n<td>Text</td>\n<td>A input json</td>\n</tr>\n<tr>\n<td>Running_Date</td>\n<td>Datetime</td>\n<td></td>\n</tr>\n<tr>\n<td>Payment_Status</td>\n<td>Int</td>\n<td>0 unsay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Billing-Unit\"><a href=\"#Billing-Unit\" class=\"headerlink\" title=\"- Billing Unit\"></a>- Billing Unit</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Resource_Type</td>\n<td>Int</td>\n<td>CPU / MEM /  DISK</td>\n</tr>\n<tr>\n<td>Price</td>\n<td>float</td>\n<td>Example: 0.01$/ms</td>\n</tr>\n</tbody></table>\n<h4 id=\"Account-Info-History\"><a href=\"#Account-Info-History\" class=\"headerlink\" title=\"- Account Info History\"></a>- Account Info History</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Date</td>\n<td>Datetime</td>\n<td>CPU / MEM /  DISK</td>\n</tr>\n<tr>\n<td>Type</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Account_num</td>\n<td>varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_ID</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Money</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"ER\"><a href=\"#ER\" class=\"headerlink\" title=\"- ER\"></a>- ER</h4><p><img src=\"/Users/lhz/Desktop/SW/ER.jpg\"></p>\n<h4 id=\"SQL-Code\"><a href=\"#SQL-Code\" class=\"headerlink\" title=\"- SQL Code\"></a>- SQL Code</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Account_Info_History</span><br><span class=\"line\">(</span><br><span class=\"line\">    ID          <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    <span class=\"type\">Date</span>        <span class=\"type\">varchar</span>(<span class=\"number\">30</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Type        <span class=\"type\">int</span>         <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;1:money in, pay for a bill&#x27;</span>,</span><br><span class=\"line\">    Account_Num <span class=\"type\">varchar</span>(<span class=\"number\">20</span>) <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 1&#x27;</span>,</span><br><span class=\"line\">    Bill_ID     <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 2&#x27;</span>,</span><br><span class=\"line\">    Money       <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 1, it is a positive num.&#x27;</span>,</span><br><span class=\"line\">    User_ID     <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Bill</span><br><span class=\"line\">(</span><br><span class=\"line\">    Bill_ID      <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_ID      <span class=\"type\">bigint</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Date    datetime <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Balance <span class=\"keyword\">double</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Detail  text     <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Status       <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;&quot;0 unpay, 1paid&quot;&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> index User_ID</span><br><span class=\"line\">    <span class=\"keyword\">on</span> Bill (User_ID);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Billing_Units</span><br><span class=\"line\">(</span><br><span class=\"line\">    ID            <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    Resource_Type <span class=\"type\">varchar</span>(<span class=\"number\">10</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Price         <span class=\"keyword\">double</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;Example: 0.01$/ms&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Func_Running_Record</span><br><span class=\"line\">(</span><br><span class=\"line\">    Running_ID     <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    Func_ID        <span class=\"type\">bigint</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Running_Time   <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;100ms&#x27;</span>,</span><br><span class=\"line\">    Status         <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;0: fail, 1 success, 2 pending&#x27;</span>,</span><br><span class=\"line\">    Input          text     <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Running_Date   datetime <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Payment_Status <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;&quot;0 unpay, 1 paid&quot;&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Functions</span><br><span class=\"line\">(</span><br><span class=\"line\">    Func_ID            <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_ID            <span class=\"type\">bigint</span>       <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Args          text         <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Path          <span class=\"type\">varchar</span>(<span class=\"number\">300</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Explanation   <span class=\"type\">varchar</span>(<span class=\"number\">500</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Output        <span class=\"type\">int</span>          <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;0=sync / 1=async&#x27;</span>,</span><br><span class=\"line\">    Func_Resource_CPU  <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Resource_Mem  <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Resource_Disk <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Name          <span class=\"type\">varchar</span>(<span class=\"number\">50</span>)  <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> index User_ID</span><br><span class=\"line\">    <span class=\"keyword\">on</span> Functions (User_ID);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> User_Info</span><br><span class=\"line\">(</span><br><span class=\"line\">    User_ID       <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_Email    <span class=\"type\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    User_Password <span class=\"type\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    User_Balance  <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Core-Cluster-Detail-Design\"><a href=\"#Core-Cluster-Detail-Design\" class=\"headerlink\" title=\"Core Cluster Detail Design\"></a>Core Cluster Detail Design</h2><p>**In development! **</p>\n<p>In core cluster, there are many servers. All servers will be managed by zookeeper. All nodes can perform the scheduling function. Zookeeper will elect a leader for scheduling.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.10.24.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>The worker nodes will regularly report resource usage to the master node, and the master node will use the progress of DRF algorithm based on resource usage information</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.11.11.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<p>The following figure shows the module division of the whole scheduling system(For master):</p>\n<img src=\"/Users/lhz/Desktop/SW/f.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Color-FaaS-Design-Doc\"><a href=\"#Color-FaaS-Design-Doc\" class=\"headerlink\" title=\"Color FaaS Design Doc\"></a>Color FaaS Design Doc</h1><p>Designed By Hanzhong Liu, Xi Shi</p>\n<p>Video: <a href=\"https://www.youtube.com/watch?v=QDuIaaMpTBo\">https://www.youtube.com/watch?v=QDuIaaMpTBo</a></p>\n<h2 id=\"High-Level-Design\"><a href=\"#High-Level-Design\" class=\"headerlink\" title=\"High Level Design\"></a>High Level Design</h2><h3 id=\"Requirements\"><a href=\"#Requirements\" class=\"headerlink\" title=\"Requirements\"></a>Requirements</h3><p>I plan to design a FaaS platform called Color FaaS. Color FaaS will has the ability to process many kinds of task like AWS Lambda. The platform will include user registration, function creation and management, billing and payment.</p>\n<p><strong>User case 1</strong>: Development</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>A User want to deploy a application in cloud environment</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User must develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file, and the function file is successfully created <br />3. User test this function from web browser.<br />4. System calls the function and returns the result</td>\n</tr>\n</tbody></table>\n<p><strong>User case 2</strong>: Pay the bill</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Pay the bill</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User login into the platftom<br />2. System verifies that user information is correct<br />3. User enter the account info page<br />4. System return the web page to user<br />5. User click “bill” button<br />6. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />7. User click “Pay” button<br />8. System redirects to the payment page<br />9. User enter all information in the payment form and submit<br />10. System deducts the fee and completes the payment</td>\n</tr>\n</tbody></table>\n<p><strong>User case 3</strong>: Manage function</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Trace  the running status of a Func</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User login into the platform<br />2. System verifies that user information is correct<br />3. User enter Task manage page<br />4. System return the manage page<br />5. User use search to find the target Func<br />6. System search from the database and return it to user<br />7. User look at the running status of the function</td>\n</tr>\n</tbody></table>\n<h3 id=\"Architectural-design\"><a href=\"#Architectural-design\" class=\"headerlink\" title=\"Architectural design\"></a>Architectural design</h3><p>The system is divided into three layers: the website, the gateway, and the cluster. The website is primarily responsible for user interaction and needs to connect to the database to store user information. The gateway layer is a simplified implementation that can be replaced with gateways like AWS ELB (Elastic Load Balancer). The cluster is the core of the entire Color FaaS platform. Here, I have designed a decentralized resource scheduler and use Docker for handling user tasks.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/2023-09-2716.58.19.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<p>In Website layer, we use Java Serverlet to develop a Web application.We also use Mysql to store user’s information. Website will provide user with functions include: add/delete a Func, pay for the bill, trace Func status.</p>\n<p>For GateWay, all request will be send to gateway, and gateway will write infomation about the task into DB. In the end, gateway will sent task to Core cluster.</p>\n<p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>worker</strong> program will run in In these servers. When a task is sent to a worker, it will stand up a Docker container and run this task in that container. Because, image of a container is very big, so worker will use LRU to cache some containers.</p>\n<h2 id=\"Website-Detail-Design\"><a href=\"#Website-Detail-Design\" class=\"headerlink\" title=\"Website Detail Design\"></a>Website Detail Design</h2><h3 id=\"UI-Design-Prototype\"><a href=\"#UI-Design-Prototype\" class=\"headerlink\" title=\"UI Design / Prototype\"></a>UI Design / Prototype</h3><h4 id=\"Login-page\"><a href=\"#Login-page\" class=\"headerlink\" title=\"- Login page\"></a>- Login page</h4><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/login.png\" alt=\"login\"></p>\n<h4 id=\"Register-page\"><a href=\"#Register-page\" class=\"headerlink\" title=\"- Register page\"></a>- Register page</h4><p><img src=\"/Users/lhz/Desktop/SW/register.png\" alt=\"register\"></p>\n<h4 id=\"Func-manage-page\"><a href=\"#Func-manage-page\" class=\"headerlink\" title=\"- Func manage page\"></a>- Func manage page</h4><p>From this page, user can Add, delete, or modify a function.</p>\n<p><img src=\"/Users/lhz/Desktop/SW/func.png\" alt=\"register\"></p>\n<h4 id=\"Task-manage-page\"><a href=\"#Task-manage-page\" class=\"headerlink\" title=\"- Task manage page\"></a>- Task manage page</h4><p>This page shows all the user’s functions running.</p>\n<p>![截屏2023-10-01 11.43.41](/Users/lhz/Library/Application Support/typora-user-images/截屏2023-10-01 11.43.41.png)</p>\n<h4 id=\"Account-info-page\"><a href=\"#Account-info-page\" class=\"headerlink\" title=\"- Account info page\"></a>- Account info page</h4><p>This page shows the bill and account balance, and the user can pay the bill or top up the money.</p>\n<p><img src=\"/Users/lhz/Desktop/SW/account.png\" alt=\"register\"></p>\n<h3 id=\"Database-Design\"><a href=\"#Database-Design\" class=\"headerlink\" title=\"Database Design\"></a>Database Design</h3><h4 id=\"User-Info-Table\"><a href=\"#User-Info-Table\" class=\"headerlink\" title=\"- User Info Table:\"></a>- User Info Table:</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Email</td>\n<td>varchar(50)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Name</td>\n<td>Varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Password</td>\n<td>varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"Bill-Table\"><a href=\"#Bill-Table\" class=\"headerlink\" title=\"- Bill Table\"></a>- Bill Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Bill_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td>Index</td>\n</tr>\n<tr>\n<td>Bill_Date</td>\n<td>Datetime</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Detail</td>\n<td>Text</td>\n<td>A JSON inclueds all unpaid function running records’ ID {1,2,3}</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>int</td>\n<td>0 unsay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Function-Table\"><a href=\"#Function-Table\" class=\"headerlink\" title=\"- Function Table\"></a>- Function Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Func_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Args</td>\n<td>JSON</td>\n<td>{“num1”:int,”num2”,int}</td>\n</tr>\n<tr>\n<td>Func_Path</td>\n<td>varchar(200)</td>\n<td>path of func’s code in OSS like S3</td>\n</tr>\n<tr>\n<td>Func_Explanation</td>\n<td>varchar(500)</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Output</td>\n<td>Int</td>\n<td>0=sync / 1=async</td>\n</tr>\n<tr>\n<td>Func_Resource</td>\n<td>JSON</td>\n<td>{“CPU”:4,”MEM”:1024m,”DISK”:1024m}</td>\n</tr>\n</tbody></table>\n<h4 id=\"Func-Running-Record\"><a href=\"#Func-Running-Record\" class=\"headerlink\" title=\"- Func Running Record\"></a>- Func Running Record</h4><table>\n<thead>\n<tr>\n<th>tem</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Running_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Running_Time</td>\n<td>Bigint</td>\n<td>Example: 100ms</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>Int</td>\n<td>0: fail, 1 success, 2 pending</td>\n</tr>\n<tr>\n<td>Input</td>\n<td>Text</td>\n<td>A input json</td>\n</tr>\n<tr>\n<td>Running_Date</td>\n<td>Datetime</td>\n<td></td>\n</tr>\n<tr>\n<td>Payment_Status</td>\n<td>Int</td>\n<td>0 unsay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Billing-Unit\"><a href=\"#Billing-Unit\" class=\"headerlink\" title=\"- Billing Unit\"></a>- Billing Unit</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Resource_Type</td>\n<td>Int</td>\n<td>CPU / MEM /  DISK</td>\n</tr>\n<tr>\n<td>Price</td>\n<td>float</td>\n<td>Example: 0.01$/ms</td>\n</tr>\n</tbody></table>\n<h4 id=\"Account-Info-History\"><a href=\"#Account-Info-History\" class=\"headerlink\" title=\"- Account Info History\"></a>- Account Info History</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Date</td>\n<td>Datetime</td>\n<td>CPU / MEM /  DISK</td>\n</tr>\n<tr>\n<td>Type</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Account_num</td>\n<td>varchar(20)</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_ID</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Money</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"ER\"><a href=\"#ER\" class=\"headerlink\" title=\"- ER\"></a>- ER</h4><p><img src=\"/Users/lhz/Desktop/SW/ER.jpg\"></p>\n<h4 id=\"SQL-Code\"><a href=\"#SQL-Code\" class=\"headerlink\" title=\"- SQL Code\"></a>- SQL Code</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Account_Info_History</span><br><span class=\"line\">(</span><br><span class=\"line\">    ID          <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    <span class=\"type\">Date</span>        <span class=\"type\">varchar</span>(<span class=\"number\">30</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Type        <span class=\"type\">int</span>         <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;1:money in, pay for a bill&#x27;</span>,</span><br><span class=\"line\">    Account_Num <span class=\"type\">varchar</span>(<span class=\"number\">20</span>) <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 1&#x27;</span>,</span><br><span class=\"line\">    Bill_ID     <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 2&#x27;</span>,</span><br><span class=\"line\">    Money       <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;for type 1, it is a positive num.&#x27;</span>,</span><br><span class=\"line\">    User_ID     <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Bill</span><br><span class=\"line\">(</span><br><span class=\"line\">    Bill_ID      <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_ID      <span class=\"type\">bigint</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Date    datetime <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Balance <span class=\"keyword\">double</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Bill_Detail  text     <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Status       <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;&quot;0 unpay, 1paid&quot;&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> index User_ID</span><br><span class=\"line\">    <span class=\"keyword\">on</span> Bill (User_ID);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Billing_Units</span><br><span class=\"line\">(</span><br><span class=\"line\">    ID            <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    Resource_Type <span class=\"type\">varchar</span>(<span class=\"number\">10</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Price         <span class=\"keyword\">double</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;Example: 0.01$/ms&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Func_Running_Record</span><br><span class=\"line\">(</span><br><span class=\"line\">    Running_ID     <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    Func_ID        <span class=\"type\">bigint</span>   <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Running_Time   <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;100ms&#x27;</span>,</span><br><span class=\"line\">    Status         <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;0: fail, 1 success, 2 pending&#x27;</span>,</span><br><span class=\"line\">    Input          text     <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Running_Date   datetime <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Payment_Status <span class=\"type\">int</span>      <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;&quot;0 unpay, 1 paid&quot;&#x27;</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> Functions</span><br><span class=\"line\">(</span><br><span class=\"line\">    Func_ID            <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_ID            <span class=\"type\">bigint</span>       <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Args          text         <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Path          <span class=\"type\">varchar</span>(<span class=\"number\">300</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Explanation   <span class=\"type\">varchar</span>(<span class=\"number\">500</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Output        <span class=\"type\">int</span>          <span class=\"keyword\">null</span> comment <span class=\"string\">&#x27;0=sync / 1=async&#x27;</span>,</span><br><span class=\"line\">    Func_Resource_CPU  <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Resource_Mem  <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Resource_Disk <span class=\"type\">int</span>          <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    Func_Name          <span class=\"type\">varchar</span>(<span class=\"number\">50</span>)  <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> index User_ID</span><br><span class=\"line\">    <span class=\"keyword\">on</span> Functions (User_ID);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> User_Info</span><br><span class=\"line\">(</span><br><span class=\"line\">    User_ID       <span class=\"type\">bigint</span> auto_increment</span><br><span class=\"line\">        <span class=\"keyword\">primary</span> key,</span><br><span class=\"line\">    User_Email    <span class=\"type\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    User_Password <span class=\"type\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">null</span>,</span><br><span class=\"line\">    User_Balance  <span class=\"type\">bigint</span>      <span class=\"keyword\">null</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"Core-Cluster-Detail-Design\"><a href=\"#Core-Cluster-Detail-Design\" class=\"headerlink\" title=\"Core Cluster Detail Design\"></a>Core Cluster Detail Design</h2><p>**In development! **</p>\n<p>In core cluster, there are many servers. All servers will be managed by zookeeper. All nodes can perform the scheduling function. Zookeeper will elect a leader for scheduling.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.10.24.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>The worker nodes will regularly report resource usage to the master node, and the master node will use the progress of DRF algorithm based on resource usage information</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-30%2023.11.11.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<p>The following figure shows the module division of the whole scheduling system(For master):</p>\n<img src=\"/Users/lhz/Desktop/SW/f.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n"},{"title":"Distributed-sys-mp1-design","date":"2023-09-25T01:46:26.000Z","_content":"\n# MP1 Design Doc\n\n## Introduction\n\nIn modern social networking applications, user login, mutual following, viewing lists, and timelines are among the common functionalities. In this project, I have created a simple social networking application called SNS from skeleton, showcasing the fundamental principles and operations of these features.\n\n## Detailed Design\n\n### Login\n\nFor a successful login, the client needs to connect to the server and obtain a stub. The client sends its username to the server, and if the server responds with \"OK,\" the login is successful.\n\n```\n➜  mp1 ./tsc -u test\n\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> \n```\n\n\n\nOn the server-side, it starts by traversing the client database (client_db) to determine if the client is already logged in. If not, it creates a new Client object and initializes it. Subsequently, it creates a timeline file locally named \"username.txt.\" If it detects that the user is already logged in, it returns a \"deny\" status.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.26.07.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\nThe timeline file has the following format:\n\n```\n[username2] [msg2] [timestamp2]\n[username1] [msg1] [timestamp1]\n...\n\nWhere the most recent information is stored at the top.\n```\n\n### Follow\n\nOn the client-side, a request is constructed with the username set as the user's name and the arg set as username2. The request is then sent to the server. If an \"OK\" response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> \n```\n\n\n\nOn the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns \"NO_TARGET\" in msg. If username is equal to username2, it returns \"Can't follow self\" since users cannot follow themselves. If the user is already following username2, it returns \"RE-FOLLOW.\" Subsequently, the server establishes a direct relationship between username and username2 and returns \"OK.\"\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.20.06.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n### Unfollow\n\nOn the client-side, a request is constructed with the username set as the user's name and the arg set as username2. The request is then sent to the server. If an \"OK\" response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> UNFOLLOW default\nCommand completed successfully\nCmd> \n```\n\n\n\nOn the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns \"NO_TARGET.\" Otherwise, it removes the relationship between the two users and returns \"OK.\"\n\n### List\n\nOn the server-side, it constructs a ListReply. It iterates through the client database, adding all usernames to the ListReply. Then, it locates username and iterates through its followers, adding them all to the ListReply too.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> LIST\nCommand completed successfully\nAll users: lhz, default, \nFollowers: \nCmd> LIST\nCommand completed successfully\nAll users: lhz, default, \nFollowers: lhz, \nCmd> \n```\n\n\n\n### Timeline\n\nOn the client-side, it begins by establishing a stream connection. It constructs a message request with the message set as \"join_timeline.\" Afterward, two threads are started: read and write. The read thread continuously reads messages from the stream, while the write thread constantly reads user input and sends it to the server by stream.\n\n```\nUser:\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> TIMELINE\nCommand completed successfully\nNow you are in the timeline\np1\np2\np3\n```\n\n```\nFollower:\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> TIMELINE\nCommand completed successfully\nNow you are in the timeline\ndefault (Sun Sep 24 22:31:15 2023) >> p1\ndefault (Sun Sep 24 22:31:16 2023) >> p2\ndefault (Sun Sep 24 22:31:17 2023) >> p3\n```\n\nOn the server-side, upon receiving the \"join_timeline\" request, it saves the stream in the client database. It then reads up to 20 lines from the current user's timeline file, parses them into messages, and sends them to the client. When the server receives a message, it iterates through all followers, individually checking if their stream is not null. If it's not null, the server sends the message directly to the client through the stream. The message is then saved at the top of the follower's timeline file.\n\n<img src=\"/Users/lhz/Desktop/截屏2023-09-25 23.33.01.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n\n\n\n\n","source":"_posts/Distributed-sys-mp1-design.md","raw":"---\ntitle: Distributed-sys-mp1-design\ndate: 2023-09-24 20:46:26\ntags:\n---\n\n# MP1 Design Doc\n\n## Introduction\n\nIn modern social networking applications, user login, mutual following, viewing lists, and timelines are among the common functionalities. In this project, I have created a simple social networking application called SNS from skeleton, showcasing the fundamental principles and operations of these features.\n\n## Detailed Design\n\n### Login\n\nFor a successful login, the client needs to connect to the server and obtain a stub. The client sends its username to the server, and if the server responds with \"OK,\" the login is successful.\n\n```\n➜  mp1 ./tsc -u test\n\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> \n```\n\n\n\nOn the server-side, it starts by traversing the client database (client_db) to determine if the client is already logged in. If not, it creates a new Client object and initializes it. Subsequently, it creates a timeline file locally named \"username.txt.\" If it detects that the user is already logged in, it returns a \"deny\" status.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.26.07.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\nThe timeline file has the following format:\n\n```\n[username2] [msg2] [timestamp2]\n[username1] [msg1] [timestamp1]\n...\n\nWhere the most recent information is stored at the top.\n```\n\n### Follow\n\nOn the client-side, a request is constructed with the username set as the user's name and the arg set as username2. The request is then sent to the server. If an \"OK\" response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> \n```\n\n\n\nOn the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns \"NO_TARGET\" in msg. If username is equal to username2, it returns \"Can't follow self\" since users cannot follow themselves. If the user is already following username2, it returns \"RE-FOLLOW.\" Subsequently, the server establishes a direct relationship between username and username2 and returns \"OK.\"\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.20.06.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n### Unfollow\n\nOn the client-side, a request is constructed with the username set as the user's name and the arg set as username2. The request is then sent to the server. If an \"OK\" response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> UNFOLLOW default\nCommand completed successfully\nCmd> \n```\n\n\n\nOn the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns \"NO_TARGET.\" Otherwise, it removes the relationship between the two users and returns \"OK.\"\n\n### List\n\nOn the server-side, it constructs a ListReply. It iterates through the client database, adding all usernames to the ListReply. Then, it locates username and iterates through its followers, adding them all to the ListReply too.\n\n```\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> LIST\nCommand completed successfully\nAll users: lhz, default, \nFollowers: \nCmd> LIST\nCommand completed successfully\nAll users: lhz, default, \nFollowers: lhz, \nCmd> \n```\n\n\n\n### Timeline\n\nOn the client-side, it begins by establishing a stream connection. It constructs a message request with the message set as \"join_timeline.\" Afterward, two threads are started: read and write. The read thread continuously reads messages from the stream, while the write thread constantly reads user input and sends it to the server by stream.\n\n```\nUser:\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> TIMELINE\nCommand completed successfully\nNow you are in the timeline\np1\np2\np3\n```\n\n```\nFollower:\n========= TINY SNS CLIENT =========\n Command Lists and Format:\n FOLLOW <username>\n UNFOLLOW <username>\n LIST\n TIMELINE\n=====================================\nCmd> FOLLOW default\nCommand completed successfully\nCmd> TIMELINE\nCommand completed successfully\nNow you are in the timeline\ndefault (Sun Sep 24 22:31:15 2023) >> p1\ndefault (Sun Sep 24 22:31:16 2023) >> p2\ndefault (Sun Sep 24 22:31:17 2023) >> p3\n```\n\nOn the server-side, upon receiving the \"join_timeline\" request, it saves the stream in the client database. It then reads up to 20 lines from the current user's timeline file, parses them into messages, and sends them to the client. When the server receives a message, it iterates through all followers, individually checking if their stream is not null. If it's not null, the server sends the message directly to the client through the stream. The message is then saved at the top of the follower's timeline file.\n\n<img src=\"/Users/lhz/Desktop/截屏2023-09-25 23.33.01.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n\n\n\n\n","slug":"Distributed-sys-mp1-design","published":1,"updated":"2023-09-26T04:35:02.502Z","_id":"clmzgww640001i3exehf9h86c","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"MP1-Design-Doc\"><a href=\"#MP1-Design-Doc\" class=\"headerlink\" title=\"MP1 Design Doc\"></a>MP1 Design Doc</h1><h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>In modern social networking applications, user login, mutual following, viewing lists, and timelines are among the common functionalities. In this project, I have created a simple social networking application called SNS from skeleton, showcasing the fundamental principles and operations of these features.</p>\n<h2 id=\"Detailed-Design\"><a href=\"#Detailed-Design\" class=\"headerlink\" title=\"Detailed Design\"></a>Detailed Design</h2><h3 id=\"Login\"><a href=\"#Login\" class=\"headerlink\" title=\"Login\"></a>Login</h3><p>For a successful login, the client needs to connect to the server and obtain a stub. The client sends its username to the server, and if the server responds with “OK,” the login is successful.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  mp1 ./tsc -u test</span><br><span class=\"line\"></span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it starts by traversing the client database (client_db) to determine if the client is already logged in. If not, it creates a new Client object and initializes it. Subsequently, it creates a timeline file locally named “username.txt.” If it detects that the user is already logged in, it returns a “deny” status.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.26.07.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<p>The timeline file has the following format:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[username2] [msg2] [timestamp2]</span><br><span class=\"line\">[username1] [msg1] [timestamp1]</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">Where the most recent information is stored at the top.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Follow\"><a href=\"#Follow\" class=\"headerlink\" title=\"Follow\"></a>Follow</h3><p>On the client-side, a request is constructed with the username set as the user’s name and the arg set as username2. The request is then sent to the server. If an “OK” response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns “NO_TARGET” in msg. If username is equal to username2, it returns “Can’t follow self” since users cannot follow themselves. If the user is already following username2, it returns “RE-FOLLOW.” Subsequently, the server establishes a direct relationship between username and username2 and returns “OK.”</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.20.06.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n<h3 id=\"Unfollow\"><a href=\"#Unfollow\" class=\"headerlink\" title=\"Unfollow\"></a>Unfollow</h3><p>On the client-side, a request is constructed with the username set as the user’s name and the arg set as username2. The request is then sent to the server. If an “OK” response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; UNFOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns “NO_TARGET.” Otherwise, it removes the relationship between the two users and returns “OK.”</p>\n<h3 id=\"List\"><a href=\"#List\" class=\"headerlink\" title=\"List\"></a>List</h3><p>On the server-side, it constructs a ListReply. It iterates through the client database, adding all usernames to the ListReply. Then, it locates username and iterates through its followers, adding them all to the ListReply too.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; LIST</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">All users: lhz, default, </span><br><span class=\"line\">Followers: </span><br><span class=\"line\">Cmd&gt; LIST</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">All users: lhz, default, </span><br><span class=\"line\">Followers: lhz, </span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"Timeline\"><a href=\"#Timeline\" class=\"headerlink\" title=\"Timeline\"></a>Timeline</h3><p>On the client-side, it begins by establishing a stream connection. It constructs a message request with the message set as “join_timeline.” Afterward, two threads are started: read and write. The read thread continuously reads messages from the stream, while the write thread constantly reads user input and sends it to the server by stream.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User:</span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; TIMELINE</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Now you are in the timeline</span><br><span class=\"line\">p1</span><br><span class=\"line\">p2</span><br><span class=\"line\">p3</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Follower:</span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; TIMELINE</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Now you are in the timeline</span><br><span class=\"line\">default (Sun Sep 24 22:31:15 2023) &gt;&gt; p1</span><br><span class=\"line\">default (Sun Sep 24 22:31:16 2023) &gt;&gt; p2</span><br><span class=\"line\">default (Sun Sep 24 22:31:17 2023) &gt;&gt; p3</span><br></pre></td></tr></table></figure>\n\n<p>On the server-side, upon receiving the “join_timeline” request, it saves the stream in the client database. It then reads up to 20 lines from the current user’s timeline file, parses them into messages, and sends them to the client. When the server receives a message, it iterates through all followers, individually checking if their stream is not null. If it’s not null, the server sends the message directly to the client through the stream. The message is then saved at the top of the follower’s timeline file.</p>\n<img src=\"/Users/lhz/Desktop/截屏2023-09-25 23.33.01.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"MP1-Design-Doc\"><a href=\"#MP1-Design-Doc\" class=\"headerlink\" title=\"MP1 Design Doc\"></a>MP1 Design Doc</h1><h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>In modern social networking applications, user login, mutual following, viewing lists, and timelines are among the common functionalities. In this project, I have created a simple social networking application called SNS from skeleton, showcasing the fundamental principles and operations of these features.</p>\n<h2 id=\"Detailed-Design\"><a href=\"#Detailed-Design\" class=\"headerlink\" title=\"Detailed Design\"></a>Detailed Design</h2><h3 id=\"Login\"><a href=\"#Login\" class=\"headerlink\" title=\"Login\"></a>Login</h3><p>For a successful login, the client needs to connect to the server and obtain a stub. The client sends its username to the server, and if the server responds with “OK,” the login is successful.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  mp1 ./tsc -u test</span><br><span class=\"line\"></span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it starts by traversing the client database (client_db) to determine if the client is already logged in. If not, it creates a new Client object and initializes it. Subsequently, it creates a timeline file locally named “username.txt.” If it detects that the user is already logged in, it returns a “deny” status.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.26.07.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<p>The timeline file has the following format:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[username2] [msg2] [timestamp2]</span><br><span class=\"line\">[username1] [msg1] [timestamp1]</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">Where the most recent information is stored at the top.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Follow\"><a href=\"#Follow\" class=\"headerlink\" title=\"Follow\"></a>Follow</h3><p>On the client-side, a request is constructed with the username set as the user’s name and the arg set as username2. The request is then sent to the server. If an “OK” response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns “NO_TARGET” in msg. If username is equal to username2, it returns “Can’t follow self” since users cannot follow themselves. If the user is already following username2, it returns “RE-FOLLOW.” Subsequently, the server establishes a direct relationship between username and username2 and returns “OK.”</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/%E6%88%AA%E5%B1%8F2023-09-25%2023.20.06.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n<h3 id=\"Unfollow\"><a href=\"#Unfollow\" class=\"headerlink\" title=\"Unfollow\"></a>Unfollow</h3><p>On the client-side, a request is constructed with the username set as the user’s name and the arg set as username2. The request is then sent to the server. If an “OK” response is received, it returns IStatus::SUCCESS; otherwise, it returns an error code.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; UNFOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<p>On the server-side, it begins by searching for username and username2 in the client database (client_db). If username2 cannot be found, it returns “NO_TARGET.” Otherwise, it removes the relationship between the two users and returns “OK.”</p>\n<h3 id=\"List\"><a href=\"#List\" class=\"headerlink\" title=\"List\"></a>List</h3><p>On the server-side, it constructs a ListReply. It iterates through the client database, adding all usernames to the ListReply. Then, it locates username and iterates through its followers, adding them all to the ListReply too.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; LIST</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">All users: lhz, default, </span><br><span class=\"line\">Followers: </span><br><span class=\"line\">Cmd&gt; LIST</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">All users: lhz, default, </span><br><span class=\"line\">Followers: lhz, </span><br><span class=\"line\">Cmd&gt; </span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"Timeline\"><a href=\"#Timeline\" class=\"headerlink\" title=\"Timeline\"></a>Timeline</h3><p>On the client-side, it begins by establishing a stream connection. It constructs a message request with the message set as “join_timeline.” Afterward, two threads are started: read and write. The read thread continuously reads messages from the stream, while the write thread constantly reads user input and sends it to the server by stream.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User:</span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; TIMELINE</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Now you are in the timeline</span><br><span class=\"line\">p1</span><br><span class=\"line\">p2</span><br><span class=\"line\">p3</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Follower:</span><br><span class=\"line\">========= TINY SNS CLIENT =========</span><br><span class=\"line\"> Command Lists and Format:</span><br><span class=\"line\"> FOLLOW &lt;username&gt;</span><br><span class=\"line\"> UNFOLLOW &lt;username&gt;</span><br><span class=\"line\"> LIST</span><br><span class=\"line\"> TIMELINE</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">Cmd&gt; FOLLOW default</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Cmd&gt; TIMELINE</span><br><span class=\"line\">Command completed successfully</span><br><span class=\"line\">Now you are in the timeline</span><br><span class=\"line\">default (Sun Sep 24 22:31:15 2023) &gt;&gt; p1</span><br><span class=\"line\">default (Sun Sep 24 22:31:16 2023) &gt;&gt; p2</span><br><span class=\"line\">default (Sun Sep 24 22:31:17 2023) &gt;&gt; p3</span><br></pre></td></tr></table></figure>\n\n<p>On the server-side, upon receiving the “join_timeline” request, it saves the stream in the client database. It then reads up to 20 lines from the current user’s timeline file, parses them into messages, and sends them to the client. When the server receives a message, it iterates through all followers, individually checking if their stream is not null. If it’s not null, the server sends the message directly to the client through the stream. The message is then saved at the top of the follower’s timeline file.</p>\n<img src=\"/Users/lhz/Desktop/截屏2023-09-25 23.33.01.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n\n\n\n\n"},{"title":"Spark Check Point","date":"2023-09-25T22:06:26.000Z","_content":"\n\n\n# Spark check point\n\nIn SparkContext, when a job is completed, rdd.doCheckpoint() will be called. \n\n```scala\n  /**\n   * Run a function on a given set of partitions in an RDD and pass the results to the given\n   * handler function. This is the main entry point for all actions in Spark.\n   *\n   * @param rdd target RDD to run tasks on\n   * @param func a function to run on each partition of the RDD\n   * @param partitions set of partitions to run on; some jobs may not want to compute on all\n   * partitions of the target RDD, e.g. for operations like `first()`\n   * @param resultHandler callback to pass each result to\n   */  \n\tdef runJob[T, U: ClassTag](\n      rdd: RDD[T],\n      func: (TaskContext, Iterator[T]) => U,\n      partitions: Seq[Int],\n      resultHandler: (Int, U) => Unit): Unit = {\n    ...\n    \trun job\n    ...\n    // job completed\n    rdd.doCheckpoint()\n  }\n```\n\nCheck point code in RDD.\n\n```scala\n  /**\n   * Performs the checkpointing of this RDD by saving this. It is called after a job using this RDD\n   * has completed (therefore the RDD has been materialized and potentially stored in memory).\n   * doCheckpoint() is called recursively on the parent RDDs.\n   */  \n\tprivate[spark] def doCheckpoint(): Unit = {\n    RDDOperationScope.withScope(sc, \"checkpoint\", allowNesting = false, ignoreParent = true) {\n      if (!doCheckpointCalled) {\n        doCheckpointCalled = true\n        if (checkpointData.isDefined) {\n          if (checkpointAllMarkedAncestors) {\n            // TODO We can collect all the RDDs that needs to be checkpointed, and then checkpoint\n            // them in parallel.\n            // Checkpoint parents first because our lineage will be truncated after we\n            // checkpoint ourselves\n            dependencies.foreach(_.rdd.doCheckpoint())\n          }\n          checkpointData.get.checkpoint()\n        } else {\n          dependencies.foreach(_.rdd.doCheckpoint())\n        }\n      }\n    }\n  }\n```\n\n","source":"_posts/Spark-Check-Point.md","raw":"---\ntitle: Spark Check Point\ndate: 2023-09-25 17:06:26\ntags:\n---\n\n\n\n# Spark check point\n\nIn SparkContext, when a job is completed, rdd.doCheckpoint() will be called. \n\n```scala\n  /**\n   * Run a function on a given set of partitions in an RDD and pass the results to the given\n   * handler function. This is the main entry point for all actions in Spark.\n   *\n   * @param rdd target RDD to run tasks on\n   * @param func a function to run on each partition of the RDD\n   * @param partitions set of partitions to run on; some jobs may not want to compute on all\n   * partitions of the target RDD, e.g. for operations like `first()`\n   * @param resultHandler callback to pass each result to\n   */  \n\tdef runJob[T, U: ClassTag](\n      rdd: RDD[T],\n      func: (TaskContext, Iterator[T]) => U,\n      partitions: Seq[Int],\n      resultHandler: (Int, U) => Unit): Unit = {\n    ...\n    \trun job\n    ...\n    // job completed\n    rdd.doCheckpoint()\n  }\n```\n\nCheck point code in RDD.\n\n```scala\n  /**\n   * Performs the checkpointing of this RDD by saving this. It is called after a job using this RDD\n   * has completed (therefore the RDD has been materialized and potentially stored in memory).\n   * doCheckpoint() is called recursively on the parent RDDs.\n   */  \n\tprivate[spark] def doCheckpoint(): Unit = {\n    RDDOperationScope.withScope(sc, \"checkpoint\", allowNesting = false, ignoreParent = true) {\n      if (!doCheckpointCalled) {\n        doCheckpointCalled = true\n        if (checkpointData.isDefined) {\n          if (checkpointAllMarkedAncestors) {\n            // TODO We can collect all the RDDs that needs to be checkpointed, and then checkpoint\n            // them in parallel.\n            // Checkpoint parents first because our lineage will be truncated after we\n            // checkpoint ourselves\n            dependencies.foreach(_.rdd.doCheckpoint())\n          }\n          checkpointData.get.checkpoint()\n        } else {\n          dependencies.foreach(_.rdd.doCheckpoint())\n        }\n      }\n    }\n  }\n```\n\n","slug":"Spark-Check-Point","published":1,"updated":"2023-09-25T22:15:00.993Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clmzgww640002i3ex8974avl0","content":"<h1 id=\"Spark-check-point\"><a href=\"#Spark-check-point\" class=\"headerlink\" title=\"Spark check point\"></a>Spark check point</h1><p>In SparkContext, when a job is completed, rdd.doCheckpoint() will be called. </p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Run a function on a given set of partitions in an RDD and pass the results to the given</span></span><br><span class=\"line\"><span class=\"comment\">  * handler function. This is the main entry point for all actions in Spark.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * @param rdd target RDD to run tasks on</span></span><br><span class=\"line\"><span class=\"comment\">  * @param func a function to run on each partition of the RDD</span></span><br><span class=\"line\"><span class=\"comment\">  * @param partitions set of partitions to run on; some jobs may not want to compute on all</span></span><br><span class=\"line\"><span class=\"comment\">  * partitions of the target RDD, e.g. for operations like `first()`</span></span><br><span class=\"line\"><span class=\"comment\">  * @param resultHandler callback to pass each result to</span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">runJob</span></span>[<span class=\"type\">T</span>, <span class=\"type\">U</span>: <span class=\"type\">ClassTag</span>](</span><br><span class=\"line\">     rdd: <span class=\"type\">RDD</span>[<span class=\"type\">T</span>],</span><br><span class=\"line\">     func: (<span class=\"type\">TaskContext</span>, <span class=\"type\">Iterator</span>[<span class=\"type\">T</span>]) =&gt; <span class=\"type\">U</span>,</span><br><span class=\"line\">     partitions: <span class=\"type\">Seq</span>[<span class=\"type\">Int</span>],</span><br><span class=\"line\">     resultHandler: (<span class=\"type\">Int</span>, <span class=\"type\">U</span>) =&gt; <span class=\"type\">Unit</span>): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">   \trun job</span><br><span class=\"line\">   ...</span><br><span class=\"line\">   <span class=\"comment\">// job completed</span></span><br><span class=\"line\">   rdd.doCheckpoint()</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>Check point code in RDD.</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Performs the checkpointing of this RDD by saving this. It is called after a job using this RDD</span></span><br><span class=\"line\"><span class=\"comment\">  * has completed (therefore the RDD has been materialized and potentially stored in memory).</span></span><br><span class=\"line\"><span class=\"comment\">  * doCheckpoint() is called recursively on the parent RDDs.</span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span>[spark] <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">doCheckpoint</span></span>(): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">   <span class=\"type\">RDDOperationScope</span>.withScope(sc, <span class=\"string\">&quot;checkpoint&quot;</span>, allowNesting = <span class=\"literal\">false</span>, ignoreParent = <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (!doCheckpointCalled) &#123;</span><br><span class=\"line\">       doCheckpointCalled = <span class=\"literal\">true</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (checkpointData.isDefined) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (checkpointAllMarkedAncestors) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// TODO We can collect all the RDDs that needs to be checkpointed, and then checkpoint</span></span><br><span class=\"line\">           <span class=\"comment\">// them in parallel.</span></span><br><span class=\"line\">           <span class=\"comment\">// Checkpoint parents first because our lineage will be truncated after we</span></span><br><span class=\"line\">           <span class=\"comment\">// checkpoint ourselves</span></span><br><span class=\"line\">           dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         checkpointData.get.checkpoint()</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Spark-check-point\"><a href=\"#Spark-check-point\" class=\"headerlink\" title=\"Spark check point\"></a>Spark check point</h1><p>In SparkContext, when a job is completed, rdd.doCheckpoint() will be called. </p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Run a function on a given set of partitions in an RDD and pass the results to the given</span></span><br><span class=\"line\"><span class=\"comment\">  * handler function. This is the main entry point for all actions in Spark.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * @param rdd target RDD to run tasks on</span></span><br><span class=\"line\"><span class=\"comment\">  * @param func a function to run on each partition of the RDD</span></span><br><span class=\"line\"><span class=\"comment\">  * @param partitions set of partitions to run on; some jobs may not want to compute on all</span></span><br><span class=\"line\"><span class=\"comment\">  * partitions of the target RDD, e.g. for operations like `first()`</span></span><br><span class=\"line\"><span class=\"comment\">  * @param resultHandler callback to pass each result to</span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">runJob</span></span>[<span class=\"type\">T</span>, <span class=\"type\">U</span>: <span class=\"type\">ClassTag</span>](</span><br><span class=\"line\">     rdd: <span class=\"type\">RDD</span>[<span class=\"type\">T</span>],</span><br><span class=\"line\">     func: (<span class=\"type\">TaskContext</span>, <span class=\"type\">Iterator</span>[<span class=\"type\">T</span>]) =&gt; <span class=\"type\">U</span>,</span><br><span class=\"line\">     partitions: <span class=\"type\">Seq</span>[<span class=\"type\">Int</span>],</span><br><span class=\"line\">     resultHandler: (<span class=\"type\">Int</span>, <span class=\"type\">U</span>) =&gt; <span class=\"type\">Unit</span>): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">   \trun job</span><br><span class=\"line\">   ...</span><br><span class=\"line\">   <span class=\"comment\">// job completed</span></span><br><span class=\"line\">   rdd.doCheckpoint()</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>Check point code in RDD.</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Performs the checkpointing of this RDD by saving this. It is called after a job using this RDD</span></span><br><span class=\"line\"><span class=\"comment\">  * has completed (therefore the RDD has been materialized and potentially stored in memory).</span></span><br><span class=\"line\"><span class=\"comment\">  * doCheckpoint() is called recursively on the parent RDDs.</span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span>[spark] <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">doCheckpoint</span></span>(): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">   <span class=\"type\">RDDOperationScope</span>.withScope(sc, <span class=\"string\">&quot;checkpoint&quot;</span>, allowNesting = <span class=\"literal\">false</span>, ignoreParent = <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (!doCheckpointCalled) &#123;</span><br><span class=\"line\">       doCheckpointCalled = <span class=\"literal\">true</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (checkpointData.isDefined) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (checkpointAllMarkedAncestors) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// TODO We can collect all the RDDs that needs to be checkpointed, and then checkpoint</span></span><br><span class=\"line\">           <span class=\"comment\">// them in parallel.</span></span><br><span class=\"line\">           <span class=\"comment\">// Checkpoint parents first because our lineage will be truncated after we</span></span><br><span class=\"line\">           <span class=\"comment\">// checkpoint ourselves</span></span><br><span class=\"line\">           dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         checkpointData.get.checkpoint()</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         dependencies.foreach(_.rdd.doCheckpoint())</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"Spark Memory Manager","date":"2023-09-14T21:40:33.000Z","_content":"\nUnifiedMemoryManager:\n\n```scala\n\n// acquireStorageMemory\noverride def acquireStorageMemory(\n      blockId: BlockId,\n      numBytes: Long,\n      memoryMode: MemoryMode): Boolean = synchronized {\n    assertInvariants()\n    assert(numBytes >= 0)\n    val (executionPool, storagePool, maxMemory) = memoryMode match {\n      case MemoryMode.ON_HEAP => (\n        onHeapExecutionMemoryPool,\n        onHeapStorageMemoryPool,\n        maxOnHeapStorageMemory)\n      case MemoryMode.OFF_HEAP => (\n        offHeapExecutionMemoryPool,\n        offHeapStorageMemoryPool,\n        maxOffHeapStorageMemory)\n    }\n    if (numBytes > maxMemory) {\n      // Fail fast if the block simply won't fit\n      logInfo(s\"Will not store $blockId as the required space ($numBytes bytes) exceeds our \" +\n        s\"memory limit ($maxMemory bytes)\")\n      return false\n    }\n    if (numBytes > storagePool.memoryFree) {\n      // There is not enough free memory in the storage pool, so try to borrow free memory from\n      // the execution pool.\n      val memoryBorrowedFromExecution = Math.min(executionPool.memoryFree,\n        numBytes - storagePool.memoryFree)\n      executionPool.decrementPoolSize(memoryBorrowedFromExecution)\n      storagePool.incrementPoolSize(memoryBorrowedFromExecution)\n    }\n    storagePool.acquireMemory(blockId, numBytes)\n  }\n\n\n\n  /**\n   * Try to acquire up to `numBytes` of execution memory for the current task and return the\n   * number of bytes obtained, or 0 if none can be allocated.\n   *\n   * This call may block until there is enough free memory in some situations, to make sure each\n   * task has a chance to ramp up to at least 1 / 2N of the total memory pool (where N is the # of\n   * active tasks) before it is forced to spill. This can happen if the number of tasks increase\n   * but an older task had a lot of memory already.\n   */\n  override private[memory] def acquireExecutionMemory(\n      numBytes: Long,\n      taskAttemptId: Long,\n      memoryMode: MemoryMode): Long = synchronized {\n    assertInvariants()\n    assert(numBytes >= 0)\n    val (executionPool, storagePool, storageRegionSize, maxMemory) = memoryMode match {\n      case MemoryMode.ON_HEAP => (\n        onHeapExecutionMemoryPool,\n        onHeapStorageMemoryPool,\n        onHeapStorageRegionSize,\n        maxHeapMemory)\n      case MemoryMode.OFF_HEAP => (\n        offHeapExecutionMemoryPool,\n        offHeapStorageMemoryPool,\n        offHeapStorageMemory,\n        maxOffHeapMemory)\n    }\n\n    /**\n     * Grow the execution pool by evicting cached blocks, thereby shrinking the storage pool.\n     *\n     * When acquiring memory for a task, the execution pool may need to make multiple\n     * attempts. Each attempt must be able to evict storage in case another task jumps in\n     * and caches a large block between the attempts. This is called once per attempt.\n     */\n    def maybeGrowExecutionPool(extraMemoryNeeded: Long): Unit = {\n      if (extraMemoryNeeded > 0) {\n        // There is not enough free memory in the execution pool, so try to reclaim memory from\n        // storage. We can reclaim any free memory from the storage pool. If the storage pool\n        // has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim\n        // the memory that storage has borrowed from execution.\n        val memoryReclaimableFromStorage = math.max(\n          storagePool.memoryFree,\n          storagePool.poolSize - storageRegionSize)\n        if (memoryReclaimableFromStorage > 0) {\n          // Only reclaim as much space as is necessary and available:\n          val spaceToReclaim = storagePool.freeSpaceToShrinkPool(\n            math.min(extraMemoryNeeded, memoryReclaimableFromStorage))\n          storagePool.decrementPoolSize(spaceToReclaim)\n          executionPool.incrementPoolSize(spaceToReclaim)\n        }\n      }\n    }\n\n    /**\n     * The size the execution pool would have after evicting storage memory.\n     *\n     * The execution memory pool divides this quantity among the active tasks evenly to cap\n     * the execution memory allocation for each task. It is important to keep this greater\n     * than the execution pool size, which doesn't take into account potential memory that\n     * could be freed by evicting storage. Otherwise we may hit SPARK-12155.\n     *\n     * Additionally, this quantity should be kept below `maxMemory` to arbitrate fairness\n     * in execution memory allocation across tasks, Otherwise, a task may occupy more than\n     * its fair share of execution memory, mistakenly thinking that other tasks can acquire\n     * the portion of storage memory that cannot be evicted.\n     */\n    def computeMaxExecutionPoolSize(): Long = {\n      maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)\n    }\n\n    executionPool.acquireMemory(\n      numBytes, taskAttemptId, maybeGrowExecutionPool, () => computeMaxExecutionPoolSize)\n  }\n```\n\nStorageMemoryPool:\n\n```scala\n  /**\n   * Acquire N bytes of storage memory for the given block, evicting existing ones if necessary.\n   *\n   * @param blockId the ID of the block we are acquiring storage memory for\n   * @param numBytesToAcquire the size of this block\n   * @param numBytesToFree the amount of space to be freed through evicting blocks\n   * @return whether all N bytes were successfully granted.\n   */\n  def acquireMemory(\n      blockId: BlockId,\n      numBytesToAcquire: Long,\n      numBytesToFree: Long): Boolean = lock.synchronized {\n    assert(numBytesToAcquire >= 0)\n    assert(numBytesToFree >= 0)\n    assert(memoryUsed <= poolSize)\n    if (numBytesToFree > 0) {\n      memoryStore.evictBlocksToFreeSpace(Some(blockId), numBytesToFree, memoryMode)\n    }\n    // NOTE: If the memory store evicts blocks, then those evictions will synchronously call\n    // back into this StorageMemoryPool in order to free memory. Therefore, these variables\n    // should have been updated.\n    val enoughMemory = numBytesToAcquire <= memoryFree\n    if (enoughMemory) {\n      _memoryUsed += numBytesToAcquire\n    }\n    enoughMemory\n  }\n```\n\n\n\n\n\n\n\n","source":"_posts/Spark-Memory-Manager.md","raw":"---\ntitle: Spark Memory Manager\ndate: 2023-09-14 16:40:33\ntags:\n---\n\nUnifiedMemoryManager:\n\n```scala\n\n// acquireStorageMemory\noverride def acquireStorageMemory(\n      blockId: BlockId,\n      numBytes: Long,\n      memoryMode: MemoryMode): Boolean = synchronized {\n    assertInvariants()\n    assert(numBytes >= 0)\n    val (executionPool, storagePool, maxMemory) = memoryMode match {\n      case MemoryMode.ON_HEAP => (\n        onHeapExecutionMemoryPool,\n        onHeapStorageMemoryPool,\n        maxOnHeapStorageMemory)\n      case MemoryMode.OFF_HEAP => (\n        offHeapExecutionMemoryPool,\n        offHeapStorageMemoryPool,\n        maxOffHeapStorageMemory)\n    }\n    if (numBytes > maxMemory) {\n      // Fail fast if the block simply won't fit\n      logInfo(s\"Will not store $blockId as the required space ($numBytes bytes) exceeds our \" +\n        s\"memory limit ($maxMemory bytes)\")\n      return false\n    }\n    if (numBytes > storagePool.memoryFree) {\n      // There is not enough free memory in the storage pool, so try to borrow free memory from\n      // the execution pool.\n      val memoryBorrowedFromExecution = Math.min(executionPool.memoryFree,\n        numBytes - storagePool.memoryFree)\n      executionPool.decrementPoolSize(memoryBorrowedFromExecution)\n      storagePool.incrementPoolSize(memoryBorrowedFromExecution)\n    }\n    storagePool.acquireMemory(blockId, numBytes)\n  }\n\n\n\n  /**\n   * Try to acquire up to `numBytes` of execution memory for the current task and return the\n   * number of bytes obtained, or 0 if none can be allocated.\n   *\n   * This call may block until there is enough free memory in some situations, to make sure each\n   * task has a chance to ramp up to at least 1 / 2N of the total memory pool (where N is the # of\n   * active tasks) before it is forced to spill. This can happen if the number of tasks increase\n   * but an older task had a lot of memory already.\n   */\n  override private[memory] def acquireExecutionMemory(\n      numBytes: Long,\n      taskAttemptId: Long,\n      memoryMode: MemoryMode): Long = synchronized {\n    assertInvariants()\n    assert(numBytes >= 0)\n    val (executionPool, storagePool, storageRegionSize, maxMemory) = memoryMode match {\n      case MemoryMode.ON_HEAP => (\n        onHeapExecutionMemoryPool,\n        onHeapStorageMemoryPool,\n        onHeapStorageRegionSize,\n        maxHeapMemory)\n      case MemoryMode.OFF_HEAP => (\n        offHeapExecutionMemoryPool,\n        offHeapStorageMemoryPool,\n        offHeapStorageMemory,\n        maxOffHeapMemory)\n    }\n\n    /**\n     * Grow the execution pool by evicting cached blocks, thereby shrinking the storage pool.\n     *\n     * When acquiring memory for a task, the execution pool may need to make multiple\n     * attempts. Each attempt must be able to evict storage in case another task jumps in\n     * and caches a large block between the attempts. This is called once per attempt.\n     */\n    def maybeGrowExecutionPool(extraMemoryNeeded: Long): Unit = {\n      if (extraMemoryNeeded > 0) {\n        // There is not enough free memory in the execution pool, so try to reclaim memory from\n        // storage. We can reclaim any free memory from the storage pool. If the storage pool\n        // has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim\n        // the memory that storage has borrowed from execution.\n        val memoryReclaimableFromStorage = math.max(\n          storagePool.memoryFree,\n          storagePool.poolSize - storageRegionSize)\n        if (memoryReclaimableFromStorage > 0) {\n          // Only reclaim as much space as is necessary and available:\n          val spaceToReclaim = storagePool.freeSpaceToShrinkPool(\n            math.min(extraMemoryNeeded, memoryReclaimableFromStorage))\n          storagePool.decrementPoolSize(spaceToReclaim)\n          executionPool.incrementPoolSize(spaceToReclaim)\n        }\n      }\n    }\n\n    /**\n     * The size the execution pool would have after evicting storage memory.\n     *\n     * The execution memory pool divides this quantity among the active tasks evenly to cap\n     * the execution memory allocation for each task. It is important to keep this greater\n     * than the execution pool size, which doesn't take into account potential memory that\n     * could be freed by evicting storage. Otherwise we may hit SPARK-12155.\n     *\n     * Additionally, this quantity should be kept below `maxMemory` to arbitrate fairness\n     * in execution memory allocation across tasks, Otherwise, a task may occupy more than\n     * its fair share of execution memory, mistakenly thinking that other tasks can acquire\n     * the portion of storage memory that cannot be evicted.\n     */\n    def computeMaxExecutionPoolSize(): Long = {\n      maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)\n    }\n\n    executionPool.acquireMemory(\n      numBytes, taskAttemptId, maybeGrowExecutionPool, () => computeMaxExecutionPoolSize)\n  }\n```\n\nStorageMemoryPool:\n\n```scala\n  /**\n   * Acquire N bytes of storage memory for the given block, evicting existing ones if necessary.\n   *\n   * @param blockId the ID of the block we are acquiring storage memory for\n   * @param numBytesToAcquire the size of this block\n   * @param numBytesToFree the amount of space to be freed through evicting blocks\n   * @return whether all N bytes were successfully granted.\n   */\n  def acquireMemory(\n      blockId: BlockId,\n      numBytesToAcquire: Long,\n      numBytesToFree: Long): Boolean = lock.synchronized {\n    assert(numBytesToAcquire >= 0)\n    assert(numBytesToFree >= 0)\n    assert(memoryUsed <= poolSize)\n    if (numBytesToFree > 0) {\n      memoryStore.evictBlocksToFreeSpace(Some(blockId), numBytesToFree, memoryMode)\n    }\n    // NOTE: If the memory store evicts blocks, then those evictions will synchronously call\n    // back into this StorageMemoryPool in order to free memory. Therefore, these variables\n    // should have been updated.\n    val enoughMemory = numBytesToAcquire <= memoryFree\n    if (enoughMemory) {\n      _memoryUsed += numBytesToAcquire\n    }\n    enoughMemory\n  }\n```\n\n\n\n\n\n\n\n","slug":"Spark-Memory-Manager","published":1,"updated":"2023-09-14T21:53:07.947Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clmzgww650003i3exh9w1amih","content":"<p>UnifiedMemoryManager:</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// acquireStorageMemory</span></span><br><span class=\"line\"><span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireStorageMemory</span></span>(</span><br><span class=\"line\">      blockId: <span class=\"type\">BlockId</span>,</span><br><span class=\"line\">      numBytes: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      memoryMode: <span class=\"type\">MemoryMode</span>): <span class=\"type\">Boolean</span> = synchronized &#123;</span><br><span class=\"line\">    assertInvariants()</span><br><span class=\"line\">    assert(numBytes &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">val</span> (executionPool, storagePool, maxMemory) = memoryMode <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">ON_HEAP</span> =&gt; (</span><br><span class=\"line\">        onHeapExecutionMemoryPool,</span><br><span class=\"line\">        onHeapStorageMemoryPool,</span><br><span class=\"line\">        maxOnHeapStorageMemory)</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">OFF_HEAP</span> =&gt; (</span><br><span class=\"line\">        offHeapExecutionMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemoryPool,</span><br><span class=\"line\">        maxOffHeapStorageMemory)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numBytes &gt; maxMemory) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Fail fast if the block simply won&#x27;t fit</span></span><br><span class=\"line\">      logInfo(<span class=\"string\">s&quot;Will not store <span class=\"subst\">$blockId</span> as the required space (<span class=\"subst\">$numBytes</span> bytes) exceeds our &quot;</span> +</span><br><span class=\"line\">        <span class=\"string\">s&quot;memory limit (<span class=\"subst\">$maxMemory</span> bytes)&quot;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numBytes &gt; storagePool.memoryFree) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// There is not enough free memory in the storage pool, so try to borrow free memory from</span></span><br><span class=\"line\">      <span class=\"comment\">// the execution pool.</span></span><br><span class=\"line\">      <span class=\"keyword\">val</span> memoryBorrowedFromExecution = <span class=\"type\">Math</span>.min(executionPool.memoryFree,</span><br><span class=\"line\">        numBytes - storagePool.memoryFree)</span><br><span class=\"line\">      executionPool.decrementPoolSize(memoryBorrowedFromExecution)</span><br><span class=\"line\">      storagePool.incrementPoolSize(memoryBorrowedFromExecution)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    storagePool.acquireMemory(blockId, numBytes)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Try to acquire up to `numBytes` of execution memory for the current task and return the</span></span><br><span class=\"line\"><span class=\"comment\">   * number of bytes obtained, or 0 if none can be allocated.</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * This call may block until there is enough free memory in some situations, to make sure each</span></span><br><span class=\"line\"><span class=\"comment\">   * task has a chance to ramp up to at least 1 / 2N of the total memory pool (where N is the # of</span></span><br><span class=\"line\"><span class=\"comment\">   * active tasks) before it is forced to spill. This can happen if the number of tasks increase</span></span><br><span class=\"line\"><span class=\"comment\">   * but an older task had a lot of memory already.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"keyword\">private</span>[memory] <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireExecutionMemory</span></span>(</span><br><span class=\"line\">      numBytes: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      taskAttemptId: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      memoryMode: <span class=\"type\">MemoryMode</span>): <span class=\"type\">Long</span> = synchronized &#123;</span><br><span class=\"line\">    assertInvariants()</span><br><span class=\"line\">    assert(numBytes &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">val</span> (executionPool, storagePool, storageRegionSize, maxMemory) = memoryMode <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">ON_HEAP</span> =&gt; (</span><br><span class=\"line\">        onHeapExecutionMemoryPool,</span><br><span class=\"line\">        onHeapStorageMemoryPool,</span><br><span class=\"line\">        onHeapStorageRegionSize,</span><br><span class=\"line\">        maxHeapMemory)</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">OFF_HEAP</span> =&gt; (</span><br><span class=\"line\">        offHeapExecutionMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemory,</span><br><span class=\"line\">        maxOffHeapMemory)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Grow the execution pool by evicting cached blocks, thereby shrinking the storage pool.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * When acquiring memory for a task, the execution pool may need to make multiple</span></span><br><span class=\"line\"><span class=\"comment\">     * attempts. Each attempt must be able to evict storage in case another task jumps in</span></span><br><span class=\"line\"><span class=\"comment\">     * and caches a large block between the attempts. This is called once per attempt.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">maybeGrowExecutionPool</span></span>(extraMemoryNeeded: <span class=\"type\">Long</span>): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (extraMemoryNeeded &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// There is not enough free memory in the execution pool, so try to reclaim memory from</span></span><br><span class=\"line\">        <span class=\"comment\">// storage. We can reclaim any free memory from the storage pool. If the storage pool</span></span><br><span class=\"line\">        <span class=\"comment\">// has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim</span></span><br><span class=\"line\">        <span class=\"comment\">// the memory that storage has borrowed from execution.</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> memoryReclaimableFromStorage = math.max(</span><br><span class=\"line\">          storagePool.memoryFree,</span><br><span class=\"line\">          storagePool.poolSize - storageRegionSize)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (memoryReclaimableFromStorage &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// Only reclaim as much space as is necessary and available:</span></span><br><span class=\"line\">          <span class=\"keyword\">val</span> spaceToReclaim = storagePool.freeSpaceToShrinkPool(</span><br><span class=\"line\">            math.min(extraMemoryNeeded, memoryReclaimableFromStorage))</span><br><span class=\"line\">          storagePool.decrementPoolSize(spaceToReclaim)</span><br><span class=\"line\">          executionPool.incrementPoolSize(spaceToReclaim)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * The size the execution pool would have after evicting storage memory.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * The execution memory pool divides this quantity among the active tasks evenly to cap</span></span><br><span class=\"line\"><span class=\"comment\">     * the execution memory allocation for each task. It is important to keep this greater</span></span><br><span class=\"line\"><span class=\"comment\">     * than the execution pool size, which doesn&#x27;t take into account potential memory that</span></span><br><span class=\"line\"><span class=\"comment\">     * could be freed by evicting storage. Otherwise we may hit SPARK-12155.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * Additionally, this quantity should be kept below `maxMemory` to arbitrate fairness</span></span><br><span class=\"line\"><span class=\"comment\">     * in execution memory allocation across tasks, Otherwise, a task may occupy more than</span></span><br><span class=\"line\"><span class=\"comment\">     * its fair share of execution memory, mistakenly thinking that other tasks can acquire</span></span><br><span class=\"line\"><span class=\"comment\">     * the portion of storage memory that cannot be evicted.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">computeMaxExecutionPoolSize</span></span>(): <span class=\"type\">Long</span> = &#123;</span><br><span class=\"line\">      maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    executionPool.acquireMemory(</span><br><span class=\"line\">      numBytes, taskAttemptId, maybeGrowExecutionPool, () =&gt; computeMaxExecutionPoolSize)</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>StorageMemoryPool:</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Acquire N bytes of storage memory for the given block, evicting existing ones if necessary.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * @param blockId the ID of the block we are acquiring storage memory for</span></span><br><span class=\"line\"><span class=\"comment\"> * @param numBytesToAcquire the size of this block</span></span><br><span class=\"line\"><span class=\"comment\"> * @param numBytesToFree the amount of space to be freed through evicting blocks</span></span><br><span class=\"line\"><span class=\"comment\"> * @return whether all N bytes were successfully granted.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireMemory</span></span>(</span><br><span class=\"line\">    blockId: <span class=\"type\">BlockId</span>,</span><br><span class=\"line\">    numBytesToAcquire: <span class=\"type\">Long</span>,</span><br><span class=\"line\">    numBytesToFree: <span class=\"type\">Long</span>): <span class=\"type\">Boolean</span> = lock.synchronized &#123;</span><br><span class=\"line\">  assert(numBytesToAcquire &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">  assert(numBytesToFree &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">  assert(memoryUsed &lt;= poolSize)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (numBytesToFree &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    memoryStore.evictBlocksToFreeSpace(<span class=\"type\">Some</span>(blockId), numBytesToFree, memoryMode)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// <span class=\"doctag\">NOTE:</span> If the memory store evicts blocks, then those evictions will synchronously call</span></span><br><span class=\"line\">  <span class=\"comment\">// back into this StorageMemoryPool in order to free memory. Therefore, these variables</span></span><br><span class=\"line\">  <span class=\"comment\">// should have been updated.</span></span><br><span class=\"line\">  <span class=\"keyword\">val</span> enoughMemory = numBytesToAcquire &lt;= memoryFree</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (enoughMemory) &#123;</span><br><span class=\"line\">    _memoryUsed += numBytesToAcquire</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  enoughMemory</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<p>UnifiedMemoryManager:</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// acquireStorageMemory</span></span><br><span class=\"line\"><span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireStorageMemory</span></span>(</span><br><span class=\"line\">      blockId: <span class=\"type\">BlockId</span>,</span><br><span class=\"line\">      numBytes: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      memoryMode: <span class=\"type\">MemoryMode</span>): <span class=\"type\">Boolean</span> = synchronized &#123;</span><br><span class=\"line\">    assertInvariants()</span><br><span class=\"line\">    assert(numBytes &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">val</span> (executionPool, storagePool, maxMemory) = memoryMode <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">ON_HEAP</span> =&gt; (</span><br><span class=\"line\">        onHeapExecutionMemoryPool,</span><br><span class=\"line\">        onHeapStorageMemoryPool,</span><br><span class=\"line\">        maxOnHeapStorageMemory)</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">OFF_HEAP</span> =&gt; (</span><br><span class=\"line\">        offHeapExecutionMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemoryPool,</span><br><span class=\"line\">        maxOffHeapStorageMemory)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numBytes &gt; maxMemory) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Fail fast if the block simply won&#x27;t fit</span></span><br><span class=\"line\">      logInfo(<span class=\"string\">s&quot;Will not store <span class=\"subst\">$blockId</span> as the required space (<span class=\"subst\">$numBytes</span> bytes) exceeds our &quot;</span> +</span><br><span class=\"line\">        <span class=\"string\">s&quot;memory limit (<span class=\"subst\">$maxMemory</span> bytes)&quot;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numBytes &gt; storagePool.memoryFree) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// There is not enough free memory in the storage pool, so try to borrow free memory from</span></span><br><span class=\"line\">      <span class=\"comment\">// the execution pool.</span></span><br><span class=\"line\">      <span class=\"keyword\">val</span> memoryBorrowedFromExecution = <span class=\"type\">Math</span>.min(executionPool.memoryFree,</span><br><span class=\"line\">        numBytes - storagePool.memoryFree)</span><br><span class=\"line\">      executionPool.decrementPoolSize(memoryBorrowedFromExecution)</span><br><span class=\"line\">      storagePool.incrementPoolSize(memoryBorrowedFromExecution)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    storagePool.acquireMemory(blockId, numBytes)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Try to acquire up to `numBytes` of execution memory for the current task and return the</span></span><br><span class=\"line\"><span class=\"comment\">   * number of bytes obtained, or 0 if none can be allocated.</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * This call may block until there is enough free memory in some situations, to make sure each</span></span><br><span class=\"line\"><span class=\"comment\">   * task has a chance to ramp up to at least 1 / 2N of the total memory pool (where N is the # of</span></span><br><span class=\"line\"><span class=\"comment\">   * active tasks) before it is forced to spill. This can happen if the number of tasks increase</span></span><br><span class=\"line\"><span class=\"comment\">   * but an older task had a lot of memory already.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"keyword\">private</span>[memory] <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireExecutionMemory</span></span>(</span><br><span class=\"line\">      numBytes: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      taskAttemptId: <span class=\"type\">Long</span>,</span><br><span class=\"line\">      memoryMode: <span class=\"type\">MemoryMode</span>): <span class=\"type\">Long</span> = synchronized &#123;</span><br><span class=\"line\">    assertInvariants()</span><br><span class=\"line\">    assert(numBytes &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">val</span> (executionPool, storagePool, storageRegionSize, maxMemory) = memoryMode <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">ON_HEAP</span> =&gt; (</span><br><span class=\"line\">        onHeapExecutionMemoryPool,</span><br><span class=\"line\">        onHeapStorageMemoryPool,</span><br><span class=\"line\">        onHeapStorageRegionSize,</span><br><span class=\"line\">        maxHeapMemory)</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"type\">MemoryMode</span>.<span class=\"type\">OFF_HEAP</span> =&gt; (</span><br><span class=\"line\">        offHeapExecutionMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemoryPool,</span><br><span class=\"line\">        offHeapStorageMemory,</span><br><span class=\"line\">        maxOffHeapMemory)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Grow the execution pool by evicting cached blocks, thereby shrinking the storage pool.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * When acquiring memory for a task, the execution pool may need to make multiple</span></span><br><span class=\"line\"><span class=\"comment\">     * attempts. Each attempt must be able to evict storage in case another task jumps in</span></span><br><span class=\"line\"><span class=\"comment\">     * and caches a large block between the attempts. This is called once per attempt.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">maybeGrowExecutionPool</span></span>(extraMemoryNeeded: <span class=\"type\">Long</span>): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (extraMemoryNeeded &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// There is not enough free memory in the execution pool, so try to reclaim memory from</span></span><br><span class=\"line\">        <span class=\"comment\">// storage. We can reclaim any free memory from the storage pool. If the storage pool</span></span><br><span class=\"line\">        <span class=\"comment\">// has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim</span></span><br><span class=\"line\">        <span class=\"comment\">// the memory that storage has borrowed from execution.</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> memoryReclaimableFromStorage = math.max(</span><br><span class=\"line\">          storagePool.memoryFree,</span><br><span class=\"line\">          storagePool.poolSize - storageRegionSize)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (memoryReclaimableFromStorage &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// Only reclaim as much space as is necessary and available:</span></span><br><span class=\"line\">          <span class=\"keyword\">val</span> spaceToReclaim = storagePool.freeSpaceToShrinkPool(</span><br><span class=\"line\">            math.min(extraMemoryNeeded, memoryReclaimableFromStorage))</span><br><span class=\"line\">          storagePool.decrementPoolSize(spaceToReclaim)</span><br><span class=\"line\">          executionPool.incrementPoolSize(spaceToReclaim)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * The size the execution pool would have after evicting storage memory.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * The execution memory pool divides this quantity among the active tasks evenly to cap</span></span><br><span class=\"line\"><span class=\"comment\">     * the execution memory allocation for each task. It is important to keep this greater</span></span><br><span class=\"line\"><span class=\"comment\">     * than the execution pool size, which doesn&#x27;t take into account potential memory that</span></span><br><span class=\"line\"><span class=\"comment\">     * could be freed by evicting storage. Otherwise we may hit SPARK-12155.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * Additionally, this quantity should be kept below `maxMemory` to arbitrate fairness</span></span><br><span class=\"line\"><span class=\"comment\">     * in execution memory allocation across tasks, Otherwise, a task may occupy more than</span></span><br><span class=\"line\"><span class=\"comment\">     * its fair share of execution memory, mistakenly thinking that other tasks can acquire</span></span><br><span class=\"line\"><span class=\"comment\">     * the portion of storage memory that cannot be evicted.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">computeMaxExecutionPoolSize</span></span>(): <span class=\"type\">Long</span> = &#123;</span><br><span class=\"line\">      maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    executionPool.acquireMemory(</span><br><span class=\"line\">      numBytes, taskAttemptId, maybeGrowExecutionPool, () =&gt; computeMaxExecutionPoolSize)</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>StorageMemoryPool:</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Acquire N bytes of storage memory for the given block, evicting existing ones if necessary.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * @param blockId the ID of the block we are acquiring storage memory for</span></span><br><span class=\"line\"><span class=\"comment\"> * @param numBytesToAcquire the size of this block</span></span><br><span class=\"line\"><span class=\"comment\"> * @param numBytesToFree the amount of space to be freed through evicting blocks</span></span><br><span class=\"line\"><span class=\"comment\"> * @return whether all N bytes were successfully granted.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">acquireMemory</span></span>(</span><br><span class=\"line\">    blockId: <span class=\"type\">BlockId</span>,</span><br><span class=\"line\">    numBytesToAcquire: <span class=\"type\">Long</span>,</span><br><span class=\"line\">    numBytesToFree: <span class=\"type\">Long</span>): <span class=\"type\">Boolean</span> = lock.synchronized &#123;</span><br><span class=\"line\">  assert(numBytesToAcquire &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">  assert(numBytesToFree &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">  assert(memoryUsed &lt;= poolSize)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (numBytesToFree &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    memoryStore.evictBlocksToFreeSpace(<span class=\"type\">Some</span>(blockId), numBytesToFree, memoryMode)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// <span class=\"doctag\">NOTE:</span> If the memory store evicts blocks, then those evictions will synchronously call</span></span><br><span class=\"line\">  <span class=\"comment\">// back into this StorageMemoryPool in order to free memory. Therefore, these variables</span></span><br><span class=\"line\">  <span class=\"comment\">// should have been updated.</span></span><br><span class=\"line\">  <span class=\"keyword\">val</span> enoughMemory = numBytesToAcquire &lt;= memoryFree</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (enoughMemory) &#123;</span><br><span class=\"line\">    _memoryUsed += numBytesToAcquire</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  enoughMemory</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n"},{"title":"Color-FaaS-2","date":"2023-10-27T19:26:45.000Z","_content":"\n\n# Color FaaS Doc Final\n\nDesigned By Hanzhong Liu, Xi Shi\n\nAll Videos: https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9\n\nWebsite & Bill Service: https://github.com/muchengl/tamu-sw-faas\n\nClient: https://github.com/muchengl/Color-FaaS-Core\n\nFunction SDK: https://github.com/muchengl/Color-FaaS-SDK\n\nEnvironment: https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\n\n**Catalog**\n\n[toc]\n\n## **Introduction**\n\nIn this project, we have undertaken a significant redesign of our existing system, transitioning to a microservices architecture and incorporating multi-modal client interfaces. This iteration represents an evolution of our system, focusing on enhanced scalability, modularity, and user experience.\n\nOur submission for this iteration includes:\n\n1. **Requirements:** Detailed descriptions and UI sketches of all use cases, incorporating standard format narratives and sequence diagrams. Video recordings demonstrating the system in action for each defined use case, highlighting functionality and user interaction.\n2. **Database Design:** We redesigned our DB based on MongoDB. Comprehensive outlines of data entities, relationships, and an entity-relationship diagram, accompanied by sample data.\n3. **Architectural Design:** In-depth descriptions of client and server components, communication protocols, data formats, and an overarching system architecture diagram.\n4. **Runnable System:** A fully functional system with a personalized and polished UI.\n5. **Installation and Usage Manual:** A detailed Handbook covering installation procedures, usage instructions, and information on necessary libraries and frameworks.\n\n## **User cases and UI design**\n\n#### **User case **: Register & Login\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Register a new account and login to the platform             |\n| Path  | 1.User visits the website landing page<br />2.System returns the html code of the page<br />3.User clicks \"New User\"<br />4.System display the form for registering a new user<br />5.User fill in the new user information and submit<br />6.System writes the new user information to the database. And jump back to the landing page<br />7.User enters the new user information and clicks Login<br />8.System checks whether the user exists. If yes, go to the home page |\n\nUI of this User case:\n\nVIdeo: https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/Register.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/login.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n#### **User case **: Development/Upload function\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | A User want to deploy a application in cloud environment     |\n| Path  | 1. User develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file (in HDFS), and the function file is successfully created <br />3. User views the corresponding information in the function list |\n\nUI of this User case\n\nVideo: https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj\n\n\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/function.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n#### **User case **: Test Function via web page\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Test the function from platform's web page                   |\n| Path  | 1. User enter the function test page<br />2. System return the web page to user<br />3. User test this function from web page.<br />4. System calls the function and returns the result and log |\n\nUI of this User case:\n\nVideo: https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test02.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n#### **User case **: Test Functions via Public URL\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Test the function from platform's web page                   |\n| Path  | 1. User enter the function test page<br />2. System return the web page to user<br />3. User copy the \"public url\" and test it in Browser<br />4. System calls the function and returns the result and log as JSON. Show it in Browser. |\n\nVideo: https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u\n\n\n\n#### **User case **: Test Functions in the Desktop Tool\n\nThere are two options to implement this Desktop tool, one is to write an **interactive command line**, and the other is to implement the program with UI. Since my project is a developer-oriented tool, I decided to implement an interactive command line program that more closely resembles a real-world product (like these tools in linux).\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Test functions in desktop tool                               |\n| Path  | 1. User start the Desktop tool and login<br />2. System verifies that user information is correct<br />3. User enter list, history or test command to use different functions<br />4.System process the command and return the result<br />5.User see the output in screen. |\n\nUI of this User case:\n\nVideo: https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool01.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool02.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool03.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n#### **User case **: Manage tasks\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Trace  the running status of a Func                          |\n| Path  | 1. User enter Task manage page<br />2. System return the manage page<br />3. User look at the running status, output and time of the function |\n\nVideo: https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tasks.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n#### **User case **: Top up user's account\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Top up                                                       |\n| Path  | 1. User enter the account info page<br />2. System return the web page to user<br />3. User click \"Recharge\" button<br />4. System show the recharge form<br />5.User type info and click the button \"Submit\"<br />6.System add money to user's account |\n\nUI of this User case:\n\nVideo: https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/recarge.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n#### **User case **: Pay the bill\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Pay the bill                                                 |\n| Path  | 1. User enter the account info page<br />2. System return the web page to user<br />3. User click \"Update Bill\" button<br />4. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />5. User click \"Pay\" button<br />6. System deducts the fee and completes the payment |\n\nUI of this User case:\n\nVideo: https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/userdata.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n## **Architectural design**\n\n#### **High Level Design**\n\nThis system comprises three microservices: **Website Service**, **Billing Service**, and **Execution Client**. The Website interact with the Execution Client and Billing Servers using the **Http RestFul API** protocol. The Website Service is responsible for user login, function upload, and function management. The Billing Server handles generating bills and processing user operations for recharge and payment. \n\nThe Execution Client is a multi-instance service, allowing for the deployment of numerous instances to achieve horizontal scaling and enhance system performance. The clients will register its information in ZooKeeper. The Website can then retrieve the list of clients from ZooKeeper and subsequently dispatch function calls to these clients.\n\nCore cluster may contains many servers, so it can process many tasks in the same time. A **Client** program will run in In these servers. When a task is sent to a Client, it will stand up a Executor to process this task. The communitetion bewteen Client and Executor will been held by **gPRC**. Because, Function files are very big, so worker will use LRU to cache some function instances.\n\nAs for the architecture of this system：\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/arch.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n#### **Data Storage System**\n\nIn Website service and Bill service, we use **MongoDB** to store user's information. Website will provide user with functions include: add/update a Func, pay for the bill, trace Func status, debug function via webpage.\n\nFor function file storage, we use **HDFS** as the cloud storage system. User's function files will be uploaded to HDFS and got by Executor.\n\nFor cluster management, we use **ZooKeeper** as the information register system. All clients' info will be stored in ZooKeeper.\n\n#### **Data format between services**\n\n**User ↔ Website**\n\n| Request                                              | Protocol | Data Type | Request Data                                     | Response Data                                           | URL               |\n| ---------------------------------------------------- | -------- | --------- | ------------------------------------------------ | ------------------------------------------------------- | ----------------- |\n| Login                                                | POST     | Form      | Username<br />Password                           | Redirect to the home page                               | /user             |\n| Register new user                                    | POST     | Form      | Username<br />Password                           | register success: \"ok\"<br />fail to register: \"fail\"    | /add/user         |\n| Upload a new function                                | POST     | Form      | FunctionName<br />Description<br />Function File | upload success: \"ok\"<br />fail to upload: \"fail\"        | /upload/func      |\n| Update function's data                               | POST     | Json      | New FunctionName<br />New Description            | update success: \"ok\"<br />fail to update: \"fail\"        | /update/func      |\n| Get user's function list                             | GET      | url       | User ID                                          | A json list contains all user's function                | /funcs            |\n| Get user's function access history                   | GET      | url       | User ID                                          | A json list contains all user's function access history | /user/tasks       |\n| Pay for the bill <br />(Forward to the Bill service) | POST     | Json      | User ID<br />Bill ID                             | pay success: \"ok\"<br />fail to pay: \"fail\"              | /pay/bill         |\n| Top up<br />(Forward to the Bill service)            | POST     | Json      | User ID<br />Card Number<br />Amount of money    | success: \"ok\"<br />fail: \"fail\"                         | /user/add/balance |\n| Update Bill<br />(Forward to the Bill service)       | GET      | Json      | User ID                                          | success: \"ok\"<br />fail: \"fail\"                         | /update/bills     |\n| Get Bill List<br />(Forward to the Bill service)     | GET      | Json      | User ID                                          | A json list contains all user's bill history            | /bills            |\n| Invoke a function                                    | POST/GET | Json      | Function ID<br />Task Input                      | A json of output and logs                               | /func/invoke      |\n\n**Website ↔ Bill service**\n\n| Request          | Protocol | Data Type | Request Data                                  | Response Data                                | URL               |\n| ---------------- | -------- | --------- | --------------------------------------------- | -------------------------------------------- | ----------------- |\n| Pay for the bill | POST     | Json      | User ID<br />Bill ID                          | pay success: \"ok\"<br />fail to pay: \"fail\"   | /pay/bill         |\n| Top up           | POST     | Json      | User ID<br />Card Number<br />Amount of money | success: \"ok\"<br />fail: \"fail\"              | /user/add/balance |\n| Update Bill      | GET      | Json      | User ID                                       | success: \"ok\"<br />fail: \"fail\"              | /update/bills     |\n| Get Bill List    | GET      | Json      | User ID                                       | A json list contains all user's bill history | /bills            |\n\n\n\n**Website ↔ Client**\n\n| Request       | Protocol | Data Type | Request Data                                                 | Response Data                                   | URL          |\n| ------------- | -------- | --------- | ------------------------------------------------------------ | ----------------------------------------------- | ------------ |\n| Submit a task | POST     | Json      | TaskID          <br />FuncName        <br />FuncID          <br />FuncStorageType<br />TaskFuncPath     <br />TaskRunningMode <br />FuncType      <br />TaskCPUCore     <br />TaskMem        <br />TaskDiskSpace   <br />TaskMaxTime     <br />TaskInput | A JSON include:<br />status,<br />msg<br />logs | /func/invoke |\n\n\n\n## **Database Design**\n\nThis FaaS platform's database(MongoDB) design encompasses multiple tables, intended to manage user information, bills, functions, function execution records, billing units, and account history details. Here's a detailed explanation of these tables:\n\n1. **User Info Table**:\n    - `User_ID`: A unique identifier for the user, of type Bigint.\n    - `User_Email`: The email address of the user.\n    - `User_Name`: The name of the user, which can be up to 20 characters.\n    - `User_Password`: The password of the user, capped at 20 characters.\n    - `User_Balance`: The balance in the user's account, of type Bigint.\n2. **Bill Table**:\n    - `Bill_ID`: A unique identifier for the bill.\n    - `User_ID`: A unique identifier for the user, serving as an index.\n    - `Bill_Date`: The date of the bill.\n    - `Bill_Balance`: The amount of the bill.\n    - `Bill_tasks`: A JSON document inclueds all unpaid function running records, supported by MongoDB\n    - `Status`: The status of the bill, where 0 stands for unpaid and 1 for paid.\n3. **Function Table**:\n    - `Func_ID`: A unique identifier for the function.\n    - `User_ID`: A unique identifier for the user.\n    - `Func_Path`: The path to the function's code in object storage services like S3.\n    - `Func_Explanation`: An explanation or description of the function.\n    - `Func_Resource`: Resources required by the function, in JSON format, e.g., {\"CPU\":4,\"MEM\":1024m,\"DISK\":1024m}.\n4. **Func Running Record Table**:\n    - `ID`: A unique identifier for the execution record.\n    - `Func_ID`: A unique identifier for the function.\n    - `Running_Time`: Execution time, e.g., 100ms.\n    - `Status`: Status of execution, where 0 stands for failure, 1 for success, and 2 for pending.\n    - `Input`: Input data in JSON format.\n    - `Running_Date`: The date of execution.\n    - `Payment_Status`: Payment status, where 0 stands for unpaid and 1 for paid.\n5. **Billing Unit Table**:\n    - `Price`: The price, e.g., 0.01$/ms for functions.\n6. **Account Info History Table**:\n    - `ID`: A unique identifier for the record.\n    - `Date`: The date.\n    - `Type`: The action type (add fund or payment).\n    - `Account_num`: Account number.\n    - `Bill_ID`: The ID of the bill.\n    - `Money`: The amount.\n    - `User_ID`: A unique identifier for the user.\n\n---\n\n####  - User Info Table:\n\n| Item          | Type   | Explanation/Sample Data |\n| ------------- | ------ | ----------------------- |\n| User_ID       | String |                         |\n| User_Email    | String |                         |\n| User_Name     | String |                         |\n| User_Password | String |                         |\n| User_Balance  | Bigint | 1000.0$                 |\n\n#### - Bill Table\n\n| Item         | Type   | Explanation/Sample Data                                      |\n| ------------ | ------ | ------------------------------------------------------------ |\n| Bill_ID      | String |                                                              |\n| User_ID      | String | Index                                                        |\n| Bill_Date    | String |                                                              |\n| Bill_Balance | Bigint |                                                              |\n| Bill_Tasks   | Task   | A JSON document inclueds all unpaid function running records, supported by MongoDB<br />{<br />    {taskID:1,...},<br />    {taskID:2,...}<br />} |\n| Status       | int    | 0 unpay, 1 paid                                              |\n\n#### - Function Table\n\n| Item             | Type   | Explanation/Sample Data           |\n| ---------------- | ------ | --------------------------------- |\n| Func_ID          | String |                                   |\n| User_ID          | String |                                   |\n| Func_Args        | String | {\"num1\":int,\"num2\",int}           |\n| Func_Path        | String | path of func's code in HDFS or S3 |\n| Func_Explanation | String |                                   |\n\n#### - Func Running Record\n\n| tem            | Type   | Explanation/Sample Data       |\n| -------------- | ------ | ----------------------------- |\n| Running_ID     | String |                               |\n| Func_ID        | String |                               |\n| Running_Time   | String | Example: 100ms                |\n| Status         | Int    | 0: fail, 1 success, 2 pending |\n| Input          | String | A input json                  |\n| Running_Date   | String |                               |\n| Payment_Status | Int    | 0 unpay, 1 paid               |\n\n#### - Billing Unit\n\n| Item  | Type   | Explanation/Sample Data |\n| ----- | ------ | ----------------------- |\n| ID    | Bitint |                         |\n| Price | float  | 0.0001$ / ms            |\n\n#### - Account Info History\n\n| Item        | Type   | Explanation/Sample Data |\n| ----------- | ------ | ----------------------- |\n| ID          | String |                         |\n| Date        | String |                         |\n| Type        | Int    | Payment or ADD          |\n| Account_num | String |                         |\n| Bill_ID     | Int    |                         |\n| Money       | Bigint |                         |\n| User_ID     | Bigint |                         |\n\n#### - ER Graph\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/ER.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n## **Handbook**\n\nWebsite & Bill Service Code: https://github.com/muchengl/tamu-sw-faas\n\nClient Code: https://github.com/muchengl/Color-FaaS-Core\n\nDocker Environment: https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\n\n#### **Environment**\n\nThis service includes a Website, Bill service, and Client. Both the Website and Bill service rely on a Java environment (Java 1.8+), while the Client is developed using Golang and requires Golang 1.21. Website and Bill service use Maven to manager all dependent environment. Client can use Golang's mod to get all dependents.\n\n#### **Start Website and Bill Service**\n\nStep 01: Download/Clone all code of project.\n\nStep 02: Open the project with IDEA.\n\nStep 03: Open **pom.xml** in project and init maven for both main-module and bill-module.\n\nStep 04: Run project in IDEA. Website is in main module **com.tamu.faas.FaasApplication**. Bill is in bill module **com.tamu.faas.bill.BillApplication**\n\nStep 05: com.tamu.faas.FaasApplication will use port 8080 and com.tamu.faas.bill.BillApplication will use 8081.\n\n#### **Start Client Cluster** \n\nClient uses makefile to manager the project, you can use the follows commands to init and build the project:\n\n```\n➜ cd [client project's dir in your computer]\n➜ make mod\n---> make mod <---\ngo mod tidy\ngo mod download\n\n➜ make build\n---> make build <---\n./build.sh\n  ---> make clean <---\n  ---> init dir <---\n  ---> init files <---\n  ---> make server <---\n  ---> make client <---\n  ---> make executor <---\n\n```\n\nAnd than, use the follows commands to start the client:\n```\n➜ ./output/startup.sh --client\n```\n\nIf you see the following output, the client has started successfully (**only one client**, if you want to start many clients to form a cluster, you need to run muit-clients in many Containers/VMs):\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/run-core.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n#### **Start Zookeeper and HDFS**\n\nStart by docker-compose in project dir (May not work perfectly, may require manual installation) :\n\n```\n➜ cd [docker-compose's dir in your computer]\n➜ docker-compose up -d\n```\n\n#### **Test the project**\n\nTest the project by URL in your browser: http://localhost:8080/login\n\nHDFS URL in browser: http://localhost:9870/\n\nTest desktop tool:\n\n```\n➜ pip install prettytable requests\n➜ python3 client.py\n```\n\n","source":"_posts/Color-FaaS-2.md","raw":"---\ntitle: Color-FaaS-2\ndate: 2023-10-27 14:26:45\ntags:\n---\n\n\n# Color FaaS Doc Final\n\nDesigned By Hanzhong Liu, Xi Shi\n\nAll Videos: https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9\n\nWebsite & Bill Service: https://github.com/muchengl/tamu-sw-faas\n\nClient: https://github.com/muchengl/Color-FaaS-Core\n\nFunction SDK: https://github.com/muchengl/Color-FaaS-SDK\n\nEnvironment: https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\n\n**Catalog**\n\n[toc]\n\n## **Introduction**\n\nIn this project, we have undertaken a significant redesign of our existing system, transitioning to a microservices architecture and incorporating multi-modal client interfaces. This iteration represents an evolution of our system, focusing on enhanced scalability, modularity, and user experience.\n\nOur submission for this iteration includes:\n\n1. **Requirements:** Detailed descriptions and UI sketches of all use cases, incorporating standard format narratives and sequence diagrams. Video recordings demonstrating the system in action for each defined use case, highlighting functionality and user interaction.\n2. **Database Design:** We redesigned our DB based on MongoDB. Comprehensive outlines of data entities, relationships, and an entity-relationship diagram, accompanied by sample data.\n3. **Architectural Design:** In-depth descriptions of client and server components, communication protocols, data formats, and an overarching system architecture diagram.\n4. **Runnable System:** A fully functional system with a personalized and polished UI.\n5. **Installation and Usage Manual:** A detailed Handbook covering installation procedures, usage instructions, and information on necessary libraries and frameworks.\n\n## **User cases and UI design**\n\n#### **User case **: Register & Login\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Register a new account and login to the platform             |\n| Path  | 1.User visits the website landing page<br />2.System returns the html code of the page<br />3.User clicks \"New User\"<br />4.System display the form for registering a new user<br />5.User fill in the new user information and submit<br />6.System writes the new user information to the database. And jump back to the landing page<br />7.User enters the new user information and clicks Login<br />8.System checks whether the user exists. If yes, go to the home page |\n\nUI of this User case:\n\nVIdeo: https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/Register.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/login.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n#### **User case **: Development/Upload function\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | A User want to deploy a application in cloud environment     |\n| Path  | 1. User develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file (in HDFS), and the function file is successfully created <br />3. User views the corresponding information in the function list |\n\nUI of this User case\n\nVideo: https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj\n\n\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/function.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n#### **User case **: Test Function via web page\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Test the function from platform's web page                   |\n| Path  | 1. User enter the function test page<br />2. System return the web page to user<br />3. User test this function from web page.<br />4. System calls the function and returns the result and log |\n\nUI of this User case:\n\nVideo: https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test02.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n#### **User case **: Test Functions via Public URL\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | User                                                         |\n| Goal  | Test the function from platform's web page                   |\n| Path  | 1. User enter the function test page<br />2. System return the web page to user<br />3. User copy the \"public url\" and test it in Browser<br />4. System calls the function and returns the result and log as JSON. Show it in Browser. |\n\nVideo: https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u\n\n\n\n#### **User case **: Test Functions in the Desktop Tool\n\nThere are two options to implement this Desktop tool, one is to write an **interactive command line**, and the other is to implement the program with UI. Since my project is a developer-oriented tool, I decided to implement an interactive command line program that more closely resembles a real-world product (like these tools in linux).\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Test functions in desktop tool                               |\n| Path  | 1. User start the Desktop tool and login<br />2. System verifies that user information is correct<br />3. User enter list, history or test command to use different functions<br />4.System process the command and return the result<br />5.User see the output in screen. |\n\nUI of this User case:\n\nVideo: https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool01.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool02.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool03.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n#### **User case **: Manage tasks\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Trace  the running status of a Func                          |\n| Path  | 1. User enter Task manage page<br />2. System return the manage page<br />3. User look at the running status, output and time of the function |\n\nVideo: https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tasks.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n#### **User case **: Top up user's account\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Top up                                                       |\n| Path  | 1. User enter the account info page<br />2. System return the web page to user<br />3. User click \"Recharge\" button<br />4. System show the recharge form<br />5.User type info and click the button \"Submit\"<br />6.System add money to user's account |\n\nUI of this User case:\n\nVideo: https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/recarge.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n#### **User case **: Pay the bill\n\n| Items |                                                              |\n| ----- | ------------------------------------------------------------ |\n| Actor | Developer                                                    |\n| Goal  | Pay the bill                                                 |\n| Path  | 1. User enter the account info page<br />2. System return the web page to user<br />3. User click \"Update Bill\" button<br />4. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />5. User click \"Pay\" button<br />6. System deducts the fee and completes the payment |\n\nUI of this User case:\n\nVideo: https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/userdata.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n## **Architectural design**\n\n#### **High Level Design**\n\nThis system comprises three microservices: **Website Service**, **Billing Service**, and **Execution Client**. The Website interact with the Execution Client and Billing Servers using the **Http RestFul API** protocol. The Website Service is responsible for user login, function upload, and function management. The Billing Server handles generating bills and processing user operations for recharge and payment. \n\nThe Execution Client is a multi-instance service, allowing for the deployment of numerous instances to achieve horizontal scaling and enhance system performance. The clients will register its information in ZooKeeper. The Website can then retrieve the list of clients from ZooKeeper and subsequently dispatch function calls to these clients.\n\nCore cluster may contains many servers, so it can process many tasks in the same time. A **Client** program will run in In these servers. When a task is sent to a Client, it will stand up a Executor to process this task. The communitetion bewteen Client and Executor will been held by **gPRC**. Because, Function files are very big, so worker will use LRU to cache some function instances.\n\nAs for the architecture of this system：\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/arch.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n#### **Data Storage System**\n\nIn Website service and Bill service, we use **MongoDB** to store user's information. Website will provide user with functions include: add/update a Func, pay for the bill, trace Func status, debug function via webpage.\n\nFor function file storage, we use **HDFS** as the cloud storage system. User's function files will be uploaded to HDFS and got by Executor.\n\nFor cluster management, we use **ZooKeeper** as the information register system. All clients' info will be stored in ZooKeeper.\n\n#### **Data format between services**\n\n**User ↔ Website**\n\n| Request                                              | Protocol | Data Type | Request Data                                     | Response Data                                           | URL               |\n| ---------------------------------------------------- | -------- | --------- | ------------------------------------------------ | ------------------------------------------------------- | ----------------- |\n| Login                                                | POST     | Form      | Username<br />Password                           | Redirect to the home page                               | /user             |\n| Register new user                                    | POST     | Form      | Username<br />Password                           | register success: \"ok\"<br />fail to register: \"fail\"    | /add/user         |\n| Upload a new function                                | POST     | Form      | FunctionName<br />Description<br />Function File | upload success: \"ok\"<br />fail to upload: \"fail\"        | /upload/func      |\n| Update function's data                               | POST     | Json      | New FunctionName<br />New Description            | update success: \"ok\"<br />fail to update: \"fail\"        | /update/func      |\n| Get user's function list                             | GET      | url       | User ID                                          | A json list contains all user's function                | /funcs            |\n| Get user's function access history                   | GET      | url       | User ID                                          | A json list contains all user's function access history | /user/tasks       |\n| Pay for the bill <br />(Forward to the Bill service) | POST     | Json      | User ID<br />Bill ID                             | pay success: \"ok\"<br />fail to pay: \"fail\"              | /pay/bill         |\n| Top up<br />(Forward to the Bill service)            | POST     | Json      | User ID<br />Card Number<br />Amount of money    | success: \"ok\"<br />fail: \"fail\"                         | /user/add/balance |\n| Update Bill<br />(Forward to the Bill service)       | GET      | Json      | User ID                                          | success: \"ok\"<br />fail: \"fail\"                         | /update/bills     |\n| Get Bill List<br />(Forward to the Bill service)     | GET      | Json      | User ID                                          | A json list contains all user's bill history            | /bills            |\n| Invoke a function                                    | POST/GET | Json      | Function ID<br />Task Input                      | A json of output and logs                               | /func/invoke      |\n\n**Website ↔ Bill service**\n\n| Request          | Protocol | Data Type | Request Data                                  | Response Data                                | URL               |\n| ---------------- | -------- | --------- | --------------------------------------------- | -------------------------------------------- | ----------------- |\n| Pay for the bill | POST     | Json      | User ID<br />Bill ID                          | pay success: \"ok\"<br />fail to pay: \"fail\"   | /pay/bill         |\n| Top up           | POST     | Json      | User ID<br />Card Number<br />Amount of money | success: \"ok\"<br />fail: \"fail\"              | /user/add/balance |\n| Update Bill      | GET      | Json      | User ID                                       | success: \"ok\"<br />fail: \"fail\"              | /update/bills     |\n| Get Bill List    | GET      | Json      | User ID                                       | A json list contains all user's bill history | /bills            |\n\n\n\n**Website ↔ Client**\n\n| Request       | Protocol | Data Type | Request Data                                                 | Response Data                                   | URL          |\n| ------------- | -------- | --------- | ------------------------------------------------------------ | ----------------------------------------------- | ------------ |\n| Submit a task | POST     | Json      | TaskID          <br />FuncName        <br />FuncID          <br />FuncStorageType<br />TaskFuncPath     <br />TaskRunningMode <br />FuncType      <br />TaskCPUCore     <br />TaskMem        <br />TaskDiskSpace   <br />TaskMaxTime     <br />TaskInput | A JSON include:<br />status,<br />msg<br />logs | /func/invoke |\n\n\n\n## **Database Design**\n\nThis FaaS platform's database(MongoDB) design encompasses multiple tables, intended to manage user information, bills, functions, function execution records, billing units, and account history details. Here's a detailed explanation of these tables:\n\n1. **User Info Table**:\n    - `User_ID`: A unique identifier for the user, of type Bigint.\n    - `User_Email`: The email address of the user.\n    - `User_Name`: The name of the user, which can be up to 20 characters.\n    - `User_Password`: The password of the user, capped at 20 characters.\n    - `User_Balance`: The balance in the user's account, of type Bigint.\n2. **Bill Table**:\n    - `Bill_ID`: A unique identifier for the bill.\n    - `User_ID`: A unique identifier for the user, serving as an index.\n    - `Bill_Date`: The date of the bill.\n    - `Bill_Balance`: The amount of the bill.\n    - `Bill_tasks`: A JSON document inclueds all unpaid function running records, supported by MongoDB\n    - `Status`: The status of the bill, where 0 stands for unpaid and 1 for paid.\n3. **Function Table**:\n    - `Func_ID`: A unique identifier for the function.\n    - `User_ID`: A unique identifier for the user.\n    - `Func_Path`: The path to the function's code in object storage services like S3.\n    - `Func_Explanation`: An explanation or description of the function.\n    - `Func_Resource`: Resources required by the function, in JSON format, e.g., {\"CPU\":4,\"MEM\":1024m,\"DISK\":1024m}.\n4. **Func Running Record Table**:\n    - `ID`: A unique identifier for the execution record.\n    - `Func_ID`: A unique identifier for the function.\n    - `Running_Time`: Execution time, e.g., 100ms.\n    - `Status`: Status of execution, where 0 stands for failure, 1 for success, and 2 for pending.\n    - `Input`: Input data in JSON format.\n    - `Running_Date`: The date of execution.\n    - `Payment_Status`: Payment status, where 0 stands for unpaid and 1 for paid.\n5. **Billing Unit Table**:\n    - `Price`: The price, e.g., 0.01$/ms for functions.\n6. **Account Info History Table**:\n    - `ID`: A unique identifier for the record.\n    - `Date`: The date.\n    - `Type`: The action type (add fund or payment).\n    - `Account_num`: Account number.\n    - `Bill_ID`: The ID of the bill.\n    - `Money`: The amount.\n    - `User_ID`: A unique identifier for the user.\n\n---\n\n####  - User Info Table:\n\n| Item          | Type   | Explanation/Sample Data |\n| ------------- | ------ | ----------------------- |\n| User_ID       | String |                         |\n| User_Email    | String |                         |\n| User_Name     | String |                         |\n| User_Password | String |                         |\n| User_Balance  | Bigint | 1000.0$                 |\n\n#### - Bill Table\n\n| Item         | Type   | Explanation/Sample Data                                      |\n| ------------ | ------ | ------------------------------------------------------------ |\n| Bill_ID      | String |                                                              |\n| User_ID      | String | Index                                                        |\n| Bill_Date    | String |                                                              |\n| Bill_Balance | Bigint |                                                              |\n| Bill_Tasks   | Task   | A JSON document inclueds all unpaid function running records, supported by MongoDB<br />{<br />    {taskID:1,...},<br />    {taskID:2,...}<br />} |\n| Status       | int    | 0 unpay, 1 paid                                              |\n\n#### - Function Table\n\n| Item             | Type   | Explanation/Sample Data           |\n| ---------------- | ------ | --------------------------------- |\n| Func_ID          | String |                                   |\n| User_ID          | String |                                   |\n| Func_Args        | String | {\"num1\":int,\"num2\",int}           |\n| Func_Path        | String | path of func's code in HDFS or S3 |\n| Func_Explanation | String |                                   |\n\n#### - Func Running Record\n\n| tem            | Type   | Explanation/Sample Data       |\n| -------------- | ------ | ----------------------------- |\n| Running_ID     | String |                               |\n| Func_ID        | String |                               |\n| Running_Time   | String | Example: 100ms                |\n| Status         | Int    | 0: fail, 1 success, 2 pending |\n| Input          | String | A input json                  |\n| Running_Date   | String |                               |\n| Payment_Status | Int    | 0 unpay, 1 paid               |\n\n#### - Billing Unit\n\n| Item  | Type   | Explanation/Sample Data |\n| ----- | ------ | ----------------------- |\n| ID    | Bitint |                         |\n| Price | float  | 0.0001$ / ms            |\n\n#### - Account Info History\n\n| Item        | Type   | Explanation/Sample Data |\n| ----------- | ------ | ----------------------- |\n| ID          | String |                         |\n| Date        | String |                         |\n| Type        | Int    | Payment or ADD          |\n| Account_num | String |                         |\n| Bill_ID     | Int    |                         |\n| Money       | Bigint |                         |\n| User_ID     | Bigint |                         |\n\n#### - ER Graph\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/ER.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n## **Handbook**\n\nWebsite & Bill Service Code: https://github.com/muchengl/tamu-sw-faas\n\nClient Code: https://github.com/muchengl/Color-FaaS-Core\n\nDocker Environment: https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\n\n#### **Environment**\n\nThis service includes a Website, Bill service, and Client. Both the Website and Bill service rely on a Java environment (Java 1.8+), while the Client is developed using Golang and requires Golang 1.21. Website and Bill service use Maven to manager all dependent environment. Client can use Golang's mod to get all dependents.\n\n#### **Start Website and Bill Service**\n\nStep 01: Download/Clone all code of project.\n\nStep 02: Open the project with IDEA.\n\nStep 03: Open **pom.xml** in project and init maven for both main-module and bill-module.\n\nStep 04: Run project in IDEA. Website is in main module **com.tamu.faas.FaasApplication**. Bill is in bill module **com.tamu.faas.bill.BillApplication**\n\nStep 05: com.tamu.faas.FaasApplication will use port 8080 and com.tamu.faas.bill.BillApplication will use 8081.\n\n#### **Start Client Cluster** \n\nClient uses makefile to manager the project, you can use the follows commands to init and build the project:\n\n```\n➜ cd [client project's dir in your computer]\n➜ make mod\n---> make mod <---\ngo mod tidy\ngo mod download\n\n➜ make build\n---> make build <---\n./build.sh\n  ---> make clean <---\n  ---> init dir <---\n  ---> init files <---\n  ---> make server <---\n  ---> make client <---\n  ---> make executor <---\n\n```\n\nAnd than, use the follows commands to start the client:\n```\n➜ ./output/startup.sh --client\n```\n\nIf you see the following output, the client has started successfully (**only one client**, if you want to start many clients to form a cluster, you need to run muit-clients in many Containers/VMs):\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/run-core.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n#### **Start Zookeeper and HDFS**\n\nStart by docker-compose in project dir (May not work perfectly, may require manual installation) :\n\n```\n➜ cd [docker-compose's dir in your computer]\n➜ docker-compose up -d\n```\n\n#### **Test the project**\n\nTest the project by URL in your browser: http://localhost:8080/login\n\nHDFS URL in browser: http://localhost:9870/\n\nTest desktop tool:\n\n```\n➜ pip install prettytable requests\n➜ python3 client.py\n```\n\n","slug":"Color-FaaS-2","published":1,"updated":"2023-12-06T20:48:45.622Z","_id":"clog7v1gt0000z1okf674hc5a","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"Color-FaaS-Doc-Final\"><a href=\"#Color-FaaS-Doc-Final\" class=\"headerlink\" title=\"Color FaaS Doc Final\"></a>Color FaaS Doc Final</h1><p>Designed By Hanzhong Liu, Xi Shi</p>\n<p>All Videos: <a href=\"https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9\">https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9</a></p>\n<p>Website &amp; Bill Service: <a href=\"https://github.com/muchengl/tamu-sw-faas\">https://github.com/muchengl/tamu-sw-faas</a></p>\n<p>Client: <a href=\"https://github.com/muchengl/Color-FaaS-Core\">https://github.com/muchengl/Color-FaaS-Core</a></p>\n<p>Function SDK: <a href=\"https://github.com/muchengl/Color-FaaS-SDK\">https://github.com/muchengl/Color-FaaS-SDK</a></p>\n<p>Environment: <a href=\"https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p>\n<p><strong>Catalog</strong></p>\n<p>[toc]</p>\n<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a><strong>Introduction</strong></h2><p>In this project, we have undertaken a significant redesign of our existing system, transitioning to a microservices architecture and incorporating multi-modal client interfaces. This iteration represents an evolution of our system, focusing on enhanced scalability, modularity, and user experience.</p>\n<p>Our submission for this iteration includes:</p>\n<ol>\n<li><strong>Requirements:</strong> Detailed descriptions and UI sketches of all use cases, incorporating standard format narratives and sequence diagrams. Video recordings demonstrating the system in action for each defined use case, highlighting functionality and user interaction.</li>\n<li><strong>Database Design:</strong> We redesigned our DB based on MongoDB. Comprehensive outlines of data entities, relationships, and an entity-relationship diagram, accompanied by sample data.</li>\n<li><strong>Architectural Design:</strong> In-depth descriptions of client and server components, communication protocols, data formats, and an overarching system architecture diagram.</li>\n<li><strong>Runnable System:</strong> A fully functional system with a personalized and polished UI.</li>\n<li><strong>Installation and Usage Manual:</strong> A detailed Handbook covering installation procedures, usage instructions, and information on necessary libraries and frameworks.</li>\n</ol>\n<h2 id=\"User-cases-and-UI-design\"><a href=\"#User-cases-and-UI-design\" class=\"headerlink\" title=\"User cases and UI design\"></a><strong>User cases and UI design</strong></h2><h4 id=\"User-case-Register-amp-Login\"><a href=\"#User-case-Register-amp-Login\" class=\"headerlink\" title=\"**User case **: Register &amp; Login\"></a>**User case **: Register &amp; Login</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Register a new account and login to the platform</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1.User visits the website landing page<br />2.System returns the html code of the page<br />3.User clicks “New User”<br />4.System display the form for registering a new user<br />5.User fill in the new user information and submit<br />6.System writes the new user information to the database. And jump back to the landing page<br />7.User enters the new user information and clicks Login<br />8.System checks whether the user exists. If yes, go to the home page</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>VIdeo: <a href=\"https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz\">https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/Register.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/login.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Development-Upload-function\"><a href=\"#User-case-Development-Upload-function\" class=\"headerlink\" title=\"**User case **: Development/Upload function\"></a>**User case **: Development/Upload function</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>A User want to deploy a application in cloud environment</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file (in HDFS), and the function file is successfully created <br />3. User views the corresponding information in the function list</td>\n</tr>\n</tbody></table>\n<p>UI of this User case</p>\n<p>Video: <a href=\"https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj\">https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/function.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Test-Function-via-web-page\"><a href=\"#User-case-Test-Function-via-web-page\" class=\"headerlink\" title=\"**User case **: Test Function via web page\"></a>**User case **: Test Function via web page</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test the function from platform’s web page</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the function test page<br />2. System return the web page to user<br />3. User test this function from web page.<br />4. System calls the function and returns the result and log</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8\">https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test02.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Test-Functions-via-Public-URL\"><a href=\"#User-case-Test-Functions-via-Public-URL\" class=\"headerlink\" title=\"**User case **: Test Functions via Public URL\"></a>**User case **: Test Functions via Public URL</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test the function from platform’s web page</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the function test page<br />2. System return the web page to user<br />3. User copy the “public url” and test it in Browser<br />4. System calls the function and returns the result and log as JSON. Show it in Browser.</td>\n</tr>\n</tbody></table>\n<p>Video: <a href=\"https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u\">https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u</a></p>\n<h4 id=\"User-case-Test-Functions-in-the-Desktop-Tool\"><a href=\"#User-case-Test-Functions-in-the-Desktop-Tool\" class=\"headerlink\" title=\"**User case **: Test Functions in the Desktop Tool\"></a>**User case **: Test Functions in the Desktop Tool</h4><p>There are two options to implement this Desktop tool, one is to write an <strong>interactive command line</strong>, and the other is to implement the program with UI. Since my project is a developer-oriented tool, I decided to implement an interactive command line program that more closely resembles a real-world product (like these tools in linux).</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test functions in desktop tool</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User start the Desktop tool and login<br />2. System verifies that user information is correct<br />3. User enter list, history or test command to use different functions<br />4.System process the command and return the result<br />5.User see the output in screen.</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i\">https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool01.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool02.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool03.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<h4 id=\"User-case-Manage-tasks\"><a href=\"#User-case-Manage-tasks\" class=\"headerlink\" title=\"**User case **: Manage tasks\"></a>**User case **: Manage tasks</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Trace  the running status of a Func</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter Task manage page<br />2. System return the manage page<br />3. User look at the running status, output and time of the function</td>\n</tr>\n</tbody></table>\n<p>Video: <a href=\"https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE\">https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tasks.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<h4 id=\"User-case-Top-up-user’s-account\"><a href=\"#User-case-Top-up-user’s-account\" class=\"headerlink\" title=\"**User case **: Top up user’s account\"></a>**User case **: Top up user’s account</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Top up</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click “Recharge” button<br />4. System show the recharge form<br />5.User type info and click the button “Submit”<br />6.System add money to user’s account</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh\">https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/recarge.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<h4 id=\"User-case-Pay-the-bill\"><a href=\"#User-case-Pay-the-bill\" class=\"headerlink\" title=\"**User case **: Pay the bill\"></a>**User case **: Pay the bill</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Pay the bill</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click “Update Bill” button<br />4. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />5. User click “Pay” button<br />6. System deducts the fee and completes the payment</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i\">https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/userdata.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h2 id=\"Architectural-design\"><a href=\"#Architectural-design\" class=\"headerlink\" title=\"Architectural design\"></a><strong>Architectural design</strong></h2><h4 id=\"High-Level-Design\"><a href=\"#High-Level-Design\" class=\"headerlink\" title=\"High Level Design\"></a><strong>High Level Design</strong></h4><p>This system comprises three microservices: <strong>Website Service</strong>, <strong>Billing Service</strong>, and <strong>Execution Client</strong>. The Website interact with the Execution Client and Billing Servers using the <strong>Http RestFul API</strong> protocol. The Website Service is responsible for user login, function upload, and function management. The Billing Server handles generating bills and processing user operations for recharge and payment. </p>\n<p>The Execution Client is a multi-instance service, allowing for the deployment of numerous instances to achieve horizontal scaling and enhance system performance. The clients will register its information in ZooKeeper. The Website can then retrieve the list of clients from ZooKeeper and subsequently dispatch function calls to these clients.</p>\n<p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>Client</strong> program will run in In these servers. When a task is sent to a Client, it will stand up a Executor to process this task. The communitetion bewteen Client and Executor will been held by <strong>gPRC</strong>. Because, Function files are very big, so worker will use LRU to cache some function instances.</p>\n<p>As for the architecture of this system：</p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/arch.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<h4 id=\"Data-Storage-System\"><a href=\"#Data-Storage-System\" class=\"headerlink\" title=\"Data Storage System\"></a><strong>Data Storage System</strong></h4><p>In Website service and Bill service, we use <strong>MongoDB</strong> to store user’s information. Website will provide user with functions include: add/update a Func, pay for the bill, trace Func status, debug function via webpage.</p>\n<p>For function file storage, we use <strong>HDFS</strong> as the cloud storage system. User’s function files will be uploaded to HDFS and got by Executor.</p>\n<p>For cluster management, we use <strong>ZooKeeper</strong> as the information register system. All clients’ info will be stored in ZooKeeper.</p>\n<h4 id=\"Data-format-between-services\"><a href=\"#Data-format-between-services\" class=\"headerlink\" title=\"Data format between services\"></a><strong>Data format between services</strong></h4><p><strong>User ↔ Website</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Login</td>\n<td>POST</td>\n<td>Form</td>\n<td>Username<br />Password</td>\n<td>Redirect to the home page</td>\n<td>/user</td>\n</tr>\n<tr>\n<td>Register new user</td>\n<td>POST</td>\n<td>Form</td>\n<td>Username<br />Password</td>\n<td>register success: “ok”<br />fail to register: “fail”</td>\n<td>/add/user</td>\n</tr>\n<tr>\n<td>Upload a new function</td>\n<td>POST</td>\n<td>Form</td>\n<td>FunctionName<br />Description<br />Function File</td>\n<td>upload success: “ok”<br />fail to upload: “fail”</td>\n<td>/upload/func</td>\n</tr>\n<tr>\n<td>Update function’s data</td>\n<td>POST</td>\n<td>Json</td>\n<td>New FunctionName<br />New Description</td>\n<td>update success: “ok”<br />fail to update: “fail”</td>\n<td>/update/func</td>\n</tr>\n<tr>\n<td>Get user’s function list</td>\n<td>GET</td>\n<td>url</td>\n<td>User ID</td>\n<td>A json list contains all user’s function</td>\n<td>/funcs</td>\n</tr>\n<tr>\n<td>Get user’s function access history</td>\n<td>GET</td>\n<td>url</td>\n<td>User ID</td>\n<td>A json list contains all user’s function access history</td>\n<td>/user/tasks</td>\n</tr>\n<tr>\n<td>Pay for the bill <br />(Forward to the Bill service)</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Bill ID</td>\n<td>pay success: “ok”<br />fail to pay: “fail”</td>\n<td>/pay/bill</td>\n</tr>\n<tr>\n<td>Top up<br />(Forward to the Bill service)</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Card Number<br />Amount of money</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/user/add/balance</td>\n</tr>\n<tr>\n<td>Update Bill<br />(Forward to the Bill service)</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/update/bills</td>\n</tr>\n<tr>\n<td>Get Bill List<br />(Forward to the Bill service)</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>A json list contains all user’s bill history</td>\n<td>/bills</td>\n</tr>\n<tr>\n<td>Invoke a function</td>\n<td>POST/GET</td>\n<td>Json</td>\n<td>Function ID<br />Task Input</td>\n<td>A json of output and logs</td>\n<td>/func/invoke</td>\n</tr>\n</tbody></table>\n<p><strong>Website ↔ Bill service</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pay for the bill</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Bill ID</td>\n<td>pay success: “ok”<br />fail to pay: “fail”</td>\n<td>/pay/bill</td>\n</tr>\n<tr>\n<td>Top up</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Card Number<br />Amount of money</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/user/add/balance</td>\n</tr>\n<tr>\n<td>Update Bill</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/update/bills</td>\n</tr>\n<tr>\n<td>Get Bill List</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>A json list contains all user’s bill history</td>\n<td>/bills</td>\n</tr>\n</tbody></table>\n<p><strong>Website ↔ Client</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Submit a task</td>\n<td>POST</td>\n<td>Json</td>\n<td>TaskID          <br />FuncName        <br />FuncID          <br />FuncStorageType<br />TaskFuncPath     <br />TaskRunningMode <br />FuncType      <br />TaskCPUCore     <br />TaskMem        <br />TaskDiskSpace   <br />TaskMaxTime     <br />TaskInput</td>\n<td>A JSON include:<br />status,<br />msg<br />logs</td>\n<td>/func/invoke</td>\n</tr>\n</tbody></table>\n<h2 id=\"Database-Design\"><a href=\"#Database-Design\" class=\"headerlink\" title=\"Database Design\"></a><strong>Database Design</strong></h2><p>This FaaS platform’s database(MongoDB) design encompasses multiple tables, intended to manage user information, bills, functions, function execution records, billing units, and account history details. Here’s a detailed explanation of these tables:</p>\n<ol>\n<li><strong>User Info Table</strong>:<ul>\n<li><code>User_ID</code>: A unique identifier for the user, of type Bigint.</li>\n<li><code>User_Email</code>: The email address of the user.</li>\n<li><code>User_Name</code>: The name of the user, which can be up to 20 characters.</li>\n<li><code>User_Password</code>: The password of the user, capped at 20 characters.</li>\n<li><code>User_Balance</code>: The balance in the user’s account, of type Bigint.</li>\n</ul>\n</li>\n<li><strong>Bill Table</strong>:<ul>\n<li><code>Bill_ID</code>: A unique identifier for the bill.</li>\n<li><code>User_ID</code>: A unique identifier for the user, serving as an index.</li>\n<li><code>Bill_Date</code>: The date of the bill.</li>\n<li><code>Bill_Balance</code>: The amount of the bill.</li>\n<li><code>Bill_tasks</code>: A JSON document inclueds all unpaid function running records, supported by MongoDB</li>\n<li><code>Status</code>: The status of the bill, where 0 stands for unpaid and 1 for paid.</li>\n</ul>\n</li>\n<li><strong>Function Table</strong>:<ul>\n<li><code>Func_ID</code>: A unique identifier for the function.</li>\n<li><code>User_ID</code>: A unique identifier for the user.</li>\n<li><code>Func_Path</code>: The path to the function’s code in object storage services like S3.</li>\n<li><code>Func_Explanation</code>: An explanation or description of the function.</li>\n<li><code>Func_Resource</code>: Resources required by the function, in JSON format, e.g., {“CPU”:4,”MEM”:1024m,”DISK”:1024m}.</li>\n</ul>\n</li>\n<li><strong>Func Running Record Table</strong>:<ul>\n<li><code>ID</code>: A unique identifier for the execution record.</li>\n<li><code>Func_ID</code>: A unique identifier for the function.</li>\n<li><code>Running_Time</code>: Execution time, e.g., 100ms.</li>\n<li><code>Status</code>: Status of execution, where 0 stands for failure, 1 for success, and 2 for pending.</li>\n<li><code>Input</code>: Input data in JSON format.</li>\n<li><code>Running_Date</code>: The date of execution.</li>\n<li><code>Payment_Status</code>: Payment status, where 0 stands for unpaid and 1 for paid.</li>\n</ul>\n</li>\n<li><strong>Billing Unit Table</strong>:<ul>\n<li><code>Price</code>: The price, e.g., 0.01$/ms for functions.</li>\n</ul>\n</li>\n<li><strong>Account Info History Table</strong>:<ul>\n<li><code>ID</code>: A unique identifier for the record.</li>\n<li><code>Date</code>: The date.</li>\n<li><code>Type</code>: The action type (add fund or payment).</li>\n<li><code>Account_num</code>: Account number.</li>\n<li><code>Bill_ID</code>: The ID of the bill.</li>\n<li><code>Money</code>: The amount.</li>\n<li><code>User_ID</code>: A unique identifier for the user.</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h4 id=\"User-Info-Table\"><a href=\"#User-Info-Table\" class=\"headerlink\" title=\"- User Info Table:\"></a>- User Info Table:</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>User_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Email</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Name</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Password</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Balance</td>\n<td>Bigint</td>\n<td>1000.0$</td>\n</tr>\n</tbody></table>\n<h4 id=\"Bill-Table\"><a href=\"#Bill-Table\" class=\"headerlink\" title=\"- Bill Table\"></a>- Bill Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Bill_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>String</td>\n<td>Index</td>\n</tr>\n<tr>\n<td>Bill_Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Tasks</td>\n<td>Task</td>\n<td>A JSON document inclueds all unpaid function running records, supported by MongoDB<br />{<br />    {taskID:1,…},<br />    {taskID:2,…}<br />}</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>int</td>\n<td>0 unpay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Function-Table\"><a href=\"#Function-Table\" class=\"headerlink\" title=\"- Function Table\"></a>- Function Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Func_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Args</td>\n<td>String</td>\n<td>{“num1”:int,”num2”,int}</td>\n</tr>\n<tr>\n<td>Func_Path</td>\n<td>String</td>\n<td>path of func’s code in HDFS or S3</td>\n</tr>\n<tr>\n<td>Func_Explanation</td>\n<td>String</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"Func-Running-Record\"><a href=\"#Func-Running-Record\" class=\"headerlink\" title=\"- Func Running Record\"></a>- Func Running Record</h4><table>\n<thead>\n<tr>\n<th>tem</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Running_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Running_Time</td>\n<td>String</td>\n<td>Example: 100ms</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>Int</td>\n<td>0: fail, 1 success, 2 pending</td>\n</tr>\n<tr>\n<td>Input</td>\n<td>String</td>\n<td>A input json</td>\n</tr>\n<tr>\n<td>Running_Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Payment_Status</td>\n<td>Int</td>\n<td>0 unpay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Billing-Unit\"><a href=\"#Billing-Unit\" class=\"headerlink\" title=\"- Billing Unit\"></a>- Billing Unit</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Price</td>\n<td>float</td>\n<td>0.0001$ / ms</td>\n</tr>\n</tbody></table>\n<h4 id=\"Account-Info-History\"><a href=\"#Account-Info-History\" class=\"headerlink\" title=\"- Account Info History\"></a>- Account Info History</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Type</td>\n<td>Int</td>\n<td>Payment or ADD</td>\n</tr>\n<tr>\n<td>Account_num</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_ID</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Money</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"ER-Graph\"><a href=\"#ER-Graph\" class=\"headerlink\" title=\"- ER Graph\"></a>- ER Graph</h4><img src=\"/Users/lhz/Desktop/SW/SW-final/ER.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<h2 id=\"Handbook\"><a href=\"#Handbook\" class=\"headerlink\" title=\"Handbook\"></a><strong>Handbook</strong></h2><p>Website &amp; Bill Service Code: <a href=\"https://github.com/muchengl/tamu-sw-faas\">https://github.com/muchengl/tamu-sw-faas</a></p>\n<p>Client Code: <a href=\"https://github.com/muchengl/Color-FaaS-Core\">https://github.com/muchengl/Color-FaaS-Core</a></p>\n<p>Docker Environment: <a href=\"https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p>\n<h4 id=\"Environment\"><a href=\"#Environment\" class=\"headerlink\" title=\"Environment\"></a><strong>Environment</strong></h4><p>This service includes a Website, Bill service, and Client. Both the Website and Bill service rely on a Java environment (Java 1.8+), while the Client is developed using Golang and requires Golang 1.21. Website and Bill service use Maven to manager all dependent environment. Client can use Golang’s mod to get all dependents.</p>\n<h4 id=\"Start-Website-and-Bill-Service\"><a href=\"#Start-Website-and-Bill-Service\" class=\"headerlink\" title=\"Start Website and Bill Service\"></a><strong>Start Website and Bill Service</strong></h4><p>Step 01: Download/Clone all code of project.</p>\n<p>Step 02: Open the project with IDEA.</p>\n<p>Step 03: Open <strong>pom.xml</strong> in project and init maven for both main-module and bill-module.</p>\n<p>Step 04: Run project in IDEA. Website is in main module <strong>com.tamu.faas.FaasApplication</strong>. Bill is in bill module <strong>com.tamu.faas.bill.BillApplication</strong></p>\n<p>Step 05: com.tamu.faas.FaasApplication will use port 8080 and com.tamu.faas.bill.BillApplication will use 8081.</p>\n<h4 id=\"Start-Client-Cluster\"><a href=\"#Start-Client-Cluster\" class=\"headerlink\" title=\"Start Client Cluster\"></a><strong>Start Client Cluster</strong></h4><p>Client uses makefile to manager the project, you can use the follows commands to init and build the project:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ cd [client project&#x27;s dir in your computer]</span><br><span class=\"line\">➜ make mod</span><br><span class=\"line\">---&gt; make mod &lt;---</span><br><span class=\"line\">go mod tidy</span><br><span class=\"line\">go mod download</span><br><span class=\"line\"></span><br><span class=\"line\">➜ make build</span><br><span class=\"line\">---&gt; make build &lt;---</span><br><span class=\"line\">./build.sh</span><br><span class=\"line\">  ---&gt; make clean &lt;---</span><br><span class=\"line\">  ---&gt; init dir &lt;---</span><br><span class=\"line\">  ---&gt; init files &lt;---</span><br><span class=\"line\">  ---&gt; make server &lt;---</span><br><span class=\"line\">  ---&gt; make client &lt;---</span><br><span class=\"line\">  ---&gt; make executor &lt;---</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>And than, use the follows commands to start the client:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ ./output/startup.sh --client</span><br></pre></td></tr></table></figure>\n\n<p>If you see the following output, the client has started successfully (<strong>only one client</strong>, if you want to start many clients to form a cluster, you need to run muit-clients in many Containers/VMs):</p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/run-core.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<h4 id=\"Start-Zookeeper-and-HDFS\"><a href=\"#Start-Zookeeper-and-HDFS\" class=\"headerlink\" title=\"Start Zookeeper and HDFS\"></a><strong>Start Zookeeper and HDFS</strong></h4><p>Start by docker-compose in project dir (May not work perfectly, may require manual installation) :</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ cd [docker-compose&#x27;s dir in your computer]</span><br><span class=\"line\">➜ docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Test-the-project\"><a href=\"#Test-the-project\" class=\"headerlink\" title=\"Test the project\"></a><strong>Test the project</strong></h4><p>Test the project by URL in your browser: <a href=\"http://localhost:8080/login\">http://localhost:8080/login</a></p>\n<p>HDFS URL in browser: <a href=\"http://localhost:9870/\">http://localhost:9870/</a></p>\n<p>Test desktop tool:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ pip install prettytable requests</span><br><span class=\"line\">➜ python3 client.py</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Color-FaaS-Doc-Final\"><a href=\"#Color-FaaS-Doc-Final\" class=\"headerlink\" title=\"Color FaaS Doc Final\"></a>Color FaaS Doc Final</h1><p>Designed By Hanzhong Liu, Xi Shi</p>\n<p>All Videos: <a href=\"https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9\">https://www.youtube.com/playlist?list=PLARUmtazqWjWrdYpJCU77CL7i0meZPqK9</a></p>\n<p>Website &amp; Bill Service: <a href=\"https://github.com/muchengl/tamu-sw-faas\">https://github.com/muchengl/tamu-sw-faas</a></p>\n<p>Client: <a href=\"https://github.com/muchengl/Color-FaaS-Core\">https://github.com/muchengl/Color-FaaS-Core</a></p>\n<p>Function SDK: <a href=\"https://github.com/muchengl/Color-FaaS-SDK\">https://github.com/muchengl/Color-FaaS-SDK</a></p>\n<p>Environment: <a href=\"https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p>\n<p><strong>Catalog</strong></p>\n<p>[toc]</p>\n<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a><strong>Introduction</strong></h2><p>In this project, we have undertaken a significant redesign of our existing system, transitioning to a microservices architecture and incorporating multi-modal client interfaces. This iteration represents an evolution of our system, focusing on enhanced scalability, modularity, and user experience.</p>\n<p>Our submission for this iteration includes:</p>\n<ol>\n<li><strong>Requirements:</strong> Detailed descriptions and UI sketches of all use cases, incorporating standard format narratives and sequence diagrams. Video recordings demonstrating the system in action for each defined use case, highlighting functionality and user interaction.</li>\n<li><strong>Database Design:</strong> We redesigned our DB based on MongoDB. Comprehensive outlines of data entities, relationships, and an entity-relationship diagram, accompanied by sample data.</li>\n<li><strong>Architectural Design:</strong> In-depth descriptions of client and server components, communication protocols, data formats, and an overarching system architecture diagram.</li>\n<li><strong>Runnable System:</strong> A fully functional system with a personalized and polished UI.</li>\n<li><strong>Installation and Usage Manual:</strong> A detailed Handbook covering installation procedures, usage instructions, and information on necessary libraries and frameworks.</li>\n</ol>\n<h2 id=\"User-cases-and-UI-design\"><a href=\"#User-cases-and-UI-design\" class=\"headerlink\" title=\"User cases and UI design\"></a><strong>User cases and UI design</strong></h2><h4 id=\"User-case-Register-amp-Login\"><a href=\"#User-case-Register-amp-Login\" class=\"headerlink\" title=\"**User case **: Register &amp; Login\"></a>**User case **: Register &amp; Login</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Register a new account and login to the platform</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1.User visits the website landing page<br />2.System returns the html code of the page<br />3.User clicks “New User”<br />4.System display the form for registering a new user<br />5.User fill in the new user information and submit<br />6.System writes the new user information to the database. And jump back to the landing page<br />7.User enters the new user information and clicks Login<br />8.System checks whether the user exists. If yes, go to the home page</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>VIdeo: <a href=\"https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz\">https://youtu.be/bLijflOhaDs?si=2M6rCZVapOltcmfz</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/Register.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/login.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Development-Upload-function\"><a href=\"#User-case-Development-Upload-function\" class=\"headerlink\" title=\"**User case **: Development/Upload function\"></a>**User case **: Development/Upload function</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>A User want to deploy a application in cloud environment</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User develop a func in his/her computer by a SDK and upload this function from the webpage<br />2. System saves the function file (in HDFS), and the function file is successfully created <br />3. User views the corresponding information in the function list</td>\n</tr>\n</tbody></table>\n<p>UI of this User case</p>\n<p>Video: <a href=\"https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj\">https://youtu.be/zrBuOFd2jsk?si=BBQKRtWMwfU-F9Aj</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/function.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Test-Function-via-web-page\"><a href=\"#User-case-Test-Function-via-web-page\" class=\"headerlink\" title=\"**User case **: Test Function via web page\"></a>**User case **: Test Function via web page</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test the function from platform’s web page</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the function test page<br />2. System return the web page to user<br />3. User test this function from web page.<br />4. System calls the function and returns the result and log</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8\">https://youtu.be/nybjcanzMko?si=rx2toB0qJ9R3zZx8</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/test02.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<h4 id=\"User-case-Test-Functions-via-Public-URL\"><a href=\"#User-case-Test-Functions-via-Public-URL\" class=\"headerlink\" title=\"**User case **: Test Functions via Public URL\"></a>**User case **: Test Functions via Public URL</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>User</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test the function from platform’s web page</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the function test page<br />2. System return the web page to user<br />3. User copy the “public url” and test it in Browser<br />4. System calls the function and returns the result and log as JSON. Show it in Browser.</td>\n</tr>\n</tbody></table>\n<p>Video: <a href=\"https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u\">https://youtu.be/2_BJYx0JUBU?si=xXDeK_aF2hs8fj2u</a></p>\n<h4 id=\"User-case-Test-Functions-in-the-Desktop-Tool\"><a href=\"#User-case-Test-Functions-in-the-Desktop-Tool\" class=\"headerlink\" title=\"**User case **: Test Functions in the Desktop Tool\"></a>**User case **: Test Functions in the Desktop Tool</h4><p>There are two options to implement this Desktop tool, one is to write an <strong>interactive command line</strong>, and the other is to implement the program with UI. Since my project is a developer-oriented tool, I decided to implement an interactive command line program that more closely resembles a real-world product (like these tools in linux).</p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Test functions in desktop tool</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User start the Desktop tool and login<br />2. System verifies that user information is correct<br />3. User enter list, history or test command to use different functions<br />4.System process the command and return the result<br />5.User see the output in screen.</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i\">https://youtu.be/Uq23_F1yW-k?si=FnUfgjdBmk0kwb4i</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool01.png\" alt=\"图片替换文本\" width=\"300\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool02.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tool03.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n<h4 id=\"User-case-Manage-tasks\"><a href=\"#User-case-Manage-tasks\" class=\"headerlink\" title=\"**User case **: Manage tasks\"></a>**User case **: Manage tasks</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Trace  the running status of a Func</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter Task manage page<br />2. System return the manage page<br />3. User look at the running status, output and time of the function</td>\n</tr>\n</tbody></table>\n<p>Video: <a href=\"https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE\">https://youtu.be/dJ60XcTPhV0?si=MnkhJ3wmDE60XXmE</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/tasks.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<h4 id=\"User-case-Top-up-user’s-account\"><a href=\"#User-case-Top-up-user’s-account\" class=\"headerlink\" title=\"**User case **: Top up user’s account\"></a>**User case **: Top up user’s account</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Top up</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click “Recharge” button<br />4. System show the recharge form<br />5.User type info and click the button “Submit”<br />6.System add money to user’s account</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh\">https://youtu.be/bL5l1LQHHrw?si=pWOBahXJLAHMEsHh</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/recarge.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<h4 id=\"User-case-Pay-the-bill\"><a href=\"#User-case-Pay-the-bill\" class=\"headerlink\" title=\"**User case **: Pay the bill\"></a>**User case **: Pay the bill</h4><table>\n<thead>\n<tr>\n<th>Items</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Actor</td>\n<td>Developer</td>\n</tr>\n<tr>\n<td>Goal</td>\n<td>Pay the bill</td>\n</tr>\n<tr>\n<td>Path</td>\n<td>1. User enter the account info page<br />2. System return the web page to user<br />3. User click “Update Bill” button<br />4. System queries all unpaid records and generates a bill. Platform will show the bill in web page<br />5. User click “Pay” button<br />6. System deducts the fee and completes the payment</td>\n</tr>\n</tbody></table>\n<p>UI of this User case:</p>\n<p>Video: <a href=\"https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i\">https://youtu.be/XO2TSqXJF0Y?si=Ozx1OBktopRhTn0i</a></p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/userdata.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n\n\n<h2 id=\"Architectural-design\"><a href=\"#Architectural-design\" class=\"headerlink\" title=\"Architectural design\"></a><strong>Architectural design</strong></h2><h4 id=\"High-Level-Design\"><a href=\"#High-Level-Design\" class=\"headerlink\" title=\"High Level Design\"></a><strong>High Level Design</strong></h4><p>This system comprises three microservices: <strong>Website Service</strong>, <strong>Billing Service</strong>, and <strong>Execution Client</strong>. The Website interact with the Execution Client and Billing Servers using the <strong>Http RestFul API</strong> protocol. The Website Service is responsible for user login, function upload, and function management. The Billing Server handles generating bills and processing user operations for recharge and payment. </p>\n<p>The Execution Client is a multi-instance service, allowing for the deployment of numerous instances to achieve horizontal scaling and enhance system performance. The clients will register its information in ZooKeeper. The Website can then retrieve the list of clients from ZooKeeper and subsequently dispatch function calls to these clients.</p>\n<p>Core cluster may contains many servers, so it can process many tasks in the same time. A <strong>Client</strong> program will run in In these servers. When a task is sent to a Client, it will stand up a Executor to process this task. The communitetion bewteen Client and Executor will been held by <strong>gPRC</strong>. Because, Function files are very big, so worker will use LRU to cache some function instances.</p>\n<p>As for the architecture of this system：</p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/arch.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n<h4 id=\"Data-Storage-System\"><a href=\"#Data-Storage-System\" class=\"headerlink\" title=\"Data Storage System\"></a><strong>Data Storage System</strong></h4><p>In Website service and Bill service, we use <strong>MongoDB</strong> to store user’s information. Website will provide user with functions include: add/update a Func, pay for the bill, trace Func status, debug function via webpage.</p>\n<p>For function file storage, we use <strong>HDFS</strong> as the cloud storage system. User’s function files will be uploaded to HDFS and got by Executor.</p>\n<p>For cluster management, we use <strong>ZooKeeper</strong> as the information register system. All clients’ info will be stored in ZooKeeper.</p>\n<h4 id=\"Data-format-between-services\"><a href=\"#Data-format-between-services\" class=\"headerlink\" title=\"Data format between services\"></a><strong>Data format between services</strong></h4><p><strong>User ↔ Website</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Login</td>\n<td>POST</td>\n<td>Form</td>\n<td>Username<br />Password</td>\n<td>Redirect to the home page</td>\n<td>/user</td>\n</tr>\n<tr>\n<td>Register new user</td>\n<td>POST</td>\n<td>Form</td>\n<td>Username<br />Password</td>\n<td>register success: “ok”<br />fail to register: “fail”</td>\n<td>/add/user</td>\n</tr>\n<tr>\n<td>Upload a new function</td>\n<td>POST</td>\n<td>Form</td>\n<td>FunctionName<br />Description<br />Function File</td>\n<td>upload success: “ok”<br />fail to upload: “fail”</td>\n<td>/upload/func</td>\n</tr>\n<tr>\n<td>Update function’s data</td>\n<td>POST</td>\n<td>Json</td>\n<td>New FunctionName<br />New Description</td>\n<td>update success: “ok”<br />fail to update: “fail”</td>\n<td>/update/func</td>\n</tr>\n<tr>\n<td>Get user’s function list</td>\n<td>GET</td>\n<td>url</td>\n<td>User ID</td>\n<td>A json list contains all user’s function</td>\n<td>/funcs</td>\n</tr>\n<tr>\n<td>Get user’s function access history</td>\n<td>GET</td>\n<td>url</td>\n<td>User ID</td>\n<td>A json list contains all user’s function access history</td>\n<td>/user/tasks</td>\n</tr>\n<tr>\n<td>Pay for the bill <br />(Forward to the Bill service)</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Bill ID</td>\n<td>pay success: “ok”<br />fail to pay: “fail”</td>\n<td>/pay/bill</td>\n</tr>\n<tr>\n<td>Top up<br />(Forward to the Bill service)</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Card Number<br />Amount of money</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/user/add/balance</td>\n</tr>\n<tr>\n<td>Update Bill<br />(Forward to the Bill service)</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/update/bills</td>\n</tr>\n<tr>\n<td>Get Bill List<br />(Forward to the Bill service)</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>A json list contains all user’s bill history</td>\n<td>/bills</td>\n</tr>\n<tr>\n<td>Invoke a function</td>\n<td>POST/GET</td>\n<td>Json</td>\n<td>Function ID<br />Task Input</td>\n<td>A json of output and logs</td>\n<td>/func/invoke</td>\n</tr>\n</tbody></table>\n<p><strong>Website ↔ Bill service</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pay for the bill</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Bill ID</td>\n<td>pay success: “ok”<br />fail to pay: “fail”</td>\n<td>/pay/bill</td>\n</tr>\n<tr>\n<td>Top up</td>\n<td>POST</td>\n<td>Json</td>\n<td>User ID<br />Card Number<br />Amount of money</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/user/add/balance</td>\n</tr>\n<tr>\n<td>Update Bill</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>success: “ok”<br />fail: “fail”</td>\n<td>/update/bills</td>\n</tr>\n<tr>\n<td>Get Bill List</td>\n<td>GET</td>\n<td>Json</td>\n<td>User ID</td>\n<td>A json list contains all user’s bill history</td>\n<td>/bills</td>\n</tr>\n</tbody></table>\n<p><strong>Website ↔ Client</strong></p>\n<table>\n<thead>\n<tr>\n<th>Request</th>\n<th>Protocol</th>\n<th>Data Type</th>\n<th>Request Data</th>\n<th>Response Data</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Submit a task</td>\n<td>POST</td>\n<td>Json</td>\n<td>TaskID          <br />FuncName        <br />FuncID          <br />FuncStorageType<br />TaskFuncPath     <br />TaskRunningMode <br />FuncType      <br />TaskCPUCore     <br />TaskMem        <br />TaskDiskSpace   <br />TaskMaxTime     <br />TaskInput</td>\n<td>A JSON include:<br />status,<br />msg<br />logs</td>\n<td>/func/invoke</td>\n</tr>\n</tbody></table>\n<h2 id=\"Database-Design\"><a href=\"#Database-Design\" class=\"headerlink\" title=\"Database Design\"></a><strong>Database Design</strong></h2><p>This FaaS platform’s database(MongoDB) design encompasses multiple tables, intended to manage user information, bills, functions, function execution records, billing units, and account history details. Here’s a detailed explanation of these tables:</p>\n<ol>\n<li><strong>User Info Table</strong>:<ul>\n<li><code>User_ID</code>: A unique identifier for the user, of type Bigint.</li>\n<li><code>User_Email</code>: The email address of the user.</li>\n<li><code>User_Name</code>: The name of the user, which can be up to 20 characters.</li>\n<li><code>User_Password</code>: The password of the user, capped at 20 characters.</li>\n<li><code>User_Balance</code>: The balance in the user’s account, of type Bigint.</li>\n</ul>\n</li>\n<li><strong>Bill Table</strong>:<ul>\n<li><code>Bill_ID</code>: A unique identifier for the bill.</li>\n<li><code>User_ID</code>: A unique identifier for the user, serving as an index.</li>\n<li><code>Bill_Date</code>: The date of the bill.</li>\n<li><code>Bill_Balance</code>: The amount of the bill.</li>\n<li><code>Bill_tasks</code>: A JSON document inclueds all unpaid function running records, supported by MongoDB</li>\n<li><code>Status</code>: The status of the bill, where 0 stands for unpaid and 1 for paid.</li>\n</ul>\n</li>\n<li><strong>Function Table</strong>:<ul>\n<li><code>Func_ID</code>: A unique identifier for the function.</li>\n<li><code>User_ID</code>: A unique identifier for the user.</li>\n<li><code>Func_Path</code>: The path to the function’s code in object storage services like S3.</li>\n<li><code>Func_Explanation</code>: An explanation or description of the function.</li>\n<li><code>Func_Resource</code>: Resources required by the function, in JSON format, e.g., {“CPU”:4,”MEM”:1024m,”DISK”:1024m}.</li>\n</ul>\n</li>\n<li><strong>Func Running Record Table</strong>:<ul>\n<li><code>ID</code>: A unique identifier for the execution record.</li>\n<li><code>Func_ID</code>: A unique identifier for the function.</li>\n<li><code>Running_Time</code>: Execution time, e.g., 100ms.</li>\n<li><code>Status</code>: Status of execution, where 0 stands for failure, 1 for success, and 2 for pending.</li>\n<li><code>Input</code>: Input data in JSON format.</li>\n<li><code>Running_Date</code>: The date of execution.</li>\n<li><code>Payment_Status</code>: Payment status, where 0 stands for unpaid and 1 for paid.</li>\n</ul>\n</li>\n<li><strong>Billing Unit Table</strong>:<ul>\n<li><code>Price</code>: The price, e.g., 0.01$/ms for functions.</li>\n</ul>\n</li>\n<li><strong>Account Info History Table</strong>:<ul>\n<li><code>ID</code>: A unique identifier for the record.</li>\n<li><code>Date</code>: The date.</li>\n<li><code>Type</code>: The action type (add fund or payment).</li>\n<li><code>Account_num</code>: Account number.</li>\n<li><code>Bill_ID</code>: The ID of the bill.</li>\n<li><code>Money</code>: The amount.</li>\n<li><code>User_ID</code>: A unique identifier for the user.</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h4 id=\"User-Info-Table\"><a href=\"#User-Info-Table\" class=\"headerlink\" title=\"- User Info Table:\"></a>- User Info Table:</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>User_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Email</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Name</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Password</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_Balance</td>\n<td>Bigint</td>\n<td>1000.0$</td>\n</tr>\n</tbody></table>\n<h4 id=\"Bill-Table\"><a href=\"#Bill-Table\" class=\"headerlink\" title=\"- Bill Table\"></a>- Bill Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Bill_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>String</td>\n<td>Index</td>\n</tr>\n<tr>\n<td>Bill_Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Balance</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_Tasks</td>\n<td>Task</td>\n<td>A JSON document inclueds all unpaid function running records, supported by MongoDB<br />{<br />    {taskID:1,…},<br />    {taskID:2,…}<br />}</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>int</td>\n<td>0 unpay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Function-Table\"><a href=\"#Function-Table\" class=\"headerlink\" title=\"- Function Table\"></a>- Function Table</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Func_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_Args</td>\n<td>String</td>\n<td>{“num1”:int,”num2”,int}</td>\n</tr>\n<tr>\n<td>Func_Path</td>\n<td>String</td>\n<td>path of func’s code in HDFS or S3</td>\n</tr>\n<tr>\n<td>Func_Explanation</td>\n<td>String</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"Func-Running-Record\"><a href=\"#Func-Running-Record\" class=\"headerlink\" title=\"- Func Running Record\"></a>- Func Running Record</h4><table>\n<thead>\n<tr>\n<th>tem</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Running_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Func_ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Running_Time</td>\n<td>String</td>\n<td>Example: 100ms</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>Int</td>\n<td>0: fail, 1 success, 2 pending</td>\n</tr>\n<tr>\n<td>Input</td>\n<td>String</td>\n<td>A input json</td>\n</tr>\n<tr>\n<td>Running_Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Payment_Status</td>\n<td>Int</td>\n<td>0 unpay, 1 paid</td>\n</tr>\n</tbody></table>\n<h4 id=\"Billing-Unit\"><a href=\"#Billing-Unit\" class=\"headerlink\" title=\"- Billing Unit\"></a>- Billing Unit</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>Bitint</td>\n<td></td>\n</tr>\n<tr>\n<td>Price</td>\n<td>float</td>\n<td>0.0001$ / ms</td>\n</tr>\n</tbody></table>\n<h4 id=\"Account-Info-History\"><a href=\"#Account-Info-History\" class=\"headerlink\" title=\"- Account Info History\"></a>- Account Info History</h4><table>\n<thead>\n<tr>\n<th>Item</th>\n<th>Type</th>\n<th>Explanation/Sample Data</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Date</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Type</td>\n<td>Int</td>\n<td>Payment or ADD</td>\n</tr>\n<tr>\n<td>Account_num</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>Bill_ID</td>\n<td>Int</td>\n<td></td>\n</tr>\n<tr>\n<td>Money</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n<tr>\n<td>User_ID</td>\n<td>Bigint</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"ER-Graph\"><a href=\"#ER-Graph\" class=\"headerlink\" title=\"- ER Graph\"></a>- ER Graph</h4><img src=\"/Users/lhz/Desktop/SW/SW-final/ER.png\" alt=\"图片替换文本\" width=\"600\" align=\"bottom\" />\n\n<h2 id=\"Handbook\"><a href=\"#Handbook\" class=\"headerlink\" title=\"Handbook\"></a><strong>Handbook</strong></h2><p>Website &amp; Bill Service Code: <a href=\"https://github.com/muchengl/tamu-sw-faas\">https://github.com/muchengl/tamu-sw-faas</a></p>\n<p>Client Code: <a href=\"https://github.com/muchengl/Color-FaaS-Core\">https://github.com/muchengl/Color-FaaS-Core</a></p>\n<p>Docker Environment: <a href=\"https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link\">https://drive.google.com/file/d/1UE5ZxRM66E4el5G-MV9gjSpM_WBBAFvZ/view?usp=drive_link</a></p>\n<h4 id=\"Environment\"><a href=\"#Environment\" class=\"headerlink\" title=\"Environment\"></a><strong>Environment</strong></h4><p>This service includes a Website, Bill service, and Client. Both the Website and Bill service rely on a Java environment (Java 1.8+), while the Client is developed using Golang and requires Golang 1.21. Website and Bill service use Maven to manager all dependent environment. Client can use Golang’s mod to get all dependents.</p>\n<h4 id=\"Start-Website-and-Bill-Service\"><a href=\"#Start-Website-and-Bill-Service\" class=\"headerlink\" title=\"Start Website and Bill Service\"></a><strong>Start Website and Bill Service</strong></h4><p>Step 01: Download/Clone all code of project.</p>\n<p>Step 02: Open the project with IDEA.</p>\n<p>Step 03: Open <strong>pom.xml</strong> in project and init maven for both main-module and bill-module.</p>\n<p>Step 04: Run project in IDEA. Website is in main module <strong>com.tamu.faas.FaasApplication</strong>. Bill is in bill module <strong>com.tamu.faas.bill.BillApplication</strong></p>\n<p>Step 05: com.tamu.faas.FaasApplication will use port 8080 and com.tamu.faas.bill.BillApplication will use 8081.</p>\n<h4 id=\"Start-Client-Cluster\"><a href=\"#Start-Client-Cluster\" class=\"headerlink\" title=\"Start Client Cluster\"></a><strong>Start Client Cluster</strong></h4><p>Client uses makefile to manager the project, you can use the follows commands to init and build the project:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ cd [client project&#x27;s dir in your computer]</span><br><span class=\"line\">➜ make mod</span><br><span class=\"line\">---&gt; make mod &lt;---</span><br><span class=\"line\">go mod tidy</span><br><span class=\"line\">go mod download</span><br><span class=\"line\"></span><br><span class=\"line\">➜ make build</span><br><span class=\"line\">---&gt; make build &lt;---</span><br><span class=\"line\">./build.sh</span><br><span class=\"line\">  ---&gt; make clean &lt;---</span><br><span class=\"line\">  ---&gt; init dir &lt;---</span><br><span class=\"line\">  ---&gt; init files &lt;---</span><br><span class=\"line\">  ---&gt; make server &lt;---</span><br><span class=\"line\">  ---&gt; make client &lt;---</span><br><span class=\"line\">  ---&gt; make executor &lt;---</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>And than, use the follows commands to start the client:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ ./output/startup.sh --client</span><br></pre></td></tr></table></figure>\n\n<p>If you see the following output, the client has started successfully (<strong>only one client</strong>, if you want to start many clients to form a cluster, you need to run muit-clients in many Containers/VMs):</p>\n<img src=\"/Users/lhz/Desktop/SW/SW-final/run-core.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<h4 id=\"Start-Zookeeper-and-HDFS\"><a href=\"#Start-Zookeeper-and-HDFS\" class=\"headerlink\" title=\"Start Zookeeper and HDFS\"></a><strong>Start Zookeeper and HDFS</strong></h4><p>Start by docker-compose in project dir (May not work perfectly, may require manual installation) :</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ cd [docker-compose&#x27;s dir in your computer]</span><br><span class=\"line\">➜ docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Test-the-project\"><a href=\"#Test-the-project\" class=\"headerlink\" title=\"Test the project\"></a><strong>Test the project</strong></h4><p>Test the project by URL in your browser: <a href=\"http://localhost:8080/login\">http://localhost:8080/login</a></p>\n<p>HDFS URL in browser: <a href=\"http://localhost:9870/\">http://localhost:9870/</a></p>\n<p>Test desktop tool:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ pip install prettytable requests</span><br><span class=\"line\">➜ python3 client.py</span><br></pre></td></tr></table></figure>\n\n"},{"title":"2023 Self Review","date":"2023-12-26T18:47:54.000Z","_content":"\n2023即将结束，总结下这一年的收获～\n\n（年末了，正在度过极其无聊的寒假，没事随笔写一写）\n\n[Link](https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06)\n\nhttps://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06","source":"_posts/2023-Self-Review.md","raw":"---\ntitle: 2023 Self Review\ndate: 2023-12-26 12:47:54\ntags:\n---\n\n2023即将结束，总结下这一年的收获～\n\n（年末了，正在度过极其无聊的寒假，没事随笔写一写）\n\n[Link](https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06)\n\nhttps://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06","slug":"2023-Self-Review","published":1,"updated":"2023-12-30T19:03:16.720Z","_id":"clqmq3qvk0000fpok01xt7zv5","comments":1,"layout":"post","photos":[],"link":"","content":"<p>2023即将结束，总结下这一年的收获～</p>\n<p>（年末了，正在度过极其无聊的寒假，没事随笔写一写）</p>\n<p><a href=\"https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06\">Link</a></p>\n<p><a href=\"https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06\">https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>2023即将结束，总结下这一年的收获～</p>\n<p>（年末了，正在度过极其无聊的寒假，没事随笔写一写）</p>\n<p><a href=\"https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06\">Link</a></p>\n<p><a href=\"https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06\">https://carpal-cornflower-8c1.notion.site/2023-Self-Review-c53c8ebfbb294dcc8af60b1631ec5d06</a></p>\n"},{"title":"CSCE611 OS Env Prepare (Macbook M-chip)","date":"2024-01-24T02:56:35.000Z","_content":"\nThis assumes that you have at the very least set up developer tools and [Homebrew](https://brew.sh) on your machine.\n\n## Step01, GCC Install\n\nIn the class, we need to build a unix-like kernel in X86 arch. Because MacBook with M2 chip is arm arch. So, we can't use the original gcc in homebrew. Fortunate, there is a **x86_64-elf-gcc** in home-brew repo:\n```\n➜  ~ brew search gcc\n==> Formulae\naarch64-elf-gcc ✔                                            libgccjit\narm-none-eabi-gcc                                            nativeos/i386-elf-toolchain/i386-elf-gcc\ngcc                                                          nativeos/i386-elf-toolchain/i386-elf-gcc@11.1\ngcc@10                                                       nativeos/i386-elf-toolchain/i386-elf-gcc@11.2\ngcc@11 ✔                                                     riscv64-elf-gcc\ngcc@12 ✔                                                     x86_64-elf-gcc ✔\ngcc@5                                                        ghc\ngcc@6                                                        grc\ngcc@7                                                        scc\ngcc@8                                                        tcc\ngcc@9                                                        ncc\ni686-elf-gcc\n```\n\nUse **brew search gcc** in terminal, you can find \"x86_64-elf-gcc\". So, use \"brew install x86_64-elf-gcc\" to install it. Now, you can use \"aarch64-elf-gcc\" to compail the kernel.\n\nAll tool intalled by gcc will be store in this path: **/opt/homebrew/Cellar/**. So you should heve this \"/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld\".\n\n## Step2, Tools Install\n\n- Install wget `brew install wget`\n- Install nasm: `brew install nasm`\n- Install qemu and bochs: `brew install qemu bochs`\n\n","source":"_posts/CSCE611-MP1.md","raw":"---\ntitle: CSCE611 OS Env Prepare (Macbook M-chip)\ndate: 2024-01-23 20:56:35\ntags:\n---\n\nThis assumes that you have at the very least set up developer tools and [Homebrew](https://brew.sh) on your machine.\n\n## Step01, GCC Install\n\nIn the class, we need to build a unix-like kernel in X86 arch. Because MacBook with M2 chip is arm arch. So, we can't use the original gcc in homebrew. Fortunate, there is a **x86_64-elf-gcc** in home-brew repo:\n```\n➜  ~ brew search gcc\n==> Formulae\naarch64-elf-gcc ✔                                            libgccjit\narm-none-eabi-gcc                                            nativeos/i386-elf-toolchain/i386-elf-gcc\ngcc                                                          nativeos/i386-elf-toolchain/i386-elf-gcc@11.1\ngcc@10                                                       nativeos/i386-elf-toolchain/i386-elf-gcc@11.2\ngcc@11 ✔                                                     riscv64-elf-gcc\ngcc@12 ✔                                                     x86_64-elf-gcc ✔\ngcc@5                                                        ghc\ngcc@6                                                        grc\ngcc@7                                                        scc\ngcc@8                                                        tcc\ngcc@9                                                        ncc\ni686-elf-gcc\n```\n\nUse **brew search gcc** in terminal, you can find \"x86_64-elf-gcc\". So, use \"brew install x86_64-elf-gcc\" to install it. Now, you can use \"aarch64-elf-gcc\" to compail the kernel.\n\nAll tool intalled by gcc will be store in this path: **/opt/homebrew/Cellar/**. So you should heve this \"/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld\".\n\n## Step2, Tools Install\n\n- Install wget `brew install wget`\n- Install nasm: `brew install nasm`\n- Install qemu and bochs: `brew install qemu bochs`\n\n","slug":"CSCE611-MP1","published":1,"updated":"2024-01-25T20:37:09.290Z","_id":"clrtlyppq00001zhg0uwj50ij","comments":1,"layout":"post","photos":[],"link":"","content":"<p>This assumes that you have at the very least set up developer tools and <a href=\"https://brew.sh/\">Homebrew</a> on your machine.</p>\n<h2 id=\"Step01-GCC-Install\"><a href=\"#Step01-GCC-Install\" class=\"headerlink\" title=\"Step01, GCC Install\"></a>Step01, GCC Install</h2><p>In the class, we need to build a unix-like kernel in X86 arch. Because MacBook with M2 chip is arm arch. So, we can’t use the original gcc in homebrew. Fortunate, there is a <strong>x86_64-elf-gcc</strong> in home-brew repo:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ brew search gcc</span><br><span class=\"line\">==&gt; Formulae</span><br><span class=\"line\">aarch64-elf-gcc ✔                                            libgccjit</span><br><span class=\"line\">arm-none-eabi-gcc                                            nativeos/i386-elf-toolchain/i386-elf-gcc</span><br><span class=\"line\">gcc                                                          nativeos/i386-elf-toolchain/i386-elf-gcc@11.1</span><br><span class=\"line\">gcc@10                                                       nativeos/i386-elf-toolchain/i386-elf-gcc@11.2</span><br><span class=\"line\">gcc@11 ✔                                                     riscv64-elf-gcc</span><br><span class=\"line\">gcc@12 ✔                                                     x86_64-elf-gcc ✔</span><br><span class=\"line\">gcc@5                                                        ghc</span><br><span class=\"line\">gcc@6                                                        grc</span><br><span class=\"line\">gcc@7                                                        scc</span><br><span class=\"line\">gcc@8                                                        tcc</span><br><span class=\"line\">gcc@9                                                        ncc</span><br><span class=\"line\">i686-elf-gcc</span><br></pre></td></tr></table></figure>\n\n<p>Use <strong>brew search gcc</strong> in terminal, you can find “x86_64-elf-gcc”. So, use “brew install x86_64-elf-gcc” to install it. Now, you can use “aarch64-elf-gcc” to compail the kernel.</p>\n<p>All tool intalled by gcc will be store in this path: <strong>/opt/homebrew/Cellar/</strong>. So you should heve this “/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld”.</p>\n<h2 id=\"Step2-Tools-Install\"><a href=\"#Step2-Tools-Install\" class=\"headerlink\" title=\"Step2, Tools Install\"></a>Step2, Tools Install</h2><ul>\n<li>Install wget <code>brew install wget</code></li>\n<li>Install nasm: <code>brew install nasm</code></li>\n<li>Install qemu and bochs: <code>brew install qemu bochs</code></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>This assumes that you have at the very least set up developer tools and <a href=\"https://brew.sh/\">Homebrew</a> on your machine.</p>\n<h2 id=\"Step01-GCC-Install\"><a href=\"#Step01-GCC-Install\" class=\"headerlink\" title=\"Step01, GCC Install\"></a>Step01, GCC Install</h2><p>In the class, we need to build a unix-like kernel in X86 arch. Because MacBook with M2 chip is arm arch. So, we can’t use the original gcc in homebrew. Fortunate, there is a <strong>x86_64-elf-gcc</strong> in home-brew repo:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ brew search gcc</span><br><span class=\"line\">==&gt; Formulae</span><br><span class=\"line\">aarch64-elf-gcc ✔                                            libgccjit</span><br><span class=\"line\">arm-none-eabi-gcc                                            nativeos/i386-elf-toolchain/i386-elf-gcc</span><br><span class=\"line\">gcc                                                          nativeos/i386-elf-toolchain/i386-elf-gcc@11.1</span><br><span class=\"line\">gcc@10                                                       nativeos/i386-elf-toolchain/i386-elf-gcc@11.2</span><br><span class=\"line\">gcc@11 ✔                                                     riscv64-elf-gcc</span><br><span class=\"line\">gcc@12 ✔                                                     x86_64-elf-gcc ✔</span><br><span class=\"line\">gcc@5                                                        ghc</span><br><span class=\"line\">gcc@6                                                        grc</span><br><span class=\"line\">gcc@7                                                        scc</span><br><span class=\"line\">gcc@8                                                        tcc</span><br><span class=\"line\">gcc@9                                                        ncc</span><br><span class=\"line\">i686-elf-gcc</span><br></pre></td></tr></table></figure>\n\n<p>Use <strong>brew search gcc</strong> in terminal, you can find “x86_64-elf-gcc”. So, use “brew install x86_64-elf-gcc” to install it. Now, you can use “aarch64-elf-gcc” to compail the kernel.</p>\n<p>All tool intalled by gcc will be store in this path: <strong>/opt/homebrew/Cellar/</strong>. So you should heve this “/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld”.</p>\n<h2 id=\"Step2-Tools-Install\"><a href=\"#Step2-Tools-Install\" class=\"headerlink\" title=\"Step2, Tools Install\"></a>Step2, Tools Install</h2><ul>\n<li>Install wget <code>brew install wget</code></li>\n<li>Install nasm: <code>brew install nasm</code></li>\n<li>Install qemu and bochs: <code>brew install qemu bochs</code></li>\n</ul>\n"},{"title":"CSCE611 OS Project01 Note","date":"2024-01-25T19:23:49.000Z","_content":"\nIn this document, I describe the steps I took to add gdb debug support to the kernel in MacBook M2.\n\n## 1) Environment preparation\n\nSet up Bochs with  GDB support on MacBook M2:\n\n**Step01**, download source code from bochs's GitHub releases: https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL\n\n**Step02**, set the configure to enable GDB stub:\n\n\n```shell\n$ cd [Bochs' dir]\n$ ./configure --enable-ne2000 \\\n            --enable-all-optimizations \\\n            --enable-cpu-level=6 \\\n            --enable-x86-64 \\\n            --enable-vmx=2 \\\n            --enable-pci \\\n            --enable-usb \\\n            --enable-usb-ohci \\\n            --enable-e1000 \\\n            --enable-disasm \\\n            --disable-debugger-gui \\\n            --with-sdl \\\n            --prefix=$HOME/opt/bochs \\\n            --enable-gdb-stub  # important, --enable-debugger is not work\n```\n\n**Step03**, prepare and make Bochs:\n\n```shell\n$ brew install sdl\n$ make\n```\n\n**Step04**, install GDB:\n\nNow, no native gdb is supposed in MacBook M2. So I installed another one : i386-elf-gdb\n\n```shell\n$ brew install i386-elf-gdb\n```\n\n## 2) Add debug support to the kernel\n\n**Step05**, modify MP's makefile:\n\nAdd *-g* flag in makefile:\n\n```makefile\nAS=nasm\n\nGCC=/opt/homebrew/Cellar/x86_64-elf-gcc/13.2.0/bin/x86_64-elf-gcc\nLD=/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld\n\nGCC_OPTIONS = -m32 -nostdlib -fno-builtin -nostartfiles -nodefaultlibs -fno-exceptions -fno-rtti -fno-stack-protector -fleading-underscore -fno-asynchronous-unwind-tables\n\nall: kernel.bin\n\nclean:\n\trm -f *.o *.bin\n\n# ==== KERNEL ENTRY POINT ====\nstart.o: start.asm\n\t$(AS) -f elf -o start.o start.asm\n\n# ==== UTILITIES ====\nutils.o: utils.H utils.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o utils.o utils.C\n\n# ==== DEVICES ====\nconsole.o: console.H console.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o console.o console.C\n\n# ==== KERNEL MAIN FILE ====\nkernel.o: kernel.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o kernel.o kernel.C\n\n\nkernel.bin: start.o kernel.o console.o utils.o linker.ld\n\t$(LD) -melf_i386 -T linker.ld -o kernel.bin start.o kernel.o console.o utils.o\n```\n\nModify linker.ld, delete the first line *OUTPUT_FOTMAT('binary')*.\n\n## Debug\n\n**Step06**, start Bochs:\n\nI did not install bochs. So I use the path to call its runnable file directly\n\n```shell\n$ /Users/lhz/bochs/bochs -f bochsrc.bxrc\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/start.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n**Step07**, start GDB and connect to Bochs:\n\n```shell\n$ i386-elf-gdb kernel.bin # start GDB\n$ set architecture i386:x86-64:intel\n$ target remote localhost:1234 # connect to bochs\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/connect.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n**Step08**, set breakpoint and debug in kernel:\n\n```sh\n$ b main() # set breakpoint\n$ continue # stop at main(), the breakpoint\n$ continue # enter main(), start console\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/running.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n","source":"_posts/CSCE611-OS-Projest01-Note.md","raw":"---\ntitle: CSCE611 OS Project01 Note\ndate: 2024-01-25 13:23:49\ntags:\n---\n\nIn this document, I describe the steps I took to add gdb debug support to the kernel in MacBook M2.\n\n## 1) Environment preparation\n\nSet up Bochs with  GDB support on MacBook M2:\n\n**Step01**, download source code from bochs's GitHub releases: https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL\n\n**Step02**, set the configure to enable GDB stub:\n\n\n```shell\n$ cd [Bochs' dir]\n$ ./configure --enable-ne2000 \\\n            --enable-all-optimizations \\\n            --enable-cpu-level=6 \\\n            --enable-x86-64 \\\n            --enable-vmx=2 \\\n            --enable-pci \\\n            --enable-usb \\\n            --enable-usb-ohci \\\n            --enable-e1000 \\\n            --enable-disasm \\\n            --disable-debugger-gui \\\n            --with-sdl \\\n            --prefix=$HOME/opt/bochs \\\n            --enable-gdb-stub  # important, --enable-debugger is not work\n```\n\n**Step03**, prepare and make Bochs:\n\n```shell\n$ brew install sdl\n$ make\n```\n\n**Step04**, install GDB:\n\nNow, no native gdb is supposed in MacBook M2. So I installed another one : i386-elf-gdb\n\n```shell\n$ brew install i386-elf-gdb\n```\n\n## 2) Add debug support to the kernel\n\n**Step05**, modify MP's makefile:\n\nAdd *-g* flag in makefile:\n\n```makefile\nAS=nasm\n\nGCC=/opt/homebrew/Cellar/x86_64-elf-gcc/13.2.0/bin/x86_64-elf-gcc\nLD=/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld\n\nGCC_OPTIONS = -m32 -nostdlib -fno-builtin -nostartfiles -nodefaultlibs -fno-exceptions -fno-rtti -fno-stack-protector -fleading-underscore -fno-asynchronous-unwind-tables\n\nall: kernel.bin\n\nclean:\n\trm -f *.o *.bin\n\n# ==== KERNEL ENTRY POINT ====\nstart.o: start.asm\n\t$(AS) -f elf -o start.o start.asm\n\n# ==== UTILITIES ====\nutils.o: utils.H utils.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o utils.o utils.C\n\n# ==== DEVICES ====\nconsole.o: console.H console.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o console.o console.C\n\n# ==== KERNEL MAIN FILE ====\nkernel.o: kernel.C\n\t$(GCC) $(GCC_OPTIONS) -g -c -o kernel.o kernel.C\n\n\nkernel.bin: start.o kernel.o console.o utils.o linker.ld\n\t$(LD) -melf_i386 -T linker.ld -o kernel.bin start.o kernel.o console.o utils.o\n```\n\nModify linker.ld, delete the first line *OUTPUT_FOTMAT('binary')*.\n\n## Debug\n\n**Step06**, start Bochs:\n\nI did not install bochs. So I use the path to call its runnable file directly\n\n```shell\n$ /Users/lhz/bochs/bochs -f bochsrc.bxrc\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/start.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n**Step07**, start GDB and connect to Bochs:\n\n```shell\n$ i386-elf-gdb kernel.bin # start GDB\n$ set architecture i386:x86-64:intel\n$ target remote localhost:1234 # connect to bochs\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/connect.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n**Step08**, set breakpoint and debug in kernel:\n\n```sh\n$ b main() # set breakpoint\n$ continue # stop at main(), the breakpoint\n$ continue # enter main(), start console\n```\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/running.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n","slug":"CSCE611-OS-Projest01-Note","published":1,"updated":"2024-02-10T18:54:30.949Z","_id":"clrtlyppt00011zhg0q4f7u8f","comments":1,"layout":"post","photos":[],"link":"","content":"<p>In this document, I describe the steps I took to add gdb debug support to the kernel in MacBook M2.</p>\n<h2 id=\"1-Environment-preparation\"><a href=\"#1-Environment-preparation\" class=\"headerlink\" title=\"1) Environment preparation\"></a>1) Environment preparation</h2><p>Set up Bochs with  GDB support on MacBook M2:</p>\n<p><strong>Step01</strong>, download source code from bochs’s GitHub releases: <a href=\"https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL\">https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL</a></p>\n<p><strong>Step02</strong>, set the configure to enable GDB stub:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cd</span> [Bochs<span class=\"string\">&#x27; dir]</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"string\">./configure --enable-ne2000 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-all-optimizations \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-cpu-level=6 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-x86-64 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-vmx=2 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-pci \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-usb \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-usb-ohci \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-e1000 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-disasm \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --disable-debugger-gui \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --with-sdl \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --prefix=$HOME/opt/bochs \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-gdb-stub  # important, --enable-debugger is not work</span></span></span><br></pre></td></tr></table></figure>\n\n<p><strong>Step03</strong>, prepare and make Bochs:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">brew install sdl</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">make</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>Step04</strong>, install GDB:</p>\n<p>Now, no native gdb is supposed in MacBook M2. So I installed another one : i386-elf-gdb</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">brew install i386-elf-gdb</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Add-debug-support-to-the-kernel\"><a href=\"#2-Add-debug-support-to-the-kernel\" class=\"headerlink\" title=\"2) Add debug support to the kernel\"></a>2) Add debug support to the kernel</h2><p><strong>Step05</strong>, modify MP’s makefile:</p>\n<p>Add <em>-g</em> flag in makefile:</p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AS=nasm</span><br><span class=\"line\"></span><br><span class=\"line\">GCC=/opt/homebrew/Cellar/x86_64-elf-gcc/13.2.0/bin/x86_64-elf-gcc</span><br><span class=\"line\">LD=/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld</span><br><span class=\"line\"></span><br><span class=\"line\">GCC_OPTIONS = -m32 -nostdlib -fno-builtin -nostartfiles -nodefaultlibs -fno-exceptions -fno-rtti -fno-stack-protector -fleading-underscore -fno-asynchronous-unwind-tables</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all: kernel.bin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\trm -f *.o *.bin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== KERNEL ENTRY POINT ====</span></span><br><span class=\"line\"><span class=\"section\">start.o: start.asm</span></span><br><span class=\"line\">\t<span class=\"variable\">$(AS)</span> -f elf -o start.o start.asm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== UTILITIES ====</span></span><br><span class=\"line\"><span class=\"section\">utils.o: utils.H utils.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o utils.o utils.C</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== DEVICES ====</span></span><br><span class=\"line\"><span class=\"section\">console.o: console.H console.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o console.o console.C</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== KERNEL MAIN FILE ====</span></span><br><span class=\"line\"><span class=\"section\">kernel.o: kernel.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o kernel.o kernel.C</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">kernel.bin: start.o kernel.o console.o utils.o linker.ld</span></span><br><span class=\"line\">\t<span class=\"variable\">$(LD)</span> -melf_i386 -T linker.ld -o kernel.bin start.o kernel.o console.o utils.o</span><br></pre></td></tr></table></figure>\n\n<p>Modify linker.ld, delete the first line <em>OUTPUT_FOTMAT(‘binary’)</em>.</p>\n<h2 id=\"Debug\"><a href=\"#Debug\" class=\"headerlink\" title=\"Debug\"></a>Debug</h2><p><strong>Step06</strong>, start Bochs:</p>\n<p>I did not install bochs. So I use the path to call its runnable file directly</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">/Users/lhz/bochs/bochs -f bochsrc.bxrc</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/start.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<p><strong>Step07</strong>, start GDB and connect to Bochs:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">i386-elf-gdb kernel.bin <span class=\"comment\"># start GDB</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">set</span> architecture i386:x86-64:intel</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">target remote localhost:1234 <span class=\"comment\"># connect to bochs</span></span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/connect.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<p><strong>Step08</strong>, set breakpoint and debug in kernel:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ b main() <span class=\"comment\"># set breakpoint</span></span><br><span class=\"line\">$ <span class=\"built_in\">continue</span> <span class=\"comment\"># stop at main(), the breakpoint</span></span><br><span class=\"line\">$ <span class=\"built_in\">continue</span> <span class=\"comment\"># enter main(), start console</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/running.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n","site":{"data":{}},"excerpt":"","more":"<p>In this document, I describe the steps I took to add gdb debug support to the kernel in MacBook M2.</p>\n<h2 id=\"1-Environment-preparation\"><a href=\"#1-Environment-preparation\" class=\"headerlink\" title=\"1) Environment preparation\"></a>1) Environment preparation</h2><p>Set up Bochs with  GDB support on MacBook M2:</p>\n<p><strong>Step01</strong>, download source code from bochs’s GitHub releases: <a href=\"https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL\">https://github.com/bochs-emu/Bochs/releases/tag/REL_2_7_FINAL</a></p>\n<p><strong>Step02</strong>, set the configure to enable GDB stub:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cd</span> [Bochs<span class=\"string\">&#x27; dir]</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"string\">./configure --enable-ne2000 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-all-optimizations \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-cpu-level=6 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-x86-64 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-vmx=2 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-pci \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-usb \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-usb-ohci \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-e1000 \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-disasm \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --disable-debugger-gui \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --with-sdl \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --prefix=$HOME/opt/bochs \\</span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"language-bash\">            --enable-gdb-stub  # important, --enable-debugger is not work</span></span></span><br></pre></td></tr></table></figure>\n\n<p><strong>Step03</strong>, prepare and make Bochs:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">brew install sdl</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">make</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>Step04</strong>, install GDB:</p>\n<p>Now, no native gdb is supposed in MacBook M2. So I installed another one : i386-elf-gdb</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">brew install i386-elf-gdb</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Add-debug-support-to-the-kernel\"><a href=\"#2-Add-debug-support-to-the-kernel\" class=\"headerlink\" title=\"2) Add debug support to the kernel\"></a>2) Add debug support to the kernel</h2><p><strong>Step05</strong>, modify MP’s makefile:</p>\n<p>Add <em>-g</em> flag in makefile:</p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AS=nasm</span><br><span class=\"line\"></span><br><span class=\"line\">GCC=/opt/homebrew/Cellar/x86_64-elf-gcc/13.2.0/bin/x86_64-elf-gcc</span><br><span class=\"line\">LD=/opt/homebrew/Cellar/x86_64-elf-binutils/2.41_1/bin/x86_64-elf-ld</span><br><span class=\"line\"></span><br><span class=\"line\">GCC_OPTIONS = -m32 -nostdlib -fno-builtin -nostartfiles -nodefaultlibs -fno-exceptions -fno-rtti -fno-stack-protector -fleading-underscore -fno-asynchronous-unwind-tables</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all: kernel.bin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\trm -f *.o *.bin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== KERNEL ENTRY POINT ====</span></span><br><span class=\"line\"><span class=\"section\">start.o: start.asm</span></span><br><span class=\"line\">\t<span class=\"variable\">$(AS)</span> -f elf -o start.o start.asm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== UTILITIES ====</span></span><br><span class=\"line\"><span class=\"section\">utils.o: utils.H utils.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o utils.o utils.C</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== DEVICES ====</span></span><br><span class=\"line\"><span class=\"section\">console.o: console.H console.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o console.o console.C</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==== KERNEL MAIN FILE ====</span></span><br><span class=\"line\"><span class=\"section\">kernel.o: kernel.C</span></span><br><span class=\"line\">\t<span class=\"variable\">$(GCC)</span> <span class=\"variable\">$(GCC_OPTIONS)</span> -g -c -o kernel.o kernel.C</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">kernel.bin: start.o kernel.o console.o utils.o linker.ld</span></span><br><span class=\"line\">\t<span class=\"variable\">$(LD)</span> -melf_i386 -T linker.ld -o kernel.bin start.o kernel.o console.o utils.o</span><br></pre></td></tr></table></figure>\n\n<p>Modify linker.ld, delete the first line <em>OUTPUT_FOTMAT(‘binary’)</em>.</p>\n<h2 id=\"Debug\"><a href=\"#Debug\" class=\"headerlink\" title=\"Debug\"></a>Debug</h2><p><strong>Step06</strong>, start Bochs:</p>\n<p>I did not install bochs. So I use the path to call its runnable file directly</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">/Users/lhz/bochs/bochs -f bochsrc.bxrc</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/start.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<p><strong>Step07</strong>, start GDB and connect to Bochs:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">i386-elf-gdb kernel.bin <span class=\"comment\"># start GDB</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">set</span> architecture i386:x86-64:intel</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">target remote localhost:1234 <span class=\"comment\"># connect to bochs</span></span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/connect.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n\n<p><strong>Step08</strong>, set breakpoint and debug in kernel:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ b main() <span class=\"comment\"># set breakpoint</span></span><br><span class=\"line\">$ <span class=\"built_in\">continue</span> <span class=\"comment\"># stop at main(), the breakpoint</span></span><br><span class=\"line\">$ <span class=\"built_in\">continue</span> <span class=\"comment\"># enter main(), start console</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/running.png\" alt=\"图片替换文本\" width=\"800\" align=\"bottom\" />\n"},{"title":"CSCE611-OS-Project02-Frame Manager","date":"2024-02-10T18:55:05.000Z","_content":"\n# CSCE611-OS-MP02-Frame-Manager\n\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- cont_frame_pool.H\n- cont_frame_pool.C\n- copykernel.sh\n  - Modified to fit Mac OS\n- makefile\n  - Add a new item `make run` to make it easier to start the kernel\n    ```makefile\n    run: copy start_vm\n    copy: \n    \t./copykernel.sh\n    start_vm:\n    \tbochs -f bochsrc.bxrc\n    ```\n  \n    \n\n### Memory Structure\n\n**Design of memory pools:**\n\n![mp2-frame-memory.drawio (1)](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png)\n\n\n\n**Design of the bitmap:**\nI used two bits to store the status of a frame. The first bit indicates whether the frame is used and the second bit indicates whether the frame is the head of a frame sequence. So, we have the follows:\n\n- `[0,x]` : Not Used (`x` is 0 or 1)\n- `[1,1]` : Used and this frame is the head of a sequence\n- `[1,0]` : Used and this frame is not the head of a sequence\n\n![mp2-frame-bitmap.drawio](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-bitmap.drawio.png)\n\n### Get Frames\n\n```c++\nunsigned long ContFramePool::get_frames(unsigned int _n_frames);\n```\n\n- The function first determines if there are enough frames to allocate, then iterates through the bitmap, looking for appropriate frames, and returns the frame's id.\n\n\n\n### Release Frames\n\n```c++\nvoid release_frames_internel(unsigned long _first_frame_no);\n\nContFramePool*        next_pool;  // next pool\nstatic ContFramePool* pools_head; // head point of all polls\nstatic void release_frames(unsigned long _first_frame_no);\n```\n\n- **`release_frames_internel`**: An internal function to release frames starting from a given frame number within a specific pool.\n- **`next_pool`**: A pointer to the next memory frame pool, enabling a linked list structure for pool management.\n- **`pools_head`**: A static pointer that serves as the head of the list of all memory frame pools.\n- **`release_frames`**: A static function that releases frames by locating the correct pool using the frame's ID and then invoking `release_frames_internel` for that pool.\n\n\n\n**Release process:**\n\n- release_frames is a static function which has only one parameter `_first_frame_no`\n- release_frames first determines which pool the frame belongs to, and then use `global_kernel_memory_pool` and `global_process_memory_pool ` to releases it.\n- Since one sequence of frames needs to be released, the release process constantly determines whether a new head (Frame with `Used_Head` tag in bitmap) has been encountered. If so, the release_frames_internel will finish the release process and return.\n\n\n\n### Output/Test\n\n![Screenshot 2024-02-10 at 16.26.52](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-10%20at%2016.26.52.png)\n\n","source":"_posts/CSCE611-OS-Project02-Frame-Manager.md","raw":"---\ntitle: CSCE611-OS-Project02-Frame Manager\ndate: 2024-02-10 12:55:05\ntags:\n---\n\n# CSCE611-OS-MP02-Frame-Manager\n\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- cont_frame_pool.H\n- cont_frame_pool.C\n- copykernel.sh\n  - Modified to fit Mac OS\n- makefile\n  - Add a new item `make run` to make it easier to start the kernel\n    ```makefile\n    run: copy start_vm\n    copy: \n    \t./copykernel.sh\n    start_vm:\n    \tbochs -f bochsrc.bxrc\n    ```\n  \n    \n\n### Memory Structure\n\n**Design of memory pools:**\n\n![mp2-frame-memory.drawio (1)](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png)\n\n\n\n**Design of the bitmap:**\nI used two bits to store the status of a frame. The first bit indicates whether the frame is used and the second bit indicates whether the frame is the head of a frame sequence. So, we have the follows:\n\n- `[0,x]` : Not Used (`x` is 0 or 1)\n- `[1,1]` : Used and this frame is the head of a sequence\n- `[1,0]` : Used and this frame is not the head of a sequence\n\n![mp2-frame-bitmap.drawio](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-bitmap.drawio.png)\n\n### Get Frames\n\n```c++\nunsigned long ContFramePool::get_frames(unsigned int _n_frames);\n```\n\n- The function first determines if there are enough frames to allocate, then iterates through the bitmap, looking for appropriate frames, and returns the frame's id.\n\n\n\n### Release Frames\n\n```c++\nvoid release_frames_internel(unsigned long _first_frame_no);\n\nContFramePool*        next_pool;  // next pool\nstatic ContFramePool* pools_head; // head point of all polls\nstatic void release_frames(unsigned long _first_frame_no);\n```\n\n- **`release_frames_internel`**: An internal function to release frames starting from a given frame number within a specific pool.\n- **`next_pool`**: A pointer to the next memory frame pool, enabling a linked list structure for pool management.\n- **`pools_head`**: A static pointer that serves as the head of the list of all memory frame pools.\n- **`release_frames`**: A static function that releases frames by locating the correct pool using the frame's ID and then invoking `release_frames_internel` for that pool.\n\n\n\n**Release process:**\n\n- release_frames is a static function which has only one parameter `_first_frame_no`\n- release_frames first determines which pool the frame belongs to, and then use `global_kernel_memory_pool` and `global_process_memory_pool ` to releases it.\n- Since one sequence of frames needs to be released, the release process constantly determines whether a new head (Frame with `Used_Head` tag in bitmap) has been encountered. If so, the release_frames_internel will finish the release process and return.\n\n\n\n### Output/Test\n\n![Screenshot 2024-02-10 at 16.26.52](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-10%20at%2016.26.52.png)\n\n","slug":"CSCE611-OS-Project02-Frame-Manager","published":1,"updated":"2024-02-12T05:29:08.558Z","_id":"clsgh58uf00000lok378g94pm","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"CSCE611-OS-MP02-Frame-Manager\"><a href=\"#CSCE611-OS-MP02-Frame-Manager\" class=\"headerlink\" title=\"CSCE611-OS-MP02-Frame-Manager\"></a>CSCE611-OS-MP02-Frame-Manager</h1><p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>cont_frame_pool.H</li>\n<li>cont_frame_pool.C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n<li>makefile<ul>\n<li>Add a new item <code>make run</code> to make it easier to start the kernel<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">run: copy start_vm</span></span><br><span class=\"line\"><span class=\"section\">copy: </span></span><br><span class=\"line\">\t./copykernel.sh</span><br><span class=\"line\"><span class=\"section\">start_vm:</span></span><br><span class=\"line\">\tbochs -f bochsrc.bxrc</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Memory-Structure\"><a href=\"#Memory-Structure\" class=\"headerlink\" title=\"Memory Structure\"></a>Memory Structure</h3><p><strong>Design of memory pools:</strong></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png\" alt=\"mp2-frame-memory.drawio (1)\"></p>\n<p><strong>Design of the bitmap:</strong><br>I used two bits to store the status of a frame. The first bit indicates whether the frame is used and the second bit indicates whether the frame is the head of a frame sequence. So, we have the follows:</p>\n<ul>\n<li><code>[0,x]</code> : Not Used (<code>x</code> is 0 or 1)</li>\n<li><code>[1,1]</code> : Used and this frame is the head of a sequence</li>\n<li><code>[1,0]</code> : Used and this frame is not the head of a sequence</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-bitmap.drawio.png\" alt=\"mp2-frame-bitmap.drawio\"></p>\n<h3 id=\"Get-Frames\"><a href=\"#Get-Frames\" class=\"headerlink\" title=\"Get Frames\"></a>Get Frames</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"title\">ContFramePool::get_frames</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> _n_frames)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>The function first determines if there are enough frames to allocate, then iterates through the bitmap, looking for appropriate frames, and returns the frame’s id.</li>\n</ul>\n<h3 id=\"Release-Frames\"><a href=\"#Release-Frames\" class=\"headerlink\" title=\"Release Frames\"></a>Release Frames</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">release_frames_internel</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> _first_frame_no)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">ContFramePool*        next_pool;  <span class=\"comment\">// next pool</span></span><br><span class=\"line\"><span class=\"type\">static</span> ContFramePool* pools_head; <span class=\"comment\">// head point of all polls</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">release_frames</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> _first_frame_no)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong><code>release_frames_internel</code></strong>: An internal function to release frames starting from a given frame number within a specific pool.</li>\n<li><strong><code>next_pool</code></strong>: A pointer to the next memory frame pool, enabling a linked list structure for pool management.</li>\n<li><strong><code>pools_head</code></strong>: A static pointer that serves as the head of the list of all memory frame pools.</li>\n<li><strong><code>release_frames</code></strong>: A static function that releases frames by locating the correct pool using the frame’s ID and then invoking <code>release_frames_internel</code> for that pool.</li>\n</ul>\n<p><strong>Release process:</strong></p>\n<ul>\n<li>release_frames is a static function which has only one parameter <code>_first_frame_no</code></li>\n<li>release_frames first determines which pool the frame belongs to, and then use <code>global_kernel_memory_pool</code> and <code>global_process_memory_pool </code> to releases it.</li>\n<li>Since one sequence of frames needs to be released, the release process constantly determines whether a new head (Frame with <code>Used_Head</code> tag in bitmap) has been encountered. If so, the release_frames_internel will finish the release process and return.</li>\n</ul>\n<h3 id=\"Output-Test\"><a href=\"#Output-Test\" class=\"headerlink\" title=\"Output/Test\"></a>Output/Test</h3><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-10%20at%2016.26.52.png\" alt=\"Screenshot 2024-02-10 at 16.26.52\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"CSCE611-OS-MP02-Frame-Manager\"><a href=\"#CSCE611-OS-MP02-Frame-Manager\" class=\"headerlink\" title=\"CSCE611-OS-MP02-Frame-Manager\"></a>CSCE611-OS-MP02-Frame-Manager</h1><p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>cont_frame_pool.H</li>\n<li>cont_frame_pool.C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n<li>makefile<ul>\n<li>Add a new item <code>make run</code> to make it easier to start the kernel<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">run: copy start_vm</span></span><br><span class=\"line\"><span class=\"section\">copy: </span></span><br><span class=\"line\">\t./copykernel.sh</span><br><span class=\"line\"><span class=\"section\">start_vm:</span></span><br><span class=\"line\">\tbochs -f bochsrc.bxrc</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Memory-Structure\"><a href=\"#Memory-Structure\" class=\"headerlink\" title=\"Memory Structure\"></a>Memory Structure</h3><p><strong>Design of memory pools:</strong></p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png\" alt=\"mp2-frame-memory.drawio (1)\"></p>\n<p><strong>Design of the bitmap:</strong><br>I used two bits to store the status of a frame. The first bit indicates whether the frame is used and the second bit indicates whether the frame is the head of a frame sequence. So, we have the follows:</p>\n<ul>\n<li><code>[0,x]</code> : Not Used (<code>x</code> is 0 or 1)</li>\n<li><code>[1,1]</code> : Used and this frame is the head of a sequence</li>\n<li><code>[1,0]</code> : Used and this frame is not the head of a sequence</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-bitmap.drawio.png\" alt=\"mp2-frame-bitmap.drawio\"></p>\n<h3 id=\"Get-Frames\"><a href=\"#Get-Frames\" class=\"headerlink\" title=\"Get Frames\"></a>Get Frames</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"title\">ContFramePool::get_frames</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> _n_frames)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>The function first determines if there are enough frames to allocate, then iterates through the bitmap, looking for appropriate frames, and returns the frame’s id.</li>\n</ul>\n<h3 id=\"Release-Frames\"><a href=\"#Release-Frames\" class=\"headerlink\" title=\"Release Frames\"></a>Release Frames</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">release_frames_internel</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> _first_frame_no)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">ContFramePool*        next_pool;  <span class=\"comment\">// next pool</span></span><br><span class=\"line\"><span class=\"type\">static</span> ContFramePool* pools_head; <span class=\"comment\">// head point of all polls</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">release_frames</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> _first_frame_no)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong><code>release_frames_internel</code></strong>: An internal function to release frames starting from a given frame number within a specific pool.</li>\n<li><strong><code>next_pool</code></strong>: A pointer to the next memory frame pool, enabling a linked list structure for pool management.</li>\n<li><strong><code>pools_head</code></strong>: A static pointer that serves as the head of the list of all memory frame pools.</li>\n<li><strong><code>release_frames</code></strong>: A static function that releases frames by locating the correct pool using the frame’s ID and then invoking <code>release_frames_internel</code> for that pool.</li>\n</ul>\n<p><strong>Release process:</strong></p>\n<ul>\n<li>release_frames is a static function which has only one parameter <code>_first_frame_no</code></li>\n<li>release_frames first determines which pool the frame belongs to, and then use <code>global_kernel_memory_pool</code> and <code>global_process_memory_pool </code> to releases it.</li>\n<li>Since one sequence of frames needs to be released, the release process constantly determines whether a new head (Frame with <code>Used_Head</code> tag in bitmap) has been encountered. If so, the release_frames_internel will finish the release process and return.</li>\n</ul>\n<h3 id=\"Output-Test\"><a href=\"#Output-Test\" class=\"headerlink\" title=\"Output/Test\"></a>Output/Test</h3><p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-10%20at%2016.26.52.png\" alt=\"Screenshot 2024-02-10 at 16.26.52\"></p>\n"},{"title":"CSCE611-OS-Project03","date":"2024-02-24T03:36:58.000Z","_content":"\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- cont_frame_pool.H/C\n- page table.H/C\n- copykernel.sh\n  - Modified to fit Mac OS\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2021.44.43.png\" alt=\"图片替换文本\" width=\"200\" align=\"bottom\" />\n\n**Step 1** Init memory pools:\nWe have two pools : kernel pool and process pool. Kernel pool is used for store infomations from kernel like page table. Process pool is to allocate memory to processes. When a page fault is triggered, the page fault handle will get a frame from process pool and map it from the address that fault happened.\n\n![mp2-frame-memory.drawio (1)](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png)\n\n**Step 2** add page fault handle\n\n```c++\n\t\tclass PageFault_Handler : public ExceptionHandler {\n    public:\n        virtual void handle_exception(REGS * _regs) {\n            PageTable::handle_fault(_regs);\n        }\n    } pagefault_handler;\n    \n\n    ExceptionHandler::register_handler(14, &pagefault_handler);\n```\n\nIn this code, we add a handle for fault 14, which is page fault. The page fault will be processed by the static function PageTable::handle_fault().\n\n\n\n**Step 3** Init paging\n\n```c++\n\t\tPageTable::init_paging(&kernel_mem_pool,\n                           &process_mem_pool,\n                           4 MB); /* We share the first 4MB */\n    \n    PageTable pt;\n    \n    pt.load();\n```\n\nIn this code, we first init the PageTable's static variables by pass two memory pools to it (init_paging). In init_paging, we, first apply one frame from kernel pool for page directory. Than, we map the first 4MB of memory to it physical address(use another frame as the first page table). This can help us able to access kernel pool's frames directly.\n\nThis is the menory structure:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\nAfter that, we use *pt.load* to anable paging:\n```c++\nvoid PageTable::load()\n{\n   // before we set the paging bit to 1, we must put the address of the page directory into CR3.\n   current_page_table = this;\n   write_cr3((unsigned long) page_directory);\n}\n\nvoid PageTable::enable_paging()\n{   \n   paging_enabled = 1;\n   //  the paging bit of CR0(bit 31) when set to 1 enables paging\n   write_cr0(read_cr0() | 0x80000000);\n}\n```\n\n**Step 4** process page faluts\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nFirstly, get fault virtual memory address from cr2\"\n\n```c++\nunsigned long faulting_address = read_cr2();\n```\n\nGet page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.\n\n```c++\n unsigned long pd_index = faulting_address >> 22; // index in page dir\n unsigned long pt_index = (faulting_address >> 12) & 0b1111111111; // index in page table\n```\n\nFor two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].\n```c++\n if (!(pd[pd_index] & 1)) {\n \t// page table not exist\n   // apply a new frame from kernel pool\n   ......\n }\n```\n\nIn the end, we apply a new frame from process pool and add it to page table.\n\n```c++\n unsigned long new_frame = process_mem_pool->get_frames(1);\n pt[pt_index] = (new_frame * PAGE_SIZE) | 3;\n```\n\n\n\n**Result**:\n\n![Screenshot 2024-02-23 at 22.22.42](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.22.42.png)\n","source":"_posts/CSCE611-OS-Project03.md","raw":"---\ntitle: CSCE611-OS-Project03\ndate: 2024-02-23 21:36:58\ntags:\n---\n\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- cont_frame_pool.H/C\n- page table.H/C\n- copykernel.sh\n  - Modified to fit Mac OS\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2021.44.43.png\" alt=\"图片替换文本\" width=\"200\" align=\"bottom\" />\n\n**Step 1** Init memory pools:\nWe have two pools : kernel pool and process pool. Kernel pool is used for store infomations from kernel like page table. Process pool is to allocate memory to processes. When a page fault is triggered, the page fault handle will get a frame from process pool and map it from the address that fault happened.\n\n![mp2-frame-memory.drawio (1)](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png)\n\n**Step 2** add page fault handle\n\n```c++\n\t\tclass PageFault_Handler : public ExceptionHandler {\n    public:\n        virtual void handle_exception(REGS * _regs) {\n            PageTable::handle_fault(_regs);\n        }\n    } pagefault_handler;\n    \n\n    ExceptionHandler::register_handler(14, &pagefault_handler);\n```\n\nIn this code, we add a handle for fault 14, which is page fault. The page fault will be processed by the static function PageTable::handle_fault().\n\n\n\n**Step 3** Init paging\n\n```c++\n\t\tPageTable::init_paging(&kernel_mem_pool,\n                           &process_mem_pool,\n                           4 MB); /* We share the first 4MB */\n    \n    PageTable pt;\n    \n    pt.load();\n```\n\nIn this code, we first init the PageTable's static variables by pass two memory pools to it (init_paging). In init_paging, we, first apply one frame from kernel pool for page directory. Than, we map the first 4MB of memory to it physical address(use another frame as the first page table). This can help us able to access kernel pool's frames directly.\n\nThis is the menory structure:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\nAfter that, we use *pt.load* to anable paging:\n```c++\nvoid PageTable::load()\n{\n   // before we set the paging bit to 1, we must put the address of the page directory into CR3.\n   current_page_table = this;\n   write_cr3((unsigned long) page_directory);\n}\n\nvoid PageTable::enable_paging()\n{   \n   paging_enabled = 1;\n   //  the paging bit of CR0(bit 31) when set to 1 enables paging\n   write_cr0(read_cr0() | 0x80000000);\n}\n```\n\n**Step 4** process page faluts\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nFirstly, get fault virtual memory address from cr2\"\n\n```c++\nunsigned long faulting_address = read_cr2();\n```\n\nGet page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.\n\n```c++\n unsigned long pd_index = faulting_address >> 22; // index in page dir\n unsigned long pt_index = (faulting_address >> 12) & 0b1111111111; // index in page table\n```\n\nFor two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].\n```c++\n if (!(pd[pd_index] & 1)) {\n \t// page table not exist\n   // apply a new frame from kernel pool\n   ......\n }\n```\n\nIn the end, we apply a new frame from process pool and add it to page table.\n\n```c++\n unsigned long new_frame = process_mem_pool->get_frames(1);\n pt[pt_index] = (new_frame * PAGE_SIZE) | 3;\n```\n\n\n\n**Result**:\n\n![Screenshot 2024-02-23 at 22.22.42](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.22.42.png)\n","slug":"CSCE611-OS-Project03","published":1,"updated":"2024-02-25T17:05:03.954Z","_id":"clszkt8d20000wuok9xqj4oqq","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>cont_frame_pool.H/C</li>\n<li>page table.H/C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n</ul>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2021.44.43.png\" alt=\"图片替换文本\" width=\"200\" align=\"bottom\" />\n\n<p><strong>Step 1</strong> Init memory pools:<br>We have two pools : kernel pool and process pool. Kernel pool is used for store infomations from kernel like page table. Process pool is to allocate memory to processes. When a page fault is triggered, the page fault handle will get a frame from process pool and map it from the address that fault happened.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png\" alt=\"mp2-frame-memory.drawio (1)\"></p>\n<p><strong>Step 2</strong> add page fault handle</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">PageFault_Handler</span> : <span class=\"keyword\">public</span> ExceptionHandler &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">handle_exception</span><span class=\"params\">(REGS * _regs)</span> </span>&#123;</span><br><span class=\"line\">          PageTable::<span class=\"built_in\">handle_fault</span>(_regs);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125; pagefault_handler;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">  ExceptionHandler::<span class=\"built_in\">register_handler</span>(<span class=\"number\">14</span>, &amp;pagefault_handler);</span><br></pre></td></tr></table></figure>\n\n<p>In this code, we add a handle for fault 14, which is page fault. The page fault will be processed by the static function PageTable::handle_fault().</p>\n<p><strong>Step 3</strong> Init paging</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PageTable::<span class=\"built_in\">init_paging</span>(&amp;kernel_mem_pool,</span><br><span class=\"line\">                         &amp;process_mem_pool,</span><br><span class=\"line\">                         <span class=\"number\">4</span> MB); <span class=\"comment\">/* We share the first 4MB */</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  PageTable pt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  pt.<span class=\"built_in\">load</span>();</span><br></pre></td></tr></table></figure>\n\n<p>In this code, we first init the PageTable’s static variables by pass two memory pools to it (init_paging). In init_paging, we, first apply one frame from kernel pool for page directory. Than, we map the first 4MB of memory to it physical address(use another frame as the first page table). This can help us able to access kernel pool’s frames directly.</p>\n<p>This is the menory structure:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n<p>After that, we use <em>pt.load</em> to anable paging:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::load</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   <span class=\"comment\">// before we set the paging bit to 1, we must put the address of the page directory into CR3.</span></span><br><span class=\"line\">   current_page_table = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">   <span class=\"built_in\">write_cr3</span>((<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) page_directory);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::enable_paging</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;   </span><br><span class=\"line\">   paging_enabled = <span class=\"number\">1</span>;</span><br><span class=\"line\">   <span class=\"comment\">//  the paging bit of CR0(bit 31) when set to 1 enables paging</span></span><br><span class=\"line\">   <span class=\"built_in\">write_cr0</span>(<span class=\"built_in\">read_cr0</span>() | <span class=\"number\">0x80000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>Step 4</strong> process page faluts</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>Firstly, get fault virtual memory address from cr2”</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> faulting_address = <span class=\"built_in\">read_cr2</span>();</span><br></pre></td></tr></table></figure>\n\n<p>Get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pd_index = faulting_address &gt;&gt; <span class=\"number\">22</span>; <span class=\"comment\">// index in page dir</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pt_index = (faulting_address &gt;&gt; <span class=\"number\">12</span>) &amp; <span class=\"number\">0b1111111111</span>; <span class=\"comment\">// index in page table</span></span><br></pre></td></tr></table></figure>\n\n<p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!(pd[pd_index] &amp; <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// page table not exist</span></span><br><span class=\"line\">  <span class=\"comment\">// apply a new frame from kernel pool</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>In the end, we apply a new frame from process pool and add it to page table.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> new_frame = process_mem_pool-&gt;<span class=\"built_in\">get_frames</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class=\"number\">3</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>Result</strong>:</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.22.42.png\" alt=\"Screenshot 2024-02-23 at 22.22.42\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>cont_frame_pool.H/C</li>\n<li>page table.H/C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n</ul>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2021.44.43.png\" alt=\"图片替换文本\" width=\"200\" align=\"bottom\" />\n\n<p><strong>Step 1</strong> Init memory pools:<br>We have two pools : kernel pool and process pool. Kernel pool is used for store infomations from kernel like page table. Process pool is to allocate memory to processes. When a page fault is triggered, the page fault handle will get a frame from process pool and map it from the address that fault happened.</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/mp2-frame-memory.drawio.png\" alt=\"mp2-frame-memory.drawio (1)\"></p>\n<p><strong>Step 2</strong> add page fault handle</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">PageFault_Handler</span> : <span class=\"keyword\">public</span> ExceptionHandler &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">handle_exception</span><span class=\"params\">(REGS * _regs)</span> </span>&#123;</span><br><span class=\"line\">          PageTable::<span class=\"built_in\">handle_fault</span>(_regs);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125; pagefault_handler;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">  ExceptionHandler::<span class=\"built_in\">register_handler</span>(<span class=\"number\">14</span>, &amp;pagefault_handler);</span><br></pre></td></tr></table></figure>\n\n<p>In this code, we add a handle for fault 14, which is page fault. The page fault will be processed by the static function PageTable::handle_fault().</p>\n<p><strong>Step 3</strong> Init paging</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PageTable::<span class=\"built_in\">init_paging</span>(&amp;kernel_mem_pool,</span><br><span class=\"line\">                         &amp;process_mem_pool,</span><br><span class=\"line\">                         <span class=\"number\">4</span> MB); <span class=\"comment\">/* We share the first 4MB */</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  PageTable pt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  pt.<span class=\"built_in\">load</span>();</span><br></pre></td></tr></table></figure>\n\n<p>In this code, we first init the PageTable’s static variables by pass two memory pools to it (init_paging). In init_paging, we, first apply one frame from kernel pool for page directory. Than, we map the first 4MB of memory to it physical address(use another frame as the first page table). This can help us able to access kernel pool’s frames directly.</p>\n<p>This is the menory structure:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"400\" align=\"bottom\" />\n\n<p>After that, we use <em>pt.load</em> to anable paging:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::load</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   <span class=\"comment\">// before we set the paging bit to 1, we must put the address of the page directory into CR3.</span></span><br><span class=\"line\">   current_page_table = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">   <span class=\"built_in\">write_cr3</span>((<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) page_directory);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::enable_paging</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;   </span><br><span class=\"line\">   paging_enabled = <span class=\"number\">1</span>;</span><br><span class=\"line\">   <span class=\"comment\">//  the paging bit of CR0(bit 31) when set to 1 enables paging</span></span><br><span class=\"line\">   <span class=\"built_in\">write_cr0</span>(<span class=\"built_in\">read_cr0</span>() | <span class=\"number\">0x80000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>Step 4</strong> process page faluts</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>Firstly, get fault virtual memory address from cr2”</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> faulting_address = <span class=\"built_in\">read_cr2</span>();</span><br></pre></td></tr></table></figure>\n\n<p>Get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pd_index = faulting_address &gt;&gt; <span class=\"number\">22</span>; <span class=\"comment\">// index in page dir</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pt_index = (faulting_address &gt;&gt; <span class=\"number\">12</span>) &amp; <span class=\"number\">0b1111111111</span>; <span class=\"comment\">// index in page table</span></span><br></pre></td></tr></table></figure>\n\n<p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!(pd[pd_index] &amp; <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// page table not exist</span></span><br><span class=\"line\">  <span class=\"comment\">// apply a new frame from kernel pool</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>In the end, we apply a new frame from process pool and add it to page table.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> new_frame = process_mem_pool-&gt;<span class=\"built_in\">get_frames</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class=\"number\">3</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>Result</strong>:</p>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.22.42.png\" alt=\"Screenshot 2024-02-23 at 22.22.42\"></p>\n"},{"title":"CSCE611-OS-Project04-Memory","date":"2024-03-18T15:45:35.000Z","_content":"\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- page table.H/C\n- vm_pool.H/C\n- copykernel.sh\n  - Modified to fit Mac OS\n\n### Design\n\n#### 1. Page Table\n\n**i. Extension of page table manager**\n\nFor *register_pool()*, I used a linkedlist to store all VMPools in PageTable. In PageTable, I added a new variable:\n```c++\n// vm pools\nstatic VMPool * pool_link_head;\n```\n\nThis is the head of all vm_pools. In VMPool, there is a new variable *next_pool* which point to the next pool. By doing this, I realized the register_pool by adding the pool to the end of the linkedlist in VMPool's constructor.\n\n```c++\nvoid PageTable::register_pool(VMPool * _vm_pool)\n{\n   VMPool * node=pool_link_head;\n   if(node == nullptr){\n      pool_link_head = _vm_pool;\n   }\n   else{\n      while(node->next_pool != nullptr){\n         node=node->next_pool;\n      }\n      node->next_pool = _vm_pool;\n   }\n}\n```\n\n For *free_page()*, first calculate the address of the page according to the page_no. Then, based on this address, find the corresponding page table. Set the corresponding pte value to 0. Then release the corresponding frame in the frame pool. Thus realize the release of memory.\n\n\n\n**ii. Recursive page table lookup**\n\nThis is the menory structure:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\nprocess page faluts: \n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nFirstly, get fault virtual memory address from cr2\"\n\n```c++\nunsigned long faulting_address = read_cr2();\n```\n\nBefore fault handle, function need to check whether the address belong to a registed VMPool.\n\n```c++\n\t // check address in vm pool\n   bool flag=false;\n\n   VMPool * node = pool_link_head;\n\n\t // no vm pool, so not make checking\n   if(node == nullptr) flag =true;\n\n   while(node != nullptr){\n     \t// first two pages, used to store memory usage information\n      if(faulting_address >= node->base_address && faulting_address <= (node->base_address+PAGE_SIZE*2) ){\n         flag=true;\n         break;\n      }\n\n      // is_legitimate ?\n      flag = flag || node->is_legitimate(faulting_address);\n\n      node=node->next_pool;\n   }\n```\n\n\n\nIf address is legitimate, get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.\n\n```c++\n unsigned long pd_index = faulting_address >> 22; // index in page dir\n unsigned long pt_index = (faulting_address >> 12) & 0b1111111111; // index in page table\n```\n\nFor two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].\n```c++\n if (!(pd[pd_index] & 1)) {\n \t// page table not exist\n   // apply a new frame from kernel pool\n   ......\n }\n```\n\nIn the end, we apply a new frame from process pool and add it to page table.\n\n```c++\n unsigned long new_frame = process_mem_pool->get_frames(1);\n pt[pt_index] = (new_frame * PAGE_SIZE) | 3;\n```\n\n\n\n#### 2.VM Pool\n\nThe `VMPool` class is responsible for managing a virtual memory pool, which includes allocating and releasing memory regions as well as checking the legitimacy of addresses. Here's a detailed breakdown of each function in the class:\n\n1. **Constructor `VMPool`**: Initializes a virtual memory pool with a given base address, size, frame pool, and page table. It registers the pool with the page table and sets up the data structures for tracking used and free memory regions.\n\n2. **`allocate(unsigned long _size)`**: The `allocate` method in the `VMPool` class is responsible for allocating a region of memory from the virtual memory pool. It uses two arrays (first to frames in frame_pool), `used_memory_info` and `free_memory_info`, to track the memory usage. Each entry in these arrays consists of a pair of values, representing the start and end addresses of a memory region. This is structure of `used_memory_info`:\n\n   <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2019.41.59.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n1. **`release(unsigned long _start_address)`**: Releases a region of previously allocated memory identified by its start address. It removes the region from the used memory info, adds it back to the free memory info, and releases the corresponding pages in the page table.\n\n2. **`is_legitimate(unsigned long _address)`**: Checks whether a given address is part of a currently allocated region. It returns `true` if the address is within the range of an allocated block and `false` otherwise.\n\nAdditionally, the class has private member variables for storing the size of the pool, pointers to the frame pool and page table, and arrays for tracking used and free memory regions. It also defines a constant `PAGE_SIZE` for the page size and has a public member variable `base_address` for the base address of the pool.\n\n\n\n### **Testing**:\n\n**_TEST_PAGE_TABLE_ (Passed)** :\n\nThis test is designed to evaluate the implementation of page tables by accessing and writing to unmapped virtual memory. It determines the correctness of the page table implementation by verifying whether data can be accurately written to and read from virtual addresses.\n\n```c++\n#define FAULT_ADDR (4 * 1024 * 1024) // 4 MB, Address used to cause page faults in the test.\n#define NACCESS ((1 MB) / 4) // (1 MB) / 4, Number of integer accesses (4 bytes each) starting from FAULT_ADDR.\n```\n\nI also extended this test from \"(1 MB) / 4\" to \"(27 MB) / 4\". This is because the physics address space it 32MB. The first 4MB is direct mapped and 15-16MB is the memory hole. So, there is total 27MB can be mapped. For \"(27 MB) / 4\", my code can pass the test too.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.56.06.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n**_TEST_VM_POOL_ (Passed)** :\n\nThis test involves memory allocation and release operations. It tests the ability to correctly handle memory allocation and release requests, ensuring that memory is properly allocated when requested and correctly freed when no longer needed. \n\n```c++\nint *arr = new int[size2 * i]; // allocate\ndelete[] arr; // release\n```\n\nMy code prints out the IDs of the allocated memory frames and the frames released during the release process. Upon inspection, my vm_pool can correctly allocate and release frames.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.54.45.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n","source":"_posts/CSCE611-OS-Project04-Memory.md","raw":"---\ntitle: CSCE611-OS-Project04-Memory\ndate: 2024-03-18 10:45:35\ntags:\n---\n\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n- page table.H/C\n- vm_pool.H/C\n- copykernel.sh\n  - Modified to fit Mac OS\n\n### Design\n\n#### 1. Page Table\n\n**i. Extension of page table manager**\n\nFor *register_pool()*, I used a linkedlist to store all VMPools in PageTable. In PageTable, I added a new variable:\n```c++\n// vm pools\nstatic VMPool * pool_link_head;\n```\n\nThis is the head of all vm_pools. In VMPool, there is a new variable *next_pool* which point to the next pool. By doing this, I realized the register_pool by adding the pool to the end of the linkedlist in VMPool's constructor.\n\n```c++\nvoid PageTable::register_pool(VMPool * _vm_pool)\n{\n   VMPool * node=pool_link_head;\n   if(node == nullptr){\n      pool_link_head = _vm_pool;\n   }\n   else{\n      while(node->next_pool != nullptr){\n         node=node->next_pool;\n      }\n      node->next_pool = _vm_pool;\n   }\n}\n```\n\n For *free_page()*, first calculate the address of the page according to the page_no. Then, based on this address, find the corresponding page table. Set the corresponding pte value to 0. Then release the corresponding frame in the frame pool. Thus realize the release of memory.\n\n\n\n**ii. Recursive page table lookup**\n\nThis is the menory structure:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\nprocess page faluts: \n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\nFirstly, get fault virtual memory address from cr2\"\n\n```c++\nunsigned long faulting_address = read_cr2();\n```\n\nBefore fault handle, function need to check whether the address belong to a registed VMPool.\n\n```c++\n\t // check address in vm pool\n   bool flag=false;\n\n   VMPool * node = pool_link_head;\n\n\t // no vm pool, so not make checking\n   if(node == nullptr) flag =true;\n\n   while(node != nullptr){\n     \t// first two pages, used to store memory usage information\n      if(faulting_address >= node->base_address && faulting_address <= (node->base_address+PAGE_SIZE*2) ){\n         flag=true;\n         break;\n      }\n\n      // is_legitimate ?\n      flag = flag || node->is_legitimate(faulting_address);\n\n      node=node->next_pool;\n   }\n```\n\n\n\nIf address is legitimate, get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.\n\n```c++\n unsigned long pd_index = faulting_address >> 22; // index in page dir\n unsigned long pt_index = (faulting_address >> 12) & 0b1111111111; // index in page table\n```\n\nFor two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].\n```c++\n if (!(pd[pd_index] & 1)) {\n \t// page table not exist\n   // apply a new frame from kernel pool\n   ......\n }\n```\n\nIn the end, we apply a new frame from process pool and add it to page table.\n\n```c++\n unsigned long new_frame = process_mem_pool->get_frames(1);\n pt[pt_index] = (new_frame * PAGE_SIZE) | 3;\n```\n\n\n\n#### 2.VM Pool\n\nThe `VMPool` class is responsible for managing a virtual memory pool, which includes allocating and releasing memory regions as well as checking the legitimacy of addresses. Here's a detailed breakdown of each function in the class:\n\n1. **Constructor `VMPool`**: Initializes a virtual memory pool with a given base address, size, frame pool, and page table. It registers the pool with the page table and sets up the data structures for tracking used and free memory regions.\n\n2. **`allocate(unsigned long _size)`**: The `allocate` method in the `VMPool` class is responsible for allocating a region of memory from the virtual memory pool. It uses two arrays (first to frames in frame_pool), `used_memory_info` and `free_memory_info`, to track the memory usage. Each entry in these arrays consists of a pair of values, representing the start and end addresses of a memory region. This is structure of `used_memory_info`:\n\n   <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2019.41.59.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n1. **`release(unsigned long _start_address)`**: Releases a region of previously allocated memory identified by its start address. It removes the region from the used memory info, adds it back to the free memory info, and releases the corresponding pages in the page table.\n\n2. **`is_legitimate(unsigned long _address)`**: Checks whether a given address is part of a currently allocated region. It returns `true` if the address is within the range of an allocated block and `false` otherwise.\n\nAdditionally, the class has private member variables for storing the size of the pool, pointers to the frame pool and page table, and arrays for tracking used and free memory regions. It also defines a constant `PAGE_SIZE` for the page size and has a public member variable `base_address` for the base address of the pool.\n\n\n\n### **Testing**:\n\n**_TEST_PAGE_TABLE_ (Passed)** :\n\nThis test is designed to evaluate the implementation of page tables by accessing and writing to unmapped virtual memory. It determines the correctness of the page table implementation by verifying whether data can be accurately written to and read from virtual addresses.\n\n```c++\n#define FAULT_ADDR (4 * 1024 * 1024) // 4 MB, Address used to cause page faults in the test.\n#define NACCESS ((1 MB) / 4) // (1 MB) / 4, Number of integer accesses (4 bytes each) starting from FAULT_ADDR.\n```\n\nI also extended this test from \"(1 MB) / 4\" to \"(27 MB) / 4\". This is because the physics address space it 32MB. The first 4MB is direct mapped and 15-16MB is the memory hole. So, there is total 27MB can be mapped. For \"(27 MB) / 4\", my code can pass the test too.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.56.06.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n**_TEST_VM_POOL_ (Passed)** :\n\nThis test involves memory allocation and release operations. It tests the ability to correctly handle memory allocation and release requests, ensuring that memory is properly allocated when requested and correctly freed when no longer needed. \n\n```c++\nint *arr = new int[size2 * i]; // allocate\ndelete[] arr; // release\n```\n\nMy code prints out the IDs of the allocated memory frames and the frames released during the release process. Upon inspection, my vm_pool can correctly allocate and release frames.\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.54.45.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n","slug":"CSCE611-OS-Project04-Memory","published":1,"updated":"2024-03-20T18:50:32.983Z","_id":"cltxndopv00009eokf68qffbr","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>page table.H/C</li>\n<li>vm_pool.H/C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Design\"><a href=\"#Design\" class=\"headerlink\" title=\"Design\"></a>Design</h3><h4 id=\"1-Page-Table\"><a href=\"#1-Page-Table\" class=\"headerlink\" title=\"1. Page Table\"></a>1. Page Table</h4><p><strong>i. Extension of page table manager</strong></p>\n<p>For <em>register_pool()</em>, I used a linkedlist to store all VMPools in PageTable. In PageTable, I added a new variable:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// vm pools</span></span><br><span class=\"line\"><span class=\"type\">static</span> VMPool * pool_link_head;</span><br></pre></td></tr></table></figure>\n\n<p>This is the head of all vm_pools. In VMPool, there is a new variable <em>next_pool</em> which point to the next pool. By doing this, I realized the register_pool by adding the pool to the end of the linkedlist in VMPool’s constructor.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::register_pool</span><span class=\"params\">(VMPool * _vm_pool)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   VMPool * node=pool_link_head;</span><br><span class=\"line\">   <span class=\"keyword\">if</span>(node == <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">      pool_link_head = _vm_pool;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span>(node-&gt;next_pool != <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">         node=node-&gt;next_pool;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      node-&gt;next_pool = _vm_pool;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> For <em>free_page()</em>, first calculate the address of the page according to the page_no. Then, based on this address, find the corresponding page table. Set the corresponding pte value to 0. Then release the corresponding frame in the frame pool. Thus realize the release of memory.</p>\n<p><strong>ii. Recursive page table lookup</strong></p>\n<p>This is the menory structure:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n<p>process page faluts: </p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>Firstly, get fault virtual memory address from cr2”</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> faulting_address = <span class=\"built_in\">read_cr2</span>();</span><br></pre></td></tr></table></figure>\n\n<p>Before fault handle, function need to check whether the address belong to a registed VMPool.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// check address in vm pool</span></span><br><span class=\"line\"> <span class=\"type\">bool</span> flag=<span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> VMPool * node = pool_link_head;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// no vm pool, so not make checking</span></span><br><span class=\"line\"> <span class=\"keyword\">if</span>(node == <span class=\"literal\">nullptr</span>) flag =<span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">while</span>(node != <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">   \t<span class=\"comment\">// first two pages, used to store memory usage information</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(faulting_address &gt;= node-&gt;base_address &amp;&amp; faulting_address &lt;= (node-&gt;base_address+PAGE_SIZE*<span class=\"number\">2</span>) )&#123;</span><br><span class=\"line\">       flag=<span class=\"literal\">true</span>;</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// is_legitimate ?</span></span><br><span class=\"line\">    flag = flag || node-&gt;<span class=\"built_in\">is_legitimate</span>(faulting_address);</span><br><span class=\"line\"></span><br><span class=\"line\">    node=node-&gt;next_pool;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>If address is legitimate, get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pd_index = faulting_address &gt;&gt; <span class=\"number\">22</span>; <span class=\"comment\">// index in page dir</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pt_index = (faulting_address &gt;&gt; <span class=\"number\">12</span>) &amp; <span class=\"number\">0b1111111111</span>; <span class=\"comment\">// index in page table</span></span><br></pre></td></tr></table></figure>\n\n<p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!(pd[pd_index] &amp; <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// page table not exist</span></span><br><span class=\"line\">  <span class=\"comment\">// apply a new frame from kernel pool</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>In the end, we apply a new frame from process pool and add it to page table.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> new_frame = process_mem_pool-&gt;<span class=\"built_in\">get_frames</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class=\"number\">3</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"2-VM-Pool\"><a href=\"#2-VM-Pool\" class=\"headerlink\" title=\"2.VM Pool\"></a>2.VM Pool</h4><p>The <code>VMPool</code> class is responsible for managing a virtual memory pool, which includes allocating and releasing memory regions as well as checking the legitimacy of addresses. Here’s a detailed breakdown of each function in the class:</p>\n<ol>\n<li><p><strong>Constructor <code>VMPool</code></strong>: Initializes a virtual memory pool with a given base address, size, frame pool, and page table. It registers the pool with the page table and sets up the data structures for tracking used and free memory regions.</p>\n</li>\n<li><p><strong><code>allocate(unsigned long _size)</code></strong>: The <code>allocate</code> method in the <code>VMPool</code> class is responsible for allocating a region of memory from the virtual memory pool. It uses two arrays (first to frames in frame_pool), <code>used_memory_info</code> and <code>free_memory_info</code>, to track the memory usage. Each entry in these arrays consists of a pair of values, representing the start and end addresses of a memory region. This is structure of <code>used_memory_info</code>:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2019.41.59.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" /></li>\n</ol>\n<ol>\n<li><p><strong><code>release(unsigned long _start_address)</code></strong>: Releases a region of previously allocated memory identified by its start address. It removes the region from the used memory info, adds it back to the free memory info, and releases the corresponding pages in the page table.</p>\n</li>\n<li><p><strong><code>is_legitimate(unsigned long _address)</code></strong>: Checks whether a given address is part of a currently allocated region. It returns <code>true</code> if the address is within the range of an allocated block and <code>false</code> otherwise.</p>\n</li>\n</ol>\n<p>Additionally, the class has private member variables for storing the size of the pool, pointers to the frame pool and page table, and arrays for tracking used and free memory regions. It also defines a constant <code>PAGE_SIZE</code> for the page size and has a public member variable <code>base_address</code> for the base address of the pool.</p>\n<h3 id=\"Testing\"><a href=\"#Testing\" class=\"headerlink\" title=\"Testing:\"></a><strong>Testing</strong>:</h3><p><strong><em>TEST_PAGE_TABLE</em> (Passed)</strong> :</p>\n<p>This test is designed to evaluate the implementation of page tables by accessing and writing to unmapped virtual memory. It determines the correctness of the page table implementation by verifying whether data can be accurately written to and read from virtual addresses.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> FAULT_ADDR (4 * 1024 * 1024) <span class=\"comment\">// 4 MB, Address used to cause page faults in the test.</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NACCESS ((1 MB) / 4) <span class=\"comment\">// (1 MB) / 4, Number of integer accesses (4 bytes each) starting from FAULT_ADDR.</span></span></span><br></pre></td></tr></table></figure>\n\n<p>I also extended this test from “(1 MB) / 4” to “(27 MB) / 4”. This is because the physics address space it 32MB. The first 4MB is direct mapped and 15-16MB is the memory hole. So, there is total 27MB can be mapped. For “(27 MB) / 4”, my code can pass the test too.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.56.06.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<p><strong><em>TEST_VM_POOL</em> (Passed)</strong> :</p>\n<p>This test involves memory allocation and release operations. It tests the ability to correctly handle memory allocation and release requests, ensuring that memory is properly allocated when requested and correctly freed when no longer needed. </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> *arr = <span class=\"keyword\">new</span> <span class=\"type\">int</span>[size2 * i]; <span class=\"comment\">// allocate</span></span><br><span class=\"line\"><span class=\"keyword\">delete</span>[] arr; <span class=\"comment\">// release</span></span><br></pre></td></tr></table></figure>\n\n<p>My code prints out the IDs of the allocated memory frames and the frames released during the release process. Upon inspection, my vm_pool can correctly allocate and release frames.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.54.45.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n","site":{"data":{}},"excerpt":"","more":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<ul>\n<li>page table.H/C</li>\n<li>vm_pool.H/C</li>\n<li>copykernel.sh<ul>\n<li>Modified to fit Mac OS</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Design\"><a href=\"#Design\" class=\"headerlink\" title=\"Design\"></a>Design</h3><h4 id=\"1-Page-Table\"><a href=\"#1-Page-Table\" class=\"headerlink\" title=\"1. Page Table\"></a>1. Page Table</h4><p><strong>i. Extension of page table manager</strong></p>\n<p>For <em>register_pool()</em>, I used a linkedlist to store all VMPools in PageTable. In PageTable, I added a new variable:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// vm pools</span></span><br><span class=\"line\"><span class=\"type\">static</span> VMPool * pool_link_head;</span><br></pre></td></tr></table></figure>\n\n<p>This is the head of all vm_pools. In VMPool, there is a new variable <em>next_pool</em> which point to the next pool. By doing this, I realized the register_pool by adding the pool to the end of the linkedlist in VMPool’s constructor.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PageTable::register_pool</span><span class=\"params\">(VMPool * _vm_pool)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   VMPool * node=pool_link_head;</span><br><span class=\"line\">   <span class=\"keyword\">if</span>(node == <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">      pool_link_head = _vm_pool;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span>(node-&gt;next_pool != <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">         node=node-&gt;next_pool;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      node-&gt;next_pool = _vm_pool;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> For <em>free_page()</em>, first calculate the address of the page according to the page_no. Then, based on this address, find the corresponding page table. Set the corresponding pte value to 0. Then release the corresponding frame in the frame pool. Thus realize the release of memory.</p>\n<p><strong>ii. Recursive page table lookup</strong></p>\n<p>This is the menory structure:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-23%20at%2022.05.15.png\" alt=\"图片替换文本\" width=\"350\" align=\"bottom\" />\n\n<p>process page faluts: </p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-02-25%20at%2010.43.20.png\" alt=\"图片替换文本\" width=\"500\" align=\"bottom\" />\n\n\n\n<p>Firstly, get fault virtual memory address from cr2”</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> faulting_address = <span class=\"built_in\">read_cr2</span>();</span><br></pre></td></tr></table></figure>\n\n<p>Before fault handle, function need to check whether the address belong to a registed VMPool.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// check address in vm pool</span></span><br><span class=\"line\"> <span class=\"type\">bool</span> flag=<span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> VMPool * node = pool_link_head;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// no vm pool, so not make checking</span></span><br><span class=\"line\"> <span class=\"keyword\">if</span>(node == <span class=\"literal\">nullptr</span>) flag =<span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">while</span>(node != <span class=\"literal\">nullptr</span>)&#123;</span><br><span class=\"line\">   \t<span class=\"comment\">// first two pages, used to store memory usage information</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(faulting_address &gt;= node-&gt;base_address &amp;&amp; faulting_address &lt;= (node-&gt;base_address+PAGE_SIZE*<span class=\"number\">2</span>) )&#123;</span><br><span class=\"line\">       flag=<span class=\"literal\">true</span>;</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// is_legitimate ?</span></span><br><span class=\"line\">    flag = flag || node-&gt;<span class=\"built_in\">is_legitimate</span>(faulting_address);</span><br><span class=\"line\"></span><br><span class=\"line\">    node=node-&gt;next_pool;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>If address is legitimate, get page dir index and page table index from address. pd_index is the top 10 bits and pt_index can get from bits from 12 to 22.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pd_index = faulting_address &gt;&gt; <span class=\"number\">22</span>; <span class=\"comment\">// index in page dir</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> pt_index = (faulting_address &gt;&gt; <span class=\"number\">12</span>) &amp; <span class=\"number\">0b1111111111</span>; <span class=\"comment\">// index in page table</span></span><br></pre></td></tr></table></figure>\n\n<p>For two level page table, may the page table is not exist. We can determine it by check the first bit of pd[pd_index].</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!(pd[pd_index] &amp; <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// page table not exist</span></span><br><span class=\"line\">  <span class=\"comment\">// apply a new frame from kernel pool</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>In the end, we apply a new frame from process pool and add it to page table.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> new_frame = process_mem_pool-&gt;<span class=\"built_in\">get_frames</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">pt[pt_index] = (new_frame * PAGE_SIZE) | <span class=\"number\">3</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"2-VM-Pool\"><a href=\"#2-VM-Pool\" class=\"headerlink\" title=\"2.VM Pool\"></a>2.VM Pool</h4><p>The <code>VMPool</code> class is responsible for managing a virtual memory pool, which includes allocating and releasing memory regions as well as checking the legitimacy of addresses. Here’s a detailed breakdown of each function in the class:</p>\n<ol>\n<li><p><strong>Constructor <code>VMPool</code></strong>: Initializes a virtual memory pool with a given base address, size, frame pool, and page table. It registers the pool with the page table and sets up the data structures for tracking used and free memory regions.</p>\n</li>\n<li><p><strong><code>allocate(unsigned long _size)</code></strong>: The <code>allocate</code> method in the <code>VMPool</code> class is responsible for allocating a region of memory from the virtual memory pool. It uses two arrays (first to frames in frame_pool), <code>used_memory_info</code> and <code>free_memory_info</code>, to track the memory usage. Each entry in these arrays consists of a pair of values, representing the start and end addresses of a memory region. This is structure of <code>used_memory_info</code>:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2019.41.59.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" /></li>\n</ol>\n<ol>\n<li><p><strong><code>release(unsigned long _start_address)</code></strong>: Releases a region of previously allocated memory identified by its start address. It removes the region from the used memory info, adds it back to the free memory info, and releases the corresponding pages in the page table.</p>\n</li>\n<li><p><strong><code>is_legitimate(unsigned long _address)</code></strong>: Checks whether a given address is part of a currently allocated region. It returns <code>true</code> if the address is within the range of an allocated block and <code>false</code> otherwise.</p>\n</li>\n</ol>\n<p>Additionally, the class has private member variables for storing the size of the pool, pointers to the frame pool and page table, and arrays for tracking used and free memory regions. It also defines a constant <code>PAGE_SIZE</code> for the page size and has a public member variable <code>base_address</code> for the base address of the pool.</p>\n<h3 id=\"Testing\"><a href=\"#Testing\" class=\"headerlink\" title=\"Testing:\"></a><strong>Testing</strong>:</h3><p><strong><em>TEST_PAGE_TABLE</em> (Passed)</strong> :</p>\n<p>This test is designed to evaluate the implementation of page tables by accessing and writing to unmapped virtual memory. It determines the correctness of the page table implementation by verifying whether data can be accurately written to and read from virtual addresses.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> FAULT_ADDR (4 * 1024 * 1024) <span class=\"comment\">// 4 MB, Address used to cause page faults in the test.</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NACCESS ((1 MB) / 4) <span class=\"comment\">// (1 MB) / 4, Number of integer accesses (4 bytes each) starting from FAULT_ADDR.</span></span></span><br></pre></td></tr></table></figure>\n\n<p>I also extended this test from “(1 MB) / 4” to “(27 MB) / 4”. This is because the physics address space it 32MB. The first 4MB is direct mapped and 15-16MB is the memory hole. So, there is total 27MB can be mapped. For “(27 MB) / 4”, my code can pass the test too.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.56.06.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n\n\n\n<p><strong><em>TEST_VM_POOL</em> (Passed)</strong> :</p>\n<p>This test involves memory allocation and release operations. It tests the ability to correctly handle memory allocation and release requests, ensuring that memory is properly allocated when requested and correctly freed when no longer needed. </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> *arr = <span class=\"keyword\">new</span> <span class=\"type\">int</span>[size2 * i]; <span class=\"comment\">// allocate</span></span><br><span class=\"line\"><span class=\"keyword\">delete</span>[] arr; <span class=\"comment\">// release</span></span><br></pre></td></tr></table></figure>\n\n<p>My code prints out the IDs of the allocated memory frames and the frames released during the release process. Upon inspection, my vm_pool can correctly allocate and release frames.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-18%20at%2010.54.45.png\" alt=\"图片替换文本\" width=\"700\" align=\"bottom\" />\n"},{"title":"CSCE611-OS-Project05-Process","date":"2024-03-26T19:30:18.000Z","_content":"\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n1.**Scheduler and RR Scheduler**:\n\n- Add rr_scheduler.C/H\n- kernel.C : support rr_scheudler\n- interrupt.C/H : enable interrupt\n- thread.C/H: enable interrupt\n- copykernel.sh: Modified to fit Mac OS\n\n3.**Process**:\n\n- Add process.C/H\n- Add rr_scheduler.C/H\n- kernel.C\n- interrupt.C/H\n- thread.C/H\n- Add cont_frame_pool.C/H\n- Add vm_pool.C/H\n- Add page_table.C/H\n- copykernel.sh: Modified to fit Mac OS\n\n\n\n### 1. FIFO Scheduler\n\nIn the `Scheduler`, implement a queue using `LinkedList` to store `Threads`. Each time `Resume` is called, insert the thread at the end of the queue. When `yield` is called, pop the first thread from the queue and switch to it using `Thread::dispatch_to(Thread * _thread)`.\n\nDesign of LinkedList: \n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.42.01.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n1. `resume (append)`: This indicates that when a new thread is created or when a suspended thread is to be resumed, it is appended to the end of the queue.\n2. `yield (pop)`: When function yield is called, scheduler will pop the first thread in ready queue and the use `Thread::dispatch_to` to start this thread.\n3. Finally, `Thread::dispatch_to:` will use the low level `asm` code to set the current thread's stack to hardware to start the thread. \n\nTo terminate a thread, two steps are involved: 1. releasing memory, and 2. removing the thread from the scheduler. To obtain the stack address of the current thread, I added a `Thread::Stack()` function.\n\n```c++\nstatic void thread_shutdown() {\n    MEMORY_POOL->release((long unsigned int) current_thread->Stack());\n    SYSTEM_SCHEDULER->terminate(current_thread);\n}\n```\n\n**TEST:**\n\nLaunch the kernel, the output of threads shows on UI:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.51.27.png\" alt=\"图片替换文本\" width=\"650\" align=\"bottom\" />\n\nWe can observe that threads are executed sequentially.\n\n### 2.Enable Interrupt (bonus 1)\n\nWithin the `Thread` class, in the `Thread::thread_start` function, add `Machine::enable_interrupts();`.\n\nIn the scheduler, before `resume` and `yield`, call `Machine::disable_interrupts()` to prevent interrupts from occurring during a process switch. The worst-case scenario is when an interrupt occurs during an active process switch, causing the switch to terminate prematurely, and simultaneously triggering a process switch via `rr_schedule`, which would result in an erroneous switch.\n\nThe test for interrupt is in the RR Scheduler.\n\n### 3.Round-Robin Scheduler (bonus 2)\n\nTo control the activation of the round-robin (RR) scheduler, a `scheduler_conf.H` file has been added. Additionally, an `eoq_timer` has been introduced, with its constructor taking an `RRScheduler`. Every 50ms, an interrupt is triggered, and `EOQTimer::handle_interrupt` calls the scheduler's `resume` and `yield` methods to implement thread preemption.\n\nThe implementation of `Interrupt` has been modified to add a function `InterruptHandler::send_end_of_interrupt(REGS * _r)`. In the scheduler, before switching to the next thread, `send_end_of_interrupt` is called to indicate the end of the current interrupt handling, ensuring that `Interrupt` can continue processing interrupts. Moreover, in `InterruptHandler::dispatch_interrupt`, `if(int_no!=0) send_end_of_interrupt(_r);` is added to indicate that the timer interrupt is handled by the scheduler, preventing the redundant sending of interrupt end signals.\n\n**TEST: **\n\n>  In the top of kernel.c, use `#define _ENABLE_RR_SCHEDULER_` to switch to RR_Scheduler.\n\nAccording to the figure below, we can see that thread switching includes not only the switching of threads after the \"BURST execution\", but also periodic preemption switching\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.25.09.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n\n\n### 4.Processes (bonus 3)\n\nAfter a discussion with the professor. In my operating system project, I have implemented a `kernel process system` with the following features and details:\n\n- Ported the memory pool from previous assignments (MP2 to MP4) to the new project (MP5).\n\n- Enabled virtual memory and implemented a `Process` class. During the initialization of a `Process`, two virtual memory pools are declared: `kernel_mem_pool` (3MB-4MB) for internal objects of the process (e.g., stack, which requires direct mapping) and `process_mem_pool` (4MB-256MB) for allocating memory to threads during runtime, providing them with new page tables and address spaces.\n  \n  ```c++\n  Process::Process(unsigned long address_space_size);\n  ```\n\n  Within the constructor, the process initially switches to the `kernel_page_table` and `kernel_obj_pool`. It then uses the `new` operator to allocate memory for the process's page table and virtual memory pools, setting up the necessary environment for process execution.\n  \n- **Memory Management: ** \n  \n  - Frame Pools: I used two frame pools: `kernel_frame_pool` and `process_frame_pool`\n  - I utilized three virtual memory (VM) pools: `kernel_obj_pool`, `kernel_vm_pool`, and `process_vm_pool`:\n    1. **`kernel_obj_pool`** (2MB - 3MB): This pool is reserved for kernel objects, such as the kernel page table. When the kernel needs to define a new object, like a new process, it switches to the `kernel_obj_pool` and uses the `new` operator to allocate memory for it.\n    2. **`kernel_vm_pool`** (3MB - 4MB): This pool is used for the kernel stacks of threads. Each thread's kernel stack is allocated from this pool to ensure have a dedicated memory space.\n    3. **`process_vm_pool`**(4MB - 256MB): This pool is used for the execution of processes. When a thread starts, the kernel sets `current_thread` to the thread's process VM pool, allowing the process to allocate objects within its own address space.\n  \n  \n  ![Screenshot 2024-03-29 at 20.53.46](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.53.46.png)\n  \n- Retained the `Thread` class, similar to the original design, containing an `esp` attribute to store the current process's stack address, code segment, etc. It includes `push` and `set_context` functions to establish the context of the process. \n  Additionally, due to threads belonging to different address spaces, a page table address for the current address space is added to the `Thread` class (passed in from the process).\n\n  The constructor and functions of the `Thread` class is designed as follows:\n\n  ```c++\n  Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size);\n  \n  void Thread::set_process(Process * _process);\n  \n  void Thread::set_pt(PageTable * pt);\n  ```\n\n- **Thread Management:** Added an `add_thread` function to the `Process` class, allowing the addition of a new thread to the process. This function first disables interrupts, then switch to page table of current process, and then allocates memory from the `kernel_vm_pool` for the stack. It creates a new `Thread` object, and adds it to the scheduler's queue (without implementing \"Thread level scheduling\").\n\n  ```c++\n  Process::add_proces(Thread_Function _tf, int _stack_size)\n  ```\n\n- When the `RRScheduler` handles thread switching, it first compares the page table of the next thread with the current one. If they are different, the new page table is loaded into the register (pt->load()) and `current_pool` will be set to `process_vm_pool` of current process.. Since the first 4MB is directly mapped to the kernel pool, switching page tables does not affect system operation.\n  ```c++\n  Console::puts(\"Switch CURRENT_POOL \\n\"); \n  CURRENT_POOL = current_thread->process->process_pool;\n  \n  PageTable * pt_ = current_thread->pt;\n  pt_->load();\n  ```\n\n- With this setup, multiple threads can be continuously added to a process, and these threads will share the same address space.\n\n\n\n**TEST: **\n\nFor testing, two processes are started: `process1` contains `Thread1` and `Thread3`, while `process2` contains `Thread2` and `Thread4`. \n\n```c++\n// 2 processes and 4 threads\nprocess1.add_thread(fun1, 1024);\nprocess2.add_thread(fun2, 1024);\nprocess1.add_thread(fun3, 1024);\nprocess2.add_thread(fun4, 1024);\n```\n\nIn the test, each thread accumulates its ticks in the memory location at 32MB + ThreadID. The expected result is that the ticks for threads within the same process are visible to each other, while the other locations are 0. \n\n>addr[1]                 addr[2]                 addr[3]                addr[4]\n>\n>[thread1's tick]   [thread2's tick]   [thread3's tick]   [thread4's tick]\n\nThe test code and output (which meets expectations) is as follows:\n\n  ```c++\n  unsigned long tick_addr = 32 MB;\n  \n  void fun1() {\n      Console::puts(\"Thread: \"); Console::puti(Thread::CurrentThread()->ThreadId()); Console::puts(\"\\n\");\n      Console::puts(\"FUN 1 INVOKED!\\n\");\n      int id=1;\n      unsigned long * addr = (unsigned long *)(tick_addr);\n      addr[id]=0;\n  \n  \t\t// _TERMINATING_FUNCTIONS_\n  \t\tfor(int j = 0; j < 10; j++) {\t\n          Console::puts(\"FUN 1 IN BURST[\"); Console::puti(j); Console::puts(\"]\\n\");\n          for (int i = 0; i < 10; i++) {\n              Console::puts(\"FUN 1: TICK [\"); Console::puti(i); Console::puts(\"]\\n\");\n  \n            \t// add tick to memory\n             \tunsigned long * addr = (unsigned long *)(tick_addr);\n              addr[id]+=id;\n          }\n          pass_on_CPU(thread2);\n      }\n  \n      Console::puts(\"====== FUN 1 ======\\n\");\n      for(int i=1;i<=4;i++){\n          unsigned long * addr = (unsigned long *)(tick_addr);\n          Console::puts(\"TICK in Idx \"); \n          Console::puti(i); \n          Console::puts(\", Num: \"); \n          Console::puti(addr[i]);\n          Console::puts(\"]\\n\");\n      }\n      return;\n  }\n  \n  ```\n**Test Output:**\n\n  ```python\n  # Thread 3 finished firstly. \n  # Got 92 ticks from Thread 1. (because thread 1 haven't stop, so not 100)\n  # Get 300 ticks Thread 3(itself)\n  # Got 0 ticks from Thread 2 and Thread 4. (since Thread 2 and Thread 4 belong to the different address sapce)\n  ====== FUN 3 ======\n  TICK in Idx 1, Num: 92\n  TICK in Idx 2, Num: 0\n  TICK in Idx 3, Num: 300\n  TICK in Idx 4, Num: 0\n  \n  # Thread 2 finished. \n  # Got 368 ticks from Thread 4. (because thread 4 haven't stop, so not 400)\n  # Got 200 ticks from Thread 2. (itself) \n  # Got 0 ticks from Thread 2 and Thread 4.\n  ====== FUN 2 ======\n  TICK in Idx 1, Num: 0\n  TICK in Idx 2, Num: 200\n  TICK in Idx 3, Num: 0\n  TICK in Idx 4, Num: 368\n  \n  ====== FUN 4 ======\n  TICK in Idx 1, Num: 0\n  TICK in Idx 2, Num: 200\n  TICK in Idx 3, Num: 0\n  TICK in Idx 4, Num: 400\n  \n  ====== FUN 1 ======\n  TICK in Idx 1, Num: 100\n  TICK in Idx 2, Num: 0\n  TICK in Idx 3, Num: 300\n  TICK in Idx 4, Num: 0\n  ```\n\nSo this test verified that Process1 and Process2 have different address Spaces. This test also verified the accuracy of Thread running (according to Tick number), thread switching and page table switching.\n\nThis proves that I have completed a basic kernel process.\n","source":"_posts/CSCE611-OS-Project05-Process.md","raw":"---\ntitle: CSCE611-OS-Project05-Process\ndate: 2024-03-26 12:30:18\ntags:\n---\n\nGithub Link: https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\n\nFiles I modified: \n\n1.**Scheduler and RR Scheduler**:\n\n- Add rr_scheduler.C/H\n- kernel.C : support rr_scheudler\n- interrupt.C/H : enable interrupt\n- thread.C/H: enable interrupt\n- copykernel.sh: Modified to fit Mac OS\n\n3.**Process**:\n\n- Add process.C/H\n- Add rr_scheduler.C/H\n- kernel.C\n- interrupt.C/H\n- thread.C/H\n- Add cont_frame_pool.C/H\n- Add vm_pool.C/H\n- Add page_table.C/H\n- copykernel.sh: Modified to fit Mac OS\n\n\n\n### 1. FIFO Scheduler\n\nIn the `Scheduler`, implement a queue using `LinkedList` to store `Threads`. Each time `Resume` is called, insert the thread at the end of the queue. When `yield` is called, pop the first thread from the queue and switch to it using `Thread::dispatch_to(Thread * _thread)`.\n\nDesign of LinkedList: \n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.42.01.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n1. `resume (append)`: This indicates that when a new thread is created or when a suspended thread is to be resumed, it is appended to the end of the queue.\n2. `yield (pop)`: When function yield is called, scheduler will pop the first thread in ready queue and the use `Thread::dispatch_to` to start this thread.\n3. Finally, `Thread::dispatch_to:` will use the low level `asm` code to set the current thread's stack to hardware to start the thread. \n\nTo terminate a thread, two steps are involved: 1. releasing memory, and 2. removing the thread from the scheduler. To obtain the stack address of the current thread, I added a `Thread::Stack()` function.\n\n```c++\nstatic void thread_shutdown() {\n    MEMORY_POOL->release((long unsigned int) current_thread->Stack());\n    SYSTEM_SCHEDULER->terminate(current_thread);\n}\n```\n\n**TEST:**\n\nLaunch the kernel, the output of threads shows on UI:\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.51.27.png\" alt=\"图片替换文本\" width=\"650\" align=\"bottom\" />\n\nWe can observe that threads are executed sequentially.\n\n### 2.Enable Interrupt (bonus 1)\n\nWithin the `Thread` class, in the `Thread::thread_start` function, add `Machine::enable_interrupts();`.\n\nIn the scheduler, before `resume` and `yield`, call `Machine::disable_interrupts()` to prevent interrupts from occurring during a process switch. The worst-case scenario is when an interrupt occurs during an active process switch, causing the switch to terminate prematurely, and simultaneously triggering a process switch via `rr_schedule`, which would result in an erroneous switch.\n\nThe test for interrupt is in the RR Scheduler.\n\n### 3.Round-Robin Scheduler (bonus 2)\n\nTo control the activation of the round-robin (RR) scheduler, a `scheduler_conf.H` file has been added. Additionally, an `eoq_timer` has been introduced, with its constructor taking an `RRScheduler`. Every 50ms, an interrupt is triggered, and `EOQTimer::handle_interrupt` calls the scheduler's `resume` and `yield` methods to implement thread preemption.\n\nThe implementation of `Interrupt` has been modified to add a function `InterruptHandler::send_end_of_interrupt(REGS * _r)`. In the scheduler, before switching to the next thread, `send_end_of_interrupt` is called to indicate the end of the current interrupt handling, ensuring that `Interrupt` can continue processing interrupts. Moreover, in `InterruptHandler::dispatch_interrupt`, `if(int_no!=0) send_end_of_interrupt(_r);` is added to indicate that the timer interrupt is handled by the scheduler, preventing the redundant sending of interrupt end signals.\n\n**TEST: **\n\n>  In the top of kernel.c, use `#define _ENABLE_RR_SCHEDULER_` to switch to RR_Scheduler.\n\nAccording to the figure below, we can see that thread switching includes not only the switching of threads after the \"BURST execution\", but also periodic preemption switching\n\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.25.09.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n\n\n### 4.Processes (bonus 3)\n\nAfter a discussion with the professor. In my operating system project, I have implemented a `kernel process system` with the following features and details:\n\n- Ported the memory pool from previous assignments (MP2 to MP4) to the new project (MP5).\n\n- Enabled virtual memory and implemented a `Process` class. During the initialization of a `Process`, two virtual memory pools are declared: `kernel_mem_pool` (3MB-4MB) for internal objects of the process (e.g., stack, which requires direct mapping) and `process_mem_pool` (4MB-256MB) for allocating memory to threads during runtime, providing them with new page tables and address spaces.\n  \n  ```c++\n  Process::Process(unsigned long address_space_size);\n  ```\n\n  Within the constructor, the process initially switches to the `kernel_page_table` and `kernel_obj_pool`. It then uses the `new` operator to allocate memory for the process's page table and virtual memory pools, setting up the necessary environment for process execution.\n  \n- **Memory Management: ** \n  \n  - Frame Pools: I used two frame pools: `kernel_frame_pool` and `process_frame_pool`\n  - I utilized three virtual memory (VM) pools: `kernel_obj_pool`, `kernel_vm_pool`, and `process_vm_pool`:\n    1. **`kernel_obj_pool`** (2MB - 3MB): This pool is reserved for kernel objects, such as the kernel page table. When the kernel needs to define a new object, like a new process, it switches to the `kernel_obj_pool` and uses the `new` operator to allocate memory for it.\n    2. **`kernel_vm_pool`** (3MB - 4MB): This pool is used for the kernel stacks of threads. Each thread's kernel stack is allocated from this pool to ensure have a dedicated memory space.\n    3. **`process_vm_pool`**(4MB - 256MB): This pool is used for the execution of processes. When a thread starts, the kernel sets `current_thread` to the thread's process VM pool, allowing the process to allocate objects within its own address space.\n  \n  \n  ![Screenshot 2024-03-29 at 20.53.46](https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.53.46.png)\n  \n- Retained the `Thread` class, similar to the original design, containing an `esp` attribute to store the current process's stack address, code segment, etc. It includes `push` and `set_context` functions to establish the context of the process. \n  Additionally, due to threads belonging to different address spaces, a page table address for the current address space is added to the `Thread` class (passed in from the process).\n\n  The constructor and functions of the `Thread` class is designed as follows:\n\n  ```c++\n  Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size);\n  \n  void Thread::set_process(Process * _process);\n  \n  void Thread::set_pt(PageTable * pt);\n  ```\n\n- **Thread Management:** Added an `add_thread` function to the `Process` class, allowing the addition of a new thread to the process. This function first disables interrupts, then switch to page table of current process, and then allocates memory from the `kernel_vm_pool` for the stack. It creates a new `Thread` object, and adds it to the scheduler's queue (without implementing \"Thread level scheduling\").\n\n  ```c++\n  Process::add_proces(Thread_Function _tf, int _stack_size)\n  ```\n\n- When the `RRScheduler` handles thread switching, it first compares the page table of the next thread with the current one. If they are different, the new page table is loaded into the register (pt->load()) and `current_pool` will be set to `process_vm_pool` of current process.. Since the first 4MB is directly mapped to the kernel pool, switching page tables does not affect system operation.\n  ```c++\n  Console::puts(\"Switch CURRENT_POOL \\n\"); \n  CURRENT_POOL = current_thread->process->process_pool;\n  \n  PageTable * pt_ = current_thread->pt;\n  pt_->load();\n  ```\n\n- With this setup, multiple threads can be continuously added to a process, and these threads will share the same address space.\n\n\n\n**TEST: **\n\nFor testing, two processes are started: `process1` contains `Thread1` and `Thread3`, while `process2` contains `Thread2` and `Thread4`. \n\n```c++\n// 2 processes and 4 threads\nprocess1.add_thread(fun1, 1024);\nprocess2.add_thread(fun2, 1024);\nprocess1.add_thread(fun3, 1024);\nprocess2.add_thread(fun4, 1024);\n```\n\nIn the test, each thread accumulates its ticks in the memory location at 32MB + ThreadID. The expected result is that the ticks for threads within the same process are visible to each other, while the other locations are 0. \n\n>addr[1]                 addr[2]                 addr[3]                addr[4]\n>\n>[thread1's tick]   [thread2's tick]   [thread3's tick]   [thread4's tick]\n\nThe test code and output (which meets expectations) is as follows:\n\n  ```c++\n  unsigned long tick_addr = 32 MB;\n  \n  void fun1() {\n      Console::puts(\"Thread: \"); Console::puti(Thread::CurrentThread()->ThreadId()); Console::puts(\"\\n\");\n      Console::puts(\"FUN 1 INVOKED!\\n\");\n      int id=1;\n      unsigned long * addr = (unsigned long *)(tick_addr);\n      addr[id]=0;\n  \n  \t\t// _TERMINATING_FUNCTIONS_\n  \t\tfor(int j = 0; j < 10; j++) {\t\n          Console::puts(\"FUN 1 IN BURST[\"); Console::puti(j); Console::puts(\"]\\n\");\n          for (int i = 0; i < 10; i++) {\n              Console::puts(\"FUN 1: TICK [\"); Console::puti(i); Console::puts(\"]\\n\");\n  \n            \t// add tick to memory\n             \tunsigned long * addr = (unsigned long *)(tick_addr);\n              addr[id]+=id;\n          }\n          pass_on_CPU(thread2);\n      }\n  \n      Console::puts(\"====== FUN 1 ======\\n\");\n      for(int i=1;i<=4;i++){\n          unsigned long * addr = (unsigned long *)(tick_addr);\n          Console::puts(\"TICK in Idx \"); \n          Console::puti(i); \n          Console::puts(\", Num: \"); \n          Console::puti(addr[i]);\n          Console::puts(\"]\\n\");\n      }\n      return;\n  }\n  \n  ```\n**Test Output:**\n\n  ```python\n  # Thread 3 finished firstly. \n  # Got 92 ticks from Thread 1. (because thread 1 haven't stop, so not 100)\n  # Get 300 ticks Thread 3(itself)\n  # Got 0 ticks from Thread 2 and Thread 4. (since Thread 2 and Thread 4 belong to the different address sapce)\n  ====== FUN 3 ======\n  TICK in Idx 1, Num: 92\n  TICK in Idx 2, Num: 0\n  TICK in Idx 3, Num: 300\n  TICK in Idx 4, Num: 0\n  \n  # Thread 2 finished. \n  # Got 368 ticks from Thread 4. (because thread 4 haven't stop, so not 400)\n  # Got 200 ticks from Thread 2. (itself) \n  # Got 0 ticks from Thread 2 and Thread 4.\n  ====== FUN 2 ======\n  TICK in Idx 1, Num: 0\n  TICK in Idx 2, Num: 200\n  TICK in Idx 3, Num: 0\n  TICK in Idx 4, Num: 368\n  \n  ====== FUN 4 ======\n  TICK in Idx 1, Num: 0\n  TICK in Idx 2, Num: 200\n  TICK in Idx 3, Num: 0\n  TICK in Idx 4, Num: 400\n  \n  ====== FUN 1 ======\n  TICK in Idx 1, Num: 100\n  TICK in Idx 2, Num: 0\n  TICK in Idx 3, Num: 300\n  TICK in Idx 4, Num: 0\n  ```\n\nSo this test verified that Process1 and Process2 have different address Spaces. This test also verified the accuracy of Thread running (according to Tick number), thread switching and page table switching.\n\nThis proves that I have completed a basic kernel process.\n","slug":"CSCE611-OS-Project05-Process","published":1,"updated":"2024-03-30T21:37:30.846Z","_id":"cludgda7t0000d6okdmhw5lev","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<p>1.<strong>Scheduler and RR Scheduler</strong>:</p>\n<ul>\n<li>Add rr_scheduler.C/H</li>\n<li>kernel.C : support rr_scheudler</li>\n<li>interrupt.C/H : enable interrupt</li>\n<li>thread.C/H: enable interrupt</li>\n<li>copykernel.sh: Modified to fit Mac OS</li>\n</ul>\n<p>3.<strong>Process</strong>:</p>\n<ul>\n<li>Add process.C/H</li>\n<li>Add rr_scheduler.C/H</li>\n<li>kernel.C</li>\n<li>interrupt.C/H</li>\n<li>thread.C/H</li>\n<li>Add cont_frame_pool.C/H</li>\n<li>Add vm_pool.C/H</li>\n<li>Add page_table.C/H</li>\n<li>copykernel.sh: Modified to fit Mac OS</li>\n</ul>\n<h3 id=\"1-FIFO-Scheduler\"><a href=\"#1-FIFO-Scheduler\" class=\"headerlink\" title=\"1. FIFO Scheduler\"></a>1. FIFO Scheduler</h3><p>In the <code>Scheduler</code>, implement a queue using <code>LinkedList</code> to store <code>Threads</code>. Each time <code>Resume</code> is called, insert the thread at the end of the queue. When <code>yield</code> is called, pop the first thread from the queue and switch to it using <code>Thread::dispatch_to(Thread * _thread)</code>.</p>\n<p>Design of LinkedList: </p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.42.01.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n<ol>\n<li><code>resume (append)</code>: This indicates that when a new thread is created or when a suspended thread is to be resumed, it is appended to the end of the queue.</li>\n<li><code>yield (pop)</code>: When function yield is called, scheduler will pop the first thread in ready queue and the use <code>Thread::dispatch_to</code> to start this thread.</li>\n<li>Finally, <code>Thread::dispatch_to:</code> will use the low level <code>asm</code> code to set the current thread’s stack to hardware to start the thread. </li>\n</ol>\n<p>To terminate a thread, two steps are involved: 1. releasing memory, and 2. removing the thread from the scheduler. To obtain the stack address of the current thread, I added a <code>Thread::Stack()</code> function.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">thread_shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    MEMORY_POOL-&gt;<span class=\"built_in\">release</span>((<span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>) current_thread-&gt;<span class=\"built_in\">Stack</span>());</span><br><span class=\"line\">    SYSTEM_SCHEDULER-&gt;<span class=\"built_in\">terminate</span>(current_thread);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>TEST:</strong></p>\n<p>Launch the kernel, the output of threads shows on UI:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.51.27.png\" alt=\"图片替换文本\" width=\"650\" align=\"bottom\" />\n\n<p>We can observe that threads are executed sequentially.</p>\n<h3 id=\"2-Enable-Interrupt-bonus-1\"><a href=\"#2-Enable-Interrupt-bonus-1\" class=\"headerlink\" title=\"2.Enable Interrupt (bonus 1)\"></a>2.Enable Interrupt (bonus 1)</h3><p>Within the <code>Thread</code> class, in the <code>Thread::thread_start</code> function, add <code>Machine::enable_interrupts();</code>.</p>\n<p>In the scheduler, before <code>resume</code> and <code>yield</code>, call <code>Machine::disable_interrupts()</code> to prevent interrupts from occurring during a process switch. The worst-case scenario is when an interrupt occurs during an active process switch, causing the switch to terminate prematurely, and simultaneously triggering a process switch via <code>rr_schedule</code>, which would result in an erroneous switch.</p>\n<p>The test for interrupt is in the RR Scheduler.</p>\n<h3 id=\"3-Round-Robin-Scheduler-bonus-2\"><a href=\"#3-Round-Robin-Scheduler-bonus-2\" class=\"headerlink\" title=\"3.Round-Robin Scheduler (bonus 2)\"></a>3.Round-Robin Scheduler (bonus 2)</h3><p>To control the activation of the round-robin (RR) scheduler, a <code>scheduler_conf.H</code> file has been added. Additionally, an <code>eoq_timer</code> has been introduced, with its constructor taking an <code>RRScheduler</code>. Every 50ms, an interrupt is triggered, and <code>EOQTimer::handle_interrupt</code> calls the scheduler’s <code>resume</code> and <code>yield</code> methods to implement thread preemption.</p>\n<p>The implementation of <code>Interrupt</code> has been modified to add a function <code>InterruptHandler::send_end_of_interrupt(REGS * _r)</code>. In the scheduler, before switching to the next thread, <code>send_end_of_interrupt</code> is called to indicate the end of the current interrupt handling, ensuring that <code>Interrupt</code> can continue processing interrupts. Moreover, in <code>InterruptHandler::dispatch_interrupt</code>, <code>if(int_no!=0) send_end_of_interrupt(_r);</code> is added to indicate that the timer interrupt is handled by the scheduler, preventing the redundant sending of interrupt end signals.</p>\n<p>**TEST: **</p>\n<blockquote>\n<p> In the top of kernel.c, use <code>#define _ENABLE_RR_SCHEDULER_</code> to switch to RR_Scheduler.</p>\n</blockquote>\n<p>According to the figure below, we can see that thread switching includes not only the switching of threads after the “BURST execution”, but also periodic preemption switching</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.25.09.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n\n\n<h3 id=\"4-Processes-bonus-3\"><a href=\"#4-Processes-bonus-3\" class=\"headerlink\" title=\"4.Processes (bonus 3)\"></a>4.Processes (bonus 3)</h3><p>After a discussion with the professor. In my operating system project, I have implemented a <code>kernel process system</code> with the following features and details:</p>\n<ul>\n<li><p>Ported the memory pool from previous assignments (MP2 to MP4) to the new project (MP5).</p>\n</li>\n<li><p>Enabled virtual memory and implemented a <code>Process</code> class. During the initialization of a <code>Process</code>, two virtual memory pools are declared: <code>kernel_mem_pool</code> (3MB-4MB) for internal objects of the process (e.g., stack, which requires direct mapping) and <code>process_mem_pool</code> (4MB-256MB) for allocating memory to threads during runtime, providing them with new page tables and address spaces.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::<span class=\"built_in\">Process</span>(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> address_space_size);</span><br></pre></td></tr></table></figure>\n\n<p>Within the constructor, the process initially switches to the <code>kernel_page_table</code> and <code>kernel_obj_pool</code>. It then uses the <code>new</code> operator to allocate memory for the process’s page table and virtual memory pools, setting up the necessary environment for process execution.</p>\n</li>\n<li><p>**Memory Management: ** </p>\n<ul>\n<li>Frame Pools: I used two frame pools: <code>kernel_frame_pool</code> and <code>process_frame_pool</code></li>\n<li>I utilized three virtual memory (VM) pools: <code>kernel_obj_pool</code>, <code>kernel_vm_pool</code>, and <code>process_vm_pool</code>:<ol>\n<li><strong><code>kernel_obj_pool</code></strong> (2MB - 3MB): This pool is reserved for kernel objects, such as the kernel page table. When the kernel needs to define a new object, like a new process, it switches to the <code>kernel_obj_pool</code> and uses the <code>new</code> operator to allocate memory for it.</li>\n<li><strong><code>kernel_vm_pool</code></strong> (3MB - 4MB): This pool is used for the kernel stacks of threads. Each thread’s kernel stack is allocated from this pool to ensure have a dedicated memory space.</li>\n<li><strong><code>process_vm_pool</code></strong>(4MB - 256MB): This pool is used for the execution of processes. When a thread starts, the kernel sets <code>current_thread</code> to the thread’s process VM pool, allowing the process to allocate objects within its own address space.</li>\n</ol>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.53.46.png\" alt=\"Screenshot 2024-03-29 at 20.53.46\"></p>\n</li>\n<li><p>Retained the <code>Thread</code> class, similar to the original design, containing an <code>esp</code> attribute to store the current process’s stack address, code segment, etc. It includes <code>push</code> and <code>set_context</code> functions to establish the context of the process.<br>Additionally, due to threads belonging to different address spaces, a page table address for the current address space is added to the <code>Thread</code> class (passed in from the process).</p>\n<p>The constructor and functions of the <code>Thread</code> class is designed as follows:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Thread::<span class=\"built_in\">Thread</span>(Thread_Function _tf, <span class=\"type\">char</span> * _stack, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> _stack_size);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Thread::set_process</span><span class=\"params\">(Process * _process)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Thread::set_pt</span><span class=\"params\">(PageTable * pt)</span></span>;</span><br></pre></td></tr></table></figure></li>\n<li><p><strong>Thread Management:</strong> Added an <code>add_thread</code> function to the <code>Process</code> class, allowing the addition of a new thread to the process. This function first disables interrupts, then switch to page table of current process, and then allocates memory from the <code>kernel_vm_pool</code> for the stack. It creates a new <code>Thread</code> object, and adds it to the scheduler’s queue (without implementing “Thread level scheduling”).</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::<span class=\"built_in\">add_proces</span>(Thread_Function _tf, <span class=\"type\">int</span> _stack_size)</span><br></pre></td></tr></table></figure></li>\n<li><p>When the <code>RRScheduler</code> handles thread switching, it first compares the page table of the next thread with the current one. If they are different, the new page table is loaded into the register (pt-&gt;load()) and <code>current_pool</code> will be set to <code>process_vm_pool</code> of current process.. Since the first 4MB is directly mapped to the kernel pool, switching page tables does not affect system operation.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Switch CURRENT_POOL \\n&quot;</span>); </span><br><span class=\"line\">CURRENT_POOL = current_thread-&gt;process-&gt;process_pool;</span><br><span class=\"line\"></span><br><span class=\"line\">PageTable * pt_ = current_thread-&gt;pt;</span><br><span class=\"line\">pt_-&gt;<span class=\"built_in\">load</span>();</span><br></pre></td></tr></table></figure></li>\n<li><p>With this setup, multiple threads can be continuously added to a process, and these threads will share the same address space.</p>\n</li>\n</ul>\n<p>**TEST: **</p>\n<p>For testing, two processes are started: <code>process1</code> contains <code>Thread1</code> and <code>Thread3</code>, while <code>process2</code> contains <code>Thread2</code> and <code>Thread4</code>. </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 2 processes and 4 threads</span></span><br><span class=\"line\">process1.<span class=\"built_in\">add_thread</span>(fun1, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process2.<span class=\"built_in\">add_thread</span>(fun2, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process1.<span class=\"built_in\">add_thread</span>(fun3, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process2.<span class=\"built_in\">add_thread</span>(fun4, <span class=\"number\">1024</span>);</span><br></pre></td></tr></table></figure>\n\n<p>In the test, each thread accumulates its ticks in the memory location at 32MB + ThreadID. The expected result is that the ticks for threads within the same process are visible to each other, while the other locations are 0. </p>\n<blockquote>\n<p>addr[1]                 addr[2]                 addr[3]                addr[4]</p>\n<p>[thread1’s tick]   [thread2’s tick]   [thread3’s tick]   [thread4’s tick]</p>\n</blockquote>\n<p>The test code and output (which meets expectations) is as follows:</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> tick_addr = <span class=\"number\">32</span> MB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">fun1</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Thread: &quot;</span>); Console::<span class=\"built_in\">puti</span>(Thread::<span class=\"built_in\">CurrentThread</span>()-&gt;<span class=\"built_in\">ThreadId</span>()); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1 INVOKED!\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> id=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">    addr[id]=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// _TERMINATING_FUNCTIONS_</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> j = <span class=\"number\">0</span>; j &lt; <span class=\"number\">10</span>; j++) &#123;\t</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1 IN BURST[&quot;</span>); Console::<span class=\"built_in\">puti</span>(j); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1: TICK [&quot;</span>); Console::<span class=\"built_in\">puti</span>(i); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          \t<span class=\"comment\">// add tick to memory</span></span><br><span class=\"line\">           \t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">            addr[id]+=id;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">pass_on_CPU</span>(thread2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;====== FUN 1 ======\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;i&lt;=<span class=\"number\">4</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;TICK in Idx &quot;</span>); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puti</span>(i); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;, Num: &quot;</span>); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puti</span>(addr[i]);</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Test Output:</strong></p>\n  <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Thread 3 finished firstly. </span></span><br><span class=\"line\"><span class=\"comment\"># Got 92 ticks from Thread 1. (because thread 1 haven&#x27;t stop, so not 100)</span></span><br><span class=\"line\"><span class=\"comment\"># Get 300 ticks Thread 3(itself)</span></span><br><span class=\"line\"><span class=\"comment\"># Got 0 ticks from Thread 2 and Thread 4. (since Thread 2 and Thread 4 belong to the different address sapce)</span></span><br><span class=\"line\">====== FUN <span class=\"number\">3</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">92</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">300</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Thread 2 finished. </span></span><br><span class=\"line\"><span class=\"comment\"># Got 368 ticks from Thread 4. (because thread 4 haven&#x27;t stop, so not 400)</span></span><br><span class=\"line\"><span class=\"comment\"># Got 200 ticks from Thread 2. (itself) </span></span><br><span class=\"line\"><span class=\"comment\"># Got 0 ticks from Thread 2 and Thread 4.</span></span><br><span class=\"line\">====== FUN <span class=\"number\">2</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">200</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">368</span></span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN <span class=\"number\">4</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">200</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">400</span></span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN <span class=\"number\">1</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">100</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">300</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<p>So this test verified that Process1 and Process2 have different address Spaces. This test also verified the accuracy of Thread running (according to Tick number), thread switching and page table switching.</p>\n<p>This proves that I have completed a basic kernel process.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Github Link: <a href=\"https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu\">https://github.com/tamu-edu-students/CSCE410-611-Spring2024-Hanzhong_Liu</a></p>\n<p>Files I modified: </p>\n<p>1.<strong>Scheduler and RR Scheduler</strong>:</p>\n<ul>\n<li>Add rr_scheduler.C/H</li>\n<li>kernel.C : support rr_scheudler</li>\n<li>interrupt.C/H : enable interrupt</li>\n<li>thread.C/H: enable interrupt</li>\n<li>copykernel.sh: Modified to fit Mac OS</li>\n</ul>\n<p>3.<strong>Process</strong>:</p>\n<ul>\n<li>Add process.C/H</li>\n<li>Add rr_scheduler.C/H</li>\n<li>kernel.C</li>\n<li>interrupt.C/H</li>\n<li>thread.C/H</li>\n<li>Add cont_frame_pool.C/H</li>\n<li>Add vm_pool.C/H</li>\n<li>Add page_table.C/H</li>\n<li>copykernel.sh: Modified to fit Mac OS</li>\n</ul>\n<h3 id=\"1-FIFO-Scheduler\"><a href=\"#1-FIFO-Scheduler\" class=\"headerlink\" title=\"1. FIFO Scheduler\"></a>1. FIFO Scheduler</h3><p>In the <code>Scheduler</code>, implement a queue using <code>LinkedList</code> to store <code>Threads</code>. Each time <code>Resume</code> is called, insert the thread at the end of the queue. When <code>yield</code> is called, pop the first thread from the queue and switch to it using <code>Thread::dispatch_to(Thread * _thread)</code>.</p>\n<p>Design of LinkedList: </p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.42.01.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n<ol>\n<li><code>resume (append)</code>: This indicates that when a new thread is created or when a suspended thread is to be resumed, it is appended to the end of the queue.</li>\n<li><code>yield (pop)</code>: When function yield is called, scheduler will pop the first thread in ready queue and the use <code>Thread::dispatch_to</code> to start this thread.</li>\n<li>Finally, <code>Thread::dispatch_to:</code> will use the low level <code>asm</code> code to set the current thread’s stack to hardware to start the thread. </li>\n</ol>\n<p>To terminate a thread, two steps are involved: 1. releasing memory, and 2. removing the thread from the scheduler. To obtain the stack address of the current thread, I added a <code>Thread::Stack()</code> function.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">thread_shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    MEMORY_POOL-&gt;<span class=\"built_in\">release</span>((<span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>) current_thread-&gt;<span class=\"built_in\">Stack</span>());</span><br><span class=\"line\">    SYSTEM_SCHEDULER-&gt;<span class=\"built_in\">terminate</span>(current_thread);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>TEST:</strong></p>\n<p>Launch the kernel, the output of threads shows on UI:</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2019.51.27.png\" alt=\"图片替换文本\" width=\"650\" align=\"bottom\" />\n\n<p>We can observe that threads are executed sequentially.</p>\n<h3 id=\"2-Enable-Interrupt-bonus-1\"><a href=\"#2-Enable-Interrupt-bonus-1\" class=\"headerlink\" title=\"2.Enable Interrupt (bonus 1)\"></a>2.Enable Interrupt (bonus 1)</h3><p>Within the <code>Thread</code> class, in the <code>Thread::thread_start</code> function, add <code>Machine::enable_interrupts();</code>.</p>\n<p>In the scheduler, before <code>resume</code> and <code>yield</code>, call <code>Machine::disable_interrupts()</code> to prevent interrupts from occurring during a process switch. The worst-case scenario is when an interrupt occurs during an active process switch, causing the switch to terminate prematurely, and simultaneously triggering a process switch via <code>rr_schedule</code>, which would result in an erroneous switch.</p>\n<p>The test for interrupt is in the RR Scheduler.</p>\n<h3 id=\"3-Round-Robin-Scheduler-bonus-2\"><a href=\"#3-Round-Robin-Scheduler-bonus-2\" class=\"headerlink\" title=\"3.Round-Robin Scheduler (bonus 2)\"></a>3.Round-Robin Scheduler (bonus 2)</h3><p>To control the activation of the round-robin (RR) scheduler, a <code>scheduler_conf.H</code> file has been added. Additionally, an <code>eoq_timer</code> has been introduced, with its constructor taking an <code>RRScheduler</code>. Every 50ms, an interrupt is triggered, and <code>EOQTimer::handle_interrupt</code> calls the scheduler’s <code>resume</code> and <code>yield</code> methods to implement thread preemption.</p>\n<p>The implementation of <code>Interrupt</code> has been modified to add a function <code>InterruptHandler::send_end_of_interrupt(REGS * _r)</code>. In the scheduler, before switching to the next thread, <code>send_end_of_interrupt</code> is called to indicate the end of the current interrupt handling, ensuring that <code>Interrupt</code> can continue processing interrupts. Moreover, in <code>InterruptHandler::dispatch_interrupt</code>, <code>if(int_no!=0) send_end_of_interrupt(_r);</code> is added to indicate that the timer interrupt is handled by the scheduler, preventing the redundant sending of interrupt end signals.</p>\n<p>**TEST: **</p>\n<blockquote>\n<p> In the top of kernel.c, use <code>#define _ENABLE_RR_SCHEDULER_</code> to switch to RR_Scheduler.</p>\n</blockquote>\n<p>According to the figure below, we can see that thread switching includes not only the switching of threads after the “BURST execution”, but also periodic preemption switching</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.25.09.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n\n\n<h3 id=\"4-Processes-bonus-3\"><a href=\"#4-Processes-bonus-3\" class=\"headerlink\" title=\"4.Processes (bonus 3)\"></a>4.Processes (bonus 3)</h3><p>After a discussion with the professor. In my operating system project, I have implemented a <code>kernel process system</code> with the following features and details:</p>\n<ul>\n<li><p>Ported the memory pool from previous assignments (MP2 to MP4) to the new project (MP5).</p>\n</li>\n<li><p>Enabled virtual memory and implemented a <code>Process</code> class. During the initialization of a <code>Process</code>, two virtual memory pools are declared: <code>kernel_mem_pool</code> (3MB-4MB) for internal objects of the process (e.g., stack, which requires direct mapping) and <code>process_mem_pool</code> (4MB-256MB) for allocating memory to threads during runtime, providing them with new page tables and address spaces.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::<span class=\"built_in\">Process</span>(<span class=\"type\">unsigned</span> <span class=\"type\">long</span> address_space_size);</span><br></pre></td></tr></table></figure>\n\n<p>Within the constructor, the process initially switches to the <code>kernel_page_table</code> and <code>kernel_obj_pool</code>. It then uses the <code>new</code> operator to allocate memory for the process’s page table and virtual memory pools, setting up the necessary environment for process execution.</p>\n</li>\n<li><p>**Memory Management: ** </p>\n<ul>\n<li>Frame Pools: I used two frame pools: <code>kernel_frame_pool</code> and <code>process_frame_pool</code></li>\n<li>I utilized three virtual memory (VM) pools: <code>kernel_obj_pool</code>, <code>kernel_vm_pool</code>, and <code>process_vm_pool</code>:<ol>\n<li><strong><code>kernel_obj_pool</code></strong> (2MB - 3MB): This pool is reserved for kernel objects, such as the kernel page table. When the kernel needs to define a new object, like a new process, it switches to the <code>kernel_obj_pool</code> and uses the <code>new</code> operator to allocate memory for it.</li>\n<li><strong><code>kernel_vm_pool</code></strong> (3MB - 4MB): This pool is used for the kernel stacks of threads. Each thread’s kernel stack is allocated from this pool to ensure have a dedicated memory space.</li>\n<li><strong><code>process_vm_pool</code></strong>(4MB - 256MB): This pool is used for the execution of processes. When a thread starts, the kernel sets <code>current_thread</code> to the thread’s process VM pool, allowing the process to allocate objects within its own address space.</li>\n</ol>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-03-29%20at%2020.53.46.png\" alt=\"Screenshot 2024-03-29 at 20.53.46\"></p>\n</li>\n<li><p>Retained the <code>Thread</code> class, similar to the original design, containing an <code>esp</code> attribute to store the current process’s stack address, code segment, etc. It includes <code>push</code> and <code>set_context</code> functions to establish the context of the process.<br>Additionally, due to threads belonging to different address spaces, a page table address for the current address space is added to the <code>Thread</code> class (passed in from the process).</p>\n<p>The constructor and functions of the <code>Thread</code> class is designed as follows:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Thread::<span class=\"built_in\">Thread</span>(Thread_Function _tf, <span class=\"type\">char</span> * _stack, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> _stack_size);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Thread::set_process</span><span class=\"params\">(Process * _process)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Thread::set_pt</span><span class=\"params\">(PageTable * pt)</span></span>;</span><br></pre></td></tr></table></figure></li>\n<li><p><strong>Thread Management:</strong> Added an <code>add_thread</code> function to the <code>Process</code> class, allowing the addition of a new thread to the process. This function first disables interrupts, then switch to page table of current process, and then allocates memory from the <code>kernel_vm_pool</code> for the stack. It creates a new <code>Thread</code> object, and adds it to the scheduler’s queue (without implementing “Thread level scheduling”).</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::<span class=\"built_in\">add_proces</span>(Thread_Function _tf, <span class=\"type\">int</span> _stack_size)</span><br></pre></td></tr></table></figure></li>\n<li><p>When the <code>RRScheduler</code> handles thread switching, it first compares the page table of the next thread with the current one. If they are different, the new page table is loaded into the register (pt-&gt;load()) and <code>current_pool</code> will be set to <code>process_vm_pool</code> of current process.. Since the first 4MB is directly mapped to the kernel pool, switching page tables does not affect system operation.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Switch CURRENT_POOL \\n&quot;</span>); </span><br><span class=\"line\">CURRENT_POOL = current_thread-&gt;process-&gt;process_pool;</span><br><span class=\"line\"></span><br><span class=\"line\">PageTable * pt_ = current_thread-&gt;pt;</span><br><span class=\"line\">pt_-&gt;<span class=\"built_in\">load</span>();</span><br></pre></td></tr></table></figure></li>\n<li><p>With this setup, multiple threads can be continuously added to a process, and these threads will share the same address space.</p>\n</li>\n</ul>\n<p>**TEST: **</p>\n<p>For testing, two processes are started: <code>process1</code> contains <code>Thread1</code> and <code>Thread3</code>, while <code>process2</code> contains <code>Thread2</code> and <code>Thread4</code>. </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 2 processes and 4 threads</span></span><br><span class=\"line\">process1.<span class=\"built_in\">add_thread</span>(fun1, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process2.<span class=\"built_in\">add_thread</span>(fun2, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process1.<span class=\"built_in\">add_thread</span>(fun3, <span class=\"number\">1024</span>);</span><br><span class=\"line\">process2.<span class=\"built_in\">add_thread</span>(fun4, <span class=\"number\">1024</span>);</span><br></pre></td></tr></table></figure>\n\n<p>In the test, each thread accumulates its ticks in the memory location at 32MB + ThreadID. The expected result is that the ticks for threads within the same process are visible to each other, while the other locations are 0. </p>\n<blockquote>\n<p>addr[1]                 addr[2]                 addr[3]                addr[4]</p>\n<p>[thread1’s tick]   [thread2’s tick]   [thread3’s tick]   [thread4’s tick]</p>\n</blockquote>\n<p>The test code and output (which meets expectations) is as follows:</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> tick_addr = <span class=\"number\">32</span> MB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">fun1</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Thread: &quot;</span>); Console::<span class=\"built_in\">puti</span>(Thread::<span class=\"built_in\">CurrentThread</span>()-&gt;<span class=\"built_in\">ThreadId</span>()); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1 INVOKED!\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> id=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">    addr[id]=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// _TERMINATING_FUNCTIONS_</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> j = <span class=\"number\">0</span>; j &lt; <span class=\"number\">10</span>; j++) &#123;\t</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1 IN BURST[&quot;</span>); Console::<span class=\"built_in\">puti</span>(j); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;FUN 1: TICK [&quot;</span>); Console::<span class=\"built_in\">puti</span>(i); Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          \t<span class=\"comment\">// add tick to memory</span></span><br><span class=\"line\">           \t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">            addr[id]+=id;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">pass_on_CPU</span>(thread2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;====== FUN 1 ======\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;i&lt;=<span class=\"number\">4</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;TICK in Idx &quot;</span>); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puti</span>(i); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;, Num: &quot;</span>); </span><br><span class=\"line\">        Console::<span class=\"built_in\">puti</span>(addr[i]);</span><br><span class=\"line\">        Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;]\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Test Output:</strong></p>\n  <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Thread 3 finished firstly. </span></span><br><span class=\"line\"><span class=\"comment\"># Got 92 ticks from Thread 1. (because thread 1 haven&#x27;t stop, so not 100)</span></span><br><span class=\"line\"><span class=\"comment\"># Get 300 ticks Thread 3(itself)</span></span><br><span class=\"line\"><span class=\"comment\"># Got 0 ticks from Thread 2 and Thread 4. (since Thread 2 and Thread 4 belong to the different address sapce)</span></span><br><span class=\"line\">====== FUN <span class=\"number\">3</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">92</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">300</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Thread 2 finished. </span></span><br><span class=\"line\"><span class=\"comment\"># Got 368 ticks from Thread 4. (because thread 4 haven&#x27;t stop, so not 400)</span></span><br><span class=\"line\"><span class=\"comment\"># Got 200 ticks from Thread 2. (itself) </span></span><br><span class=\"line\"><span class=\"comment\"># Got 0 ticks from Thread 2 and Thread 4.</span></span><br><span class=\"line\">====== FUN <span class=\"number\">2</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">200</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">368</span></span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN <span class=\"number\">4</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">200</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">400</span></span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN <span class=\"number\">1</span> ======</span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">1</span>, Num: <span class=\"number\">100</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">2</span>, Num: <span class=\"number\">0</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">3</span>, Num: <span class=\"number\">300</span></span><br><span class=\"line\">TICK <span class=\"keyword\">in</span> Idx <span class=\"number\">4</span>, Num: <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<p>So this test verified that Process1 and Process2 have different address Spaces. This test also verified the accuracy of Thread running (according to Tick number), thread switching and page table switching.</p>\n<p>This proves that I have completed a basic kernel process.</p>\n"},{"title":"CSCE611-OS-Project05-Thread","date":"2024-03-24T22:40:44.000Z","_content":"\n1.FIFO\n\n在Scheduler里实现一个队列LinkedList，储存Threads。每次调用Resume，则将thread插入队尾。调用yield，则pop出第一个thread，并使用 Thread::dispatch_to(Thread * _thread) 切换。\n\n\n\n为了实现终止thread，包含两个步骤，1.释放内存，2.从scheduler删除thread。为了获得当前thread的stack地址，我添加了一个Thread::Stack()函数。并修改：\n```c++\nstatic void thread_shutdown() {\n    /* This function should be called when the thread returns from the thread function.\n       It terminates the thread by releasing memory and any other resources held by the thread. \n       This is a bit complicated because the thread termination interacts with the scheduler.\n     */\n    Console::puts(\"thread_shutdown\\n\");\n\n    MEMORY_POOL->release((long unsigned int) current_thread->Stack());\n    SYSTEM_SCHEDULER->terminate(current_thread);\n    \n}\n```\n\n\n\n\n\n2.Enable Interrupt\n\n在Thread里，Thread::thread_start函数里，添加if(!Machine::interrupts_enabled()) Machine::enable_interrupts();\n\n在scheduler里，resume和yield前，调用Machine::disable_interrupts()，从而避免进行进程切换时发生中断。（最坏的情况时，进程主动切换时发生中断，切换终止，同时触发rr_schedule的进程切换，此是会产生错误的切换）\n\n\n\n\n\n3.RR scheduler\n\n- 为了控制是否启用rr scheduler，添加了一个scheduler_conf.H\n- 添加eoq_timer，构造函数传入RRScheduler。每隔50ms，触发中断，EOQTimer::handle_interrupt调用scheduler的resume和yield\n- 修改Interrupt实现，增加函数InterruptHandler::send_end_of_interrupt(REGS * _r)。在scheduler里，切换到下一个thread前，调用send_end_of_interrupt，表明当前中断处理结束，从而保证Interrupt可以继续处理中断。_\n  _同时在InterruptHandler::dispatch_interrupt添加 if(int_no!=0) send_end_of_interrupt(_r);，表明时间中断，由timer发送结束信号，避免重复发送中断结束的信息。\n- 缺点，scheduler不线程安全，Interrupt切换和thread本身的切换，可能冲突，导致队列里的内容不正确。经测试，单独启用RRScheduler，禁用thread本身切换，可以准确实现每隔50ms切换到下一个thread。\n\n\n\n\n\n- \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n4.Processes\n\n- 将之前三个MP的Pool，移植到MP5\n\n- 启用虚拟内存。实现Process类。在初始化Process时，为其声明两个vm_pool，kernel_mem_pool（3MB-4MB） 和 process_mempool（4MB-256MB）。kernel_mem_pool用于process的内部对象声明（例如Stack，需要直接映射），process_mem_pool在线程运行时用于给线程分配内存（因此具有新的页表，地址空间）。\n\n  ```\n  Process::Process(VMPool * vm_pool);\n  ```\n\n  \n\n- 保留Thread，该Thread类似原有的Thread的设计。其中包含esp用于储存当前precess的stack地址，代码段等。包含push和set_context函数，以完成该process的context声明。\n  此外，由于此时Thread之间属于不同的地址空间，因此需要在Thread里加入当前地址空间的页表地址（传入process）\n\n  该类的构造函数设计：\n\n  ```\n  Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size, Process * process);\n  ```\n\n  \n\n- 为Process添加一个add_thread函数，用于向Process增加一个线程。此函数首先会停止中断，然后从kernel_vm_pool申请一块内存，用作stack。然后建立一个新的Thread对象，在本地的队列存储该Thread，同时并将改Thread对象add入scheduler的queue里（不设计“Thread level调度”）。\n\n  ```\n  Process::add_proces(Thread_Function _tf,int _stack_size)\n  ```\n\n  \n\n- 当Scheduler处理Thread切换时，首先比较下一个Thread的page table与当前是否相同，不同的话则将新的page table load到寄存器。由于前4MB是直接映射到kernel pool，因此切换页表不会影响系统运行。\n\n\n\n- 这样以来，就可以向一个Process里不断添加新的Thread，并且这些Thread具有相同的地址空间\n\n- 测试，启动两个Process，process1包含Thread1和2，Process2包含Thread2和4。Thread会向地址为32MB+ThreadID的位置累加本线程的Tick。最终打印四个位置的Tick。\n  ```c++\n  unsigned long tick_addr = 32 MB;\n  \n  int id=1;\n  unsigned long * addr = (unsigned long *)(tick_addr);\n      \n  unsigned long * addr = (unsigned long *)(tick_addr);\n  addr[id]+=id;\n  ```\n\n  结构应该是，process1下的两个线程之间的tick相互可见，另外两个tick的位置是0。反之同理。测试结果（符合预期）：\n  ```\n  ====== FUN 3 ======\n  TICK in Idx 1, Num: 92]\n  TICK in Idx 2, Num: 0]\n  TICK in Idx 3, Num: 300]\n  TICK in Idx 4, Num: 0]\n  \n  ====== FUN 2 ======\n  TICK in Idx 1, Num: 0]\n  TICK in Idx 2, Num: 200]\n  TICK in Idx 3, Num: 0]\n  TICK in Idx 4, Num: 368]\n  \n  ====== FUN 4 ======\n  TICK in Idx 1, Num: 0]\n  TICK in Idx 2, Num: 200]\n  TICK in Idx 3, Num: 0]\n  TICK in Idx 4, Num: 400]\n  \n  ====== FUN 1 ======\n  TICK in Idx 1, Num: 100]\n  TICK in Idx 2, Num: 0]\n  TICK in Idx 3, Num: 300]\n  TICK in Idx 4, Num: 0]\n  ```\n\n  \n","source":"_posts/CSCE611-OS-Project05-Thread.md","raw":"---\ntitle: CSCE611-OS-Project05-Thread\ndate: 2024-03-24 17:40:44\ntags:\n---\n\n1.FIFO\n\n在Scheduler里实现一个队列LinkedList，储存Threads。每次调用Resume，则将thread插入队尾。调用yield，则pop出第一个thread，并使用 Thread::dispatch_to(Thread * _thread) 切换。\n\n\n\n为了实现终止thread，包含两个步骤，1.释放内存，2.从scheduler删除thread。为了获得当前thread的stack地址，我添加了一个Thread::Stack()函数。并修改：\n```c++\nstatic void thread_shutdown() {\n    /* This function should be called when the thread returns from the thread function.\n       It terminates the thread by releasing memory and any other resources held by the thread. \n       This is a bit complicated because the thread termination interacts with the scheduler.\n     */\n    Console::puts(\"thread_shutdown\\n\");\n\n    MEMORY_POOL->release((long unsigned int) current_thread->Stack());\n    SYSTEM_SCHEDULER->terminate(current_thread);\n    \n}\n```\n\n\n\n\n\n2.Enable Interrupt\n\n在Thread里，Thread::thread_start函数里，添加if(!Machine::interrupts_enabled()) Machine::enable_interrupts();\n\n在scheduler里，resume和yield前，调用Machine::disable_interrupts()，从而避免进行进程切换时发生中断。（最坏的情况时，进程主动切换时发生中断，切换终止，同时触发rr_schedule的进程切换，此是会产生错误的切换）\n\n\n\n\n\n3.RR scheduler\n\n- 为了控制是否启用rr scheduler，添加了一个scheduler_conf.H\n- 添加eoq_timer，构造函数传入RRScheduler。每隔50ms，触发中断，EOQTimer::handle_interrupt调用scheduler的resume和yield\n- 修改Interrupt实现，增加函数InterruptHandler::send_end_of_interrupt(REGS * _r)。在scheduler里，切换到下一个thread前，调用send_end_of_interrupt，表明当前中断处理结束，从而保证Interrupt可以继续处理中断。_\n  _同时在InterruptHandler::dispatch_interrupt添加 if(int_no!=0) send_end_of_interrupt(_r);，表明时间中断，由timer发送结束信号，避免重复发送中断结束的信息。\n- 缺点，scheduler不线程安全，Interrupt切换和thread本身的切换，可能冲突，导致队列里的内容不正确。经测试，单独启用RRScheduler，禁用thread本身切换，可以准确实现每隔50ms切换到下一个thread。\n\n\n\n\n\n- \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n4.Processes\n\n- 将之前三个MP的Pool，移植到MP5\n\n- 启用虚拟内存。实现Process类。在初始化Process时，为其声明两个vm_pool，kernel_mem_pool（3MB-4MB） 和 process_mempool（4MB-256MB）。kernel_mem_pool用于process的内部对象声明（例如Stack，需要直接映射），process_mem_pool在线程运行时用于给线程分配内存（因此具有新的页表，地址空间）。\n\n  ```\n  Process::Process(VMPool * vm_pool);\n  ```\n\n  \n\n- 保留Thread，该Thread类似原有的Thread的设计。其中包含esp用于储存当前precess的stack地址，代码段等。包含push和set_context函数，以完成该process的context声明。\n  此外，由于此时Thread之间属于不同的地址空间，因此需要在Thread里加入当前地址空间的页表地址（传入process）\n\n  该类的构造函数设计：\n\n  ```\n  Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size, Process * process);\n  ```\n\n  \n\n- 为Process添加一个add_thread函数，用于向Process增加一个线程。此函数首先会停止中断，然后从kernel_vm_pool申请一块内存，用作stack。然后建立一个新的Thread对象，在本地的队列存储该Thread，同时并将改Thread对象add入scheduler的queue里（不设计“Thread level调度”）。\n\n  ```\n  Process::add_proces(Thread_Function _tf,int _stack_size)\n  ```\n\n  \n\n- 当Scheduler处理Thread切换时，首先比较下一个Thread的page table与当前是否相同，不同的话则将新的page table load到寄存器。由于前4MB是直接映射到kernel pool，因此切换页表不会影响系统运行。\n\n\n\n- 这样以来，就可以向一个Process里不断添加新的Thread，并且这些Thread具有相同的地址空间\n\n- 测试，启动两个Process，process1包含Thread1和2，Process2包含Thread2和4。Thread会向地址为32MB+ThreadID的位置累加本线程的Tick。最终打印四个位置的Tick。\n  ```c++\n  unsigned long tick_addr = 32 MB;\n  \n  int id=1;\n  unsigned long * addr = (unsigned long *)(tick_addr);\n      \n  unsigned long * addr = (unsigned long *)(tick_addr);\n  addr[id]+=id;\n  ```\n\n  结构应该是，process1下的两个线程之间的tick相互可见，另外两个tick的位置是0。反之同理。测试结果（符合预期）：\n  ```\n  ====== FUN 3 ======\n  TICK in Idx 1, Num: 92]\n  TICK in Idx 2, Num: 0]\n  TICK in Idx 3, Num: 300]\n  TICK in Idx 4, Num: 0]\n  \n  ====== FUN 2 ======\n  TICK in Idx 1, Num: 0]\n  TICK in Idx 2, Num: 200]\n  TICK in Idx 3, Num: 0]\n  TICK in Idx 4, Num: 368]\n  \n  ====== FUN 4 ======\n  TICK in Idx 1, Num: 0]\n  TICK in Idx 2, Num: 200]\n  TICK in Idx 3, Num: 0]\n  TICK in Idx 4, Num: 400]\n  \n  ====== FUN 1 ======\n  TICK in Idx 1, Num: 100]\n  TICK in Idx 2, Num: 0]\n  TICK in Idx 3, Num: 300]\n  TICK in Idx 4, Num: 0]\n  ```\n\n  \n","slug":"CSCE611-OS-Project05-Thread","published":1,"updated":"2024-03-29T18:10:08.119Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cludgda7v0001d6okewxqdf8m","content":"<p>1.FIFO</p>\n<p>在Scheduler里实现一个队列LinkedList，储存Threads。每次调用Resume，则将thread插入队尾。调用yield，则pop出第一个thread，并使用 Thread::dispatch_to(Thread * _thread) 切换。</p>\n<p>为了实现终止thread，包含两个步骤，1.释放内存，2.从scheduler删除thread。为了获得当前thread的stack地址，我添加了一个Thread::Stack()函数。并修改：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">thread_shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* This function should be called when the thread returns from the thread function.</span></span><br><span class=\"line\"><span class=\"comment\">       It terminates the thread by releasing memory and any other resources held by the thread. </span></span><br><span class=\"line\"><span class=\"comment\">       This is a bit complicated because the thread termination interacts with the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;thread_shutdown\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    MEMORY_POOL-&gt;<span class=\"built_in\">release</span>((<span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>) current_thread-&gt;<span class=\"built_in\">Stack</span>());</span><br><span class=\"line\">    SYSTEM_SCHEDULER-&gt;<span class=\"built_in\">terminate</span>(current_thread);</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>2.Enable Interrupt</p>\n<p>在Thread里，Thread::thread_start函数里，添加if(!Machine::interrupts_enabled()) Machine::enable_interrupts();</p>\n<p>在scheduler里，resume和yield前，调用Machine::disable_interrupts()，从而避免进行进程切换时发生中断。（最坏的情况时，进程主动切换时发生中断，切换终止，同时触发rr_schedule的进程切换，此是会产生错误的切换）</p>\n<p>3.RR scheduler</p>\n<ul>\n<li>为了控制是否启用rr scheduler，添加了一个scheduler_conf.H</li>\n<li>添加eoq_timer，构造函数传入RRScheduler。每隔50ms，触发中断，EOQTimer::handle_interrupt调用scheduler的resume和yield</li>\n<li>修改Interrupt实现，增加函数InterruptHandler::send_end_of_interrupt(REGS * <em>r)。在scheduler里，切换到下一个thread前，调用send_end_of_interrupt，表明当前中断处理结束，从而保证Interrupt可以继续处理中断。</em><br>_同时在InterruptHandler::dispatch_interrupt添加 if(int_no!=0) send_end_of_interrupt(_r);，表明时间中断，由timer发送结束信号，避免重复发送中断结束的信息。</li>\n<li>缺点，scheduler不线程安全，Interrupt切换和thread本身的切换，可能冲突，导致队列里的内容不正确。经测试，单独启用RRScheduler，禁用thread本身切换，可以准确实现每隔50ms切换到下一个thread。</li>\n</ul>\n<ul>\n<li></li>\n</ul>\n<p>4.Processes</p>\n<ul>\n<li><p>将之前三个MP的Pool，移植到MP5</p>\n</li>\n<li><p>启用虚拟内存。实现Process类。在初始化Process时，为其声明两个vm_pool，kernel_mem_pool（3MB-4MB） 和 process_mempool（4MB-256MB）。kernel_mem_pool用于process的内部对象声明（例如Stack，需要直接映射），process_mem_pool在线程运行时用于给线程分配内存（因此具有新的页表，地址空间）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::Process(VMPool * vm_pool);</span><br></pre></td></tr></table></figure></li>\n<li><p>保留Thread，该Thread类似原有的Thread的设计。其中包含esp用于储存当前precess的stack地址，代码段等。包含push和set_context函数，以完成该process的context声明。<br>此外，由于此时Thread之间属于不同的地址空间，因此需要在Thread里加入当前地址空间的页表地址（传入process）</p>\n<p>该类的构造函数设计：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size, Process * process);</span><br></pre></td></tr></table></figure></li>\n<li><p>为Process添加一个add_thread函数，用于向Process增加一个线程。此函数首先会停止中断，然后从kernel_vm_pool申请一块内存，用作stack。然后建立一个新的Thread对象，在本地的队列存储该Thread，同时并将改Thread对象add入scheduler的queue里（不设计“Thread level调度”）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::add_proces(Thread_Function _tf,int _stack_size)</span><br></pre></td></tr></table></figure></li>\n<li><p>当Scheduler处理Thread切换时，首先比较下一个Thread的page table与当前是否相同，不同的话则将新的page table load到寄存器。由于前4MB是直接映射到kernel pool，因此切换页表不会影响系统运行。</p>\n</li>\n</ul>\n<ul>\n<li><p>这样以来，就可以向一个Process里不断添加新的Thread，并且这些Thread具有相同的地址空间</p>\n</li>\n<li><p>测试，启动两个Process，process1包含Thread1和2，Process2包含Thread2和4。Thread会向地址为32MB+ThreadID的位置累加本线程的Tick。最终打印四个位置的Tick。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> tick_addr = <span class=\"number\">32</span> MB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> id=<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">addr[id]+=id;</span><br></pre></td></tr></table></figure>\n\n<p>结构应该是，process1下的两个线程之间的tick相互可见，另外两个tick的位置是0。反之同理。测试结果（符合预期）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">====== FUN 3 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 92]</span><br><span class=\"line\">TICK in Idx 2, Num: 0]</span><br><span class=\"line\">TICK in Idx 3, Num: 300]</span><br><span class=\"line\">TICK in Idx 4, Num: 0]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 2 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 0]</span><br><span class=\"line\">TICK in Idx 2, Num: 200]</span><br><span class=\"line\">TICK in Idx 3, Num: 0]</span><br><span class=\"line\">TICK in Idx 4, Num: 368]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 4 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 0]</span><br><span class=\"line\">TICK in Idx 2, Num: 200]</span><br><span class=\"line\">TICK in Idx 3, Num: 0]</span><br><span class=\"line\">TICK in Idx 4, Num: 400]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 1 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 100]</span><br><span class=\"line\">TICK in Idx 2, Num: 0]</span><br><span class=\"line\">TICK in Idx 3, Num: 300]</span><br><span class=\"line\">TICK in Idx 4, Num: 0]</span><br></pre></td></tr></table></figure></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>1.FIFO</p>\n<p>在Scheduler里实现一个队列LinkedList，储存Threads。每次调用Resume，则将thread插入队尾。调用yield，则pop出第一个thread，并使用 Thread::dispatch_to(Thread * _thread) 切换。</p>\n<p>为了实现终止thread，包含两个步骤，1.释放内存，2.从scheduler删除thread。为了获得当前thread的stack地址，我添加了一个Thread::Stack()函数。并修改：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">thread_shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* This function should be called when the thread returns from the thread function.</span></span><br><span class=\"line\"><span class=\"comment\">       It terminates the thread by releasing memory and any other resources held by the thread. </span></span><br><span class=\"line\"><span class=\"comment\">       This is a bit complicated because the thread termination interacts with the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    Console::<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;thread_shutdown\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    MEMORY_POOL-&gt;<span class=\"built_in\">release</span>((<span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>) current_thread-&gt;<span class=\"built_in\">Stack</span>());</span><br><span class=\"line\">    SYSTEM_SCHEDULER-&gt;<span class=\"built_in\">terminate</span>(current_thread);</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>2.Enable Interrupt</p>\n<p>在Thread里，Thread::thread_start函数里，添加if(!Machine::interrupts_enabled()) Machine::enable_interrupts();</p>\n<p>在scheduler里，resume和yield前，调用Machine::disable_interrupts()，从而避免进行进程切换时发生中断。（最坏的情况时，进程主动切换时发生中断，切换终止，同时触发rr_schedule的进程切换，此是会产生错误的切换）</p>\n<p>3.RR scheduler</p>\n<ul>\n<li>为了控制是否启用rr scheduler，添加了一个scheduler_conf.H</li>\n<li>添加eoq_timer，构造函数传入RRScheduler。每隔50ms，触发中断，EOQTimer::handle_interrupt调用scheduler的resume和yield</li>\n<li>修改Interrupt实现，增加函数InterruptHandler::send_end_of_interrupt(REGS * <em>r)。在scheduler里，切换到下一个thread前，调用send_end_of_interrupt，表明当前中断处理结束，从而保证Interrupt可以继续处理中断。</em><br>_同时在InterruptHandler::dispatch_interrupt添加 if(int_no!=0) send_end_of_interrupt(_r);，表明时间中断，由timer发送结束信号，避免重复发送中断结束的信息。</li>\n<li>缺点，scheduler不线程安全，Interrupt切换和thread本身的切换，可能冲突，导致队列里的内容不正确。经测试，单独启用RRScheduler，禁用thread本身切换，可以准确实现每隔50ms切换到下一个thread。</li>\n</ul>\n<ul>\n<li></li>\n</ul>\n<p>4.Processes</p>\n<ul>\n<li><p>将之前三个MP的Pool，移植到MP5</p>\n</li>\n<li><p>启用虚拟内存。实现Process类。在初始化Process时，为其声明两个vm_pool，kernel_mem_pool（3MB-4MB） 和 process_mempool（4MB-256MB）。kernel_mem_pool用于process的内部对象声明（例如Stack，需要直接映射），process_mem_pool在线程运行时用于给线程分配内存（因此具有新的页表，地址空间）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::Process(VMPool * vm_pool);</span><br></pre></td></tr></table></figure></li>\n<li><p>保留Thread，该Thread类似原有的Thread的设计。其中包含esp用于储存当前precess的stack地址，代码段等。包含push和set_context函数，以完成该process的context声明。<br>此外，由于此时Thread之间属于不同的地址空间，因此需要在Thread里加入当前地址空间的页表地址（传入process）</p>\n<p>该类的构造函数设计：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Thread::Thread(Thread_Function _tf, char * _stack, unsigned int _stack_size, Process * process);</span><br></pre></td></tr></table></figure></li>\n<li><p>为Process添加一个add_thread函数，用于向Process增加一个线程。此函数首先会停止中断，然后从kernel_vm_pool申请一块内存，用作stack。然后建立一个新的Thread对象，在本地的队列存储该Thread，同时并将改Thread对象add入scheduler的queue里（不设计“Thread level调度”）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Process::add_proces(Thread_Function _tf,int _stack_size)</span><br></pre></td></tr></table></figure></li>\n<li><p>当Scheduler处理Thread切换时，首先比较下一个Thread的page table与当前是否相同，不同的话则将新的page table load到寄存器。由于前4MB是直接映射到kernel pool，因此切换页表不会影响系统运行。</p>\n</li>\n</ul>\n<ul>\n<li><p>这样以来，就可以向一个Process里不断添加新的Thread，并且这些Thread具有相同的地址空间</p>\n</li>\n<li><p>测试，启动两个Process，process1包含Thread1和2，Process2包含Thread2和4。Thread会向地址为32MB+ThreadID的位置累加本线程的Tick。最终打印四个位置的Tick。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> tick_addr = <span class=\"number\">32</span> MB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> id=<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> * addr = (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> *)(tick_addr);</span><br><span class=\"line\">addr[id]+=id;</span><br></pre></td></tr></table></figure>\n\n<p>结构应该是，process1下的两个线程之间的tick相互可见，另外两个tick的位置是0。反之同理。测试结果（符合预期）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">====== FUN 3 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 92]</span><br><span class=\"line\">TICK in Idx 2, Num: 0]</span><br><span class=\"line\">TICK in Idx 3, Num: 300]</span><br><span class=\"line\">TICK in Idx 4, Num: 0]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 2 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 0]</span><br><span class=\"line\">TICK in Idx 2, Num: 200]</span><br><span class=\"line\">TICK in Idx 3, Num: 0]</span><br><span class=\"line\">TICK in Idx 4, Num: 368]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 4 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 0]</span><br><span class=\"line\">TICK in Idx 2, Num: 200]</span><br><span class=\"line\">TICK in Idx 3, Num: 0]</span><br><span class=\"line\">TICK in Idx 4, Num: 400]</span><br><span class=\"line\"></span><br><span class=\"line\">====== FUN 1 ======</span><br><span class=\"line\">TICK in Idx 1, Num: 100]</span><br><span class=\"line\">TICK in Idx 2, Num: 0]</span><br><span class=\"line\">TICK in Idx 3, Num: 300]</span><br><span class=\"line\">TICK in Idx 4, Num: 0]</span><br></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"CSCE611-OS-Project07-File-System","date":"2024-05-03T20:56:39.000Z","_content":"\n### File System\n\n**Introduction:** The File System (FS) described here is a simple implementation designed to manage files on a disk. It provides basic functionality such as mounting a disk, formatting it, creating, deleting, and looking up files by their IDs.\n\n**FileSystem Class:** The `FileSystem` class is the central component of the file system implementation. It manages the disk, maintains the inode list, and keeps track of free blocks. Below are the details of its member functions:\n\n1. **Constructor (`FileSystem::FileSystem()`):**\n\n   - Initializes local data structures.\n   - Does not connect to the disk yet.\n   - Outputs a message indicating the construction of the file system.\n\n2. **Destructor (`FileSystem::~FileSystem()`):**\n\n   - Unmounts the file system if it has been mounted.\n   - Ensures that the inode list and free block list are saved. Write inode list and free list to block0 and block1.\n\n3. **Mount (`FileSystem::Mount(SimpleDisk\\* _disk)`):**\n\n   - Associates the file system with a disk.\n\n   - Reads the inode list and the free block list into memory from the disk. In my file system, the first block is used to store inode list and second block is used for free list. In inode list, eack record contains two items, inode id and block id. Free is a bit map, ''*\" in free list meas that `used` and \"_\" means that unused.\n     \n\n     <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-05-03%20at%2014.12.13.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n4. **Format (`FileSystem::Format(SimpleDisk\\* _disk, unsigned int _size)`):**\n\n   - Formats the disk, wiping any existing file system.\n   - Populates the disk with an empty file system of the given size.\n   - Initializes the inode list and the free block list.\n\n5. **LookupFile (`FileSystem::LookupFile(int _file_id)`):**\n\n   - Finds a file with the given ID in the file system.\n   - Traverses the inode list to locate the file.\n   - Returns the inode of the file if found; otherwise, returns null.\n   - Outputs a message indicating the file lookup process.\n\n6. **CreateFile (`FileSystem::CreateFile(int _file_id)`):**\n\n   - Creates a file with the given ID in the file system.\n   - Checks if the file already exists; if so, aborts and returns false.\n   - Allocates a free block for the file and initializes its inode.\n   - Adds the inode to the inode list.\n   - Outputs a message indicating the file creation process.\n\n7. **DeleteFile (`FileSystem::DeleteFile(int _file_id)`):**\n\n   - Deletes a file with the given ID from the file system.\n   - Checks if the file exists; if not, returns an error.\n   - Frees the blocks occupied by the file and removes its inode from the inode list.\n   - Outputs a message indicating the file deletion process.\n\n**Inode Class:** The `Inode` class represents an index node in the file system. It contains information about a file, such as its ID and the block it occupies on the disk. Additional functions may be needed to read and store inodes from and to the disk.\n\n\n\n### File\n\n**Introduction:** The `File` class represents a file handle in the file system implementation. It provides functionality for sequential read and write operations on a file. Each `File` object maintains a reference to its corresponding inode in the file system.\n\n**File Class:** Below are the details of the `File` class member functions:\n\n1. **Constructor (`File::File(FileSystem\\* _fs, int _id)`):**\n   - Initializes the file handle with the provided file system reference (`_fs`) and file ID (`_id`).\n   - Sets the current position to the beginning of the file.\n   - Checks if the file exists in the file system by looking up its inode.\n   - If the file does not exist, creates a new file with the provided ID.\n   - Reads the file's data block into the block cache for sequential read and write operations.\n2. **Destructor (`File::~File()`):**\n   - Closes the file.\n   - Writes any cached data to the disk.\n3. **Read (`File::Read(unsigned int _n, char\\* _buf)`):**\n   - Reads `_n` characters from the file starting at the current position.\n   - Copies the read characters into the buffer `_buf`.\n   - Returns the number of characters read.\n   - Does not read beyond the end of the file.\n4. **Write (`File::Write(unsigned int _n, const char\\* _buf)`):**\n   - Writes `_n` characters to the file starting at the current position.\n   - If the write extends over the end of the file, extends the length of the file until all data is written or until the maximum file size is reached.\n   - Returns the number of characters written.\n   - Does not write beyond the maximum length of the file.\n5. **Reset (`File::Reset()`):**\n   - Sets the current position to the beginning of the file.\n   - Allows subsequent read or write operations to start from the beginning of the file.\n6. **EoF (`File::EoF()`):**\n   - Checks if the current position for the file is at the end of the file.\n   - Returns true if the current position is at the end of the file; otherwise, returns false.\n   - Helps determine if there are more characters to read from the file.\n\n\n\n### Test\n\n**Testing File System Functionality**\n\nTo ensure the proper functioning of the file system, the following steps are taken to test various operations:\n\n1. **File Creation:**\n   \n   - Two files are created using the `CreateFile` function of the file system.\n   - Assertions are used to verify that the files are successfully created.\n     ```c++\n     assert(_file_system->CreateFile(1));\n     assert(_file_system->CreateFile(2));\n     ```\n   \n     \n   \n2. **File Opening and Writing:**\n   - The two files are \"opened\" using the `File` constructor, which initializes file handles.\n   - Data is written to each file using the `Write` function, with different content for each file.\n   - Assertions are used to verify that the write operations are successful.\n     ```c++\n     const char * STRING1 = \"01234567890123456789\";\n     const char * STRING2 = \"abcdefghijabcdefghij\";\n     ```\n   \n3. **File Closing:**\n   - The files are automatically closed when they go out of scope.\n\n4. **File Opening and Reading:**\n   - The files are \"opened\" again to simulate reopening.\n   - Data is read from each file using the `Read` function.\n   - Assertions are used to compare the read data with the expected content.\n\n5. **File Deletion:**\n   \n   - Both files are deleted using the `DeleteFile` function.\n   - Assertions are used to verify that the files are successfully deleted.\n   \n8. **Comparison with Expected Results:**\n   - The actual results of file read operations are compared with the expected content.\n   - If any discrepancies are found, assertions will fail, indicating a potential problem with file reading or writing.\n\n##### Log\n\n```python\nHello World!\nformatting disk\nWrite Block: 1\t# init free list and inode list\nWrite Block: 2\nmounting file system from disk\nRead Block: 1 \t# read free list and inode list\nRead Block: 2\ncreating file with id:1\n\nCreated File Name: 1\nUsed File Block: 3\n\ncreating file with id:2\n\nCreated File Name: 2\nUsed File Block: 4\n\nOpening file.\t# open file21\nlooking up file with id = 1\nRead Block: 3\nOpening file. # open file 2\nlooking up file with id = 2\nRead Block: 4\nwriting to file\nwriting to file\nClosing file.\nWrite Block: 4\nClosing file.\nWrite Block: 3\n\nOpening file.\t# open file again\nlooking up file with id = 1\nRead Block: 3\nOpening file.\t\t# open file again\nlooking up file with id = 2\nRead Block: 4\nresetting file\nreading from file\nresetting file\nreading from file\nClosing file.\nWrite Block: 4\nClosing file.\nWrite Block: 3\ndeleting file with id:1 # test passed \nFile successfully deleted.\ndeleting file with id:2\t# test passed \nFile successfully deleted.\n\n```\n\n\n\n\n\n","source":"_posts/CSCE611-OS-Project07-File-System.md","raw":"---\ntitle: CSCE611-OS-Project07-File-System\ndate: 2024-05-03 13:56:39\ntags:\n---\n\n### File System\n\n**Introduction:** The File System (FS) described here is a simple implementation designed to manage files on a disk. It provides basic functionality such as mounting a disk, formatting it, creating, deleting, and looking up files by their IDs.\n\n**FileSystem Class:** The `FileSystem` class is the central component of the file system implementation. It manages the disk, maintains the inode list, and keeps track of free blocks. Below are the details of its member functions:\n\n1. **Constructor (`FileSystem::FileSystem()`):**\n\n   - Initializes local data structures.\n   - Does not connect to the disk yet.\n   - Outputs a message indicating the construction of the file system.\n\n2. **Destructor (`FileSystem::~FileSystem()`):**\n\n   - Unmounts the file system if it has been mounted.\n   - Ensures that the inode list and free block list are saved. Write inode list and free list to block0 and block1.\n\n3. **Mount (`FileSystem::Mount(SimpleDisk\\* _disk)`):**\n\n   - Associates the file system with a disk.\n\n   - Reads the inode list and the free block list into memory from the disk. In my file system, the first block is used to store inode list and second block is used for free list. In inode list, eack record contains two items, inode id and block id. Free is a bit map, ''*\" in free list meas that `used` and \"_\" means that unused.\n     \n\n     <img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-05-03%20at%2014.12.13.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" />\n\n4. **Format (`FileSystem::Format(SimpleDisk\\* _disk, unsigned int _size)`):**\n\n   - Formats the disk, wiping any existing file system.\n   - Populates the disk with an empty file system of the given size.\n   - Initializes the inode list and the free block list.\n\n5. **LookupFile (`FileSystem::LookupFile(int _file_id)`):**\n\n   - Finds a file with the given ID in the file system.\n   - Traverses the inode list to locate the file.\n   - Returns the inode of the file if found; otherwise, returns null.\n   - Outputs a message indicating the file lookup process.\n\n6. **CreateFile (`FileSystem::CreateFile(int _file_id)`):**\n\n   - Creates a file with the given ID in the file system.\n   - Checks if the file already exists; if so, aborts and returns false.\n   - Allocates a free block for the file and initializes its inode.\n   - Adds the inode to the inode list.\n   - Outputs a message indicating the file creation process.\n\n7. **DeleteFile (`FileSystem::DeleteFile(int _file_id)`):**\n\n   - Deletes a file with the given ID from the file system.\n   - Checks if the file exists; if not, returns an error.\n   - Frees the blocks occupied by the file and removes its inode from the inode list.\n   - Outputs a message indicating the file deletion process.\n\n**Inode Class:** The `Inode` class represents an index node in the file system. It contains information about a file, such as its ID and the block it occupies on the disk. Additional functions may be needed to read and store inodes from and to the disk.\n\n\n\n### File\n\n**Introduction:** The `File` class represents a file handle in the file system implementation. It provides functionality for sequential read and write operations on a file. Each `File` object maintains a reference to its corresponding inode in the file system.\n\n**File Class:** Below are the details of the `File` class member functions:\n\n1. **Constructor (`File::File(FileSystem\\* _fs, int _id)`):**\n   - Initializes the file handle with the provided file system reference (`_fs`) and file ID (`_id`).\n   - Sets the current position to the beginning of the file.\n   - Checks if the file exists in the file system by looking up its inode.\n   - If the file does not exist, creates a new file with the provided ID.\n   - Reads the file's data block into the block cache for sequential read and write operations.\n2. **Destructor (`File::~File()`):**\n   - Closes the file.\n   - Writes any cached data to the disk.\n3. **Read (`File::Read(unsigned int _n, char\\* _buf)`):**\n   - Reads `_n` characters from the file starting at the current position.\n   - Copies the read characters into the buffer `_buf`.\n   - Returns the number of characters read.\n   - Does not read beyond the end of the file.\n4. **Write (`File::Write(unsigned int _n, const char\\* _buf)`):**\n   - Writes `_n` characters to the file starting at the current position.\n   - If the write extends over the end of the file, extends the length of the file until all data is written or until the maximum file size is reached.\n   - Returns the number of characters written.\n   - Does not write beyond the maximum length of the file.\n5. **Reset (`File::Reset()`):**\n   - Sets the current position to the beginning of the file.\n   - Allows subsequent read or write operations to start from the beginning of the file.\n6. **EoF (`File::EoF()`):**\n   - Checks if the current position for the file is at the end of the file.\n   - Returns true if the current position is at the end of the file; otherwise, returns false.\n   - Helps determine if there are more characters to read from the file.\n\n\n\n### Test\n\n**Testing File System Functionality**\n\nTo ensure the proper functioning of the file system, the following steps are taken to test various operations:\n\n1. **File Creation:**\n   \n   - Two files are created using the `CreateFile` function of the file system.\n   - Assertions are used to verify that the files are successfully created.\n     ```c++\n     assert(_file_system->CreateFile(1));\n     assert(_file_system->CreateFile(2));\n     ```\n   \n     \n   \n2. **File Opening and Writing:**\n   - The two files are \"opened\" using the `File` constructor, which initializes file handles.\n   - Data is written to each file using the `Write` function, with different content for each file.\n   - Assertions are used to verify that the write operations are successful.\n     ```c++\n     const char * STRING1 = \"01234567890123456789\";\n     const char * STRING2 = \"abcdefghijabcdefghij\";\n     ```\n   \n3. **File Closing:**\n   - The files are automatically closed when they go out of scope.\n\n4. **File Opening and Reading:**\n   - The files are \"opened\" again to simulate reopening.\n   - Data is read from each file using the `Read` function.\n   - Assertions are used to compare the read data with the expected content.\n\n5. **File Deletion:**\n   \n   - Both files are deleted using the `DeleteFile` function.\n   - Assertions are used to verify that the files are successfully deleted.\n   \n8. **Comparison with Expected Results:**\n   - The actual results of file read operations are compared with the expected content.\n   - If any discrepancies are found, assertions will fail, indicating a potential problem with file reading or writing.\n\n##### Log\n\n```python\nHello World!\nformatting disk\nWrite Block: 1\t# init free list and inode list\nWrite Block: 2\nmounting file system from disk\nRead Block: 1 \t# read free list and inode list\nRead Block: 2\ncreating file with id:1\n\nCreated File Name: 1\nUsed File Block: 3\n\ncreating file with id:2\n\nCreated File Name: 2\nUsed File Block: 4\n\nOpening file.\t# open file21\nlooking up file with id = 1\nRead Block: 3\nOpening file. # open file 2\nlooking up file with id = 2\nRead Block: 4\nwriting to file\nwriting to file\nClosing file.\nWrite Block: 4\nClosing file.\nWrite Block: 3\n\nOpening file.\t# open file again\nlooking up file with id = 1\nRead Block: 3\nOpening file.\t\t# open file again\nlooking up file with id = 2\nRead Block: 4\nresetting file\nreading from file\nresetting file\nreading from file\nClosing file.\nWrite Block: 4\nClosing file.\nWrite Block: 3\ndeleting file with id:1 # test passed \nFile successfully deleted.\ndeleting file with id:2\t# test passed \nFile successfully deleted.\n\n```\n\n\n\n\n\n","slug":"CSCE611-OS-Project07-File-System","published":1,"updated":"2024-05-03T19:44:13.007Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clwo5xc8b0000aq1fhcxe5xm6","content":"<h3 id=\"File-System\"><a href=\"#File-System\" class=\"headerlink\" title=\"File System\"></a>File System</h3><p><strong>Introduction:</strong> The File System (FS) described here is a simple implementation designed to manage files on a disk. It provides basic functionality such as mounting a disk, formatting it, creating, deleting, and looking up files by their IDs.</p>\n<p><strong>FileSystem Class:</strong> The <code>FileSystem</code> class is the central component of the file system implementation. It manages the disk, maintains the inode list, and keeps track of free blocks. Below are the details of its member functions:</p>\n<ol>\n<li><p><strong>Constructor (<code>FileSystem::FileSystem()</code>):</strong></p>\n<ul>\n<li>Initializes local data structures.</li>\n<li>Does not connect to the disk yet.</li>\n<li>Outputs a message indicating the construction of the file system.</li>\n</ul>\n</li>\n<li><p><strong>Destructor (<code>FileSystem::~FileSystem()</code>):</strong></p>\n<ul>\n<li>Unmounts the file system if it has been mounted.</li>\n<li>Ensures that the inode list and free block list are saved. Write inode list and free list to block0 and block1.</li>\n</ul>\n</li>\n<li><p><strong>Mount (<code>FileSystem::Mount(SimpleDisk\\* _disk)</code>):</strong></p>\n<ul>\n<li><p>Associates the file system with a disk.</p>\n</li>\n<li><p>Reads the inode list and the free block list into memory from the disk. In my file system, the first block is used to store inode list and second block is used for free list. In inode list, eack record contains two items, inode id and block id. Free is a bit map, ‘’*” in free list meas that <code>used</code> and “_” means that unused.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-05-03%20at%2014.12.13.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" /></li>\n</ul>\n</li>\n<li><p><strong>Format (<code>FileSystem::Format(SimpleDisk\\* _disk, unsigned int _size)</code>):</strong></p>\n<ul>\n<li>Formats the disk, wiping any existing file system.</li>\n<li>Populates the disk with an empty file system of the given size.</li>\n<li>Initializes the inode list and the free block list.</li>\n</ul>\n</li>\n<li><p><strong>LookupFile (<code>FileSystem::LookupFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Finds a file with the given ID in the file system.</li>\n<li>Traverses the inode list to locate the file.</li>\n<li>Returns the inode of the file if found; otherwise, returns null.</li>\n<li>Outputs a message indicating the file lookup process.</li>\n</ul>\n</li>\n<li><p><strong>CreateFile (<code>FileSystem::CreateFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Creates a file with the given ID in the file system.</li>\n<li>Checks if the file already exists; if so, aborts and returns false.</li>\n<li>Allocates a free block for the file and initializes its inode.</li>\n<li>Adds the inode to the inode list.</li>\n<li>Outputs a message indicating the file creation process.</li>\n</ul>\n</li>\n<li><p><strong>DeleteFile (<code>FileSystem::DeleteFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Deletes a file with the given ID from the file system.</li>\n<li>Checks if the file exists; if not, returns an error.</li>\n<li>Frees the blocks occupied by the file and removes its inode from the inode list.</li>\n<li>Outputs a message indicating the file deletion process.</li>\n</ul>\n</li>\n</ol>\n<p><strong>Inode Class:</strong> The <code>Inode</code> class represents an index node in the file system. It contains information about a file, such as its ID and the block it occupies on the disk. Additional functions may be needed to read and store inodes from and to the disk.</p>\n<h3 id=\"File\"><a href=\"#File\" class=\"headerlink\" title=\"File\"></a>File</h3><p><strong>Introduction:</strong> The <code>File</code> class represents a file handle in the file system implementation. It provides functionality for sequential read and write operations on a file. Each <code>File</code> object maintains a reference to its corresponding inode in the file system.</p>\n<p><strong>File Class:</strong> Below are the details of the <code>File</code> class member functions:</p>\n<ol>\n<li><strong>Constructor (<code>File::File(FileSystem\\* _fs, int _id)</code>):</strong><ul>\n<li>Initializes the file handle with the provided file system reference (<code>_fs</code>) and file ID (<code>_id</code>).</li>\n<li>Sets the current position to the beginning of the file.</li>\n<li>Checks if the file exists in the file system by looking up its inode.</li>\n<li>If the file does not exist, creates a new file with the provided ID.</li>\n<li>Reads the file’s data block into the block cache for sequential read and write operations.</li>\n</ul>\n</li>\n<li><strong>Destructor (<code>File::~File()</code>):</strong><ul>\n<li>Closes the file.</li>\n<li>Writes any cached data to the disk.</li>\n</ul>\n</li>\n<li><strong>Read (<code>File::Read(unsigned int _n, char\\* _buf)</code>):</strong><ul>\n<li>Reads <code>_n</code> characters from the file starting at the current position.</li>\n<li>Copies the read characters into the buffer <code>_buf</code>.</li>\n<li>Returns the number of characters read.</li>\n<li>Does not read beyond the end of the file.</li>\n</ul>\n</li>\n<li><strong>Write (<code>File::Write(unsigned int _n, const char\\* _buf)</code>):</strong><ul>\n<li>Writes <code>_n</code> characters to the file starting at the current position.</li>\n<li>If the write extends over the end of the file, extends the length of the file until all data is written or until the maximum file size is reached.</li>\n<li>Returns the number of characters written.</li>\n<li>Does not write beyond the maximum length of the file.</li>\n</ul>\n</li>\n<li><strong>Reset (<code>File::Reset()</code>):</strong><ul>\n<li>Sets the current position to the beginning of the file.</li>\n<li>Allows subsequent read or write operations to start from the beginning of the file.</li>\n</ul>\n</li>\n<li><strong>EoF (<code>File::EoF()</code>):</strong><ul>\n<li>Checks if the current position for the file is at the end of the file.</li>\n<li>Returns true if the current position is at the end of the file; otherwise, returns false.</li>\n<li>Helps determine if there are more characters to read from the file.</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"Test\"><a href=\"#Test\" class=\"headerlink\" title=\"Test\"></a>Test</h3><p><strong>Testing File System Functionality</strong></p>\n<p>To ensure the proper functioning of the file system, the following steps are taken to test various operations:</p>\n<ol>\n<li><p><strong>File Creation:</strong></p>\n<ul>\n<li>Two files are created using the <code>CreateFile</code> function of the file system.</li>\n<li>Assertions are used to verify that the files are successfully created.<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">assert</span>(_file_system-&gt;<span class=\"built_in\">CreateFile</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"built_in\">assert</span>(_file_system-&gt;<span class=\"built_in\">CreateFile</span>(<span class=\"number\">2</span>));</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>File Opening and Writing:</strong></p>\n<ul>\n<li>The two files are “opened” using the <code>File</code> constructor, which initializes file handles.</li>\n<li>Data is written to each file using the <code>Write</code> function, with different content for each file.</li>\n<li>Assertions are used to verify that the write operations are successful.<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> * STRING1 = <span class=\"string\">&quot;01234567890123456789&quot;</span>;</span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> * STRING2 = <span class=\"string\">&quot;abcdefghijabcdefghij&quot;</span>;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>File Closing:</strong></p>\n<ul>\n<li>The files are automatically closed when they go out of scope.</li>\n</ul>\n</li>\n<li><p><strong>File Opening and Reading:</strong></p>\n<ul>\n<li>The files are “opened” again to simulate reopening.</li>\n<li>Data is read from each file using the <code>Read</code> function.</li>\n<li>Assertions are used to compare the read data with the expected content.</li>\n</ul>\n</li>\n<li><p><strong>File Deletion:</strong></p>\n<ul>\n<li>Both files are deleted using the <code>DeleteFile</code> function.</li>\n<li>Assertions are used to verify that the files are successfully deleted.</li>\n</ul>\n</li>\n<li><p><strong>Comparison with Expected Results:</strong></p>\n<ul>\n<li>The actual results of file read operations are compared with the expected content.</li>\n<li>If any discrepancies are found, assertions will fail, indicating a potential problem with file reading or writing.</li>\n</ul>\n</li>\n</ol>\n<h5 id=\"Log\"><a href=\"#Log\" class=\"headerlink\" title=\"Log\"></a>Log</h5><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Hello World!</span><br><span class=\"line\">formatting disk</span><br><span class=\"line\">Write Block: <span class=\"number\">1</span>\t<span class=\"comment\"># init free list and inode list</span></span><br><span class=\"line\">Write Block: <span class=\"number\">2</span></span><br><span class=\"line\">mounting file system <span class=\"keyword\">from</span> disk</span><br><span class=\"line\">Read Block: <span class=\"number\">1</span> \t<span class=\"comment\"># read free list and inode list</span></span><br><span class=\"line\">Read Block: <span class=\"number\">2</span></span><br><span class=\"line\">creating file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">Created File Name: <span class=\"number\">1</span></span><br><span class=\"line\">Used File Block: <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">creating file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">Created File Name: <span class=\"number\">2</span></span><br><span class=\"line\">Used File Block: <span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\">Opening file.\t<span class=\"comment\"># open file21</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">1</span></span><br><span class=\"line\">Read Block: <span class=\"number\">3</span></span><br><span class=\"line\">Opening file. <span class=\"comment\"># open file 2</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">2</span></span><br><span class=\"line\">Read Block: <span class=\"number\">4</span></span><br><span class=\"line\">writing to file</span><br><span class=\"line\">writing to file</span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">4</span></span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">Opening file.\t<span class=\"comment\"># open file again</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">1</span></span><br><span class=\"line\">Read Block: <span class=\"number\">3</span></span><br><span class=\"line\">Opening file.\t\t<span class=\"comment\"># open file again</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">2</span></span><br><span class=\"line\">Read Block: <span class=\"number\">4</span></span><br><span class=\"line\">resetting file</span><br><span class=\"line\">reading <span class=\"keyword\">from</span> file</span><br><span class=\"line\">resetting file</span><br><span class=\"line\">reading <span class=\"keyword\">from</span> file</span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">4</span></span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">3</span></span><br><span class=\"line\">deleting file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">1</span> <span class=\"comment\"># test passed </span></span><br><span class=\"line\">File successfully deleted.</span><br><span class=\"line\">deleting file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">2</span>\t<span class=\"comment\"># test passed </span></span><br><span class=\"line\">File successfully deleted.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"File-System\"><a href=\"#File-System\" class=\"headerlink\" title=\"File System\"></a>File System</h3><p><strong>Introduction:</strong> The File System (FS) described here is a simple implementation designed to manage files on a disk. It provides basic functionality such as mounting a disk, formatting it, creating, deleting, and looking up files by their IDs.</p>\n<p><strong>FileSystem Class:</strong> The <code>FileSystem</code> class is the central component of the file system implementation. It manages the disk, maintains the inode list, and keeps track of free blocks. Below are the details of its member functions:</p>\n<ol>\n<li><p><strong>Constructor (<code>FileSystem::FileSystem()</code>):</strong></p>\n<ul>\n<li>Initializes local data structures.</li>\n<li>Does not connect to the disk yet.</li>\n<li>Outputs a message indicating the construction of the file system.</li>\n</ul>\n</li>\n<li><p><strong>Destructor (<code>FileSystem::~FileSystem()</code>):</strong></p>\n<ul>\n<li>Unmounts the file system if it has been mounted.</li>\n<li>Ensures that the inode list and free block list are saved. Write inode list and free list to block0 and block1.</li>\n</ul>\n</li>\n<li><p><strong>Mount (<code>FileSystem::Mount(SimpleDisk\\* _disk)</code>):</strong></p>\n<ul>\n<li><p>Associates the file system with a disk.</p>\n</li>\n<li><p>Reads the inode list and the free block list into memory from the disk. In my file system, the first block is used to store inode list and second block is used for free list. In inode list, eack record contains two items, inode id and block id. Free is a bit map, ‘’*” in free list meas that <code>used</code> and “_” means that unused.</p>\n<img src=\"https://raw.githubusercontent.com/muchengl/pic_storage/main/uPic/Screenshot%202024-05-03%20at%2014.12.13.png\" alt=\"图片替换文本\" width=\"750\" align=\"bottom\" /></li>\n</ul>\n</li>\n<li><p><strong>Format (<code>FileSystem::Format(SimpleDisk\\* _disk, unsigned int _size)</code>):</strong></p>\n<ul>\n<li>Formats the disk, wiping any existing file system.</li>\n<li>Populates the disk with an empty file system of the given size.</li>\n<li>Initializes the inode list and the free block list.</li>\n</ul>\n</li>\n<li><p><strong>LookupFile (<code>FileSystem::LookupFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Finds a file with the given ID in the file system.</li>\n<li>Traverses the inode list to locate the file.</li>\n<li>Returns the inode of the file if found; otherwise, returns null.</li>\n<li>Outputs a message indicating the file lookup process.</li>\n</ul>\n</li>\n<li><p><strong>CreateFile (<code>FileSystem::CreateFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Creates a file with the given ID in the file system.</li>\n<li>Checks if the file already exists; if so, aborts and returns false.</li>\n<li>Allocates a free block for the file and initializes its inode.</li>\n<li>Adds the inode to the inode list.</li>\n<li>Outputs a message indicating the file creation process.</li>\n</ul>\n</li>\n<li><p><strong>DeleteFile (<code>FileSystem::DeleteFile(int _file_id)</code>):</strong></p>\n<ul>\n<li>Deletes a file with the given ID from the file system.</li>\n<li>Checks if the file exists; if not, returns an error.</li>\n<li>Frees the blocks occupied by the file and removes its inode from the inode list.</li>\n<li>Outputs a message indicating the file deletion process.</li>\n</ul>\n</li>\n</ol>\n<p><strong>Inode Class:</strong> The <code>Inode</code> class represents an index node in the file system. It contains information about a file, such as its ID and the block it occupies on the disk. Additional functions may be needed to read and store inodes from and to the disk.</p>\n<h3 id=\"File\"><a href=\"#File\" class=\"headerlink\" title=\"File\"></a>File</h3><p><strong>Introduction:</strong> The <code>File</code> class represents a file handle in the file system implementation. It provides functionality for sequential read and write operations on a file. Each <code>File</code> object maintains a reference to its corresponding inode in the file system.</p>\n<p><strong>File Class:</strong> Below are the details of the <code>File</code> class member functions:</p>\n<ol>\n<li><strong>Constructor (<code>File::File(FileSystem\\* _fs, int _id)</code>):</strong><ul>\n<li>Initializes the file handle with the provided file system reference (<code>_fs</code>) and file ID (<code>_id</code>).</li>\n<li>Sets the current position to the beginning of the file.</li>\n<li>Checks if the file exists in the file system by looking up its inode.</li>\n<li>If the file does not exist, creates a new file with the provided ID.</li>\n<li>Reads the file’s data block into the block cache for sequential read and write operations.</li>\n</ul>\n</li>\n<li><strong>Destructor (<code>File::~File()</code>):</strong><ul>\n<li>Closes the file.</li>\n<li>Writes any cached data to the disk.</li>\n</ul>\n</li>\n<li><strong>Read (<code>File::Read(unsigned int _n, char\\* _buf)</code>):</strong><ul>\n<li>Reads <code>_n</code> characters from the file starting at the current position.</li>\n<li>Copies the read characters into the buffer <code>_buf</code>.</li>\n<li>Returns the number of characters read.</li>\n<li>Does not read beyond the end of the file.</li>\n</ul>\n</li>\n<li><strong>Write (<code>File::Write(unsigned int _n, const char\\* _buf)</code>):</strong><ul>\n<li>Writes <code>_n</code> characters to the file starting at the current position.</li>\n<li>If the write extends over the end of the file, extends the length of the file until all data is written or until the maximum file size is reached.</li>\n<li>Returns the number of characters written.</li>\n<li>Does not write beyond the maximum length of the file.</li>\n</ul>\n</li>\n<li><strong>Reset (<code>File::Reset()</code>):</strong><ul>\n<li>Sets the current position to the beginning of the file.</li>\n<li>Allows subsequent read or write operations to start from the beginning of the file.</li>\n</ul>\n</li>\n<li><strong>EoF (<code>File::EoF()</code>):</strong><ul>\n<li>Checks if the current position for the file is at the end of the file.</li>\n<li>Returns true if the current position is at the end of the file; otherwise, returns false.</li>\n<li>Helps determine if there are more characters to read from the file.</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"Test\"><a href=\"#Test\" class=\"headerlink\" title=\"Test\"></a>Test</h3><p><strong>Testing File System Functionality</strong></p>\n<p>To ensure the proper functioning of the file system, the following steps are taken to test various operations:</p>\n<ol>\n<li><p><strong>File Creation:</strong></p>\n<ul>\n<li>Two files are created using the <code>CreateFile</code> function of the file system.</li>\n<li>Assertions are used to verify that the files are successfully created.<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">assert</span>(_file_system-&gt;<span class=\"built_in\">CreateFile</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"built_in\">assert</span>(_file_system-&gt;<span class=\"built_in\">CreateFile</span>(<span class=\"number\">2</span>));</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>File Opening and Writing:</strong></p>\n<ul>\n<li>The two files are “opened” using the <code>File</code> constructor, which initializes file handles.</li>\n<li>Data is written to each file using the <code>Write</code> function, with different content for each file.</li>\n<li>Assertions are used to verify that the write operations are successful.<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> * STRING1 = <span class=\"string\">&quot;01234567890123456789&quot;</span>;</span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> * STRING2 = <span class=\"string\">&quot;abcdefghijabcdefghij&quot;</span>;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>File Closing:</strong></p>\n<ul>\n<li>The files are automatically closed when they go out of scope.</li>\n</ul>\n</li>\n<li><p><strong>File Opening and Reading:</strong></p>\n<ul>\n<li>The files are “opened” again to simulate reopening.</li>\n<li>Data is read from each file using the <code>Read</code> function.</li>\n<li>Assertions are used to compare the read data with the expected content.</li>\n</ul>\n</li>\n<li><p><strong>File Deletion:</strong></p>\n<ul>\n<li>Both files are deleted using the <code>DeleteFile</code> function.</li>\n<li>Assertions are used to verify that the files are successfully deleted.</li>\n</ul>\n</li>\n<li><p><strong>Comparison with Expected Results:</strong></p>\n<ul>\n<li>The actual results of file read operations are compared with the expected content.</li>\n<li>If any discrepancies are found, assertions will fail, indicating a potential problem with file reading or writing.</li>\n</ul>\n</li>\n</ol>\n<h5 id=\"Log\"><a href=\"#Log\" class=\"headerlink\" title=\"Log\"></a>Log</h5><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Hello World!</span><br><span class=\"line\">formatting disk</span><br><span class=\"line\">Write Block: <span class=\"number\">1</span>\t<span class=\"comment\"># init free list and inode list</span></span><br><span class=\"line\">Write Block: <span class=\"number\">2</span></span><br><span class=\"line\">mounting file system <span class=\"keyword\">from</span> disk</span><br><span class=\"line\">Read Block: <span class=\"number\">1</span> \t<span class=\"comment\"># read free list and inode list</span></span><br><span class=\"line\">Read Block: <span class=\"number\">2</span></span><br><span class=\"line\">creating file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">Created File Name: <span class=\"number\">1</span></span><br><span class=\"line\">Used File Block: <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">creating file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">Created File Name: <span class=\"number\">2</span></span><br><span class=\"line\">Used File Block: <span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\">Opening file.\t<span class=\"comment\"># open file21</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">1</span></span><br><span class=\"line\">Read Block: <span class=\"number\">3</span></span><br><span class=\"line\">Opening file. <span class=\"comment\"># open file 2</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">2</span></span><br><span class=\"line\">Read Block: <span class=\"number\">4</span></span><br><span class=\"line\">writing to file</span><br><span class=\"line\">writing to file</span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">4</span></span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">Opening file.\t<span class=\"comment\"># open file again</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">1</span></span><br><span class=\"line\">Read Block: <span class=\"number\">3</span></span><br><span class=\"line\">Opening file.\t\t<span class=\"comment\"># open file again</span></span><br><span class=\"line\">looking up file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span> = <span class=\"number\">2</span></span><br><span class=\"line\">Read Block: <span class=\"number\">4</span></span><br><span class=\"line\">resetting file</span><br><span class=\"line\">reading <span class=\"keyword\">from</span> file</span><br><span class=\"line\">resetting file</span><br><span class=\"line\">reading <span class=\"keyword\">from</span> file</span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">4</span></span><br><span class=\"line\">Closing file.</span><br><span class=\"line\">Write Block: <span class=\"number\">3</span></span><br><span class=\"line\">deleting file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">1</span> <span class=\"comment\"># test passed </span></span><br><span class=\"line\">File successfully deleted.</span><br><span class=\"line\">deleting file <span class=\"keyword\">with</span> <span class=\"built_in\">id</span>:<span class=\"number\">2</span>\t<span class=\"comment\"># test passed </span></span><br><span class=\"line\">File successfully deleted.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n"},{"title":"swe meme","date":"2025-04-07T01:32:12.000Z","_content":"\n🔥 上古程序员/计算机科学家：自动定理证明器、纸带编程、手搓程序指令级别内存管理、拜占庭将军、多层感知机、手搓编程语言编译器、手搓OS、设计新算法\n\n🐶 现在的程序员/计算机科学家：nm怎么这个包找不到、把这个张量拉长一点能不能涨一个点、wc c++真难啊、无法熟练使用无GC语言、wc这虚拟机怎么连不上\n\n🐭 未来的程序员/计算机科学家：wc ChatGPT怎么连不上了、无法熟练掌握一千行代码以上的代码库、无法在没有LLM的帮助下完成超过五十行的程序、无法独立阅读文档、必须让LLM解释\n","source":"_posts/swe-meme.md","raw":"---\ntitle: swe meme\ndate: 2025-04-06 20:32:12\ntags:\n---\n\n🔥 上古程序员/计算机科学家：自动定理证明器、纸带编程、手搓程序指令级别内存管理、拜占庭将军、多层感知机、手搓编程语言编译器、手搓OS、设计新算法\n\n🐶 现在的程序员/计算机科学家：nm怎么这个包找不到、把这个张量拉长一点能不能涨一个点、wc c++真难啊、无法熟练使用无GC语言、wc这虚拟机怎么连不上\n\n🐭 未来的程序员/计算机科学家：wc ChatGPT怎么连不上了、无法熟练掌握一千行代码以上的代码库、无法在没有LLM的帮助下完成超过五十行的程序、无法独立阅读文档、必须让LLM解释\n","slug":"swe-meme","published":1,"updated":"2025-04-07T01:32:36.345Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm96ed0g30000ttokdo6t11ly","content":"<p>🔥 上古程序员/计算机科学家：自动定理证明器、纸带编程、手搓程序指令级别内存管理、拜占庭将军、多层感知机、手搓编程语言编译器、手搓OS、设计新算法</p>\n<p>🐶 现在的程序员/计算机科学家：nm怎么这个包找不到、把这个张量拉长一点能不能涨一个点、wc c++真难啊、无法熟练使用无GC语言、wc这虚拟机怎么连不上</p>\n<p>🐭 未来的程序员/计算机科学家：wc ChatGPT怎么连不上了、无法熟练掌握一千行代码以上的代码库、无法在没有LLM的帮助下完成超过五十行的程序、无法独立阅读文档、必须让LLM解释</p>\n","site":{"data":{}},"excerpt":"","more":"<p>🔥 上古程序员/计算机科学家：自动定理证明器、纸带编程、手搓程序指令级别内存管理、拜占庭将军、多层感知机、手搓编程语言编译器、手搓OS、设计新算法</p>\n<p>🐶 现在的程序员/计算机科学家：nm怎么这个包找不到、把这个张量拉长一点能不能涨一个点、wc c++真难啊、无法熟练使用无GC语言、wc这虚拟机怎么连不上</p>\n<p>🐭 未来的程序员/计算机科学家：wc ChatGPT怎么连不上了、无法熟练掌握一千行代码以上的代码库、无法在没有LLM的帮助下完成超过五十行的程序、无法独立阅读文档、必须让LLM解释</p>\n"},{"title":"如何通过一次实习获得转正？方法论层面的剖析","date":"2025-05-28T22:00:44.000Z","_content":"\n[link](https://zhuanlan.zhihu.com/p/1911262854318920310) <br>\n\nhttps://zhuanlan.zhihu.com/p/1911262854318920310\n\n","source":"_posts/如何通过一次实习获得转正？方法论层面的剖析.md","raw":"---\ntitle: 如何通过一次实习获得转正？方法论层面的剖析\ndate: 2025-05-28 15:00:44\ntags:\n---\n\n[link](https://zhuanlan.zhihu.com/p/1911262854318920310) <br>\n\nhttps://zhuanlan.zhihu.com/p/1911262854318920310\n\n","slug":"如何通过一次实习获得转正？方法论层面的剖析","published":1,"updated":"2025-07-05T21:01:17.736Z","_id":"cmb8der8o0000juokeyj447z0","comments":1,"layout":"post","photos":[],"link":"","content":"<p><a href=\"https://zhuanlan.zhihu.com/p/1911262854318920310\">link</a> <br></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1911262854318920310\">https://zhuanlan.zhihu.com/p/1911262854318920310</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://zhuanlan.zhihu.com/p/1911262854318920310\">link</a> <br></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1911262854318920310\">https://zhuanlan.zhihu.com/p/1911262854318920310</a></p>\n"},{"title":"辛苦遭逢起一经 ，十年学生生涯回顾与未来的展望","date":"2025-05-28T19:59:44.000Z","_content":"\n[link](https://zhuanlan.zhihu.com/p/1910243192726618925) <br>\nhttps://zhuanlan.zhihu.com/p/1910243192726618925\n","source":"_posts/辛苦遭逢起一经-，十年学生生涯回顾与未来的展望.md","raw":"---\ntitle: 辛苦遭逢起一经 ，十年学生生涯回顾与未来的展望\ndate: 2025-05-28 14:59:44\ntags:\n---\n\n[link](https://zhuanlan.zhihu.com/p/1910243192726618925) <br>\nhttps://zhuanlan.zhihu.com/p/1910243192726618925\n","slug":"辛苦遭逢起一经-，十年学生生涯回顾与未来的展望","published":1,"updated":"2025-05-28T20:00:29.823Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cmb8der8p0001juokd535h5ui","content":"<p><a href=\"https://zhuanlan.zhihu.com/p/1910243192726618925\">link</a> <br><br><a href=\"https://zhuanlan.zhihu.com/p/1910243192726618925\">https://zhuanlan.zhihu.com/p/1910243192726618925</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://zhuanlan.zhihu.com/p/1910243192726618925\">link</a> <br><br><a href=\"https://zhuanlan.zhihu.com/p/1910243192726618925\">https://zhuanlan.zhihu.com/p/1910243192726618925</a></p>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"clepqbq9m0001b9c91cbq9zm9","tag_id":"clepqbq9r0004b9c97a9khf4o","_id":"clepqbq9v000ab9c921vzg77q"},{"post_id":"clepqbq9s0006b9c9apxaaczz","tag_id":"clepqbq9u0009b9c9b5sebe2p","_id":"clepqbq9x000fb9c93oao1l43"},{"post_id":"clepqbq9t0007b9c9cyfza66l","tag_id":"clepqbq9w000db9c98o442cxc","_id":"clepqbq9z000jb9c94ezf20il"},{"post_id":"clepqbq9u0008b9c9eslc3egr","tag_id":"clepqbq9u0009b9c9b5sebe2p","_id":"clepqbqa1000nb9c9ejwpei5t"},{"post_id":"clepqbq9w000cb9c90bnzd51z","tag_id":"clepqbqa0000lb9c9019hgrxg","_id":"clepqbqa2000qb9c96s4ybdgp"},{"post_id":"clepqbqa2000pb9c940cc2o9z","tag_id":"clepqbqa3000sb9c9efkt4zfq","_id":"clepqbqa5000xb9c9ct4ge2ku"},{"post_id":"clepqbqa3000tb9c92mu315g5","tag_id":"clepqbqa4000wb9c94vcafmh0","_id":"clepqbqa60011b9c97dy53r2j"}],"Tag":[{"name":"intern","_id":"clepqbq9r0004b9c97a9khf4o"},{"name":"Casdoor","_id":"clepqbq9u0009b9c9b5sebe2p"},{"name":"casdoor","_id":"clepqbq9w000db9c98o442cxc"},{"name":"Go","_id":"clepqbqa0000lb9c9019hgrxg"},{"name":"Operation Systems Three Easy Pieces","_id":"clepqbqa3000sb9c9efkt4zfq"},{"name":"Virtualization","_id":"clepqbqa4000wb9c94vcafmh0"}]}}